<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>脚本实例五：监控指定端口流量 | Peter's technology stack.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/shell脚本实例/">shell脚本实例</a></div><div class="post-time">2019-07-24</div></div></div><div class="container post-header"><h1>脚本实例五：监控指定端口流量</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#脚本实例五：监控指定端口流量"><span class="toc-number">1.</span> <span class="toc-text">脚本实例五：监控指定端口流量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#脚本功能"><span class="toc-number">2.</span> <span class="toc-text">脚本功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#脚本使用"><span class="toc-number">3.</span> <span class="toc-text">脚本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#脚本下载"><span class="toc-number">4.</span> <span class="toc-text">脚本下载</span></a></li></ol></details></div><div class="container post-content"><h3 id="脚本实例五：监控指定端口流量"><a href="#脚本实例五：监控指定端口流量" class="headerlink" title="脚本实例五：监控指定端口流量"></a>脚本实例五：监控指定端口流量</h3><a id="more"></a>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 定义监控网卡</span><br><span class="line">INTERFACE=ens34</span><br><span class="line"><span class="meta">#</span> 定义监控端口，将需要监控的端口，写入如下列表，不能为空</span><br><span class="line">PORT=(22 443 80)</span><br><span class="line"><span class="meta">#</span> 定义记录日志目录及文件</span><br><span class="line">TOTAL_FLOW_LOG_DIR=/var/log/iftop</span><br><span class="line">TOTAL_FLOW_LOG_FILE=$TOTAL_FLOW_LOG_DIR/iftop_total.log</span><br><span class="line">INPUT_FLOW_LOG_FILE=$TOTAL_FLOW_LOG_DIR/iftop_input.log</span><br><span class="line">OUTPUT_FLOW_LOG_FILE=$TOTAL_FLOW_LOG_DIR/iftop_output.log</span><br><span class="line">IFTOP_PORT_OPTION=''</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 检查需要安装的软件包</span><br><span class="line">CHECK_PACKAGE() &#123;</span><br><span class="line">    PACKAGES=(bc iftop)</span><br><span class="line">    for PACKAGE in $&#123;PACKAGES[@]&#125; ; do</span><br><span class="line">        which $&#123;PACKAGE&#125; &amp;&gt; /dev/null</span><br><span class="line">	if [[ $? != 0 ]] ; then</span><br><span class="line">	     echo "No have package: $&#123;PACKAGE&#125;, please install!"</span><br><span class="line">             exit 1</span><br><span class="line">	fi</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 生成端口监控命令</span><br><span class="line">PORT_OPTION () &#123;</span><br><span class="line">TMP=1</span><br><span class="line">for i in $&#123;PORT[@]&#125;; do</span><br><span class="line"></span><br><span class="line">  if [[ "$&#123;#PORT[@]&#125;" == "$&#123;TMP&#125;" ]]; then</span><br><span class="line">    IFTOP_PORT_OPTION="$&#123;IFTOP_PORT_OPTION&#125; port $&#123;i&#125;"</span><br><span class="line">  else</span><br><span class="line">    IFTOP_PORT_OPTION="$&#123;IFTOP_PORT_OPTION&#125; port $&#123;i&#125; ||"</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  let TMP++</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 更换单位</span><br><span class="line">CHANGE_BIT ()&#123;</span><br><span class="line">    if [[ $1 == *K* ]]</span><br><span class="line">    then</span><br><span class="line">    	TRUE_FLOW=`echo $1|awk -FK '&#123;print $1&#125;'`</span><br><span class="line">    	CHANGE_FLOW=`echo "$TRUE_FLOW*1000"|bc`</span><br><span class="line">    elif [[ $1 == *M* ]]</span><br><span class="line">    then</span><br><span class="line">    	TRUE_FLOW=`echo $1|awk -FM '&#123;print $1&#125;'`</span><br><span class="line">    	CHANGE_FLOW=`echo "$TRUE_FLOW*1000*1000"|bc`</span><br><span class="line">    elif [[ $1 == *G* ]]</span><br><span class="line">    then</span><br><span class="line">    	TRUE_FLOW=`echo $1|awk -FG '&#123;print $1&#125;'`</span><br><span class="line">    	CHANGE_FLOW=`echo "$TRUE_FLOW*1000*1000*1000"|bc`</span><br><span class="line">    elif [[ $1 == *T* ]]</span><br><span class="line">    then</span><br><span class="line">    	TRUE_FLOW=`echo $1|awk -FT '&#123;print $1&#125;'`</span><br><span class="line">    	CHANGE_FLOW=`echo "$TRUE_FLOW*1000*1000*1000*1000"|bc`</span><br><span class="line">    elif echo "$1"|[ -n "`sed -n '/^[0-9][0-9]*$/p'`" ]</span><br><span class="line">    then</span><br><span class="line">    	CHANGE_FLOW=$1</span><br><span class="line">    else</span><br><span class="line">    	CHANGE_FLOW=$1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 监控命令</span><br><span class="line">FILTER_FLOW () &#123;</span><br><span class="line">    [ -d $TOTAL_FLOW_LOG_DIR ] || mkdir -p $TOTAL_FLOW_LOG_DIR</span><br><span class="line"></span><br><span class="line">    FLOW_TOTAL=$(timeout --signal=9 100 iftop  -t -s 1 -L 1 -i $INTERFACE \</span><br><span class="line">	-f "$&#123;IFTOP_PORT_OPTION&#125;" 2&gt; /dev/null | \</span><br><span class="line">	grep -i "$1" | \</span><br><span class="line">	awk -F: '&#123;print $2&#125;' | awk '&#123;print $1&#125;'|awk -Fb '&#123;print $1&#125;')</span><br><span class="line"></span><br><span class="line">    CHANGE_BIT $FLOW_TOTAL</span><br><span class="line"></span><br><span class="line">    echo "$CHANGE_FLOW" &gt; $2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 调用函数</span><br><span class="line">CHECK_PACKAGE</span><br><span class="line">PORT_OPTION</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 写入while循环，基本实现实时监控</span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">	FILTER_FLOW "Total send and receive rate" $TOTAL_FLOW_LOG_FILE</span><br><span class="line">	FILTER_FLOW "Total receive rate" $INPUT_FLOW_LOG_FILE</span><br><span class="line">	FILTER_FLOW "Total send rate" $OUTPUT_FLOW_LOG_FILE</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="脚本功能"><a href="#脚本功能" class="headerlink" title="脚本功能"></a>脚本功能</h3><p>实现对端口的流量进行监控，默认监控三个指标：端口总流量、入和出流量。可以搭配监控系统实现对端口流量监控并以图形化展示。会输出三个日志文件，在此日志文件中可以查看到当前监控端口的流量。大家可以根据自己需求进行更改。</p>
<h3 id="脚本使用"><a href="#脚本使用" class="headerlink" title="脚本使用"></a>脚本使用</h3><p>直接执行<code>bash iftop_net.sh &amp;</code></p>
<h3 id="脚本下载"><a href="#脚本下载" class="headerlink" title="脚本下载"></a>脚本下载</h3><p><a href="https://www.ihaiyun.cc/script/iftop_net.txt">https://www.ihaiyun.cc/script/iftop_net.txt</a></p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>