<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>Nginx根据手机电脑进行不同跳转 | Peter's technology stack.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Nginx/">Nginx</a></div><div class="post-time">2019-01-21</div></div></div><div class="container post-header"><h1>Nginx根据手机电脑进行不同跳转</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#识别平台"><span class="toc-number">2.</span> <span class="toc-text">识别平台</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#识别访问的页面"><span class="toc-number">3.</span> <span class="toc-text">识别访问的页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#处理规则"><span class="toc-number">4.</span> <span class="toc-text">处理规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#致谢"><span class="toc-number">5.</span> <span class="toc-text">致谢</span></a></li></ol></details></div><div class="container post-content"><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><a id="more"></a>
<p>有时候我们想对来自不同平台的同一页面的访问进行处理。比如访问：<a href="https://www.ihaiyun.cc/about/index.html">https://www.ihaiyun.cc/about/index.html</a> 页面，如果是电脑的浏览器访问，直接不处理；但是如果是手机的浏览器访问这个页面我们想跳转到其他页面去。这里有几种方法可以实现：</p>
<ul>
<li>直接通过 JavaScript 进行处理；</li>
<li>通过 Nginx 配置来处理</li>
</ul>
<p>本文只介绍如何通过 Nginx 配置来实现。</p>
<h3 id="识别平台"><a href="#识别平台" class="headerlink" title="识别平台"></a>识别平台</h3><p>这个需求的第一个问题是如何识别处电脑浏览器和手机浏览器，主要通过<code>$http_user_agent</code>判断的，代码如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">set $is_mobile no;</span><br><span class="line">if ($http_user_agent ~* "(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino") &#123;</span><br><span class="line">    set $is_mobile yes;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">if ($http_user_agent ~* "^(1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-)") &#123;</span><br><span class="line">    set $is_mobile yes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面配置首先设置<code>$is_mobile</code>参数为<code>no</code>，接着判断浏览器的<code>$http_user_agent</code>；如果满足上面的两个条件判断则可以得到访问的平台是手机端，那么<code>$is_mobile</code>，参数就为<code>yes</code>。</p>
<h3 id="识别访问的页面"><a href="#识别访问的页面" class="headerlink" title="识别访问的页面"></a>识别访问的页面</h3><p>上面我们已经识别了用户的平台，现在我们需要识别我们当前访问的页面地址。我们可以通过Nginx内置的<code>$document_uir</code>(也可以通过<code>$request_uri</code>实现)来获取用户访问的页面地址。比如你现在访问了 <a href="https://www.ihaiyun.cc/test.html?from=ihaiyuncc_nginx&amp;id=2666">https://www.ihaiyun.cc/test.html?from=ihaiyuncc_nginx&amp;id=2666</a> 页面，下面就是 <code>$request_uri</code>、<code>$uri</code> 以及 <code>$document_uri</code>获取到的信息：</p>
<ul>
<li><code>$request_uri</code>：/test.html?from=ihaiyuncc_nginx&amp;id=2666</li>
<li><code>$uri</code>：/test.html</li>
<li><code>$document_uri</code>：/test.html</li>
</ul>
<p>可以看出<code>$request_uri</code>变量可以获取访问页面的参数；而<code>$uri</code>和<code>$document_uri</code>功能类似，都是获取到不带请求参数的当前URI，不包含主机名。所以我们可以判断当前访问的页面是test.html：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ( $document_uri ~* "(test)\.html" ) &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 访问了test.html</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="处理规则"><a href="#处理规则" class="headerlink" title="处理规则"></a>处理规则</h3><p>现在我们获取到了用户访问平台和访问的页面，我们就可以结合这两个条件进行相关的处理。但是遗憾的是，nginx 中的if 不支持 and 操作，所以我们需要特殊处理。最终实现如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">set $con 0;</span><br><span class="line">if ($is_mobile = "yes") &#123;</span><br><span class="line">    set $con 1;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">if ( $document_uri ~* "(test)\.html.*" ) &#123;</span><br><span class="line">    set $con "$&#123;con&#125;0";</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">if ( $con = "10") &#123;</span><br><span class="line">    rewrite ^/ https://www.ihaiyun.cc/2018/11/25/Linux-Random-Password/index.html permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的逻辑是：</p>
<ul>
<li>当我们访问的平台是手机，且访问的页面是 test.html，这时候 <code>$con = 10</code></li>
<li>当我们访问的平台是手机，且访问的页面不是 test.html，这时候<code>$con = 1</code></li>
<li>当我们访问的平台是电脑，且访问的页面是 test.html，这时候<code>$con = 00</code></li>
<li>当我们访问的平台是电脑，且访问的页面不是 test.html，这时候 <code>$con = 0</code></li>
</ul>
<p>最后我们只需要重启 Nginx 即可。现在如果你是电脑访问 <a href="https://www.ihaiyun.cc/test.html">https://www.ihaiyun.cc/test.html</a> 页面 Nginx不会做任何的跳转；但是如果你是通过手机浏览器访问这个页面，Nginx 就会301跳转到 <a href="https://www.ihaiyun.cc/2018/11/25/Linux-Random-Password/index.html">https://www.ihaiyun.cc/2018/11/25/Linux-Random-Password/index.html</a> 页面。</p>
<h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://blog.csdn.net/qq_28867949/article/details/80037073" target="_blank" rel="noopener">CSDN：Nginx 根据手机电脑进行不同跳转</a></p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>