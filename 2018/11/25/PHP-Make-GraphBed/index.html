<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>PHP制作简单图床 | Peter's technology stack.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/PHP/">PHP</a></div><div class="post-time">2018-11-25</div></div></div><div class="container post-header"><h1>PHP制作简单图床</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一、前端上传页面"><span class="toc-number">2.</span> <span class="toc-text">一、前端上传页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、远程服务器图片处理"><span class="toc-number">3.</span> <span class="toc-text">二、远程服务器图片处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、回调页面返回图片地址到前端页面"><span class="toc-number">4.</span> <span class="toc-text">三、回调页面返回图片地址到前端页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、上传到服务器的文件写入日志"><span class="toc-number">5.</span> <span class="toc-text">四、上传到服务器的文件写入日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#致谢"><span class="toc-number">6.</span> <span class="toc-text">致谢</span></a></li></ol></details></div><div class="container post-content"><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><a id="more"></a>
<p>本次示例演示一个简单的上传图片到远程服务器，然后生成图片路径后通过提交的回调路径返回给本地服务器，最后将图片地址显示在前端页面。</p>
<p>本项目应用三个文件，即前端选取图片的页面，然后提交图片到远程服务器处理文件，返回前端页面的回调文件。</p>
<center><img src="https://houhaiyun.github.io/img/images/PHP-Upload-img-1.png" title="演示效果"></center>

<h3 id="一、前端上传页面"><a href="#一、前端上传页面" class="headerlink" title="一、前端上传页面"></a>一、前端上传页面</h3><p>upload.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"</span></span><br><span class="line"><span class="meta">    "http://www.w3.org/TR/html4/loose.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Upload Image<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://libs.baidu.com/jquery/2.0.0/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--注意这里的iframe标签--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">iframe</span>  <span class="attr">name</span>=<span class="string">"post_frame"</span> <span class="attr">style</span>=<span class="string">"display:none;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"photo_upload"</span> <span class="attr">action</span>=<span class="string">"upload_action.php"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">target</span>=<span class="string">"post_frame"</span>  <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span>              </span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">cellspacing</span>=<span class="string">"0"</span> <span class="attr">cellpadding</span>=<span class="string">"0"</span> <span class="attr">border</span>=<span class="string">"0"</span> &gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">              <span class="tag">&lt;<span class="name">th</span> <span class="attr">style</span>=<span class="string">"border-bottom:1px solid #D1E0EB;text-align: right;"</span>&gt;</span>主题封面图：<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">"border-bottom:1px solid #D1E0EB"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"opus"</span> <span class="attr">value</span>=<span class="string">""</span> <span class="attr">width</span>=<span class="string">"200"</span> /&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">style</span>=<span class="string">" height: 40px;width: 45px;"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"上传"</span> <span class="attr">name</span>=<span class="string">"submit"</span> /&gt;</span>&amp;nbsp;&amp;nbsp;<span class="tag">&lt;<span class="name">span</span>&gt;</span> 图片格式 jpg  jpeg gif  png  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"callbackUrl"</span> <span class="attr">value</span>=<span class="string">"http://192.168.8.12/callback.php"</span>  /&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">cellspacing</span>=<span class="string">"0"</span> <span class="attr">cellpadding</span>=<span class="string">"0"</span> <span class="attr">border</span>=<span class="string">"0"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">           <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">th</span> <span class="attr">style</span>=<span class="string">"border-bottom:1px solid #D1E0EB;text-align: right;"</span>&gt;</span>封面图URL：<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">td</span> <span class="attr">style</span>=<span class="string">"border-bottom:1px solid #D1E0EB"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"cover_img_url"</span> <span class="attr">name</span>=<span class="string">"cover_img_url"</span> <span class="attr">size</span>=<span class="string">"120"</span> <span class="attr">readonly</span>=<span class="string">"readonly"</span> /&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>* </span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">" height: 100px;"</span> <span class="attr">id</span>=<span class="string">"show_img"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里需要注意当回调页面返回图片地址到前端页面时，需要<strong>iframe</strong>标签（这里我们将其隐藏），否则将会找不到要在页面显示的地方<code>&lt;input type=&quot;text&quot; id=&quot;cover_img_url&quot; name=&quot;cover_img_url&quot; size=&quot;120&quot; readonly=&quot;readonly&quot; /&gt;</code>。</p>
<p><strong>和一般的<code>&lt;form&gt;</code>标签相比多了一个target属性罢了，用于指定标签页在哪里打开以及提交数据</strong>。<br>而如果设置为<code>iframe</code>的<code>name</code>值，即<code>&quot;post_frame&quot;</code>的话,就会在该<code>iframe</code>内打开，因为<code>CSS</code>设置为隐藏，因而不会有任何动静。若将<code>display:none</code>去掉,还会看到服务器的返回信息。</p>
<p>上传文件时，<code>form</code>表单的<code>method</code>、 <code>enctype</code>属性必须和上面的代码一样，然后将<code>target</code>的值设为<code>iframe</code>的<code>name</code>，这样就可以实现无刷新上传文件。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"post_frame"</span> <span class="attr">style</span>=<span class="string">"display:none;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当选择图片提交时，还有一个隐藏域，即给远程服务器提交图片时，还需要提交回调路径，好让图片返回给本地服务器。（这里我们都是用本地服务器来进行测试）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"callbackUrl"</span> <span class="attr">value</span>=<span class="string">"http://localhost/url_test/callback.php"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="二、远程服务器图片处理"><a href="#二、远程服务器图片处理" class="headerlink" title="二、远程服务器图片处理"></a>二、远程服务器图片处理</h3><p>upload_action.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/**</span><br><span class="line"> * 图片上传处理</span><br><span class="line"> * User: CorwienWong</span><br><span class="line"> * Date: 16-06-15</span><br><span class="line"> * Time: 00:33</span><br><span class="line"> */</span><br><span class="line">header(&quot;Content-type:text/html;charset=utf-8&quot;);</span><br><span class="line"></span><br><span class="line">// 配置文件需要上传到服务器的路径，需要允许所有用户有可写权限，否则无法上传成功</span><br><span class="line">$uploadPath = &apos;uploads/&apos;;</span><br><span class="line"></span><br><span class="line">// 获取提交的图片数据</span><br><span class="line">$file = $_FILES[&apos;opus&apos;];</span><br><span class="line"></span><br><span class="line">// 获取图片回调路径</span><br><span class="line">$callbackUrl = $_POST[&apos;callbackUrl&apos;];</span><br><span class="line"></span><br><span class="line">if($file[&apos;error&apos;] &gt; 0)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    $msg = &apos;传入参数错误&apos; . $file[&apos;error&apos;] . &quot;  &quot;;</span><br><span class="line">    exit($msg);</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">   // chmod($uploadPath, 0666);</span><br><span class="line"></span><br><span class="line">    if(file_exists($uploadPath.$file[&apos;name&apos;]))&#123;</span><br><span class="line">       $msg = $file[&apos;name&apos;] . &quot;文件已经存在！&quot;;</span><br><span class="line">       exit($msg);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        if(move_uploaded_file($file[&apos;tmp_name&apos;], $uploadPath.$file[&apos;name&apos;]))</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">          $img_url = &quot;http://192.168.8.12/&quot;.$uploadPath.$file[&apos;name&apos;];</span><br><span class="line">          $img_url = urlencode($img_url);</span><br><span class="line"></span><br><span class="line">          $url = $callbackUrl.&quot;?img_url=&#123;$img_url&#125;&quot;;</span><br><span class="line"></span><br><span class="line">          // 跳转</span><br><span class="line">          header(&quot;location:&#123;$url&#125;&quot;);</span><br><span class="line">          exit();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">          exit(&quot;上传失败！&quot;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>图片上传到到该页面后，保存并返回图片地址给回调页面。</p>
<h3 id="三、回调页面返回图片地址到前端页面"><a href="#三、回调页面返回图片地址到前端页面" class="headerlink" title="三、回调页面返回图片地址到前端页面"></a>三、回调页面返回图片地址到前端页面</h3><p>回调页面获取到远程服务器传来的图片地址后，经过<code>window.parent.XXX</code>返回给前端页面。 </p>
<p>cat callback.php </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  ##回调方法</span><br><span class="line"></span><br><span class="line">$img_url = $_GET[&apos;img_url&apos;];</span><br><span class="line"></span><br><span class="line">// 返回数据给回调页面</span><br><span class="line"></span><br><span class="line">echo &quot;</span><br><span class="line">&lt;script&gt;window.parent.document.getElementById(&apos;cover_img_url&apos;).value=&apos;&#123;$img_url&#125;&apos;;&lt;/script&gt;</span><br><span class="line">&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>上传图片测试：</strong></p>
<center><img src="https://houhaiyun.github.io/img/images/PHP-Upload-img-2.gif" title="测试上传"></center>

<h3 id="四、上传到服务器的文件写入日志"><a href="#四、上传到服务器的文件写入日志" class="headerlink" title="四、上传到服务器的文件写入日志"></a>四、上传到服务器的文件写入日志</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">写入日志：</span><br><span class="line"> $file = <span class="keyword">$this</span>-&gt;file = $_FILES[<span class="keyword">$this</span>-&gt;fileField];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 要写入文件的文件名（可以是任意文件名），如果文件不存在，将会创建一个</span></span><br><span class="line">        $log_file  = <span class="string">'../log/log.txt'</span>;</span><br><span class="line">        $time = date(<span class="string">"Y-m-d H:i:s"</span>, time());</span><br><span class="line">        $log_content = var_export($_FILES, <span class="keyword">true</span>) .<span class="string">"Time:&#123;$time&#125; \r\n"</span>;</span><br><span class="line">        file_put_contents($log_file, $log_content, FILE_APPEND);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment">// 结果记录</span></span><br><span class="line"><span class="keyword">array</span> (</span><br><span class="line">  <span class="string">'name'</span> =&gt; <span class="string">'myImage.jpg'</span>,</span><br><span class="line">  <span class="string">'type'</span> =&gt; <span class="string">'image/jpeg'</span>,</span><br><span class="line">  <span class="string">'tmp_name'</span> =&gt; <span class="string">'/Applications/XAMPP/xamppfiles/temp/phpod5VA4'</span>,</span><br><span class="line">  <span class="string">'error'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">  <span class="string">'size'</span> =&gt; <span class="number">249318</span>,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">array</span> (</span><br><span class="line">  <span class="string">'file'</span> =&gt; </span><br><span class="line">  <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">'name'</span> =&gt; <span class="string">'myImage.jpg'</span>,</span><br><span class="line">    <span class="string">'type'</span> =&gt; <span class="string">'image/jpeg'</span>,</span><br><span class="line">    <span class="string">'tmp_name'</span> =&gt; <span class="string">'/Applications/XAMPP/xamppfiles/temp/phppRvcVe'</span>,</span><br><span class="line">    <span class="string">'error'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">    <span class="string">'size'</span> =&gt; <span class="number">249318</span>,</span><br><span class="line">  ),</span><br><span class="line">)Time:<span class="number">2016</span><span class="number">-09</span><span class="number">-10</span> <span class="number">17</span>:<span class="number">32</span>:<span class="number">30</span></span><br></pre></td></tr></table></figure>
<h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://segmentfault.com/a/1190000006861633" target="_blank" rel="noopener">php上传图片到远程服务器并返回图片地址到本地显示</a></p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>