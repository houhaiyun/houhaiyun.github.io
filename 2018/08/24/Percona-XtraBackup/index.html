<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>Percona XtraBackup | Peter's technology stack.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Percona/">Percona</a></div><div class="post-time">2018-08-24</div></div></div><div class="container post-header"><h1>Percona XtraBackup</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装xtracbackup"><span class="toc-number">2.</span> <span class="toc-text">安装xtracbackup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xtrabackup进行全量备份"><span class="toc-number">3.</span> <span class="toc-text">xtrabackup进行全量备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从一个完全备份中恢复数据"><span class="toc-number">4.</span> <span class="toc-text">从一个完全备份中恢复数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用innobackupex进行增量备份"><span class="toc-number">5.</span> <span class="toc-text">使用innobackupex进行增量备份</span></a></li></ol></details></div><div class="container post-content"><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><a id="more"></a>
<p><code>Percona XtraBackup</code>是物理备份</p>
<p><code>Percona XtraBackup</code>对MyISAM只支持温备</p>
<p><code>Percona XtraBackup</code>对<code>InnoDB</code>支持热备(全量和增量)。对<code>InnoDb</code>备份进行热备时还会备份二进制日志</p>
<h3 id="安装xtracbackup"><a href="#安装xtracbackup" class="headerlink" title="安装xtracbackup"></a>安装xtracbackup</h3><p>直接从官网下载软件包安装即可</p>
<p><a href="https://www.percona.com/downloads/XtraBackup/LATEST/" target="_blank" rel="noopener">下载地址：https://www.percona.com/downloads/XtraBackup/LATEST/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql2 ~]# ls         # 已经下载完成；</span><br><span class="line">percona-xtrabackup-24-2.4.7-2.el7.x86_64.rpm</span><br><span class="line">[root@mysql2 ~]# yum install -y percona-xtrabackup-24-2.4.7-2.el7.x86_64.rpm    # 安装；</span><br><span class="line"></span><br><span class="line">[root@mysql2 ~]# rpm -ql percona-xtrabackup-24-2.4.7        # 查看生成的文件</span><br><span class="line">/usr/bin/innobackupex</span><br><span class="line">/usr/bin/xbcloud</span><br><span class="line">/usr/bin/xbcloud_osenv</span><br><span class="line">/usr/bin/xbcrypt</span><br><span class="line">/usr/bin/xbstream</span><br><span class="line">/usr/bin/xtrabackup</span><br><span class="line">/usr/share/doc/percona-xtrabackup-24-2.4.7</span><br><span class="line">/usr/share/doc/percona-xtrabackup-24-2.4.7/COPYING</span><br><span class="line">/usr/share/man/man1/innobackupex.1.gz</span><br><span class="line">/usr/share/man/man1/xbcrypt.1.gz</span><br><span class="line">/usr/share/man/man1/xbstream.1.gz</span><br><span class="line">/usr/share/man/man1/xtrabackup.1.gz</span><br></pre></td></tr></table></figure>
<h3 id="xtrabackup进行全量备份"><a href="#xtrabackup进行全量备份" class="headerlink" title="xtrabackup进行全量备份"></a>xtrabackup进行全量备份</h3><p><code>innobackupex --user= --password= --host= /BackupDIR</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql1 ~]# mkdir /backup      # 创建备份目录；</span><br><span class="line">[root@mysql1 ~]# innobackupex --user=root --password=haiyun --host=localhost /backup/       # /bakcup为备份后数据存放的目录；</span><br><span class="line">171130 19:29:40 innobackupex: Starting the backup operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the backup run completes successfully.</span><br><span class="line">           At the end of a successful backup run innobackupex</span><br><span class="line">           prints &quot;completed OK!&quot;.</span><br><span class="line"></span><br><span class="line">171130 19:29:41  version_check Connecting to MySQL server with DSN &apos;dbi:mysql:;mysql_read_default_group=xtrabackup;host=localhost&apos; as &apos;root&apos;  (using password: YES).</span><br><span class="line">171130 19:29:41  version_check Connected to MySQL server</span><br><span class="line">171130 19:29:41  version_check Executing a version check against the server...</span><br><span class="line">171130 19:29:41  version_check Done.</span><br><span class="line">171130 19:29:41 Connecting to MySQL server host: localhost, user: root, password: set, port: not set, socket: not set</span><br><span class="line"></span><br><span class="line">...省略部分内容</span><br><span class="line">171130 19:29:42 [00]        ...done</span><br><span class="line">xtrabackup: Transaction log of lsn (1604357) to (1604357) was copied.</span><br><span class="line">171130 19:29:43 completed OK!       # 出现completed OK代表备份成功；</span><br><span class="line"></span><br><span class="line">[root@mysql1 ~]# cd /bakcup/        # 切换到备份数据目录；</span><br><span class="line">[root@mysql1 bakcup]# ls</span><br><span class="line">2017-11-30_19-29-40</span><br><span class="line">[root@mysql1 backup]# cd 2017-11-30_19-29-40/</span><br><span class="line">[root@mysql1 2017-11-30_19-29-40]# ll</span><br><span class="line">total 18460</span><br><span class="line">-rw-r----- 1 root root      417 Nov 30 19:29 backup-my.cnf      # 备份的配置文件；</span><br><span class="line">drwxr-x--- 2 root root       39 Nov 30 19:29 haiyundb</span><br><span class="line">-rw-r----- 1 root root 18874368 Nov 30 19:29 ibdata1</span><br><span class="line">drwxr-x--- 2 root root     4096 Nov 30 19:29 mysql</span><br><span class="line">drwxr-x--- 2 root root     4096 Nov 30 19:29 performance_schema</span><br><span class="line">drwxr-x--- 2 root root       20 Nov 30 19:29 test</span><br><span class="line">-rw-r----- 1 root root       22 Nov 30 19:29 xtrabackup_binlog_info     # 二进制日志信息；</span><br><span class="line">-rw-r----- 1 root root      113 Nov 30 19:29 xtrabackup_checkpoints     # 备份相关信息；</span><br><span class="line">-rw-r----- 1 root root      486 Nov 30 19:29 xtrabackup_info            # xtrabackup信息；</span><br><span class="line">-rw-r----- 1 root root     2560 Nov 30 19:29 xtrabackup_logfile     # xtrabackup日志信息；</span><br><span class="line"></span><br><span class="line">[root@mysql1 2017-11-30_19-29-40]# cat xtrabackup_binlog_info </span><br><span class="line">master-log.000003	650</span><br></pre></td></tr></table></figure>
<h3 id="从一个完全备份中恢复数据"><a href="#从一个完全备份中恢复数据" class="headerlink" title="从一个完全备份中恢复数据"></a>从一个完全备份中恢复数据</h3><p><strong>注意</strong>：恢复不用启动MySQL</p>
<p><code>innobackupex</code>命令的<code>--copy-back</code>选项用于执行恢复操作，其通过复制所有数据相关的文件至<code>mysql</code>服务器<code>DATADIR</code>目录中来执行恢复过程。<code>innobackupex</code>通过<code>backup-my.cnf</code>来获取<code>DATADIR</code>目录的相关信息。</p>
<p><code># innobackupex --copy-back  /path/to/BACKUP-DIR</code></p>
<p>当数据恢复至<code>DATADIR</code>目录以后，还需要确保所有数据文件的属主和属组均为正确的用户，如<code>mysql</code>，否则，在启动<code>mysqld</code>之前还需要事先修改数据文件的属主和属组。如：</p>
<p><code># chown -R  mysql:mysql  /mydata/data/</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"># 准备工作</span><br><span class="line">[root@mysql1 ~]# scp /backup/2017-11-30_19-29-40/ 192.168.8.15:</span><br><span class="line">root@192.168.8.15&apos;s password: </span><br><span class="line">/backup/2017-11-30_19-29-40: not a regular file</span><br><span class="line">[root@mysql1 ~]# scp -r  /backup/2017-11-30_19-29-40/ 192.168.8.15:     # 将备份的文件复制到要恢复的目录；</span><br><span class="line">root@192.168.8.15&apos;s password: </span><br><span class="line">xtrabackup_logfile                                         100% 2560     2.5KB/s   00:00    </span><br><span class="line">ibdata1                                                    100%   18MB  18.0MB/s   00:00    </span><br><span class="line">db.frm                                                     100% 9582     9.4KB/s   00:00  </span><br><span class="line">。。。省略部分内容</span><br><span class="line">[root@mysql2 ~]# ls     # 已经复制成功；</span><br><span class="line">2017-11-30_19-29-40  percona-xtrabackup-24-2.4.7-2.el7.x86_64.rpm       </span><br><span class="line">[root@mysql2 ~]# yum -y  install percona-xtrabackup-24-2.4.7-2.el7.x86_64.rpm       # 安装percona-xtrabackup；</span><br><span class="line">[root@mysql2 ~]# cd 2017-11-30_19-29-40/</span><br><span class="line">[root@mysql2 2017-11-30_19-29-40]# ls</span><br><span class="line">backup-my.cnf  ibdata1  performance_schema  xtrabackup_binlog_info  xtrabackup_info</span><br><span class="line">haiyundb       mysql    test                xtrabackup_checkpoints  xtrabackup_logfile</span><br><span class="line">[root@mysql2 2017-11-30_19-29-40]# innobackupex --apply-log  ./         # 做一次apply，将那些提交的事务同步，回滚的事务回滚，未有结果的事务回滚；</span><br><span class="line">171130 19:40:34 innobackupex: Starting the apply-log operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the apply-log run completes successfully.</span><br><span class="line">           At the end of a successful apply-log run innobackupex</span><br><span class="line">           prints &quot;completed OK!&quot;.</span><br><span class="line"></span><br><span class="line">innobackupex version 2.4.7 based on MySQL server 5.7.13 Linux (x86_64) (revision id: 05f1fcf)</span><br><span class="line">xtrabackup: cd to /root/2017-11-30_19-29-40/</span><br><span class="line">。。。省略部分内容</span><br><span class="line">InnoDB: Shutdown completed; log sequence number 1604657</span><br><span class="line">171130 19:40:38 completed OK!</span><br><span class="line"></span><br><span class="line">[root@mysql2 2017-11-30_19-29-40]# systemctl status mariadb     # 确认mysql数据库是停止的；</span><br><span class="line">● mariadb.service - MariaDB database server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mariadb.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line"></span><br><span class="line"># 开始恢复</span><br><span class="line">[root@mysql2 2017-11-30_19-29-40]# innobackupex --copy-back ./      # 开始恢复；</span><br><span class="line">171130 19:42:53 innobackupex: Starting the copy-back operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the copy-back run completes successfully.</span><br><span class="line">           At the end of a successful copy-back run innobackupex</span><br><span class="line">           prints &quot;completed OK!&quot;.</span><br><span class="line"></span><br><span class="line">innobackupex version 2.4.7 based on MySQL server 5.7.13 Linux (x86_64) (revision id: 05f1fcf)</span><br><span class="line">Original data directory /var/lib/mysql is not empty!        # 报错，提示/var/lib/mysql的目录不是空的；</span><br><span class="line">[root@mysql2 2017-11-30_19-29-40]# rm -rf /var/lib/mysql/*      # 清空/var/lib/mysql/下的所有内容；</span><br><span class="line">[root@mysql2 2017-11-30_19-29-40]# innobackupex --copy-back ./      # 再次恢复；</span><br><span class="line">171130 19:43:17 innobackupex: Starting the copy-back operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the copy-back run completes successfully.</span><br><span class="line">           At the end of a successful copy-back run innobackupex</span><br><span class="line">           prints &quot;completed OK!&quot;.</span><br><span class="line"></span><br><span class="line">innobackupex version 2.4.7 based on MySQL server 5.7.13 Linux (x86_64) (revision id: 05f1fcf)</span><br><span class="line">171130 19:43:17 [01] Copying ib_logfile0 to /var/lib/mysql/ib_logfile0</span><br><span class="line">171130 19:43:17 [01]        ...done</span><br><span class="line">。。。省略部分内容</span><br><span class="line">171130 19:43:17 [01] Copying ./ibtmp1 to /var/lib/mysql/ibtmp1</span><br><span class="line">171130 19:43:17 [01]        ...done</span><br><span class="line">171130 19:43:17 completed OK!       # 恢复成功；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 启动数据库</span><br><span class="line"></span><br><span class="line">[root@mysql2 2017-11-30_19-29-40]# systemctl start mariadb      # 直接启动会失败；</span><br><span class="line">Job for mariadb.service failed because the control process exited with error code. See &quot;systemctl status mariadb.service&quot; and &quot;journalctl -xe&quot; for details.</span><br><span class="line"></span><br><span class="line">[root@mysql2 2017-11-30_19-29-40]# cd /var/lib/mysql/</span><br><span class="line">[root@mysql2 mysql]# ll</span><br><span class="line">total 40972</span><br><span class="line">drwxr-x--- 2 root root       39 Nov 30 19:43 haiyundb</span><br><span class="line">-rw-r----- 1 root root 18874368 Nov 30 19:43 ibdata1</span><br><span class="line">-rw-r----- 1 root root  5242880 Nov 30 19:43 ib_logfile0</span><br><span class="line">-rw-r----- 1 root root  5242880 Nov 30 19:43 ib_logfile1</span><br><span class="line">-rw-r----- 1 root root 12582912 Nov 30 19:43 ibtmp1</span><br><span class="line">drwxr-x--- 2 root root     4096 Nov 30 19:43 mysql</span><br><span class="line">drwxr-x--- 2 root root     4096 Nov 30 19:43 performance_schema</span><br><span class="line">drwxr-x--- 2 root root       20 Nov 30 19:43 test</span><br><span class="line">-rw-r----- 1 root root      486 Nov 30 19:43 xtrabackup_info</span><br><span class="line">[root@mysql2 mysql]# chown -R mysql.mysql *         # 修改属主属组；</span><br><span class="line">[root@mysql2 mysql]# ll</span><br><span class="line">total 40972</span><br><span class="line">drwxr-x--- 2 mysql mysql       39 Nov 30 19:43 haiyundb</span><br><span class="line">-rw-r----- 1 mysql mysql 18874368 Nov 30 19:43 ibdata1</span><br><span class="line">-rw-r----- 1 mysql mysql  5242880 Nov 30 19:43 ib_logfile0</span><br><span class="line">-rw-r----- 1 mysql mysql  5242880 Nov 30 19:43 ib_logfile1</span><br><span class="line">-rw-r----- 1 mysql mysql 12582912 Nov 30 19:43 ibtmp1</span><br><span class="line">drwxr-x--- 2 mysql mysql     4096 Nov 30 19:43 mysql</span><br><span class="line">drwxr-x--- 2 mysql mysql     4096 Nov 30 19:43 performance_schema</span><br><span class="line">drwxr-x--- 2 mysql mysql       20 Nov 30 19:43 test</span><br><span class="line">-rw-r----- 1 mysql mysql      486 Nov 30 19:43 xtrabackup_info</span><br><span class="line">[root@mysql2 mysql]# systemctl start mariadb        # 再次启动OK；</span><br><span class="line">[root@mysql2 mysql]# mysql -uroot -phaiyun</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 2</span><br><span class="line">Server version: 5.5.52-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| haiyundb           |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; USE haiyundb</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MariaDB [haiyundb]&gt; SELECT * FROM student;</span><br><span class="line">+----+-------+------+--------+</span><br><span class="line">| id | name  | age  | gender |</span><br><span class="line">+----+-------+------+--------+</span><br><span class="line">|  1 | Stu1  |   76 | F      |</span><br><span class="line">|  2 | Stu2  |   47 | F      |</span><br><span class="line">|  3 | Stu3  |   32 | M      |</span><br><span class="line">|  4 | Stu4  |   95 | M      |</span><br><span class="line">|  5 | Stu5  |   42 | M      |</span><br><span class="line">|  6 | Stu6  |   57 | F      |</span><br><span class="line">|  7 | Stu7  |   39 | M      |</span><br><span class="line">|  8 | Stu8  |   23 | M      |</span><br><span class="line">|  9 | Stu9  |   85 | F      |</span><br><span class="line">| 10 | Stu10 |   64 | M      |</span><br><span class="line">| 11 | Stu11 |   73 | F      |</span><br><span class="line">| 12 | Stu12 |   76 | M      |</span><br><span class="line">| 13 | Stu13 |   45 | M      |</span><br><span class="line">| 14 | Stu14 |   63 | F      |</span><br><span class="line">| 15 | Stu15 |   94 | M      |</span><br><span class="line">| 16 | Stu16 |   38 | M      |</span><br><span class="line">| 17 | Stu17 |   57 | F      |</span><br><span class="line">| 18 | Stu18 |   19 | M      |</span><br><span class="line">| 19 | Stu19 |   20 | M      |</span><br><span class="line">| 20 | Stu20 |   58 | F      |</span><br><span class="line">| 21 | Stu21 |   20 | F      |</span><br><span class="line">| 22 | Stu22 |   45 | M      |</span><br><span class="line">| 23 | Stu23 |   63 | F      |</span><br><span class="line">| 24 | Stu24 |   39 | F      |</span><br><span class="line">| 25 | Stu25 |   72 | F      |</span><br><span class="line">| 26 | Stu26 |   18 | M      |</span><br><span class="line">| 27 | Stu27 |   90 | M      |</span><br><span class="line">| 28 | Stu28 |   56 | F      |</span><br><span class="line">| 29 | Stu29 |   64 | F      |</span><br><span class="line">| 30 | Stu30 |   79 | F      |</span><br><span class="line">| 31 | Stu31 |   64 | F      |</span><br><span class="line">| 32 | Stu32 |   78 | F      |</span><br><span class="line">| 33 | Stu33 |   31 | F      |</span><br><span class="line">| 34 | Stu34 |   26 | F      |</span><br><span class="line">| 35 | Stu35 |   26 | M      |</span><br><span class="line">| 36 | Stu36 |   80 | M      |</span><br><span class="line">| 37 | Stu37 |   95 | F      |</span><br><span class="line">| 38 | Stu38 |   52 | M      |</span><br><span class="line">| 39 | Stu39 |   24 | M      |</span><br><span class="line">| 40 | Stu40 |   96 | F      |</span><br><span class="line">| 41 | Stu41 |   54 | F      |</span><br><span class="line">| 42 | Stu42 |   83 | F      |</span><br><span class="line">| 43 | Stu43 |   58 | M      |</span><br><span class="line">| 44 | Stu44 |   60 | M      |</span><br><span class="line">| 45 | Stu45 |   32 | F      |</span><br><span class="line">| 46 | Stu46 |   91 | M      |</span><br><span class="line">| 47 | Stu47 |   33 | F      |</span><br><span class="line">| 48 | Stu48 |   47 | M      |</span><br><span class="line">| 49 | Stu49 |   76 | M      |</span><br><span class="line">| 50 | Stu50 |   75 | M      |</span><br><span class="line">| 51 | MySQL |   66 | M      |</span><br><span class="line">+----+-------+------+--------+</span><br><span class="line">51 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [haiyundb]&gt; Bye     # 数据已经成功恢复；</span><br></pre></td></tr></table></figure>
<h3 id="使用innobackupex进行增量备份"><a href="#使用innobackupex进行增量备份" class="headerlink" title="使用innobackupex进行增量备份"></a>使用innobackupex进行增量备份</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br></pre></td><td class="code"><pre><span class="line"># 首先进行全量备份；</span><br><span class="line">[root@mysql1 ~]# innobackupex --user=root --password=haiyun --host=localhost /backup/</span><br><span class="line">171130 20:03:43 innobackupex: Starting the backup operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the backup run completes successfully.</span><br><span class="line">           At the end of a successful backup run innobackupex</span><br><span class="line">           prints &quot;completed OK!&quot;.</span><br><span class="line"></span><br><span class="line">171130 20:03:43  version_check Connecting to MySQL server with DSN &apos;dbi:mysql:;mysql_read_default_group=xtrabackup;host=localhost&apos; as &apos;root&apos;  (using password: YES).</span><br><span class="line">171130 20:03:43  version_check Connected to MySQL server</span><br><span class="line">xtrabackup: Transaction log of lsn (1604367) to (1604367) was copied.</span><br><span class="line">171130 20:03:45 completed OK!</span><br><span class="line"></span><br><span class="line"># 修改数据库内容</span><br><span class="line">[root@mysql1 ~]# mysql -phaiyun</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 17</span><br><span class="line">Server version: 5.5.52-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; USE haiyundb;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MariaDB [haiyundb]&gt; SELECT * FROM student;</span><br><span class="line">+----+-------+------+--------+</span><br><span class="line">| id | name  | age  | gender |</span><br><span class="line">+----+-------+------+--------+</span><br><span class="line">|  1 | Stu1  |   76 | F      |</span><br><span class="line">|  2 | Stu2  |   47 | F      |</span><br><span class="line">|  3 | Stu3  |   32 | M      |</span><br><span class="line">|  4 | Stu4  |   95 | M      |</span><br><span class="line">|  5 | Stu5  |   42 | M      |</span><br><span class="line">|  6 | Stu6  |   57 | F      |</span><br><span class="line">|  7 | Stu7  |   39 | M      |</span><br><span class="line">|  8 | Stu8  |   23 | M      |</span><br><span class="line">|  9 | Stu9  |   85 | F      |</span><br><span class="line">| 10 | Stu10 |   64 | M      |</span><br><span class="line">| 11 | Stu11 |   73 | F      |</span><br><span class="line">| 12 | Stu12 |   76 | M      |</span><br><span class="line">| 13 | Stu13 |   45 | M      |</span><br><span class="line">| 14 | Stu14 |   63 | F      |</span><br><span class="line">| 15 | Stu15 |   94 | M      |</span><br><span class="line">| 16 | Stu16 |   38 | M      |</span><br><span class="line">| 17 | Stu17 |   57 | F      |</span><br><span class="line">| 18 | Stu18 |   19 | M      |</span><br><span class="line">| 19 | Stu19 |   20 | M      |</span><br><span class="line">| 20 | Stu20 |   58 | F      |</span><br><span class="line">| 21 | Stu21 |   20 | F      |</span><br><span class="line">| 22 | Stu22 |   45 | M      |</span><br><span class="line">| 23 | Stu23 |   63 | F      |</span><br><span class="line">| 24 | Stu24 |   39 | F      |</span><br><span class="line">| 25 | Stu25 |   72 | F      |</span><br><span class="line">| 26 | Stu26 |   18 | M      |</span><br><span class="line">| 27 | Stu27 |   90 | M      |</span><br><span class="line">| 28 | Stu28 |   56 | F      |</span><br><span class="line">| 29 | Stu29 |   64 | F      |</span><br><span class="line">| 30 | Stu30 |   79 | F      |</span><br><span class="line">| 31 | Stu31 |   64 | F      |</span><br><span class="line">| 32 | Stu32 |   78 | F      |</span><br><span class="line">| 33 | Stu33 |   31 | F      |</span><br><span class="line">| 34 | Stu34 |   26 | F      |</span><br><span class="line">| 35 | Stu35 |   26 | M      |</span><br><span class="line">| 36 | Stu36 |   80 | M      |</span><br><span class="line">| 37 | Stu37 |   95 | F      |</span><br><span class="line">| 38 | Stu38 |   52 | M      |</span><br><span class="line">| 39 | Stu39 |   24 | M      |</span><br><span class="line">| 40 | Stu40 |   96 | F      |</span><br><span class="line">| 41 | Stu41 |   54 | F      |</span><br><span class="line">| 42 | Stu42 |   83 | F      |</span><br><span class="line">| 43 | Stu43 |   58 | M      |</span><br><span class="line">| 44 | Stu44 |   60 | M      |</span><br><span class="line">| 45 | Stu45 |   32 | F      |</span><br><span class="line">| 46 | Stu46 |   91 | M      |</span><br><span class="line">| 47 | Stu47 |   33 | F      |</span><br><span class="line">| 48 | Stu48 |   47 | M      |</span><br><span class="line">| 49 | Stu49 |   76 | M      |</span><br><span class="line">| 50 | Stu50 |   75 | M      |</span><br><span class="line">| 51 | MySQL |   66 | M      |</span><br><span class="line">+----+-------+------+--------+</span><br><span class="line">51 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [haiyundb]&gt; DESC student;</span><br><span class="line">+--------+---------------------+------+-----+---------+-------+</span><br><span class="line">| Field  | Type                | Null | Key | Default | Extra |</span><br><span class="line">+--------+---------------------+------+-----+---------+-------+</span><br><span class="line">| id     | tinyint(3) unsigned | NO   | PRI | NULL    |       |</span><br><span class="line">| name   | varchar(20)         | NO   |     | NULL    |       |</span><br><span class="line">| age    | tinyint(3) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| gender | char(1)             | YES  |     | m       |       |</span><br><span class="line">+--------+---------------------+------+-----+---------+-------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [haiyundb]&gt; INSERT INTO student VALUES (66,&quot;Yeliangchen&quot;,88,&quot;F&quot;);       # 插入一条数据；</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [haiyundb]&gt; SELECT * FROM student;</span><br><span class="line">+----+-------------+------+--------+</span><br><span class="line">| id | name        | age  | gender |</span><br><span class="line">+----+-------------+------+--------+</span><br><span class="line">|  1 | Stu1        |   76 | F      |</span><br><span class="line">|  2 | Stu2        |   47 | F      |</span><br><span class="line">|  3 | Stu3        |   32 | M      |</span><br><span class="line">|  4 | Stu4        |   95 | M      |</span><br><span class="line">|  5 | Stu5        |   42 | M      |</span><br><span class="line">|  6 | Stu6        |   57 | F      |</span><br><span class="line">|  7 | Stu7        |   39 | M      |</span><br><span class="line">|  8 | Stu8        |   23 | M      |</span><br><span class="line">|  9 | Stu9        |   85 | F      |</span><br><span class="line">| 10 | Stu10       |   64 | M      |</span><br><span class="line">| 11 | Stu11       |   73 | F      |</span><br><span class="line">| 12 | Stu12       |   76 | M      |</span><br><span class="line">| 13 | Stu13       |   45 | M      |</span><br><span class="line">| 14 | Stu14       |   63 | F      |</span><br><span class="line">| 15 | Stu15       |   94 | M      |</span><br><span class="line">| 16 | Stu16       |   38 | M      |</span><br><span class="line">| 17 | Stu17       |   57 | F      |</span><br><span class="line">| 18 | Stu18       |   19 | M      |</span><br><span class="line">| 19 | Stu19       |   20 | M      |</span><br><span class="line">| 20 | Stu20       |   58 | F      |</span><br><span class="line">| 21 | Stu21       |   20 | F      |</span><br><span class="line">| 22 | Stu22       |   45 | M      |</span><br><span class="line">| 23 | Stu23       |   63 | F      |</span><br><span class="line">| 24 | Stu24       |   39 | F      |</span><br><span class="line">| 25 | Stu25       |   72 | F      |</span><br><span class="line">| 26 | Stu26       |   18 | M      |</span><br><span class="line">| 27 | Stu27       |   90 | M      |</span><br><span class="line">| 28 | Stu28       |   56 | F      |</span><br><span class="line">| 29 | Stu29       |   64 | F      |</span><br><span class="line">| 30 | Stu30       |   79 | F      |</span><br><span class="line">| 31 | Stu31       |   64 | F      |</span><br><span class="line">| 32 | Stu32       |   78 | F      |</span><br><span class="line">| 33 | Stu33       |   31 | F      |</span><br><span class="line">| 34 | Stu34       |   26 | F      |</span><br><span class="line">| 35 | Stu35       |   26 | M      |</span><br><span class="line">| 36 | Stu36       |   80 | M      |</span><br><span class="line">| 37 | Stu37       |   95 | F      |</span><br><span class="line">| 38 | Stu38       |   52 | M      |</span><br><span class="line">| 39 | Stu39       |   24 | M      |</span><br><span class="line">| 40 | Stu40       |   96 | F      |</span><br><span class="line">| 41 | Stu41       |   54 | F      |</span><br><span class="line">| 42 | Stu42       |   83 | F      |</span><br><span class="line">| 43 | Stu43       |   58 | M      |</span><br><span class="line">| 44 | Stu44       |   60 | M      |</span><br><span class="line">| 45 | Stu45       |   32 | F      |</span><br><span class="line">| 46 | Stu46       |   91 | M      |</span><br><span class="line">| 47 | Stu47       |   33 | F      |</span><br><span class="line">| 48 | Stu48       |   47 | M      |</span><br><span class="line">| 49 | Stu49       |   76 | M      |</span><br><span class="line">| 50 | Stu50       |   75 | M      |</span><br><span class="line">| 51 | MySQL       |   66 | M      |</span><br><span class="line">| 66 | Yeliangchen |   88 | F      |</span><br><span class="line">+----+-------------+------+--------+</span><br><span class="line">52 rows in set (0.00 sec)</span><br><span class="line">MariaDB [haiyundb]&gt; Bye</span><br><span class="line"></span><br><span class="line"># 进行第一次增量备份</span><br><span class="line"></span><br><span class="line">[root@mysql1 ~]# innobackupex --user=root --password=haiyun --host=localhost --incremental /backup/ --incremental-basedir=/backup/2017-11-30_20-03-43</span><br><span class="line">171130 20:13:26 innobackupex: Starting the backup operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the backup run completes successfully.</span><br><span class="line">           At the end of a successful backup run innobackupex</span><br><span class="line">           prints &quot;completed OK!&quot;.</span><br><span class="line"></span><br><span class="line">171130 20:13:26  version_check Connecting to MySQL server with DSN &apos;dbi:mysql:;mysql_read_default_group=xtrabackup;host=localhost&apos; as &apos;root&apos;  (using password: YES).</span><br><span class="line">。。。省略部分内容</span><br><span class="line">171130 20:13:28 [00]        ...done</span><br><span class="line">xtrabackup: Transaction log of lsn (1604727) to (1604727) was copied.</span><br><span class="line">171130 20:13:28 completed OK!       # 备份成功；</span><br><span class="line"></span><br><span class="line"># 修改数据</span><br><span class="line">MariaDB [(none)]&gt; USE haiyundb;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MariaDB [haiyundb]&gt; DELETE FROM student WHERE age=90;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"># 进行第二次增量备份</span><br><span class="line">[root@mysql1 ~]# ls /backup/</span><br><span class="line">2017-11-30_20-03-43  2017-11-30_20-13-26</span><br><span class="line">[root@mysql1 ~]# innobackupex --user=root --password=haiyun --host=localhost --incremental /backup/ --incremental-basedir=/backup/2017-11-30_20-13-26       # 注意此次增量针对的目录为2017-11-30_20-13-26，如果还是第一次增量备份的目录就是差异备份了；</span><br><span class="line">171130 20:23:04 innobackupex: Starting the backup operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the backup run completes successfully.</span><br><span class="line">           At the end of a successful backup run innobackupex</span><br><span class="line">           prints &quot;completed OK!&quot;.</span><br><span class="line"></span><br><span class="line">171130 20:23:04  version_check Connecting to MySQL server with DSN &apos;dbi:mysql:;mysql_read_default_group=xtrabackup;host=localhost&apos; as &apos;root&apos;  (using password: YES).</span><br><span class="line">xtrabackup: Transaction log of lsn (1605864) to (1605864) was copied.</span><br><span class="line">171130 20:23:06 completed OK!       # 备份成功；</span><br><span class="line"></span><br><span class="line"># 再次修改数据</span><br><span class="line">MariaDB [haiyundb]&gt; UPDATE student SET age=&apos;66&apos; WHERE age=80;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">## 恢复数据</span><br><span class="line">[root@mysql1 ~]# cd /backup/</span><br><span class="line">[root@mysql1 backup]# ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-x--- 6 root root 218 Nov 30 20:03 2017-11-30_20-03-43</span><br><span class="line">drwxr-x--- 6 root root 244 Nov 30 20:13 2017-11-30_20-13-26</span><br><span class="line">drwxr-x--- 6 root root 244 Nov 30 20:23 2017-11-30_20-23-04</span><br><span class="line">[root@mysql1 backup]# cd 2017-11-30_20-23-04/       # 进入最近一次的备份目录；</span><br><span class="line">[root@mysql1 2017-11-30_20-23-04]# cat xtrabackup_binlog_info       # 查看二进制日志文件和位置；</span><br><span class="line">master-log.000003	1066</span><br><span class="line">[root@mysql1 ~]# mysqlbinlog -j 843 /var/log/mariadb/master-log.000003 &gt; /root/binlog4.sql      # 将二进制日志导入到文件中；</span><br><span class="line"></span><br><span class="line">[root@mysql1 ~]# cd /backup/</span><br><span class="line">[root@mysql1 backup]# ll</span><br><span class="line">total 0</span><br><span class="line">drwxr-x--- 6 root root 218 Nov 30 20:03 2017-11-30_20-03-43</span><br><span class="line">drwxr-x--- 6 root root 244 Nov 30 20:13 2017-11-30_20-13-26</span><br><span class="line">drwxr-x--- 6 root root 244 Nov 30 20:23 2017-11-30_20-23-04</span><br><span class="line">[root@mysql1 backup]# cd 2017-11-30_20-03-43/</span><br><span class="line">[root@mysql1 2017-11-30_20-03-43]# innobackupex --apply-log --redo-only ./</span><br><span class="line">171130 20:41:03 innobackupex: Starting the apply-log operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the apply-log run completes successfully.</span><br><span class="line">           At the end of a successful apply-log run innobackupex</span><br><span class="line">           prints &quot;completed OK!&quot;.</span><br><span class="line"></span><br><span class="line">innobackupex version 2.4.7 based on MySQL server 5.7.13 Linux (x86_64) (revision id: 05f1fcf)</span><br><span class="line">xtrabackup: cd to /backup/2017-11-30_20-03-43/</span><br><span class="line">。。。</span><br><span class="line">InnoDB: Number of pools: 1</span><br><span class="line">171130 20:41:05 completed OK!</span><br><span class="line"></span><br><span class="line">[root@mysql1 2017-11-30_20-03-43]# innobackupex --apply-log --redo-only ./ --incremental-dir=/backup/2017-11-30_20-13-26       # 合并第一次增量</span><br><span class="line"></span><br><span class="line">[root@mysql1 2017-11-30_20-03-43]# innobackupex --apply-log --redo-only ./ --incremental-dir=/backup/2017-11-30_20-23-04       # 合并第一次增量</span><br><span class="line"></span><br><span class="line">[root@mysql1 2017-11-30_20-03-43]# innobackupex --apply-log  ./ </span><br><span class="line">[root@mysql1 backup]# scp -r 2017-11-30_20-03-43 192.168.8.15:</span><br><span class="line">root@192.168.8.15&apos;s password: </span><br><span class="line">ibdata1                                                        100%   18MB  18.0MB/s   00:00    </span><br><span class="line">db.frm                                                         100% 9582     9.4KB/s   00:00  </span><br><span class="line">。。。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@mysql2 ~]# cd 2017-11-30_20-03-43/</span><br><span class="line">[root@mysql2 2017-11-30_20-03-43]# innobackupex --copy-back ./</span><br><span class="line">[root@mysql2 2017-11-30_20-03-43]# cd /var/lib/mysql/</span><br><span class="line">[root@mysql2 mysql]# ll</span><br><span class="line">total 40976</span><br><span class="line">drwxr-x--- 2 root root       39 Nov 30 20:46 haiyundb</span><br><span class="line">-rw-r----- 1 root root 18874368 Nov 30 20:46 ibdata1</span><br><span class="line">-rw-r----- 1 root root  5242880 Nov 30 20:46 ib_logfile0</span><br><span class="line">-rw-r----- 1 root root  5242880 Nov 30 20:46 ib_logfile1</span><br><span class="line">-rw-r----- 1 root root 12582912 Nov 30 20:46 ibtmp1</span><br><span class="line">drwxr-x--- 2 root root     4096 Nov 30 20:46 mysql</span><br><span class="line">drwxr-x--- 2 root root     4096 Nov 30 20:46 performance_schema</span><br><span class="line">drwxr-x--- 2 root root       20 Nov 30 20:46 test</span><br><span class="line">-rw-r----- 1 root root       40 Nov 30 20:46 xtrabackup_binlog_pos_innodb</span><br><span class="line">-rw-r----- 1 root root      557 Nov 30 20:46 xtrabackup_info</span><br><span class="line">[root@mysql2 mysql]# chown -R mysql.mysql * </span><br><span class="line">[root@mysql2 mysql]# ll</span><br><span class="line">total 40976</span><br><span class="line">drwxr-x--- 2 mysql mysql       39 Nov 30 20:46 haiyundb</span><br><span class="line">-rw-r----- 1 mysql mysql 18874368 Nov 30 20:46 ibdata1</span><br><span class="line">-rw-r----- 1 mysql mysql  5242880 Nov 30 20:46 ib_logfile0</span><br><span class="line">-rw-r----- 1 mysql mysql  5242880 Nov 30 20:46 ib_logfile1</span><br><span class="line">-rw-r----- 1 mysql mysql 12582912 Nov 30 20:46 ibtmp1</span><br><span class="line">drwxr-x--- 2 mysql mysql     4096 Nov 30 20:46 mysql</span><br><span class="line">drwxr-x--- 2 mysql mysql     4096 Nov 30 20:46 performance_schema</span><br><span class="line">drwxr-x--- 2 mysql mysql       20 Nov 30 20:46 test</span><br><span class="line">-rw-r----- 1 mysql mysql       40 Nov 30 20:46 xtrabackup_binlog_pos_innodb</span><br><span class="line">-rw-r----- 1 mysql mysql      557 Nov 30 20:46 xtrabackup_info</span><br><span class="line">[root@mysql2 mysql]# systemctl start mariadb</span><br><span class="line"></span><br><span class="line">[root@mysql1 ~]# scp binlog4.sql 192.168.8.15:</span><br><span class="line">root@192.168.8.15&apos;s password: </span><br><span class="line">binlog4.sql                                                    100%  918     0.9KB/s   00:00    </span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; use haiyundb;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MariaDB [haiyundb]&gt; SET @@session.sql_log_bin=OFF;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [haiyundb]&gt; \. /tmp/binlog4.sql</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [haiyundb]&gt; SET @@session.sql_log_bin=ON;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [haiyundb]&gt; SELECT * FROM student WHERE age=80;     # 恢复成功；</span><br><span class="line">Empty set (0.01 sec)</span><br></pre></td></tr></table></figure>
<p>备份完成后进行全量备份；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">使用innobackupex进行增量备份</span><br><span class="line"></span><br><span class="line">每个InnoDB的页面都会包含一个LSN信息，每当相关的数据发生改变，相关的页面的LSN就会自动增长。这正是InnoDB表可以进行增量备份的基础，即innobackupex通过备份上次完全备份之后发生改变的页面来实现。</span><br><span class="line"></span><br><span class="line">要实现第一次增量备份，可以使用下面的命令进行：</span><br><span class="line"></span><br><span class="line"># innobackupex --incremental /backup --incremental-basedir=BASEDIR</span><br><span class="line"></span><br><span class="line">其中，BASEDIR指的是完全备份所在的目录，此命令执行结束后，innobackupex命令会在/backup目录中创建一个新的以时间命名的目录以存放所有的增量备份数据。另外，在执行过增量备份之后再一次进行增量备份时，其--incremental-basedir应该指向上一次的增量备份所在的目录。</span><br><span class="line"></span><br><span class="line">需要注意的是，增量备份仅能应用于InnoDB或XtraDB表，对于MyISAM表而言，执行增量备份时其实进行的是完全备份。</span><br><span class="line"></span><br><span class="line">“准备”(prepare)增量备份与整理完全备份有着一些不同，尤其要注意的是：</span><br><span class="line">(1)需要在每个备份(包括完全和各个增量备份)上，将已经提交的事务进行“重放”。“重放”之后，所有的备份数据将合并到完全备份上。</span><br><span class="line">(2)基于所有的备份将未提交的事务进行“回滚”。</span><br><span class="line"></span><br><span class="line">于是，操作就变成了：</span><br><span class="line"># innobackupex --apply-log --redo-only BASE-DIR</span><br><span class="line"></span><br><span class="line">接着执行：</span><br><span class="line"># innobackupex --apply-log --redo-only BASE-DIR --incremental-dir=INCREMENTAL-DIR-1</span><br><span class="line"></span><br><span class="line">而后是第二个增量：</span><br><span class="line"># innobackupex --apply-log --redo-only BASE-DIR --incremental-dir=INCREMENTAL-DIR-2</span><br><span class="line"></span><br><span class="line">其中BASE-DIR指的是完全备份所在的目录，而INCREMENTAL-DIR-1指的是第一次增量备份的目录，INCREMENTAL-DIR-2指的是第二次增量备份的目录，其它依次类推，即如果有多次增量备份，每一次都要执行如上操作；</span><br><span class="line"></span><br><span class="line">最后一个增量命令完成后，要在全量备份上做“回滚”操作。</span><br><span class="line"># innobackupex --apply-log BASE-DIR</span><br></pre></td></tr></table></figure>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>