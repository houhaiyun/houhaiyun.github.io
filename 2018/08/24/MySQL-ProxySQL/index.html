<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>基于Proxy SQL实现 MySQL主从复制的读写分离 | Peter's technology stack.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/MySQL读写分离/">MySQL读写分离</a></div><div class="post-time">2018-08-24</div></div></div><div class="container post-header"><h1>基于Proxy SQL实现 MySQL主从复制的读写分离</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#proxysql简介"><span class="toc-number">1.</span> <span class="toc-text">proxysql简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#环境"><span class="toc-number">2.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#环境准备"><span class="toc-number">3.</span> <span class="toc-text">环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#主机名"><span class="toc-number">3.1.</span> <span class="toc-text">主机名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#同步时间"><span class="toc-number">3.2.</span> <span class="toc-text">同步时间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装数据库"><span class="toc-number">4.</span> <span class="toc-text">安装数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开启MySQL主服务器二进制日志和server-id"><span class="toc-number">5.</span> <span class="toc-text">开启MySQL主服务器二进制日志和server_id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动MySQL主服务器并查看二进制日志status"><span class="toc-number">6.</span> <span class="toc-text">启动MySQL主服务器并查看二进制日志status</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开启MySQL从服务器中继日志和server-id并启动MySQL数据库"><span class="toc-number">7.</span> <span class="toc-text">开启MySQL从服务器中继日志和server_id并启动MySQL数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在MySQL主服务器授权用户"><span class="toc-number">8.</span> <span class="toc-text">在MySQL主服务器授权用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置MySQL从服务器复制参数"><span class="toc-number">9.</span> <span class="toc-text">设置MySQL从服务器复制参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试主从同步"><span class="toc-number">10.</span> <span class="toc-text">测试主从同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装proxysql-1-4-2"><span class="toc-number">11.</span> <span class="toc-text">安装proxysql-1.4.2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为proxysql授权用户"><span class="toc-number">12.</span> <span class="toc-text">为proxysql授权用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改proxysql配置文件"><span class="toc-number">13.</span> <span class="toc-text">修改proxysql配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动proxysql并连接数据库"><span class="toc-number">14.</span> <span class="toc-text">启动proxysql并连接数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过ProxySQL连接的数据库进行创建表，进行测试-默认连接的是主服务器，具有读写功能"><span class="toc-number">15.</span> <span class="toc-text">通过ProxySQL连接的数据库进行创建表，进行测试(默认连接的是主服务器，具有读写功能)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ProxySQL节点查看主从节点信息"><span class="toc-number">16.</span> <span class="toc-text">ProxySQL节点查看主从节点信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#致谢"><span class="toc-number">17.</span> <span class="toc-text">致谢</span></a></li></ol></details></div><div class="container post-content"><h3 id="proxysql简介"><a href="#proxysql简介" class="headerlink" title="proxysql简介"></a>proxysql简介</h3><a id="more"></a>
<p><a href="http://www.proxysql.com/" target="_blank" rel="noopener">proxysql</a> 是一个 MySQL 中间层的代理, 其源代码 <a href="https://github.com/sysown/proxysql" target="_blank" rel="noopener">proxysql</a>在github 上托管, 兼容 MySQL 协议, 所以同样支持 Percona 和 MariaDB 分之版本. 同类的产品有 <a href="https://github.com/Qihoo360/Atlas" target="_blank" rel="noopener">Atlas</a> 和 <a href="https://github.com/flike/kingshard" target="_blank" rel="noopener">kingshard</a>, 三者相比较起来, Atlas 和 kingshard 的功能类似, 仅能代理指定的库, 同样都支持表分区处理; proxysql 则可以代理整个实例, 配置方便则是 cnf 文件 + sqlite3 + runtime 的方式实现, 特别灵活, 不过目前还没有实现表分区功能, 其它功能可以在官网介绍中查找.</p>
<p>proxysql 的简单配置使用可以参考 <a href="https://www.percona.com/blog/2016/09/16/consul-proxysql-mysql-ha/" target="_blank" rel="noopener">consul-proxysql-mysql-ha</a><br>管理接口参见 <a href="https://github.com/sysown/proxysql/wiki/Tables-in-Admin-interface" target="_blank" rel="noopener">proxysql wiki</a></p>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><table>
<thead>
<tr>
<th>服务</th>
<th>IP</th>
<th>软件版本</th>
<th>系统版本</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>mariadb1</td>
<td>192.168.8.12</td>
<td>mariadb-server-5.5.52</td>
<td>CentOS Linux release 7.3.1611 (Core)</td>
<td>MySQL主服务器</td>
</tr>
<tr>
<td>mariadb2</td>
<td>192.168.8.15</td>
<td>mariadb-server-5.5.52</td>
<td>CentOS Linux release 7.3.1611 (Core)</td>
<td>MySQL从服务器</td>
</tr>
<tr>
<td>proxysql</td>
<td>192.168.8.17</td>
<td>proxysql-1.4.2-1</td>
<td>CentOS Linux release 7.3.1611 (Core)</td>
<td>实现读写分离</td>
</tr>
</tbody>
</table>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><h4 id="主机名"><a href="#主机名" class="headerlink" title="主机名"></a>主机名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># mysql1配置</span><br><span class="line">[root@master ~]# hostnamectl set-hostname mysql1.ihaiyun.cc &amp;&amp; exec bash </span><br><span class="line">[root@mysql1 ~]# </span><br><span class="line"></span><br><span class="line"># mysql2配置</span><br><span class="line">[root@slave ~]# hostnamectl set-hostname mysql2.ihaiyun.cc &amp;&amp; exec bash</span><br><span class="line">[root@mysql2 ~]# </span><br><span class="line"></span><br><span class="line"># proxy-sql配置</span><br><span class="line">[root@centos7 ~]# hostnamectl set-hostname proxy-sql.ihaiyun.cc &amp;&amp; exec bash</span><br><span class="line">[root@proxy-sql ~]# </span><br><span class="line"></span><br><span class="line"># 主机名也可以写到hosts文件中，或添加到DNS解析，本次实验就不做了</span><br></pre></td></tr></table></figure>
<h4 id="同步时间"><a href="#同步时间" class="headerlink" title="同步时间"></a>同步时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># mysql1配置</span><br><span class="line">[root@mysql1 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 4 Dec 11:31:53 ntpdate[13570]: adjust time server 172.18.0.1 offset 0.001148 sec</span><br><span class="line">[root@mysql1 ~]# date</span><br><span class="line">Mon Dec  4 11:31:54 CST 2017</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># mysql2配置</span><br><span class="line">[root@mysql2 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 4 Dec 11:31:53 ntpdate[13505]: adjust time server 172.18.0.1 offset 0.001293 sec</span><br><span class="line">[root@mysql2 ~]# date</span><br><span class="line">Mon Dec  4 11:31:54 CST 2017</span><br><span class="line"></span><br><span class="line"># proxy-sql配置</span><br><span class="line">[root@proxy-sql ~]# ntpdate 172.18.0.1</span><br><span class="line"> 4 Dec 11:31:53 ntpdate[2342]: step time server 172.18.0.1 offset 6.089175 sec</span><br><span class="line">[root@proxy-sql ~]# date</span><br><span class="line">Mon Dec  4 11:31:54 CST 2017</span><br></pre></td></tr></table></figure>
<h3 id="安装数据库"><a href="#安装数据库" class="headerlink" title="安装数据库"></a>安装数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># mysql1配置</span><br><span class="line">[root@mysql1 ~]# yum install -y mariadb-server</span><br><span class="line"></span><br><span class="line"># mysql2配置</span><br><span class="line">[root@mysql2 ~]# yum install -y mariadb-server</span><br></pre></td></tr></table></figure>
<h3 id="开启MySQL主服务器二进制日志和server-id"><a href="#开启MySQL主服务器二进制日志和server-id" class="headerlink" title="开启MySQL主服务器二进制日志和server_id"></a>开启MySQL主服务器二进制日志和server_id</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql1 ~]# vim /etc/my.cnf.d/server.cnf</span><br><span class="line">[server]</span><br><span class="line">skip_name_resolve = ON</span><br><span class="line">innodb_file_per_table = ON</span><br><span class="line"></span><br><span class="line">log_bin = /var/log/mariadb/bin-log</span><br><span class="line">server_id = 1</span><br></pre></td></tr></table></figure>
<h3 id="启动MySQL主服务器并查看二进制日志status"><a href="#启动MySQL主服务器并查看二进制日志status" class="headerlink" title="启动MySQL主服务器并查看二进制日志status"></a>启动MySQL主服务器并查看二进制日志status</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql1 ~]# systemctl start mariadb</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW MASTER STATUS;</span><br><span class="line">+----------------+----------+--------------+------------------+</span><br><span class="line">| File           | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+----------------+----------+--------------+------------------+</span><br><span class="line">| bin-log.000003 |      245 |              |                  |</span><br><span class="line">+----------------+----------+--------------+------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; Bye</span><br></pre></td></tr></table></figure>
<h3 id="开启MySQL从服务器中继日志和server-id并启动MySQL数据库"><a href="#开启MySQL从服务器中继日志和server-id并启动MySQL数据库" class="headerlink" title="开启MySQL从服务器中继日志和server_id并启动MySQL数据库"></a>开启MySQL从服务器中继日志和server_id并启动MySQL数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql2 ~]# vim /etc/my.cnf.d/server.cnf</span><br><span class="line">[server]</span><br><span class="line">skip_name_resolve = ON</span><br><span class="line">innodb_file_per_table = ON</span><br><span class="line"></span><br><span class="line">relay_log = /var/log/mariadb/relau-log</span><br><span class="line">server_id = 2</span><br><span class="line">read_only = ON      # 设置从服务器为只读，仅对没有MySQL超级管理权限的生效；</span><br><span class="line">[root@mysql2 ~]# systemctl start mariadb</span><br></pre></td></tr></table></figure>
<h3 id="在MySQL主服务器授权用户"><a href="#在MySQL主服务器授权用户" class="headerlink" title="在MySQL主服务器授权用户"></a>在MySQL主服务器授权用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; GRANT REPLICATION CLIENT,REPLICATION SLAVE ON *.*  TO &apos;repluser&apos;@&apos;192.168.8.15&apos; IDENTIFIED BY &apos;replpass&apos; ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="设置MySQL从服务器复制参数"><a href="#设置MySQL从服务器复制参数" class="headerlink" title="设置MySQL从服务器复制参数"></a>设置MySQL从服务器复制参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; CHANGE MASTER TO MASTER_HOST=&apos;192.168.8.12&apos;,MASTER_USER=&apos;repluser&apos;,MASTER_PASSWORD=&apos;replpass&apos;,MASTER_LOG_FILE=&apos;bin-log.000003&apos;,MASTER_LOG_POS=499;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: </span><br><span class="line">                  Master_Host: 192.168.8.12</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: bin-log.000003</span><br><span class="line">          Read_Master_Log_Pos: 499</span><br><span class="line">               Relay_Log_File: relay-log.000001</span><br><span class="line">                Relay_Log_Pos: 4</span><br><span class="line">        Relay_Master_Log_File: bin-log.000003</span><br><span class="line">             Slave_IO_Running: No</span><br><span class="line">            Slave_SQL_Running: No</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 499</span><br><span class="line">              Relay_Log_Space: 245</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: NULL</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 0</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; START SLAVE IO_THREAD,SQL_THREAD;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.8.12</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: bin-log.000003</span><br><span class="line">          Read_Master_Log_Pos: 499</span><br><span class="line">               Relay_Log_File: relay-log.000002</span><br><span class="line">                Relay_Log_Pos: 527</span><br><span class="line">        Relay_Master_Log_File: bin-log.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 499</span><br><span class="line">              Relay_Log_Space: 815</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="测试主从同步"><a href="#测试主从同步" class="headerlink" title="测试主从同步"></a>测试主从同步</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"># 在MySQL主服务器上面创建一个数据库mydb</span><br><span class="line">MariaDB [(none)]&gt; CREATE DATABASE mydb;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"># 在MySQL从服务器查看，已经同步</span><br><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mydb               |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW SLAVE STATUS\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.8.12</span><br><span class="line">                  Master_User: repluser</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: bin-log.000003</span><br><span class="line">          Read_Master_Log_Pos: 582</span><br><span class="line">               Relay_Log_File: relay-log.000002</span><br><span class="line">                Relay_Log_Pos: 610</span><br><span class="line">        Relay_Master_Log_File: bin-log.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 582</span><br><span class="line">              Relay_Log_Space: 898</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="安装proxysql-1-4-2"><a href="#安装proxysql-1-4-2" class="headerlink" title="安装proxysql-1.4.2"></a>安装proxysql-1.4.2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy-sql ~]# ls      # rpm包已经下载好；</span><br><span class="line">proxysql-1.4.2-1-centos7.x86_64.rpm</span><br><span class="line">[root@proxy-sql ~]# yum install -y proxysql-1.4.2-1-centos7.x86_64.rpm</span><br><span class="line">[root@proxy-sql ~]# rpm -ql proxysql        # 安装完成后生成的文件；</span><br><span class="line">/etc/init.d/proxysql</span><br><span class="line">/etc/proxysql.cnf</span><br><span class="line">/usr/bin/proxysql</span><br><span class="line">/usr/share/proxysql/tools/proxysql_galera_checker.sh</span><br><span class="line">/usr/share/proxysql/tools/proxysql_galera_writer.pl</span><br></pre></td></tr></table></figure>
<h3 id="为proxysql授权用户"><a href="#为proxysql授权用户" class="headerlink" title="为proxysql授权用户"></a>为proxysql授权用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; GRANT ALL ON *.* TO &apos;dbadmin&apos;@&apos;192.168.8.%&apos; IDENTIFIED BY &apos;dbpass&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="修改proxysql配置文件"><a href="#修改proxysql配置文件" class="headerlink" title="修改proxysql配置文件"></a>修改proxysql配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy-sql ~]# cp /etc/proxysql.cnf&#123;,.bak&#125;         # 备份配置文件；</span><br><span class="line"></span><br><span class="line">[root@proxy-sql ~]# vim /etc/proxysql.cnf</span><br><span class="line"></span><br><span class="line">datadir=&quot;/var/lib/proxysql&quot;         </span><br><span class="line"></span><br><span class="line">admin_variables=</span><br><span class="line">&#123;</span><br><span class="line">    admin_credentials=&quot;admin:admin&quot;         # 用户名和密码；</span><br><span class="line">    mysql_ifaces=&quot;127.0.0.1:6032;/tmp/proxysql_admin.sock&quot;      # 监听的端口活着本地链接sock；</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mysql_variables=</span><br><span class="line">&#123;</span><br><span class="line">    threads=4           # 并发线程，单线程响应多个请求。建议为CPU核心数；</span><br><span class="line">    max_connections=2048        # 最大连接数；</span><br><span class="line">    default_query_delay=0       # 默认查询延迟时间</span><br><span class="line">    default_query_timeout=36000000      # 默认查询超时时间</span><br><span class="line">    have_compress=true      # 是否压缩</span><br><span class="line">    poll_timeout=2000       # 轮询时超时时间</span><br><span class="line">    interfaces=&quot;0.0.0.0:3306;/tmp/mysql.sock&quot;       # 本地监听转发端口，用户通过此端口来访问；</span><br><span class="line">    default_schema=&quot;information_schema&quot;         # 用户连接后默认使用的数据库；</span><br><span class="line">    stacksize=1048576           # 栈大小；</span><br><span class="line">    server_version=&quot;5.5.30&quot;         # 服务器版本；</span><br><span class="line">    connect_timeout_server=3000     # 连接超时时间；</span><br><span class="line">    monitor_username=&quot;monitor&quot;      </span><br><span class="line">    monitor_password=&quot;monitor&quot;</span><br><span class="line">    monitor_history=600000</span><br><span class="line">    monitor_connect_interval=60000</span><br><span class="line">    monitor_ping_interval=10000</span><br><span class="line">    monitor_read_only_interval=1500</span><br><span class="line">    monitor_read_only_timeout=500</span><br><span class="line">    ping_interval_server_msec=120000</span><br><span class="line">    ping_timeout_server=500</span><br><span class="line">    commands_stats=true</span><br><span class="line">    sessions_sort=true</span><br><span class="line">    connect_retries_on_failure=10</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># MySQL服务器组</span><br><span class="line">mysql_servers =</span><br><span class="line">(</span><br><span class="line">    &#123;           # 主节点(mysql1)；</span><br><span class="line">        address = &quot;192.168.8.12&quot;        # MySQL server IP；</span><br><span class="line">        port = 3306                     # Port；</span><br><span class="line">        hostgroup = 0                   # 组；</span><br><span class="line">        status = &quot;ONLINE&quot;               # 在线还是离线；</span><br><span class="line">        weight = 1                      # 权重；</span><br><span class="line">        compression = 0                 # 是否压缩；</span><br><span class="line">        max_connections=200             # 最大并发连接数；</span><br><span class="line"># max_replication_lag = 10       # 如果是读服务器，是否启用延迟。尽量不要开启；    </span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    &#123;           # 从节点(mysql2)；</span><br><span class="line">        address = &quot;192.168.8.15&quot;</span><br><span class="line">        port = 3306           </span><br><span class="line">        hostgroup = 1         </span><br><span class="line">        status = &quot;ONLINE&quot;     </span><br><span class="line">        weight = 1            </span><br><span class="line">        compression = 0    </span><br><span class="line"># max_replication_lag = 10       # 如果是读服务器，是否启用延迟。尽量不要开启；   </span><br><span class="line">    &#125;</span><br><span class="line">    # 注意最后一个&#123;，这个后面没有逗号</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 登录后端MySQL主机的账号和密码</span><br><span class="line">mysql_users:</span><br><span class="line">(</span><br><span class="line">    &#123;</span><br><span class="line">        username = &quot;dbadmin&quot;        # 用户名；</span><br><span class="line">        password = &quot;dbpass&quot;         # 密码；</span><br><span class="line">        default_hostgroup = 0       # 默认连接到哪个组中，默认连接到主服务组；</span><br><span class="line">        active = 1                  # 是否激活；</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 语句路由，将指定的SQL语句，路由到指定的服务器上</span><br><span class="line">mysql_query_rules:</span><br><span class="line">(</span><br><span class="line">    &#123;</span><br><span class="line">        rule_id=1</span><br><span class="line">        active=1</span><br><span class="line">        match_pattern=&quot;^SELECT .* FOR UPDATE$&quot;</span><br><span class="line">        destination_hostgroup=0</span><br><span class="line">        apply=1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        rule_id=2</span><br><span class="line">        active=1</span><br><span class="line">        match_pattern=&quot;^SELECT&quot;</span><br><span class="line">        destination_hostgroup=1</span><br><span class="line">        apply=1</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># MySQL复制集群的定义：指定读组、写组</span><br><span class="line"># 这里组号是之前在mysql_servers段中设置的hostgroup的ID</span><br><span class="line">mysql_replication_hostgroups=</span><br><span class="line">(</span><br><span class="line">        &#123;       </span><br><span class="line">                writer_hostgroup=0                  # 写组；</span><br><span class="line">                reader_hostgroup=1                  # 读组；</span><br><span class="line">                comment=&quot;Application Server&quot;        # 注释信息；</span><br><span class="line">       &#125;</span><br><span class="line">#       &#123;</span><br><span class="line">#                writer_hostgroup=50</span><br><span class="line">#                reader_hostgroup=60</span><br><span class="line">#                comment=&quot;test repl 2&quot;</span><br><span class="line">#        &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="启动proxysql并连接数据库"><a href="#启动proxysql并连接数据库" class="headerlink" title="启动proxysql并连接数据库"></a>启动proxysql并连接数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy-sql ~]# systemctl start proxysql</span><br><span class="line"></span><br><span class="line">[root@proxy-sql ~]# ss -tnl     # 查看端口，已经开启；</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port                Peer Address:Port              </span><br><span class="line">LISTEN      0      128                *:3306                           *:*                  </span><br><span class="line">LISTEN      0      128                *:3306                           *:*                  </span><br><span class="line">LISTEN      0      128                *:3306                           *:*                  </span><br><span class="line">LISTEN      0      128                *:3306                           *:*                  </span><br><span class="line">LISTEN      0      128        127.0.0.1:6032                           *:*                  </span><br><span class="line">LISTEN      0      128                *:22                             *:*                  </span><br><span class="line">LISTEN      0      100        127.0.0.1:25                             *:*                  </span><br><span class="line">LISTEN      0      128               :::22                            :::*                  </span><br><span class="line">LISTEN      0      100              ::1:25                            :::*      </span><br><span class="line"></span><br><span class="line">[root@proxy-sql ~]# mysql -h 192.168.8.17 -udbadmin -pdbpass        # 这里的用户和密码是MySQL的密码，而非proxySQL的管理账号密码;</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 1</span><br><span class="line">Server version: 5.5.30 (ProxySQL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; Bye</span><br></pre></td></tr></table></figure>
<h3 id="通过ProxySQL连接的数据库进行创建表，进行测试-默认连接的是主服务器，具有读写功能"><a href="#通过ProxySQL连接的数据库进行创建表，进行测试-默认连接的是主服务器，具有读写功能" class="headerlink" title="通过ProxySQL连接的数据库进行创建表，进行测试(默认连接的是主服务器，具有读写功能)"></a>通过ProxySQL连接的数据库进行创建表，进行测试(默认连接的是主服务器，具有读写功能)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; CREATE DATABASE DB;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| DB                 |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; USE DB;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [DB]&gt; CREATE TABLE T1 (id int(10));</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [DB]&gt; SHOW TABLES;</span><br><span class="line">+--------------+</span><br><span class="line">| Tables_in_DB |</span><br><span class="line">+--------------+</span><br><span class="line">| T1           |</span><br><span class="line">+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在主服务器和两台从节点查看是否创建了tb1这张表，如果有，则成功；</span><br></pre></td></tr></table></figure>
<h3 id="ProxySQL节点查看主从节点信息"><a href="#ProxySQL节点查看主从节点信息" class="headerlink" title="ProxySQL节点查看主从节点信息"></a>ProxySQL节点查看主从节点信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@proxy-sql ~]# mysql -h 127.0.0.1 -uadmin -padmin -P6032       # 通过管理接口连接；</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)      # 注意标识符是不同的；</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line">MySQL [(none)]&gt; SHOW TABLES;        # 查看所有表</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| tables                                     |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| global_variables                           |</span><br><span class="line">| mysql_collations                           |</span><br><span class="line">| mysql_group_replication_hostgroups         |</span><br><span class="line">| mysql_query_rules                          |</span><br><span class="line">| mysql_replication_hostgroups               |</span><br><span class="line">| mysql_servers                              |</span><br><span class="line">| mysql_users                                |</span><br><span class="line">| proxysql_servers                           |</span><br><span class="line">| runtime_checksums_values                   |</span><br><span class="line">| runtime_global_variables                   |</span><br><span class="line">| runtime_mysql_group_replication_hostgroups |</span><br><span class="line">| runtime_mysql_query_rules                  |</span><br><span class="line">| runtime_mysql_replication_hostgroups       |</span><br><span class="line">| runtime_mysql_servers                      |</span><br><span class="line">| runtime_mysql_users                        |</span><br><span class="line">| runtime_proxysql_servers                   |</span><br><span class="line">| runtime_scheduler                          |</span><br><span class="line">| scheduler                                  |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">18 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SELECT hostgroup_id,hostname,port,status FROM mysql_servers;</span><br><span class="line">+--------------+--------------+------+--------+</span><br><span class="line">| hostgroup_id | hostname     | port | status |</span><br><span class="line">+--------------+--------------+------+--------+</span><br><span class="line">| 0            | 192.168.8.12 | 3306 | ONLINE |</span><br><span class="line">| 1            | 192.168.8.15 | 3306 | ONLINE |</span><br><span class="line">+--------------+--------------+------+--------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SELECT * FROM mysql_servers;        # 查看你MySQL server；</span><br><span class="line">+--------------+--------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname     | port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+--------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 0            | 192.168.8.12 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 1            | 192.168.8.15 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+--------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; SELECT * FROM runtime_mysql_replication_hostgroups;     # 查看组信息；</span><br><span class="line">+------------------+------------------+--------------------+</span><br><span class="line">| writer_hostgroup | reader_hostgroup | comment            |</span><br><span class="line">+------------------+------------------+--------------------+</span><br><span class="line">| 0                | 1                | Application Server |</span><br><span class="line">+------------------+------------------+--------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://maxiecloud.com/2017/07/14/mysql-replication/" target="_blank" rel="noopener">MySQL Replication 主从复制：http://maxiecloud.com/2017/07/14/mysql-replication/</a></p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>