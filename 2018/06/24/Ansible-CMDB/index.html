<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>Ansible CMDB | Peter's technology stack.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/CMDB/">CMDB</a></div><div class="post-time">2018-06-24</div></div></div><div class="container post-header"><h1>Ansible CMDB</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">2.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-安装-ansible"><span class="toc-number">2.1.</span> <span class="toc-text">1. 安装 ansible</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-下载并安装-ansible-cmdb"><span class="toc-number">2.2.</span> <span class="toc-text">2. 下载并安装 ansible-cmdb</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-ansible-cmdb"><span class="toc-number">3.</span> <span class="toc-text">使用 ansible-cmdb</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基本"><span class="toc-number">3.1.</span> <span class="toc-text">基本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#完全使用"><span class="toc-number">3.2.</span> <span class="toc-text">完全使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#库存扫描"><span class="toc-number">3.3.</span> <span class="toc-text">库存扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模板"><span class="toc-number">3.4.</span> <span class="toc-text">模板</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#指定模板"><span class="toc-number">3.4.1.</span> <span class="toc-text">指定模板</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#模板参数"><span class="toc-number">3.4.2.</span> <span class="toc-text">模板参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#标准可用模板"><span class="toc-number">3.4.3.</span> <span class="toc-text">标准可用模板</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#html-fancy"><span class="toc-number">3.4.3.1.</span> <span class="toc-text">html_fancy</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#html-fancy-split"><span class="toc-number">3.4.3.2.</span> <span class="toc-text">html_fancy_split</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#sql"><span class="toc-number">3.4.3.3.</span> <span class="toc-text">sql</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#事实缓存"><span class="toc-number">3.4.3.4.</span> <span class="toc-text">事实缓存</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#列"><span class="toc-number">3.4.3.5.</span> <span class="toc-text">列</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#致谢"><span class="toc-number">4.</span> <span class="toc-text">致谢</span></a></li></ol></details></div><div class="container post-content"><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><a href="https://github.com/fboender/ansible-cmdb" target="_blank" rel="noopener">github项目地址：https://github.com/fboender/ansible-cmdb</a></p>
<p><a href="http://ansible-cmdb.readthedocs.io/en/latest/" target="_blank" rel="noopener">官方文档：http://ansible-cmdb.readthedocs.io/en/latest/</a></p>
<p>Ansible-cmdb将Ansible 实际收集的输出信息 转换为包含系统配置信息的静态HTML概述页面（以及其他内容）。</p>
<p>它支持多种类型的输出（html，csv，sql等），并将由Ansible收集的信息与自定义数据进行扩展。对于每个主机，它还显示组，主机变量，自定义变量和机器本地事实。</p>
<a id="more"></a>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>本实验使用环境如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">IP</th>
<th style="text-align:center">系统版本</th>
<th style="text-align:center">软件版本</th>
<th style="text-align:center">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">192.168.8.12/24</td>
<td style="text-align:center">CentOS Linux release 7.3.1611 (Core)</td>
<td style="text-align:center">ansible 2.4.2.0  ansible-cmdb.py v1.27</td>
<td style="text-align:center">ansible-cmdb</td>
</tr>
<tr>
<td style="text-align:center">192.168.8.14/24</td>
<td style="text-align:center">CentOS Linux release 7.3.1611 (Core)</td>
<td style="text-align:center"></td>
<td style="text-align:center">应用服务</td>
</tr>
</tbody>
</table>
<h4 id="1-安装-ansible"><a href="#1-安装-ansible" class="headerlink" title="1. 安装 ansible"></a>1. 安装 ansible</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ansible</span><br></pre></td></tr></table></figure>
<h4 id="2-下载并安装-ansible-cmdb"><a href="#2-下载并安装-ansible-cmdb" class="headerlink" title="2. 下载并安装 ansible-cmdb"></a>2. 下载并安装 ansible-cmdb</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/fboender/ansible-cmdb/releases/download/1.27/ansible-cmdb-1.27-2.noarch.rpm</span><br><span class="line"></span><br><span class="line">yum install -y ./ansible-cmdb-1.27-2.noarch.rpm</span><br></pre></td></tr></table></figure>
<h3 id="使用-ansible-cmdb"><a href="#使用-ansible-cmdb" class="headerlink" title="使用 ansible-cmdb"></a>使用 ansible-cmdb</h3><h4 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h4><p>首先，为你的主机生成 Asible 输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir out</span><br><span class="line"></span><br><span class="line">ansible -m setup --tree out/ all</span><br></pre></td></tr></table></figure>
<p>接下来，再生成的 out/ 目录调用 ansible CMDB 以生成 CMDB概览界面：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-cmdb out/ &gt; overview.html</span><br></pre></td></tr></table></figure>
<p>默认模板是 html_fancy，它使用 jQuery。</p>
<p>访问效果：</p>
<center><img src="https://houhaiyun.github.io/img/images/Ansible-CMDB-1.gif" title="Ansible-CMDB"></center>


<h4 id="完全使用"><a href="#完全使用" class="headerlink" title="完全使用"></a>完全使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Usage: ansible-cmdb.py [option] &lt;dir&gt; &gt; output.html</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  --version             show program&apos;s version number and exit</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -t TEMPLATE, --template=TEMPLATE</span><br><span class="line">                        Template to use. Default is &apos;html_fancy&apos;</span><br><span class="line">  -i INVENTORY, --inventory=INVENTORY</span><br><span class="line">                        Inventory to read extra info from</span><br><span class="line">  -f, --fact-cache      &lt;dir&gt; contains fact-cache files</span><br><span class="line">  -p PARAMS, --params=PARAMS</span><br><span class="line">                        Params to send to template</span><br><span class="line">  -d, --debug           Show debug output</span><br><span class="line">  -q, --quiet           Don&apos;t report warnings</span><br><span class="line">  -c COLUMNS, --columns=COLUMNS</span><br><span class="line">                        Show only given columns</span><br><span class="line">  --exclude-cols=EXCLUDE_COLUMNS</span><br><span class="line">                        Exclude cols from output</span><br></pre></td></tr></table></figure>
<h4 id="库存扫描"><a href="#库存扫描" class="headerlink" title="库存扫描"></a>库存扫描</h4><p>ansible cmdb 可以读取库存文件（hosts，默认情况下），库存目录或者动态库存，并从中提取有用的信息，例如：</p>
<ul>
<li>主机所属的所有组</li>
<li>主机变量：每个主机都可以选择的键/值对，可以再剧本中使用。通过 ansible cmdb 扫描它们并将它添加到 ‘hostvars’ 部分下发县的 facts。</li>
</ul>
<p>读取清单是使用 -i switch 来实现 cmdb 的。它需要一个参数：包含主机文件或者动态库存脚本路径的主机文件目录。可以通过将多个清单文件与逗号（不包含空格）分开来指定多个清单文件。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-cmdb -i ./hosts out/ &gt; overview.html</span><br></pre></td></tr></table></figure>
<p>如果在该位置存在 host_vars 和 / 或者 group_vars 目录，也将读取它们。</p>
<p>“html_fancy” 模板使用四个额外的字段：</p>
<ul>
<li>groups：主机所属的 Ansible 组的列表</li>
<li>dtap：主机是否是开发、测试、验收或者生产系统</li>
<li>comment：主机的注释</li>
<li>ext_id：主机的外部唯一标识符</li>
</ul>
<p>假设我们有如下 hosts file：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[cmdb]</span><br><span class="line">192.168.8.12    dtap=test comment=&quot;New database server&quot;</span><br><span class="line">192.168.8.14    dtap=dev comment=&quot;Old database server&quot;</span><br></pre></td></tr></table></figure>
<h4 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h4><h5 id="指定模板"><a href="#指定模板" class="headerlink" title="指定模板"></a>指定模板</h5><p>ansible-cmdb 提供多个模板你可以使用 -t 或者 –template 参数选择你的模板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-cmdb -t html_fancy_split out/ overview.html</span><br></pre></td></tr></table></figure>
<p>‘html_fancy’ 模板是默认模板</p>
<p>模板可以由 NAME 引用，也可以由 .tpl 文件的相对/绝对路径引用。这允许你实现自己的模板。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-cmdb -t/home/fboender/my_template out/&gt; my_template.html</span><br></pre></td></tr></table></figure>
<h5 id="模板参数"><a href="#模板参数" class="headerlink" title="模板参数"></a>模板参数</h5><p>某些模板支持影响它的输出的参数。蚕食使用 -p 或者 –parameter 选项指定为 ansible-cmdb。可以通过逗号分隔多个参数来指定参数，参数中必须有空格。</p>
<p>例如：要指定带有不呢地 Javascript 库和关闭数的 html_fancy 模板，请执行以下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-cmdb -t html_fancy -p local_js=1,collapsed=1 out&gt; overview.html</span><br></pre></td></tr></table></figure>
<h5 id="标准可用模板"><a href="#标准可用模板" class="headerlink" title="标准可用模板"></a>标准可用模板</h5><p>ansible cmdb 目前提供了以下模板：</p>
<ul>
<li>html_fancy：一个办好所有主机的动态的现代 HTML 页面</li>
<li>html_fancy_split：一个动态的现代 HTML 页面，每个细节都包含在一个单独的文件中</li>
<li>txt_table：一个快速文件 table 摘要，其中包含一些最少的信息</li>
<li>json：转储所有包括组、变量、自定义信息（JSON格式）的主机</li>
<li>csv：CSV 模板输出主机的 CSV 文件</li>
<li>markdown：Markdown 模板以 Markdown 格式生成主机信息</li>
<li>收费：SQL 模板生成一个可以加载到 SQLite 或者 MySQL 数据库的 .sql 文件</li>
</ul>
<h6 id="html-fancy"><a href="#html-fancy" class="headerlink" title="html_fancy"></a>html_fancy</h6><p>一个奇妙的 HTML 页面，使用 jQuery 和数据表给你一个可以搜索的和可以排序的 table 概述。</p>
<p>它采用可选参数：</p>
<ul>
<li>local_js=0|1：从本地磁盘（default=0）加载资源。如果设置，将从本地磁盘加载资源，而不是通过网络加载资源。</li>
<li>collapsed=0|1：控制默认情况下是否折叠主机信息。值为1，将通过 defaultcontrols 对所有主机进行 collapse 处理。默认情况下，1的值将 collapse 所有主机信息。（default=’0’）</li>
<li>host_details=0|1：渲染主机详细信。（default=1）</li>
<li>skip_empty=0|1：跳过没有收集事实的主机（无法接通等）。（default=0）</li>
</ul>
<h6 id="html-fancy-split"><a href="#html-fancy-split" class="headerlink" title="html_fancy_split"></a>html_fancy_split</h6><p>这个模板与 html_fancy 模板基本相同，但是它生成带有一个 index.html 文件的 cmdb/ 目录，并为每一个主机生成一个独立的 html 文件</p>
<p>使用方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-cmdb -t html_fancy_split out/</span><br></pre></td></tr></table></figure>
<p>它接受与 html_fancy 模板相同的参数</p>
<h6 id="sql"><a href="#sql" class="headerlink" title="sql"></a>sql</h6><p>sql 模板生成一个 .sql 文件，可以加载到 SQLite 或者 MySQL 数据库中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ansible-cmdb -t sql  out/ &gt; cmdb.sql</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# head cmdb.sql </span><br><span class="line">DROP TABLE IF EXISTS hosts;</span><br><span class="line">CREATE TABLE hosts (</span><br><span class="line">    name VARCHAR(255),</span><br><span class="line">    fqdn VARCHAR(255),</span><br><span class="line">    main_ip VARCHAR(15),</span><br><span class="line">    os_name VARCHAR(80),</span><br><span class="line">    os_version VARCHAR(40),</span><br><span class="line">    system VARCHAR(40),</span><br><span class="line">    kernel VARCHAR(40),</span><br><span class="line">    arch_hardware VARCHAR(12),</span><br><span class="line"></span><br><span class="line">echo&quot;CREATE DATABASE ansiblecmdb&quot; | mysql </span><br><span class="line"></span><br><span class="line">mysql ansiblecmdb &lt;cmdb.sql</span><br></pre></td></tr></table></figure>
<h6 id="事实缓存"><a href="#事实缓存" class="headerlink" title="事实缓存"></a>事实缓存</h6><p>Ansible 可以在运行剧本时从主机缓存事实，这中配置在 Ansible 配置文件中修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">fact_caching=jsonfile</span><br><span class="line">fact_caching_connection =/path/to/facts/dir</span><br></pre></td></tr></table></figure>
<p>通过指定 -f(–fact-cache) 选项，你可以将这些缓存的事实用作 facts cmdb 的事实目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-cmdb -f/path/to/facts/dir&gt; overview.html</span><br></pre></td></tr></table></figure>
<p>请注意，–fact-cache 选项将应用于你指定的所有事实目录。这意味着不能混合事实缓存事实目录的普通 setup 事实目录。另外，如果希望手动扩展（查看 Extending 章节），必须省略 ansible_facts 键并将项目放在 JSON 的 root 中。</p>
<h6 id="列"><a href="#列" class="headerlink" title="列"></a>列</h6><p>一些模板，如 txt_table 和 html_fancy，支持列。如果支持列，则可以使用 –columns/-c 命令行选项指定要显示的列。</p>
<p>–columns 采用一个逗号分隔列的列表。列必须由它们的 id 字段指定。有关模板支持那些 id 字段的信息，请在模板中查看。通常是列标题，但在 lowercase 中，也有用下划线替换的空格。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# ansible-cmdb -t txt_table --columns name,os,ip,mem,cpus out/</span><br><span class="line">Name          OS               IP               Mem  CPUs  </span><br><span class="line">------------  ---------------  ---------------  ---  ----  </span><br><span class="line">192.168.8.14  CentOS 7.3.1611  192.168.139.151  2g   2     </span><br><span class="line">192.168.8.12  CentOS 7.3.1611  192.168.139.129  2g   2</span><br></pre></td></tr></table></figure>
<h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://ansible-cmdb.readthedocs.io/en/latest/" target="_blank" rel="noopener">官方文档：http://ansible-cmdb.readthedocs.io/en/latest/</a></p>
<p><a href="https://www.helplib.com/GitHub/article_127990" target="_blank" rel="noopener">帮酷：ansible-cmdb</a></p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>