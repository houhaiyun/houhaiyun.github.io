<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>Nginx编译并添加ngx_cache_purge模块 | Keep learn!</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Nginx/">Nginx</a></div><div class="post-time">2018-09-04</div></div></div><div class="container post-header"><h1>Nginx编译并添加ngx_cache_purge模块</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装必备软件包"><span class="toc-number">1.</span> <span class="toc-text">安装必备软件包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下载nginx源码包"><span class="toc-number">2.</span> <span class="toc-text">下载nginx源码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下载ngx-cache-purge模块"><span class="toc-number">3.</span> <span class="toc-text">下载ngx_cache_purge模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解压"><span class="toc-number">4.</span> <span class="toc-text">解压</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加nginx用户"><span class="toc-number">5.</span> <span class="toc-text">添加nginx用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译安装"><span class="toc-number">6.</span> <span class="toc-text">编译安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译参数说明"><span class="toc-number">7.</span> <span class="toc-text">编译参数说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动测试"><span class="toc-number">8.</span> <span class="toc-text">启动测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看已经编译模块"><span class="toc-number">9.</span> <span class="toc-text">查看已经编译模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#致谢"><span class="toc-number">10.</span> <span class="toc-text">致谢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-配置文件"><span class="toc-number">11.</span> <span class="toc-text">Nginx 配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#清除缓存"><span class="toc-number">12.</span> <span class="toc-text">清除缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#方法一"><span class="toc-number">12.1.</span> <span class="toc-text">方法一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#方法二"><span class="toc-number">12.2.</span> <span class="toc-text">方法二</span></a></li></ol></li></ol></details></div><div class="container post-content"><h3 id="安装必备软件包"><a href="#安装必备软件包" class="headerlink" title="安装必备软件包"></a>安装必备软件包</h3><a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># yum -y install  openssl-devel pcre-devel      # 安装必备包</span><br><span class="line"># yum install gcc make gcc-c++  autoconf automake      # 安装编译工具</span><br><span class="line"># yum -y groupinstall &apos;Development Tools&apos;</span><br><span class="line"># yum install -y libxml2 libxslt    </span><br><span class="line"># yum -y install libxslt-devel</span><br><span class="line"># yum -y install gd-devel</span><br><span class="line"># yum -y install perl-devel perl-ExtUtils-Embed</span><br><span class="line"># yum -y install GeoIP GeoIP-devel GeoIP-data</span><br><span class="line"># yum -y install zlib-devel</span><br><span class="line"># </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 脚本</span><br><span class="line"># cat install.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">yum -y install  openssl-devel pcre-devel         </span><br><span class="line">yum -y install gcc make gcc-c++  autoconf automake  </span><br><span class="line">yum -y install  libxml2 libxslt    </span><br><span class="line">yum -y install libxslt-devel</span><br><span class="line">yum -y install gd-devel</span><br><span class="line">yum -y install perl-devel perl-ExtUtils-Embed</span><br><span class="line">yum -y install GeoIP GeoIP-devel GeoIP-data</span><br><span class="line">yum -y install zlib-devel</span><br><span class="line">yum -y groupinstall &apos;Development Tools&apos;</span><br></pre></td></tr></table></figure>
<h3 id="下载nginx源码包"><a href="#下载nginx源码包" class="headerlink" title="下载nginx源码包"></a>下载nginx源码包</h3><p>目前稳定的版本是<code>1.14.0</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget   http://nginx.org/download/nginx-1.14.0.tar.gz      # 下载源码包</span><br></pre></td></tr></table></figure>
<h3 id="下载ngx-cache-purge模块"><a href="#下载ngx-cache-purge模块" class="headerlink" title="下载ngx_cache_purge模块"></a>下载ngx_cache_purge模块</h3><p>使用 ngx_cache_purge 实现更强大的缓存清除功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># wget http://labs.frickle.com/files/ngx_cache_purge-2.3.tar.gz</span><br></pre></td></tr></table></figure>
<h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 解压到/usr/local/src/目录下</span><br><span class="line"># tar xf ngx_cache_purge-2.3.tar.gz -C /usr/local/src/</span><br><span class="line"># tar xf nginx-1.14.0.tar.gz -C /usr/local/src/</span><br></pre></td></tr></table></figure>
<h3 id="添加nginx用户"><a href="#添加nginx用户" class="headerlink" title="添加nginx用户"></a>添加nginx用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># useradd -r -s /sbin/nologin -m -d   /var/lib/nginx nginx       # 添加用户nginx</span><br></pre></td></tr></table></figure>
<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><p>编译安装以下选项是按照 yum 安装 nginx 进行配置的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-file-aio  --with-http_auth_request_module --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_geoip_module=dynamic --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-http_perl_module=dynamic --with-mail=dynamic  --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module  --with-debug --with-cc-opt=&apos;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic&apos;  --add-module=../ngx_cache_purge-2.3</span><br></pre></td></tr></table></figure>
<h3 id="编译参数说明"><a href="#编译参数说明" class="headerlink" title="编译参数说明"></a>编译参数说明</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">--error-log-path=/var/log/nginx/error.log \</span><br><span class="line">--http-log-path=/var/log/nginx/access.log \</span><br><span class="line">--pid-path=/var/run/nginx.pid \</span><br><span class="line">--lock-path=/var/run/nginx.lock \</span><br><span class="line">--http-proxy-temp-path=/var/lib/nginx/tmp/proxy \</span><br><span class="line">--http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi \</span><br><span class="line">--pid-path=/run/nginx.pid \</span><br><span class="line">--with-http_mp4_module \</span><br><span class="line">--with-http_gunzip_module \</span><br><span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span><br><span class="line"> --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</span><br><span class="line"> --with-stream_ssl_module \</span><br><span class="line">--user=nginx \</span><br><span class="line">--group=nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_dav_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-threads \</span><br><span class="line">--with-file-aio \</span><br><span class="line">--add-module=../ngx_cache_purge-2.3 \</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/nginx \ # 安装目录</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf \ # 指定配置文件路径</span><br><span class="line">--error-log-path=/var/log/nginx/error.log \ # 错误日志</span><br><span class="line">--http-log-path=/var/log/nginx/access.log \ # 访问日志</span><br><span class="line">--pid-path=/var/run/nginx.pid \ # pid路径</span><br><span class="line">--lock-path=/var/run/nginx.lock \   #  锁文件安装位置</span><br><span class="line">--http-proxy-temp-path=/var/lib/nginx/tmp/proxy \   作为代理服务器，服务器响应报文的临时文件存放路径</span><br><span class="line">--http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi \ 作为fastcgi代理服务器，服务器响应报文的临时文件存放路径</span><br><span class="line">--with-http_mp4_module \    # 启用MP4视频</span><br><span class="line">--with-http_gunzip_module \ # 启用压缩</span><br><span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp \ # 作为scgi反代服务器，服务器响应报文的临时文件存放路径</span><br><span class="line"> --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \# 作为uwsgi代理服务器，服务器响应报文的临时文件存放路径</span><br><span class="line">--with-stream_ssl_module \ # 启用stream模块的ssl</span><br><span class="line">--user=nginx \  # 指明以那个身份运行worker进程，主控master进程一般由root运行</span><br><span class="line">--group=nginx \ # 组</span><br><span class="line">--with-http_ssl_module \ # 启用ssl</span><br><span class="line">--with-http_v2_module \ # 支持http2.0</span><br><span class="line">--with-http_dav_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-threads \</span><br><span class="line">--with-file-aio \   # 异步非阻塞</span><br><span class="line">--add-module=../ngx_cache_purge-2.3 \   # 添加模块ngx_cache_purge</span><br></pre></td></tr></table></figure>
<h3 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># cd /usr/local/nginx/sbin/</span><br><span class="line"># ls</span><br><span class="line">nginx</span><br><span class="line"># ./nginx        # 启动nginx，提示找不到目录</span><br><span class="line">nginx: [emerg] mkdir() &quot;/var/lib/nginx/tmp/proxy&quot; failed (2: No such file or directory)</span><br><span class="line"># mkdir -p /var/lib/nginx/tmp/proxy  # 创建目录</span><br><span class="line"># ./nginx        # 再次启动，还是提示缺少目录</span><br><span class="line">nginx: [emerg] mkdir() &quot;/var/cache/nginx/uwsgi_temp&quot; failed (2: No such file or directory)</span><br><span class="line"># mkdir -p /var/cache/nginx/uwsgi_temp   # 创建目录</span><br><span class="line"># ./nginx</span><br><span class="line"># ss -tnul       # 80端口已经开启</span><br><span class="line">Netid State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">udp   UNCONN     0      0              ::1:323                         :::*                  </span><br><span class="line">udp   UNCONN     0      0               :::34463                       :::*                  </span><br><span class="line">tcp   LISTEN     0      128              *:80                           *:*                  </span><br><span class="line">tcp   LISTEN     0      128              *:22                           *:*                  </span><br><span class="line"></span><br><span class="line">[root@centos7 sbin]# curl -I localhost</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: HaiYunNginx/6.6.6           # 已经修改为我们想要的版本了，呵呵~~~</span><br><span class="line">Date: Sat, 28 Oct 2017 12:07:24 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Sat, 28 Oct 2017 12:01:53 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;59f471b1-264&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>
<h3 id="查看已经编译模块"><a href="#查看已经编译模块" class="headerlink" title="查看已经编译模块"></a>查看已经编译模块</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#  nginx -V</span><br><span class="line">nginx version: zeforce/2.12.0</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-28) (GCC) </span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-</span><br><span class="line">path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-file-aio --with-http_auth_request_module --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_addition_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_geoip_module=dynamic --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-http_perl_module=dynamic --with-mail=dynamic --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-debug --with-cc-opt=&apos;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic&apos; --add-module=../ngx_cache_purge-2.3</span><br></pre></td></tr></table></figure>
<h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://blog.csdn.net/huaxiongbiao/article/details/71514456" target="_blank" rel="noopener">CSDN：Nginx安装以及可能出现错误</a></p>
<p><a href="http://blog.51cto.com/yw666/1907624" target="_blank" rel="noopener">51CTO博客：Nginx构建反向代理缓存服务器</a></p>
<h3 id="Nginx-配置文件"><a href="#Nginx-配置文件" class="headerlink" title="Nginx 配置文件"></a>Nginx 配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"># For more information on configuration, see:</span><br><span class="line">#   * Official English Documentation: http://nginx.org/en/docs/</span><br><span class="line">#   * Official Russian Documentation: http://nginx.org/ru/docs/</span><br><span class="line"></span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line"># Load dynamic modules. See /usr/share/nginx/README.dynamic.</span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    worker_connections 4096;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # Load modular configuration files from the /etc/nginx/conf.d directory.</span><br><span class="line">    # See http://nginx.org/en/docs/ngx_core_module.html#include</span><br><span class="line">    # for more information.</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">    # Compression Settings</span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_comp_level 6;</span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line">    gzip_proxied any;</span><br><span class="line">    gzip_min_length 1k;</span><br><span class="line">    gzip_buffers 16 8k;</span><br><span class="line">    gzip_types text/plain text/css text/javascript application/jsonapplication/javascript application/x-javascript application/xml;</span><br><span class="line">    gzip_vary on;</span><br><span class="line">    # end gzip</span><br><span class="line"></span><br><span class="line">    # http_proxy Settings</span><br><span class="line">    client_max_body_size   10m;</span><br><span class="line">    client_body_buffer_size   128k;</span><br><span class="line">    proxy_buffering on;</span><br><span class="line">    proxy_buffer_size 8k; </span><br><span class="line">    proxy_buffers 8 32K;</span><br><span class="line">    proxy_busy_buffers_size 64k;</span><br><span class="line">    proxy_connect_timeout 75s;</span><br><span class="line">    proxy_read_timeout 75s;</span><br><span class="line">    proxy_send_timeout 75s;</span><br><span class="line">    proxy_cache_path /data/nginx/cache keys_zone=nginx_cache:10240m loader_threshold=300 loader_files=200  levels=1:2 inactive=10d max_size=50g;</span><br><span class="line">    proxy_temp_file_write_size 512k;</span><br><span class="line">    proxy_temp_path  /data/nginx/temp;</span><br><span class="line"></span><br><span class="line">    # load balance Settings</span><br><span class="line">    upstream web &#123;</span><br><span class="line">        server 10.6.168.224:80 weight=1 ;</span><br><span class="line">        server 10.6.168.224:80 weight=1 ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # virtual host Settings</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        server_name  www.zeforce.com;</span><br><span class="line">        root         /data/www;</span><br><span class="line">    </span><br><span class="line">        location ~ /purge(/.*) &#123;</span><br><span class="line">               allow              127.0.0.1;</span><br><span class="line">               allow              192.168.0.0/24;</span><br><span class="line">               allow              10.6.168.0/24;</span><br><span class="line">               allow              10.6.167.0/24;</span><br><span class="line">               allow              10.6.169.0/24;</span><br><span class="line">               deny               all;</span><br><span class="line">               proxy_cache_purge    nginx_cache $host$1$is_args$args;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_cache nginx_cache;</span><br><span class="line">            proxy_pass  http://web; </span><br><span class="line">            add_header cache-status $upstream_cache_status;</span><br><span class="line">            proxy_cache_bypass $cookie_nocache $arg_nocache$arg_comment;</span><br><span class="line">            proxy_cache_bypass $http_pragma $http_authorization;</span><br><span class="line">            proxy_cache_methods GET HEAD POST;</span><br><span class="line">            proxy_cache_use_stale error  timeout  invalid_header  updating  http_500  http_502  http_503  http_504  http_403  http_404;</span><br><span class="line">            proxy_cache_revalidate on ;</span><br><span class="line">            proxy_cache_lock on ;</span><br><span class="line">            proxy_cache_lock_age 5s;</span><br><span class="line">            proxy_cache_valid 200 302 10m;</span><br><span class="line">            proxy_cache_valid 301      1h;</span><br><span class="line">            proxy_cache_valid 404      1m;</span><br><span class="line">            proxy_cache_valid any      10m;</span><br><span class="line">            proxy_cache_background_update on ;</span><br><span class="line">            proxy_http_version 1.1;</span><br><span class="line">            proxy_ignore_client_abort on ;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">            add_header cache-status $upstream_cache_status;</span><br><span class="line">            expires 30d;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ~ .*\.(gif|jpg|xml|rtmp|jpeg|png|bmp|swf|mp4|3gp|flv|js|fla|css|htm|html|m3u8|ts|pdf|ico)$ &#123;</span><br><span class="line">            proxy_cache nginx_cache;</span><br><span class="line">            proxy_cache_valid 200 10d;</span><br><span class="line">            proxy_cache_valid 304 1d;</span><br><span class="line">            proxy_cache_valid 301 302 1d;</span><br><span class="line">            proxy_cache_valid any 10d;</span><br><span class="line">            proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">            proxy_pass http://web;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">            add_header cache-status $upstream_cache_status;</span><br><span class="line">            expires 30d;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="清除缓存"><a href="#清除缓存" class="headerlink" title="清除缓存"></a>清除缓存</h3><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p>直接使用<code>rm -rf</code>删除缓存目录内的内容</p>
<h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><p>使用 purge </p>
<p>浏览器访问<a href="http://SERVER/purge/your/may/path来清除缓存" target="_blank" rel="noopener">http://SERVER/purge/your/may/path来清除缓存</a></p>
<ul>
<li>（1）purge是ngx_cache_pure 模块指令</li>
<li>（2）your/may/path 是要清除的缓存文件URL路径</li>
</ul>
<p>例如：</p>
<p>清除 缓存 <a href="http://10.6.168.35/images/banner1.png" target="_blank" rel="noopener">http://10.6.168.35/images/banner1.png</a></p>
<p>清除缓存的URL为：<a href="http://10.6.168.35/purge/images/banner1.png" target="_blank" rel="noopener">http://10.6.168.35/purge/images/banner1.png</a></p>
<p>添加了 purge 路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@datanode1 nginx]# curl http://10.6.168.35/purge/images/banner1.png</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;Successful purge&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;Successful purge&lt;/h1&gt;</span><br><span class="line">&lt;br&gt;Key : 10.6.168.35/images/banner1.png</span><br><span class="line">&lt;br&gt;Path: /data/nginx/cache/8/3b/390e690809560e1ef03ad651658893b8</span><br><span class="line">&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;zeforce/2.12.0&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
</div></div><div class="post-main post-comment"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'keeplearn';
var disqus_identifier = '2018/09/04/Nginx-ngx-cache-purge/';
var disqus_title = 'Nginx编译并添加ngx_cache_purge模块';
var disqus_url = 'https://keeplearn.vip/2018/09/04/Nginx-ngx-cache-purge/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>