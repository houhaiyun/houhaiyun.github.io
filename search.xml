<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>Docker简介</title>
      <link href="/2017/12/23/Docker-Jianjie/"/>
      <url>/2017/12/23/Docker-Jianjie/</url>
      <content type="html"><![CDATA[<center><img src="https://houhaiyun.github.io/img/images/Docker-Jianjie-1.png" title="Docker"></center><a id="more"></a><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><a href="https://www.docker.com/" target="_blank" rel="noopener">官网：https://www.docker.com/</a></p><p>Docker是一个开源的引擎，可以轻松的为任何应用创建一个轻量级的、可移植的、自给自足的容器。开发者在笔记本上编译测试通过的容器可以批量地在生产环境中部署，包括VMs（虚拟机）、<a href="http://www.whatis.com.cn/word_5275.htm" target="_blank" rel="noopener">bare metal</a>、OpenStack 集群和其他的基础应用平台。 </p><h4 id="Docker通常用于如下场景："><a href="#Docker通常用于如下场景：" class="headerlink" title="Docker通常用于如下场景："></a>Docker通常用于如下场景：</h4><ul><li>web应用的自动化打包和发布；</li><li>自动化测试和持续集成、发布；</li><li>在服务型环境中部署和调整数据库或其他的后台应用；</li><li>从头编译或者扩展现有的OpenShift或Cloud Foundry平台来搭建自己的PaaS环境。</li></ul><p><code>Docker</code>使用<code>google</code>公司推出的<code>go</code>语言进行开发实现，基于<code>Linux</code>内核的<code>cgroup</code>，<code>namespace</code>，以及<code>AUFS</code>类的<code>Union</code> <code>FS</code>等技术，对进程进行封装隔离，属于操作系统层面的虚拟化技术。由于隔离的进程独立于宿主和其它的隔离进程，因此也称其为容器。最初实现是基于<code>LXC</code>，从0.7版本以后开始取出<code>LXC</code>，转而使用自行研发的<code>licontainer</code>，从1.1开始，则进一步演进为使用<code>runC</code>和<code>containerd</code>。</p><p><code>Docker</code> 最初是 <code>dotCloud</code> 公司创始人 <code>Solomon</code> <code>Hykes</code> 在法国期间发起的一个公司内部项目，它是基于 <code>dotCloud</code> 公司多年云服务技术的一次革新，并于 2013 年 3 月以 <code>Apache</code> 2.0 授权协议开源，主<br>要项目代码在 <code>GitHub</code>上进行维护。<code>Docker</code> 项目后来还加入了 <code>Linux</code> 基金会，并成立推动 开放容器联盟（<code>OCI</code>） 。</p><p><code>Docker</code> 自开源后受到广泛的关注和讨论，至今其 <code>GitHub</code> 项目已经超过 4 万 6 千个星标和一万多个 <code>fork</code>。甚至由于 <code>Docker</code> 项目的火爆，在 2013 年底，<code>dotCloud</code> 公司决定改名为<code>Docker</code>。<code>Docker</code> 最初是在 <code>Ubuntu</code> 12.04上开发实现的；<code>Red</code> <code>Hat</code> 则从 <code>RHEL</code> 6.5 开始对<code>Docker</code> 进行支持；<code>Google</code> 也在其 <code>PaaS</code> 产品中广泛应用 <code>Docker</code>。</p><h3 id="Docker和传统虚拟化的不同之处"><a href="#Docker和传统虚拟化的不同之处" class="headerlink" title="Docker和传统虚拟化的不同之处"></a>Docker和传统虚拟化的不同之处</h3><p><code>Docker</code> 在容器的基础上，进行了进一步的封装，从文件系统、网络互联到进程隔离等等，极大的简化了容器的创建和维护。使得 <code>Docker</code> 技术比虚拟机技术更为轻便、快捷。</p><p>下面的图片比较了 <code>Docker</code> 和传统虚拟化方式的不同之处。传统虚拟机技术是虚拟出一套硬件后，在其上运行一个完整操作系统，在该系统上再运行所需应用进程；而容器内的应用进程直接运行于宿主的内核，容器内没有自己的内核，而且也没有进行硬件虚拟。因此容器要比传统虚拟机更为轻便。</p><h4 id="传统虚拟化"><a href="#传统虚拟化" class="headerlink" title="传统虚拟化"></a><center>传统虚拟化</center></h4><center><img src="https://houhaiyun.github.io/img/images/Docker-Jianjie-2.jpg" title="传统虚拟化"></center><h4 id="Docker"><a href="#Docker" class="headerlink" title=" Docker"></a><center> Docker</center></h4><center><img src="https://houhaiyun.github.io/img/images/Docker-Jianjie-3.jpg" title="Docker"></center><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><strong>《Docker — 从入门到实践》</strong></p>]]></content>
      
      <categories>
          
          <category> 容器 </category>
          
          <category> Docker简介 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>为什么要用Docker？</title>
      <link href="/2017/12/23/Docker-Why-Use/"/>
      <url>/2017/12/23/Docker-Why-Use/</url>
      <content type="html"><![CDATA[<h3 id="为什么要用Docker？"><a href="#为什么要用Docker？" class="headerlink" title="为什么要用Docker？"></a>为什么要用Docker？</h3><p>作为一种新兴的虚拟化方式，<code>Docker</code> 跟传统的虚拟化方式相比具有众多的优势。</p><a id="more"></a><h4 id="更高效的利用系统资源"><a href="#更高效的利用系统资源" class="headerlink" title="更高效的利用系统资源"></a>更高效的利用系统资源</h4><p>由于容器不需要进行硬件虚拟以及运行完整操作系统等额外开销，<code>Docker</code> 对系统资源的利用率更高。无论是应用执行速度、内存损耗或者文件存储速度，都要比传统虚拟机技术更高效。因此，相比虚拟机技术，一个相同配置的主机，往往可以运行更多数量的应用。</p><h4 id="更快速的启动时间"><a href="#更快速的启动时间" class="headerlink" title="更快速的启动时间"></a>更快速的启动时间</h4><p>传统的虚拟机技术启动应用服务往往需要数分钟，而 <code>Docker</code> 容器应用，由于直接运行于宿主内核，无需启动完整的操作系统，因此可以做到秒级、甚至毫秒级的启动时间。大大节约了开发、测试、部署的时间。</p><h4 id="一致的运行环境"><a href="#一致的运行环境" class="headerlink" title="一致的运行环境"></a>一致的运行环境</h4><p>开发过程中一个常见的问题是环境一致性问题。由于开发环境、测试环境、生产环境不一致，导致有些 <code>bug</code> 并未在开发过程中被发现。而 <code>Docker</code> 的镜像提供了除内核外完整的运行时环境，确保了应用运行环境一致性，从而不会再出现「这段代码在我机器上没问题啊」 这类问题。</p><h4 id="持续交付和部署"><a href="#持续交付和部署" class="headerlink" title="持续交付和部署"></a>持续交付和部署</h4><p>对开发和运维（<code>DevOps</code>） 人员来说，最希望的就是一次创建或配置，可以在任意地方正常运行。</p><p>使用 <code>Docker</code> 可以通过定制应用镜像来实现持续集成、持续交付、部署。开发人员可以通过<code>Dockerfile</code> 来进行镜像构建，并结合 持续集成(<code>Continuous Integration</code>) 系统进行集成测试，而运维人员则可以<br>直接在生产环境中快速部署该镜像，甚至结合 持续部署(<code>ContinuousDelivery</code>/<code>Deployment</code>) 系统进行自动部署。</p><p>而且使用 <code>Dockerfile</code> 使镜像构建透明化，不仅仅开发团队可以理解应用运行环境，也方便运维团队理解应用运行所需条件，帮助更好的生产环境中部署该镜像。</p><h4 id="更轻松的迁移"><a href="#更轻松的迁移" class="headerlink" title="更轻松的迁移"></a>更轻松的迁移</h4><p>由于 <code>Docker</code> 确保了执行环境的一致性，使得应用的迁移更加容易。<code>Docker</code> 可以在很多平台上运行，无论是物理机、虚拟机、公有云、私有云，甚至是笔记本，其运行结果是一致的。因此用户可以很轻易的将在一个平台上运行的应用，迁移到另一个平台上，而不用担心运行环境的变化导致应用无法正常运行的情况。</p><h4 id="更轻松的维护和扩展"><a href="#更轻松的维护和扩展" class="headerlink" title="更轻松的维护和扩展"></a>更轻松的维护和扩展</h4><p><code>Docker</code> 使用的分层存储以及镜像的技术，使得应用重复部分的复用更为容易，也使得应用的维护更新更加简单，基于基础镜像进一步扩展镜像也变得非常简单。此外，<code>Docker</code> 团队同各个开源项目团队一起维护了一大批高质量的官方镜像，既可以直接在生产环境使用，又可以作为基础进一步定制，大大的降低了应用服务的镜像制作成本。</p><h3 id="对比传统虚拟机总结"><a href="#对比传统虚拟机总结" class="headerlink" title="对比传统虚拟机总结"></a>对比传统虚拟机总结</h3><table><thead><tr><th>特性</th><th>容器</th><th>虚拟机</th></tr></thead><tbody><tr><td>启动</td><td>秒级</td><td>分钟级</td></tr><tr><td>硬盘使用</td><td>一般为 MB</td><td>一般为 GB</td></tr><tr><td>性能</td><td>接近原生</td><td>弱于</td></tr><tr><td>系统支持量</td><td>单机支持上千个容器</td><td>一般几十个</td></tr></tbody></table><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><strong>《Docker — 从入门到实践》</strong></p>]]></content>
      
      <categories>
          
          <category> 容器 </category>
          
          <category> 为什么要用Docker？ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Xen、OpenVZ、KVM、Hyper-V、VMWare虚拟化技术介绍</title>
      <link href="/2017/12/23/Docker-Xunnihua/"/>
      <url>/2017/12/23/Docker-Xunnihua/</url>
      <content type="html"><![CDATA[<h3 id="XEN"><a href="#XEN" class="headerlink" title="XEN"></a>XEN</h3><p><a href="http://xen.org/" target="_blank" rel="noopener">官网：http://xen.org/</a></p><p><code>Xen</code> 由剑桥大学开发，它是基于硬件的完全分割，物理上有多少的资源就只能分配多少资源，因此很难超售。可分为<code>Xen-PV</code>（半虚拟化），和<code>Xen-HVM</code>（全虚拟化）。</p><p><code>Xen</code>是不能超售内存和硬盘的，当母服务器只有16<code>G</code>内存以及100<code>G</code>硬盘时，当开 <code>Xen</code>架构（任意一个虚拟化）的1<code>G</code>内存、25<code>G</code>硬盘的子机时，会直接占用服务器1<code>G</code> 内存，以及25<code>G</code>硬盘，所以<code>Xen</code>的性能，相比<code>OpenVZ</code>在超售的情况下要好。</p><a id="more"></a><ul><li><code>Xen-PV</code>：半虚拟化，所以它仅仅适用于<code>linux</code>系列<code>VPS</code>，但它的性能损失比较少，大概相对于母机的4%-8%左右。</li><li><code>Xen-HVM</code>：全虚拟化，可以安装<code>windows</code>或自由挂载<code>ISO</code>文件安装任意系统，由于是全虚拟化，所以性能损失较大，大概相对于母机性能损失8%-20%左右。</li></ul><ul><li><code>Xen</code>适用人群：预算较为充足，且希望<code>VPS</code>有较高性能的客户</li><li><code>Xen</code>注意事项：注意<code>Xen-PV</code>和<code>Xen-HVM</code>的区别。</li><li><code>Xen</code>可用系统：<code>Xen-PV</code>：纯<code>Linux</code>，<code>Xen-HVM</code>：支持<code>Windows</code>、<code>Linux</code>等。</li><li><code>Xen</code>代表商家：<code>Linode.com</code></li></ul><h3 id="OpenVZ"><a href="#OpenVZ" class="headerlink" title="OpenVZ"></a>OpenVZ</h3><p><a href="http://openvz.org/" target="_blank" rel="noopener">官网：http://openvz.org/</a></p><p><code>OpenVZ</code>（简 称<code>OVZ</code>）采用<code>SWsoft</code>的<code>Virutozzo</code>虚拟化服务器软件产品的内核，是基于<code>Linux</code>平台的操作系统级服务器虚拟化架构。这个架构直接调用母服务器（母机）中的内核，模拟生成出子服务器（<code>VPS</code><br>，小机），所以，它经过虚拟化后相对于母服务器，性能损失大概只有的1-3%。<br>当然 <code>OpenVZ</code>可以超售，意思味着一台服务器总共16<code>G</code>内存，他可以开出配置为1<code>G</code> 内存×17台以上的子服务器。因为他的虚拟架构关系属于：客户用多少，就扣除母服务器多少，所以<code>OpenVZ</code>架构的<code>VPS</code>较为便<br>宜。但由于存在超售因素，如果服务商毫无休止的超售会导致服务器的性能急剧下降。</p><p><code>OpenVZ</code>另一个特点是，它是 <strong>直接调用母服务器的内核</strong> ，所以会导致部分软件无法使用，以及部分内核文件是无法修改。</p><ul><li><code>OpenVZ</code>适用人群：新手、低预算客户</li><li><code>OpenVZ</code>注意事项：资源不是自己独有的，安装<code>VPN</code>服务需要注意检测虚拟网卡支持。</li><li><code>OpenVZ</code>可用系统：<code>Linux</code>（不支持<code>Windows</code>）</li><li><code>OpenVZ</code>代表商家：<code>Buyvm.net</code></li></ul><h3 id="KVM"><a href="#KVM" class="headerlink" title="KVM"></a>KVM</h3><p><a href="http://www.linux-kvm.org/" target="_blank" rel="noopener">网站：http://www.linux-kvm.org/</a></p><p><code>KVM</code>是<code>Linux</code>下的全功能虚拟化架构，基于<code>KVM</code>架构的<code>VPS</code>，默认是没有系统的，可自己上传<code>ISO</code>或调用服务商自带的<code>ISO</code>手动安装系统。这个非常适合热爱<code>DIY</code>自己 <code>VPS</code>的客户。</p><p>由于<code>KVM</code>架构全功能虚拟化架构，甚至拥有独立的<code>BIOS</code>控制，所以对母服务器性能影响较大，所以基于<code>KVM</code>的<code>VPS</code>较贵，但<code>KVM VPS</code>相对其它架构的<code>VPS</code>较为自由。</p><ul><li><code>KVM</code>适用人群：折腾帝</li><li><code>KVM</code>注意事项：虚拟化性能比<code>Xen</code>略低</li><li><code>KVM</code>可用系统：<code>Windows</code>、<code>Linux</code>系列</li><li><code>KVM</code>代表商家：<code>Hostgation</code>.<code>com</code></li></ul><h3 id="Hyper-V"><a href="#Hyper-V" class="headerlink" title="Hyper-V"></a>Hyper-V</h3><p><a href="http://www.microsoft.com/zh-cn/server-cloud/" target="_blank" rel="noopener">网站：http://www.microsoft.com/zh-cn/server-cloud/</a></p><p><code>Hyper-V</code>是微软的一款虚拟化产品，大部分国内的<code>VPS</code>服务商使用这个架构，主要是因为其转为<code>Windows</code>定制，管理起来较为方便。目前的<code>Hyper</code>-<code>V</code>也支持<code>Linux</code>，只不过性能损失比较严重。</p><p><code>Hyper-V</code>完美支持<code>Windows</code>系统，包括32位和64位。如果大家选购<code>Hyper-V</code>架构的 <code>VPS</code>，强烈建议使用<code>Windows</code>。</p><p><code>Hyper-V</code>目前不能超售内存，但可超售硬盘，硬盘是根据客户使用情况扣除。一般来说，服务器的硬盘不会100%用完，这点不用担心。</p><ul><li><code>Hyper-V</code>适用人群：<code>Windows</code>系统爱好者</li><li><code>Hyper-V</code>注意事项：<code>Linux</code>操作系统性能较低</li><li><code>Hyper-V</code>可用系统：<code>Windows</code>、<code>Linux</code></li></ul><h3 id="VMWare"><a href="#VMWare" class="headerlink" title="VMWare"></a>VMWare</h3><p><a href="http://www.vmware.com/" target="_blank" rel="noopener">网站：http://www.vmware.com/</a></p><p><code>vSphere</code> 是<code>VMware</code>公司推出一套服务器虚拟化解决方案，目前的最新版本为5.0 。<code>vSphere</code>5 中的核心组件为 <code>VMware</code> <code>ESXi</code> 5.0.0（取代原<code>ESX</code>）, <code>ESXi</code>是一款可以独立安装和运行在祼机上的系统，因&gt;此与他我们以往见过的<code>VMware</code> <code>Workstation</code> 软件不同的是它不再依存于宿主操作系统之上。在<code>ESXi</code>安装好以后，我们可以通过<code>vSphere</code> <code>Client</code> 远程连接控制，在<code>ESXi</code> 服务器上创建多个<code>VM</code>（虚拟机），在为这些虚拟机安装好<code>Linux</code> /<code>Windows</code> <code>Server</code> 系统使之成为能提供各种网络应用服务的虚拟服务器，<code>ESXi</code> 也是从内核级支持硬件虚拟化，运行于其中的虚拟服务器在性能与稳定性上不亚于普通的硬件服<br>务器，而且更易于管理维护</p><p><code>VMware vSphere</code> 是用于虚拟化的软件组件套件。这些组件包括 <code>ESXi</code>、<code>vCenter Server</code> 以及在 <code>vSphere</code> 环境中实现许多不同功能的其他软件组件。</p><h3 id="KVM、XEN、VMWare的对比"><a href="#KVM、XEN、VMWare的对比" class="headerlink" title="KVM、XEN、VMWare的对比"></a>KVM、XEN、VMWare的对比</h3><center><img src="https://houhaiyun.github.io/img/images/Docker-Xunnihua-1.png" title="KVM、XEN、VMWare的对比"></center><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://wiki.dreamrunner.org/public_html/Misc/Software/virtual-technology.html" target="_blank" rel="noopener">虚拟化技术：http://wiki.dreamrunner.org/public_html/Misc/Software/virtual-technology.html</a></p><p><a href="http://openskill.cn/article/69" target="_blank" rel="noopener">XEN 、 VMware ESXi、Hyper-V 以及 KVM 特点比较：http://openskill.cn/article/69</a></p>]]></content>
      
      <categories>
          
          <category> 虚拟化 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 虚拟化技术介绍 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MarraiDB安装-yum方式</title>
      <link href="/2017/11/11/MySQL-MariaDB-Install-Yum/"/>
      <url>/2017/11/11/MySQL-MariaDB-Install-Yum/</url>
      <content type="html"><![CDATA[<h3 id="官方yum仓库获取方式"><a href="#官方yum仓库获取方式" class="headerlink" title="官方yum仓库获取方式"></a>官方yum仓库获取方式</h3><p><a href="https://downloads.mariadb.org/mariadb/repositories/" target="_blank" rel="noopener">项目官方：https://downloads.mariadb.org/mariadb/repositories/</a></p><a id="more"></a><center><img src="https://houhaiyun.github.io/img/images/MySQL-MariaDB-Install-Yum-1.gif" title="官方yum仓库获取方式"></center><h3 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h3><p>如果使用<code>yum</code>安装时，有两个<code>yum</code>源，都有<code>mysql</code>包，那么安装时<code>yum</code>会使用版本较高的安装。也可以配置<code>MariaDB</code>官方<code>yum</code>源进行安装。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# yum install -y mysql mysql-server     &lt;==安装mysql客户端和服务器端</span><br><span class="line">[root@centos6 ~]# service mysqld start</span><br><span class="line">Starting mysqld:                                           [  OK  ]     &lt;==启动mysql</span><br><span class="line"> [root@centos6 ~]# mysql            &lt;==安装完成后默认root是没有密码的，默认连接用户为root，不安全。</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.1.73 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT USER()            &lt;==查看当前登陆用户</span><br><span class="line">    -&gt; ;</span><br><span class="line">+----------------+</span><br><span class="line">| USER()         |</span><br><span class="line">+----------------+</span><br><span class="line">| root@localhost |</span><br><span class="line">+----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="提高安全性"><a href="#提高安全性" class="headerlink" title="提高安全性"></a>提高安全性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# mysql_secure_installation         &lt;==此脚本为安装完成mysql，MySQL提供的</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MySQL</span><br><span class="line">      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">In order to log into MySQL to secure it, we&apos;ll need the current</span><br><span class="line">password for the root user.  If you&apos;ve just installed MySQL, and</span><br><span class="line">you haven&apos;t set the root password yet, the password will be blank,</span><br><span class="line">so you should just press enter here.</span><br><span class="line"></span><br><span class="line">Enter current password for root (enter for none):       &lt;==输入当前root的密码，因为默认root是没有密码的所以直接回车就ok了</span><br><span class="line">OK, successfully used password, moving on...</span><br><span class="line"></span><br><span class="line">Setting the root password ensures that nobody can log into the MySQL</span><br><span class="line">root user without the proper authorisation.</span><br><span class="line"></span><br><span class="line">Set root password? [Y/n] y      &lt;==是否设置root密码</span><br><span class="line">New password:                   &lt;==输入密码</span><br><span class="line">Re-enter new password:          &lt;==再次输入密码</span><br><span class="line">Password updated successfully!</span><br><span class="line">Reloading privilege tables..</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">By default, a MySQL installation has an anonymous user, allowing anyone</span><br><span class="line">to log into MySQL without having to have a user account created for</span><br><span class="line">them.  This is intended only for testing, and to make the installation</span><br><span class="line">go a bit smoother.  You should remove them before moving into a</span><br><span class="line">production environment.</span><br><span class="line"></span><br><span class="line">Remove anonymous users? [Y/n] y     &lt;==是否移除匿名用户</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Normally, root should only be allowed to connect from &apos;localhost&apos;.  This</span><br><span class="line">ensures that someone cannot guess at the root password from the network.</span><br><span class="line"></span><br><span class="line">Disallow root login remotely? [Y/n] n       &lt;==是否禁止root用户远程登陆</span><br><span class="line"> ... skipping.</span><br><span class="line"></span><br><span class="line">By default, MySQL comes with a database named &apos;test&apos; that anyone can</span><br><span class="line">access.  This is also intended only for testing, and should be removed</span><br><span class="line">before moving into a production environment.</span><br><span class="line"></span><br><span class="line">Remove test database and access to it? [Y/n] n      &lt;==是否移除test数据库</span><br><span class="line"> ... skipping.</span><br><span class="line"></span><br><span class="line">Reloading the privilege tables will ensure that all changes made so far</span><br><span class="line">will take effect immediately.</span><br><span class="line"></span><br><span class="line">Reload privilege tables now? [Y/n] y            &lt;==是否加载特权表，就是是否生效</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Cleaning up...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">All done!  If you&apos;ve completed all of the above steps, your MySQL</span><br><span class="line">installation should now be secure.</span><br><span class="line"></span><br><span class="line">Thanks for using MySQL!</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# mysql         &lt;==现在我们已经无法使用匿名用户连接了</span><br><span class="line">ERROR 1045 (28000): Access denied for user &apos;root&apos;@&apos;localhost&apos; (using password: NO)</span><br><span class="line">[root@centos6 ~]# mysql -u root -p      &lt;==必须要指定用户和密码才可以登陆</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 10</span><br><span class="line">Server version: 5.1.73 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT USER();</span><br><span class="line">+----------------+</span><br><span class="line">| USER()         |</span><br><span class="line">+----------------+</span><br><span class="line">| root@localhost |</span><br><span class="line">+----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">[root@centos6 ~]# </span><br><span class="line">[root@centos6 ~]# mysql -uroot -pmagedu         &lt;==也可以使用-p后面直接跟密码</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 12</span><br><span class="line">Server version: 5.1.73 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br></pre></td></tr></table></figure><h3 id="查看msyql-user表"><a href="#查看msyql-user表" class="headerlink" title="查看msyql.user表"></a>查看msyql.user表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT user,host,password FROM mysql.user;</span><br><span class="line">+------+--------------------+-------------------------------------------+</span><br><span class="line">| user | host               | password                                  |</span><br><span class="line">+------+--------------------+-------------------------------------------+</span><br><span class="line">| root | localhost          | *6B8CCC83799A26CD19D7AD9AEEADBCD30D8A8664 |</span><br><span class="line">| root | centos6.haiyun.com | *6B8CCC83799A26CD19D7AD9AEEADBCD30D8A8664 |</span><br><span class="line">| root | 127.0.0.1          | *6B8CCC83799A26CD19D7AD9AEEADBCD30D8A8664 |</span><br><span class="line">+------+--------------------+-------------------------------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="mysql-配置"><a href="#mysql-配置" class="headerlink" title="mysql 配置"></a>mysql 配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">侦听3306/tcp端口可以在绑定有一个或全部接口IP上</span><br><span class="line">- Vim /etc/my.cnf</span><br><span class="line">    - [mysqld]加一行：</span><br><span class="line">    - skip-networking=1 跳过域名解析，和sshd服务的useDNS相似</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 数据库 </category>
          
          <category> MarraiDB安装-yum方式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MarraiDB安装-通用二进制方式</title>
      <link href="/2017/11/11/MySQL-MariaDB-Install-Binary/"/>
      <url>/2017/11/11/MySQL-MariaDB-Install-Binary/</url>
      <content type="html"><![CDATA[<h3 id="安装方式"><a href="#安装方式" class="headerlink" title="安装方式"></a>安装方式</h3><p><code>MariaDB</code>的安装方法大致有以下四种，本例是关于通用二进制（俗称绿色包）格式的压缩文件进行安装。</p><ul><li>系统自带<code>RPM</code>包安装</li><li><code>MariaDB</code>官方自带的<code>rpm</code>包</li><li>通用二进制格式</li><li>源码编译</li></ul><a id="more"></a><h3 id="mariadb下载"><a href="#mariadb下载" class="headerlink" title="mariadb下载"></a>mariadb下载</h3><p><a href="http://mariadb.org/" target="_blank" rel="noopener">官网：http://mariadb.org/</a></p><p>目前最新版本为：10.3.1，稳定版本为：10.2.8</p><p>本次实验使用的版本为：稳定版10.2.8</p><h3 id="0-环境准备"><a href="#0-环境准备" class="headerlink" title="0. 环境准备"></a>0. 环境准备</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 mysql]# rpm -qa libaio        &lt;==判断系统安装这两个lib包，如果不按爪给你这两个lib包在初始化是会报错的</span><br><span class="line">libaio-0.3.109-13.el7.x86_64</span><br><span class="line">libaio-0.3.109-13.el7.i686</span><br><span class="line">[root@centos7 dbdata]# yum install -y libaio.so.1</span><br><span class="line">[root@centos7 mysql]# yum install -y libaio.x86_64 libaio-devel.x86_64</span><br></pre></td></tr></table></figure><h3 id="1-准备用户"><a href="#1-准备用户" class="headerlink" title="1. 准备用户"></a>1. 准备用户</h3><p>mariadb和mysql运行使用的用户都是mysql，所以需要创建mysql用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# getent passwd mysql       &lt;==mysql用户不存在</span><br><span class="line">[root@centos7 ~]# useradd -r -m -d /app/dbdata -s /sbin/nologin mysql       &lt;==创建mysql用户，指定家目录为/app/dbdata，且为系统用户，默认shell为/sbin/nologin无法登陆</span><br><span class="line">[root@centos7 ~]# getent passwd mysql           &lt;==确认用户mysql信息    </span><br><span class="line">mysql: x:997:995::/app/dbdata:/sbin/nologin</span><br><span class="line">[root@centos7 ~]# ll /app/dbdata/ -d            &lt;==查看mysql家目录</span><br><span class="line">drwx------. 2 mysql mysql 62 Sep 25 09:43 /app/dbdata/</span><br></pre></td></tr></table></figure></p><h3 id="2-准备二进制程序"><a href="#2-准备二进制程序" class="headerlink" title="2. 准备二进制程序"></a>2. 准备二进制程序</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# tar xf mariadb-10.2.8-linux-x86_64.tar.gz -C /usr/local/         &lt;==解压mariadb到/usr/local目录下</span><br><span class="line">[root@centos7 app]# cd /usr/local/      &lt;==切换到/usr/local目录</span><br><span class="line">[root@centos7 local]# ls</span><br><span class="line">bin  games    lib    libexec                      sbin   src</span><br><span class="line">etc  include  lib64  mariadb-10.2.8-linux-x86_64  share</span><br><span class="line">[root@centos7 local]# ln -sv mariadb-10.2.8-linux-x86_64/ mysql     &lt;==创建软链接，名字必须交mysql</span><br><span class="line">‘mysql’ -&gt; ‘mariadb-10.2.8-linux-x86_64/’</span><br><span class="line">[root@centos7 local]# ls        &lt;==确认软链接已经别创建</span><br><span class="line">bin  games    lib    libexec                      mysql  share</span><br><span class="line">etc  include  lib64  mariadb-10.2.8-linux-x86_64  sbin   src</span><br></pre></td></tr></table></figure><h3 id="3-准备配置文件"><a href="#3-准备配置文件" class="headerlink" title="3. 准备配置文件"></a>3. 准备配置文件</h3><ul><li>配置格式：类<code>ini</code>格式，各程序由单个配置文件提供配<code>[prog_name]</code></li><li>配置文件查找次序：后面覆盖前面的配置文件</li><li><code>/etc/my.cnf</code> –&gt; <code>/etc/mysql/my.cnf</code> –&gt; <code>--default-extrafile=/PATH/TO/CONF_FILE</code> –&gt; <code>~/.my.cnf</code></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 local]# mkdir /etc/mysql      &lt;==创建mysql目录</span><br><span class="line">[root@centos7 mysql]# cp /usr/local/mariadb-10.2.8-linux-x86_64/support-files/my-huge.cnf /etc/mysql/my.cnf           &lt;==cpmysql配置文件</span><br><span class="line">[root@centos7 mysql]# vim /etc/mysql/my.cnf     &lt;==编辑配置文件，添加一下三行，在[mysqld]后面</span><br><span class="line">[mysqld]            </span><br><span class="line">datadir = /app/dbdata       &lt;==指定数据库文件路径，必须指定为/app/dbdata</span><br><span class="line">innodb_file_per_table = on  &lt;==使用innodb引擎，每个表都是一个独立的文件</span><br><span class="line">skip_name_resolve = on      &lt;==禁止主机名解析</span><br></pre></td></tr></table></figure><h3 id="4-创建数据库文件"><a href="#4-创建数据库文件" class="headerlink" title="4. 创建数据库文件"></a>4. 创建数据库文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# ls /app/dbdata/           &lt;==没有文件</span><br><span class="line">[root@centos7 mysql]# ./scripts/mysql_install_db --help     &lt;==查看此脚本的帮助信息，此脚本是用于创建数据库文件的脚本，创建数据库文件相当于初始化</span><br><span class="line">Usage: ./scripts/mysql_install_db [OPTIONS]</span><br><span class="line">  --auth-root-authentication-method=normal|socket</span><br><span class="line">                       Chooses the authentication method for the created initial</span><br><span class="line">                       root user. The default is &apos;normal&apos; to creates a root user</span><br><span class="line">                       that can login without password, which can be insecure.</span><br><span class="line">                       The alternative &apos;socket&apos; allows only the system root user</span><br><span class="line">                       to login as MariaDB root; this requires the unix socket</span><br><span class="line">                       authentication plugin.</span><br><span class="line">  --auth-root-socket-user=user</span><br><span class="line">                       Used with --auth-root-authentication-method=socket. It</span><br><span class="line">                       specifies the name of the MariaDB root account, as well</span><br><span class="line">                       as of the system account allowed to access it. Defaults</span><br><span class="line">                       to &apos;root&apos;.</span><br><span class="line">  --basedir=path       The path to the MariaDB installation directory.</span><br><span class="line">  --builddir=path      If using --srcdir with out-of-directory builds, you</span><br><span class="line">                       will need to set this to the location of the build</span><br><span class="line">                       directory where built files reside.</span><br><span class="line">  --cross-bootstrap    For internal use.  Used when building the MariaDB system</span><br><span class="line">                       tables on a different host than the target.</span><br><span class="line">  --datadir=path       The path to the MariaDB data directory.</span><br><span class="line">  --defaults-extra-file=name</span><br><span class="line">                       Read this file after the global files are read.</span><br><span class="line">  --defaults-file=name Only read default options from the given file name.</span><br><span class="line">  --force              Causes mysql_install_db to run even if DNS does not</span><br><span class="line">                       work.  In that case, grant table entries that</span><br><span class="line">                       normally use hostnames will use IP addresses.</span><br><span class="line">  --help               Display this help and exit.                     </span><br><span class="line">  --ldata=path         The path to the MariaDB data directory. Same as</span><br><span class="line">                       --datadir.</span><br><span class="line">  --no-defaults        Don&apos;t read default options from any option file.</span><br><span class="line">  --defaults-file=path Read only this configuration file.</span><br><span class="line">  --rpm                For internal use.  This option is used by RPM files</span><br><span class="line">                       during the MariaDB installation process.</span><br><span class="line">  --skip-auth-anonymous-user</span><br><span class="line">                       Do not install an unprivileged anonymous user.</span><br><span class="line">  --skip-name-resolve  Use IP addresses rather than hostnames when creating</span><br><span class="line">                       grant table entries.  This option can be useful if</span><br><span class="line">                       your DNS does not work.</span><br><span class="line">  --srcdir=path        The path to the MariaDB source directory.  This option</span><br><span class="line">                       uses the compiled binaries and support files within the</span><br><span class="line">                       source tree, useful for if you don&apos;t want to install</span><br><span class="line">                       MariaDB yet and just want to create the system tables.</span><br><span class="line">  --user=user_name     The login username to use for running mysqld.  Files</span><br><span class="line">                       and directories created by mysqld will be owned by this</span><br><span class="line">                       user.  You must be root to use this option.  By default</span><br><span class="line">                       mysqld runs using your current login name and files and</span><br><span class="line">                       directories that it creates will be owned by you.</span><br><span class="line"></span><br><span class="line">All other options are passed to the mysqld program</span><br><span class="line"></span><br><span class="line">[root@centos7 mysql]# ./scripts/mysql_install_db --datadir=/app/dbdata --user=mysql        &lt;==指定mysql数据存储目录为/app/dbdata，用户为mysql</span><br><span class="line">Installing MariaDB/MySQL system tables in &apos;/app/dbdata&apos; ...</span><br><span class="line">2017-09-25 11:02:27 140386981918528 [Warning] &apos;THREAD_CONCURRENCY&apos; is deprecated and will be removed in a future release.</span><br><span class="line">2017-09-25 11:02:30 140386857879296 [Warning] Failed to load slave replication state from table mysql.gtid_slave_pos: 1146: Table &apos;mysql.gtid_slave_pos&apos; doesn&apos;t exist</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">To start mysqld at boot time you have to copy</span><br><span class="line">support-files/mysql.server to the right place for your system</span><br><span class="line"></span><br><span class="line">PLEASE REMEMBER TO SET A PASSWORD FOR THE MariaDB root USER !</span><br><span class="line">To do so, start the server, then issue the following commands:</span><br><span class="line"></span><br><span class="line">&apos;./bin/mysqladmin&apos; -u root password &apos;new-password&apos;</span><br><span class="line">&apos;./bin/mysqladmin&apos; -u root -h centos7.haiyun.com password &apos;new-password&apos;</span><br><span class="line"></span><br><span class="line">Alternatively you can run:</span><br><span class="line">&apos;./bin/mysql_secure_installation&apos;</span><br><span class="line"></span><br><span class="line">which will also give you the option of removing the test</span><br><span class="line">databases and anonymous user created by default.  This is</span><br><span class="line">strongly recommended for production servers.</span><br><span class="line"></span><br><span class="line">See the MariaDB Knowledgebase at http://mariadb.com/kb or the</span><br><span class="line">MySQL manual for more instructions.</span><br><span class="line"></span><br><span class="line">You can start the MariaDB daemon with:</span><br><span class="line">cd &apos;.&apos; ; ./bin/mysqld_safe --datadir=&apos;/app/dbdata&apos;</span><br><span class="line"></span><br><span class="line">You can test the MariaDB daemon with mysql-test-run.pl</span><br><span class="line">cd &apos;./mysql-test&apos; ; perl mysql-test-run.pl</span><br><span class="line"></span><br><span class="line">Please report any problems at http://mariadb.org/jira</span><br><span class="line"></span><br><span class="line">The latest information about MariaDB is available at http://mariadb.org/.</span><br><span class="line">You can find additional information about the MySQL part at:</span><br><span class="line">http://dev.mysql.com</span><br><span class="line">Consider joining MariaDB&apos;s strong and vibrant community:</span><br><span class="line">https://mariadb.org/get-involved/</span><br><span class="line"></span><br><span class="line">at http://mariadb.org/jira</span><br><span class="line">[root@centos7 mysql]# ls /app/dbdata/       &lt;==可以看到文件已经生成</span><br><span class="line">aria_log.00000001  ibdata1      mysql             mysql-bin.state</span><br><span class="line">aria_log_control   ib_logfile0  mysql-bin.000001  performance_schema</span><br><span class="line">ib_buffer_pool     ib_logfile1  mysql-bin.index   test</span><br></pre></td></tr></table></figure><h3 id="5-准备服务脚本"><a href="#5-准备服务脚本" class="headerlink" title="5. 准备服务脚本"></a>5. 准备服务脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 mysql]# pwd</span><br><span class="line">/usr/local/mysql</span><br><span class="line">[root@centos7 mysql]# cp support-files/mysql.server /etc/init.d/mysqld </span><br><span class="line">[root@centos7 mysql]# chkconfig --list</span><br><span class="line"></span><br><span class="line">Note: This output shows SysV services only and does not include native</span><br><span class="line">      systemd services. SysV configuration data might be overridden by native</span><br><span class="line">      systemd configuration.</span><br><span class="line"></span><br><span class="line">      If you want to list systemd services use &apos;systemctl list-unit-files&apos;.</span><br><span class="line">      To see services enabled on particular target use</span><br><span class="line">      &apos;systemctl list-dependencies [target]&apos;.</span><br><span class="line"></span><br><span class="line">netconsole     0:off1:off2:off3:off4:off5:off6:off</span><br><span class="line">network        0:off1:off2:on3:on4:on5:on6:off</span><br><span class="line">[root@centos7 mysql]# chkconfig --add mysqld</span><br><span class="line">[root@centos7 mysql]# chkconfig --list</span><br><span class="line"></span><br><span class="line">Note: This output shows SysV services only and does not include native</span><br><span class="line">      systemd services. SysV configuration data might be overridden by native</span><br><span class="line">      systemd configuration.</span><br><span class="line"></span><br><span class="line">      If you want to list systemd services use &apos;systemctl list-unit-files&apos;.</span><br><span class="line">      To see services enabled on particular target use</span><br><span class="line">      &apos;systemctl list-dependencies [target]&apos;.</span><br><span class="line"></span><br><span class="line">mysqld         0:off1:off2:on3:on4:on5:on6:off</span><br><span class="line">netconsole     0:off1:off2:off3:off4:off5:off6:off</span><br><span class="line">network        0:off1:off2:on3:on4:on5:on6:off</span><br><span class="line">[root@centos7 mysql]# chkconfig mysqld on</span><br></pre></td></tr></table></figure><h3 id="6-准备日志文件"><a href="#6-准备日志文件" class="headerlink" title="6. 准备日志文件"></a>6. 准备日志文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 mysql]# service mysqld start</span><br><span class="line">Starting mysqld (via systemctl):                           [  OK  ]</span><br><span class="line">[root@centos7 mysql]# setfacl -m u:mysql:rwx /var/log/</span><br><span class="line">[root@centos7 mysql]# service mysqld start</span><br><span class="line">Starting mysqld (via systemctl):  Job for mysqld.service failed because the control process exited with error code. See &quot;systemctl status mysqld.service&quot; and &quot;journalctl -xe&quot; for details.</span><br><span class="line">                                                           [FAILED]</span><br><span class="line">[root@centos7 mysql]# mkdir /var/log/mariadb        &lt;==创建日志目录</span><br><span class="line">[root@centos7 mysql]# touch /var/log/mariadb/mariadb.log    &lt;==穿件日志文件</span><br><span class="line">[root@centos7 mysql]# setfacl -R -m u:mysql:rwx /var/log/mariadb        &lt;==设置acl使mysql用户对/var/log/mariadb目录有权限</span><br></pre></td></tr></table></figure><h3 id="7-设置环境变量"><a href="#7-设置环境变量" class="headerlink" title="7. 设置环境变量"></a>7. 设置环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 mysql]# vim /etc/profile.d/mysql.sh</span><br><span class="line">export PATH=/usr/local/mysql/bin/:$PATH</span><br><span class="line">[root@centos7 mysql]# source /etc/profile.d/mysql.sh    &lt;==同步环境变量到本地</span><br><span class="line">[root@centos7 mysql]# echo $PATH</span><br><span class="line">/usr/local/mysql/bin/:/usr/local/mysql/bin/:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br></pre></td></tr></table></figure><h3 id="8-连接数据库测试"><a href="#8-连接数据库测试" class="headerlink" title="8. 连接数据库测试"></a>8. 连接数据库测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 mysql]# mysql</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 12</span><br><span class="line">Server version: 10.2.8-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SELECT USER();</span><br><span class="line">+----------------+</span><br><span class="line">| USER()         |</span><br><span class="line">+----------------+</span><br><span class="line">| root@localhost |</span><br><span class="line">+----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="9-安全初始化"><a href="#9-安全初始化" class="headerlink" title="9. 安全初始化"></a>9. 安全初始化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 mysql]# mysql_secure_installation         &lt;==如果没有此安全初始化脚本，可能是环境变量的问题</span><br><span class="line"></span><br><span class="line">NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB</span><br><span class="line">      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!</span><br><span class="line"></span><br><span class="line">In order to log into MariaDB to secure it, we&apos;ll need the current</span><br><span class="line">password for the root user.  If you&apos;ve just installed MariaDB, and</span><br><span class="line">you haven&apos;t set the root password yet, the password will be blank,</span><br><span class="line">so you should just press enter here.</span><br><span class="line"></span><br><span class="line">Enter current password for root (enter for none): </span><br><span class="line">OK, successfully used password, moving on...</span><br><span class="line"></span><br><span class="line">Setting the root password ensures that nobody can log into the MariaDB</span><br><span class="line">root user without the proper authorisation.</span><br><span class="line"></span><br><span class="line">Set root password? [Y/n] y</span><br><span class="line">New password: </span><br><span class="line">Re-enter new password: </span><br><span class="line">Password updated successfully!</span><br><span class="line">Reloading privilege tables..</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">By default, a MariaDB installation has an anonymous user, allowing anyone</span><br><span class="line">to log into MariaDB without having to have a user account created for</span><br><span class="line">them.  This is intended only for testing, and to make the installation</span><br><span class="line">go a bit smoother.  You should remove them before moving into a</span><br><span class="line">production environment.</span><br><span class="line"></span><br><span class="line">Remove anonymous users? [Y/n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Normally, root should only be allowed to connect from &apos;localhost&apos;.  This</span><br><span class="line">ensures that someone cannot guess at the root password from the network.</span><br><span class="line"></span><br><span class="line">Disallow root login remotely? [Y/n] n</span><br><span class="line"> ... skipping.</span><br><span class="line"></span><br><span class="line">By default, MariaDB comes with a database named &apos;test&apos; that anyone can</span><br><span class="line">access.  This is also intended only for testing, and should be removed</span><br><span class="line">before moving into a production environment.</span><br><span class="line"></span><br><span class="line">Remove test database and access to it? [Y/n] n</span><br><span class="line"> ... skipping.</span><br><span class="line"></span><br><span class="line">Reloading the privilege tables will ensure that all changes made so far</span><br><span class="line">will take effect immediately.</span><br><span class="line"></span><br><span class="line">Reload privilege tables now? [Y/n] y</span><br><span class="line"> ... Success!</span><br><span class="line"></span><br><span class="line">Cleaning up...</span><br><span class="line"></span><br><span class="line">All done!  If you&apos;ve completed all of the above steps, your MariaDB</span><br><span class="line">installation should now be secure.</span><br><span class="line"></span><br><span class="line">Thanks for using MariaDB!</span><br></pre></td></tr></table></figure><h3 id="10-优化后连接"><a href="#10-优化后连接" class="headerlink" title="10. 优化后连接"></a>10. 优化后连接</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 mysql]# mysql         &lt;==优化后就无法连接了</span><br><span class="line">ERROR 1045 (28000): Access denied for user &apos;root&apos;@&apos;localhost&apos; (using password: NO)</span><br><span class="line">[root@centos7 mysql]# mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 19</span><br><span class="line">Server version: 10.2.8-MariaDB-log MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 数据库 </category>
          
          <category> MarraiDB安装-通用二进制方式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MySQL</title>
      <link href="/2017/11/11/MySQL/"/>
      <url>/2017/11/11/MySQL/</url>
      <content type="html"><![CDATA[<h3 id="什么是MySQL？"><a href="#什么是MySQL？" class="headerlink" title="什么是MySQL？"></a>什么是MySQL？</h3><p><code>MySQL</code>是一个关系型数据库管理系统，由瑞典 <code>MySQL AB</code> 公司开发，目前属于 <code>Oracle</code> 旗下公司。<code>MySQL</code> 最流行的关系型数据库管理系统，在 <code>WEB</code> 应用方面 <code>MySQL</code> 是最好的 RDBMS应用软件之一。<code>MySQL</code> 是一种关联数据库管理系统，关联数据库将数据保存在不同的表中，而不是将所有数据放在一个大仓库内，这样就增加了速度并提高了灵活性。<code>MySQL</code> 所使用的 <code>SQL</code> 语言是用于访问数据库的最常用标准化语言。<code>MySQL</code> 软件采用了双授权政策（本词条“授权政策”），它分为社区版和商业版，由于其体积小、速度快、总体拥有成本低，尤其是开放源码这一特点，一般中小型网站的开发都选择 MySQL 作为网站数据库。由于其社区版的性能卓越，搭配 <code>PHP</code> 和 <code>Apache</code> 可组成良好的开发环境。</p><a id="more"></a><h3 id="MySQL数据库实现模型"><a href="#MySQL数据库实现模型" class="headerlink" title="MySQL数据库实现模型"></a>MySQL数据库实现模型</h3><center><img src="https://houhaiyun.github.io/img/images/MySQL-1.jpg" title="MySQL架构"></center><p><strong>通过上图可以把数据库操作分为以下四个阶段：</strong></p><ol><li>用户通过本地或网络使用C、PHP等多种开发语言开发的接口连接MySQL数据库服务器。</li><li>用户接入服务器后进入连接池，在连接池中实现用户认证、线程重用、并发连接数限制、内存检测、连接缓存等操作，而后数据处理结果进入下一层面，接受用户输入的指令，结合SQL接口，分析器，优化器，缓存缓存管理器，将指令处理后发送给数据库引擎完成数据库管理、维护、集群、配置等操作。</li><li>数据库引擎接收到其能支持的数据处理命令后，对数据执行响应的查询、修改等操作，数据库引擎是直接数据处理层面。</li><li>物理存储层面，数据的最终存储位置，根据数据库引擎的处理以索引顺序或者堆文件存储模式存储底层数据。</li></ol><p><strong>上图中的部分组件介绍：</strong></p><ol><li><code>Connectors</code>：是连接<code>mysql</code>的各种客户端和接口。</li><li><code>Connection Pool</code>：用于创建用户连接，缓存连接线程，做连接池。还有鉴权、进行身份验证、线程重用、连接限制、检查内存、数据缓存、管理用户的连接，线程处理等需要缓存的需求。</li><li><code>Management Serveices &amp; Utilities</code>：系统管理和控制工具备份和恢复的安全性，复制、集群、管理、配置和迁移元数据。</li><li><code>SQL Interface</code>：<code>SQL</code>接口，接受用户的SQL命令，并且返回用户需要查询的结果。比如<code>select from</code>就是调用<code>SQL Interface</code>。进行<code>DML</code>、<code>DDL</code>、存储过程、视图、触发器等操作和管理；用户通过<code>SQL</code>命令查询所需结果。</li><li><code>Parser</code>：解释器，<code>SQL</code>命令传递到解析器的时候会被解析器验证和解析。解析器是由<code>Lex</code>和<code>YACC</code>实现的，是一个很长的脚本。主要功能：<ol><li>将<code>SQL</code>语句分解成数据结构，并将这个结构传递到后续步骤，以后SQL语句的传递和处理就是基于这个结构的</li><li>如果在分解构成中遇到错误，那么就说明这个sql语句是不合理的</li></ol></li><li><code>Optimizer</code>：查询优化器 <code>SQL</code>语句在查询之前会使用查询优化器对查询进行优化。它使用的是“选取-投影-联接”策略进行查询。<ul><li>用一个例子就可以理解： <code>select uid,name from user where gender = 1</code>;这个<code>select</code> 查询先根据<code>where</code> 语句进行选取，而不是先将表全部查询出来以后再进行gender过滤，这个select查询先根据uid和name进行属性投影，而不是将属性全部取出以后再进行过滤将这两个查询条件联接起来生成最终查询结果</li></ul></li><li><code>Cache</code>和<code>Buffer</code>：查询缓存，如果查询缓存有命中的查询结果，查询语法就可以直接去查村缓存中读取数据。这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，<code>key</code>缓存，权限缓存等。</li><li><code>Engine</code>：存储引擎：存储引擎是<code>Mysql</code>中具体的与文件打交道的子系统。也就是Mysql最具有特色的一个地方。<code>Mysql</code>的存储引擎是插件式的它根据<code>Mysql AB</code>公司提供的文件访问层的一个抽象接口来定制一种文件访问机制（这种访问机制就叫存储引擎）现在有很多种存储引擎，各个引擎的优势各不一样，最常用的<code>MyISAM</code>,<code>InnoDB</code>,<code>NDB</code>,<code>Archive</code>,<code>Federated</code>,<code>Memory</code>,<code>Merge</code>,<code>Partner</code>,<code>Community</code>,<code>Custom</code>等等。</li></ol><h3 id="系统特性"><a href="#系统特性" class="headerlink" title="系统特性"></a>系统特性</h3><ul><li>使用 <code>C</code>和 <code>C++</code>编写，并使用了多种编译器进行测试，保证了源代码的可移植性。 </li><li>支持 <code>AIX</code>、<code>FreeBSD</code>、<code>HP-UX</code>、<code>Linux</code>、<code>Mac OS</code>、<code>NovellNetware</code>、<code>OpenBSD</code>、<code>OS/2 Wrap</code>、<code>Solaris</code>、<code>Windows</code>等多种操作系统。 </li><li>为多种编程语言提供了 <code>API</code>。这些编程语言包括 <code>C</code>、<code>C++</code>、<code>Python</code>、<code>Java</code>、<code>Perl</code>、<code>PHP</code>、<code>Eiffel</code>、<code>Ruby</code>、<code>.NET</code>和 <code>Tcl</code> 等。 </li><li>支持多线程，充分利用 <code>CPU</code> 资源。 </li><li>优化的 <code>SQL</code>查询算法，有效地提高查询速度。 </li><li>既能够作为一个单独的应用程序应用在客户端服务器网络环境中，也能够作为一个库而嵌入到其他的软件中。 </li><li>提供多语言支持，常见的编码如中文的 <code>GB 2312</code>、<code>BIG5</code>，日文的 <code>Shift_JIS</code>等都可以用作数据表名和数据列名。 </li><li>提供 <code>TCP/IP</code>、<code>ODBC</code> 和 <code>JDBC</code>等多种数据库连接途径。 </li><li>提供用于管理、检查、优化数据库操作的管理工具。 </li><li>支持大型的数据库。可以处理拥有上千万条记录的大型数据库。 </li><li>支持多种存储引擎。 </li><li><code>MySQL</code> 是开源的，所以你不需要支付额外的费用。 </li><li><code>MySQL</code> 使用标准的 <code>SQL</code>数据语言形式。 </li><li><code>MySQL</code> 对 <code>PHP</code> 有很好的支持，<code>PHP</code>是目前最流行的 <code>Web</code> 开发语言。 </li><li><code>MySQL</code>是可以定制的，采用了 <code>GPL</code>协议，你可以修改源码来开发自己的 <code>MySQL</code> 系统。 </li><li>在线 <code>DDL</code>/更改功能，数据架构支持动态应用程序和开发人员灵活性（5.6新增） </li><li>复制全局事务标识，可支持自我修复式集群（5.6新增） </li><li>复制无崩溃从机，可提高可用性（5.6新增） </li><li>复制多线程从机，可提高性能（5.6新增）</li></ul><h3 id="应用环境组合"><a href="#应用环境组合" class="headerlink" title="应用环境组合"></a>应用环境组合</h3><p>与其他的大型数据库例如 <code>Oracle</code>、<code>DB2</code>、<code>SQL Server</code>等相比，<code>MySQL</code> 自有它的不足之处，但是这丝毫也没有减少它受欢迎的程度。对于一般的个人使用者和中小型企业来说，MySQL提供的功能已经绰绰有余，而且由于 <code>MySQ L</code>是开放源码软件，因此可以大大降低总体拥有成本。<code>Linux</code>作为操作系统，<code>Apache</code>和 <code>Nginx</code>作为 <code>Web</code> 服务器，<code>MySQL</code> 作为数据库，<code>PHP</code>/<code>Perl</code>/<code>Python</code>作为服务器端脚本解释器。由于这四个软件都是免费或开放源码软件（<code>FLOSS</code>)，因此使用这种方式不用花一分钱（除开人工成本）就可以建立起一个稳定、免费的网站系统，被业界称为<code>“LAMP“</code>或<code>“LNMP”</code>组合。</p><h3 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h3><ul><li><code>MyISAM</code>在<code>MySQL 5.0</code> 之前是默认数据库引擎，最为常用。拥有较高的插入，查询速度，但不支持事务 </li><li><code>InnoDB</code>事务型数据库的首选引擎，支持ACID事务，支持行级锁定, <code>MySQL 5.5</code> 起成为默认数据库引擎 </li><li><code>BDB</code>源 自 <code>Berkeley DB</code>，事务型数据库的另一种选择，支持<code>Commit</code> 和<code>Rollback</code> 等其他事务特性 </li><li><code>Memory</code>所有数据置于内存的存储引擎，拥有极高的插入，更新和查询效率。但是会占用和数据量成正比的内存空间。并且其内容会在 <code>MySQL</code> 重新启动时丢失 </li><li><code>Merge</code>将一定数量的 <code>MyISAM</code> 表联合而成一个整体，在超大规模数据存储时很有用 </li><li><code>Archive</code>非常适合存储大量的独立的，作为历史记录的数据。因为它们不经常被读取。<code>Archive</code> 拥有高效的插入速度，但其对查询的支持相对较差 </li><li><code>Federated</code>将不同的 <code>MySQL</code> 服务器联合起来，逻辑上组成一个完整的数据库。非常适合分布式应用 </li><li><code>Cluster</code>/<code>NDB</code>高冗余的存储引擎，用多台数据机器联合提供服务以提高整体性能和安全性。适合数据量大，安全和性能要求高的应用 </li><li><code>CSV</code>： 逻辑上由逗号分割数据的存储引擎。它会在数据库子目录里为每个数据表创建一个 <code>.csv</code> 文件。这是一种普通文本文件，每个数据行占用一个文本行。<code>CSV</code> 存储引擎不支持索引。 </li><li><code>BlackHole</code>：黑洞引擎，写入的任何数据都会消失，一般用于记录 <code>binlog</code>做复制的中继 </li><li><code>EXAMPLE</code> 存储引擎是一个不做任何事情的存根引擎。它的目的是作为 <code>MySQL</code> 源代码中的一个例子，用来演示如何开始编写一个新存储引擎。同样，它的主要兴趣是对开发者。<code>EXAMPLE</code> 存储引擎不支持编索引。</li></ul><h3 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h3><p><code>ACID</code>，指数据库事务正确执行的四个基本要素的缩写。包含：原子性（<code>Atomicity</code>）、一致性（<code>Consistency</code>）、隔离性（<code>Isolation</code>）、持久性（<code>Durability</code>）。一个支持事务（<code>Transaction</code>）的数据库，必需要具有这四种特性，否则在事务过程（Transaction <code>processing</code>）当中无法保证数据的正确性，交易过程极可能达不到交易方的要求。</p><ul><li>原子性<ul><li>整个事务中的所有操作，要么全部完成，要么全部不完成，不可能停滞在中间某个环节。事务在执行过程中发生错误，会被回滚（<code>Rollback</code>）到事务开始前的状态，就像这个事务从来没有执行过一样。</li></ul></li><li>一致性<ul><li>在事务开始之前和事务结束以后，数据库的完整性约束没有被破坏。具体来说就是，比如表与表之间存在外键约束关系，那么你对数据库进行的修改操作就必需要满足约束条件，即如果你修改了一张表中的数据，那你还需要修改与之存在外键约束关系的其他表中对应的数据，以达到一致性。</li></ul></li><li>隔离性<ul><li>隔离状态执行事务，使它们好像是系统在给定时间内执行的唯一操作。如果有两个事务，运行在相同的时间内，执行相同的功能，事务的隔离性将确保每一事务在系统中认为只有该事务在使用系统。这种属性有时称为串行化，为了防止事务操作间的混淆，必须串行化或序列化请求，使得在同一时间仅有一个请求用于同一数据。</li></ul></li><li>持久性<ul><li>在事务完成以后，该事务所对数据库所作的更改便持久的保存在数据库之中，并不会被回滚。 由于一项操作通常会包含许多子操作，而这些子操作可能会因为硬件的损坏或其他因素产生问题，要正确实现<code>ACID</code>并不容易。<code>ACID</code>建议数据库将所有需要更新以及修改的资料一次操作完毕，但实际上并不可行。 </li></ul></li></ul><p> 目前主要有两种方式实现<code>ACID</code>：第一种是<code>Write ahead logging</code>，也就是日志式的方式。第二种是<code>Shadow paging</code>。</p><h3 id="MySQL替代产品"><a href="#MySQL替代产品" class="headerlink" title="MySQL替代产品"></a>MySQL替代产品</h3><p>随着 <code>MySQL</code> 被 <code>Oracle</code> 收购，<code>MySQL</code> 的用户和开发者开始质疑开源数据库的命运，与此同时他们开始寻找替代品。</p><ul><li><code>MariaDB</code>：从 <code>MySQL</code> 转向 <code>MariaDB</code>的代表厂家：谷歌（2013年9月）、<code>RedHat</code>（2013年6月）、维基百科（2013年4月） 。<code>MariaDB</code>如同 <code>MySQL</code> 的影子版本，<code>MariaDB</code>是 <code>MySQL</code> 的一个分支版本（<code>branch</code>），而不是衍生版本（<code>folk</code>），提供的功能可和 <code>MySQL</code> 完全兼容。 </li><li><code>PostgreSQL</code>：从 <code>MySQL</code> 转向 <code>PostgreSQL</code>的代表厂家：苹果（2011年） 。</li><li><code>NoSQL</code>：(<code>NoSQL</code> = <code>Not Only SQL</code>)，意即 <strong>不仅仅是 SQL</strong> ，是一项全新的数据库革命性运动。<code>NoSQL</code>指的是非关系型的数据库。</li></ul><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://www.jianshu.com/p/bc66ab95717c" target="_blank" rel="noopener">简书：mysql的架构</a></p><p><a href="http://cuchadanfan.blog.51cto.com/9940284/1688364" target="_blank" rel="noopener">粗茶淡饭：MySQL（一）之通用二进制格式安装MySQL及数据库基本概念</a></p>]]></content>
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>目前流行的开源RDBMS</title>
      <link href="/2017/11/11/MySQL-Liuxing-Database/"/>
      <url>/2017/11/11/MySQL-Liuxing-Database/</url>
      <content type="html"><![CDATA[<h3 id="WebScaleSQL"><a href="#WebScaleSQL" class="headerlink" title="WebScaleSQL"></a>WebScaleSQL</h3><p>2015年1月20日，<code>Facebook</code>宣布阿里巴巴旗下的阿里云RDS团队正式加入<code>WebScaleSQL</code>。<code>WebScaleSQL</code>是<code>Facebook</code>、 <code>Google</code>、<code>Twitter</code>和<code>Linkedin</code>四家公司的<code>MySQL</code>团队发起的<code>MySQL</code>开源组织，旨在改进<code>MySQL</code>在规模和性能等方面的问题。<code>WebScaleSQL</code>是基于<code>MySQL 5.6</code> 社区版本改编的<code>MySQL</code>通用分支，基于<code>GPL</code>开源协议发布。<code>WebScaleSQL</code>目前已经做了很多性能改进工作，包括：客户端异步协调、逻辑预读、查询限流、服务端线程池优化、InnoDB大页支持等等。由于我们的分支上本身有一些定制化的需求，因此不会直接使用<code>WebScaleSQL</code>分支提供线上服务，但是这些改进对于我们都是很感兴趣的，好的特性会被吸收进来。因为我们有各种各样应用场景的用户，对<code>MySQL</code>本身的要求也比较高。比如大并发连接的用户，就需要线程池；存大量历史数据的用户，就要求高的压缩比等等。通过这可以看出虽然<code>WebScaleSQL</code>诞生时间较晚，但是其维护力量可以说是很强大的，最后用一句话概括：这款数据库就是专门为<code>web</code>服务设计的数据库。</p><a id="more"></a><h3 id="PostgreSQL"><a href="#PostgreSQL" class="headerlink" title="PostgreSQL"></a>PostgreSQL</h3><p><code>PostgreSQL</code>是以加州大学伯克利分校计算机系开发的 <code>POSTGRES</code>，现在已经更名为<code>PostgreSQL</code>，版本 4.2为基础的对象关系型数据库管理系统（<code>ORDBMS</code>）。<code>PostgreSQL</code>支持大部分 <code>SQL</code>标准并且提供了许多其他现代特性：复杂查询、外键、触发器、视图、事务完整性、<code>MVCC</code>。同样，<code>PostgreSQL</code> 可以用许多方法扩展，比如， 通过增加新的数据类型、函数、操作符、聚集函数、索引。免费使用、修改、和分发 <code>PostgreSQL</code>，不管是私用、商用、还是学术研究使用。</p><h3 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h3><p><code>SQLite</code>，是一款轻型的数据库，是遵守<code>ACID</code>的关系型数据库管理系统，它包含在一个相对小的<code>C</code>库中。它是<code>D.RichardHipp</code>建立的公有领域项目。它的设计目标是嵌入式的，而且目前已经在很多嵌入式产品中使用了它，它占用资源非常的低，在嵌入式设备中，可能只需要几百<code>K</code>的内存就够了。它能够支持<code>Windows</code>/<code>Linux</code>/<code>Unix</code>等等主流的操作系统，同时能够跟很多程序语言相结合，比如 <code>Tcl</code>、<code>C#</code>、<code>PHP</code>、<code>Java</code>等，还有<code>ODBC</code>接口，同样比起<code>Mysql</code>、<code>PostgreSQL</code>这两款开源的世界著名数据库管理系统来讲，它的处理速度比他们都快。<code>SQLite</code>第一个<code>Alpha</code>版本诞生于2000年5月。 至2015年已经有15个年头，<code>SQLite</code>也迎来了一个版本 <code>SQLite 3</code>已经发布。</p><h3 id="MariaDB"><a href="#MariaDB" class="headerlink" title="MariaDB"></a>MariaDB</h3><p><code>MariaDB</code>数据库管理系统是<code>MySQL</code>的一个分支，主要由开源社区在维护，采用<code>GPL</code>授权许可 <code>MariaDB</code>的目的是完全兼容<code>MySQL</code>，包括<code>API</code>和命令行，使之能轻松成为<code>MySQL</code>的代替品。在存储引擎方面，使用<code>XtraDB</code>（英语：<code>XtraDB</code>）来代替<code>MySQL</code>的<code>InnoDB</code>。 <code>MariaDB</code>由<code>MySQL</code>的创始人<code>Michael Widenius</code>（英语：<code>Michael Widenius</code>）主导开发，他早前曾以10亿美元的价格，将自己创建的公司<code>MySQL AB</code>卖给了<code>SUN</code>，此后，随着<code>SUN</code>被甲骨文收购，<code>MySQL</code>的所有权也落入<code>Oracle</code>的手中。<code>MariaDB</code>名称来自<code>Michael Widenius</code>的女儿<code>Maria</code>的名字。</p><p><code>MariaDB</code>基于事务的<code>Maria</code>存储引擎，替换了<code>MySQL</code>的<code>MyISAM</code>存储引擎，它使用了<code>Percona</code>的 <code>XtraDB</code>，I<code>nnoDB</code>的变体，分支的开发者希望提供访问即将到来的<code>MySQL 5.4 InnoDB</code>性能。这个版本还包括了 <code>PrimeBase XT (PBXT)</code> 和 <code>FederatedX</code>存储引擎。</p><p>说在最后，目前由于<code>MySQL</code>是属于<code>Oracle</code>公司的一款产品，而<code>Oracle</code>有将<code>MySQL</code>闭源的潜在风险，现在有很多大公司已经弃用<code>MySQL</code>，而<code>MariaDB</code>就是由<code>MySQL</code>之父<code>Michael</code>领头设计出来的一款开源数据库。确切来讲<code>MariaDB</code>是<code>MySQL</code>的分支版，而且整合了开源社区的很多东西，所以这款产品可以说就是<code>MySQL</code>的替代产品。由于其完全兼容<code>MySQL</code>所以今后演示就用<code>MariaDB</code>进行演示，而所有理论上的概念还是以<code>MySQL</code>为基础。</p><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://cuchadanfan.blog.51cto.com/9940284/1688364" target="_blank" rel="noopener">粗茶淡饭：MySQL（一）之通用二进制格式安装MySQL及数据库基本概念</a></p>]]></content>
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 目前流行的开源RDBMS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>关系型数据概念</title>
      <link href="/2017/11/11/MySQL-Guanxi-Database/"/>
      <url>/2017/11/11/MySQL-Guanxi-Database/</url>
      <content type="html"><![CDATA[<h3 id="RDBMS（关系型数据库管理系统）术语"><a href="#RDBMS（关系型数据库管理系统）术语" class="headerlink" title="RDBMS（关系型数据库管理系统）术语"></a>RDBMS（关系型数据库管理系统）术语</h3><ul><li><code>Database</code>：数据库是一个表的集合，与相关的数据。 </li><li><code>Table</code>： 一个表的数据是一个矩阵。在一个数据库中的表看起来像一个简单的电子表格。 </li><li><code>Column</code>： 一列（数据元素）包含的是同一个样的数据，例如列邮政编码。 </li><li><code>Row</code>： 行（元组，进入或记录）是一组相关的数据，例如一个订阅的数据。 </li><li><code>Redundancy</code>： 存储数据的两倍，冗余，使系统速度更快。 </li><li><code>Primary Key</code>：  主键是唯一的。一个关键值可以在一个表中不能出现两次。使用<code>key</code>我们可以在大多数行找到。 </li><li><code>Foreign Key</code>： 外键是两个表之间的链接杆。 </li><li><code>Compound Key</code>： 复合键（组合键）是一个重要的，由多个列，一列是因为并非十分独特。 </li><li><code>Index</code>：在一个数据库中的索引类似于在一本书的背面的一个索引。 </li><li><code>Referential Integrity</code>：参照完整性可以确保一个外键的值总是指向一个现有的行。</li></ul><a id="more"></a><h3 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h3><ol><li><p>关系型数据库可以简单的理解为二维数据库，表格式类似于<code>excel</code>表格，我们平时我接触的数据据，一般都是关系型数据库。</p></li><li><p>关系型数据库不是唯一的高级数据库模型，也不是最优的一种，但是，关系型数据库是现今使用最广泛、最易于理解和使用的数据库模型。</p></li></ol><ul><li>关系：可以理解成一张二维表，每个关系都有一个关系名，即表名。</li><li>元组：可以理解成二维表中的一行，在数据库中常被称作记录。 </li><li>属性：可以理解成二维表中的一列，在数据库中常被成为字段。 </li><li>域：属性的取值范围，也是数据库中某一列的取值限制。 </li><li>关键字：一组可以唯一标识元组的属性。数据库中常称为主键有一个或多个列组成。 </li><li>关系模式：对关系的描述，在数据库中通常称之为表结构。 </li></ul><h4 id="关系型数据库特点"><a href="#关系型数据库特点" class="headerlink" title="关系型数据库特点"></a>关系型数据库特点</h4><ul><li><strong>容易理解</strong>：二维表结构是非常贴近逻辑世界的一个概念，相对与网状、层次以及其它模型更容易理解。</li><li><strong>使用方便</strong>：通过SQL语言程序员和数据管理员可以很方便的在逻辑层面操作数据库而不必理解其底层实现。</li><li><strong>易于维护</strong>：丰富的完整性（实体完整性、参照完整性、用户自定义完整性）降低数据冗余和数据不一致的概率。    </li></ul><h4 id="关系操作"><a href="#关系操作" class="headerlink" title="关系操作"></a>关系操作</h4><ul><li>数据查询：选择、投影、连接、并、交、差、除</li><li>数据操作：增加、删除、修改、查询</li></ul><h4 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h4><p><code>SQL</code>(<code>Structured Query Language</code>)：结构化查询语言，一种特殊目的的编程语言，数据库查询和程序设计语言，用于存储数据以及查询、更新和管理关系型数据库。</p><p><strong>SQL查询语言组成部分</strong></p><ul><li><code>DDL</code>(<code>Data Definition Languages</code>)语句：数据定义语句，用于定义不同的数据段、数据库、表、列、索引等数据库的对象定义。常用关键字主要包括<code>create</code>、<code>drop</code>、<code>alter</code>等。</li><li><code>DML</code>(<code>Data Manipulation Language</code>)语句：数据操纵语句，用于添加、删除、更新和查询数据库记录，并检查数据完整性。常用关键字包括<code>insert</code>、<code>delete</code>、<code>update</code>和<code>select</code>等。</li><li><code>DCL</code>(<code>Data Control Language</code>)语句：数据控制语句，用于控制不同数据段直接的许可和访问级别的语句，用于定义数据库、表、字段、用户的访问权限和安全级别。常用关键字有<code>grant</code>、<code>revoke</code>等。</li></ul><h3 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h3><p><code>SQL</code>标准定义了4类隔离级，包括了一些具体规则，用来限定事务内外的哪些改变时可见的，哪些是不可见的。低级别的隔离级一般支持更高的并发处理，并拥有更低的系统开销。</p><ul><li><code>READ UNCOMMITTED</code>(读取未提交内容) <ul><li>在<code>READ UNCOMMITTED</code>隔离级，所有事务都可以“看到”未提交事务的执行结果。在这种级别上，可能会产生很多问题。本隔离级很少用于实际应用，因为它的性能也不比其他级别好多少，而别的级别还有其他更多的优点。读取未提交数据，也被称之为<code>“脏读(Dirty Read)”</code></li></ul></li><li><code>READ COMMITTED</code>(读取提交内容) <ul><li>大多数数据库系统的默认隔离级是<code>READ COMMITTED</code>(但这不是<code>MYSQL</code>默认的)。它满足了隔离的早先简单定义：一个事务在开始时，只能“看见”已经提交事务所做的改变，一个事务从开始到提交前，所做的任何数据改变都是不可见的，除非已经提交。这种隔离级别也支持所谓的“不可重复读(<code>Nonrepeatable Read</code>)”。这意味着用户运行同一语句两次，看到的结果是不同的。</li></ul></li><li><code>REPEATABLE READ</code>(可重读) <ul><li><code>REPEATABLE READ</code> 隔离级解决了<code>READ UNCOMMITTED</code>隔离级导致的问题。它确保同一事务的多个实例在并发读取数据时，会“看到相同的”数据行。不过理论上，这会导致另一个棘手问题：幻读(<code>Phantom Read</code>)。简单来说，幻读指当用户读取某一范围的数据行时，另一个事务又在该范围内插入了新行，当用户再读取该范围的数据行时，另一个事务又在该范围内插入了新行，当用户再读取该范围的数据行时，会发现有新的“幻影”行。<code>InnoDB</code>和<code>Falcon</code>存储引擎通过多版本并发控制机制解决了幻读问题。 <code>REPEATABLE READ</code> 是<code>MYSQL</code>的默认事务隔离级。<code>InnoDB</code>和<code>Falcon</code>存储引擎都遵循这种设置。</li></ul></li><li><code>SERIALIZABLE</code>(可串行化) <ul><li><code>SERIALIZABLE</code>是最高级别的隔离级，它通过强制事务排斥，使之不可能相互冲突，从而解决幻读问题。简言之，<code>SERIALIZABLE</code>是在每个读的数据行上加锁。在这个级别，可能导致大量的超时现象和锁竞争现象。很少看到有用户选择这种隔离级。</li></ul></li></ul><p><strong>注</strong> ：不可重复读与幻读：不可重复读的重点是修改(同样的查询条件，你读取过的数据，再次读取出来发现值不一样了);幻读的重点在于新增或者删除(同样的查询条件，第1次和第2次读出来的记录数不一样)</p><h3 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h3><p>就是使用时间戳或者事务<code>ID</code>来控制数据的多版本</p><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://cuchadanfan.blog.51cto.com/9940284/1688364" target="_blank" rel="noopener">粗茶淡饭：MySQL（一）之通用二进制格式安装MySQL及数据库基本概念</a></p>]]></content>
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 关系型数据概念 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>设计关系数据库的范式基础概念</title>
      <link href="/2017/11/11/MySQL-Fanshi/"/>
      <url>/2017/11/11/MySQL-Fanshi/</url>
      <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>数据库管理系统：<code>DBMS</code>(<code>Datebase Management System</code>)。是一种操纵和管理数据库的大型软件，用于建立、使用和维护数据库。</p><a id="more"></a><p><code>RDBMS</code>即关系数据库管理系统(<code>Relational Database Management System</code>)，是将数据组织为相关的行和列的系统，而管理关系数据库的计算机软件就是关系数据库管理系统，常用的数据库软件有<code>Oracle</code>、<code>SQL Server</code>等。</p><h3 id="RDMBS设计范式基础概念"><a href="#RDMBS设计范式基础概念" class="headerlink" title="RDMBS设计范式基础概念"></a>RDMBS设计范式基础概念</h3><p>设计关系数据库时，遵从不同的规范要求，设计出合理的关系型数据库，这些不同的规范要求被称为不同的范式，各种范式呈递次规范，越高的范式数据库冗余越小。</p><p>目前关系数据库有六种范式：第一范式（<code>1NF</code>）、第二范式（<code>2NF</code>）、第三范式（<code>3NF</code>）、巴德斯科范式（<code>BCNF</code>）、第四范式(<code>4NF</code>）和第五范式（<code>5NF</code>，又称完美范式）。满足最低要求的范式是第一范式（1NF）。在第一范式的基础上进一步满足更多规范要求的称为第二范式（2NF），其余范式以次类推。一般说来，数据库只需满足第三范式(<code>3NF</code>）即可。</p><h4 id="第一范式（1NF）"><a href="#第一范式（1NF）" class="headerlink" title="第一范式（1NF）"></a>第一范式（1NF）</h4><p>每一列都是不可分割的基本数据项，同一列中不能有多个值，即实体中的某个属性不能有多个值或者不能有重复的属性。<strong>除去同类型的字段，就是无重复的列（域或字段）</strong></p><h4 id="第二范式（2NF）"><a href="#第二范式（2NF）" class="headerlink" title="第二范式（2NF）"></a>第二范式（2NF）</h4><p><strong>第二范式必须先满足第一范式</strong>，<strong>要求表中的每个行必须可以被唯一地区分</strong>。通常为表加上一个列，以存储各个实例的唯一标识PK。非PK的字段需要与整个PK有直接相关性</p><h4 id="第三范式（3NF）"><a href="#第三范式（3NF）" class="headerlink" title="第三范式（3NF）"></a>第三范式（3NF）</h4><p><strong>满足第三范式必须先满足第二范式。一个数据库表中不包含已在其它表中已包含的非主关键字信息。</strong> 第三范式要求一个数据库表中不包含已在其它表中已包含的非主关键字信息，非PK的字段间不能有从属关系。</p>]]></content>
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计关系数据库的范式基础概念 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>数据结构模型</title>
      <link href="/2017/11/11/MySQL-Data-Jiegou/"/>
      <url>/2017/11/11/MySQL-Data-Jiegou/</url>
      <content type="html"><![CDATA[<h3 id="数据结构模型常见的有以下三种："><a href="#数据结构模型常见的有以下三种：" class="headerlink" title="数据结构模型常见的有以下三种："></a>数据结构模型常见的有以下三种：</h3><ul><li>层次模型</li><li>网状模型</li><li>关系模型</li></ul><a id="more"></a><h3 id="层次模型"><a href="#层次模型" class="headerlink" title="层次模型"></a>层次模型</h3><p>层次模型是一种用树形结构描述实体及其之间关系的数据模型。在这种结构中，每一个记录类型都是用节点表示，记录类型之间的联系则用结点之间的有向线段来表示。每一个双亲结点可以有多个子节点但是每一个子节点只能有一个双亲结点。这种结构决定了采用层次模型作为数系组织方式的层次数据库系统只能处理一对多的实体联系。</p><p>由<code>IBM</code>于1968年推出的<code>IMS</code>（<code>Information Management System</code>）数据库管理系统是第一个层次模型数据库管理系统，也是最典型的一个。</p><p><strong>缺点：</strong> 每一个子节点只能有一个父结点，和多个父节点发生关系非常困难。</p><h3 id="网状模型"><a href="#网状模型" class="headerlink" title="网状模型"></a>网状模型</h3><p>网状模型是一种可以灵活地描述事物及其之间关系的数据库模型。最早由美国的查尔斯·巴赫曼发明。</p><p>层次模型使用树形结构来表示实体及实体间的关系，每一个结点表示一个记录，除了根节点外每一个节点都有且仅有一个双亲结点，但可以有多个子节点。但是网状模型允许一个结点可以同时拥有多个双亲结点和子节点。因而同层次模型相比，网状结构更具有普遍性，能够直接地描述现实世界的实体。也可以认为层次模型是网状模型的一个特例。</p><p><strong>缺点：</strong> 网状模型可以使每个子节点和多个节点发生关系。一旦应用程序应用需求发生改变，底层的数据模型就会发生改变。底层数据模型发生改变，那么应用程序也要发生改变。数据的存储，数据的结构设计与应用层序有非常大的耦合度，并不灵活。</p><h3 id="关系模型"><a href="#关系模型" class="headerlink" title="关系模型"></a>关系模型</h3><p>用于数据库管理的关系模型（英语：<code>Relational model</code>）是基于谓词逻辑和集合论的一种数据模型，广泛被使用于数据库之中。最早于1969年由埃德加·科德提出。</p><p>关系模型的基本假定是所有数据都表示为数学上的关系，就是说<code>n</code>个集合的笛卡儿积的一个子集，有关这种数据的推理通过二值（就是说没有<code>NULL</code>）的谓词逻辑来进行，这意味着对每个命题都没有两种可能的赋值：要么是真要么是假。数据通过关系演算和关系代数的一种方式来操作。关系模型是采用二维表格结构表达实体类型及实体间联系的数据模型。</p><p>关系(<code>Relation</code>)：一个关系对应着一个二维表，二维表就是关系名。</p><p>关系模型中，字段称为属性，字段值称为属性值，记录类型称为关系模型。</p>]]></content>
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据结构模型 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>数据库简介</title>
      <link href="/2017/11/11/MySQL-DataBase/"/>
      <url>/2017/11/11/MySQL-DataBase/</url>
      <content type="html"><![CDATA[<center><img src="https://houhaiyun.github.io/img/images/MySQL-DataBase-1.png" title="数据库"></center><h3 id="什么是数据库？"><a href="#什么是数据库？" class="headerlink" title="什么是数据库？"></a>什么是数据库？</h3><p><strong>数据库，简单来说可视为电子化的文件柜——存储电子文件的处所，用户可以对文件中的数据运行新增、截取、更新、删除等操作。</strong></p><a id="more"></a><p><strong>数据库指的是以一定方式储存在一起、能为多个用户共享、具有尽可能小的冗余度、与应用程序彼此独立的数据集合。</strong></p><h3 id="数据库管理系统"><a href="#数据库管理系统" class="headerlink" title="数据库管理系统"></a>数据库管理系统</h3><p>数据库管理系统（英语：<code>Database Management System</code>，简称<code>DBMS</code>）是为管理数据库而设计的电脑软件系统，一般具有存储、截取、安全保障、备份等基础功能。数据库管理系统可以依据它所支持的数据库模型来作分类，例如关系式、<code>XML</code>；或依据所支持的电脑类型来作分类，例如服务器群集、移动电话；或依据所用查询语言来作分类，例如<code>SQL</code>、<code>XQuery</code>；或依据性能冲量重点来作分类，例如最大规模、最高运行速度；亦或其他的分类方式。不论使用哪种分类方式，一些<code>DBMS</code>能够跨类别，例如，同时支持多种查询语言。</p><h3 id="数据库基本结构"><a href="#数据库基本结构" class="headerlink" title="数据库基本结构"></a>数据库基本结构</h3><ul><li><strong>物理数据层</strong><ul><li>它是数据库的最内层，是物理存贮设备上实际存储的数据的集合。这些数据是原始数据，是用户加工的对象，由内部模式描述的指令操作处理的位串、字符和字组成。</li></ul></li><li><strong>概念数据层</strong><ul><li>它是数据库的中间一层，是数据库的整体逻辑表示。指出了每个数据的逻辑定义及数据间的逻辑联系，是存贮记录的集合。它所涉及的是数据库所有对象的逻辑关系，而不是它们的物理情况，是数据库管理员概念下的数据库。</li></ul></li><li><strong>用户数据层</strong><ul><li>它是用户所看到和使用的数据库，表示了一个或一些特定用户使用的数据集合，即逻辑记录的集合。 数据库不同层次之间的联系是通过映射进行转换的。</li></ul></li></ul><h3 id="数据库主要特点"><a href="#数据库主要特点" class="headerlink" title="数据库主要特点"></a>数据库主要特点</h3><ul><li><strong>实现数据共享</strong><ul><li>数据共享包含所有用户可同时存取数据库中的数据，也包括用户可以用各种方式通过接口使用数据库，并提供数据共享。</li></ul></li><li><strong>减少数据的冗余度</strong></li><li><strong>数据的独立性</strong></li><li><strong>数据实现几种控制</strong><ul><li>文件管理方式中，数据处于一种分散的状态，不同的用户或同一用户在不同处理中其文件之间毫无关系。利用数据库可对数据进行集中控制和管理，并通过数据模型表示各种数据的组织以及数据间的联系。</li></ul></li><li><strong>数据一致性和可维护性</strong><ul><li>主要包括：①安全性控制：以防止数据丢失、错误更新和越权使用；②完整性控制：保证数据的正确性、有效性和相容性；③并发控制：使在同一时间周期内，允许对数据实现多路存取，又能防止用户之间的不正常交互作用。</li></ul></li><li><strong>故障恢复</strong><ul><li>由数据库管理系统提供一套方法，可及时发现故障和修复故障，从而防止数据被破坏。数据库系统能尽快恢复数据库系统运行时出现的故障，可能是物理上或是逻辑上的错误。比如对系统的误操作造成的数据错误等。</li></ul></li></ul><h3 id="数据库发展阶段"><a href="#数据库发展阶段" class="headerlink" title="数据库发展阶段"></a>数据库发展阶段</h3><h4 id="1-人工管理"><a href="#1-人工管理" class="headerlink" title="1. 人工管理"></a>1. 人工管理</h4><p>这一阶段的主要特征可归纳为如下几点：</p><ul><li>计算机中没有支持数据管理的软件。 </li><li>数据组织面向应用，数据不能共享，数据重复。 </li><li>在程序中要规定数据的逻辑结构和物理结构，数据与程序不独立。 </li><li>数据处理方式——批处理。</li></ul><h4 id="2-文件系统"><a href="#2-文件系统" class="headerlink" title="2. 文件系统"></a>2. 文件系统</h4><p>这一阶段的主要标志是计算机中有了专门管理数据库的软件——操作系统（文件管理）。</p><h4 id="3-数据系统阶段"><a href="#3-数据系统阶段" class="headerlink" title="3. 数据系统阶段"></a>3. 数据系统阶段</h4><ul><li>面向企业或部门，以数据为中心组织数据，形成综合性的数据库，为各应用共享。 </li><li>采用一定的数据模型。数据模型不仅要描述数据本身的特点，而且要描述数据之间的联系。 </li><li>数据冗余小，易修改、易扩充。不同的应用程序根据处理要求，从数据库中获取需要的数据，这样就减少了数据的重复存储，也便于增加新的数据结构，便于维护数据的一致性。 </li><li>程序和数据有较高的独立性。 </li><li>具有良好的用户接口，用户可方便地开发和使用数据库。 </li><li>对数据进行统一管理和控制，提供了数据的安全性、完整性、以及并发控制。</li></ul><h4 id="4-高级数据系统阶段"><a href="#4-高级数据系统阶段" class="headerlink" title="4. 高级数据系统阶段"></a>4. 高级数据系统阶段</h4><p>由于现在数据成爆炸式增长，在传统型的数据系统已经不能满足人们的需要，为存储海量的数据现阶段引入了分布式文件系统以及<code>nosql</code>等新的高级数据系统。</p><h3 id="数据库系统软件"><a href="#数据库系统软件" class="headerlink" title="数据库系统软件"></a>数据库系统软件</h3><ul><li><strong>关系型数据库管理系统（<code>RDBMS</code>）</strong><ul><li><code>Oracle</code></li><li><code>SQLServer</code></li><li><code>MySQL</code></li><li><code>MariaDB</code>（开源免费使用）</li><li><code>DB2</code></li><li><code>Sybase</code></li><li><code>PostgreSQL</code></li><li><code>SQLITE</code>（适用于嵌入式系统）</li></ul></li><li><strong>非关系型数据库管理系统（<code>nosql</code>）</strong><ul><li>基于键值：<code>Redis</code></li><li>基于列存储数据库：<code>HBase</code></li><li>基于文档数据库：<code>MongoDB</code></li><li>基于图形数据库：<code>Neo4J</code></li></ul></li></ul><p>关于关系型及非关系型数据库这里只列举了一部分常见的，特别是非关系型数据库还有很多，这里就不多做介绍了。这里我们主要讨论关系型数据库<code>MySQL</code>。</p><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93" target="_blank" rel="noopener">维基百科：数据库</a></p><p><a href="http://cuchadanfan.blog.51cto.com/9940284/1688364" target="_blank" rel="noopener">粗茶淡饭：MySQL（一）之通用二进制格式安装MySQL及数据库基本概念</a></p>]]></content>
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库简介 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>tomcat + memcached session manager共享session</title>
      <link href="/2017/11/09/Memcached-Tomcat-Session-Manager/"/>
      <url>/2017/11/09/Memcached-Tomcat-Session-Manager/</url>
      <content type="html"><![CDATA[<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><center><img src="https://houhaiyun.github.io/img/images/Memcached-Tomcat-Session-Manager-1.jpg" title="拓扑图"></center><table><thead><tr><th>服务</th><th>IP</th><th>系统版本</th><th>软件版本</th><th>功能</th></tr></thead><tbody><tr><td>Nginx</td><td>192.168.8.17/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>nginx.x86_64 1:1.10.2</td><td>反向代理</td></tr><tr><td>Tomcat1</td><td>192.168.8.12/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>tomcat-7.0.69(java-1.8.0-openjdk)</td><td>应用服务</td></tr><tr><td>Tomcat2</td><td>192.168.8.15/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>tomcat-7.0.69(java-1.8.0-openjdk)</td><td>应用服务</td></tr><tr><td>Memcached1</td><td>192.168.8.11/24</td><td>CentOS release 6.9 (Final)</td><td>memcached.x86_64 0:1.4.4-5</td><td>缓存服务</td></tr><tr><td>Memcached2</td><td>192.168.8.13/24</td><td>CentOS release 6.9 (Final)</td><td>memcached.x86_64 0:1.4.4-5</td><td>缓存服务</td></tr></tbody></table><p>简单说明下：<code>tomcat1</code>为主要把它的<code>session</code>存储到<code>memcached2</code>上，而<code>memcache2</code>是运行在另一台主机上的（一般情况下，<code>memcached</code>是存<code>tomcat1</code>的<code>session</code>），只有当<code>memcached2</code>不可用时，<code>tomcat1</code>才会把<code>session</code>存在<code>memcached1</code>上，也就是说<code>memcached1</code>是为了<code>tomcat1</code>做故障切换用的节点。这要的话，当<code>machine1</code>挂了的时候，<code>session</code>是不会丢失的。</p><a id="more"></a><h4 id="1-修改主机名"><a href="#1-修改主机名" class="headerlink" title="1. 修改主机名"></a>1. 修改主机名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Nginx调度器配置</span><br><span class="line">[root@Nginx ~]# hostname Nginx.ihaiyun.cc &amp;&amp; exec bash</span><br><span class="line"></span><br><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# hostname Tomcat1.ihaiyun.cc &amp;&amp; exec bash</span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# hostname Tomcat2.ihaiyun.cc &amp;&amp; exec bash</span><br><span class="line"></span><br><span class="line"># Memcached1配置</span><br><span class="line">[root@Memcached1 ~]# hostname Memcached1.ihaiyun.cc &amp;&amp; exec bash</span><br><span class="line"></span><br><span class="line"># Memcached2配置</span><br><span class="line">[root@Memcached2 ~]# hostname Memcached2.ihaiyun.cc &amp;&amp; exec bash</span><br></pre></td></tr></table></figure><h4 id="2-同步所有sever时间"><a href="#2-同步所有sever时间" class="headerlink" title="2. 同步所有sever时间"></a>2. 同步所有sever时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># Nginx调度器配置</span><br><span class="line">[root@Nginx ~]# ntpdate 172.18.0.1</span><br><span class="line"> 9 Nov 11:41:08 ntpdate[11275]: step time server 172.18.0.1 offset 2.684816 sec</span><br><span class="line">[root@Nginx ~]# date</span><br><span class="line">Thu Nov  9 11:41:13 CST 2017</span><br><span class="line"></span><br><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 9 Nov 11:41:08 ntpdate[11272]: step time server 172.18.0.1 offset 1.247753 sec</span><br><span class="line">[root@Tomcat1 ~]# date</span><br><span class="line">Thu Nov  9 11:41:13 CST 2017</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 9 Nov 11:41:08 ntpdate[2200]: step time server 172.18.0.1 offset 0.937129 sec</span><br><span class="line">[root@Tomcat2 ~]# date</span><br><span class="line">Thu Nov  9 11:41:13 CST 2017</span><br><span class="line"></span><br><span class="line"># Memcached1配置</span><br><span class="line">[root@Memcached1 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 9 Nov 11:41:02 ntpdate[1722]: step time server 172.18.0.1 offset -21.159589 sec</span><br><span class="line">[root@Memcached1 ~]# date</span><br><span class="line">Thu Nov  9 11:41:13 CST 2017</span><br><span class="line"></span><br><span class="line"># Memcached2配置</span><br><span class="line">[root@Memcached2 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 9 Nov 11:41:02 ntpdate[1941]: step time server 172.18.0.1 offset 2.332137 sec</span><br><span class="line">[root@Memcached2 ~]# date</span><br><span class="line">Thu Nov  9 11:41:13 CST 2017</span><br></pre></td></tr></table></figure><h3 id="准备Tomcat-server"><a href="#准备Tomcat-server" class="headerlink" title="准备Tomcat server"></a>准备Tomcat server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# yum -y install java-1.8.0-openjdk-devel</span><br><span class="line">[root@Tomcat1 ~]# yum -y  install tomcat</span><br><span class="line">[root@Tomcat1 ~]# cd /usr/share/tomcat/webapps/</span><br><span class="line">[root@Tomcat1 webapps]# mkdir -p  myapp/WEB-INF</span><br><span class="line">[root@Tomcat1 webapps]# cd myapp/</span><br><span class="line">[root@Tomcat1 myapp]# vim index.jsp </span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;Tomcat1&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;&lt;font color=&quot;red&quot;&gt;Tomcat1.ihaiyun.cc&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">&lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;</span><br><span class="line">&lt;tr&gt;</span><br><span class="line">&lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">&lt;% session.setAttribute(&quot;ihaiyun.cc&quot;,&quot;magedu.com&quot;); %&gt;</span><br><span class="line">&lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;tr&gt;</span><br><span class="line">&lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">&lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@Tomcat1 ~]# systemctl start tomcat        # 启动tomcat服务；</span><br><span class="line">[root@Tomcat1 ~]# elinks -dump http://192.168.8.12:8080/myapp/      # 访问测试，ok；</span><br><span class="line">                               Tomcat1.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | CDB3C77782AFEB964DD6172FBFA708A8 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510199505033                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# yum -y install java-1.8.0-openjdk-devel</span><br><span class="line">[root@Tomcat2 ~]# yum -y  install tomcat</span><br><span class="line">[root@Tomcat2 ~]# cd /usr/share/tomcat/webapps/</span><br><span class="line">[root@Tomcat2 webapps]# mkdir -p  myapp/WEB-INF</span><br><span class="line">[root@Tomcat2 webapps]# cd myapp/</span><br><span class="line">[root@Tomcat2 myapp]# vim index.jsp </span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;Tomcat1&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;&lt;font color=&quot;blue&quot;&gt;Tomcat2.ihaiyun.cc&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">&lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;</span><br><span class="line">&lt;tr&gt;</span><br><span class="line">&lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">&lt;% session.setAttribute(&quot;ihaiyun.cc&quot;,&quot;magedu.com&quot;); %&gt;</span><br><span class="line">&lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;tr&gt;</span><br><span class="line">&lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">&lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Tomcat2 ~]# systemctl start tomcat</span><br><span class="line">[root@Tomcat2 ~]# elinks -dump http://192.168.8.15:8080/myapp       # 访问测试，ok；</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 5E1E7AE5B658EDB781276CC37E5B8431 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510199718989                    |</span><br><span class="line">   +-----------------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="准备Memcached-server"><a href="#准备Memcached-server" class="headerlink" title="准备Memcached server"></a>准备Memcached server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># Memcached1配置</span><br><span class="line">[root@Memcached1 ~]# yum -y  install memcached</span><br><span class="line">[root@Memcached1 ~]# service memcached start</span><br><span class="line">Starting memcached:                                        [  OK  ]</span><br><span class="line">[root@Memcached1 ~]# ss -uln            # 端口已经打开；</span><br><span class="line">State       Recv-Q Send-Q              Local Address:Port                Peer Address:Port </span><br><span class="line">UNCONN      0      0                               *:68                             *:*     </span><br><span class="line">UNCONN      0      0                               *:11211                          *:*     </span><br><span class="line">UNCONN      0      0                              :::11211                         :::*    </span><br><span class="line"></span><br><span class="line"># Memcached2配置</span><br><span class="line">[root@Memcached2 ~]# yum -y  install memcached</span><br><span class="line">[root@Memcached2 ~]# service memcached start</span><br><span class="line">Starting memcached:                                        [  OK  ]</span><br><span class="line">[root@Memcached2 ~]# ss -uln            # 端口已经打开；</span><br><span class="line">State       Recv-Q Send-Q              Local Address:Port                Peer Address:Port </span><br><span class="line">UNCONN      0      0                               *:68                             *:*     </span><br><span class="line">UNCONN      0      0                               *:11211                          *:*     </span><br><span class="line">UNCONN      0      0                              :::11211                         :::*</span><br></pre></td></tr></table></figure><h3 id="将memcached-session-manager配置为-Manager"><a href="#将memcached-session-manager配置为-Manager" class="headerlink" title="将memcached-session-manager配置为 Manager"></a>将memcached-session-manager配置为 <context>Manager</context></h3><p><code>MSM</code>支持<code>tomcat6</code>，<code>tomcat7</code>，<code>tomcat8</code>，<code>MSM</code>支持两种模式:<code>sticky sessions</code>（<code>粘性session</code>）和<code>non-sticky sessions</code>（<code>非粘性session</code>）。我用到的是<code>sticky session</code>。</p><p>软件包简介</p><ul><li><code>javolution-5.4.3.1.jar</code>：流式化工具</li><li><code>msm-javolution-serializer-1.8.3.jar</code>：MSM</li><li><code>memcached-session-manager-1.8.3.jar</code>：memcached会话管理器</li><li><code>memcached-session-manager-tc7-1.8.3.jar</code>：memcached会话管理器（适用于tomcat7）</li><li><code>spymemcached-2.11.1.jar</code>：tomcat连接memcached的驱动</li></ul><p><a href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration" target="_blank" rel="noopener">软件包下载地址：https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration</a></p><p>通过<code>tomcat</code>扩展类，使<code>tomcat</code>支持将本地<code>session</code>通过<code>memcached</code>驱动和流式化工具和会话管理器将<code>session</code>存入<code>memcached</code>服务器中，实现<code>session</code>共享。（个人理解，如有不对，欢迎指出。）</p><p><code>sticky sessions</code>粘性<code>session + kryo</code>序列化。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@Tomcat1 ~]# ls        # 包已经下载好，如下；</span><br><span class="line">javolution-5.4.3.1.jar                   msm-javolution-serializer-1.8.3.jar</span><br><span class="line">memcached-session-manager-1.8.3.jar      spymemcached-2.11.1.jar</span><br><span class="line">memcached-session-manager-tc7-1.8.3.jar</span><br><span class="line">[root@Tomcat1 ~]# cp *.jar /usr/share/tomcat/lib/       # 将下载好的包拷贝到/usr/share/tomcat/lib/目录下；</span><br><span class="line">[root@Tomcat1 ~]# scp *.jar 192.168.8.15:/usr/share/tomcat/lib/         # 将软件包复制到192.168.8.15的对应目录下；</span><br><span class="line">The authenticity of host &apos;192.168.8.15 (192.168.8.15)&apos; can&apos;t be established.</span><br><span class="line">ECDSA key fingerprint is 09:b5:88:63:ef:63:4a:d5:b3:d8:d5:04:73:92:b6:1e.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;192.168.8.15&apos; (ECDSA) to the list of known hosts.</span><br><span class="line">root@192.168.8.15&apos;s password: </span><br><span class="line">javolution-5.4.3.1.jar                                     100%  442KB 442.1KB/s   00:00    </span><br><span class="line">memcached-session-manager-1.8.3.jar                        100%  144KB 143.6KB/s   00:00    </span><br><span class="line">memcached-session-manager-tc7-1.8.3.jar                    100%   11KB  11.0KB/s   00:00    </span><br><span class="line">msm-javolution-serializer-1.8.3.jar                        100%   69KB  69.4KB/s   00:00    </span><br><span class="line">spymemcached-2.11.1.jar                                    100%  449KB 448.7KB/s   00:00  </span><br><span class="line"></span><br><span class="line"># tomcat1的配置文件</span><br><span class="line">[root@Tomcat1 ~]# vim  /etc/tomcat/server.xml           # 修改配置文件；</span><br><span class="line">      &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">            &lt;Context path=&quot;/myapp&quot; docBase=&quot;/usr/share/tomcat/webapps/myapp&quot; reloadable=&quot;true&quot;&gt;</span><br><span class="line">              &lt;Manager className=&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span><br><span class="line">                memcachedNodes=&quot;m1:192.168.8.11:11211,m2:192.168.8.13:11211&quot;        # 此处填写的为memcached1和memcached2的IP；</span><br><span class="line">                failoverNodes=&quot;m1&quot;          # 参数failoverNodes=&quot;n1&quot; 是用来告诉 MSM 把session优先存储在 memcached2上，只有当memcached2挂了的时候才会把session存在memcache1也就是配置文件的n1里。假如整个machine1挂了，session还是可用，因为session是存在machine2的memcache2上，可以通过tomcat2对外提供服务。</span><br><span class="line">                requestUriIgnorePattern=&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span><br><span class="line">                transcoderFactoryClass=&quot;de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory&quot;</span><br><span class="line">              /&gt;</span><br><span class="line">             &lt;/Context&gt;</span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">               prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;</span><br><span class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/Host&gt;</span><br><span class="line"></span><br><span class="line"># tomcat2的配置文件</span><br><span class="line">[root@Tomcat2 ~]# vim /etc/tomcat/server.xml        # 修改配置文件；</span><br><span class="line">      &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">            &lt;Context path=&quot;/myapp&quot; docBase=&quot;/usr/share/tomcat/webapps/myapp&quot; reloadable=&quot;true&quot;&gt;</span><br><span class="line">              &lt;Manager className=&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span><br><span class="line">                memcachedNodes=&quot;m1:192.168.8.11:11211,m2:192.168.8.13:11211&quot;</span><br><span class="line">                failoverNodes=&quot;m2&quot;          # 注意此处为m2；</span><br><span class="line">                requestUriIgnorePattern=&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span><br><span class="line">                transcoderFactoryClass=&quot;de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory&quot;</span><br><span class="line">              /&gt;</span><br><span class="line">             &lt;/Context&gt;</span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">               prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;</span><br><span class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/Host&gt;</span><br></pre></td></tr></table></figure></p><h3 id="配置Nginx调度器"><a href="#配置Nginx调度器" class="headerlink" title="配置Nginx调度器"></a>配置Nginx调度器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# yum -y  install nginx</span><br><span class="line">[root@Nginx ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line">    upstream tcsrvs &#123;</span><br><span class="line">        server 192.168.8.12:8080;       # 定义tomcat1的IP；</span><br><span class="line">        server 192.168.8.15:8080;       # 定义tomcat2的IP；</span><br><span class="line">    &#125;   </span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line">    sendfile            on; </span><br><span class="line">    tcp_nopush          on; </span><br><span class="line">    tcp_nodelay         on; </span><br><span class="line">    keepalive_timeout   65; </span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  _;  </span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line">        location / &#123; </span><br><span class="line">            proxy_pass http://tcsrvs ;      # 调度；</span><br><span class="line">        &#125;   </span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;   </span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="启动服务测试"><a href="#启动服务测试" class="headerlink" title="启动服务测试"></a>启动服务测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# systemctl start nginx       # 启动nginx调度器；</span><br><span class="line">[root@Tomcat1 ~]# systemctl restart tomcat      # 重启tomcat；</span><br><span class="line">[root@Tomcat2 ~]# systemctl restart tomcat      # 重启tomcat；</span><br></pre></td></tr></table></figure><center>已经实现会话绑定</center><center><img src="https://houhaiyun.github.io/img/images/Memcached-Tomcat-Session-Manager-2.gif" title="测试访问"></center><h3 id="停止memcached2测试"><a href="#停止memcached2测试" class="headerlink" title="停止memcached2测试"></a>停止memcached2测试</h3><p>停止memcached2测试，会话是否能够保持。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Memcached2 ~]# service memcached stop             # 停止memcached2；</span><br><span class="line">Stopping memcached:                                        [  OK  ]</span><br></pre></td></tr></table></figure><center>会话可以保持</center><br><center><img src="https://houhaiyun.github.io/img/images/Memcached-Tomcat-Session-Manager-3.gif" title="测试访问"></center><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://laoxu.blog.51cto.com/4120547/1566477" target="_blank" rel="noopener">老徐的私房菜：tomcat + memcached session manager共享session</a></p><h3 id="实验中用到的配置文件"><a href="#实验中用到的配置文件" class="headerlink" title="实验中用到的配置文件"></a>实验中用到的配置文件</h3><p>把配置文件复制到此，方便大家复制，嘻嘻。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"># tomcat1配置文件</span><br><span class="line">[root@Tomcat1 ~]# vim /etc/tomcat/server.xml        # 注意：复制时要看清楚标签为Host；</span><br><span class="line">      &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">            &lt;Context path=&quot;/myapp&quot; docBase=&quot;/usr/share/tomcat/webapps/myapp&quot; reloadable=&quot;true&quot;&gt;</span><br><span class="line">              &lt;Manager className=&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span><br><span class="line">                memcachedNodes=&quot;m1:192.168.8.11:11211,m2:192.168.8.13:11211&quot;</span><br><span class="line">                failoverNodes=&quot;m1&quot;</span><br><span class="line">                requestUriIgnorePattern=&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span><br><span class="line">                transcoderFactoryClass=&quot;de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory&quot;</span><br><span class="line">              /&gt;</span><br><span class="line">             &lt;/Context&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- SingleSignOn valve, share authentication between web applications</span><br><span class="line">             Documentation at: /docs/config/valve.html --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.authenticator.SingleSignOn&quot; /&gt;</span><br><span class="line">        --&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- Access log processes all example.</span><br><span class="line">             Documentation at: /docs/config/valve.html</span><br><span class="line">             Note: The pattern used is equivalent to using pattern=&quot;common&quot; --&gt;</span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">               prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;</span><br><span class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/Host&gt;</span><br><span class="line"></span><br><span class="line"># tomcat2配置文件</span><br><span class="line">[root@Tomcat2 ~]# vim /etc/tomcat/server.xml    # 注意：复制时要看清楚标签为Host；</span><br><span class="line">      &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">            &lt;Context path=&quot;/myapp&quot; docBase=&quot;/usr/share/tomcat/webapps/myapp&quot; reloadable=&quot;true&quot;&gt;</span><br><span class="line">              &lt;Manager className=&quot;de.javakaffee.web.msm.MemcachedBackupSessionManager&quot;</span><br><span class="line">                memcachedNodes=&quot;m1:192.168.8.11:11211,m2:192.168.8.13:11211&quot;</span><br><span class="line">                failoverNodes=&quot;m2&quot;</span><br><span class="line">                requestUriIgnorePattern=&quot;.*\.(ico|png|gif|jpg|css|js)$&quot;</span><br><span class="line">                transcoderFactoryClass=&quot;de.javakaffee.web.msm.serializer.javolution.JavolutionTranscoderFactory&quot;</span><br><span class="line">              /&gt;</span><br><span class="line">             &lt;/Context&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- SingleSignOn valve, share authentication between web applications</span><br><span class="line">             Documentation at: /docs/config/valve.html --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.authenticator.SingleSignOn&quot; /&gt;</span><br><span class="line">        --&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- Access log processes all example.</span><br><span class="line">             Documentation at: /docs/config/valve.html</span><br><span class="line">             Note: The pattern used is equivalent to using pattern=&quot;common&quot; --&gt;</span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">               prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;</span><br><span class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/Host&gt;</span><br><span class="line"></span><br><span class="line"># Nginx配置文件</span><br><span class="line">[root@Nginx ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line">    upstream tcsrvs &#123;</span><br><span class="line">        server 192.168.8.12:8080;</span><br><span class="line">        server 192.168.8.15:8080;</span><br><span class="line">    &#125;   </span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line">    sendfile            on; </span><br><span class="line">    tcp_nopush          on; </span><br><span class="line">    tcp_nodelay         on; </span><br><span class="line">    keepalive_timeout   65; </span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  _;  </span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line">        location / &#123; </span><br><span class="line">            proxy_pass http://tcsrvs ;</span><br><span class="line">        &#125;   </span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;   </span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Memcached </category>
          
          <category> tomcat + memcached session manager共享session </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Memcached </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Memcached安装和常用命令</title>
      <link href="/2017/11/09/Memcached-Install-Changyong-Commands/"/>
      <url>/2017/11/09/Memcached-Install-Changyong-Commands/</url>
      <content type="html"><![CDATA[<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>安装通过<code>yum</code>直接安装即可，也可去官网下载源码编译。</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@Memcached1 ~]# yum -y  install memcached</span><br></pre></td></tr></table></figure><h3 id="启动Memcached常用参数"><a href="#启动Memcached常用参数" class="headerlink" title="启动Memcached常用参数"></a>启动Memcached常用参数</h3><ul><li><code>-p &lt;num&gt;</code>      设置TCP端口号(默认设置为: 11211)</li><li><code>-U &lt;num&gt;</code>      UDP监听端口(默认: 11211, 0 时关闭) </li><li><code>-l &lt;ip_addr&gt;</code>  绑定地址(默认:所有都允许,无论内外网或者本机更换IP，有安全隐患，若设置为127.0.0.1就只能本机访问)</li><li><code>-c &lt;num&gt;</code>      max simultaneous connections (default: 1024)</li><li>`-d            以daemon方式运行</li><li><code>-u &lt;username&gt;</code> 绑定使用指定用于运行进程<username></username></li><li><code>-m &lt;num&gt;</code>      允许最大内存用量，单位M (默认: 64 MB)</li><li><code>-P &lt;file&gt;</code>     将PID写入文件<file>，这样可以使得后边进行快速进程终止, 需要与-d 一起使用</file></li></ul><h3 id="连接和退出"><a href="#连接和退出" class="headerlink" title="连接和退出"></a>连接和退出</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@Memcached ~]# service memcached start         # 启动memcached；</span><br><span class="line">Starting memcached:                                        [  OK  ]</span><br><span class="line">[root@Memcached ~]# ss -unl         # 端口已经打开，默认就是UDP 11211；</span><br><span class="line">State       Recv-Q Send-Q                       Local Address:Port                         Peer Address:Port </span><br><span class="line">UNCONN      0      0                                        *:68                                      *:*     </span><br><span class="line">UNCONN      0      0                                        *:11211                                   *:*     </span><br><span class="line">UNCONN      0      0                                       :::11211                                  :::*   </span><br><span class="line"></span><br><span class="line">[root@Memcached ~]# telnet 127.0.0.1 11211      # 连接；</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is &apos;^]&apos;.</span><br><span class="line">quit        # 退出；</span><br><span class="line">Connection closed by foreign host.</span><br></pre></td></tr></table></figure><h3 id="命令行语法"><a href="#命令行语法" class="headerlink" title="命令行语法"></a>命令行语法</h3><p><code>command &lt;key&gt; &lt;flags&gt; &lt;expiration time&gt; &lt;bytes&gt;</code> </p><p><code>&lt;value&gt;</code></p><p>参数说明如下：</p><ul><li><code>command</code>： <code>set/add/replace</code></li><li><code>key</code> key 用于查找缓存值</li><li><code>flags</code>  可以包括键值对的整型参数，客户机使用它存储关于键值对的额外信息</li><li><code>expiration time</code>  在缓存中保存键值对的时间长度（以秒为单位，0 表示永远）</li><li><code>bytes</code>   在缓存中存储的字节点</li><li><code>value</code>   存储的值（始终位于第二行）</li></ul><h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><p>五种基本<code>memcached</code>命令执行最简单的操作。这些命令和操作包括：</p><ul><li><code>set</code>：向缓存添加新的键值对，如果键已经存在，则之前的值将被替换；</li><li><code>add</code>：仅当缓存中不存在键时，<code>add</code>命令才会向缓存中添加一个键值对。如果缓存中已经存在键，则之前的值将仍然保持相同，并且您将获得响应 <code>NOT_STORED</code>;</li><li><code>replace</code>：仅当键已经存在时，<code>replace</code> 命令才会替换缓存中的键。如果缓存中不存在键，那么您将从 <code>memcached</code> 服务器接受到一条 <code>NOT_STORED</code> 响应;</li><li><code>get</code>：用于检索与之前添加的键值对相关的值。您将使用 <code>get</code> 执行大多数检索操作;</li><li><code>delete</code>：用于删除 memcached 中的任何现有值；</li></ul><h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><p><code>set</code>命令用于向缓存添加新的键值对。如果键已经存在，则之前的值将被替换。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@Memcached ~]# !t</span><br><span class="line">telnet 127.0.0.1 11211</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is &apos;^]&apos;.</span><br><span class="line">set userID 0 0 5 </span><br><span class="line">12345</span><br><span class="line">STORED</span><br></pre></td></tr></table></figure><p>如果使用 <code>set</code> 命令正确设定了键值对，服务器将使用单词 <code>STORED</code> 进行响应。本示例向缓存中添加了一个键值对，其键为<code>userId</code>，其值为<code>12345</code>。并将过期时间设置为 <code>0</code>，这将向 <code>memcached</code> 通知您希望将此值存储在缓存中直到删除它为止。</p><h4 id="add"><a href="#add" class="headerlink" title="add"></a>add</h4><p>仅当缓存中不存在键时，<code>add</code> 命令才会向缓存中添加一个键值对。如果缓存中已经存在键，则之前的值将仍然保持相同，并且您将获得响应 <code>NOT_STORED</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add userID 0 0 5   </span><br><span class="line">55555</span><br><span class="line">NOT_STORED</span><br><span class="line">add UID 0 0 3</span><br><span class="line">123</span><br><span class="line">STORED</span><br></pre></td></tr></table></figure><h4 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h4><p>仅当键已经存在时，<code>replace</code> 命令才会替换缓存中的键。如果缓存中不存在键，那么您将从 <code>memcached</code> 服务器接受到一条 <code>NOT_STORED</code> 响应。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">replace accountID 0 0 5 </span><br><span class="line">67890</span><br><span class="line">NOT_STORED</span><br><span class="line">set accountID 0 0 5 </span><br><span class="line">67890</span><br><span class="line">STORED</span><br><span class="line">replace accountID 0 0 5</span><br><span class="line">66666</span><br><span class="line">STORED</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><p><code>get</code> 命令用于检索与之前添加的键值对相关的值。您将使用 <code>get</code> 执行大多数检索操作。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">set userID 0 0 5</span><br><span class="line">12345</span><br><span class="line">STORED</span><br><span class="line">get userID</span><br><span class="line">VALUE userID 0 5</span><br><span class="line">12345</span><br><span class="line">END</span><br><span class="line">get abc</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>如您所见，<code>get</code> 命令相当简单。您使用一个键来调用 <code>get</code>，如果这个键存在于缓存中，则返回相应的值。如果不存在，则不返回任何内容。</p><h4 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h4><p><code>delete</code> 命令用于删除 <code>memcached</code> 中的任何现有值。您将使用一个键调用<code>delete</code>，如果该键存在于缓存中，则删除该值。如果不存在，则返回一条<code>NOT_FOUND</code> 消息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">set userID 0 0 5</span><br><span class="line">12345</span><br><span class="line">STORED</span><br><span class="line">delete bob</span><br><span class="line">NOT_FOUND</span><br><span class="line">delete userID</span><br><span class="line">DELETED</span><br><span class="line">get userID</span><br><span class="line">END</span><br></pre></td></tr></table></figure><h4 id="gets"><a href="#gets" class="headerlink" title="gets"></a>gets</h4><p><code>gets</code> 命令的功能类似于基本的<code>get</code> 命令。两个命令之间的差异在于，<code>gets</code> 返回的信息稍微多一些：<code>64</code> 位的整型值非常像名称/值对的 “<code>版本</code>” 标识符。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">set userID 0 0 5</span><br><span class="line">12345</span><br><span class="line">STORED</span><br><span class="line">get userID</span><br><span class="line">VALUE userID 0 5</span><br><span class="line">12345</span><br><span class="line">END</span><br><span class="line">gets userID</span><br><span class="line">VALUE userID 0 5 7</span><br><span class="line">12345</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>考虑 <code>get</code> 和 <code>gets</code> 命令之间的差异。<code>gets</code> 命令将返回一个额外的值 — 在本例中是整型值 7，用于标识名称/值对。如果对此名称/值对执行另一个<code>set</code> 命令，则<code>gets</code> 返回的额外值将会发生更改，以表明名称/值对已经被更新。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set userId 0 0 5</span><br><span class="line">33333</span><br><span class="line">STORED</span><br><span class="line">gets userId  </span><br><span class="line">VALUE userId 0 5 8</span><br><span class="line">33333</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>您看到 <code>gets</code> 返回的值了吗？它已经更新为 8。您每次修改名称/值对时，该值都会发生更改。</p><h4 id="缓存管理命令"><a href="#缓存管理命令" class="headerlink" title="缓存管理命令"></a>缓存管理命令</h4><p>最后两个 <code>memcached</code> 命令用于监控和清理 <code>memcached</code> 实例。它们是 <code>stats</code> 和 <code>flush_all</code> 命令。</p><h5 id="stats"><a href="#stats" class="headerlink" title="stats"></a>stats</h5><p><code>stats</code> 命令的功能正如其名：转储所连接的 <code>memcached</code> 实例的当前统计数据。在下例中，执行 <code>stats</code> 命令显示了关于当前 <code>memcached</code> 实例的信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">stats</span><br><span class="line">STAT pid 11019                  # 进程ID</span><br><span class="line">STAT uptime 192                 # 服务器运行秒数</span><br><span class="line">STAT time 1510214121            # 服务器当前unix时间戳</span><br><span class="line">STAT version 1.4.4              # 服务器版本</span><br><span class="line">STAT pointer_size 64            # 操作系统64位的</span><br><span class="line">STAT rusage_user 0.000000       # 进程累计用户时间</span><br><span class="line">STAT rusage_system 0.012998     # 当前累计系统时间</span><br><span class="line">STAT curr_connections 10        # 当前打开连接数</span><br><span class="line">STAT total_connections 12       # 曾打开的连接总数</span><br><span class="line">STAT connection_structures 11   # 服务器分配的连接结构数</span><br><span class="line">STAT cmd_get 54                 # 执行get命令总数</span><br><span class="line">STAT cmd_set 34                 # 执行set命令总数</span><br><span class="line">STAT cmd_flush 3                # 指向flush_all命令总数</span><br><span class="line">STAT get_hits 9                 # get命中次数</span><br><span class="line">STAT get_misses 45              # get未命中次数</span><br><span class="line">STAT delete_misses 5            # delete未命中次数</span><br><span class="line">STAT delete_hits 1              # delete命中次数</span><br><span class="line">STAT incr_misses 0              # incr未命中次数</span><br><span class="line">STAT incr_hits 0                # incr命中次数</span><br><span class="line">STAT decr_misses 0              # decr未命中次数</span><br><span class="line">STAT decr_hits 0                # decr命中次数</span><br><span class="line">STAT cas_misses 0               # cas未命中次数</span><br><span class="line">STAT cas_hits 0                 # cas命中次数</span><br><span class="line">STAT cas_badval 0               # 使用擦拭次数</span><br><span class="line">STAT auth_cmds 0                    </span><br><span class="line">STAT auth_errors 0                  </span><br><span class="line">STAT bytes_read 86              # 读入字节总数              </span><br><span class="line">STAT bytes_written 55           # 写入字节总数</span><br><span class="line">STAT limit_maxbytes 67108864    # 分配的内存数（字节）                </span><br><span class="line">STAT accepting_conns 1          # 目前接受的连接数        </span><br><span class="line">STAT listen_disabled_num 0                  </span><br><span class="line">STAT threads 4                  # 线程数            </span><br><span class="line">STAT conn_yields 0                  </span><br><span class="line">STAT bytes 76                   # 存储item字节数</span><br><span class="line">STAT curr_items 1               # item个数    </span><br><span class="line">STAT total_items 1              # item总数    </span><br><span class="line">STAT evictions 0                # 为获取空间删除item的总数</span><br><span class="line">END</span><br></pre></td></tr></table></figure></p><h5 id="stats-slabs"><a href="#stats-slabs" class="headerlink" title="stats slabs"></a>stats slabs</h5><p><code>stats slabs</code> 显示各个<code>slab</code>的信息，包括<code>chunk</code>的大小、数目、使用情况等</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">stats slabs</span><br><span class="line">STAT 1:chunk_size 96</span><br><span class="line">STAT 1:chunks_per_page 10922</span><br><span class="line">STAT 1:total_pages 1</span><br><span class="line">STAT 1:total_chunks 10922</span><br><span class="line">STAT 1:used_chunks 1</span><br><span class="line">STAT 1:free_chunks 1</span><br><span class="line">STAT 1:free_chunks_end 10920</span><br><span class="line">STAT 1:mem_requested 76</span><br><span class="line">STAT 1:get_hits 1</span><br><span class="line">STAT 1:cmd_set 2</span><br><span class="line">STAT 1:delete_hits 0</span><br><span class="line">STAT 1:incr_hits 0</span><br><span class="line">STAT 1:decr_hits 0</span><br><span class="line">STAT 1:cas_hits 0</span><br><span class="line">STAT 1:cas_badval 1</span><br><span class="line">STAT active_slabs 1</span><br><span class="line">STAT total_malloced 1048512</span><br><span class="line">END</span><br></pre></td></tr></table></figure><h5 id="stats-sizes"><a href="#stats-sizes" class="headerlink" title="stats sizes"></a>stats sizes</h5><p><code>stats sizes</code> 输出所有<code>item</code>的大小和个数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stats sizes</span><br><span class="line">STAT 96 1</span><br><span class="line">END</span><br></pre></td></tr></table></figure><h5 id="stats-reset"><a href="#stats-reset" class="headerlink" title="stats reset"></a>stats reset</h5><p><code>stats reset</code> 清空统计数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stats reset</span><br><span class="line">RESET</span><br></pre></td></tr></table></figure><h4 id="flush-all"><a href="#flush-all" class="headerlink" title="flush_all"></a>flush_all</h4><p>这个最简单的命令仅用于清理缓存中的所有名称/值对。如果您需要将缓存重置到干净的状态，则 <code>flush_all</code> 能提供很大的用处。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">set userid 0 0 5</span><br><span class="line">12345</span><br><span class="line">STORED</span><br><span class="line">set id 0 0 3</span><br><span class="line">345</span><br><span class="line">STORED</span><br><span class="line">get userid</span><br><span class="line">VALUE userid 0 5</span><br><span class="line">12345</span><br><span class="line">END</span><br><span class="line">get id</span><br><span class="line">VALUE id 0 3</span><br><span class="line">345</span><br><span class="line">END</span><br><span class="line">flush_all</span><br><span class="line">OK</span><br><span class="line">get id</span><br><span class="line">END</span><br><span class="line">get userid</span><br><span class="line">END</span><br></pre></td></tr></table></figure><h4 id="append"><a href="#append" class="headerlink" title="append"></a>append</h4><p><code>append</code> 将数据追加到当前缓存数据的之后，当缓存数据存在时才存储。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">set username 0 0 8</span><br><span class="line">wang1234</span><br><span class="line">STORED</span><br><span class="line">get username</span><br><span class="line">VALUE username 0 8</span><br><span class="line">wang1234</span><br><span class="line">END</span><br><span class="line">append username 0 0 5</span><br><span class="line">_ages</span><br><span class="line">STORED</span><br><span class="line">get username</span><br><span class="line">VALUE username 0 13</span><br><span class="line">wang1234_ages</span><br><span class="line">END</span><br></pre></td></tr></table></figure><h4 id="prepend"><a href="#prepend" class="headerlink" title="prepend"></a>prepend</h4><p><code>prepend</code> 将数据追加到当前缓存数据的之前，当缓存数据存在时才存储。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">set username 0 0 8</span><br><span class="line">wang1234</span><br><span class="line">STORED</span><br><span class="line">get username</span><br><span class="line">VALUE username 0 8</span><br><span class="line">wang1234</span><br><span class="line">END</span><br><span class="line">prepend username 0 0 5</span><br><span class="line">name_</span><br><span class="line">STORED</span><br><span class="line">get username</span><br><span class="line">VALUE username 0 13</span><br><span class="line">name_wang1234</span><br><span class="line">END</span><br></pre></td></tr></table></figure><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://www.cnblogs.com/wayne173/p/5652034.html" target="_blank" rel="noopener">達達尼亞：memcached 常用命令及使用说明</a></p>]]></content>
      
      <categories>
          
          <category> Memcached </category>
          
          <category> Memcached安装和常用命令 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Memcached </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Memcached</title>
      <link href="/2017/11/09/Memcached/"/>
      <url>/2017/11/09/Memcached/</url>
      <content type="html"><![CDATA[<center><img src="https://houhaiyun.github.io/img/images/Memcached-1.jpg" title="Memcached"></center><a id="more"></a><h3 id="Memcached"><a href="#Memcached" class="headerlink" title="Memcached"></a>Memcached</h3><ul><li><code>Memcached</code>是以<code>LiveJournal</code>旗下<code>Danga Interactive</code>公司的<code>Brad Fitzpatric</code>为首开发的一款软件。</li><li>免费和开放源代码的高性能分布式内存对象缓存系统，本质上是通用的，但旨在通过减轻数据库负载来加速动态<code>Web</code>应用程序。</li><li><code>Memcached</code>是内存中的键值存储，用于从数据库调用，<code>API</code>调用或页面呈现的结果中为小块任意数据（字符串，对象）。</li><li><code>Memcached</code>简单而强大。其简单的设计促进了快速部署，易于开发，并解决了大数据缓存面临的许多问题。它的<code>API</code>适用于大多数流行的语言。</li><li>其守护进程（<code>daemon</code> ）是用<code>C</code>写的，但是客户端可以用任何语言来编写，并通过<code>memcached</code>协议与守护进程通信。</li><li>Memcached官网：<a href="http://memcached.org/" target="_blank" rel="noopener">http://memcached.org/</a></li></ul><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ol><li>重启<code>memcached</code>服务器或者操作系统会使数据消失。</li><li>内存容量达到指定值之后，就会使用<code>LRU</code>算法自动删除不使用或者很少使用的缓存。</li></ol><h3 id="Memcached的工作过程"><a href="#Memcached的工作过程" class="headerlink" title="Memcached的工作过程"></a>Memcached的工作过程</h3><p><code>Memcached</code>是一种<code>C/S</code>模式，在服务器端启动服务守护进程，此时可以指定监听的<code>IP</code>地址、端口号以及使用多少内存来处理客户端的请求等几个关键参数。服务器端的服务启动后就一直处于等待处理客户端的连接状态。<code>Memcached</code> 是由<code>C</code>语言来实现的，采用的是<strong>异步<code>I/O</code></strong>，其实现方式是基于事件的单进程和单线程的。使用 <strong><code>libevent</code> 作为事件通知机制</strong> ，多个服务器端可以协同工作，但这些服务器端之间没有任何通信关系，每个服务器端只对自己的数据进行管理。客户端通过指定服务器的IP地址和端口进行通信。</p><p>需要被缓存的对象或数据以 <strong><code>key/value</code>对</strong> 的形式保存在服务器端，每个被缓存的对象或数据都有唯一的标识符key，存取操作通过这个key 进行。保存到 <code>Memcached</code> 中的对象或数据放置在内存中，并不会作为文件存储在磁盘上，所以存取速度非常快。由于没有对这些对象进行持久性存储，因此在服务器端的服务重启之后存储在内存中的这些数据就会消失。而且当存储的容量达到启动时设定的值时，就自动使用 <strong><code>LRU</code>算法</strong> 删除不用的缓存。<code>Memcached</code>是为缓存而设计的服务器，因此在设计之初并没有过多考虑数据的永久性问题。<code>Memcached</code> <strong>支持各种语言编写的客户端<code>API</code></strong> ，目前包括 Perl、PHP、Python、Ruby、Java、C#和C等。</p><p><a href="https://yq.aliyun.com/articles/174199#" target="_blank" rel="noopener">本节书摘来自华章社区《高性能Linux服务器构建实战》一书中的第3章，第3.2节剖析Memcached的工作原理，作者：高俊峰</a></p><h3 id="Slab-Allocation的工作机制"><a href="#Slab-Allocation的工作机制" class="headerlink" title="Slab Allocation的工作机制"></a>Slab Allocation的工作机制</h3><p> <strong><code>Memcached</code>利用<code>Slab Allocation</code>机制来分配和管理内存</strong> 。传统的内存管理方式是：使用完通过<code>malloc</code>分配的内存后通过<code>free</code>来回收内存。这种方式容易产生内存碎片并降低操作系统对内存的管理效率。<code>Slab Allocation</code>机制不存在这样的问题，它按照预先规定的大小，将分配的内存分割成特定长度的内存块，再把尺寸相同的内存块分成组，这些内存块不会释放，可以重复利用。</p><p><code>Memcached</code>服务器端保存着一个空闲的内存块列表，当有数据存入时根据接收到的数据大小，分配一个能存下这个数据的最小内存块。这种方式有时会造成内存浪费，例如：将一个200字节的数据存入一个300字节的内存块中，会有100字节内存被浪费掉，不能使用。避免浪费内存的办法是，预先计算出应用存入的数据大小，或把同一业务类型的数据存入一个<code>Memcached</code>服务器中，确保存入的数据大小相对均匀，这样就可以减少对内存的浪费。还有一种办法是，在启动时指定“-f”参数，能在某种程度上控制内存组之间的大小差异。在应用中使用Memcached时，通常可以不重新设置这个参数，使用默认值1.25进行部署。如果想优化<code>Memcached</code>对内存的使用，可以考虑重新计算数据的预期平均长度，调整这个参数来获得合适的设置值。</p><p><a href="https://yq.aliyun.com/articles/174199#" target="_blank" rel="noopener">本节书摘来自华章社区《高性能Linux服务器构建实战》一书中的第3章，第3.2节剖析Memcached的工作原理，作者：高俊峰</a></p><h3 id="Memcached的删除机制"><a href="#Memcached的删除机制" class="headerlink" title="Memcached的删除机制"></a>Memcached的删除机制</h3><p>上一节已经介绍过，<code>Memcached</code>不会释放已分配的内存空间，在数据过期后，客户端不能通过<code>key</code>取出它的值，其存储空间被重新利用。</p><p><code>Memcached</code>使用的是一种<code>Lazy Expiration</code>策略，自己不会监控存入的<code>key/value</code>对是否过期，而是在获取<code>key</code>值时查看记录的时间戳，检查<code>key/value</code>对空间是否过期。这种策略不会在过期检测上浪费<code>CPU</code>资源。<br><code>Memcached</code>在分配空间时，优先使用已经过期的<code>key/value</code>对空间，当空间占满时，<code>Memcached</code>就会使用<code>LRU</code>算法来分配空间，删除最近最少使用的<code>key/value</code>对，将其空间分配给新的<code>key/value</code>对。在某些情况下，如果不想使用LRU算法，那么可以通过<code>“-M”</code>参数来启动<code>Memcached</code>，这样，<code>Memcached</code>在内存耗尽时，会返回一个报错信息。</p><p><a href="https://yq.aliyun.com/articles/174199#" target="_blank" rel="noopener">本节书摘来自华章社区《高性能Linux服务器构建实战》一书中的第3章，第3.2节剖析Memcached的工作原理，作者：高俊峰</a></p><h3 id="Memcached的分布式算法"><a href="#Memcached的分布式算法" class="headerlink" title="Memcached的分布式算法"></a>Memcached的分布式算法</h3><p>前面已经介绍过，Memcached的分布式是通过客户端的程序库来实现的。下面举例描述其工作过程。<br>假设有node1、node2、node2三台Memcached服务器，应用程序要实现保存名为“tokyo”、“ tokyo1”、“ tokyo2”、“ tokyo3”的数据，如图3-2所示。</p><center><img src="https://houhaiyun.github.io/img/images/Memcached-2.png" title="有node1、node2、node2三台Memcached服务器，应用程序要实现保存名为“tokyo”、“ tokyo1”、“ tokyo2”、“ tokyo3”的数据"></center><p>向Memcached中存入“tokyo”，将“tokyo”传给客户端程序后，客户端实现的算法就会根据这个“键”来决定保存数据的Memcached服务器，选定服务器后，就命令该服务器保存“tokyo”及其值，如图3-3所示。<br>同样，存入“tokyo1”、“ tokyo2”和“ tokyo3”的过程都是先通过客户端的算法选择服务器再保存数据。<br>接下来获取保存的数据。获取保存的key/value对时也要将要获取的键“tokyo”传递给函数库。函数库通过与存取数据操作相同的算法，根据“键”来选择服务器。只要使用的算法相同，就能确定存入在哪一台服务器上，然后发送get命令。只要数据没有因为某些原因被删除，就能获得保存的值，如图3-4所示。</p><center><img src="https://houhaiyun.github.io/img/images/Memcached-3.png" title="3-4"></center><p>将不同的键保存到不同的服务器上，就实现了Memcached的分布式算法。部署多台Memcached服务器时，将键分散保存到这些服务器上，当某一台Memcached服务器发生故障无法连接时，只有分散到这台服务器上的key/values对不能访问，其他key/value对不受影响。</p><p>目前有两种分布式算法使用得最多，一种是根据余数来计算分布，另一种是根据一致性散列算法来计算分布。根据余数分布式算法先求得键的整数散列值，再除以服务器台数，根据余数来选择将键存放到哪一台服务器上。这种方法虽然计算简单，效率很高，但在服务器增加或减少时，会导致几乎所有的缓存失效，所以在大规模部署中，很少使用这种方法。一致性散列的原理如图3-5所示，先算出Memcached服务器（节点）的散列值，并将其分散到0到2的32次方的圆上，然后用同样的方法算出存储数据的键的散列值并映射到圆上，最后从数据映射到的位置开始顺时针查找，将数据保存到查找到的第一个服务器上。如果超过232仍然找不到服务器，就会将数据保存到第一台Memcached服务器上。</p><center><img src="https://houhaiyun.github.io/img/images/Memcached-4.png" title="两种分布式算法"></center><p>当需要添加一台Memcached服务器时，由于保存键的服务器的个数发生了变化，因此余数分布式算法的余数结果也会发生巨大变化，几乎所有的键都找不到之前存入的服务器，导致所有的缓存失效。但在采用一致性散列算法时，添加服务器后，只有在圆上增加服务器地点的逆时针方向的第一台服务器上的键会受到影响，如图3-6所示。<br>一致性散列算法对数据的存储是不均匀的，但可以最大限度地减少缓存的失效量。在大规模部署Memcached时，容灾和扩容一定要使用一致性散列算法，以确保在出现故障或容量问题时减小对数据库的影响。</p><center><img src="https://houhaiyun.github.io/img/images/Memcached-5.png" title="3-6"></center><p><a href="https://yq.aliyun.com/articles/174199#" target="_blank" rel="noopener">本节书摘来自华章社区《高性能Linux服务器构建实战》一书中的第3章，第3.2节剖析Memcached的工作原理，作者：高俊峰</a></p>]]></content>
      
      <categories>
          
          <category> Memcached </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Memcached </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>搭建Tomcat会话集群</title>
      <link href="/2017/11/08/Tomcat-Session-Jiqun-2017-11-07/"/>
      <url>/2017/11/08/Tomcat-Session-Jiqun-2017-11-07/</url>
      <content type="html"><![CDATA[<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Httpd%E5%9F%BA%E4%BA%8Ehttp%E5%8D%8F%E8%AE%AE%E8%B0%83%E5%BA%A6Tomcat%E9%9B%86%E7%BE%A4.jpg"></center><br><center> 拓扑</center><table><thead><tr><th>服务</th><th>IP</th><th>系统版本</th><th>软件版本</th><th>功能</th></tr></thead><tbody><tr><td>Httpd</td><td>192.168.8.17/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>httpd.x86_64 0:2.4.6-45</td><td>反向代理</td></tr><tr><td>Tomcat1</td><td>192.168.8.12/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>tomcat-7.0.69(java-1.8.0-openjdk)</td><td>应用服务</td></tr><tr><td>Tomcat2</td><td>192.168.8.15/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>tomcat-7.0.69(java-1.8.0-openjdk)</td><td>应用服务</td></tr></tbody></table><a id="more"></a><h4 id="1-修改主机名，并写入hosts文件"><a href="#1-修改主机名，并写入hosts文件" class="headerlink" title="1. 修改主机名，并写入hosts文件"></a>1. 修改主机名，并写入hosts文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># 修改Httpd server 主机名；</span><br><span class="line">[root@centos6 ~]# hostname Httpd.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Httpd ~]# </span><br><span class="line">[root@Httpd ~]# vim /etc/hosts      # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Httpd.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Httpd.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改Tomccat1 server 主机名；</span><br><span class="line">[root@centos7 ~]# hostname Tomcat1.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Tomcat1 ~]# </span><br><span class="line">[root@Tomcat1 ~]# vim /etc/hosts        # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Tomcat1.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Httpd.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改Tomccat2 server 主机名；</span><br><span class="line">[root@centos7 ~]# hostname Tomcat2.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Tomcat2 ~]# </span><br><span class="line">[root@Tomcat2 ~]# vim /etc/hosts            # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Tomcat2.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Httpd.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line">[root@Httpd ~]# ping -c 1 Httpd.haiyun.com          # 测试是否能够解析成功，ok；</span><br><span class="line">PING localhost (127.0.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from localhost (127.0.0.1): icmp_seq=1 ttl=64 time=0.010 ms</span><br><span class="line"></span><br><span class="line">--- localhost ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.010/0.010/0.010/0.000 ms</span><br><span class="line">[root@Httpd ~]# ping -c 1 Tomcat1.haiyun.com</span><br><span class="line">PING Tomcat1.haiyun.com (192.168.8.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from Tomcat1.haiyun.com (192.168.8.12): icmp_seq=1 ttl=64 time=1.83 ms</span><br><span class="line"></span><br><span class="line">--- Tomcat1.haiyun.com ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 2ms</span><br><span class="line">rtt min/avg/max/mdev = 1.835/1.835/1.835/0.000 ms</span><br><span class="line">[root@Httpd ~]# ping -c 1 Tomcat2.haiyun.com</span><br><span class="line">PING Tomcat2.haiyun.com (192.168.8.15) 56(84) bytes of data.</span><br><span class="line">64 bytes from Tomcat2.haiyun.com (192.168.8.15): icmp_seq=1 ttl=64 time=1.94 ms</span><br><span class="line"></span><br><span class="line">--- Tomcat2.haiyun.com ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 2ms</span><br><span class="line">rtt min/avg/max/mdev = 1.940/1.940/1.940/0.000 ms</span><br></pre></td></tr></table></figure><h4 id="2-同步所有server的时间"><a href="#2-同步所有server的时间" class="headerlink" title="2. 同步所有server的时间"></a>2. 同步所有server的时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Httpd server</span><br><span class="line">[root@Httpd ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:36 ntpdate[11037]: adjust time server 172.18.0.1 offset -0.000054 sec</span><br><span class="line">[root@Httpd ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br><span class="line"></span><br><span class="line"># Tomcat1 server</span><br><span class="line">[root@Tomcat1 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:42 ntpdate[3153]: adjust time server 172.18.0.1 offset 0.000261 sec</span><br><span class="line">[root@Tomcat1 ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br><span class="line"></span><br><span class="line"># Tomcat2 server</span><br><span class="line">[root@Tomcat2 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:42 ntpdate[11255]: adjust time server 172.18.0.1 offset 0.332502 sec</span><br><span class="line">[root@Tomcat2 ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br></pre></td></tr></table></figure><h3 id="为两台后端server安装Tomcat软件"><a href="#为两台后端server安装Tomcat软件" class="headerlink" title="为两台后端server安装Tomcat软件"></a>为两台后端server安装Tomcat软件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# yum -y install java-1.8.0-openjdk-devel tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# yum -y install java-1.8.0-openjdk-devel tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br></pre></td></tr></table></figure><h3 id="为两台Tomcat设置默认访问主页"><a href="#为两台Tomcat设置默认访问主页" class="headerlink" title="为两台Tomcat设置默认访问主页"></a>为两台Tomcat设置默认访问主页</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# mkdir -pv /usr/share/tomcat/webapps/myapp/WEB-INF</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp’</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp/WEB-INF’</span><br><span class="line">[root@Tomcat1 ~]# vim /usr/share/tomcat/webapps/myapp/index.jsp     # 创建默认主页；</span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;&lt;title&gt;Tomcat1&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;&lt;font color=&quot;red&quot;&gt;Tomcat1.ihaiyun.cc&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(&quot;ihaiyun.cc&quot;,&quot;magedu.com&quot;); %&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Tomcat1 ~]# systemctl start tomcat.service        # 启动Tomcat服务；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# mkdir -pv /usr/share/tomcat/webapps/myapp/WEB-INF</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp’</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp/WEB-INF’</span><br><span class="line">[root@Tomcat2 ~]# vim /usr/share/tomcat/webapps/myapp/index.jsp     # 创建默认主页；</span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;&lt;title&gt;Tomcat2&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;&lt;font color=&quot;blue&quot;&gt;Tomcat2.ihaiyun.cc&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(&quot;ihaiyun.cc&quot;,&quot;magedu.com&quot;); %&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Tomcat2 ~]# systemctl start tomcat.service        # 启动Tomcat服务；</span><br></pre></td></tr></table></figure><h4 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h4><p><strong>注意：</strong><code>Tomcat1</code>为红色，<code>Tomcat2</code>为蓝色。</p><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Nginx%E8%B0%83%E5%BA%A6Tomcat%E9%9B%86%E7%BE%A41.gif"></center><h3 id="安装Httpd并配置调度"><a href="#安装Httpd并配置调度" class="headerlink" title="安装Httpd并配置调度"></a>安装Httpd并配置调度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@Httpd ~]# yum -y install httpd        # 安装httpd；</span><br><span class="line">[root@Httpd ~]# vim /etc/httpd/conf.d/httpd.conf            # 添加配置文件；</span><br><span class="line">&lt;proxy balancer://tcsrvs&gt;</span><br><span class="line">    BalancerMember http://192.168.8.12:8080</span><br><span class="line">    BalancerMember http://192.168.8.15:8080</span><br><span class="line">    ProxySet lbmethod=byrequests</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName httpd.ihaiyun.cc</span><br><span class="line">    ProxyVia On</span><br><span class="line">    ProxyRequests Off </span><br><span class="line">    ProxyPreserveHost On</span><br><span class="line">    &lt;Proxy *&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Proxy&gt;</span><br><span class="line">    ProxyPass / balancer://tcsrvs/</span><br><span class="line">    ProxyPassReverse / balancer://tcsrvs/</span><br><span class="line">    &lt;Location /&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">[root@Httpd ~]# systemctl start httpd</span><br></pre></td></tr></table></figure><h3 id="访问测试-1"><a href="#访问测试-1" class="headerlink" title="访问测试"></a>访问测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@Httpd ~]# for i in &#123;1..4&#125; ; do elinks -dump http://192.168.8.17/myapp/ ; done     # 访问测试，ok；</span><br><span class="line">                               Tomcat1.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | CB54B841B411BD39AC206E5C21A94D2D |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510055671410                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 5AE73728906E1B832CFABA7DBAB44F62 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510055671678                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat1.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 3223618E201BC73DCB053C52BD2972F2 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510055671494                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 6DE3ECA59EDB7EB71ECCFBDD47443F4A |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510055671758                    |</span><br><span class="line">   +-----------------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="修改tomcat配置文件"><a href="#修改tomcat配置文件" class="headerlink" title="修改tomcat配置文件"></a>修改tomcat配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"># 修改tomcat1的配置文件</span><br><span class="line">[root@Tomcat1 ~]# vim /etc/tomcat/server.xml </span><br><span class="line">    &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot; jvmRoute=&quot;Tomcat1&quot;&gt;     # 标识ID；</span><br><span class="line">    &lt;Cluster className=&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span><br><span class="line">            channelSendOptions=&quot;8&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Manager className=&quot;org.apache.catalina.ha.session.DeltaManager&quot;</span><br><span class="line">            expireSessionsOnShutdown=&quot;false&quot;</span><br><span class="line">            notifyListenersOnReplication=&quot;true&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Channel className=&quot;org.apache.catalina.tribes.group.GroupChannel&quot;&gt;</span><br><span class="line">        &lt;Membership className=&quot;org.apache.catalina.tribes.membership.McastService&quot;</span><br><span class="line">                address=&quot;228.0.8.4&quot;         # 组播地址，自定义需要和tomcat集群中的主机相同；</span><br><span class="line">                port=&quot;45564&quot;</span><br><span class="line">                frequency=&quot;500&quot;</span><br><span class="line">                dropTime=&quot;3000&quot;/&gt;</span><br><span class="line">        &lt;Receiver className=&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span><br><span class="line">            address=&quot;192.168.8.12&quot;          # 本tomcat的IP；</span><br><span class="line">            port=&quot;4000&quot;</span><br><span class="line">            autoBind=&quot;100&quot;</span><br><span class="line">            selectorTimeout=&quot;5000&quot;</span><br><span class="line">            maxThreads=&quot;6&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Sender className=&quot;org.apache.catalina.tribes.transport.ReplicationTransmitter&quot;&gt;</span><br><span class="line">        &lt;Transport className=&quot;org.apache.catalina.tribes.transport.nio.PooledParallelSender&quot;/&gt;</span><br><span class="line">        &lt;/Sender&gt;</span><br><span class="line">        &lt;Interceptor className=&quot;org.apache.catalina.tribes.group.interceptors.TcpFailureDetector&quot;/&gt;</span><br><span class="line">        &lt;Interceptor className=&quot;org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor&quot;/&gt;</span><br><span class="line">        &lt;/Channel&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.ha.tcp.ReplicationValve&quot;</span><br><span class="line">            filter=&quot;&quot;/&gt;</span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.ha.session.JvmRouteBinderValve&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Deployer className=&quot;org.apache.catalina.ha.deploy.FarmWarDeployer&quot;</span><br><span class="line">            tempDir=&quot;/tmp/war-temp/&quot;</span><br><span class="line">            deployDir=&quot;/tmp/war-deploy/&quot;</span><br><span class="line">            watchDir=&quot;/tmp/war-listen/&quot;</span><br><span class="line">            watchEnabled=&quot;false&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;ClusterListener className=&quot;org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener&quot;/&gt;</span><br><span class="line">        &lt;ClusterListener className=&quot;org.apache.catalina.ha.session.ClusterSessionListener&quot;/&gt;</span><br><span class="line">        &lt;/Cluster&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改tomcat2的配置文件</span><br><span class="line">[root@Tomcat2 ~]# vim /etc/tomcat/server.xml </span><br><span class="line">    &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot; jvmRoute=&quot;Tomcat2&quot;&gt;     # 标识ID；</span><br><span class="line">    &lt;Cluster className=&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;</span><br><span class="line">            channelSendOptions=&quot;8&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Manager className=&quot;org.apache.catalina.ha.session.DeltaManager&quot;</span><br><span class="line">            expireSessionsOnShutdown=&quot;false&quot;</span><br><span class="line">            notifyListenersOnReplication=&quot;true&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Channel className=&quot;org.apache.catalina.tribes.group.GroupChannel&quot;&gt;</span><br><span class="line">        &lt;Membership className=&quot;org.apache.catalina.tribes.membership.McastService&quot;</span><br><span class="line">                address=&quot;228.0.8.4&quot;             # 组播地址，自定义需要和tomcat集群中的主机相同；</span><br><span class="line">                port=&quot;45564&quot;</span><br><span class="line">                frequency=&quot;500&quot;</span><br><span class="line">                dropTime=&quot;3000&quot;/&gt;</span><br><span class="line">        &lt;Receiver className=&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;</span><br><span class="line">            address=&quot;192.168.8.15&quot;          # 本tomcat的IP；</span><br><span class="line">            port=&quot;4000&quot;</span><br><span class="line">            autoBind=&quot;100&quot;</span><br><span class="line">            selectorTimeout=&quot;5000&quot;</span><br><span class="line">            maxThreads=&quot;6&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Sender className=&quot;org.apache.catalina.tribes.transport.ReplicationTransmitter&quot;&gt;</span><br><span class="line">        &lt;Transport className=&quot;org.apache.catalina.tribes.transport.nio.PooledParallelSender&quot;/&gt;</span><br><span class="line">        &lt;/Sender&gt;</span><br><span class="line">        &lt;Interceptor className=&quot;org.apache.catalina.tribes.group.interceptors.TcpFailureDetector&quot;/&gt;</span><br><span class="line">        &lt;Interceptor className=&quot;org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor&quot;/&gt;</span><br><span class="line">        &lt;/Channel&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.ha.tcp.ReplicationValve&quot;</span><br><span class="line">            filter=&quot;&quot;/&gt;</span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.ha.session.JvmRouteBinderValve&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Deployer className=&quot;org.apache.catalina.ha.deploy.FarmWarDeployer&quot;</span><br><span class="line">            tempDir=&quot;/tmp/war-temp/&quot;</span><br><span class="line">            deployDir=&quot;/tmp/war-deploy/&quot;</span><br><span class="line">            watchDir=&quot;/tmp/war-listen/&quot;</span><br><span class="line">            watchEnabled=&quot;false&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;ClusterListener className=&quot;org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener&quot;/&gt;</span><br><span class="line">        &lt;ClusterListener className=&quot;org.apache.catalina.ha.session.ClusterSessionListener&quot;/&gt;</span><br><span class="line">        &lt;/Cluster&gt;</span><br></pre></td></tr></table></figure><h3 id="为tomcat准备web-xml"><a href="#为tomcat准备web-xml" class="headerlink" title="为tomcat准备web.xml"></a>为tomcat准备web.xml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># tomcat1复制；</span><br><span class="line">[root@Tomcat1 ~]# cp /etc/tomcat/web.xml /usr/share/tomcat/webapps/myapp/WEB-INF/</span><br><span class="line">[root@Tomcat1 ~]# vim /usr/share/tomcat/webapps/myapp/WEB-INF/web.xml</span><br><span class="line">&lt;distributable/&gt;</span><br><span class="line">[root@Tomcat1 ~]# systemctl restart tomcat          # 重启tomcat1；</span><br><span class="line"></span><br><span class="line"># tomcat2复制；</span><br><span class="line">[root@Tomcat2 ~]# cp /etc/tomcat/web.xml /usr/share/tomcat/webapps/myapp/WEB-INF/</span><br><span class="line">[root@Tomcat2 ~]# vim /usr/share/tomcat/webapps/myapp/WEB-INF/web.xml</span><br><span class="line">&lt;distributable/&gt;</span><br><span class="line">[root@Tomcat2 ~]#  systemctl restart tomcat         # 重启tomcat2；</span><br></pre></td></tr></table></figure><h3 id="访问测试-2"><a href="#访问测试-2" class="headerlink" title="访问测试"></a>访问测试</h3><center><img src="http://ovuhiuqqd.bkt.clouddn.com/%E6%90%AD%E5%BB%BATomcat%E4%BC%9A%E8%AF%9D%E9%9B%86%E7%BE%A4.gif"></center><h3 id="基于Nginx调度"><a href="#基于Nginx调度" class="headerlink" title="基于Nginx调度"></a>基于Nginx调度</h3><p>环境是不变的，只是换了调度器为<code>Nginx</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@Httpd ~]# systemctl stop httpd    # 停止httpd；</span><br><span class="line">[root@Httpd ~]# yum -y install nginx    # 安装nginx；</span><br><span class="line">[root@Httpd ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line">    upstream tcsrvs &#123;     </span><br><span class="line">        server 192.168.8.12:8080;       # 添加server；</span><br><span class="line">        server 192.168.8.15:8080;</span><br><span class="line">    &#125;       </span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on; </span><br><span class="line">    tcp_nodelay         on; </span><br><span class="line">    keepalive_timeout   65; </span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  _;  </span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://tcsrvs ;      # 调用server；</span><br><span class="line">        &#125;       </span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;       </span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123; </span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;       </span><br><span class="line">[root@Httpd ~]# systemctl start nginx       # 启动nginx；</span><br></pre></td></tr></table></figure><h3 id="访问测试-3"><a href="#访问测试-3" class="headerlink" title="访问测试"></a>访问测试</h3><center><img src="http://ovuhiuqqd.bkt.clouddn.com/%E6%90%AD%E5%BB%BATomcat%E4%BC%9A%E8%AF%9D%E9%9B%86%E7%BE%A42.gif"></center>]]></content>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>实现httpd会话绑定</title>
      <link href="/2017/11/08/Tomcat-Httpd-session-Bangding-Tomcat-2017-11-07/"/>
      <url>/2017/11/08/Tomcat-Httpd-session-Bangding-Tomcat-2017-11-07/</url>
      <content type="html"><![CDATA[<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Httpd%E5%9F%BA%E4%BA%8Eajp%E5%8D%8F%E8%AE%AE%E8%B0%83%E5%BA%A6Tomcat%E9%9B%86%E7%BE%A4.jpg"></center><br><center> 拓扑</center><table><thead><tr><th>服务</th><th>IP</th><th>系统版本</th><th>软件版本</th><th>功能</th></tr></thead><tbody><tr><td>Httpd</td><td>192.168.8.17/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>httpd.x86_64 0:2.4.6-45</td><td>反向代理</td></tr><tr><td>Tomcat1</td><td>192.168.8.12/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>tomcat-7.0.69(java-1.8.0-openjdk)</td><td>应用服务</td></tr><tr><td>Tomcat2</td><td>192.168.8.15/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>tomcat-7.0.69(java-1.8.0-openjdk)</td><td>应用服务</td></tr></tbody></table><a id="more"></a><h4 id="1-修改主机名，并写入hosts文件"><a href="#1-修改主机名，并写入hosts文件" class="headerlink" title="1. 修改主机名，并写入hosts文件"></a>1. 修改主机名，并写入hosts文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># 修改Httpd server 主机名；</span><br><span class="line">[root@centos6 ~]# hostname Httpd.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Httpd ~]# </span><br><span class="line">[root@Httpd ~]# vim /etc/hosts      # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Httpd.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Httpd.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改Tomccat1 server 主机名；</span><br><span class="line">[root@centos7 ~]# hostname Tomcat1.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Tomcat1 ~]# </span><br><span class="line">[root@Tomcat1 ~]# vim /etc/hosts        # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Tomcat1.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Httpd.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改Tomccat2 server 主机名；</span><br><span class="line">[root@centos7 ~]# hostname Tomcat2.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Tomcat2 ~]# </span><br><span class="line">[root@Tomcat2 ~]# vim /etc/hosts            # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Tomcat2.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Httpd.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line">[root@Httpd ~]# ping -c 1 Httpd.haiyun.com          # 测试是否能够解析成功，ok；</span><br><span class="line">PING localhost (127.0.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from localhost (127.0.0.1): icmp_seq=1 ttl=64 time=0.010 ms</span><br><span class="line"></span><br><span class="line">--- localhost ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.010/0.010/0.010/0.000 ms</span><br><span class="line">[root@Httpd ~]# ping -c 1 Tomcat1.haiyun.com</span><br><span class="line">PING Tomcat1.haiyun.com (192.168.8.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from Tomcat1.haiyun.com (192.168.8.12): icmp_seq=1 ttl=64 time=1.83 ms</span><br><span class="line"></span><br><span class="line">--- Tomcat1.haiyun.com ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 2ms</span><br><span class="line">rtt min/avg/max/mdev = 1.835/1.835/1.835/0.000 ms</span><br><span class="line">[root@Httpd ~]# ping -c 1 Tomcat2.haiyun.com</span><br><span class="line">PING Tomcat2.haiyun.com (192.168.8.15) 56(84) bytes of data.</span><br><span class="line">64 bytes from Tomcat2.haiyun.com (192.168.8.15): icmp_seq=1 ttl=64 time=1.94 ms</span><br><span class="line"></span><br><span class="line">--- Tomcat2.haiyun.com ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 2ms</span><br><span class="line">rtt min/avg/max/mdev = 1.940/1.940/1.940/0.000 ms</span><br></pre></td></tr></table></figure><h4 id="2-同步所有server的时间"><a href="#2-同步所有server的时间" class="headerlink" title="2. 同步所有server的时间"></a>2. 同步所有server的时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Httpd server</span><br><span class="line">[root@Httpd ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:36 ntpdate[11037]: adjust time server 172.18.0.1 offset -0.000054 sec</span><br><span class="line">[root@Httpd ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br><span class="line"></span><br><span class="line"># Tomcat1 server</span><br><span class="line">[root@Tomcat1 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:42 ntpdate[3153]: adjust time server 172.18.0.1 offset 0.000261 sec</span><br><span class="line">[root@Tomcat1 ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br><span class="line"></span><br><span class="line"># Tomcat2 server</span><br><span class="line">[root@Tomcat2 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:42 ntpdate[11255]: adjust time server 172.18.0.1 offset 0.332502 sec</span><br><span class="line">[root@Tomcat2 ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br></pre></td></tr></table></figure><h3 id="为两台后端server安装Tomcat软件"><a href="#为两台后端server安装Tomcat软件" class="headerlink" title="为两台后端server安装Tomcat软件"></a>为两台后端server安装Tomcat软件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# yum -y install java-1.8.0-openjdk-devel tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# yum -y install java-1.8.0-openjdk-devel tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br></pre></td></tr></table></figure><h3 id="为两台Tomcat设置默认访问主页"><a href="#为两台Tomcat设置默认访问主页" class="headerlink" title="为两台Tomcat设置默认访问主页"></a>为两台Tomcat设置默认访问主页</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# mkdir -pv /usr/share/tomcat/webapps/myapp/WEB-INF</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp’</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp/WEB-INF’</span><br><span class="line">[root@Tomcat1 ~]# vim /usr/share/tomcat/webapps/myapp/index.jsp     # 创建默认主页；</span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;&lt;title&gt;Tomcat1&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;&lt;font color=&quot;red&quot;&gt;Tomcat1.ihaiyun.cc&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(&quot;ihaiyun.cc&quot;,&quot;magedu.com&quot;); %&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Tomcat1 ~]# systemctl start tomcat.service        # 启动Tomcat服务；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# mkdir -pv /usr/share/tomcat/webapps/myapp/WEB-INF</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp’</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp/WEB-INF’</span><br><span class="line">[root@Tomcat2 ~]# vim /usr/share/tomcat/webapps/myapp/index.jsp     # 创建默认主页；</span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;&lt;title&gt;Tomcat2&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;&lt;font color=&quot;blue&quot;&gt;Tomcat2.ihaiyun.cc&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(&quot;ihaiyun.cc&quot;,&quot;magedu.com&quot;); %&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Tomcat2 ~]# systemctl start tomcat.service        # 启动Tomcat服务；</span><br></pre></td></tr></table></figure><h4 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h4><p><strong>注意：</strong><code>Tomcat1</code>为红色，<code>Tomcat2</code>为蓝色。</p><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Nginx%E8%B0%83%E5%BA%A6Tomcat%E9%9B%86%E7%BE%A41.gif"></center><h3 id="安装Httpd并配置调度"><a href="#安装Httpd并配置调度" class="headerlink" title="安装Httpd并配置调度"></a>安装Httpd并配置调度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@Httpd ~]# yum -y install httpd        # 安装httpd；</span><br><span class="line">[root@Httpd ~]# vim /etc/httpd/conf.d/httpd.conf            # 添加配置文件；</span><br><span class="line">[root@Httpd ~]# vim /etc/httpd/conf.d/httpd.conf </span><br><span class="line"></span><br><span class="line">Header add Set-Cookie &quot;ROUTEID=.%&#123;BALANCER_WORKER_ROUTE&#125;e; path=/&quot; env=BALANCER_ROUTE_CHANGED&lt;proxy         # 添加自定义ROUTEID；  </span><br><span class="line">&lt;proxy balancer://tcsrvs&gt;</span><br><span class="line">    BalancerMember http://192.168.8.12:8080 route=tomcat1       # 指定192.168.8.12的Id为tomcat1；</span><br><span class="line">    BalancerMember http://192.168.8.15:8080 route=tomcat2       # 指定192.168.8.15的Id为tomcat2；</span><br><span class="line">    ProxySet lbmethod=byrequests</span><br><span class="line">    ProxySet stickysession=ROUTEID              # 设置会话根据ROUTEID进行调度；</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName httpd.ihaiyun.cc</span><br><span class="line">    ProxyVia On</span><br><span class="line">    ProxyRequests Off</span><br><span class="line">    ProxyPreserveHost On</span><br><span class="line">    &lt;Proxy *&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Proxy&gt;</span><br><span class="line">    ProxyPass / balancer://tcsrvs/</span><br><span class="line">    ProxyPassReverse / balancer://tcsrvs/</span><br><span class="line">    &lt;Location /&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line">    &lt;Location /balancer-manager&gt;</span><br><span class="line">        SetHandler balancer-manager</span><br><span class="line">        ProxyPass !</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">[root@Httpd ~]# systemctl reload httpd.service          # 重新加载服务；</span><br></pre></td></tr></table></figure><h3 id="访问测试-1"><a href="#访问测试-1" class="headerlink" title="访问测试"></a>访问测试</h3><p>现在命令行测试。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@Httpd ~]# for i in &#123;1..4&#125;; do elinks -dump http://192.168.8.17/myapp/ ; done      # 已经实现会话绑定，都被调度到tomcat2了；</span><br><span class="line">[root@Httpd ~]# for i in &#123;1..4&#125;; do elinks -dump http://192.168.8.17/myapp/ ; done</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | DE99E41C8C2529CA7737F3DDA555A6B3 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510064889270                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | E1C95CC4B1BFAB9A75BD2947F23C0BA9 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510064889312                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 7DA80B52F0719216FBB9A8E691BC3C22 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510064889352                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | D94A56F7A62CFBEDCB71443891917825 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510064889393                    |</span><br><span class="line">   +-----------------------------------------------+</span><br></pre></td></tr></table></figure><center>在浏览器测试，ok</center><br><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Httpd%E5%AE%9E%E7%8E%B0Tomcat%E9%9B%86%E7%BE%A4%E4%BC%9A%E8%AF%9D%E7%BB%91%E5%AE%9A.gif"></center><h3 id="基于ajp协议实现会话绑定"><a href="#基于ajp协议实现会话绑定" class="headerlink" title="基于ajp协议实现会话绑定"></a>基于ajp协议实现会话绑定</h3><p>环境就按上面搭建好的环境。</p><h3 id="修改httpd配置文件"><a href="#修改httpd配置文件" class="headerlink" title="修改httpd配置文件"></a>修改httpd配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@Httpd ~]# vim /etc/httpd/conf.d/httpd.conf </span><br><span class="line">Header add Set-Cookie &quot;ROUTEID=.%&#123;BALANCER_WORKER_ROUTE&#125;e; path=/&quot; env=BALANCER_ROUTE_CHANGED&lt;proxy balancer://tcsrvs&gt;</span><br><span class="line">    BalancerMember ajp://192.168.8.12:8009 route=tomcat1        # 已经修改为ajp协议，且端口也变为8009；</span><br><span class="line">    BalancerMember ajp://192.168.8.15:8009 route=tomcat2</span><br><span class="line">    ProxySet lbmethod=byrequests</span><br><span class="line">    ProxySet stickysession=ROUTEID</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName ajpd.ihaiyun.cc</span><br><span class="line">    ProxyVia On</span><br><span class="line">    ProxyRequests Off</span><br><span class="line">    ProxyPreserveHost On</span><br><span class="line">    &lt;Proxy *&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Proxy&gt;</span><br><span class="line">    ProxyPass / balancer://tcsrvs/</span><br><span class="line">    ProxyPassReverse / balancer://tcsrvs/</span><br><span class="line">    &lt;Location /&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line">    &lt;Location /balancer-manager&gt;</span><br><span class="line">        SetHandler balancer-manager</span><br><span class="line">        ProxyPass !</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">[root@Httpd ~]# systemctl reload httpd      # 重新加载服务；</span><br></pre></td></tr></table></figure><h3 id="访问测试-2"><a href="#访问测试-2" class="headerlink" title="访问测试"></a>访问测试</h3><p>在命令行中访问<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@Httpd ~]# for i in &#123;1..4&#125;; do elinks -dump http://192.168.8.17/myapp/ ; done      # 全部调度到tomcat2，ok；</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 22F9390B8F3D48D1462F8F86B880CD03 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510065461064                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 04467F2925B69BE21FD5F87D5C956C42 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510065461105                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 96A245A1732FCA0594A9019530F89173 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510065461142                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | E23E51B0AE529E3F08B3407C320DC272 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510065461183                    |</span><br><span class="line">   +-----------------------------------------------+</span><br></pre></td></tr></table></figure></p><center>在浏览器测试，ok</center><br><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Httpd%E5%AE%9E%E7%8E%B0Tomcat%E9%9B%86%E7%BE%A4%E4%BC%9A%E8%AF%9D%E7%BB%91%E5%AE%9A2.gif"></center>]]></content>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Httpd基于ajp协议调度Tomcat集群</title>
      <link href="/2017/11/07/Tomcat-Httpd-ajp-Diaodu-Tomcat-2017-11-07/"/>
      <url>/2017/11/07/Tomcat-Httpd-ajp-Diaodu-Tomcat-2017-11-07/</url>
      <content type="html"><![CDATA[<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Httpd%E5%9F%BA%E4%BA%8Eajp%E5%8D%8F%E8%AE%AE%E8%B0%83%E5%BA%A6Tomcat%E9%9B%86%E7%BE%A4.jpg"></center><br><center> 拓扑</center><table><thead><tr><th>服务</th><th>IP</th><th>系统版本</th><th>软件版本</th><th>功能</th></tr></thead><tbody><tr><td>Httpd</td><td>192.168.8.17/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>httpd.x86_64 0:2.4.6-45</td><td>反向代理</td></tr><tr><td>Tomcat1</td><td>192.168.8.12/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>tomcat-7.0.69(java-1.8.0-openjdk)</td><td>应用服务</td></tr><tr><td>Tomcat2</td><td>192.168.8.15/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>tomcat-7.0.69(java-1.8.0-openjdk)</td><td>应用服务</td></tr></tbody></table><a id="more"></a><h4 id="1-修改主机名，并写入hosts文件"><a href="#1-修改主机名，并写入hosts文件" class="headerlink" title="1. 修改主机名，并写入hosts文件"></a>1. 修改主机名，并写入hosts文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># 修改Httpd server 主机名；</span><br><span class="line">[root@centos6 ~]# hostname Httpd.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Httpd ~]# </span><br><span class="line">[root@Httpd ~]# vim /etc/hosts      # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Httpd.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Httpd.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改Tomccat1 server 主机名；</span><br><span class="line">[root@centos7 ~]# hostname Tomcat1.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Tomcat1 ~]# </span><br><span class="line">[root@Tomcat1 ~]# vim /etc/hosts        # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Tomcat1.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Httpd.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改Tomccat2 server 主机名；</span><br><span class="line">[root@centos7 ~]# hostname Tomcat2.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Tomcat2 ~]# </span><br><span class="line">[root@Tomcat2 ~]# vim /etc/hosts            # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Tomcat2.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Httpd.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line">[root@Httpd ~]# ping -c 1 Httpd.haiyun.com          # 测试是否能够解析成功，ok；</span><br><span class="line">PING localhost (127.0.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from localhost (127.0.0.1): icmp_seq=1 ttl=64 time=0.010 ms</span><br><span class="line"></span><br><span class="line">--- localhost ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.010/0.010/0.010/0.000 ms</span><br><span class="line">[root@Httpd ~]# ping -c 1 Tomcat1.haiyun.com</span><br><span class="line">PING Tomcat1.haiyun.com (192.168.8.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from Tomcat1.haiyun.com (192.168.8.12): icmp_seq=1 ttl=64 time=1.83 ms</span><br><span class="line"></span><br><span class="line">--- Tomcat1.haiyun.com ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 2ms</span><br><span class="line">rtt min/avg/max/mdev = 1.835/1.835/1.835/0.000 ms</span><br><span class="line">[root@Httpd ~]# ping -c 1 Tomcat2.haiyun.com</span><br><span class="line">PING Tomcat2.haiyun.com (192.168.8.15) 56(84) bytes of data.</span><br><span class="line">64 bytes from Tomcat2.haiyun.com (192.168.8.15): icmp_seq=1 ttl=64 time=1.94 ms</span><br><span class="line"></span><br><span class="line">--- Tomcat2.haiyun.com ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 2ms</span><br><span class="line">rtt min/avg/max/mdev = 1.940/1.940/1.940/0.000 ms</span><br></pre></td></tr></table></figure><h4 id="2-同步所有server的时间"><a href="#2-同步所有server的时间" class="headerlink" title="2. 同步所有server的时间"></a>2. 同步所有server的时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Httpd server</span><br><span class="line">[root@Httpd ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:36 ntpdate[11037]: adjust time server 172.18.0.1 offset -0.000054 sec</span><br><span class="line">[root@Httpd ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br><span class="line"></span><br><span class="line"># Tomcat1 server</span><br><span class="line">[root@Tomcat1 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:42 ntpdate[3153]: adjust time server 172.18.0.1 offset 0.000261 sec</span><br><span class="line">[root@Tomcat1 ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br><span class="line"></span><br><span class="line"># Tomcat2 server</span><br><span class="line">[root@Tomcat2 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:42 ntpdate[11255]: adjust time server 172.18.0.1 offset 0.332502 sec</span><br><span class="line">[root@Tomcat2 ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br></pre></td></tr></table></figure><h3 id="为两台后端server安装Tomcat软件"><a href="#为两台后端server安装Tomcat软件" class="headerlink" title="为两台后端server安装Tomcat软件"></a>为两台后端server安装Tomcat软件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# yum -y install java-1.8.0-openjdk-devel tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# yum -y install java-1.8.0-openjdk-devel tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br></pre></td></tr></table></figure><h3 id="为两台Tomcat设置默认访问主页"><a href="#为两台Tomcat设置默认访问主页" class="headerlink" title="为两台Tomcat设置默认访问主页"></a>为两台Tomcat设置默认访问主页</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# mkdir -pv /usr/share/tomcat/webapps/myapp/WEB-INF</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp’</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp/WEB-INF’</span><br><span class="line">[root@Tomcat1 ~]# vim /usr/share/tomcat/webapps/myapp/index.jsp     # 创建默认主页；</span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;&lt;title&gt;Tomcat1&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;&lt;font color=&quot;red&quot;&gt;Tomcat1.ihaiyun.cc&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(&quot;ihaiyun.cc&quot;,&quot;magedu.com&quot;); %&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Tomcat1 ~]# systemctl start tomcat.service        # 启动Tomcat服务；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# mkdir -pv /usr/share/tomcat/webapps/myapp/WEB-INF</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp’</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp/WEB-INF’</span><br><span class="line">[root@Tomcat2 ~]# vim /usr/share/tomcat/webapps/myapp/index.jsp     # 创建默认主页；</span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;&lt;title&gt;Tomcat2&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;&lt;font color=&quot;blue&quot;&gt;Tomcat2.ihaiyun.cc&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(&quot;ihaiyun.cc&quot;,&quot;magedu.com&quot;); %&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Tomcat2 ~]# systemctl start tomcat.service        # 启动Tomcat服务；</span><br></pre></td></tr></table></figure><h4 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h4><p><strong>注意：</strong><code>Tomcat1</code>为红色，<code>Tomcat2</code>为蓝色。</p><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Nginx%E8%B0%83%E5%BA%A6Tomcat%E9%9B%86%E7%BE%A41.gif"></center><h3 id="安装Httpd并配置调度"><a href="#安装Httpd并配置调度" class="headerlink" title="安装Httpd并配置调度"></a>安装Httpd并配置调度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@Httpd ~]# yum -y install httpd        # 安装httpd；</span><br><span class="line">[root@Httpd ~]# vim /etc/httpd/conf.d/httpd.conf            # 添加配置文件；</span><br><span class="line">&lt;proxy balancer://tcsrvs&gt;</span><br><span class="line">    BalancerMember ajp://192.168.8.12:8009 loadfactor=1     # loadfactor代表权重；</span><br><span class="line">    BalancerMember ajp://192.168.8.15:8009 loadfactor=2</span><br><span class="line">    ProxySet lbmethod=byrequests</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName ajpd.ihaiyun.cc</span><br><span class="line">    ProxyVia On</span><br><span class="line">    ProxyRequests Off </span><br><span class="line">    ProxyPreserveHost On</span><br><span class="line">    &lt;Proxy *&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Proxy&gt;</span><br><span class="line">    ProxyPass / balancer://tcsrvs/</span><br><span class="line">    ProxyPassReverse / balancer://tcsrvs/</span><br><span class="line">    &lt;Location /&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">[root@Httpd ~]# systemctl start httpd           # 启动服务；</span><br></pre></td></tr></table></figure><h3 id="访问测试-1"><a href="#访问测试-1" class="headerlink" title="访问测试"></a>访问测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@Httpd ~]# for i in &#123;1..4&#125; ; do elinks -dump http://192.168.8.17/myapp/ ; done         # 访问测试，权重也ok；</span><br><span class="line">                               Tomcat1.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | D185B8D76E438F30A380AEF88485B0EF |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510056772305                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | AD507239A812442347ADFEF183242F2F |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510056772572                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | DAECB1047615F1F5CA4231CC58904D10 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510056772613                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat1.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 6525B417E343A61E72E4215C81CE7559 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510056772431                    |</span><br><span class="line">   +-----------------------------------------------+</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Httpd基于http协议调度Tomcat集群</title>
      <link href="/2017/11/07/Tomcat-Httpd-http-Diaodu-Tomcat-2017-11-07/"/>
      <url>/2017/11/07/Tomcat-Httpd-http-Diaodu-Tomcat-2017-11-07/</url>
      <content type="html"><![CDATA[<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Httpd%E5%9F%BA%E4%BA%8Ehttp%E5%8D%8F%E8%AE%AE%E8%B0%83%E5%BA%A6Tomcat%E9%9B%86%E7%BE%A4.jpg"></center><br><center> 拓扑</center><table><thead><tr><th>服务</th><th>IP</th><th>系统版本</th><th>软件版本</th><th>功能</th></tr></thead><tbody><tr><td>Httpd</td><td>192.168.8.17/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>httpd.x86_64 0:2.4.6-45</td><td>反向代理</td></tr><tr><td>Tomcat1</td><td>192.168.8.12/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>tomcat-7.0.69(java-1.8.0-openjdk)</td><td>应用服务</td></tr><tr><td>Tomcat2</td><td>192.168.8.15/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>tomcat-7.0.69(java-1.8.0-openjdk)</td><td>应用服务</td></tr></tbody></table><a id="more"></a><h4 id="1-修改主机名，并写入hosts文件"><a href="#1-修改主机名，并写入hosts文件" class="headerlink" title="1. 修改主机名，并写入hosts文件"></a>1. 修改主机名，并写入hosts文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># 修改Httpd server 主机名；</span><br><span class="line">[root@centos6 ~]# hostname Httpd.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Httpd ~]# </span><br><span class="line">[root@Httpd ~]# vim /etc/hosts      # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Httpd.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Httpd.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改Tomccat1 server 主机名；</span><br><span class="line">[root@centos7 ~]# hostname Tomcat1.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Tomcat1 ~]# </span><br><span class="line">[root@Tomcat1 ~]# vim /etc/hosts        # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Tomcat1.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Httpd.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改Tomccat2 server 主机名；</span><br><span class="line">[root@centos7 ~]# hostname Tomcat2.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Tomcat2 ~]# </span><br><span class="line">[root@Tomcat2 ~]# vim /etc/hosts            # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Tomcat2.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Httpd.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line">[root@Httpd ~]# ping -c 1 Httpd.haiyun.com          # 测试是否能够解析成功，ok；</span><br><span class="line">PING localhost (127.0.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from localhost (127.0.0.1): icmp_seq=1 ttl=64 time=0.010 ms</span><br><span class="line"></span><br><span class="line">--- localhost ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.010/0.010/0.010/0.000 ms</span><br><span class="line">[root@Httpd ~]# ping -c 1 Tomcat1.haiyun.com</span><br><span class="line">PING Tomcat1.haiyun.com (192.168.8.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from Tomcat1.haiyun.com (192.168.8.12): icmp_seq=1 ttl=64 time=1.83 ms</span><br><span class="line"></span><br><span class="line">--- Tomcat1.haiyun.com ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 2ms</span><br><span class="line">rtt min/avg/max/mdev = 1.835/1.835/1.835/0.000 ms</span><br><span class="line">[root@Httpd ~]# ping -c 1 Tomcat2.haiyun.com</span><br><span class="line">PING Tomcat2.haiyun.com (192.168.8.15) 56(84) bytes of data.</span><br><span class="line">64 bytes from Tomcat2.haiyun.com (192.168.8.15): icmp_seq=1 ttl=64 time=1.94 ms</span><br><span class="line"></span><br><span class="line">--- Tomcat2.haiyun.com ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 2ms</span><br><span class="line">rtt min/avg/max/mdev = 1.940/1.940/1.940/0.000 ms</span><br></pre></td></tr></table></figure><h4 id="2-同步所有server的时间"><a href="#2-同步所有server的时间" class="headerlink" title="2. 同步所有server的时间"></a>2. 同步所有server的时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Httpd server</span><br><span class="line">[root@Httpd ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:36 ntpdate[11037]: adjust time server 172.18.0.1 offset -0.000054 sec</span><br><span class="line">[root@Httpd ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br><span class="line"></span><br><span class="line"># Tomcat1 server</span><br><span class="line">[root@Tomcat1 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:42 ntpdate[3153]: adjust time server 172.18.0.1 offset 0.000261 sec</span><br><span class="line">[root@Tomcat1 ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br><span class="line"></span><br><span class="line"># Tomcat2 server</span><br><span class="line">[root@Tomcat2 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:42 ntpdate[11255]: adjust time server 172.18.0.1 offset 0.332502 sec</span><br><span class="line">[root@Tomcat2 ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br></pre></td></tr></table></figure><h3 id="为两台后端server安装Tomcat软件"><a href="#为两台后端server安装Tomcat软件" class="headerlink" title="为两台后端server安装Tomcat软件"></a>为两台后端server安装Tomcat软件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# yum -y install java-1.8.0-openjdk-devel tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# yum -y install java-1.8.0-openjdk-devel tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br></pre></td></tr></table></figure><h3 id="为两台Tomcat设置默认访问主页"><a href="#为两台Tomcat设置默认访问主页" class="headerlink" title="为两台Tomcat设置默认访问主页"></a>为两台Tomcat设置默认访问主页</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# mkdir -pv /usr/share/tomcat/webapps/myapp/WEB-INF</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp’</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp/WEB-INF’</span><br><span class="line">[root@Tomcat1 ~]# vim /usr/share/tomcat/webapps/myapp/index.jsp     # 创建默认主页；</span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;&lt;title&gt;Tomcat1&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;&lt;font color=&quot;red&quot;&gt;Tomcat1.ihaiyun.cc&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(&quot;ihaiyun.cc&quot;,&quot;magedu.com&quot;); %&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Tomcat1 ~]# systemctl start tomcat.service        # 启动Tomcat服务；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# mkdir -pv /usr/share/tomcat/webapps/myapp/WEB-INF</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp’</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp/WEB-INF’</span><br><span class="line">[root@Tomcat2 ~]# vim /usr/share/tomcat/webapps/myapp/index.jsp     # 创建默认主页；</span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;&lt;title&gt;Tomcat2&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;&lt;font color=&quot;blue&quot;&gt;Tomcat2.ihaiyun.cc&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(&quot;ihaiyun.cc&quot;,&quot;magedu.com&quot;); %&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Tomcat2 ~]# systemctl start tomcat.service        # 启动Tomcat服务；</span><br></pre></td></tr></table></figure><h4 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h4><p><strong>注意：</strong><code>Tomcat1</code>为红色，<code>Tomcat2</code>为蓝色。</p><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Nginx%E8%B0%83%E5%BA%A6Tomcat%E9%9B%86%E7%BE%A41.gif"></center><h3 id="安装Httpd并配置调度"><a href="#安装Httpd并配置调度" class="headerlink" title="安装Httpd并配置调度"></a>安装Httpd并配置调度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@Httpd ~]# yum -y install httpd        # 安装httpd；</span><br><span class="line">[root@Httpd ~]# vim /etc/httpd/conf.d/httpd.conf            # 添加配置文件；</span><br><span class="line">&lt;proxy balancer://tcsrvs&gt;</span><br><span class="line">    BalancerMember http://192.168.8.12:8080</span><br><span class="line">    BalancerMember http://192.168.8.15:8080</span><br><span class="line">    ProxySet lbmethod=byrequests</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName httpd.ihaiyun.cc</span><br><span class="line">    ProxyVia On</span><br><span class="line">    ProxyRequests Off </span><br><span class="line">    ProxyPreserveHost On</span><br><span class="line">    &lt;Proxy *&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Proxy&gt;</span><br><span class="line">    ProxyPass / balancer://tcsrvs/</span><br><span class="line">    ProxyPassReverse / balancer://tcsrvs/</span><br><span class="line">    &lt;Location /&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">[root@Httpd ~]# systemctl start httpd</span><br></pre></td></tr></table></figure><h3 id="访问测试-1"><a href="#访问测试-1" class="headerlink" title="访问测试"></a>访问测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@Httpd ~]# for i in &#123;1..4&#125; ; do elinks -dump http://192.168.8.17/myapp/ ; done     # 访问测试，ok；</span><br><span class="line">                               Tomcat1.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | CB54B841B411BD39AC206E5C21A94D2D |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510055671410                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 5AE73728906E1B832CFABA7DBAB44F62 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510055671678                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat1.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 3223618E201BC73DCB053C52BD2972F2 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510055671494                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 6DE3ECA59EDB7EB71ECCFBDD47443F4A |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510055671758                    |</span><br><span class="line">   +-----------------------------------------------+</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Nginx调度Tomcat集群</title>
      <link href="/2017/11/07/Tomcat-Nginx-Diaodu-Tomcat-2017-11-07/"/>
      <url>/2017/11/07/Tomcat-Nginx-Diaodu-Tomcat-2017-11-07/</url>
      <content type="html"><![CDATA[<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Nginx%E8%B0%83%E5%BA%A6Tomcat%E9%9B%86%E7%BE%A4.jpg"></center><center> 拓扑</center><table><thead><tr><th>服务</th><th>IP</th><th>系统版本</th><th>软件版本</th><th>功能</th></tr></thead><tbody><tr><td>Nginx</td><td>192.168.8.17/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>nginx.x86_64 1:1.10.2</td><td>反向代理</td></tr><tr><td>Tomcat1</td><td>192.168.8.12/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>tomcat-7.0.69(java-1.8.0-openjdk)</td><td>应用服务</td></tr><tr><td>Tomcat2</td><td>192.168.8.15/24</td><td>CentOS Linux release 7.3.1611 (Core)</td><td>tomcat-7.0.69(java-1.8.0-openjdk)</td><td>应用服务</td></tr></tbody></table><a id="more"></a><h4 id="1-修改主机名，并写入hosts文件"><a href="#1-修改主机名，并写入hosts文件" class="headerlink" title="1. 修改主机名，并写入hosts文件"></a>1. 修改主机名，并写入hosts文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># 修改Nginx server 主机名；</span><br><span class="line">[root@centos6 ~]# hostname Nginx.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Nginx ~]# </span><br><span class="line">[root@Nginx ~]# vim /etc/hosts      # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Nginx.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Nginx.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改Tomccat1 server 主机名；</span><br><span class="line">[root@centos7 ~]# hostname Tomcat1.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Tomcat1 ~]# </span><br><span class="line">[root@Tomcat1 ~]# vim /etc/hosts        # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Tomcat1.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Nginx.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改Tomccat2 server 主机名；</span><br><span class="line">[root@centos7 ~]# hostname Tomcat2.haiyun.com &amp;&amp; exec bash</span><br><span class="line">[root@Tomcat2 ~]# </span><br><span class="line">[root@Tomcat2 ~]# vim /etc/hosts            # 写入/etc/hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 Tomcat2.haiyun.com</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 Nginx.haiyun.com </span><br><span class="line">192.168.8.12 Tomcat1.haiyun.com</span><br><span class="line">192.168.8.15 Tomcat2.haiyun.com</span><br><span class="line"></span><br><span class="line">[root@Nginx ~]# ping -c 1 Nginx.haiyun.com          # 测试是否能够解析成功，ok；</span><br><span class="line">PING localhost (127.0.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from localhost (127.0.0.1): icmp_seq=1 ttl=64 time=0.010 ms</span><br><span class="line"></span><br><span class="line">--- localhost ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.010/0.010/0.010/0.000 ms</span><br><span class="line">[root@Nginx ~]# ping -c 1 Tomcat1.haiyun.com</span><br><span class="line">PING Tomcat1.haiyun.com (192.168.8.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from Tomcat1.haiyun.com (192.168.8.12): icmp_seq=1 ttl=64 time=1.83 ms</span><br><span class="line"></span><br><span class="line">--- Tomcat1.haiyun.com ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 2ms</span><br><span class="line">rtt min/avg/max/mdev = 1.835/1.835/1.835/0.000 ms</span><br><span class="line">[root@Nginx ~]# ping -c 1 Tomcat2.haiyun.com</span><br><span class="line">PING Tomcat2.haiyun.com (192.168.8.15) 56(84) bytes of data.</span><br><span class="line">64 bytes from Tomcat2.haiyun.com (192.168.8.15): icmp_seq=1 ttl=64 time=1.94 ms</span><br><span class="line"></span><br><span class="line">--- Tomcat2.haiyun.com ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 2ms</span><br><span class="line">rtt min/avg/max/mdev = 1.940/1.940/1.940/0.000 ms</span><br></pre></td></tr></table></figure><h4 id="2-同步所有server的时间"><a href="#2-同步所有server的时间" class="headerlink" title="2. 同步所有server的时间"></a>2. 同步所有server的时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Nginx server</span><br><span class="line">[root@Nginx ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:36 ntpdate[11037]: adjust time server 172.18.0.1 offset -0.000054 sec</span><br><span class="line">[root@Nginx ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br><span class="line"></span><br><span class="line"># Tomcat1 server</span><br><span class="line">[root@Tomcat1 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:42 ntpdate[3153]: adjust time server 172.18.0.1 offset 0.000261 sec</span><br><span class="line">[root@Tomcat1 ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br><span class="line"></span><br><span class="line"># Tomcat2 server</span><br><span class="line">[root@Tomcat2 ~]# ntpdate 172.18.0.1</span><br><span class="line"> 7 Nov 16:32:42 ntpdate[11255]: adjust time server 172.18.0.1 offset 0.332502 sec</span><br><span class="line">[root@Tomcat2 ~]# date</span><br><span class="line">Tue Nov  7 16:32:47 CST 2017</span><br></pre></td></tr></table></figure><h3 id="为两台后端server安装Tomcat软件"><a href="#为两台后端server安装Tomcat软件" class="headerlink" title="为两台后端server安装Tomcat软件"></a>为两台后端server安装Tomcat软件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# yum -y install java-1.8.0-openjdk-devel tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# yum -y install java-1.8.0-openjdk-devel tomcat tomcat-admin-webapps tomcat-docs-webapp tomcat-webapps</span><br></pre></td></tr></table></figure><h3 id="为两台Tomcat设置默认访问主页"><a href="#为两台Tomcat设置默认访问主页" class="headerlink" title="为两台Tomcat设置默认访问主页"></a>为两台Tomcat设置默认访问主页</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># Tomcat1配置</span><br><span class="line">[root@Tomcat1 ~]# mkdir -pv /usr/share/tomcat/webapps/myapp/WEB-INF</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp’</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp/WEB-INF’</span><br><span class="line">[root@Tomcat1 ~]# vim /usr/share/tomcat/webapps/myapp/index.jsp     # 创建默认主页；</span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;&lt;title&gt;Tomcat1&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;&lt;font color=&quot;red&quot;&gt;Tomcat1.ihaiyun.cc&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(&quot;ihaiyun.cc&quot;,&quot;magedu.com&quot;); %&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Tomcat1 ~]# systemctl start tomcat.service        # 启动Tomcat服务；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Tomcat2配置</span><br><span class="line">[root@Tomcat2 ~]# mkdir -pv /usr/share/tomcat/webapps/myapp/WEB-INF</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp’</span><br><span class="line">mkdir: created directory ‘/usr/share/tomcat/webapps/myapp/WEB-INF’</span><br><span class="line">[root@Tomcat2 ~]# vim /usr/share/tomcat/webapps/myapp/index.jsp     # 创建默认主页；</span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;&lt;title&gt;Tomcat2&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;&lt;font color=&quot;blue&quot;&gt;Tomcat2.ihaiyun.cc&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">        &lt;table align=&quot;centre&quot; border=&quot;1&quot;&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(&quot;ihaiyun.cc&quot;,&quot;magedu.com&quot;); %&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Tomcat2 ~]# systemctl start tomcat.service        # 启动Tomcat服务；</span><br></pre></td></tr></table></figure><h4 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h4><p><strong>注意：</strong><code>Tomcat1</code>为红色，<code>Tomcat2</code>为蓝色。</p><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Nginx%E8%B0%83%E5%BA%A6Tomcat%E9%9B%86%E7%BE%A41.gif"></center><h3 id="安装Nginx并配置调度"><a href="#安装Nginx并配置调度" class="headerlink" title="安装Nginx并配置调度"></a>安装Nginx并配置调度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# yum -y  install  nginx</span><br><span class="line">[root@Nginx ~]# vim /etc/nginx/nginx.conf       # 修改配置文件；</span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line">    upstream tcsrvs &#123;               # 添加一个upstream；</span><br><span class="line">        server 192.168.8.12:8080;</span><br><span class="line">        server 192.168.8.15:8080;</span><br><span class="line">    &#125;</span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  _;  </span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line">        location / &#123; </span><br><span class="line">            proxy_pass http://tcsrvs ;          # 调度；</span><br><span class="line">        &#125;   </span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx ~]# nginx -t        # 检查配置文件，ok；</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx ~]# nginx           # 启动nginx；</span><br></pre></td></tr></table></figure><h3 id="访问测试-1"><a href="#访问测试-1" class="headerlink" title="访问测试"></a>访问测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx ~]# for i in &#123;1..4&#125; ; do elinks -dump http://192.168.8.17/myapp/ ; done         # 访问测试，ok；</span><br><span class="line">                               Tomcat1.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 38F138AAC0BEEFC6D8E05C7D744EC0D4 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510048315220                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 9637B2765CBB9B45E8EE1FA9C77FCD86 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510048315322                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat1.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | C4257FC42C22ED09670B8C0EEF763E97 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510048315299                    |</span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">                               Tomcat2.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">   +-----------------------------------------------+</span><br><span class="line">   | Session ID | 6A4111864EEC323C8156A269D8CBB8C5 |</span><br><span class="line">   |------------+----------------------------------|</span><br><span class="line">   | Created on | 1510048315401                    |</span><br><span class="line">   +-----------------------------------------------+</span><br></pre></td></tr></table></figure>]]></content>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>会话保持解决方案</title>
      <link href="/2017/11/07/Tomcat-Keep-Session-2017-11-07/"/>
      <url>/2017/11/07/Tomcat-Keep-Session-2017-11-07/</url>
      <content type="html"><![CDATA[<h3 id="一、为什么需要会话保持"><a href="#一、为什么需要会话保持" class="headerlink" title="一、为什么需要会话保持"></a>一、为什么需要会话保持</h3><p>如果我们将后端的Web服务器分为两组，一组是静态内容服务器，一组是动态内容服务器，那么我们再进行反向代理的时候，反向代理服务器通过判断资源文件的后缀名，决定将其调度至后端的那一组服务上。如果我们的后端服务器静态内容和动态内容都分别有多台，那么反向代理服务器还需要对其进行负载均衡，然后觉得资源调度到那一台服务器。那么对于静态内容的服务器，因为静态内容是不会处理会话的，所以在进行负载均衡时我们不用考虑其会话保持。做最简单的和最直接的轮询就好了，如果服务器的性能不一样的话，就做加权轮询即可。当然如果说后端静态服务器的资源大小区别也非常大，那么轮询的方式对负载均衡的方式来讲，效果不是特别明显，那可能需要使用最少连接数的负载均衡方式来处理这类资源情况，最少连接是可以考虑当前连接的服务器的负载情况，能保证结果公平。这是对于静态内容的服务器来说，那么对于动态内容的服务器，因为动态内容涉及到处理会话，我们就需要考虑负载均衡间服务器的会话保持了。会话保持是指在负载均衡器上有一种机制，在作负载均衡的同时，还保证同一用户相关连的访问请求会被分配到同一台服务器上。</p><a id="more"></a><p>举例来说，网络银行的服务门户网站。用户通过输入用户名和密码登录到应用系统中，一旦登录成功，用户可以做很多业务操作。例如检查帐户余额，在线转帐等。</p><p> 如果没有配置会话保持，那么可能出现这样的情况:用户登录的时候，系统选择了Server1进行认证，通过认证以后，用户接下来进行业务操作时(比如转帐)，此时系统又选择了Server2或Server3对用户进行服务，这时问题就出现了，因为Server2或Server3上没有用户交易状态的信息，所以Server2或Server3会认为用户没有通过认证，从而拒绝该用户的操作请求。</p><p>如果配置了会话保持，那么用户登录以后后续的所有操作都会直接发送到在认证时选择的那台服务上。</p><h3 id="二、会话保持的方法"><a href="#二、会话保持的方法" class="headerlink" title="二、会话保持的方法"></a>二、会话保持的方法</h3><h4 id="1、会话绑定"><a href="#1、会话绑定" class="headerlink" title="1、会话绑定"></a>1、会话绑定</h4><p><strong>1、会话绑定</strong>：会话绑定是指使用一个算法或者是使用持久连接，将来自于同一个IP的请求始终定向至后端的同一个后端服务器。这种方法简单易用，但有如下问题：</p><ul><li>当后端服务器宕机后，会话就会丢失；</li><li>来自同一IP的客户端会被转发到同一个后端服务器，可能导致负载失衡；</li><li>不适用于前段还有代理的情况。</li></ul><h4 id="2、会话复制"><a href="#2、会话复制" class="headerlink" title="2、会话复制"></a>2、会话复制</h4><p><strong>2、会话复制</strong>：也叫会话集群，通过后端服务器自身的组件构建成类似会话高可用的集群，集群内部的动态服务器之间通过多播方式进行通信，在这些集群服务器中，每一台服务器都会将自己创建的会话通过多播的方式同步给集群的其他服务器。所以每一个服务器都维持着当前集群内的所有会话，因此用户的请求可以被调度至任意服务器上。因为我们的会话都是在集群服务器之间被同步的，不管用户连接那一台服务器，他的会话都是存在的。但是这样一种解决方法的问题在于：</p><ul><li>由于服务器于服务器之间要进行会话复制，所以后端服务器之间的带宽被大量占用；</li><li>每台服务器都要维持整个集群中的所有会话，对服务器本身的资源占用和消耗非常大，使得服务器本身的并发承载能力有限。</li><li>但是好处在于我们的负载均衡调度可以任何进行，而且任何一个服务器故障都不会导致我们的会话丢失。</li></ul><h4 id="3、会话服务器"><a href="#3、会话服务器" class="headerlink" title="3、会话服务器"></a>3、会话服务器</h4><p><strong>3、会话服务器</strong>：因为会话复制的弊端，我们可以找一台高性能的服务器，存储流式的数据，比如MemCached，这个是著名的用于会话缓存服务器，MemCache可以把web服务器中的内存组合起来，成为一个”内存池”，不管是哪个服务器产生的会话都可以放到这个”内存池”中，其他的服务器都可以使用。还有Redis（Key-value，kv store），键值服务器，键值存储，对于种存储来讲，他们可以帮我们在前端把我们的会话保存下来。但是这种方式也有弊端：</p><ul><li>服务器有可能会成为性能瓶颈；</li><li>他们是单点故障之一，因此我们部署这种类似的服务器，还得做扩展和冗余。</li></ul><h4 id="4、其他会话保持技术"><a href="#4、其他会话保持技术" class="headerlink" title="4、其他会话保持技术"></a>4、其他会话保持技术</h4><ul><li><p>至于其他的用数据库做会话保持以及利用客户端的Cookie做会话保持的技术，直接就不用推荐，为什么？数据库本来就是瓶颈的地方，还用来进行会话保持，这不是加大数据库的负担吗？</p></li><li><p>利用客户端的Cookie做会话保持，需要客户端把Cookie开启，如果把Cookie禁掉了，也就玩不转了。而且利用客户端的Cookie，容易被攻击，毕竟Cookie安全性太低了，太容易被伪造。</p><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://www.mamicode.com/" target="_blank" rel="noopener">本文内容来自：码迷</a></p></li></ul>]]></content>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>HTTP会话原理解释与应用</title>
      <link href="/2017/11/07/Tomcat-Session-2017-11-07/"/>
      <url>/2017/11/07/Tomcat-Session-2017-11-07/</url>
      <content type="html"><![CDATA[<h3 id="一、什么是会话"><a href="#一、什么是会话" class="headerlink" title="一、什么是会话"></a>一、什么是会话</h3><p> 首先解释一下什么是会话。在计算机术语中，会话是指一个终端用户与交互系统进行通讯的过程，比如从输入账户密码进入操作系统到退出操作系统就是一个会话过程。会话较多用于网络上，TCP的三次握手就创建了一个会话，TCP关闭连接就是关闭会话。用平述的语言可以解释为：你拔打你女友的电话号码，你女友接听，然后一翻“亲爱的”，直到任何一方挂掉电话，这个过程就是一个会话。你挑逗一只小狗，它跟你互动，也是会话；它不鸟你，那就不形成会话。</p><a id="more"></a><h3 id="二、什么是HTTP会话"><a href="#二、什么是HTTP会话" class="headerlink" title="二、什么是HTTP会话"></a>二、什么是HTTP会话</h3><p>协议的状态是指下一次传输可以“记住”这次传输信息的能力，HTTP是不会为了下一次连接而维护这次连接所传输的信息的。从传统WEB上看：无状态是指，当浏览器发送请求给服务器的时候，服务器响应，但是同一个浏览器再发送请求给服务器的时候，他会响应，但是他不知道你就是刚才那个浏览器，简单地说，就是服务器不会去记得你，所以是无状态协议。本质是：HTTP1.0是短连接的（这里先忽略HTTP1.1的keep alive吧），请求响应后，断开了TCP连接，下一次连接与上一次无关。为了识别不同的请求是否来自同一客户，引用HTTP会话机制，即：多次HTTP连接间维护用户与同一用户发出的不同请求之间关联的情况称为维护一个会话（session）。通过会话管理对会话进行创建、信息存储、关闭等。</p><h3 id="三、HTTP会话的实现机制"><a href="#三、HTTP会话的实现机制" class="headerlink" title="三、HTTP会话的实现机制"></a>三、HTTP会话的实现机制</h3><p>Cookie与session是各种教材，网上文章所介绍到的与HTTP会话相关的两个内容。这种者较常见的解释是：cookie存在在浏览器，session存储在服务器中。这种解释是最显浅的，很不严谨，但又不能说是错误。先从cookie谈起吧，很久很久以前，为了完成HTTP会话，那些互联网的设计者们想到了一个办法，就是在浏览器中存储用户信息，每次请求都向服务端发送这些信息，这样服务端就知道请求发送者是谁了，就知道应该返回什么信息给客户了。但是问题很快就出现了，张三冒充李四的名字发送请求给服务器，服务器把李四的相关信息发给了张三。为了安全起见，互联网老大哥们又想到了一招识别用户身份的办法，就是把客户信息存储在服务端（session），一切用户的身份由服务器指定。直到目前，session已成功HTTP会话的主流，应该说是绝对控制的地位。</p><p>Session是怎样做到会话身份识别的呢？首先，用户端向服务端发送一个请求，服务端接收到请求（这里忽悠无须会话控制的情况）后，初始化会话，生成相应的会话信息，核心是会话ID，把会话ID发送给客户端，客户端接收到这个会话ID，把它存储起来，下一次发送请求的时候，附带着这个会话ID一起发送给服务端，服务端只要根据这个会话ID，就知道是谁了。这个会话ID，就像我们的身份证号码，一直伴随终生。核心：服务端如何生成这个会话ID，客户端怎样存储这个会话ID。</p><h3 id="四、如何存储会话ID（SESSION-ID）"><a href="#四、如何存储会话ID（SESSION-ID）" class="headerlink" title="四、如何存储会话ID（SESSION ID）"></a>四、如何存储会话ID（SESSION ID）</h3><p>服务端存储会话ID有多种方式，常见的有本地存储，如：普通文本，文本名就是会话ID。对于文件系统，同一目录下，同一文件名只允许唯一一个文件，那么使用会话ID作为文件名是可以做到唯一确定会话的。除了本地文件存储，还可以使用memcache、redis、或者Mysql之类的数据库存储，即使用第三方数据库进行存储。只有一个原则：存储的会话ID必须是唯一的。</p><p>客户端收到服务端返回的（或者说服务端下发的）会话ID后，也是像服务端那样使用文件名作为会话ID存储会话信息到文本吗？如果客户端只与同一个服务端（理解为同一个服务端处理程序）进行会话通讯的话，是可行的。但是，HTTP是因万维网而生的，浏览器作为最常见的HTTP客户端，需要访问各种不同的网站，如果采用会话ID作为文件名，以这样的文件存在会话信息的话，会出现这样的情况：N个不同的网站，服务端采用的是相同的会话生成算法，在同一时刻，很可能会生成一样的会话ID，客户端则无法唯一确定这个会话ID到底是与哪个服务端通讯，也就是客户端“不认得”服务端了，会话就无法完成。如何确定服务端身份？那就是使用“域”，不同的域拥有独立的会话。客户端以域相关信息作为文件标识符创建会话文件（客户端存储）对会话信息进行存储，其中域与会话ID结合就能唯一确定服务端，并且确定会话。那么，以“域”信息作为文件名的文件中存储着会话ID等信息。每次请求某个域的服务时，把存储着的会话ID附带到请求中发送到服务端。浏览器是最常见的HTTP客户端，浏览器存储会话信息，是使用COOKIE文件的，里面保存着COOKIE信息，而服务端返回的会话ID也存储在里面。会话ID存储在COOKIE文件中是一般情况下的，而COOKIE信息是作为HTTP头发送给服务端的，也就是说这种情况下，会话ID是附带在请求头中。但是，HTTP请求，除了头信息，还可以有内容体，必须有URL。那么，会话ID同样可以存储在内容体中或URL中，比如在禁用浏览器COOKIE的情况下，也可实现与服务端会话，要么依赖内容体，要么依赖URL，常见的是URL中附带会话ID，这个在PHP等编程语言中较为常见（曾经的历史上常见，但是会涉及安全或者效率等问题，这里不详述）。</p><p>粗糙地，可理解为服务端返回给客户端的会话ID是存储在COOKIE文件中的。COOKIE文件是由浏览器管理的，当然在自实现的客户端中，可以通过编程手段实现COOKIE文件管理，即客户端会话的管理。举例：IOS开发者，可以把HTTP返回的信息头存储到沙盒中进行管理。PHP开发客户端时，可以把信息头写到文件中，或第三方服务中，或网络存储中等等。</p><h3 id="五、会话管理（SESSION）"><a href="#五、会话管理（SESSION）" class="headerlink" title="五、会话管理（SESSION）"></a>五、会话管理（SESSION）</h3><p>会话管理包括：会话创建、会话识别、会话信息操作、会话生命周期、会话关闭。</p><p>注意：这一节中的服务端会话都看作是开启的，无特别情况不再交待。</p><h4 id="1、会话创建"><a href="#1、会话创建" class="headerlink" title="1、会话创建"></a>1、会话创建</h4><p>客户端发起不带会话ID（SESSION ID）的HTTP请求，服务端认为还没产生会话，即创建会话，生成会话ID并且在服务器中存储相关会话信息，并通知客户端已开启会话。一般情况下，是在返回给客户端的HTTP  header中的COOKIE项中附带上会话ID，形式为：会话标记：会话ID。客户端根据返回的信息头，设置本地COOKIE值并存储。</p><h4 id="2、会话识别"><a href="#2、会话识别" class="headerlink" title="2、会话识别"></a>2、会话识别</h4><p>会话ID是会话的唯一标识符，一个会话ID只会对应一个会话，就像身份证号码只对应一个人一样。HTTP中，服务端是被动接受请求的，会话识别也是被动的（触发式）。服务端不需要知道发送请求的到底是谁，只需要知道对方发送过来的会话ID，把客户端传过来的会话ID与服务端存储的会话ID进行匹配。找不到这个会话ID，就认为这个会话是不存在的。</p><p>举例：服务器有个会话ID是“21412545jladfjljljqwr”，映射的值是“名字：张三，性别：男”。客户端只要请求中的会话ID是“21412545jladfjljljqwr”，就识别到这个会话了，能认为这人是张三，而且是男性。如果客户端请求的会话ID是“qwesadfasdfadsfasdf”，即使客户端附带了信息“名字：张三，性别：男”，服务端都认为不存在此人，不形成会话。就算是李四盗用了张三的会话ID，服务端也会识别这个会话</p><p>可简单理解为：SESSION只根据SESSION ID建立起会话，是不负责安全校验的，只负责让服务端与客户端可以“通话”。</p><h4 id="3、会话信息操作"><a href="#3、会话信息操作" class="headerlink" title="3、会话信息操作"></a>3、会话信息操作</h4><p>服务端：会话ID映射信息，ID不变，映射的内容可变</p><p>客户端：会话ID映射信息，ID不变，映射的内容可变（即存在在COOKIEk中的内容可变）。</p><p>服务端与客户端的会话信息只有会话ID是必须相同的，其它会话信息（即会话ID映射的信息）没有直接关系。</p><h4 id="4、会话生命周期"><a href="#4、会话生命周期" class="headerlink" title="4、会话生命周期"></a>4、会话生命周期</h4><p>会话从开始到结束就是会话的生命周期。设定一个时间，这个时间内无通讯就清除会话信息，我们就把这个时间叫做会话超时周期。</p><p>习惯地，我们把会话超时周期叫做会话的生命周期，其实这是两个概念。</p><h4 id="5、会话关闭"><a href="#5、会话关闭" class="headerlink" title="5、会话关闭"></a>5、会话关闭</h4><p>会话关闭，有2种方式。一种是用户主动清除会话信息，另一种是会话超时。会话超时不是守护任务（或自动任务）周期性检查处理的，而是访问会话信息时，根据会话信息中的“上一次更新时间”到现在的时间差，与会话周期比较，超出周期的，清除会话信息，即会话关闭。</p><p>经典例子：会话过程中，突然断网。</p><h3 id="六、-会话原理的应用"><a href="#六、-会话原理的应用" class="headerlink" title="六、 会话原理的应用"></a>六、 会话原理的应用</h3><p>浏览器默认是开启Cookie的，浏览器发起HTTP请求时，在请求头中带有Cookie信息，只要服务端返回Cookie中包含SessionID，在服务端根据Sessionid即实现HTTP会话，此过程对于前端开发者是透明的（即前端开发可以不关心浏览器是怎样与服务端确定会话的）。</p><p>除即时通讯，实时动作网游外，大多APP是使用HTTP协议与服务端通讯的，使用HTTP协议的原因主要是移动网络环境复杂（容易断线），并且HTTP协议穿透性强。原生开发的IOS，安卓等APP，与服务端会话，可不使用COOKIE，只需要在请求中携带会话ID即可，这在上文已描述。原生APP与内嵌浏览器的APP相比：原生实现性能更高，交互效果流畅，用户体验相对较好，但快速跌代比不上内嵌浏览器的APP。手机配置越来越高，内嵌浏览器对HTML5支持也越来越好，在性能要求不是很高的场景，内嵌WEB的性能已可满足，在布局多变，或者元素多变的情况下，可快速修改，而无需用户升级APP，也能获得更好的产品体验。APP内嵌WEB最常见的场景就是电商APP了，登陆、注册、入口等交互效果较多的模块使用原生程序开发，而商品列表、商品展示等等模块可采用内嵌WEB,这样既可满足快速产品跌代的要求，又可满足操作的性能要求。</p><p> 举例：电商APP入门界面、登陆、注册是使用原生开发的，登陆后跳转到商品列表页（即内嵌WEB），然后下订单。问题来了，如何使得登陆后跳转到WEB后，还是登陆状态（即内嵌WEB与原生程序具有一致的会话 ）呢？内嵌WEB是不会去取得原生程序所存储的data的。最简单直接的办法就是：登陆成功，服务器返回会话ID与成功信息，跳转到WEB时，发送的HTTP请求头中包括COOKIE，会话ID存储在COOKIE中，这样之后点击WEB中的链接后向服务端发送的HTTP请求头，就会携带这个COOKIE（会话ID）了。简单地理解：终端原生程序请求服务端，服务端按普通WEB那样返回信息，终端原生程序取得HTTP返回头中的COOKIE信息，保存下来，下一次请求时，携带COOKIE信息即可。在浏览器中，COOKIE的处理由浏览器默认处理，而在原生APP程序中，由开发者写程序去处理而已。</p><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p> <a href="http://www.mamicode.com/info-detail-608168.html" target="_blank" rel="noopener">本文内容来自：码迷-HTTP会话原理解释与应用</a></p>]]></content>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>部署solo应用</title>
      <link href="/2017/11/05/Tomcat-solo-2017-11-05/"/>
      <url>/2017/11/05/Tomcat-solo-2017-11-05/</url>
      <content type="html"><![CDATA[<h3 id="安装配置tomcat"><a href="#安装配置tomcat" class="headerlink" title="安装配置tomcat"></a>安装配置tomcat</h3><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDk ~]# vim /etc/tomcat/tomcat-users.xml          # 修改配置文件，开启web管理界面并配置tomcat用户，密码也是tomcat；</span><br><span class="line">&lt;role rolename=&quot;manager-gui&quot;/&gt;</span><br><span class="line">&lt;user username=&quot;tomcat&quot; password=&quot;tomcat&quot; roles=&quot;manager-gui,admin-gui&quot;/&gt;</span><br><span class="line">[root@OpenJDk ~]# systemctl start tomcat            # 启动tomcat服务；</span><br></pre></td></tr></table></figure><h3 id="下载solo"><a href="#下载solo" class="headerlink" title="下载solo"></a>下载solo</h3><p>目前solo最新版本为2.4；</p><p><a href="https://github.com/b3log/solo" target="_blank" rel="noopener">下载地址：https://github.com/b3log/solo</a></p><h3 id="复制solo包并修改solo配置文件"><a href="#复制solo包并修改solo配置文件" class="headerlink" title="复制solo包并修改solo配置文件"></a>复制solo包并修改solo配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDk ~]# cp solo-2.2.0.war /usr/share/tomcat/webapps/</span><br><span class="line">[root@OpenJDk ~]# cd /usr/share/tomcat/webapps/</span><br><span class="line">[root@OpenJDk webapps]# ls</span><br><span class="line">docs  examples  host-manager  manager  ROOT  sample  solo-2.4.0  solo-2.4.0.war  test</span><br><span class="line">[root@OpenJDk webapps]# cd solo-2.4.0/WEB-INF/classes/</span><br><span class="line">[root@OpenJDk classes]# vim latke.properties        # 修改配置文件；</span><br><span class="line">serverScheme=http</span><br><span class="line"># Browser visit domain name</span><br><span class="line">serverHost=192.168.8.12     # 因为本处我们没有设置域名解析，所以将此修改为IP；</span><br><span class="line"># Browser visit port, 80 as usual, THIS IS NOT SERVER LISTEN PORT!</span><br><span class="line">serverPort=8080         # 端口也是默认的8080；</span><br></pre></td></tr></table></figure><h3 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDk classes]# systemctl restart tomcat        # 重启tomcat服务；</span><br></pre></td></tr></table></figure><center><img src="http://ovuhiuqqd.bkt.clouddn.com/Tomcat-Solo.gif"></center>]]></content>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Httpd代理Tomcat</title>
      <link href="/2017/11/05/Tomcat-Httpd-Proxy/"/>
      <url>/2017/11/05/Tomcat-Httpd-Proxy/</url>
      <content type="html"><![CDATA[<h3 id="基于http协议代理Tomcat"><a href="#基于http协议代理Tomcat" class="headerlink" title="基于http协议代理Tomcat"></a>基于http协议代理Tomcat</h3><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDk ~]# yum install httpd</span><br><span class="line">[root@OpenJDk ~]# cd /etc/httpd/conf.d/</span><br><span class="line">[root@OpenJDk conf.d]# ls</span><br><span class="line">autoindex.conf  README  userdir.conf  welcome.conf</span><br><span class="line">[root@OpenJDk conf.d]# vim httpd-tomcat.conf</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName www.ihaiyun.cc</span><br><span class="line">    ProxyRequests Off </span><br><span class="line">    ProxyVia    On  </span><br><span class="line">    ProxyPreserveHost On</span><br><span class="line">    &lt;Proxy *&gt;</span><br><span class="line">        Require all granted </span><br><span class="line">    &lt;/Proxy&gt;</span><br><span class="line">    ProxyPass / http://127.0.0.1:8080/</span><br><span class="line">    ProxyPassReverse / http://127.0.0.1:8080/</span><br><span class="line">    &lt;Location /&gt;</span><br><span class="line">        Require all granted </span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@OpenJDk conf.d]# httpd -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@OpenJDk conf.d]# systemctl start httpd</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Httpd-Proxy-1.gif" title="访问测试"></center><h3 id="基于AJP协议代理Tomcat"><a href="#基于AJP协议代理Tomcat" class="headerlink" title="基于AJP协议代理Tomcat"></a>基于AJP协议代理Tomcat</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDk conf.d]# vim httpd-tomcat.conf        # 修改配置文件；</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName www.ihaiyun.cc</span><br><span class="line">    ProxyRequests Off </span><br><span class="line">    ProxyVia    On  </span><br><span class="line">    ProxyPreserveHost On</span><br><span class="line">    &lt;Proxy *&gt;</span><br><span class="line">        Require all granted </span><br><span class="line">    &lt;/Proxy&gt;</span><br><span class="line">    ProxyPass / ajp://127.0.0.1:8009/           # 修改为ajp协议，且端口为8009；</span><br><span class="line">    ProxyPassReverse / ajp://127.0.0.1:8009/</span><br><span class="line">    &lt;Location /&gt;</span><br><span class="line">        Require all granted </span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line">[root@OpenJDk conf.d]# httpd -t</span><br><span class="line">Syntax OK</span><br><span class="line">[root@OpenJDk conf.d]# systemctl restart httpd</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Httpd-Proxy-2.gif" title="访问测试"></center>]]></content>
      
      <categories>
          
          <category> TOMCAT </category>
          
          <category> Httpd代理Tomcat </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Nginx代理Tomcat</title>
      <link href="/2017/11/05/Tomcat-Nginx-Proxy/"/>
      <url>/2017/11/05/Tomcat-Nginx-Proxy/</url>
      <content type="html"><![CDATA[<h3 id="安装配置nginx"><a href="#安装配置nginx" class="headerlink" title="安装配置nginx"></a>安装配置nginx</h3><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDk ~]# yum install -y tomcat </span><br><span class="line">[root@OpenJDk ~]# systemctl start nginx</span><br><span class="line">[root@OpenJDk ~]# systemctl start tomcat.service </span><br><span class="line">[root@OpenJDk ~]# vim /etc/nginx/nginx.conf         # 修改配置文件；</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        root         /usr/share/tomcat/webapps/ROOT;        # 根目录指向tomcat的根目录；</span><br><span class="line">        index index.jsp index.html; </span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line">        location ~* \.(jsp|do)$ &#123;       # 定义访问以.jsp和.do结尾就转发到本地的tomcat来处理；</span><br><span class="line">            proxy_pass http://192.168.8.12:8080 ;   # 注意：此处不能加/；</span><br><span class="line">        &#125;   </span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;   </span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line">[root@OpenJDk ~]# nginx -s reload</span><br></pre></td></tr></table></figure><h3 id="测试访问"><a href="#测试访问" class="headerlink" title="测试访问"></a>测试访问</h3><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Nginx-Proxy-1.jpg" title="访问测试"></center>]]></content>
      
      <categories>
          
          <category> TOMCAT </category>
          
          <category> Nginx代理Tomcat </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Tomcat web管理界面</title>
      <link href="/2017/11/05/Tomcat-Web/"/>
      <url>/2017/11/05/Tomcat-Web/</url>
      <content type="html"><![CDATA[<h3 id="web管理界面"><a href="#web管理界面" class="headerlink" title="web管理界面"></a>web管理界面</h3><p>当我们安装完成Tomcat，默认的web界面如下：</p><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Web-1.jpg" title="安装完成Tomcat，默认的web界面"></center><a id="more"></a><p>我们可以看到三个按钮，分别对应为：</p><ul><li><code>Server Status</code>：tomcat服务器状态，包括内存信息，进程信息等等。</li><li><code>manager App</code>：Web App的管理页面，可以开、关、重载、部署、卸载 Web App。</li><li><code>Host Manager</code>：虚拟主机的管理页面，可以对虚拟主机进行添加删除修改操作。</li></ul><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Web-2.gif" title="点击按钮"></center><p>为我们提供了帮助信息：</p><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Web-3.jpg" title="失败界面，为我们提供了帮助信息"></center><p>角色对应的信息为：</p><ul><li>manager-gui - allows access to the HTML GUI and the status pages</li><li>manager-script - allows access to the text interface and the status pages</li><li>manager-jmx - allows access to the JMX proxy and the status pages</li><li>manager-status - allows access to the status pages only</li></ul><h3 id="访问web界面Server-Status和Manager-App"><a href="#访问web界面Server-Status和Manager-App" class="headerlink" title="访问web界面Server Status和Manager App"></a>访问web界面Server Status和Manager App</h3><p>定义角色为<code>manager-gui</code>，用户和密码为<code>tomcat</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDK ~]# vim /etc/tomcat/tomcat-users.xml          # 修改配置文件；</span><br><span class="line">&lt;role rolename=&quot;manager-gui&quot;/&gt;          </span><br><span class="line">&lt;user username=&quot;tomcat&quot; password=&quot;tomcat&quot; roles=&quot;manager-gui&quot;/&gt;</span><br><span class="line">[root@OpenJDK ~]# systemctl restart tomcat</span><br></pre></td></tr></table></figure></p><p>登陆测试：</p><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Web-4.gif" title="登陆测试"></center><h4 id="使用Manager-App热部署"><a href="#使用Manager-App热部署" class="headerlink" title="使用Manager App热部署"></a>使用Manager App热部署</h4><p>例如：部署的访问路径为<code>/app</code>，真实路径在<code>/app/test</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDK ~]# cp -r test/ /app/         # 准备文件；</span><br><span class="line">[root@OpenJDK ~]# cd /app/test/</span><br><span class="line">[root@OpenJDK test]# ls</span><br><span class="line">classes  index.jsp  lib  META-INF  WEB-INF</span><br><span class="line">[root@OpenJDK test]# vim index.jsp </span><br><span class="line">[root@OpenJDK test]# cat index.jsp </span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;%@ page import=&quot;java.util.*&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Test Page&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;% out.println(&quot;hello app server&quot;);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Web-5.gif" title="访问测试"></center><h4 id="Server-Status界面"><a href="#Server-Status界面" class="headerlink" title="Server Status界面"></a>Server Status界面</h4><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Web-6.jpg" title="Server Status界面"></center><p><strong><code>JVM Memory Status</code></strong></p><p><code>MAX memory</code>：大约为服务器最大内存的四分之一左右。可以自定义，最大不超过32G。</p><p><code>Heap</code> 内存区分为：<code>Eden Space</code>（伊甸园）、<code>Survivor Space</code>(幸存者区)、<code>Tenured Gen</code>（老年代-养老区）。</p><p>非<code>Heap</code> 内存区分为：<code>Code Cache</code>（代码缓存区）、<code>Compressed Class Space</code>（压缩的类区）、<code>Metaspace</code>（源数据区）</p><p><code>AJP</code> 服务 和<code>HTTP</code>服务（默认<code>HTTPS</code>服务没有启用）</p><p><code>AJP</code>(默认监听在8009端口）、<code>HTTP</code>（默认监听在8080端口）</p><p>服务阶段（<code>Stage</code>）<br><code>P</code>: Parse and prepare request （解析和准备请求）<br><code>S</code>: Service （服务中）<br><code>F</code>: Finishing （完成服务）<br><code>R</code>: Ready （准备好）<br><code>K</code>: Keepalive（保持连接）</p><h3 id="使用Host-Manager"><a href="#使用Host-Manager" class="headerlink" title="使用Host Manager"></a>使用Host Manager</h3><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Web-7.jpg" title="错误界面"></center><br>根据帮助页面来修改<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDK ~]# vim /etc/tomcat/tomcat-users.xml          # 修改配置文件；</span><br><span class="line">&lt;role rolename=&quot;manager-gui&quot;/&gt;</span><br><span class="line">&lt;user username=&quot;tomcat&quot; password=&quot;tomcat&quot; roles=&quot;admin-gui,manager-gui&quot;/&gt; </span><br><span class="line">[root@OpenJDK ~]# systemctl restart tomcat.service</span><br></pre></td></tr></table></figure><br><br><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Web-8.gif" title="访问测试"></center>]]></content>
      
      <categories>
          
          <category> TOMCAT </category>
          
          <category> Tomcat web管理界面 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Tomcat常用配置</title>
      <link href="/2017/11/05/Tomcat-configure/"/>
      <url>/2017/11/05/Tomcat-configure/</url>
      <content type="html"><![CDATA[<h3 id="server-xml"><a href="#server-xml" class="headerlink" title="server.xml"></a>server.xml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Tomcat的核心组件：server.xml</span><br><span class="line">&lt;Server&gt;</span><br><span class="line">&lt;Service&gt;</span><br><span class="line">&lt;connector/&gt;</span><br><span class="line">&lt;connector/&gt;</span><br><span class="line">...</span><br><span class="line">&lt;Engine&gt;</span><br><span class="line">&lt;Host&gt;</span><br><span class="line">&lt;Context/&gt;</span><br><span class="line">&lt;Context/&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/Host&gt;</span><br><span class="line">&lt;Host&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/Host&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/Engine&gt;</span><br><span class="line">&lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="server"><a href="#server" class="headerlink" title="server"></a>server</h3><p><code>&lt;Server port=&quot;8005&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</code></p><p><code>Server</code>：代表<code>tomcat instance</code>，即表现出的一个<code>java</code>进程；监听在8005端口，只接收“<code>SHUTDOWN</code>”（<code>SHUTDOWN</code>代表向本机的8005端口发送<code>SHUTDOWN</code>指令时就代表关闭<code>tomcat</code>服务。）。各<code>server</code>监听的端口不能相同，因此，在同一物理主机启动多个实例时，需要修改其监听端口为不同的端口；</p><p>建议将此功能关闭：</p><ul><li><code>port=-1</code>或将<code>shutdown=&quot;随机数&quot;</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDK ~]# ss -tnlp          # 查看端口tomcat服务已经启动；</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port                Peer Address:Port              </span><br><span class="line">LISTEN     0      128                *:22                             *:*                   users:((&quot;sshd&quot;,pid=852,fd=3))</span><br><span class="line">LISTEN     0      100        127.0.0.1:25                             *:*                   users:((&quot;master&quot;,pid=1275,fd=13))</span><br><span class="line">LISTEN     0      100               :::8080                          :::*                   users:((&quot;java&quot;,pid=3278,fd=49))</span><br><span class="line">LISTEN     0      128               :::22                            :::*                   users:((&quot;sshd&quot;,pid=852,fd=4))</span><br><span class="line">LISTEN     0      100              ::1:25                            :::*                   users:((&quot;master&quot;,pid=1275,fd=14))</span><br><span class="line">LISTEN     0      1       ::ffff:127.0.0.1:8005                          :::*                   users:((&quot;java&quot;,pid=3278,fd=55))</span><br><span class="line">LISTEN     0      100               :::8009                          :::*                   users:((&quot;java&quot;,pid=3278,fd=50))</span><br><span class="line">[root@OpenJDK ~]# telnet 127.0.0.1 8005     # telnet本机8005端口，发送SHUTDOWN指令；</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is &apos;^]&apos;.</span><br><span class="line">SHUTDOWN</span><br><span class="line">Connection closed by foreign host.</span><br><span class="line">[root@OpenJDK ~]# ss -tnlp      # tomcat服务已经被关闭；</span><br><span class="line">State      Recv-Q Send-Q Local Address:Port                Peer Address:Port              </span><br><span class="line">LISTEN     0      128                *:22                             *:*                   users:((&quot;sshd&quot;,pid=852,fd=3))</span><br><span class="line">LISTEN     0      100        127.0.0.1:25                             *:*                   users:((&quot;master&quot;,pid=1275,fd=13))</span><br><span class="line">LISTEN     0      128               :::22                            :::*                   users:((&quot;sshd&quot;,pid=852,fd=4))</span><br><span class="line">LISTEN     0      100              ::1:25                            :::*                   users:((&quot;master&quot;,pid=1275,fd=14))</span><br></pre></td></tr></table></figure></li></ul><h3 id="connector组件"><a href="#connector组件" class="headerlink" title="connector组件"></a>connector组件</h3><p>负责接收请求，常见的有三类http/https/ajp；</p><p>进入tomcat的请求可分为两类：</p><ul><li>(1) standalone : 请求来自于客户端浏览器；</li><li>(2) 由其它的web server反代：来自前端的反代服务器；<ul><li><code>nginx --&gt; http connector --&gt; tomcat</code> </li><li><code>httpd(proxy_http_module) --&gt; http connector --&gt; tomcat</code></li><li><code>httpd(proxy_ajp_module) --&gt; ajp connector --&gt; tomcat</code> </li><li><code>httpd(mod_jk) --&gt; ajp connector --&gt; tomcat</code> </li></ul></li></ul><p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">           connectionTimeout=&quot;20000&quot;</span><br><span class="line">           redirectPort=&quot;8443&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;Connector port=&quot;8443&quot; protocol=&quot;org.apache.coyote.http11.Http11Protocol&quot;</span><br><span class="line">           maxThreads=&quot;150&quot; SSLEnabled=&quot;true&quot; scheme=&quot;https&quot; secure=&quot;true&quot;</span><br><span class="line">           clientAuth=&quot;false&quot; sslProtocol=&quot;TLS&quot; /&gt;</span><br></pre></td></tr></table></figure></p><p>属性：</p><ul><li><code>port</code>=”8080” </li><li><code>protocol</code>=”HTTP/1.1”</li><li><code>connectionTimeout</code>=”20000”</li><li><code>address</code>：监听的IP地址；默认为本机所有可用地址；</li><li><code>maxThreads</code>：最大并发连接数，默认为200；</li><li><code>enableLookups</code>：是否启用DNS查询功能；</li><li><code>acceptCount</code>：等待队列的最大长度；</li><li><code>secure</code>：true 是否使用安全通信</li><li><code>sslProtocol</code>：TLS协议</li></ul><h3 id="Engine"><a href="#Engine" class="headerlink" title="Engine"></a>Engine</h3><p>Engine组件：Servlet实例，即servlet引擎，其内部可以一个或多个host组件来定义站点； 通常需要通过defaultHost来定义默认的虚拟主机；</p><p>属性：</p><ul><li>name=</li><li>defaultHost=”localhost”</li><li>jvmRoute=</li></ul><p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;</span><br></pre></td></tr></table></figure></p><h3 id="host"><a href="#host" class="headerlink" title="host"></a>host</h3><p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</span><br><span class="line">      unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">  &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">         prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;</span><br><span class="line">         pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/Host&gt;</span><br></pre></td></tr></table></figure></p><p>属性：<br>(1) appBase：此Host的webapps的默认存放目录，指存放非归档的web应用程序的目录或归档的WAR文件目录路径；可以使用基于$CATALINA_BASE变量所定义的路径的相对路径；</p><p>(2) autoDeploy：在Tomcat处于运行状态时，将某webapp放置于appBase所定义的目录中时，是否自动将其部署至tomcat；</p><h4 id="添加虚拟主机"><a href="#添加虚拟主机" class="headerlink" title="添加虚拟主机"></a>添加虚拟主机</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDK ~]# vim /etc/tomcat/server.xml        # 修改配置文件；</span><br><span class="line">      &lt;Host name=&quot;www.ihaiyun.cc&quot; appBase=&quot;/data/webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot; /&gt;</span><br><span class="line">[root@OpenJDK ~]# mkdir -pv /data/webapps</span><br><span class="line">mkdir: created directory ‘/data’</span><br><span class="line">mkdir: created directory ‘/data/webapps’</span><br><span class="line">[root@OpenJDK ~]# cp -r test/ /data/webapps/ROOT        # 为虚拟主机提供访问文件；</span><br><span class="line">[root@OpenJDK ~]# cd /data/webapps/ROOT</span><br><span class="line">[root@OpenJDK ROOT]# ls</span><br><span class="line">classes  index.jsp  lib  META-INF  WEB-INF</span><br><span class="line">[root@OpenJDK ROOT]# vim index.jsp </span><br><span class="line">[root@OpenJDK ROOT]# cat index.jsp      # 编辑默认jsp文件；</span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;%@ page import=&quot;java.util.*&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Test Page&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;% out.println(&quot;www.ihaiyun.cc&quot;);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@OpenJDK ROOT]# vim /etc/hosts         # 修改hosts文件；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.12 www.ihaiyun.cc</span><br><span class="line">[root@OpenJDK ROOT]# curl  http://www.ihaiyun.cc:8080       # 3访问测试，ok；</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Test Page&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">www.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@OpenJDK ROOT]# elinks -dump http://www.ihaiyun.cc:8080</span><br><span class="line">   www.ihaiyun.cc</span><br></pre></td></tr></table></figure><h3 id="Context组件"><a href="#Context组件" class="headerlink" title="Context组件:"></a>Context组件:</h3><p><code>&lt;Context path=&quot;/PATH&quot; docBase=&quot;/PATH/TO/SOMEDIR&quot; reloadable=&quot;&quot;/&gt;</code></p><p>包含在Host标签里。</p><p>如果在一个主机上部署多个app的话，Context就可以用来定义不同app对应的路径。</p><p>把/PATH/TO/SOMEDIR映射到 request URI /PATH</p><ul><li>如果/PATH/TO/SOMEDIR不带/，则是相对路径，相对的是Host的appBase。</li><li>如果/PATH/TO/SOMEDIR带/，则是操作系统的绝对路径。</li><li>reloadable：是否支持主机装载。</li></ul><h4 id="定义context"><a href="#定义context" class="headerlink" title="定义context"></a>定义context</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDK ~]# vim /etc/tomcat/server.xml        # 在上面刚刚增在的host中添加一个context；</span><br><span class="line">      &lt;Host name=&quot;www.ihaiyun.cc&quot; appBase=&quot;/data/webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot; &gt;</span><br><span class="line">        &lt;context path=&quot;/appserver&quot; docBase=&quot;/data/app&quot; reloadable=&quot;&quot;/&gt;</span><br><span class="line">     &lt;/host&gt;</span><br><span class="line"></span><br><span class="line">[root@OpenJDK ~]# cp -r /root/test/ /data/</span><br><span class="line">[root@OpenJDK ~]# cd /data/test/</span><br><span class="line">[root@OpenJDK test]# vim index.jsp </span><br><span class="line">[root@OpenJDK test]# cat index.jsp </span><br><span class="line">&lt;%@ page language=&quot;java&quot; %&gt;</span><br><span class="line">&lt;%@ page import=&quot;java.util.*&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Test Page&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;% out.println(&quot;/data/test&quot;);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@OpenJDK test]# systemctl restart tomcat </span><br><span class="line">[root@OpenJDK test]# elinks -dump http://www.ihaiyun.cc:8080/testapp/       # 测试访问，ok；</span><br><span class="line">   /data/test</span><br></pre></td></tr></table></figure><h3 id="value"><a href="#value" class="headerlink" title="value"></a>value</h3><p>Valve存在多种类型：</p><ul><li>定义访问日志：<code>org.apache.catalina.valves.AccessLogValve</code></li><li>定义访问控制：<code>org.apache.catalina.valves.RemoteAddrValve</code></li></ul><p>访问日志示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">               prefix=&quot;ihaiyun.cc_access_log.&quot; suffix=&quot;.log&quot;</span><br><span class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br></pre></td></tr></table></figure><p><code>&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</code>为日志格式，<code>&amp;quot</code>表示的是引号。</p><h4 id="定义日志"><a href="#定义日志" class="headerlink" title="定义日志"></a>定义日志</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDK test]# vim /etc/tomcat/server.xml         # 修改配置文件；</span><br><span class="line">      &lt;Host name=&quot;www.ihaiyun.cc&quot; appBase=&quot;/data/webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">        &lt;Context path=&quot;/testapp&quot; docBase=&quot;/data/test&quot; reloadable=&quot;true&quot;/&gt;</span><br><span class="line">     &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">               prefix=&quot;ihaiyun.cc_access_log.&quot; suffix=&quot;.log&quot;</span><br><span class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br><span class="line"> &lt;/Host&gt;</span><br><span class="line">[root@OpenJDK test]# elinks -dump http://www.ihaiyun.cc:8080        # 访问测试；</span><br><span class="line">   www.ihaiyun.cc</span><br><span class="line">[root@OpenJDK test]# elinks -dump http://www.ihaiyun.cc:8080</span><br><span class="line">   www.ihaiyun.cc</span><br><span class="line">[root@OpenJDK test]# elinks -dump http://www.ihaiyun.cc:8080</span><br><span class="line">   www.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">[root@OpenJDK ~]# cd /usr/share/tomcat/logs/</span><br><span class="line">[root@OpenJDK logs]# ls</span><br><span class="line">catalina.2017-11-04.log      ihaiyun.cc_access_log.2017-11-04.log  manager.2017-11-04.log</span><br><span class="line">catalina.out                 localhost.2017-11-04.log</span><br><span class="line">host-manager.2017-11-04.log  localhost_access_log.2017-11-04.txt</span><br><span class="line">[root@OpenJDK logs]# tail ihaiyun.cc_access_log.2017-11-04.log          # 查看日志；</span><br><span class="line">192.168.8.12 - - [04/Nov/2017:19:53:01 +0800] &quot;GET / HTTP/1.1&quot; 200 132</span><br><span class="line">192.168.8.12 - - [04/Nov/2017:19:53:01 +0800] &quot;GET / HTTP/1.1&quot; 200 132</span><br><span class="line">192.168.8.12 - - [04/Nov/2017:19:53:03 +0800] &quot;GET / HTTP/1.1&quot; 200 132</span><br></pre></td></tr></table></figure><h4 id="定义访问控制，允许某主机"><a href="#定义访问控制，允许某主机" class="headerlink" title="定义访问控制，允许某主机"></a>定义访问控制，允许某主机</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDK ~]# vim /etc/tomcat/server.xml            # 修改配置文件；</span><br><span class="line">      &lt;Host name=&quot;www.ihaiyun.cc&quot; appBase=&quot;/data/webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">        &lt;Context path=&quot;/testapp&quot; docBase=&quot;/data/test&quot; reloadable=&quot;true&quot;/&gt;</span><br><span class="line">     &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">               prefix=&quot;ihaiyun.cc_access_log.&quot; suffix=&quot;.log&quot;</span><br><span class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br><span class="line">    &lt;Valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot; allow=&quot;127\.\d+\.\d+\.\d+&quot;/&gt;</span><br><span class="line"> &lt;/Host&gt;</span><br><span class="line"> [root@OpenJDK ~]# systemctl restart tomcat</span><br><span class="line">[root@OpenJDK ~]# elinks -dump http://www.ihaiyun.cc:8080/test      # 可以看到使用域名已经无法访问了；</span><br><span class="line">[root@OpenJDK ~]# elinks -dump http://127.0.0.1:8080/test   # 但使用iP还可以；</span><br><span class="line">   hello world</span><br></pre></td></tr></table></figure><h4 id="定义访问控制，拒绝某主机"><a href="#定义访问控制，拒绝某主机" class="headerlink" title="定义访问控制，拒绝某主机"></a>定义访问控制，拒绝某主机</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@OpenJDK ~]# vim /etc/tomcat/server.xml        # 修改配置文件；</span><br><span class="line">      &lt;Host name=&quot;www.ihaiyun.cc&quot; appBase=&quot;/data/webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">        &lt;Context path=&quot;/testapp&quot; docBase=&quot;/data/test&quot; reloadable=&quot;true&quot;/&gt;</span><br><span class="line">     &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">               prefix=&quot;ihaiyun.cc_access_log.&quot; suffix=&quot;.log&quot;</span><br><span class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br><span class="line">    &lt;Valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot; deny=&quot;192\.168\.8\.11&quot;/&gt; &lt;/Host&gt;      # 拒绝192.168.8.11，这台主机访问；</span><br><span class="line">[root@OpenJDK ~]# systemctl restart tomcat</span><br><span class="line">[root@Client ~]# ifconfig eth1              # Client就是192.168.8.11；</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:DE:D2:8C  </span><br><span class="line">          inet addr:192.168.8.11  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fede:d28c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:3742 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:3027 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:380924 (371.9 KiB)  TX bytes:390104 (380.9 KiB)</span><br><span class="line"></span><br><span class="line">[root@Client ~]# cat /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11 www.ihaiyun.cc</span><br><span class="line">[root@Client ~]# elinks -dump http://192.168.8.12:8080/test/        # 直接访问默认虚拟主机，还是可以访问的；</span><br><span class="line">   hello world</span><br><span class="line">[root@Client ~]# elinks -dump http://www.ihaiyun.cc:8080/test/      # 访问www.ihaiyun.cc就被拒绝了；</span><br><span class="line">ELinks: Connection refused</span><br></pre></td></tr></table></figure><h3 id="注释某语句"><a href="#注释某语句" class="headerlink" title="注释某语句"></a>注释某语句</h3><p><code>&lt;!-- --&gt;</code>代表注释某语句。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      &lt;Host name=&quot;www.ihaiyun.cc&quot; appBase=&quot;/data/webapps&quot;</span><br><span class="line">            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">        &lt;Context path=&quot;/testapp&quot; docBase=&quot;/data/test&quot; reloadable=&quot;true&quot;/&gt;</span><br><span class="line">     &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">               prefix=&quot;ihaiyun.cc_access_log.&quot; suffix=&quot;.log&quot;</span><br><span class="line">               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;</span><br><span class="line">&lt;!---   &lt;Valve className=&quot;org.apache.catalina.valves.RemoteAddrValve&quot; deny=&quot;192\.168\.8\.11&quot;/&gt; --&gt;      # 此语句已经被注释；</span><br><span class="line"> &lt;/Host&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> TOMCAT </category>
          
          <category> Tomcat常用配置 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>安装tomcat</title>
      <link href="/2017/11/05/Tomcat-Install/"/>
      <url>/2017/11/05/Tomcat-Install/</url>
      <content type="html"><![CDATA[<h3 id="JAVA简介"><a href="#JAVA简介" class="headerlink" title="JAVA简介"></a>JAVA简介</h3><p><code>Java</code>是一种广泛使用的计算机编程语言，拥有跨平台、面向对象、泛型编程的特性，广泛应用于企业级Web应用开发和移动应用开发。</p><h4 id="JAVA代码的运行"><a href="#JAVA代码的运行" class="headerlink" title="JAVA代码的运行"></a>JAVA代码的运行</h4><p><code>*.java(source code) --&gt; javac --&gt; *.class(bytecode)</code></p><p><code>.java</code>代码编写完成后，由<code>javac</code>编译后，生成字节码<code>.class</code>，然后发送给<code>jvm</code>来运行。</p><a id="more"></a><h4 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h4><p><code>JVM</code>是<code>Java Virtual Machine</code>（<code>Java</code>虚拟机）的缩写，<code>class loader</code>，加载程序的类文件，及程序的类文件依赖到的其它的类文件而后运行； 整个运行表现为一个<code>jvm</code>进程。</p><h4 id="Servlet与Applet"><a href="#Servlet与Applet" class="headerlink" title="Servlet与Applet"></a>Servlet与Applet</h4><ul><li><code>Applet</code>具有很好的图形界面(<code>AWT</code>)，与浏览器一起，在客户端运行。</li><li><code>Servlet</code> 则没有图形界面，运行在服务器端。</li></ul><h4 id="JSP"><a href="#JSP" class="headerlink" title="JSP"></a>JSP</h4><p><code>JSP</code>全名为<code>Java Server Pages</code>，中文名叫<code>java</code>服务器页面，其根本是一个简化的<code>Servlet</code>设计。<br>是一种实现普通静态<code>HTML</code>和动态<code>HTML</code>混合编码的技术，<code>JSP</code>并没有增加任何本质上不能用<code>Servlet</code>实现的功能。但是，在 <code>JSP</code>中编写静态<code>HTML</code>更加方便，不必再用<code>println</code>语句来输出每一行<code>HTML</code>代码。更重要的是，借助内容和外观的分离，页面制作中不同性质的任务可以方便地分开：比如，由页面设计者进行HTML设计，同时留出供<code>Servlet</code>程序员插入动态内容的空间。</p><h4 id="jasper"><a href="#jasper" class="headerlink" title="jasper"></a>jasper</h4><p><code>jasper</code>程序的功能，就是把<code>JVM</code>不认识的<code>JSP</code>文件解析成<code>java</code>文件，然后由<code>javac</code>程序编译成<code>class</code>文件提供使用。目前有很多的<code>JSP</code>解析引擎，<code>Tomcat</code>中使用的是<code>Jasper</code>。如下：</p><p><code>*.jsp –&gt; jasper –&gt; *.java –&gt; javac –&gt; *.class –&gt; JVM</code></p><h3 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h3><p><code>JDK</code>(<code>Java Development Kits</code>)是 <code>Java</code> 语言的软件开发工具包，是整个<code>java</code>开发的核心，它包含了<code>JAVA</code>的运行环境（<code>JVM+Java</code>系统类库）和<code>JAVA</code>工具。</p><p>一共分为两种：</p><ul><li><code>OpenJDK</code> ：而OpenJDK使用的是开源的FreeType</li><li><code>Oracle JDK</code>：Oracle JDK采用了商业实现</li></ul><h4 id="安装OpenJDK-1-8"><a href="#安装OpenJDK-1-8" class="headerlink" title="安装OpenJDK 1.8"></a>安装OpenJDK 1.8</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# yum list | grep &quot;^java&quot;           # 查看java开头的包，可以看到，有1.6、1.7、1.8三个版本</span><br><span class="line">file://misc/cd/repodata/repomd.xml: [Errno 14] curl#37 - &quot;Couldn&apos;t open file /cd/repodata/repomd.xml&quot;</span><br><span class="line">Trying other mirror.</span><br><span class="line">java-1.8.0-openjdk.x86_64                   1:1.8.0.102-4.b14.el7      @base    </span><br><span class="line">java-1.8.0-openjdk-devel.x86_64             1:1.8.0.102-4.b14.el7      @base    </span><br><span class="line">java-1.8.0-openjdk-headless.x86_64          1:1.8.0.102-4.b14.el7      @base    </span><br><span class="line">javapackages-tools.noarch                   3.4.1-11.el7               @base    </span><br><span class="line">java-1.6.0-openjdk.x86_64                   1:1.6.0.40-1.13.12.9.el7   base     </span><br><span class="line">java-1.6.0-openjdk-demo.x86_64              1:1.6.0.40-1.13.12.9.el7   base     </span><br><span class="line">java-1.6.0-openjdk-devel.x86_64             1:1.6.0.40-1.13.12.9.el7   base     </span><br><span class="line">java-1.6.0-openjdk-javadoc.x86_64           1:1.6.0.40-1.13.12.9.el7   base     </span><br><span class="line">java-1.6.0-openjdk-src.x86_64               1:1.6.0.40-1.13.12.9.el7   base     </span><br><span class="line">java-1.7.0-openjdk.x86_64                   1:1.7.0.111-2.6.7.8.el7    base     </span><br><span class="line">java-1.7.0-openjdk-accessibility.x86_64     1:1.7.0.111-2.6.7.8.el7    base     </span><br><span class="line">java-1.7.0-openjdk-demo.x86_64              1:1.7.0.111-2.6.7.8.el7    base     </span><br><span class="line">java-1.7.0-openjdk-devel.x86_64             1:1.7.0.111-2.6.7.8.el7    base     </span><br><span class="line">java-1.7.0-openjdk-headless.x86_64          1:1.7.0.111-2.6.7.8.el7    base     </span><br><span class="line">java-1.7.0-openjdk-javadoc.noarch           1:1.7.0.111-2.6.7.8.el7    base     </span><br><span class="line">java-1.7.0-openjdk-src.x86_64               1:1.7.0.111-2.6.7.8.el7    base     </span><br><span class="line">java-1.8.0-openjdk.i686                     1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-accessibility.x86_64     1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-accessibility-debug.x86_64</span><br><span class="line">java-1.8.0-openjdk-debug.i686               1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-debug.x86_64             1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-demo.x86_64              1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-demo-debug.x86_64        1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-devel.i686               1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-devel-debug.i686         1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-devel-debug.x86_64       1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-headless.i686            1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-headless-debug.i686      1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-headless-debug.x86_64    1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-javadoc.noarch           1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-javadoc-debug.noarch     1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-javadoc-zip.noarch       1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-javadoc-zip-debug.noarch 1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-src.x86_64               1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-1.8.0-openjdk-src-debug.x86_64         1:1.8.0.102-4.b14.el7      base     </span><br><span class="line">java-atk-wrapper.i686                       0.30.4-5.el7               base     </span><br><span class="line">java-atk-wrapper.x86_64                     0.30.4-5.el7               base     </span><br><span class="line">java-dirq.noarch                            1.4-1.el6                  epel     </span><br><span class="line">java-dirq-javadoc.noarch                    1.4-1.el6                  epel     </span><br><span class="line">java-service-wrapper.x86_64                 3.2.5-23.el6               epel     </span><br><span class="line">java-service-wrapper-javadoc.noarch         3.2.5-23.el6               epel     </span><br><span class="line">java-sleep.noarch                           2.1-6.el6                  epel     </span><br><span class="line">java-sleep-javadoc.noarch                   2.1-6.el6                  epel     </span><br><span class="line">java_cup.noarch                             1:0.11a-16.el7             base     </span><br><span class="line">java_cup-javadoc.noarch                     1:0.11a-16.el7             base     </span><br><span class="line">java_cup-manual.noarch                      1:0.11a-16.el7             base     </span><br><span class="line">javacc.noarch                               5.0-10.el7                 base     </span><br><span class="line">javacc-demo.noarch                          5.0-10.el7                 base     </span><br><span class="line">javacc-javadoc.noarch                       5.0-10.el7                 base     </span><br><span class="line">javacc-manual.noarch                        5.0-10.el7                 base     </span><br><span class="line">javacc-maven-plugin.noarch                  2.6-17.el7                 base     </span><br><span class="line">javacc-maven-plugin-javadoc.noarch          2.6-17.el7                 base     </span><br><span class="line">javamail.noarch                             1.4.6-8.el7                base     </span><br><span class="line">javamail-javadoc.noarch                     1.4.6-8.el7                base     </span><br><span class="line">javassist.noarch                            3.16.1-10.el7              base     </span><br><span class="line">javassist-javadoc.noarch                    3.16.1-10.el7              base     </span><br><span class="line">javastroke.x86_64                           0.5.1-33.el6               epel     </span><br><span class="line">javatar.noarch                              2.5-5.el6                  epel     </span><br><span class="line">javatar-javadoc.noarch                      2.5-5.el6                  epel     </span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# yum install -y java-1.8.0-openjdk-devel[root@centos7 ~]# yum install -y java-1.8.0-openjdk-devel        # 我们安装1.8的devel包，这条命令会安装java-1.8.0、java-1.8.0-poenjdk-devel、java-1.8.0-openjdk-headless以及其他相关依赖。</span><br><span class="line"></span><br><span class="line"># openjdk是The OpenJDK runtime environment，只有运行环境; openjdk-devel是The OpenJDK development tools,是开发工具包组。所以我们来安装openjdk-devel，这样有一系列的开发工具包组可供使用。</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# java -version         # 安装完成后可以查看java版本；</span><br><span class="line">openjdk version &quot;1.8.0_102&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_102-b14)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.102-b14, mixed mode)</span><br></pre></td></tr></table></figure><h4 id="安装-Oracle-的-JDK-8"><a href="#安装-Oracle-的-JDK-8" class="headerlink" title="安装 Oracle 的 JDK 8"></a>安装 Oracle 的 JDK 8</h4><p>Oracle官方也有对应的JRE和JDK。可以去官网下载：<a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</a></p><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Install-1.gif" title="下载JDK"></center><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# ls</span><br><span class="line">jdk-8u151-linux-x64.rpm</span><br><span class="line">[root@centos7 ~]# rpm -ivh jdk-8u151-linux-x64.rpm          # 用rpm命令安装</span><br><span class="line">Preparing...                          ################################# [100%]</span><br><span class="line">Updating / installing...</span><br><span class="line">   1:jdk1.8-2000:1.8.0_151-fcs        ################################# [100%]</span><br><span class="line">Unpacking JAR files...</span><br><span class="line">tools.jar...</span><br><span class="line">plugin.jar...</span><br><span class="line">javaws.jar...</span><br><span class="line">deploy.jar...</span><br><span class="line">rt.jar...</span><br><span class="line">jsse.jar...</span><br><span class="line">charsets.jar...</span><br><span class="line">localedata.jar...</span><br></pre></td></tr></table></figure><h5 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# rpm -ql jdk       # 因为我们是自行下载的rpm包，所以系统并没有记录；</span><br><span class="line">package jdk is not installed</span><br><span class="line">[root@centos7 ~]# cd /usr/java/     </span><br><span class="line">[root@centos7 java]# ll             # 默认安装在/usr/java目录下；</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root  16 Nov  4 09:05 default -&gt; /usr/java/latest</span><br><span class="line">drwxr-xr-x 9 root root 268 Nov  4 09:05 jdk1.8.0_151</span><br><span class="line">lrwxrwxrwx 1 root root  22 Nov  4 09:05 latest -&gt; /usr/java/jdk1.8.0_151</span><br><span class="line">[root@centos7 java]# vim /etc/profile.d/java.sh             # 编写环境变量；</span><br><span class="line">export JAVA_HOME=/usr/java/latest</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">[root@centos7 java]# source  /etc/profile.d/java.sh         # 同步到当前终端；</span><br><span class="line">[root@centos7 ~]# java -version             # 查看版本；</span><br><span class="line">java version &quot;1.8.0_151&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_151-b12)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.151-b12, mixed mode)</span><br></pre></td></tr></table></figure><h3 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h3><p><code>Tomcat</code>服务器是一个免费的开放源代码的<code>Web</code> 应用服务器，<code>Tomcat</code>是<code>Apache</code> 软件基金会（<code>Apache Software Foundation</code>）的<code>Jakarta</code> 项目中的一个核心项目：<a href="http://tomcat.apache.org/" target="_blank" rel="noopener">官网：tomcat.apache.org</a>，它的项目名称为<code>catalina</code>，后来由<code>Apache</code>、<code>Sun</code> 和其他一些公司及个人共同开发而成，因为在<code>O’Reilly</code>家出的书的封面是一只汤姆猫，所以软件更名为<code>Tomcat</code>。<code>Tomcat</code> 是一个小型的轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试JSP 程序的首选，因为<code>Tomcat</code> 技术先进、性能稳定，成为目前比较流行的<code>Web</code> 应用服务器。Tomcat是应用（<code>java</code>）服务器，它只是一个<code>servlet</code>容器，是<code>Apache</code>的扩展，但它是独立运行的。</p><h3 id="Tomcat架构"><a href="#Tomcat架构" class="headerlink" title="Tomcat架构"></a>Tomcat架构</h3><center><img src="https://houhaiyun.github.io/img/images/Tomcat-Install-2.png" title="Tomcat架构"></center><p>Tomcat由一组嵌套的层次和组件组成，一般可分为以下四类：</p><ul><li>顶级组件：位于配置层次的顶级，并且彼此间有着严格的对应关系；</li><li>连接器：连接客户端（可以是浏览器或Web服务器）请求至Servlet容器，</li><li>容器：包含一组其它组件；</li><li>被嵌套的组件：位于一个容器当中，但不能包含其它组件；</li></ul><h4 id="各常见组件："><a href="#各常见组件：" class="headerlink" title="各常见组件："></a>各常见组件：</h4><ol><li><p>服务器(server)：Tomcat的一个实例，通常一个JVM只能包含一个Tomcat实例；因此，一台物理服务器上可以在启动多个JVM的情况下在每一个JVM中启动一个Tomcat实例，每个实例分属于一个独立的管理端口。这是一个顶级组件。</p></li><li><p>服务(service)：一个服务组件通常包含一个引擎和与此引擎相关联的一个或多个连接器。给服务命名可以方便管理员在日志文件中识别不同服务产生的日志。一个server可以包含多个service组件，但通常情下只为一个service指派一个server。</p></li></ol><h4 id="连接器类组件"><a href="#连接器类组件" class="headerlink" title="连接器类组件"></a>连接器类组件</h4><ol start="3"><li>连接器(connectors)：负责连接客户端（可以是浏览器或Web服务器）请求至Servlet容器内的Web应用程序，通常指的是接收客户发来请求的位置及服务器端分配的端口。默认端口通常是HTTP协议的8080，管理员也可以根据自己的需要改变此端口。一个引擎可以配置多个连接器，但这些连接器必须使用不同的端口。默认的连接器是基于HTTP/1.1的Coyote。同时，Tomcat也支持AJP、JServ和JK2连接器。</li></ol><h4 id="容器类组件"><a href="#容器类组件" class="headerlink" title="容器类组件"></a>容器类组件</h4><ol start="4"><li><p>引擎(Engine)：引擎通是指处理请求的Servlet引擎组件，即Catalina Servlet引擎，它检查每一个请求的HTTP首部信息以辨别此请求应该发往哪个host或context，并将请求处理后的结果返回的相应的客户端。严格意义上来说，容器不必非得通过引擎来实现，它也可以是只是一个容器。如果Tomcat被配置成为独立服务器，默认引擎就是已经定义好的引擎。而如果Tomcat被配置为Apache Web服务器的提供Servlet功能的后端，默认引擎将被忽略，因为Web服务器自身就能确定将用户请求发往何处。一个引擎可以包含多个host组件。</p></li><li><p>主机(Host)：主机组件类似于Apache中的虚拟主机，但在Tomcat中只支持基于FQDN的“虚拟主机”。一个引擎至少要包含一个主机组件。</p></li><li><p>上下文(Context)：Context组件是最内层次的组件，它表示Web应用程序本身。配置一个Context最主要的是指定Web应用程序的根目录，以便Servlet容器能够将用户请求发往正确的位置。Context组件也可包含自定义的错误页，以实现在用户访问发生错误时提供友好的提示信息。</p></li></ol><h4 id="被嵌套类-nested-组件"><a href="#被嵌套类-nested-组件" class="headerlink" title="被嵌套类(nested)组件"></a>被嵌套类(nested)组件</h4><p>这类组件通常包含于容器类组件中以提供具有管理功能的服务，它们不能包含其它组件，但有些却可以由不同层次的容器各自配置。</p><ol start="7"><li><p>阀门(Valve)：用来拦截请求并在将其转至目标之前进行某种处理操作，类似于Servlet规范中定义的过滤器。Valve可以定义在任何容器类的组件中。Valve常被用来记录客户端请求、客户端IP地址和服务器等信息，这种处理技术通常被称作请求转储(request dumping)。请求转储valve记录请求客户端请求数据包中的HTTP首部信息和cookie信息文件中，响应转储valve则记录响应数据包首部信息和cookie信息至文件中。</p></li><li><p>日志记录器(Logger)：用于记录组件内部的状态信息，可被用于除Context之外的任何容器中。日志记录的功能可被继承，因此，一个引擎级别的Logger将会记录引擎内部所有组件相关的信息，除非某内部组件定义了自己的Logger组件。</p></li><li><p>领域(Realm)：用于用户的认证和授权；在配置一个应用程序时，管理员可以为每个资源或资源组定义角色及权限，而这些访问控制功能的生效需要通过Realm来实现。Realm的认证可以基于文本文件、数据库表、LDAP服务等来实现。Realm的效用会遍及整个引擎或顶级容器，因此，一个容器内的所有应用程序将共享用户资源。同时，Realm可以被其所在组件的子组件继承，也可以被子组件中定义的Realm所覆盖。<br>引擎(Engine)：引擎是指处理请求的Servlet引擎组件，即Catalina Servlet引擎，它从HTTPconnector接收请求并响应请求。它检查每一个请求的HTTP首部信息以辨别此请求应该发往哪个host或context，并将请求处理后的结果返回的相应的客户端。严格意义上来说，容器不必非得通过引擎来实现，它也可以是只是一个容器。如果Tomcat被配置成为独立服务器，默认引擎就是已经定义好的引擎。而如果Tomcat被配置为Apache Web服务器的提供Servlet功能的后端，默认引擎将被忽略，因为Web服务器自身就能确定将用户请求发往何处。一个引擎可以包含多个host组件。</p></li></ol><h3 id="安装Tomcat"><a href="#安装Tomcat" class="headerlink" title="安装Tomcat"></a>安装Tomcat</h3><h4 id="yum方式安装tomcat"><a href="#yum方式安装tomcat" class="headerlink" title="yum方式安装tomcat"></a>yum方式安装tomcat</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# yum install tomcat tomcat-admin-webapps tomcat-webapps tomcat-docs-webapp     # 注意：yum安装tomcat时记得把epel源，给关闭否则会发生冲突</span><br><span class="line">。。。省略部分信息</span><br><span class="line">Installed:</span><br><span class="line">  tomcat.noarch 0:7.0.69-10.el7                tomcat-admin-webapps.noarch 0:7.0.69-10.el7   </span><br><span class="line">  tomcat-docs-webapp.noarch 0:7.0.69-10.el7    tomcat-webapps.noarch 0:7.0.69-10.el7         </span><br><span class="line"></span><br><span class="line">Dependency Installed:</span><br><span class="line">  apache-commons-collections.noarch 0:3.2.1-22.el7_2                                         </span><br><span class="line">  apache-commons-daemon.x86_64 0:1.0.13-6.el7                                                </span><br><span class="line">  apache-commons-dbcp.noarch 0:1.4-17.el7                                                    </span><br><span class="line">  apache-commons-logging.noarch 0:1.1.2-7.el7                                                </span><br><span class="line">  apache-commons-pool.noarch 0:1.6-9.el7                                                     </span><br><span class="line">  avalon-framework.noarch 0:4.3-10.el7                                                       </span><br><span class="line">  avalon-logkit.noarch 0:2.1-14.el7                                                          </span><br><span class="line">  ecj.x86_64 1:4.2.1-8.el7                                                                   </span><br><span class="line">  geronimo-jms.noarch 0:1.1.1-19.el7                                                         </span><br><span class="line">  geronimo-jta.noarch 0:1.1.1-17.el7                                                         </span><br><span class="line">  jakarta-taglibs-standard.noarch 0:1.1.2-14.el7_1                                           </span><br><span class="line">  javamail.noarch 0:1.4.6-8.el7                                                              </span><br><span class="line">  log4j.noarch 0:1.2.17-15.el7                                                               </span><br><span class="line">  tomcat-el-2.2-api.noarch 0:7.0.69-10.el7                                                   </span><br><span class="line">  tomcat-jsp-2.2-api.noarch 0:7.0.69-10.el7                                                  </span><br><span class="line">  tomcat-lib.noarch 0:7.0.69-10.el7                                                          </span><br><span class="line">  tomcat-servlet-3.0-api.noarch 0:7.0.69-10.el7                                              </span><br><span class="line">  xalan-j2.noarch 0:2.7.1-23.el7                                                             </span><br><span class="line">  xerces-j2.noarch 0:2.11.0-17.el7_0                                                         </span><br><span class="line">  xml-commons-apis.noarch 0:1.4.01-16.el7                                                    </span><br><span class="line">  xml-commons-resolver.noarch 0:1.2-15.el7    </span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# systemctl start tomcat.service        # 安装直接启动tomcat；</span><br><span class="line">[root@centos7 ~]# jps       # 专门用来查看java进程的；</span><br><span class="line">2340 Bootstrap</span><br><span class="line">2409 Jps</span><br><span class="line">    </span><br><span class="line">[root@centos7 ~]# jps -v        # 查看详细过程；</span><br><span class="line">2340 Bootstrap -Dcatalina.base=/usr/share/tomcat -Dcatalina.home=/usr/share/tomcat -Djava.endorsed.dirs= -Djava.io.tmpdir=/var/cache/tomcat/temp -Djava.util.logging.config.file=/usr/share/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager</span><br><span class="line">2421 Jps -Dapplication.home=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.102-4.b14.el7.x86_64 -Xms8m</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# ss -tnlp          # 端口分别为，8080：http协议接口，8009：AJP协议接口，9005管理接口；</span><br><span class="line">State       Recv-Q Send-Q Local Address:Port                Peer Address:Port              </span><br><span class="line">LISTEN      0      128                *:22                             *:*                   users:((&quot;sshd&quot;,pid=852,fd=3))</span><br><span class="line">LISTEN      0      100        127.0.0.1:25                             *:*                   users:((&quot;master&quot;,pid=1275,fd=13))</span><br><span class="line">LISTEN      0      100               :::8080                          :::*                   users:((&quot;java&quot;,pid=2340,fd=49))</span><br><span class="line">LISTEN      0      128               :::22                            :::*                   users:((&quot;sshd&quot;,pid=852,fd=4))</span><br><span class="line">LISTEN      0      100              ::1:25                            :::*                   users:((&quot;master&quot;,pid=1275,fd=14))</span><br><span class="line">LISTEN      0      1       ::ffff:127.0.0.1:8005                          :::*                   users:((&quot;java&quot;,pid=2340,fd=54))</span><br><span class="line">LISTEN      0      100               :::8009                          :::*                   users:((&quot;java&quot;,pid=2340,fd=50))</span><br></pre></td></tr></table></figure><h4 id="二进制方式安装"><a href="#二进制方式安装" class="headerlink" title="二进制方式安装"></a>二进制方式安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# wget http://mirrors.hust.edu.cn/apache/tomcat/tomcat-7/v7.0.82/bin/apache-tomcat-7.0.82.tar.gz</span><br><span class="line">--2017-11-04 14:14:50--  http://mirrors.hust.edu.cn/apache/tomcat/tomcat-7/v7.0.82/bin/apache-tomcat-7.0.82.tar.gz</span><br><span class="line">Resolving mirrors.hust.edu.cn (mirrors.hust.edu.cn)... 202.114.18.160</span><br><span class="line">Connecting to mirrors.hust.edu.cn (mirrors.hust.edu.cn)|202.114.18.160|:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 8997403 (8.6M) [application/octet-stream]</span><br><span class="line">Saving to: ‘apache-tomcat-7.0.82.tar.gz’</span><br><span class="line"></span><br><span class="line">100%[===================================================&gt;] 8,997,403   4.43MB/s   in 1.9s   </span><br><span class="line"></span><br><span class="line">2017-11-04 14:14:52 (4.43 MB/s) - ‘apache-tomcat-7.0.82.tar.gz’ saved [8997403/8997403]</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# tar xf apache-tomcat-7.0.82.tar.gz -C /usr/local/</span><br><span class="line">[root@centos7 ~]# cd /usr/local/</span><br><span class="line">[root@centos7 local]# ls</span><br><span class="line">apache-tomcat-7.0.82  bin  etc  games  include  lib  lib64  libexec  sbin  share  src</span><br><span class="line">[root@centos7 local]# ln -sv apache-tomcat-7.0.82/ tomcat</span><br><span class="line">‘tomcat’ -&gt; ‘apache-tomcat-7.0.82/’</span><br><span class="line">[root@centos7 local]# ls</span><br><span class="line">apache-tomcat-7.0.82  etc    include  lib64    sbin   src</span><br><span class="line">bin                   games  lib      libexec  share  tomcat</span><br><span class="line">[root@centos7 local]# cd tomcat</span><br><span class="line">[root@centos7 tomcat]# ll</span><br><span class="line">total 96</span><br><span class="line">drwxr-xr-x 2 root root  4096 Nov  4 14:15 bin</span><br><span class="line">drwxr-xr-x 2 root root   158 Sep 29 20:27 conf</span><br><span class="line">drwxr-xr-x 2 root root  4096 Nov  4 14:15 lib</span><br><span class="line">-rw-r--r-- 1 root root 56846 Sep 29 20:27 LICENSE</span><br><span class="line">drwxr-xr-x 2 root root     6 Sep 29 20:23 logs</span><br><span class="line">-rw-r--r-- 1 root root  1239 Sep 29 20:27 NOTICE</span><br><span class="line">-rw-r--r-- 1 root root  8965 Sep 29 20:27 RELEASE-NOTES</span><br><span class="line">-rw-r--r-- 1 root root 16195 Sep 29 20:27 RUNNING.txt</span><br><span class="line">drwxr-xr-x 2 root root    30 Nov  4 14:15 temp</span><br><span class="line">drwxr-xr-x 7 root root    81 Sep 29 20:26 webapps</span><br><span class="line">drwxr-xr-x 2 root root     6 Sep 29 20:23 work</span><br><span class="line">[root@centos7 tomcat]# useradd -r tomcat</span><br><span class="line">[root@centos7 tomcat]# chown -R tomcat.tomcat ./* </span><br><span class="line">[root@centos7 tomcat]# ll</span><br><span class="line">total 96</span><br><span class="line">drwxr-xr-x 2 tomcat tomcat  4096 Nov  4 14:15 bin</span><br><span class="line">drwxrwxr-x 3 tomcat tomcat   174 Nov  4 14:23 conf</span><br><span class="line">drwxr-xr-x 2 tomcat tomcat  4096 Nov  4 14:15 lib</span><br><span class="line">-rw-r--r-- 1 tomcat tomcat 56846 Sep 29 20:27 LICENSE</span><br><span class="line">drwxrwxr-x 2 tomcat tomcat   197 Nov  4 14:23 logs</span><br><span class="line">-rw-r--r-- 1 tomcat tomcat  1239 Sep 29 20:27 NOTICE</span><br><span class="line">-rw-r--r-- 1 tomcat tomcat  8965 Sep 29 20:27 RELEASE-NOTES</span><br><span class="line">-rw-r--r-- 1 tomcat tomcat 16195 Sep 29 20:27 RUNNING.txt</span><br><span class="line">drwxrwxr-x 2 tomcat tomcat    30 Nov  4 14:15 temp</span><br><span class="line">drwxr-xr-x 7 tomcat tomcat    81 Sep 29 20:26 webapps</span><br><span class="line">drwxrwxr-x 3 tomcat tomcat    22 Nov  4 14:23 work</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# su - tomcat -c &apos;catalina.sh start&apos;</span><br><span class="line">su: warning: cannot change directory to /home/tomcat: No such file or directory</span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /usr/java/latest</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line">[root@centos7 tomcat]# ss -tnul         # 端口已经打开；</span><br><span class="line">Netid  State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">udp    UNCONN     0      0               *:14630                       *:*                  </span><br><span class="line">udp    UNCONN     0      0       127.0.0.1:323                         *:*                  </span><br><span class="line">udp    UNCONN     0      0               *:68                          *:*                  </span><br><span class="line">udp    UNCONN     0      0             ::1:323                        :::*                  </span><br><span class="line">udp    UNCONN     0      0              :::24928                      :::*                  </span><br><span class="line">tcp    LISTEN     0      128             *:22                          *:*                  </span><br><span class="line">tcp    LISTEN     0      100     127.0.0.1:25                          *:*                  </span><br><span class="line">tcp    LISTEN     0      100            :::8080                       :::*                  </span><br><span class="line">tcp    LISTEN     0      128            :::22                         :::*                  </span><br><span class="line">tcp    LISTEN     0      100           ::1:25                         :::*                  </span><br><span class="line">tcp    LISTEN     0      1        ::ffff:127.0.0.1:8005                       :::*                  </span><br><span class="line">tcp    LISTEN     0      100            :::8009                       :::*            </span><br><span class="line">[root@centos7 tomcat]# ps aux | grep java       # 运行身份也为tomcat；</span><br><span class="line">tomcat    13683  3.6  8.0 2745508 80984 ?       Sl   14:40   0:03 /usr/java/latest/bin/java -Djava.util.logging.config.file=/usr/local/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.endorsed.dirs=/usr/local/tomcat/endorsed -classpath /usr/local/tomcat/bin/bootstrap.jar:/usr/local/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/usr/local/tomcat -Dcatalina.home=/usr/local/tomcat -Djava.io.tmpdir=/usr/local/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br></pre></td></tr></table></figure><h3 id="tomcat目录结构"><a href="#tomcat目录结构" class="headerlink" title="tomcat目录结构"></a>tomcat目录结构</h3><ul><li><code>bin</code>：脚本，及启动时用到的类。</li><li><code>conf</code>：配置文件目录。</li><li><code>lib</code>：库文件，Java类库，jar。</li><li><code>logs</code>：日志文件目录。</li><li><code>temp</code>：临时文件目录。</li><li><code>webapps</code>：webapp的默认目录。</li><li><code>work</code>：工作目录。存放编译后的字节码文件。</li></ul><h4 id="tomcat的配置文件构成："><a href="#tomcat的配置文件构成：" class="headerlink" title="tomcat的配置文件构成："></a>tomcat的配置文件构成：</h4><ul><li><code>server.xml</code>：主配置文件；</li><li><code>web.xml</code>：每个webapp只有“部署”后才能被访问，它的部署方式通常由web.xml进行定义，其存放位置为WEB-INF/目录中；此文件为所有的webapps提供默认部署相关的配置；</li><li><code>context.xml</code>：每个webapp都可以使用的配置文件，它通常由专用的配置文件context.xml来定义，其存放位置为WEB-INF/目录中；此文件为所有的webapps提供默认配置；</li><li><code>tomcat-users.xml</code>：用户认证的账号和密码文件；角色（role），用户（User）；此文件在tomcat启动时被装入内存；</li><li><code>catalina.policy</code>：当使用-security选项启动tomcat时，用于为tomcat设置安全策略； </li><li><code>catalina.properties</code>：Java属性的定义文件，用于设定类加载器路径，以及一些与JVM调优相关参数；</li><li><code>logging.properties</code>：日志系统相关的配置；    </li></ul><h4 id="JSP-Webapp的组织结构"><a href="#JSP-Webapp的组织结构" class="headerlink" title="JSP Webapp的组织结构"></a>JSP Webapp的组织结构</h4><p>webapps的根目录：</p><ul><li><code>index.jsp</code>：主页；</li><li><code>WEB-INF/</code>：当前webapp的私有资源路径；通常用于存储当前webapp的web.xml和context.xml配置文件；</li><li><code>META-INF/</code>：类似于WEB-INF/；</li><li><code>classes/</code>：类文件，当前webapp所提供的类；</li><li><code>lib/</code>：类文件，当前webapp所提供的类，被打包为jar格式；</li></ul><p>webapp归档格式：</p><ul><li><code>.war</code>：webapp</li><li><code>.jar</code>：EJB的类打包文件；</li><li><code>.rar</code>：资源适配器类打包文件；</li><li><code>.ear</code>：企业级webapp；</li></ul><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://developer.51cto.com/art/200907/134616.htm" target="_blank" rel="noopener">详解Java Servlet与Applet比较：http://developer.51cto.com/art/200907/134616.htm</a></p><p><a href="http://www.yulongjun.com/linux/20170830-01-tomcat-basic/" target="_blank" rel="noopener">Tomcat基础知识：http://www.yulongjun.com/linux/20170830-01-tomcat-basic/</a></p><p><a href="http://www.cnblogs.com/dycg/archive/2012/12/11/2813903.html" target="_blank" rel="noopener">Tomcat的架构：http://www.cnblogs.com/dycg/archive/2012/12/11/2813903.html</a></p>]]></content>
      
      <categories>
          
          <category> TOMCAT </category>
          
          <category> 安装tomcat </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>HAProxy支持https协议</title>
      <link href="/2017/11/05/Haproxy-Https/"/>
      <url>/2017/11/05/Haproxy-Https/</url>
      <content type="html"><![CDATA[<h3 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h3><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# cd /etc/pki/tls/certs/</span><br><span class="line">[root@HAProxy certs]# make /etc/haproxy/haproxy.pem</span><br><span class="line">umask 77 ; \</span><br><span class="line">PEM1=`/bin/mktemp /tmp/openssl.XXXXXX` ; \</span><br><span class="line">PEM2=`/bin/mktemp /tmp/openssl.XXXXXX` ; \</span><br><span class="line">/usr/bin/openssl req -utf8 -newkey rsa:2048 -keyout $PEM1 -nodes -x509 -days 365 -out $PEM2 -set_serial 0 ; \</span><br><span class="line">cat $PEM1 &gt;  /etc/haproxy/haproxy.pem ; \</span><br><span class="line">echo &quot;&quot;    &gt;&gt; /etc/haproxy/haproxy.pem ; \</span><br><span class="line">cat $PEM2 &gt;&gt; /etc/haproxy/haproxy.pem ; \</span><br><span class="line">rm -f $PEM1 $PEM2</span><br><span class="line">Generating a 2048 bit RSA private key</span><br><span class="line">....+++</span><br><span class="line">..............................................................................................................................................+++</span><br><span class="line">writing new private key to &apos;/tmp/openssl.2c99KA&apos;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:BJ</span><br><span class="line">Locality Name (eg, city) [Default City]:haidian</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:haiyun</span><br><span class="line">Organizational Unit Name (eg, section) []:opt</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:www.ihaiyun.cc</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg      # 修改配置文件；</span><br><span class="line">frontend https</span><br><span class="line">    bind *:80</span><br><span class="line">    bind *:443 ssl crt /etc/haproxy/haproxy.pem     # 指定启用ssl和证书文件路径；</span><br><span class="line">    default_backend websrvs</span><br><span class="line"></span><br><span class="line">backend websrvs</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check</span><br><span class="line">    </span><br><span class="line">[root@HAProxy ~]# service  haproxy restart          # 重启服务；</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11         # 测试访问，加密和不加密都可以；</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl -k https://192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl -k https://192.168.8.11</span><br><span class="line">web2</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Haproxy-Https-1.gif" title="测试访问"></center><h3 id="把80端口的请求重定向到443"><a href="#把80端口的请求重定向到443" class="headerlink" title="把80端口的请求重定向到443"></a>把80端口的请求重定向到443</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg      # 修改配置文件；</span><br><span class="line">frontend https</span><br><span class="line">    bind *:80</span><br><span class="line">    bind *:443 ssl crt /etc/haproxy/haproxy.pem</span><br><span class="line">    default_backend websrvs</span><br><span class="line">    redirect scheme https if !&#123; ssl_fc &#125;        # 加入此项；</span><br><span class="line"></span><br><span class="line">backend websrvs</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service  haproxy restart          # 重启服务；</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl -kL  192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl -kL  192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl -I  192.168.8.11         # 查看头部已经被重定向到https；</span><br><span class="line">HTTP/1.1 302 Found</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Content-length: 0</span><br><span class="line">Location: https://192.168.8.11/</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><h3 id="向后端传递用户请求的协议和端口（frontend或backend）"><a href="#向后端传递用户请求的协议和端口（frontend或backend）" class="headerlink" title="向后端传递用户请求的协议和端口（frontend或backend）"></a>向后端传递用户请求的协议和端口（frontend或backend）</h3><p><code>http_request set-header X-Forwarded-Port%[dst_port]</code></p><p><code>http_request add-header X-Forwared-Proto httpsif { ssl_fc }</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg      # 修改配置文件；</span><br><span class="line">frontend https</span><br><span class="line">    bind *:80</span><br><span class="line">    bind *:443 ssl crt /etc/haproxy/haproxy.pem</span><br><span class="line">    default_backend websrvs</span><br><span class="line">    redirect scheme https if !&#123; ssl_fc &#125;</span><br><span class="line">    http-request set-header X-Forwared-Port %[dst_port]         # 加入此项；</span><br><span class="line"></span><br><span class="line">backend websrvs</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check</span><br><span class="line"></span><br><span class="line">[root@web1 html]# vim /etc/httpd/conf/httpd.conf        # 修改后端http日志；</span><br><span class="line">    LogFormat &quot; %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;%&#123;X-Forwared-Port&#125;i&quot; haproxy</span><br><span class="line">    CustomLog &quot;logs/access_log&quot; haproxy</span><br><span class="line">    </span><br><span class="line">[root@web1 html]# systemctl restart httpd</span><br><span class="line">[root@HAProxy ~]# curl -kL 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl -kL 192.168.8.11</span><br><span class="line">web1</span><br><span class="line"></span><br><span class="line">[root@web1 html]# tail -1 /var/log/httpd/access_log         # 查看日志端口号已经记录；</span><br><span class="line"> 192.168.8.11 - - [02/Nov/2017:15:43:45 +0800] &quot;GET / HTTP/1.1&quot; 200 5 &quot;-&quot; &quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;443</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 负载均衡 </category>
          
          <category> HAProxy支持https协议 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Haproxy </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>HAProxy四层TCP代理</title>
      <link href="/2017/11/05/Haproxy-TCP-Proxy/"/>
      <url>/2017/11/05/Haproxy-TCP-Proxy/</url>
      <content type="html"><![CDATA[<h3 id="格式如下"><a href="#格式如下" class="headerlink" title="格式如下"></a>格式如下</h3><p>根据第4层条件对传入连接执行操作<br><code>tcp-request connection {accept|reject} [{if | unless}&lt;condition&gt;]</code></p><h3 id="实现对mysql-3306-的代理"><a href="#实现对mysql-3306-的代理" class="headerlink" title="实现对mysql(3306)的代理"></a>实现对mysql(3306)的代理</h3><a id="more"></a><h4 id="环境部署"><a href="#环境部署" class="headerlink" title="环境部署"></a>环境部署</h4><p>192.168.8.12(<code>centos7.3</code>)和192.168.8.13(<code>centos6.9</code>)是我们的<code>real server</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@web1 html]# yum install -y mariadb-server     # web1就代表192.168.8.12</span><br><span class="line">[root@web1 html]# systemctl start mariadb</span><br><span class="line">[root@web1 html]# mysql</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 2</span><br><span class="line">Server version: 5.5.52-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; GRANT ALL ON test.* TO &apos;test&apos;@&apos;192.168.8.11&apos; IDENTIFIED BY &apos;test&apos;         # 授权并创建用户test；</span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@web2 html]# yum install -y mysql-server</span><br><span class="line">[root@web2 html]# service mysqld start</span><br><span class="line">Starting mysqld:                                           [  OK  ]</span><br><span class="line">[root@web2 html]# mysql</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.1.73 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT ALL ON test.* TO &apos;test&apos;@&apos;192.168.8.11&apos; IDENTIFIED BY &apos;test&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# mysql -utest -ptest -h192.168.8.12        # 在本机直接连接192.168.8.12，ok；</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.5.52-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; Bye</span><br><span class="line">[root@HAProxy ~]# mysql -utest -ptest -h192.168.8.13        # 在本机直接连接192.168.8.13，ok；</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.1.73 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; Bye</span><br></pre></td></tr></table></figure><h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend mysql</span><br><span class="line">    bind *:3306</span><br><span class="line">    mode tcp            # 模式改为tcp，切记；</span><br><span class="line">    default_backend mysqlsrv</span><br><span class="line"></span><br><span class="line">backend mysqlsrv</span><br><span class="line">    mode tcp            # 模式改为tcp，切记；</span><br><span class="line">    server sql1 192.168.8.12:3306</span><br><span class="line">    server sql2 192.168.8.13:3306</span><br><span class="line">[root@HAProxy ~]# service  haproxy restart          # 重启服务</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# mysql -utest -ptest -h192.168.8.11</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 6</span><br><span class="line">Server version: 5.1.73 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like &apos;hostname&apos; ;         # 连接到192.168.8.13上面了；</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| hostname      | web2  |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; Bye</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# mysql -utest -ptest -h192.168.8.11</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.5.52-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like &apos;hostname&apos;;      # 连接到192.168.8.12上面了；</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| hostname      | web1  |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 负载均衡 </category>
          
          <category> HAProxy四层TCP代理 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Haproxy </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>HAPoxy-ACL</title>
      <link href="/2017/11/05/Haproxy-configure-ACL/"/>
      <url>/2017/11/05/Haproxy-configure-ACL/</url>
      <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><code>acl</code>：访问控制列表（<code>ACL</code>）的使用提供了一个灵活的解决方案来执行内容交换，并且通常基于从请求中提取的内容、响应或任何环境状态进行决策</p><a id="more"></a><h3 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h3><p><code>acl &lt;aclname&gt; &lt;criterion&gt; [flags] [operator] [&lt;value&gt;]...</code></p><ul><li><code>&lt;aclname&gt;</code>： <code>ACL</code>名称，可使用字母 数字 :<code>. - _</code>区分字符大小写</li><li><code>&lt;criterion&gt;</code>： 比较的标准和条件<ul><li><code>dst</code> 目标<code>IP</code></li><li><code>dst_port</code> 目标<code>PORT</code></li><li><code>src</code> 源<code>IP</code></li><li><code>src_port</code> 源<code>PORT</code></li></ul></li><li><code>&lt;flags&gt;</code><ul><li><code>-i</code> 不区分大小写</li><li><code>-m</code> 使用指定的<code>pattern</code>匹配方法</li><li><code>-n</code> 不做<code>DNS</code>解析</li><li><code>-u</code> 强制每个<code>ACL</code>必须唯一<code>ID</code>，否则多个同名<code>ACL</code>或关系</li><li><code>--</code> 强制<code>flag</code>结束. 当字符串和某个<code>flag</code>相似时使用</li></ul></li><li><code>[operator]</code><ul><li>匹配整数值： <code>eq</code>、 <code>ge</code>、 <code>gt</code>、 <code>le</code>、 <code>lt</code></li><li>匹配字符串：<ul><li><code>- exact match (-m str)</code> :字符串必须完全匹配模式</li><li><code>- substring match (-m sub)</code> :在提取的字符串中查找模式，如果其中任何一个被发现， <code>ACL</code>将匹配</li><li><code>- prefix match (-m beg)</code> :在提取的字符串首部中查找模式，如果其中任何一个被发现， <code>ACL</code>将匹配</li><li><code>- suffix match (-m end)</code> :将模式与提取字符串的尾部进行比较，如果其中任何一个匹配，则<code>ACL</code>进行匹配</li><li><code>- subdir match (-m dir)</code> :查看提取出来的用斜线分隔（<code>“/”</code>）的字符串， 如果其中任何一个匹配，则<code>ACL</code>进行匹配</li><li><code>- domain match (-m dom)</code> :查找提取的用点（<code>“.”</code>）分隔字符串，如果其中任何一个匹配，则<code>ACL</code>进行匹配</li></ul></li></ul></li><li><code>acl</code>作为条件时的逻辑关系：<ul><li>与：隐式（默认）使用</li><li>或：使用<code>“or”</code>或 <code>“||”</code>表示</li><li>否定：使用<code>“!“</code> 表示</li><li>示例： <code>if invalid_src invalid_port</code> 与关系</li><li><code>if invalid_src || invalid_port</code> 或</li><li><code>if ! invalid_src</code> 非</li></ul></li></ul><h4 id="base-string"><a href="#base-string" class="headerlink" title="base : string"></a><code>base : string</code></h4><p>返回第一个主机头和请求的路径部分的连接，该请求从第一个斜杠开始，并在问号之前结束,对虚拟主机有用</p><p><code>&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;</code></p><ul><li><code>base : exact string match</code></li><li><code>base_beg : prefix match</code></li><li><code>base_dir : subdir match</code></li><li><code>base_dom : domain match</code></li><li><code>base_end : suffix match</code></li><li><code>base_len : length match</code></li><li><code>base_reg : regex match</code></li><li><code>base_sub : substring match</code></li></ul><h4 id="path-string"><a href="#path-string" class="headerlink" title="path : string"></a><code>path : string</code></h4><p>提取请求的<code>URL</code>路径，该路径从第一个斜杠开始，并在问号之前结束（无主机部分）</p><p><code>&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;</code></p><ul><li><code>path : exact string match</code></li><li><code>path_beg : prefix match</code></li><li><code>path_dir : subdir match</code></li><li><code>path_dom : domain match</code></li><li><code>path_end : suffix match</code></li><li><code>path_len : length match</code></li><li><code>path_reg : regex match</code></li><li><code>path_sub : substring match</code></li></ul><h4 id="url-string"><a href="#url-string" class="headerlink" title="url : string"></a><code>url</code> : <code>string</code></h4><p>提取请求中的<code>URL</code>。 一个典型的应用是具有预取能力的缓存，以及需要从数据库聚合多个信息并将它们保存在缓存中的网页门户入口</p><ul><li><code>url : exact string match</code></li><li><code>url_beg : prefix match</code></li><li><code>url_dir : subdir match</code></li><li><code>url_dom : domain match</code></li><li><code>url_end : suffix match</code></li><li><code>url_len : length match</code></li><li><code>url_reg : regex match</code></li><li><code>url_sub : substring match</code></li></ul><h4 id="req-hdr-lt-name-gt-lt-occ-gt-string"><a href="#req-hdr-lt-name-gt-lt-occ-gt-string" class="headerlink" title="req.hdr([&lt;name&gt;[,&lt;occ&gt;]]) : string"></a><code>req.hdr([&lt;name&gt;[,&lt;occ&gt;]]) : string</code></h4><pre><code>提取在一个HTTP请求报文的首部</code></pre><ul><li><code>hdr([&lt;name&gt;[,&lt;occ&gt;]]) : exact string match</code></li><li><code>hdr_beg([&lt;name&gt;[,&lt;occ&gt;]]) : prefix match</code></li><li><code>hdr_dir([&lt;name&gt;[,&lt;occ&gt;]]) : subdir match</code></li><li><code>hdr_dom([&lt;name&gt;[,&lt;occ&gt;]]) : domain match</code></li><li><code>hdr_end([&lt;name&gt;[,&lt;occ&gt;]]) : suffix match</code></li><li><code>hdr_len([&lt;name&gt;[,&lt;occ&gt;]]) : length match</code></li><li><code>hdr_reg([&lt;name&gt;[,&lt;occ&gt;]]) : regex match</code></li><li><code>hdr_sub([&lt;name&gt;[,&lt;occ&gt;]]) : substring match</code></li></ul><p>示例：</p><ul><li><code>acl bad_curl hdr_sub(User-Agent) -i curl</code></li><li><code>block if bad_curl</code></li><li><code>status</code> : integer 返回在响应报文中的状态码</li></ul><h4 id="预定义ACL"><a href="#预定义ACL" class="headerlink" title="预定义ACL"></a>预定义ACL</h4><p>ACL名称    等价于      说明</p><ul><li><code>TRUE always_true</code> 总是匹配</li><li><code>FALSE always_false</code> 从不匹配</li><li><code>HTTP req_proto_http</code> 匹配HTTP协议</li><li><code>HTTP_1.0 req_ver 1.0</code> 匹配HTTP协议1.0</li><li><code>HTTP_1.1 req_ver 1.1</code> 匹配HTTP协议1.1</li><li><code>HTTP_CONTENT hdr_val(content-length) gt 0</code> 匹配已存在内容长度</li><li><code>HTTP_URL_ABS url_reg ^[^/:]*://</code> 匹配URL绝对路径</li><li><code>HTTP_URL_SLASH url_beg /</code> 匹配URL相对路径</li><li><code>HTTP_URL_STAR url *</code> 匹配 URL 等于 “*”</li><li><code>LOCALHOST src 127.0.0.1/8</code> 匹配从localhost来的连接</li><li><code>METH_CONNECT method CONNECT</code> 匹配HTTP CONNECT方</li></ul><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p><code>use_backend &lt;backend&gt; [{if | unless} &lt;condition&gt;]</code></p><ul><li>当<code>if/unless</code>一个基于ACL的条件匹配时切换指定backend</li><li><code>block { if | unless } &lt;condition&gt;</code> 阻止7层请求if/unless一个条件匹配</li></ul><p>对7层请求的访问控制：<br><code>http-request { allow | deny |add-header &lt;name&gt; &lt;fmt&gt;|set-header &lt;name&gt; &lt;fmt&gt; } [ { if | unless }&lt;condition&gt; ]</code></p><h3 id="基于ACL实现图片和网页文件的分离"><a href="#基于ACL实现图片和网页文件的分离" class="headerlink" title="基于ACL实现图片和网页文件的分离"></a>基于ACL实现图片和网页文件的分离</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">web1：192.168.8.12      用来存放html文件</span><br><span class="line">web2：192.168.8.13      用来存放图片文件</span><br><span class="line"></span><br><span class="line">[root@web2 ~]# locate *.jpg         # 为web2准备图片文件；</span><br><span class="line">/usr/lib/anaconda-runtime/syslinux-vesa-splash.jpg</span><br><span class="line">/usr/share/backgrounds/centos_1920x1200_logoonly.jpg</span><br><span class="line">/usr/share/backgrounds/centos_2048x1536_logoonly.jpg</span><br><span class="line">/usr/share/backgrounds/simple_waves.jpg</span><br><span class="line">/usr/share/wallpapers/CentOS6/contents/images/simple_waves.jpg</span><br><span class="line">[root@web2 ~]# cp /usr/lib/anaconda-runtime/syslinux-vesa-splash.jpg /var/www/html/test.jpg</span><br><span class="line">[root@web2 ~]# cd /var/www/html/</span><br><span class="line">[root@web2 html]# for i in &#123;1..5&#125; ;do echo &quot;web2 &quot;$i&quot;page &quot; &gt; $i.html ;done     # 生成5个html文件；</span><br><span class="line">[root@web2 html]# cat 1.html </span><br><span class="line">web2 1page </span><br><span class="line">[root@web2 html]# curl 192.168.8.13/1.html          # 测试访问1.html，ok</span><br><span class="line">web2 1page</span><br><span class="line"></span><br><span class="line">[root@web1 ~]# cd /var/www/html/</span><br><span class="line">[root@web1 html]# for i in &#123;1..5&#125; ;do echo &quot;web1 &quot;$i&quot;page &quot; &gt; $i.html ;done         # 生成5个html文件；</span><br><span class="line">[root@web1 html]# cat 1.html </span><br><span class="line">web1 1page </span><br><span class="line">[root@web1 html]# curl 192.168.8.12         # 本地测试，ok；</span><br><span class="line">web1</span><br><span class="line">[root@web1 html]# curl 192.168.8.12/1.html</span><br><span class="line">web1 1page </span><br><span class="line">[root@web1 html]# ls                # web1内是没有放图片文件的；</span><br><span class="line">1.html  2.html  3.html  4.html  5.html  index.html</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg              # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    acl static path_end -i .html .css .js .html .txt        # 定义acl，以.html结尾</span><br><span class="line">    acl images path_end -i .jpg .gif .png</span><br><span class="line">    default_backend appser</span><br><span class="line">    use_backend pictureser if images</span><br><span class="line">    use_backend appser if static</span><br><span class="line">    </span><br><span class="line">backend appser</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line"></span><br><span class="line">backend pictureser</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server ser2 192.168.8.13:80 check</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service  haproxy restart </span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Haproxy-configure-ACL-1.gif" title="测试访问"></center><h3 id="基于ACL实现动静分离"><a href="#基于ACL实现动静分离" class="headerlink" title="基于ACL实现动静分离"></a>基于ACL实现动静分离</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">web1：192.168.8.12      用来解析和存放php文件</span><br><span class="line">web2：192.168.8.13      用来存放图片文件</span><br><span class="line"></span><br><span class="line">[root@web1 html]# yum -y install php</span><br><span class="line">[root@web1 html]# systemctl restart httpd</span><br><span class="line">[root@web1 html]# vim test.php      # 编写php测试页面</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg              # 修改配置文件</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    acl static path_end -i .html .css .js .html .txt .jpg .gif .png</span><br><span class="line">    acl php path_end -i  .php</span><br><span class="line">    default_backend staticsrv</span><br><span class="line">    use_backend staticsrv if static</span><br><span class="line">    use_backend phpsrv if php</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">backend phpsrv</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line"></span><br><span class="line">backend staticsrv</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server ser2 192.168.8.13:80 check</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service  haproxy restart </span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Haproxy-configure-ACL-2.gif" title="测试访问"></center>]]></content>
      
      <categories>
          
          <category> 负载均衡 </category>
          
          <category> HAPoxy-ACL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Haproxy </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Haproxy常用配置</title>
      <link href="/2017/11/05/Haproxy-configure/"/>
      <url>/2017/11/05/Haproxy-configure/</url>
      <content type="html"><![CDATA[<h3 id="bind监听多个端口"><a href="#bind监听多个端口" class="headerlink" title="bind监听多个端口"></a>bind监听多个端口</h3><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">listen webser </span><br><span class="line">    bind *:80,:888          # 设置监听两个端口，用逗号分隔，:888代表监听所有iP的888端口</span><br><span class="line">    mode http</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server ser1 192.168.8.12:80</span><br><span class="line">    server ser2 192.168.8.13:80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# ss -tnul          # 80和888端口都已经监听；</span><br><span class="line">Netid State      Recv-Q Send-Q            Local Address:Port              Peer Address:Port </span><br><span class="line">tcp   LISTEN     0      128                           *:80                           *:*     </span><br><span class="line">tcp   LISTEN     0      128                          :::22                          :::*     </span><br><span class="line">tcp   LISTEN     0      128                           *:22                           *:*     </span><br><span class="line">tcp   LISTEN     0      128                           *:888                          *:*     </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11         # 测试，ok；</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11:888</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11:888</span><br><span class="line">web2</span><br></pre></td></tr></table></figure><h3 id="后端server配置"><a href="#后端server配置" class="headerlink" title="后端server配置"></a>后端server配置</h3><p>格式：<code>server &lt;name&gt; &lt;address&gt;[:[port]] [param*]</code></p><p>定义后端主机的各服务器及其选项：</p><ul><li><code>server &lt;name&gt; &lt;address&gt;[:port] [settings ...]</code></li><li><code>default-server [settings ...]</code></li><li><code>&lt;name&gt;</code>：服务器在<code>haproxy</code>上的内部名称；出现在日志及警告信息</li><li><code>&lt;address&gt;</code>：服务器地址，支持使用主机名</li><li><code>[:[port]]</code>：端口映射；省略时，表示同<code>bind</code>中绑定的端口</li><li><code>[param*]</code>：参数<ul><li><code>weight &lt;weight&gt;</code>：权重，默认为1</li><li><code>maxconn &lt;maxconn&gt;</code>：当前后端server的最大并发连接数</li><li><code>backlog &lt;backlog&gt;</code>：当<code>server</code>的连接数达到上限后的后援队列长度</li><li><code>backup</code>：设定当前<code>server</code>为备用服务器<code>Sorry Server</code></li></ul></li></ul><p><code>param</code>之<code>check</code>：</p><ul><li><code>check</code>：对当前<code>server</code>做健康状态检测，只用于四层检测</li><li>注意： <code>httpchk</code>， “<code>smtpchk</code>”, “<code>mysql-check</code>”, “<code>pgsqlcheck</code>” and “<code>ssl-hello-chk</code>” 用于定义应用层检测方法<ul><li><code>addr</code> ：检测时使用的IP地址</li><li><code>port</code> ：针对此端口进行检测</li><li><code>inter &lt;delay&gt;</code>：检测之间的时间间隔，默认为<code>2000ms</code></li><li><code>rise &lt;count&gt;</code>：连续多少次检测结果为“成功”才标记服务器为可用；默认为<code>2</code></li><li><code>fall &lt;count&gt;</code>：连续多少次检测结果为“失败”才标记服务器为不可用；默认为<code>3</code></li></ul></li></ul><p><code>param</code>之<code>disabled</code>：标记为不可用</p><p><code>redir &lt;prefix&gt;</code>：将发往此<code>server</code>的所有<code>GET</code>和<code>HEAD</code>类的请求重定向至指定的<code>URL</code></p><p><code>cookie &lt;value&gt;</code>：为当前<code>server</code>指定<code>cookie</code>值，实现基于<code>cookie</code>的会话黏性</p><p> <code>cookie &lt;name&gt; [ rewrite | insert | prefix ] [ indirect ][ nocache ] [ postonly ] [ preserve ] [ httponly ] [secure ] [ domain &lt;domain&gt; ]* [ maxidle &lt;idle&gt; ] [maxlife &lt;life&gt; ]</code></p><ul><li><code>&lt;name&gt;</code>： <code>cookie</code>名称，用于实现持久连接</li><li><code>rewrite</code>：重写</li><li><code>insert</code>：插入</li><li><code>prefix</code>：前缀</li></ul><h4 id="定义后端server"><a href="#定义后端server" class="headerlink" title="定义后端server"></a>定义后端server</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websers</span><br><span class="line"></span><br><span class="line">backend websers</span><br><span class="line">    balance roundrobin</span><br><span class="line">    default-server weight 6</span><br><span class="line">    server ser1 192.168.8.12:80 check weight 2 maxconn 5000 backlog 500     # 指定进行健康检查，权重为2，最大并发连接数为5000，达到并发连接数后的队列长度为500</span><br><span class="line">    server ser2 192.168.8.13:80</span><br></pre></td></tr></table></figure><h4 id="定义backup-server-sorry-server"><a href="#定义backup-server-sorry-server" class="headerlink" title="定义backup server (sorry server)"></a>定义backup server (sorry server)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# yum install -y httpd          # 在本地安装httpd服务；</span><br><span class="line">[root@HAProxy ~]# vim /etc/httpd/conf/httpd.conf        # 修改httpd配置文件，端口为6666；</span><br><span class="line">Listen 6666</span><br><span class="line">[root@HAProxy ~]# echo &quot;我们的服务器宕机了，哈哈哈~~~&quot; &gt; /var/www/html/index.html       # 创建网站默认界面</span><br><span class="line">[root@HAProxy ~]# service httpd start           # 启动服务；</span><br><span class="line">Starting httpd:                                            [  OK  ]</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11:6666        # 测试访问，ok；</span><br><span class="line">我们的服务器宕机了，哈哈哈~~~</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websers</span><br><span class="line"></span><br><span class="line">backend websers</span><br><span class="line">    balance roundrobin</span><br><span class="line">    default-server weight 6</span><br><span class="line">    server ser1 192.168.8.12:80 check weight 2 maxconn 5000 backlog 500</span><br><span class="line">    server ser2 192.168.8.13:80 </span><br><span class="line">    server bak  192.168.8.11:6666 backup            # 定义backup server</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11             # 目前还可以访问；    </span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# ansible web1 -m service -a &apos;name=&quot;httpd&quot; state=&quot;stopped&quot;&apos;     # 利用ansible停止real server 的httpd服务</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;httpd&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;stopped&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;httpd&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;stopped&quot;, </span><br><span class="line">。。。省略</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；       </span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websers</span><br><span class="line"></span><br><span class="line">backend websers</span><br><span class="line">    balance roundrobin</span><br><span class="line">    default-server weight 6</span><br><span class="line">    server ser1 192.168.8.12:80 check  weight 2 maxconn 5000 </span><br><span class="line">    server ser2 192.168.8.13:80 check </span><br><span class="line">    server bak  192.168.8.11:6666 backup        # 注意：定义sorry server时，需要给server加上健康检查(check)，否则会报错；</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11         # 测试，ok；</span><br><span class="line">我们的服务器宕机了，哈哈哈~~~</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">我们的服务器宕机了，哈哈哈~~~</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">我们的服务器宕机了，哈哈哈~~~</span><br></pre></td></tr></table></figure><h4 id="指定check的地址"><a href="#指定check的地址" class="headerlink" title="指定check的地址"></a>指定check的地址</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# ansible 192.168.8.13 -m shell -a &apos;ifconfig eth1:0 192.168.8.14 up&apos;        # 为192.168.8.13配置一个虚拟IP192.168.8.14；</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# ansible 192.168.8.13 -a &apos;ifconfig&apos;        # 查看192.168.8.13的IP，虚拟IP192.168.8.14已经配置；</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:23:DB:AF  </span><br><span class="line">          inet addr:192.168.8.13  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fe23:dbaf/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:3332 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:2536 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:1723718 (1.6 MiB)  TX bytes:259501 (253.4 KiB)</span><br><span class="line"></span><br><span class="line">eth1:0    Link encap:Ethernet  HWaddr 00:0C:29:23:DB:AF  </span><br><span class="line">          inet addr:192.168.8.14  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:10 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:10 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:1177 (1.1 KiB)  TX bytes:1177 (1.1 KiB)</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# ansible web1 -m service -a &apos;name=&quot;httpd&quot; state=&quot;started&quot;&apos;     # 启动两台服务器的httpd服务；</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;httpd&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;httpd&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;, </span><br><span class="line">    &quot;status&quot;: &#123;</span><br><span class="line">。。。省略</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websers</span><br><span class="line"></span><br><span class="line">backend websers</span><br><span class="line">    balance roundrobin</span><br><span class="line">    default-server weight 6</span><br><span class="line">    server ser1 192.168.8.12:80 check  weight 2 maxconn 5000 </span><br><span class="line">    server ser2 192.168.8.13:80 check addr 192.168.8.14 port 80 inter 3000 rise 3 fall 3        # 指定健康检查IP为192.168.8.14，端口为80，间隔为3000毫秒，失败3次标为宕机，成功3次标为正常</span><br><span class="line">    server bak  192.168.8.11:6666 backup</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart </span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11         # 测试，都是可以访问的；</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# ansible web1 -m shell -a &apos;ifconfig eth1:0 down&apos;       # 将刚刚配置的虚拟IP删掉；</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# ansible 192.168.8.13 -a &apos;ifconfig&apos;        # IP已经被删除；</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:23:DB:AF  </span><br><span class="line">          inet addr:192.168.8.13  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fe23:dbaf/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:3871 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:2871 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:2013622 (1.9 MiB)  TX bytes:299325 (292.3 KiB)</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# for i in &#123;1..10&#125;;do curl 192.168.8.11 ; done          # 测试，全部都调度到web1上面了，因为haproxy认为192.168.8.14已经down了。</span><br><span class="line">web1</span><br><span class="line">web1</span><br><span class="line">web1</span><br><span class="line">web1</span><br><span class="line">web1</span><br><span class="line">web1</span><br><span class="line">web1</span><br><span class="line">web1</span><br><span class="line">web1</span><br><span class="line">web1</span><br></pre></td></tr></table></figure><h4 id="指定real-server为down"><a href="#指定real-server为down" class="headerlink" title="指定real server为down"></a>指定real server为down</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websers</span><br><span class="line"></span><br><span class="line">backend websers</span><br><span class="line">    balance roundrobin</span><br><span class="line">    default-server weight 6</span><br><span class="line">    server ser1 192.168.8.12:80 check  weight 2 maxconn 5000 disabled       # 标记ser1为down；</span><br><span class="line">    server ser2 192.168.8.13:80 check   </span><br><span class="line">    server bak  192.168.8.11:6666 backup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart </span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# for i in &#123;1..5&#125; ; do curl 192.168.8.11 ; done         # 测试访问，一直都是往web2调度了，因为web1被我们标记为down了；</span><br><span class="line">web2</span><br><span class="line">web2</span><br><span class="line">web2</span><br><span class="line">web2</span><br><span class="line">web2</span><br></pre></td></tr></table></figure><h4 id="redir重定向"><a href="#redir重定向" class="headerlink" title="redir重定向"></a>redir重定向</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websers</span><br><span class="line"></span><br><span class="line">backend websers</span><br><span class="line">    balance roundrobin</span><br><span class="line">    default-server weight 6</span><br><span class="line">    server ser1 192.168.8.12:80 check  weight 2 maxconn 5000 </span><br><span class="line">    server ser2 192.168.8.13:80 check   redir http://www.baidu.com      # 定义访问ser2重定向到baidu</span><br><span class="line">    server bak  192.168.8.11:6666 backup</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart </span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Haproxy-configure-1.gif" title="测试访问"></center><h4 id="基于cookie的session-sticky的实现"><a href="#基于cookie的session-sticky的实现" class="headerlink" title="基于cookie的session sticky的实现"></a>基于cookie的session sticky的实现</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websers</span><br><span class="line"></span><br><span class="line">backend websers</span><br><span class="line">    balance roundrobin</span><br><span class="line">    cookie TEST insert nocache          # 插入匹配cookie；</span><br><span class="line">    server ser1 192.168.8.12:80 check   cookie test     当cookie为test就调度到当前主机；</span><br><span class="line">    server ser2 192.168.8.13:80 check</span><br><span class="line">    server bak  192.168.8.11:6666 backup</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11         # 正常测试，可以调度；</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl -b TEST=test 192.168.8.11        # 携带cookie为test，就会调度为web1</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl -b TEST=test 192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl -b TEST=test 192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl -b TEST=test1 192.168.8.11       # 携带cookie为非test，正常调度</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl -b TEST=test1 192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl -b TEST=test1 192.168.8.11</span><br><span class="line">web2</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl -I  -b TEST=test1 192.168.8.11       # 查看响应头部信息</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Wed, 01 Nov 2017 12:03:13 GMT</span><br><span class="line">Server: Apache/2.4.6 (CentOS)</span><br><span class="line">Last-Modified: Tue, 31 Oct 2017 13:28:20 GMT</span><br><span class="line">ETag: &quot;5-55cd7ba80027a&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 5</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Set-Cookie: TEST=test; path=/</span><br><span class="line">Cache-control: private</span><br></pre></td></tr></table></figure><h3 id="web统计接口"><a href="#web统计接口" class="headerlink" title="web统计接口"></a>web统计接口</h3><ul><li><code>stats enable</code>：启用统计页；基于默认的参数启用<code>stats page</code><ul><li><code>stats uri</code> : <code>/haproxy?stats</code> <code>uri</code>默认值</li><li><code>stats realm</code> : <code>HAProxy\ Statistics</code></li><li><code>stats auth</code> : <code>no authentication</code></li></ul></li><li><code>stats uri &lt;prefix&gt;</code><ul><li>自定义<code>stats page uri</code></li></ul></li><li><code>stats auth &lt;user&gt;:&lt;passwd&gt;</code><ul><li>认证时的账号和密码，可使用多次</li></ul></li><li><code>stats realm &lt;realm&gt;</code><ul><li><code>认证时的realm</code></li></ul></li><li><code>stats hide-version</code><ul><li>隐藏版本</li></ul></li><li><code>stats refresh &lt;delay&gt;</code><ul><li>设定自动刷新时间间隔</li></ul></li><li><code>stats admin { if | unless } &lt;cond&gt;</code><ul><li>启用<code>stats page</code>中的管理功能</li></ul></li></ul><h4 id="启用统计接口"><a href="#启用统计接口" class="headerlink" title="启用统计接口"></a>启用统计接口</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">listen stats</span><br><span class="line">    bind *:1234</span><br><span class="line">    stats enable</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Haproxy-configure-2.gif" title="启用统计接口"></center><h4 id="为统计接口web界面设置密码"><a href="#为统计接口web界面设置密码" class="headerlink" title="为统计接口web界面设置密码"></a>为统计接口web界面设置密码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">listen stats</span><br><span class="line">    bind *:1234</span><br><span class="line">    stats enable</span><br><span class="line">    stats realm &quot;HAProxy info&quot;      # 认证时显示的信息；</span><br><span class="line">    stats auth user:user        # 指定用户和密码；</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Haproxy-configure-3.gif" title="为统计接口web界面设置密码"></center><h4 id="设置自动刷新、隐藏版本和自定义访问路径"><a href="#设置自动刷新、隐藏版本和自定义访问路径" class="headerlink" title="设置自动刷新、隐藏版本和自定义访问路径"></a>设置自动刷新、隐藏版本和自定义访问路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">listen stats</span><br><span class="line">    bind *:1234</span><br><span class="line">    stats enable</span><br><span class="line">    stats realm &quot;HAProxy info&quot;</span><br><span class="line">    stats auth user:user</span><br><span class="line">    stats refresh 1s</span><br><span class="line">    stats hide-version</span><br><span class="line">    stats uri /admin</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Haproxy-configure-4.gif" title="设置自动刷新、隐藏版本和自定义访问路径"></center><h4 id="启用管理功能"><a href="#启用管理功能" class="headerlink" title="启用管理功能"></a>启用管理功能</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">listen stats</span><br><span class="line">    bind *:1234</span><br><span class="line">    stats enable</span><br><span class="line">    stats realm &quot;HAProxy info&quot;</span><br><span class="line">    stats auth user:user</span><br><span class="line">    stats refresh 10s           # 将刷新间隔调长</span><br><span class="line">    stats hide-version</span><br><span class="line">    stats uri /admin</span><br><span class="line">    stats admin if TRUE     # 认证成功后才能使用管理功能</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Haproxy-configure-5.gif" title="启用管理功能"></center><h3 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a>工作模式</h3><p><code>maxconn &lt;conns&gt;</code>：为指定的<code>frontend</code>定义其最大并发连接数；默认为3000</p><p><code>mode { tcp|http|health }</code></p><ul><li>定义<code>haproxy</code>的工作模式</li><li><code>tcp</code>：基于<code>layer4</code>实现代理；可代理<code>mysql</code>, <code>pgsql</code>, <code>ssh</code>,</li><li><code>ssl</code>等协议,<code>https</code>时使用此模式，默认模式</li><li><code>http</code>：仅当代理协议为<code>http</code>时使用,<code>centos</code>实际默认模式</li><li><code>health</code>：工作为健康状态检查的响应模式，当连接请求到达时回应<code>“OK”</code>后即断开连接，较少使用</li></ul><h3 id="健康状态检查"><a href="#健康状态检查" class="headerlink" title="健康状态检查"></a>健康状态检查</h3><p>对后端服务器做http协议健康状态检测：通常用于<code>bendend</code></p><ul><li><code>option httpchk 默认为： / OPTIONS HTTP/1.0</code></li><li><code>option httpchk &lt;uri&gt;</code></li><li><code>option httpchk &lt;method&gt; &lt;uri&gt;</code></li><li><code>option httpchk &lt;method&gt; &lt;uri&gt; &lt;version&gt;</code><ul><li>定义基于<code>http</code>协议的7层健康状态检测机制</li></ul></li><li><code>http-check expect [!] &lt;match&gt; &lt;pattern&gt;</code><ul><li><code>http</code>协议健康状态检测响应内容或指定响应码</li></ul></li></ul><h4 id="实现对后端server做健康检查"><a href="#实现对后端server做健康检查" class="headerlink" title="实现对后端server做健康检查"></a>实现对后端server做健康检查</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend webser</span><br><span class="line"></span><br><span class="line">backend webser</span><br><span class="line">    balance roundrobin</span><br><span class="line">    option httpchk          # 定义http健康检查；</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check </span><br><span class="line">    server bak  192.168.8.11:6666 backup</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@web1 ~]# tail -5 /var/log/httpd/access_log        # 查看web1的访问日志；</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:21:07 +0800] &quot;OPTIONS / HTTP/1.0&quot; 200 - &quot;-&quot; &quot;-&quot;</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:21:09 +0800] &quot;OPTIONS / HTTP/1.0&quot; 200 - &quot;-&quot; &quot;-&quot;</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:21:11 +0800] &quot;OPTIONS / HTTP/1.0&quot; 200 - &quot;-&quot; &quot;-&quot;</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:21:13 +0800] &quot;OPTIONS / HTTP/1.0&quot; 200 - &quot;-&quot; &quot;-&quot;</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:21:15 +0800] &quot;OPTIONS / HTTP/1.0&quot; 200 - &quot;-&quot; &quot;-&quot;</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend webser</span><br><span class="line"></span><br><span class="line">backend webser</span><br><span class="line">    balance roundrobin</span><br><span class="line">    option httpchk / HEAD HTTP/1.1      # 自定义请求路径、方法和协议</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check </span><br><span class="line">    server bak  192.168.8.11:6666 backup</span><br><span class="line"></span><br><span class="line">[root@web1 ~]# tail -5 /var/log/httpd/access_log                # 查看web1的访问日志；</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:23:14 +0800] &quot;/ HEAD HTTP/1.1&quot; 400 226 &quot;-&quot; &quot;-&quot;</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:23:16 +0800] &quot;/ HEAD HTTP/1.1&quot; 400 226 &quot;-&quot; &quot;-&quot;</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:23:18 +0800] &quot;/ HEAD HTTP/1.1&quot; 400 226 &quot;-&quot; &quot;-&quot;</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:23:20 +0800] &quot;/ HEAD HTTP/1.1&quot; 400 226 &quot;-&quot; &quot;-&quot;</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:23:22 +0800] &quot;/ HEAD HTTP/1.1&quot; 400 226 &quot;-&quot; &quot;-&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend webser</span><br><span class="line"></span><br><span class="line">backend webser</span><br><span class="line">    balance roundrobin</span><br><span class="line">    option httpchk  HEAD /index.html HTTP/1.1\r\nhost:          </span><br><span class="line">    http-check expect status 200        # 定义返回状态码为200才是正常的；</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check </span><br><span class="line">    server bak  192.168.8.11:6666 backup</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@web1 ~]# tail -5 /var/log/httpd/access_log            # 查看日志，ok；</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:55:20 +0800] &quot;HEAD /index.html HTTP/1.1&quot; 200 - &quot;-&quot; &quot;-&quot;</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:55:22 +0800] &quot;HEAD /index.html HTTP/1.1&quot; 200 - &quot;-&quot; &quot;-&quot;</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:55:24 +0800] &quot;HEAD /index.html HTTP/1.1&quot; 200 - &quot;-&quot; &quot;-&quot;</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:55:26 +0800] &quot;HEAD /index.html HTTP/1.1&quot; 200 - &quot;-&quot; &quot;-&quot;</span><br><span class="line">192.168.8.11 - - [01/Nov/2017:21:55:28 +0800] &quot;HEAD /index.html HTTP/1.1&quot; 200 - &quot;-&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure><h3 id="forwardfor配置"><a href="#forwardfor配置" class="headerlink" title="forwardfor配置"></a>forwardfor配置</h3><p> <code>option forwardfor [ except &lt;network&gt; ] [ header &lt;name&gt; ][ if-none ]</code></p><p>在由<code>haproxy</code>发往后端主机的请求报文中添加<code>“X-ForwardedFor”</code>首部，其值为前端客户端的地址；用于向后端主发送真实的客户端<code>IP</code></p><p><code>[ except &lt;network&gt; ]</code>：请求报请来自此处指定的网络时不予添加此首部，如<code>haproxy</code>自身所在网络</p><p><code>[ header &lt;name&gt; ]</code>：使用自定义的首部名称，而非<code>“XForwarded-For”</code></p><p><code>[ if-none ]</code> 如果没有首部才添加首部，如果有使用默认值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg              # 在我们的默认配置中已经定义forwardfor；</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line"></span><br><span class="line">[root@web1 ~]# vim /etc/httpd/conf/httpd.conf               # 在web1修改日志格式即可；</span><br><span class="line">    LogFormat &quot;%&#123;x-forwarded-for&#125;i %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; haproxy</span><br><span class="line">    CustomLog &quot;logs/access_log&quot; haproxy</span><br><span class="line"></span><br><span class="line">[root@web1 ~]# tail -2 /var/log/httpd/access_log            # 已经看到日志；</span><br><span class="line">192.168.8.1 192.168.8.11 - - [01/Nov/2017:22:15:27 +0800] &quot;GET / HTTP/1.1&quot; 200 5 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.79 Safari/537.36&quot;</span><br><span class="line">192.168.8.1 192.168.8.11 - - [01/Nov/2017:22:15:28 +0800] &quot;GET / HTTP/1.1&quot; 200 5 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.79 Safari/537.36&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8 header X-Client      # 使用自定义名称X-Client</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@web1 ~]# vim /etc/httpd/conf/httpd.conf           # 修改配置文件，将x-client定义到后面；</span><br><span class="line">    LogFormat &quot; %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;%&#123;x-Client&#125;i&quot; haproxy </span><br><span class="line">    CustomLog &quot;logs/access_log&quot; haproxy</span><br><span class="line"></span><br><span class="line">[root@web1 ~]# systemctl restart httpd</span><br><span class="line"></span><br><span class="line">[root@web1 ~]# tail -1 /var/log/httpd/access_log        # 查看日志，已经记录；</span><br><span class="line"> 192.168.8.11 - - [01/Nov/2017:22:21:50 +0800] &quot;GET / HTTP/1.1&quot; 200 5 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.79 Safari/537.36&quot;192.168.8.1</span><br></pre></td></tr></table></figure><h3 id="为指定的MIME类型启用压缩传输功能"><a href="#为指定的MIME类型启用压缩传输功能" class="headerlink" title="为指定的MIME类型启用压缩传输功能"></a>为指定的MIME类型启用压缩传输功能</h3><p><code>compression algo &lt;algorithm&gt; ...</code>：启用<code>http</code>协议的压缩机制，指明压缩算法<code>gzip</code>, <code>deflate</code></p><p><code>compression type &lt;mime type&gt; ...</code>：指明压缩的<code>MIMI</code>类型</p><h3 id="错误页配置"><a href="#错误页配置" class="headerlink" title="错误页配置"></a>错误页配置</h3><p><code>errorfile &lt;code&gt; &lt;file&gt; 自定义错误页</code></p><ul><li><code>&lt;code&gt;： HTTP status code.</code><ul><li>支持<code>200</code>, <code>400</code>, <code>403</code>, <code>408</code>, <code>500</code>, <code>502</code>, <code>503</code>, <code>504</code>.</li><li><code>&lt;file&gt;</code>：错误页文件路径<ul><li><code>errorloc &lt;code&gt; &lt;url&gt;</code></li><li>相当于<code>errorloc302 &lt;code&gt; &lt;url&gt;</code>，利用302重定向至指<code>URL</code></li></ul></li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# ansible web1 -m service -a &apos;name=&quot;httpd&quot; state=&quot;stopped&quot;&apos;         # 先停止后台的real server的httpd服务；</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;httpd&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;stopped&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;httpd&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;stopped&quot;, </span><br><span class="line">    &quot;status&quot;: &#123;</span><br><span class="line">。。。省略</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11         # 访问测试，这个页面应该就是192.168.8.11的503错误页面；</span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;503 Service Unavailable&lt;/h1&gt;</span><br><span class="line">No server is available to handle this request.</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend webser</span><br><span class="line"></span><br><span class="line">backend webser</span><br><span class="line">    balance roundrobin</span><br><span class="line">    option httpchk  HEAD /index.html HTTP/1.1\r\nhost:</span><br><span class="line">    http-check expect status 200 </span><br><span class="line">    errorfile 503   /etc/haproxy/error_file/503.html            # 定制错误页面；</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# cd /etc/haproxy/</span><br><span class="line">[root@HAProxy haproxy]# mkdir error_file</span><br><span class="line">[root@HAProxy haproxy]# echo error 503 &gt; error_file/503.html        # 创建503页面；</span><br><span class="line"></span><br><span class="line">[root@HAProxy haproxy]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line">[root@HAProxy haproxy]# curl 192.168.8.11           # 访问测试，ok；</span><br><span class="line">error 503</span><br><span class="line">[root@HAProxy haproxy]# curl 192.168.8.11</span><br><span class="line">error 503</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend webser</span><br><span class="line"></span><br><span class="line">backend webser</span><br><span class="line">    balance roundrobin</span><br><span class="line">    option httpchk  HEAD /index.html HTTP/1.1\r\nhost:</span><br><span class="line">    http-check expect status 200 </span><br><span class="line">    errorloc 503    http://192.168.8.11:6666        # 指定出现503错误时，就跳转到指定的web界面；</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check </span><br><span class="line"></span><br><span class="line">[root@HAProxy haproxy]# curl -L  192.168.8.11       # 测试，ok；</span><br><span class="line">我们的服务器宕机了，哈哈哈~~~</span><br><span class="line">[root@HAProxy haproxy]# curl -L  192.168.8.11</span><br><span class="line">我们的服务器宕机了，哈哈哈~~~</span><br></pre></td></tr></table></figure><h3 id="修改报文首部"><a href="#修改报文首部" class="headerlink" title="修改报文首部"></a>修改报文首部</h3><ul><li>在请求报文尾部添加指定首部<ul><li><code>reqadd &lt;string&gt; [{if | unless} &lt;cond&gt;]</code></li></ul></li><li>在响应报文尾部添加指定首部<ul><li><code>rspadd &lt;string&gt; [{if | unless} &lt;cond&gt;]</code><br>示例： <code>rspadd X-Via:\ HAPorxy</code></li></ul></li><li>从请求报文中删除匹配正则表达式的首部<ul><li><code>reqdel &lt;search&gt; [{if | unless} &lt;cond&gt;]</code></li><li><code>reqidel &lt;search&gt; [{if | unless} &lt;cond&gt;]</code>不分大小写</li></ul></li><li>从响应报文中删除匹配正则表达式的首部<ul><li><code>rspdel &lt;search&gt; [{if | unless} &lt;cond&gt;]</code></li><li><code>rspidel &lt;search&gt; [{if | unless} &lt;cond&gt;]</code> 不分大小写</li><li>示例： <code>rspidel server.*</code></li></ul></li></ul><h4 id="添加请求报文"><a href="#添加请求报文" class="headerlink" title="添加请求报文"></a>添加请求报文</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy haproxy]# ansible web1 -m service -a &apos;name=&quot;httpd&quot; state=&quot;started&quot;&apos;           # 启动后台real server的http的服务；</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;httpd&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;, </span><br><span class="line">    &quot;status&quot;: &#123;</span><br><span class="line">        &quot;ActiveEnterTimestampMonotonic&quot;: &quot;0&quot;, </span><br><span class="line">        &quot;ActiveExitTimestampMonotonic&quot;: &quot;0&quot;, </span><br><span class="line">        &quot;ActiveState&quot;: &quot;inactive&quot;, </span><br><span class="line">。。。省略</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;httpd&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11         # 访问测试，可以调度；</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web1</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend webser</span><br><span class="line"></span><br><span class="line">backend webser</span><br><span class="line">    balance roundrobin</span><br><span class="line">    reqadd x-via:\ HAProxy11        # 添加请求报文，x-via</span><br><span class="line">    option httpchk  HEAD /index.html HTTP/1.1\r\nhost:</span><br><span class="line">    http-check expect status 200 </span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check </span><br><span class="line"></span><br><span class="line">[root@HAProxy haproxy]# service haproxy restart </span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line">[root@web1 ~]# vim /etc/httpd/conf/httpd.conf           # 修改httpd配置文件，添加记录日志；</span><br><span class="line">    LogFormat &quot; %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;%&#123;x-via&#125;i&quot; haproxy</span><br><span class="line">    CustomLog &quot;logs/access_log&quot; haproxy</span><br><span class="line">[root@web1 ~]# systemctl restart httpd</span><br><span class="line">[root@web1 ~]# tail -1 /var/log/httpd/access_log        # 查看日志，请求报文添加成功；</span><br><span class="line"> 192.168.8.11 - - [02/Nov/2017:09:38:27 +0800] &quot;GET / HTTP/1.1&quot; 200 5 &quot;-&quot; &quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;HAProxy11</span><br></pre></td></tr></table></figure><h4 id="删除响应报文特定字段"><a href="#删除响应报文特定字段" class="headerlink" title="删除响应报文特定字段"></a>删除响应报文特定字段</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy haproxy]# curl -I  192.168.8.11       # 默认的响应报文是有Server信息；</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Thu, 02 Nov 2017 01:45:03 GMT</span><br><span class="line">Server: Apache/2.2.15 (CentOS)</span><br><span class="line">Last-Modified: Tue, 31 Oct 2017 13:28:19 GMT</span><br><span class="line">ETag: &quot;2205b1-5-55cd7ba725754&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 5</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend webser</span><br><span class="line"></span><br><span class="line">backend webser</span><br><span class="line">    balance roundrobin</span><br><span class="line">    reqadd x-via:\ HAProxy11</span><br><span class="line">    rspidel server              # 删除响应报文server段，不区分大小写；</span><br><span class="line">    option httpchk  HEAD /index.html HTTP/1.1\r\nhost:</span><br><span class="line">    http-check expect status 200 </span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check </span><br><span class="line"></span><br><span class="line">[root@HAProxy haproxy]# service haproxy restart </span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line">[root@HAProxy haproxy]# curl -I  192.168.8.11           # 测试访问，已经被删除；</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Thu, 02 Nov 2017 01:47:38 GMT</span><br><span class="line">Last-Modified: Tue, 31 Oct 2017 13:28:20 GMT</span><br><span class="line">ETag: &quot;5-55cd7ba80027a&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 5</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br></pre></td></tr></table></figure><h3 id="连接超时"><a href="#连接超时" class="headerlink" title="连接超时"></a>连接超时</h3><p>连接超时可以根据具体公司业务进行修改。</p><ul><li><code>timeout client &lt;timeout&gt;</code><ul><li>客户端最长空闲连接超时时长 默认单位是毫秒</li></ul></li><li><code>timeout server &lt;timeout&gt;</code><ul><li>后端服务器最长空闲连接超时时长</li></ul></li><li><code>timeout http-keep-alive &lt;timeout&gt;</code><ul><li>持久连接的持久时长</li></ul></li><li><code>timeout http-request &lt;timeout&gt;</code><ul><li>一次完整的HTTP请求的最大等待时长</li></ul></li><li><code>timeout connect &lt;timeout&gt;</code><ul><li>成功连接后端服务器的最大等待时长</li></ul></li><li><code>timeout client-fin &lt;timeout&gt;</code><ul><li>客户端半连接的空闲时长</li></ul></li><li><code>timeout server-fin &lt;timeout&gt;</code><ul><li>后端服务器半连接的空闲时长</li></ul></li></ul>]]></content>
      
      <categories>
          
          <category> 负载均衡 </category>
          
          <category> Haproxy常用配置 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Haproxy </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>HAProxy调度算法</title>
      <link href="/2017/11/05/Haproxy-Diaodu-Suanfa/"/>
      <url>/2017/11/05/Haproxy-Diaodu-Suanfa/</url>
      <content type="html"><![CDATA[<h3 id="调度算法"><a href="#调度算法" class="headerlink" title="调度算法"></a>调度算法</h3><h4 id="roundrobin"><a href="#roundrobin" class="headerlink" title="roundrobin"></a>roundrobin</h4><ul><li><code>roundrobin</code>：基于权重轮询，动态算法，支持权重的运行时调整，支持慢启动；每个后端<code>backend</code>中最多支持<code>4095</code>个<code>server</code></li><li><code>server options： weight #</code></li></ul><h5 id="server指定权重"><a href="#server指定权重" class="headerlink" title="server指定权重"></a>server指定权重</h5><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websers</span><br><span class="line"></span><br><span class="line">backend websers</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server ser1 192.168.8.12:80 weight 2        # 指定权重为2；</span><br><span class="line">    server ser2 192.168.8.13:80         # 默认权重为1；</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11         # 测试，ok；</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br></pre></td></tr></table></figure><h4 id="static-rr"><a href="#static-rr" class="headerlink" title="static-rr"></a>static-rr</h4><p><code>static-rr</code>：基于权重轮询，静态算法，不支持权重的运行时调整及慢启动；后端主机数量无上限</p><h4 id="leastconn"><a href="#leastconn" class="headerlink" title="leastconn"></a>leastconn</h4><p><code>leastconn</code>：加权最少连接，动态算法，最少连接的后端服务器优先分配接收新连接，相同连接时轮询，推荐在较长会话的场景使用，例如<code>MySQL</code>、 <code>LDAP</code>等，不适合<code>http</code></p><h4 id="first"><a href="#first" class="headerlink" title="first"></a>first</h4><p> <code>first</code>：根据服务器在列表中的位置，自上而下进行调度；前面服务器的连接数达到上限，新请求才会分配给下一台服务</p><h4 id="source"><a href="#source" class="headerlink" title="source"></a>source</h4><p><code>source</code>：源地址<code>hash</code>，新连接先按权重分配，后续连接按<code>source</code>分配请求</p><h4 id="uri"><a href="#uri" class="headerlink" title="uri"></a>uri</h4><p>对<code>URI</code>的左半部分或整个<code>uri</code>做<code>hash</code>计算，并除以服务器总权重取模，以后派发至某挑出的服务器,适用于后端缓存服务器</p><p><code>&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;</code></p><ul><li>左半部分： <code>/&lt;path&gt;;&lt;params&gt;</code></li><li>整个<code>uri</code>： <code>/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;</code></li></ul><h4 id="url-param"><a href="#url-param" class="headerlink" title="url_param"></a>url_param</h4><p>对用户请求的<code>uri</code>中的<code>&lt;params&gt;</code>部分中的参数的值作<code>hash</code>计算，并由服务器总权重相除以后派发至某挑出的服务器；通常用于追踪用户，以确保来自同一个用户的请求始终发往同一个<code>Backend Server</code></p><p><code>http://www.magedu.com/bbs/hello;type=title</code></p><h5 id="实现rui-parm"><a href="#实现rui-parm" class="headerlink" title="实现rui_parm"></a>实现rui_parm</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# ansible web1 -m shell -a &apos;for i in &#123;1..5&#125;; do echo &quot;`hostname` $i page&quot; &gt; /var/www/html/$i.html ; done &apos;          # 使用ansible快速生成5个test页面；</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# ansible web1 -a &apos;cat /var/www/html/1.html&apos;        # 查看页面内容，ok；</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">web2 1 page</span><br><span class="line"></span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">web1 1 page</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websers</span><br><span class="line"></span><br><span class="line">backend websers</span><br><span class="line">    balance uri         # 修改调度算法为uri；</span><br><span class="line">    server ser1 192.168.8.12:80 weight 2</span><br><span class="line">    server ser2 192.168.8.13:80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/1.html          # 测试，相同的URI已经调度到同一台主机；</span><br><span class="line">web1 1 page </span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/1.html</span><br><span class="line">web1 1 page</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/1.html</span><br><span class="line">web1 1 page</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/2.html</span><br><span class="line">web2 2 page</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/2.html</span><br><span class="line">web2 2 page</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/2.html</span><br><span class="line">web2 2 page</span><br></pre></td></tr></table></figure><h4 id="hash-type：哈希算法"><a href="#hash-type：哈希算法" class="headerlink" title="hash-type：哈希算法"></a>hash-type：哈希算法</h4><ul><li><code>hash-type &lt;method&gt; &lt;function&gt; &lt;modifier&gt;</code><ul><li><code>method:</code><ul><li><code>map-based</code>：除权取余法，哈希数据结构是静态数组</li><li><code>consistent</code>：一致性哈希，哈希数据结构是一棵树</li></ul></li><li><code>&lt;function&gt;</code> : 哈希函数<ul><li><code>sdbm djb2 wt6</code></li></ul></li></ul></li><li><code>default_backend &lt;backend&gt;</code><ul><li>无<code>use_backend</code> 匹配时，使用默认的<code>backend</code>，用于<code>frontend</code>中</li><li><code>default-server [param*]</code></li></ul></li><li>为<code>backend</code>中的各<code>server</code>设定默认选项</li></ul><h5 id="实现hash-type：consistent一致性哈希"><a href="#实现hash-type：consistent一致性哈希" class="headerlink" title="实现hash-type：consistent一致性哈希"></a>实现hash-type：consistent一致性哈希</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websers</span><br><span class="line"></span><br><span class="line">backend websers</span><br><span class="line">    balance uri</span><br><span class="line">    hash-type consistent            # 添加hash-type为consistent；</span><br><span class="line">    server ser1 192.168.8.12:80 weight 2</span><br><span class="line">    server ser2 192.168.8.13:80</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/2.html          # 测试，效果看不出来~~~；</span><br><span class="line">web1 2 page</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/2.html</span><br><span class="line">web1 2 page</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/2.html</span><br><span class="line">web1 2 page</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/5.html</span><br><span class="line">web1 5 page</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/5.html</span><br><span class="line">web1 5 page</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/5.html</span><br><span class="line">web1 5 page</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11/5.html</span><br><span class="line">web1 5 page</span><br></pre></td></tr></table></figure><h5 id="定义default-server"><a href="#定义default-server" class="headerlink" title="定义default server"></a>定义default server</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websers</span><br><span class="line"></span><br><span class="line">backend websers</span><br><span class="line">    balance roundrobin          # 将调度算法修改为轮询，方便测试；</span><br><span class="line">    default-server weight 6     # 定义默认server，权重为6</span><br><span class="line">    server ser1 192.168.8.12:80 weight 2</span><br><span class="line">    server ser2 192.168.8.13:80</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line">[root@HAProxy ~]# for i in &#123;1..10&#125; ; do curl 192.168.8.11 ; done        # 测试，ok；</span><br><span class="line">web2</span><br><span class="line">web2</span><br><span class="line">web2</span><br><span class="line">web1</span><br><span class="line">web2</span><br><span class="line">web2</span><br><span class="line">web2</span><br><span class="line">web1</span><br><span class="line">web2</span><br><span class="line">web2</span><br></pre></td></tr></table></figure><h4 id="hdr"><a href="#hdr" class="headerlink" title="hdr"></a>hdr</h4><p><code>hdr(&lt;name&gt;)</code>：对于每个<code>http</code>请求，此处由<code>&lt;name&gt;</code>指定的<code>http</code>首部将会被取出做<code>hash</code>计算；并由服务器总权重相除以后派发至某挑出的服务器； 无有效值的会被轮询调度</p><h5 id="实现hdr"><a href="#实现hdr" class="headerlink" title="实现hdr"></a>实现hdr</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/hosts            # 修改/etc/hosts文件，添加两条解析；</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.11www.a.comwww.b.com</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改配置文件；</span><br><span class="line">frontend web </span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend websers</span><br><span class="line"></span><br><span class="line">backend websers</span><br><span class="line">    balance hdr(host)         # 指定调度算法为hdr；</span><br><span class="line">    server ser1 192.168.8.12:80 weight 2</span><br><span class="line">    server ser2 192.168.8.13:80</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl www.a.com            # 测试，ok；</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl www.a.com</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl www.a.com</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl www.a.com</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br></pre></td></tr></table></figure><h4 id="rdp-cookie-远程桌面相关"><a href="#rdp-cookie-远程桌面相关" class="headerlink" title="rdp-cookie 远程桌面相关"></a>rdp-cookie 远程桌面相关</h4><p><code>rdp-cookie</code> 远程桌面相关，不做解释<br><code>rdp-cookie(&lt;name&gt;)</code></p>]]></content>
      
      <categories>
          
          <category> 负载均衡 </category>
          
          <category> HAProxy调度算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Haproxy </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>HAProxy log日志设置</title>
      <link href="/2017/11/05/Haproxy-Log/"/>
      <url>/2017/11/05/Haproxy-Log/</url>
      <content type="html"><![CDATA[<h3 id="日志记录在本机"><a href="#日志记录在本机" class="headerlink" title="日志记录在本机"></a>日志记录在本机</h3><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # haproxy服务默认已经定义日志；</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">[root@HAProxy ~]# vim /etc/rsyslog.conf             # 只需要修改日志服务配置文件，添加local2.*，并开启可以网络传输日志开关，就可以将日志记录到本机了；</span><br><span class="line">$ModLoad imudp</span><br><span class="line">$UDPServerRun 514</span><br><span class="line"># Save HAProxy log</span><br><span class="line">local2.*                                                /var/log/haproxy.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart       </span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line">[root@HAProxy ~]# service rsy</span><br><span class="line">rsync    rsyslog  </span><br><span class="line">[root@HAProxy ~]# service rsyslog restart           # 重启日志服务；</span><br><span class="line">Shutting down system logger:                               [  OK  ]</span><br><span class="line">Starting system logger:                                    [  OK  ]</span><br><span class="line">[root@HAProxy ~]# ls -l /var/log/haproxy.log        # 日志文件已经创建；</span><br><span class="line">-rw-------. 1 root root 0 Oct 31 20:22 /var/log/haproxy.log</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11         # 访问测试；</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# tail /var/log/haproxy.log         # 查看日志，已经记录；</span><br><span class="line">Oct 31 20:23:33 localhost haproxy[13640]: 192.168.8.11:44506 [31/Oct/2017:20:23:33.508] webser webser/ser1 0/0/0/1/1 200 263 - - ---- 1/1/0/0/0 0/0 &quot;GET / HTTP/1.1&quot;</span><br><span class="line">Oct 31 20:23:34 localhost haproxy[13640]: 192.168.8.11:44510 [31/Oct/2017:20:23:34.163] webser webser/ser2 0/0/0/1/1 200 271 - - ---- 1/1/0/0/0 0/0 &quot;GET / HTTP/1.1&quot;</span><br></pre></td></tr></table></figure><h3 id="日志记录在远程主机"><a href="#日志记录在远程主机" class="headerlink" title="日志记录在远程主机"></a>日志记录在远程主机</h3><p>例如，我们将日志记录在<code>192.168.8.12</code>这台主机上面。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg          # 修改haproxy配置文件，将本地的IP改为远程日志服务器的iP;</span><br><span class="line">    log         192.168.8.12 local2</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service haproxy restart</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@Log ~]# vim /etc/rsyslog.conf</span><br><span class="line">$ModLoad imudp</span><br><span class="line">$UDPServerRun 514</span><br><span class="line">local2.*                                                /var/log/haproxy.log</span><br><span class="line">[root@Log ~]# systemctl restart rsyslog.service</span><br><span class="line">[root@Log ~]# ll /var/log/haproxy.log </span><br><span class="line">-rw------- 1 root root 67 Oct 31 20:32 /var/log/haproxy.log</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11         # 访问测试；</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line"></span><br><span class="line">[root@Log ~]# tail /var/log/haproxy.log         # 查看日志，已经发送过来；</span><br><span class="line">Oct 31 20:33:06 192.168.8.11 haproxy[13827]: Proxy webser started.</span><br><span class="line">Oct 31 20:33:38 192.168.8.11 haproxy[13828]: 192.168.8.11:44514 [31/Oct/2017:20:33:38.978] webser webser/ser1 0/0/0/1/1 200 263 - - ---- 1/1/0/1/0 0/0 &quot;GET / HTTP/1.1&quot;</span><br><span class="line">Oct 31 20:33:39 192.168.8.11 haproxy[13828]: 192.168.8.11:44518 [31/Oct/2017:20:33:39.644] webser webser/ser2 0/0/0/1/1 200 271 - - ---- 1/1/0/1/0 0/0 &quot;GET / HTTP/1.1&quot;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 负载均衡 </category>
          
          <category> HAProxy log日志设置 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Haproxy </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>HAProxy配置文件</title>
      <link href="/2017/11/05/Haproxy-Configuration-File/"/>
      <url>/2017/11/05/Haproxy-Configuration-File/</url>
      <content type="html"><![CDATA[<h3 id="配置文件组成部分"><a href="#配置文件组成部分" class="headerlink" title="配置文件组成部分"></a>配置文件组成部分</h3><ul><li><p><code>global</code>：全局配置段</p><ul><li>进程及安全配置相关的参数</li><li>性能调整相关参数</li><li><code>Debug</code>参数</li></ul></li><li><p><code>proxies</code>：代理配置段</p><ul><li><code>defaults</code>：为<code>frontend</code>, <code>backend</code>, <code>listen</code>提供默认配置</li><li><code>fronted</code>：前端配置，相当于<code>nginx</code>, <code>server {}</code>，定义前端套接字，接受客户端请求</li><li><code>backend</code>：后端，相当于<code>nginx</code>, <code>upstream {}</code>，定义后端分配规则，与后端服务器交互</li><li><code>listen</code>：同时拥有前端和后端,适用于一对一环境，将指定的客户端与后端特定服务器绑定到一起</li></ul></li></ul><a id="more"></a><h3 id="简单配置示例"><a href="#简单配置示例" class="headerlink" title="简单配置示例"></a>简单配置示例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"># Real server1 配置</span><br><span class="line">[root@web1 ~]# yum install -y httpd</span><br><span class="line">[root@web1 ~]# echo &quot;web1&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@web1 ~]# systemctl start httpd</span><br><span class="line">[root@web1 ~]# curl 192.168.8.12            # 本地测试，ok</span><br><span class="line">web1</span><br><span class="line"></span><br><span class="line"># Real server2 配置</span><br><span class="line">[root@web2 ~]# yum install -y httpd</span><br><span class="line">[root@web2 ~]# echo &quot;web2&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@web2 ~]# service httpd start</span><br><span class="line">Starting httpd:                                            [  OK  ]</span><br><span class="line">[root@web2 ~]# curl 192.168.8.13            # 本地测试，ok</span><br><span class="line">web2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# vim /etc/haproxy/haproxy.cfg          # HAProxy配置文件如下；</span><br><span class="line"></span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># Example configuration for a possible web application.  See the</span><br><span class="line"># full configuration options online.</span><br><span class="line">#</span><br><span class="line">#   http://haproxy.1wt.eu/download/1.4/doc/configuration.txt</span><br><span class="line">#</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># Global settings</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">global</span><br><span class="line">    # to have these messages end up in /var/log/haproxy.log you will</span><br><span class="line">    # need to:</span><br><span class="line">    #   </span><br><span class="line">    # 1) configure syslog to accept network log events.  This is done</span><br><span class="line">    #    by adding the &apos;-r&apos; option to the SYSLOGD_OPTIONS in</span><br><span class="line">    #    /etc/sysconfig/syslog</span><br><span class="line">    #   </span><br><span class="line">    # 2) configure local2 events to go to the /var/log/haproxy.log</span><br><span class="line">    #   file. A line like the following can be added to</span><br><span class="line">    #   /etc/sysconfig/syslog</span><br><span class="line">    #   </span><br><span class="line">    #    local2.*                       /var/log/haproxy.log</span><br><span class="line">    #   </span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line"></span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line"></span><br><span class="line">    # turn on stats unix socket</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line"></span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line"># common defaults that all the &apos;listen&apos; and &apos;backend&apos; sections will</span><br><span class="line"># use if not designated in their block</span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line"></span><br><span class="line">frontend web            # 下面内容改为添加部分</span><br><span class="line">    bind *:80</span><br><span class="line">    default_backend realsrv</span><br><span class="line"></span><br><span class="line">backend realsrv</span><br><span class="line">    balance roundrobin          # 定义调度算法</span><br><span class="line">    server  ser1 192.168.8.12:80        # 定义real server1</span><br><span class="line">    server  ser2 192.168.8.13:80        # 定义real server2</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# service haproxy start         # 启动haproxy</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ss -tnul          # 本地80端口已经监听；</span><br><span class="line">Netid State      Recv-Q Send-Q            Local Address:Port              Peer Address:Port </span><br><span class="line">udp   UNCONN     0      0                             *:68                           *:*     </span><br><span class="line">udp   UNCONN     0      0                             *:57096                        *:*     </span><br><span class="line">tcp   LISTEN     0      128                           *:80                           *:*     </span><br><span class="line">tcp   LISTEN     0      128                          :::22                          :::*     </span><br><span class="line">tcp   LISTEN     0      128                           *:22                           *:*     </span><br><span class="line">tcp   LISTEN     0      100                         ::1:25                          :::*     </span><br><span class="line">tcp   LISTEN     0      100                   127.0.0.1:25                           *:*    </span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# curl 192.168.8.11         # 测试访问，192.168.8.11就是haproxy的iP,代理成功；</span><br><span class="line">web1</span><br><span class="line">[root@centos6 ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@centos6 ~]# curl 192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@centos6 ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br></pre></td></tr></table></figure><h3 id="global配置"><a href="#global配置" class="headerlink" title="global配置"></a>global配置</h3><p>进程及安全管理： <code>chroot</code>, <code>deamon</code>， <code>user</code>, <code>group</code>, <code>uid</code>, <code>gid</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">global          # 全局配置</span><br><span class="line"></span><br><span class="line">    log         127.0.0.1 local2        # 日志记录，默认记录到本地，最多可以定义两个；</span><br><span class="line"></span><br><span class="line">    chroot      /var/lib/haproxy        # 修改haproxy的工作目录至指定的目录并在放弃权限之前执行chroot()操作，可以提升haproxy的安全级别，不过需要注意的是要确保指定的目录为空目录且任何用户均不能有写权限；</span><br><span class="line">    pidfile     /var/run/haproxy.pid    # 指定PID文件路径；</span><br><span class="line">    daemon                              # 让haproxy以守护进程的方式工作于后台，其等同于“-D”选项的功能，当然，也可以在命令行中以“-db”选项将其禁用；</span><br><span class="line">    user        haproxy         # 指定运行haproxy用户；</span><br><span class="line">    group       haproxy         # 指定运行haproxy组；</span><br><span class="line">        nbproc &lt;number&gt;             # 指定启动的haproxy进程的个数，只能用于守护进程模式(daemon)的haproxy；默认只启动一个进程，鉴于调试困难等多方面的原因，一般只在单进程仅能打开少数文件描述符的场景中才使用多进程模式；</span><br><span class="line">    ulimit -n &lt;number&gt;          # 设定每进程所能够打开的最大文件描述符数目，默认情况下其会自动进行计算，因此不推荐修改此选项；</span><br><span class="line">    stats socket /var/lib/haproxy/stats         # 打开unix套接字；</span><br><span class="line">    maxconn &lt;number&gt;                # 设定每个haproxy进程所能接受的最大并发连接数；</span><br><span class="line">    maxconnrate &lt;number&gt;            # 设置每个进程每秒种所能建立的最大连接数量；</span><br><span class="line">    maxsessrate &lt;number&gt;            # 设置每个进程每秒种所能建立的最大会话数量；</span><br><span class="line">    maxsslconn &lt;number&gt;             # 每进程支持SSL的最大连接数量；</span><br><span class="line">    spread-checks &lt;0..50, in percent&gt;           # 健康检测延迟时长比建议2-5之间；</span><br><span class="line">    maxpipes &lt;number&gt;                   # haproxy使用pipe完成基于内核的tcp报文重组，此选项则用于设定每进程所允许使用的最大pipe个数；每个pipe会打开两个文件描述符，因此，“ulimit -n”自动计算时会根据需要调大此值；默认为maxconn/4，其通常会显得过大；</span><br><span class="line">    noepoll                 # 在Linux系统上禁用epoll机制；</span><br><span class="line">    nokqueue                    # 在BSD系统上禁用kqueue机制；</span><br><span class="line">    nopoll                  # 禁用poll机制；</span><br><span class="line">    nosepoll                # 在Linux禁用启发式epoll机制；</span><br><span class="line">    nosplice                # 禁止在Linux套接字上使用内核tcp重组，这会导致更多的recv/send系统调用；不过，在Linux 2.6.25-28系列的内核上，tcp重组功能有bug存在；</span><br><span class="line">    spread-checks &lt;0..50, in percent&gt;               # 在haproxy后端有着众多服务器的场景中，在精确的时间间隔后统一对众服务器进行健康状况检查可能会带来意外问题；此选项用于将其检查的时间间隔长度上增加或减小一定的随机时长；</span><br><span class="line">    tune.bufsize &lt;number&gt;               # 设定buffer的大小，同样的内存条件下，较小的值可以让haproxy有能力接受更多的并发连接，较大的值可以让某些应用程序使用较大的cookie信息；默认为16384，其可以在编译时修改，不过强烈建议使用默认值；</span><br><span class="line">    tune.chksize &lt;number&gt;           # 设定检查缓冲区的大小，单位为字节；更大的值有助于在较大的页面中完成基于字符串或模式的文本查找，但也会占用更多的系统资源；不建议修改；</span><br><span class="line">    tune.maxaccept &lt;number&gt;         # 设定haproxy进程内核调度运行时一次性可以接受的连接的个数，较大的值可以带来较大的吞吐率，默认在单进程模式下为100，多进程模式下为8，设定为-1可以禁止此限制；一般不建议修改；</span><br><span class="line">    tune.maxpollevents  &lt;number&gt;            # 设定一次系统调用可以处理的事件最大数，默认值取决于OS；其值小于200时可节约带宽，但会略微增大网络延迟，而大于200时会降低延迟，但会稍稍增加网络带宽的占用量；</span><br><span class="line">    tune.maxrewrite &lt;number&gt;            # 设定为首部重写或追加而预留的缓冲空间，建议使用1024左右的大小；在需要使用更大的空间时，haproxy会自动增加其值；</span><br><span class="line">    tune.rcvbuf.server &lt;number&gt;     # 设定内核套接字中服务端或客户端接收缓冲的大小，单位为字节；强烈推荐使用默认值；</span><br></pre></td></tr></table></figure><h3 id="代理配置段"><a href="#代理配置段" class="headerlink" title="代理配置段"></a>代理配置段</h3><h4 id="defaults"><a href="#defaults" class="headerlink" title="defaults"></a>defaults</h4><p><code>defaults</code>：为<code>frontend</code>, <code>backend</code>, <code>listen</code>提供默认配置。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">defaults            # 默认配置项</span><br><span class="line">    mode                    http        # 默认工作模式为7层http，4层tcp；</span><br><span class="line">    log                     global      # 使用全局日志；</span><br><span class="line">    option                  httplog     # 日志类别http日志格式 ；</span><br><span class="line">    option                  dontlognull     # 不记录健康检查的日志信息 ；</span><br><span class="line">    option http-server-close            # 允许客户端关闭连接；</span><br><span class="line">    option forwardfor       except 127.0.0.0/8      # 如果后端服务器需要获得客户端真实ip需要配置的参数，可以从Http Header中获得客户端ip ，本地IP不记录；</span><br><span class="line">    option                  redispatch  # server Id对应的服务器挂掉后,强制定向到其他健康的服务器  ；</span><br><span class="line">    option abortonclose                 # 当服务器负载很高的时候，自动结束掉当前队列处理比较久的连接 ；</span><br><span class="line">    balance roundrobin                  # 默认的负载均衡的方式,轮询方式 ；</span><br><span class="line">    stats refresh 30                    # 统计页面刷新间隔 ；</span><br><span class="line">    retries                 3           # 请求重试次数，3次连接失败就认为服务不可用，也可以通过后面设置； </span><br><span class="line">    timeout http-request    10s         # http请求超时时间；</span><br><span class="line">    timeout queue           1m          </span><br><span class="line">    timeout connect         10s </span><br><span class="line">    timeout client          1m  </span><br><span class="line">    timeout server          1m  </span><br><span class="line">    timeout http-keep-alive 10s </span><br><span class="line">    timeout check           10s         # 健康检查超时时间；</span><br><span class="line">    maxconn                 3000        # 最大并发连接数；</span><br></pre></td></tr></table></figure><h4 id="fronted"><a href="#fronted" class="headerlink" title="fronted"></a>fronted</h4><p><code>fronted</code>：前端，相当于<code>nginx</code>, <code>server {}</code>，定义前端套接字，接受客户端请求</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">frontend web        # 定义前端名称；</span><br><span class="line">    bind *:80       # 监听所有IP的80端口；</span><br><span class="line">    default_backend websers     # 默认后端server为websers；</span><br></pre></td></tr></table></figure><h4 id="backend"><a href="#backend" class="headerlink" title="backend"></a>backend</h4><p><code>backend</code>：后端，相当于<code>nginx</code>, <code>upstream {}</code>，定义后端分配规则，与后端服务器交互</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backend websers         # 后端名称；</span><br><span class="line">    balance roundrobin      # 调度算法；</span><br><span class="line">    server ser1 192.168.8.12:80     # real server IP为192.168.8.12，端口为80；</span><br><span class="line">    server ser2 192.168.8.13:80     # real server IP为192.168.8.13，端口为80；</span><br></pre></td></tr></table></figure><h4 id="listen"><a href="#listen" class="headerlink" title="listen"></a>listen</h4><p><code>listen</code>：同时拥有前端和后端,适用于一对一环境，将指定的客户端与后端特定服务器绑定到一起</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">listen webser       # name；</span><br><span class="line">    bind *:80       # 监听所有IP的80端口；</span><br><span class="line">    mode http       # http的7层模式；</span><br><span class="line">    balance roundrobin      # 调度算法为轮询；</span><br><span class="line">    server ser1 192.168.8.12:80     # real server IP为192.168.8.12，端口为80；</span><br><span class="line">    server ser2 192.168.8.13:80     # real server IP为192.168.8.13，端口为80；</span><br></pre></td></tr></table></figure><h5 id="listen-haproxy-status"><a href="#listen-haproxy-status" class="headerlink" title="listen haproxy_status"></a>listen haproxy_status</h5><p>监控界面的设置。</p><pre><code>listen admin_status                    # Frontend和Backend的组合体,监控组的名称，按需自定义名称 ；        bind 0.0.0.0:65532             # 监听端口 ；        mode http                      # http的7层模式 ；        log 127.0.0.1 local3 err       # 错误日志记录 ；        stats refresh 5s               # 每隔5秒自动刷新监控页面 ；        stats uri /admin?stats         # 监控页面的url ；        stats realm itnihao\ itnihao   # 监控页面的提示信息 ；        stats auth admin:admin         # 监控页面的用户和密码admin,可以设置多个用户名 ；        stats auth admin1:123456       # 监控页面的用户和密码123456；        stats hide-version             # 隐藏统计页面上的HAproxy版本信息  ；        stats admin if TRUE            # 手工启用/禁用,后端服务器(haproxy-1.4.9以后版本) ；</code></pre>]]></content>
      
      <categories>
          
          <category> 负载均衡 </category>
          
          <category> HAProxy配置文件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Haproxy </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Haproxy简介</title>
      <link href="/2017/11/05/Haproxy/"/>
      <url>/2017/11/05/Haproxy/</url>
      <content type="html"><![CDATA[<center><img src="https://houhaiyun.github.io/img/images/Haproxy-1.jpg" title="Harproxy"></center><h3 id="HAProxy"><a href="#HAProxy" class="headerlink" title="HAProxy"></a>HAProxy</h3><p><a href="http://www.haproxy.org" target="_blank" rel="noopener">官网：http://www.haproxy.org</a></p><p><a href="https://cbonte.github.io/haproxy-dconv/" target="_blank" rel="noopener">帮助文档：https://cbonte.github.io/haproxy-dconv/</a></p><a id="more"></a><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><p><code>HAProxy</code>是<code>TCP</code>/<code>HTTP</code>反向代理服务器，尤其适合于高可用性环境</p><ul><li>可以针对<code>HTTP</code>请求添加<code>cookie</code>，进行路由后端服务器</li><li>可平衡负载至后端服务器，并支持持久连接</li><li>支持基于<code>cookie</code>进行调度</li><li>支持所有主服务器故障切换至备用服务器</li><li>支持专用端口实现监控服务</li><li>支持不影响现有连接情况下停止接受新连接请求</li><li>可以在双向添加，修改或删除HTTP报文首部</li><li>支持基于<code>pattern</code>实现连接请求的访问控制</li><li>通过特定的<code>URI</code>为授权用户提供详细的状态信息</li></ul><h3 id="HAProxy功能"><a href="#HAProxy功能" class="headerlink" title="HAProxy功能"></a>HAProxy功能</h3><ul><li>支持<code>http</code>反向代理</li><li>支持动态程序的反向代理</li><li>支持基于数据库的反向代理</li></ul><h3 id="安装HAProxy"><a href="#安装HAProxy" class="headerlink" title="安装HAProxy"></a>安装HAProxy</h3><p>直接通过yum安装即可，<code>HAProxy</code>已经集成在<code>base</code>源。大家也可以源码编译安装。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# yum install -y haproxy</span><br><span class="line">[root@centos6 ~]# yum info haproxy          # HAProxy相关信息</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Repository epel is listed more than once in the configuration</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">file://misc/cd/repodata/repomd.xml: [Errno 14] Could not open/read file://misc/cd/repodata/repomd.xml</span><br><span class="line">Trying other mirror.</span><br><span class="line">Installed Packages</span><br><span class="line">Name        : haproxy</span><br><span class="line">Arch        : x86_64</span><br><span class="line">Version     : 1.5.18</span><br><span class="line">Release     : 1.el6</span><br><span class="line">Size        : 2.5 M</span><br><span class="line">Repo        : installed</span><br><span class="line">From repo   : base</span><br><span class="line">Summary     : HAProxy is a TCP/HTTP reverse proxy for high availability environments</span><br><span class="line">URL         : http://www.haproxy.org/</span><br><span class="line">License     : GPLv2+</span><br><span class="line">Description : HAProxy is a TCP/HTTP reverse proxy which is particularly suited for high</span><br><span class="line">            : availability environments. Indeed, it can:</span><br><span class="line">            :  - route HTTP requests depending on statically assigned cookies</span><br><span class="line">            :  - spread load among several servers while assuring server persistence</span><br><span class="line">            :    through the use of HTTP cookies</span><br><span class="line">            :  - switch to backup servers in the event a main one fails</span><br><span class="line">            :  - accept connections to special ports dedicated to service monitoring</span><br><span class="line">            :  - stop accepting connections without breaking existing ones</span><br><span class="line">            :  - add, modify, and delete HTTP headers in both directions</span><br><span class="line">            :  - block requests matching particular patterns</span><br><span class="line">            :  - persists clients to the correct application server depending on</span><br><span class="line">            :    application cookies</span><br><span class="line">            :  - report detailed status as HTML pages to authenticated users from a URI</span><br><span class="line">            :    intercepted from the application</span><br><span class="line">[root@centos6 ~]# rpm -ql haproxy           # 查看HAProxy安装后生成的文件</span><br><span class="line">/etc/haproxy</span><br><span class="line">/etc/haproxy/haproxy.cfg</span><br><span class="line">/etc/logrotate.d/haproxy</span><br><span class="line">/etc/rc.d/init.d/haproxy</span><br><span class="line">/etc/sysconfig/haproxy</span><br><span class="line">/usr/bin/halog</span><br><span class="line">/usr/bin/iprange</span><br><span class="line">/usr/sbin/haproxy</span><br><span class="line">/usr/share/doc/haproxy-1.5.18</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/CHANGELOG</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/LICENSE</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/README</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/acl-content-sw.cfg</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/acl.fig</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/architecture.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/close-options.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/coding-style.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/configuration.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/content-sw-sample.cfg</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/cookie-options.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/cttproxy-src.cfg</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/backends-v0.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/backends.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/be-fe-changes.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/binding-possibilities.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/buffer-redesign.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/buffers.fig</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/config-language.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/connection-reuse.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/cttproxy-changes.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/entities-v2.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/how-it-works.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/http_load_time.url</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/rate-shaping.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/design-thoughts/sess_par_sec.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/gpl.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/haproxy-en.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/haproxy-fr.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/haproxy.1</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/haproxy.cfg</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/acl.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/body-parsing.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/buffer-operations.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/buffer-ops.fig</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/connect-status.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/connection-header.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/connection-scale.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/entities.fig</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/entities.pdf</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/entities.svg</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/entities.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/hashing.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/header-parser-speed.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/header-tree.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/http-cookies.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/http-docs.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/http-parsing.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/naming.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/pattern.dia</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/pattern.pdf</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/polling-states.fig</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/repartition-be-fe-fi.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/sequence.fig</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/stats-v2.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/stream-sock-states.fig</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/internals/todo.cttproxy</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/lgpl.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/proxy-protocol.txt</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/queuing.fig</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/tarpit.cfg</span><br><span class="line">/usr/share/doc/haproxy-1.5.18/url-switching.cfg</span><br><span class="line">/usr/share/haproxy</span><br><span class="line">/usr/share/haproxy/400.http</span><br><span class="line">/usr/share/haproxy/403.http</span><br><span class="line">/usr/share/haproxy/408.http</span><br><span class="line">/usr/share/haproxy/500.http</span><br><span class="line">/usr/share/haproxy/502.http</span><br><span class="line">/usr/share/haproxy/503.http</span><br><span class="line">/usr/share/haproxy/504.http</span><br><span class="line">/usr/share/haproxy/README</span><br><span class="line">/usr/share/man/man1/halog.1.gz</span><br><span class="line">/usr/share/man/man1/haproxy.1.gz</span><br><span class="line">/var/lib/haproxy</span><br></pre></td></tr></table></figure></p><h3 id="HAProxy程序环境"><a href="#HAProxy程序环境" class="headerlink" title="HAProxy程序环境"></a>HAProxy程序环境</h3><ul><li>主程序： <code>/usr/sbin/haproxy</code></li><li>配置文件： <code>/etc/haproxy/haproxy.cfg</code></li><li>Unit file： <code>/usr/lib/systemd/system/haproxy.service</code></li></ul>]]></content>
      
      <categories>
          
          <category> 负载均衡 </category>
          
          <category> Haproxy简介 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Haproxy </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Ansible常用模块二</title>
      <link href="/2017/10/30/Ansible-configure2/"/>
      <url>/2017/10/30/Ansible-configure2/</url>
      <content type="html"><![CDATA[<h3 id="service模块"><a href="#service模块" class="headerlink" title="service模块"></a>service模块</h3><p>指定服务的运行状态。</p><h4 id="帮助信息"><a href="#帮助信息" class="headerlink" title="帮助信息"></a>帮助信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible-doc -s service </span><br><span class="line">- name: Manage services.</span><br><span class="line">  action: service</span><br><span class="line">      arguments              # Additional arguments provided on the command line</span><br><span class="line">      enabled                # Whether the service should start on boot. *At least one of state and enabled are required.*</span><br><span class="line">      name=                  # Name of the service.</span><br><span class="line">      pattern                # If the service does not respond to the status command, name a substring to look for as would be found in the output of the `ps&apos; command as a stand-in for a</span><br><span class="line">                               status result.  If the string is found, the service will be assumed to be running.</span><br><span class="line">      runlevel               # For OpenRC init scripts (ex: Gentoo) only.  The runlevel that this service belongs to.</span><br><span class="line">      sleep                  # If the service is being `restarted&apos; then sleep this many seconds between the stop and start command. This helps to workaround badly behaving init scripts that</span><br><span class="line">                               exit immediately after signaling a process to stop.</span><br><span class="line">      state                  # `started&apos;/`stopped&apos; are idempotent actions that will not run commands unless necessary.  `restarted&apos; will always bounce the service.  `reloaded&apos; will always</span><br><span class="line">                               reload. *At least one of state and enabled are required.*</span><br><span class="line">      use                    # The service module actually uses system specific modules, normally through auto detection, this setting can force a specific module. Normally it uses the value</span><br><span class="line">                               of the &apos;ansible_service_mgr&apos; fact and falls back to the old &apos;service&apos; module when none matching is found.</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible web1 -a &quot;service autofs status&quot;           # 查看autofs服务的运行状态，都是运行的</span><br><span class="line">192.168.8.14 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">automount (pid  1544) is running...</span><br><span class="line"></span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">automount (pid  1596) is running...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -a &quot;chkconfig  --list autofs&quot;            # autofs服务都是开机自启动的</span><br><span class="line">192.168.8.14 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">autofs         0:off1:off2:on3:on4:on5:on6:off</span><br><span class="line"></span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">autofs         0:off1:off2:on3:on4:on5:on6:off</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m service -a &apos;name=&quot;autofs&quot; state=&quot;restarted&quot;&apos;      # 重启autofs服务</span><br><span class="line">192.168.8.14 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;autofs&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;autofs&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m service -a &apos;name=&quot;autofs&quot; state=&apos;stopped&apos;&apos;        # 停止autofs服务</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;autofs&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;stopped&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.14 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;autofs&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;stopped&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -a &quot;service autofs status&quot;           # 查看autofs服务状态，已经停止</span><br><span class="line">192.168.8.13 | FAILED | rc=3 &gt;&gt;</span><br><span class="line">automount is stopped</span><br><span class="line"></span><br><span class="line">192.168.8.14 | FAILED | rc=3 &gt;&gt;</span><br><span class="line">automount is stopped</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m service -a &apos;name=&quot;autofs&quot; state=&quot;started&quot;&apos;        # 启动autofs服务</span><br><span class="line">192.168.8.14 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;autofs&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;autofs&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@centos6 ~]# ansible web1 -a &apos;service autofs status&apos;           # 查看autofs状态，已经启动</span><br><span class="line">192.168.8.14 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">automount (pid  23086) is running...</span><br><span class="line"></span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">automount (pid  24883) is running...</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m service -a &apos;name=&quot;autofs&quot; state=&quot;reloaded&quot;&apos;       # 重新加载配置文件</span><br><span class="line">192.168.8.14 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;autofs&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;autofs&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;started&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m service -a &apos;name=&quot;autofs&quot; enabled=&quot;false&quot;&apos;        # 关闭开机自启动autofs</span><br><span class="line">192.168.8.14 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;enabled&quot;: false, </span><br><span class="line">    &quot;name&quot;: &quot;autofs&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;enabled&quot;: false, </span><br><span class="line">    &quot;name&quot;: &quot;autofs&quot;</span><br><span class="line">&#125;   </span><br><span class="line">[root@centos6 ~]# ansible web1 -a &quot;chkconfig autofs --list&quot;     # 确认</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">autofs         0:off1:off2:off3:off4:off5:off6:off</span><br><span class="line"></span><br><span class="line">192.168.8.14 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">autofs         0:off1:off2:off3:off4:off5:off6:off</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m service -a &apos;name=&quot;autofs&quot; enabled=&quot;true&quot;&apos;         # 开启开机自启动autofs</span><br><span class="line">192.168.8.14 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;enabled&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;autofs&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;enabled&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;autofs&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@centos6 ~]# ansible web1 -a &apos;chkconfig autofs --list&apos;         # 确认</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">autofs         0:off1:off2:on3:on4:on5:on6:off</span><br><span class="line"></span><br><span class="line">192.168.8.14 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">autofs         0:off1:off2:on3:on4:on5:on6:off</span><br></pre></td></tr></table></figure><h3 id="shell模块"><a href="#shell模块" class="headerlink" title="shell模块"></a>shell模块</h3><p>和<code>command</code>模块类似，尤其是用到管道等功能复杂的命令，建议使用shell。</p><h4 id="帮助信息-1"><a href="#帮助信息-1" class="headerlink" title="帮助信息"></a>帮助信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible-doc -s shell</span><br><span class="line">- name: Execute commands in nodes.</span><br><span class="line">  action: shell</span><br><span class="line">      chdir                  # cd into this directory before running the command</span><br><span class="line">      creates                # a filename, when it already exists, this step will *not* be run.</span><br><span class="line">      executable             # change the shell used to execute the command. Should be an absolute path to the executable.</span><br><span class="line">      free_form=             # The shell module takes a free form command to run, as a string.  There&apos;s not an actual option named &quot;free form&quot;.  See the examples!</span><br><span class="line">      removes                # a filename, when it does not exist, this step will *not* be run.</span><br><span class="line">      warn                   # if command warnings are on in ansible.cfg, do not warn about this particular line if set to no/false.</span><br></pre></td></tr></table></figure><h4 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible web1 -m user -a &apos;name=&quot;tset&quot;&apos;         # 添加test用户</span><br><span class="line">192.168.8.14 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 500, </span><br><span class="line">    &quot;home&quot;: &quot;/home/tset&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;tset&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: false, </span><br><span class="line">    &quot;uid&quot;: 500</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 2223, </span><br><span class="line">    &quot;home&quot;: &quot;/home/tset&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;tset&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: false, </span><br><span class="line">    &quot;uid&quot;: 2223</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m command -a &apos;echo haiyun | passwd --stdin test &apos;           # 注意看，command并没有把管道当命令只是当作字符串输出了</span><br><span class="line">192.168.8.14 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">haiyun | passwd --stdin test</span><br><span class="line"></span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">haiyun | passwd --stdin test</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m shell -a &apos;echo haiyun | passwd --stdin tset&apos;          # 修改密码成功，这就是command和shell的区别</span><br><span class="line">192.168.8.14 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Changing password for user tset.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line"></span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Changing password for user tset.</span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br></pre></td></tr></table></figure><h3 id="script模块"><a href="#script模块" class="headerlink" title="script模块"></a>script模块</h3><p>将本地脚本复制到远程主机并运行。</p><h4 id="帮助信息-2"><a href="#帮助信息-2" class="headerlink" title="帮助信息"></a>帮助信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible-doc -s script</span><br><span class="line">- name: Runs a local script on a remote node after transferring it</span><br><span class="line">  action: script</span><br><span class="line">      creates                # a filename, when it already exists, this step will *not* be run.</span><br><span class="line">      free_form=             # path to the local script file followed by optional arguments.</span><br><span class="line">      removes                # a filename, when it does not exist, this step will *not* be run.</span><br></pre></td></tr></table></figure><h4 id="实例-2"><a href="#实例-2" class="headerlink" title="实例"></a>实例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# cat /tmp/test.sh          # 创建一个测试脚本</span><br><span class="line">#!/bin/bash</span><br><span class="line">date</span><br><span class="line">useradd testuser</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m script -a &quot;/tmp/test.sh&quot;          # 将test.sh复制到远程主机并执行</span><br><span class="line">192.168.8.14 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;stderr&quot;: &quot;Shared connection to 192.168.8.14 closed.\r\n&quot;, </span><br><span class="line">    &quot;stdout&quot;: &quot;Mon Oct 30 22:15:29 CST 2017\r\n&quot;, </span><br><span class="line">    &quot;stdout_lines&quot;: [</span><br><span class="line">        &quot;Mon Oct 30 22:15:29 CST 2017&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;stderr&quot;: &quot;Shared connection to 192.168.8.13 closed.\r\n&quot;, </span><br><span class="line">    &quot;stdout&quot;: &quot;Mon Oct 30 22:15:29 CST 2017\r\n&quot;, </span><br><span class="line">    &quot;stdout_lines&quot;: [</span><br><span class="line">        &quot;Mon Oct 30 22:15:29 CST 2017&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">[root@centos6 ~]# ansible web1 -a &quot;getent passwd testuser&quot;      # 用户已经添加成功</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">testuser<img class="github-emoji" title="x" alt="x" src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8" height="20" width="20">2224:2224::/home/testuser:/bin/bash</span><br><span class="line"></span><br><span class="line">192.168.8.14 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">testuser<img class="github-emoji" title="x" alt="x" src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8" height="20" width="20">501:501::/home/testuser:/bin/bash</span><br></pre></td></tr></table></figure><h3 id="yum模块"><a href="#yum模块" class="headerlink" title="yum模块"></a>yum模块</h3><p>安装和卸载软件包。</p><h4 id="帮助信息-3"><a href="#帮助信息-3" class="headerlink" title="帮助信息"></a>帮助信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible-doc -s yum</span><br><span class="line">- name: Manages packages with the `yum&apos; package manager</span><br><span class="line">  action: yum</span><br><span class="line">      conf_file              # The remote yum configuration file to use for the transaction.</span><br><span class="line">      disable_gpg_check      # Whether to disable the GPG checking of signatures of packages being installed. Has an effect only if state is `present&apos; or `latest&apos;.</span><br><span class="line">      disablerepo            # `Repoid&apos; of repositories to disable for the install/update operation. These repos will not persist beyond the transaction. When specifying multiple repos,</span><br><span class="line">                               separate them with a &quot;,&quot;.</span><br><span class="line">      enablerepo             # `Repoid&apos; of repositories to enable for the install/update operation. These repos will not persist beyond the transaction. When specifying multiple repos,</span><br><span class="line">                               separate them with a &quot;,&quot;.</span><br><span class="line">      exclude                # Package name(s) to exclude when state=present, or latest</span><br><span class="line">      list                   # Various (non-idempotent) commands for usage with `/usr/bin/ansible&apos; and `not&apos; playbooks. See examples.</span><br><span class="line">      name=                  # Package name, or package specifier with version, like `name-1.0&apos;. When using state=latest, this can be &apos;*&apos; which means run: yum -y update. You can also pass a</span><br><span class="line">                               url or a local path to a rpm file (using state=present).  To operate on several packages this can accept a comma separated list</span><br><span class="line">                               of packages or (as of 2.0) a list of packages.</span><br><span class="line">      state                  # Whether to install (`present&apos; or `installed&apos;, `latest&apos;), or remove (`absent&apos; or `removed&apos;) a package.</span><br><span class="line">      update_cache           # Force updating the cache. Has an effect only if state is `present&apos; or `latest&apos;.</span><br><span class="line">      validate_certs         # This only applies if using a https url as the source of the rpm. e.g. for localinstall. If set to `no&apos;, the SSL certificates will not be validated. This should</span><br><span class="line">                               only set to `no&apos; used on personally controlled sites using self-signed certificates as it avoids verifying the source site. Prior</span><br><span class="line">                               to 2.1 the code worked as if this was set to `yes&apos;.</span><br></pre></td></tr></table></figure><h4 id="实例-3"><a href="#实例-3" class="headerlink" title="实例"></a>实例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible web1 -m yum -a &apos;name=&quot;httpd&quot;&apos;         # 安装httpd软件包</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;msg&quot;: &quot;file://misc/cd/repodata/repomd.xml: [Errno 14] Could not open/read file://misc/cd/repodata/repomd.xml\nTrying other mirror.\n&quot;, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;results&quot;: [</span><br><span class="line">        &quot;Loaded plugins: fastestmirror, security\nSetting up Install Process\nLoading mirror speeds from cached hostfile\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package httpd.x86_64 0:2.2.15-59.el6.centos will be installed\n--&gt; Processing Dependency: httpd-tools = 2.2.15-59.el6.centos for package: httpd-2.2.15-59.el6.centos.x86_64\n--&gt; Processing Dependency: apr-util-ldap for package: httpd-2.2.15-59.el6.centos.x86_64\n--&gt; Processing Dependency: /etc/mime.types for package: httpd-2.2.15-59.el6.centos.x86_64\n--&gt; Processing Dependency: libaprutil-1.so.0()(64bit) for package: httpd-2.2.15-59.el6.centos.x86_64\n--&gt; Processing Dependency: libapr-1.so.0()(64bit) for package: httpd-2.2.15-59.el6.centos.x86_64\n--&gt; Running transaction check\n---&gt; Package apr.x86_64 0:1.3.9-5.el6_2 will be installed\n---&gt; Package apr-util.x86_64 0:1.3.9-3.el6_0.1 will be installed\n---&gt; Package apr-util-ldap.x86_64 0:1.3.9-3.el6_0.1 will be installed\n---&gt; Package httpd-tools.x86_64 0:2.2.15-59.el6.centos will be installed\n---&gt; Package mailcap.noarch 0:2.1.31-2.el6 will be installed\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n================================================================================\n Package             Arch         Version                      Repository  Size\n================================================================================\nInstalling:\n httpd               x86_64       2.2.15-59.el6.centos         base       834 k\nInstalling for dependencies:\n apr                 x86_64       1.3.9-5.el6_2                base       123 k\n apr-util            x86_64       1.3.9-3.el6_0.1              base        87 k\n apr-util-ldap       x86_64       1.3.9-3.el6_0.1              base        15 k\n httpd-tools         x86_64       2.2.15-59.el6.centos         base        79 k\n mailcap             noarch       2.1.31-2.el6                 base        27 k\n\nTransaction Summary\n================================================================================\nInstall       6 Package(s)\n\nTotal download size: 1.1 M\nInstalled size: 3.7 M\nDownloading Packages:\n--------------------------------------------------------------------------------\nTotal                                           2.2 MB/s | 1.1 MB     00:00     \nRunning rpm_check_debug\nRunning Transaction Test\nTransaction Test Succeeded\nRunning Transaction\n\r  Installing : apr-1.3.9-5.el6_2.x86_64                                     1/6 \n\r  Installing : apr-util-1.3.9-3.el6_0.1.x86_64                              2/6 \n\r  Installing : httpd-tools-2.2.15-59.el6.centos.x86_64                      3/6 \n\r  Installing : apr-util-ldap-1.3.9-3.el6_0.1.x86_64                         4/6 \n\r  Installing : mailcap-2.1.31-2.el6.noarch                                  5/6 \n\r  Installing : httpd-2.2.15-59.el6.centos.x86_64                            6/6 \n\r  Verifying  : httpd-tools-2.2.15-59.el6.centos.x86_64                      1/6 \n\r  Verifying  : apr-util-ldap-1.3.9-3.el6_0.1.x86_64                         2/6 \n\r  Verifying  : httpd-2.2.15-59.el6.centos.x86_64                            3/6 \n\r  Verifying  : apr-1.3.9-5.el6_2.x86_64                                     4/6 \n\r  Verifying  : mailcap-2.1.31-2.el6.noarch                                  5/6 \n\r  Verifying  : apr-util-1.3.9-3.el6_0.1.x86_64                              6/6 \n\nInstalled:\n  httpd.x86_64 0:2.2.15-59.el6.centos                                           \n\nDependency Installed:\n  apr.x86_64 0:1.3.9-5.el6_2                                                    \n  apr-util.x86_64 0:1.3.9-3.el6_0.1                                             \n  apr-util-ldap.x86_64 0:1.3.9-3.el6_0.1                                        \n  httpd-tools.x86_64 0:2.2.15-59.el6.centos                                     \n  mailcap.noarch 0:2.1.31-2.el6                                                 \n\nComplete!\n&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.14 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;msg&quot;: &quot;file://misc/cd/repodata/repomd.xml: [Errno 14] Could not open/read file://misc/cd/repodata/repomd.xml\nTrying other mirror.\n&quot;, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;results&quot;: [</span><br><span class="line">        &quot;Loaded plugins: fastestmirror, security\nSetting up Install Process\nLoading mirror speeds from cached hostfile\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package httpd.x86_64 0:2.2.15-59.el6.centos will be installed\n--&gt; Processing Dependency: httpd-tools = 2.2.15-59.el6.centos for package: httpd-2.2.15-59.el6.centos.x86_64\n--&gt; Processing Dependency: apr-util-ldap for package: httpd-2.2.15-59.el6.centos.x86_64\n--&gt; Processing Dependency: /etc/mime.types for package: httpd-2.2.15-59.el6.centos.x86_64\n--&gt; Processing Dependency: libaprutil-1.so.0()(64bit) for package: httpd-2.2.15-59.el6.centos.x86_64\n--&gt; Processing Dependency: libapr-1.so.0()(64bit) for package: httpd-2.2.15-59.el6.centos.x86_64\n--&gt; Running transaction check\n---&gt; Package apr.x86_64 0:1.3.9-5.el6_2 will be installed\n---&gt; Package apr-util.x86_64 0:1.3.9-3.el6_0.1 will be installed\n---&gt; Package apr-util-ldap.x86_64 0:1.3.9-3.el6_0.1 will be installed\n---&gt; Package httpd-tools.x86_64 0:2.2.15-59.el6.centos will be installed\n---&gt; Package mailcap.noarch 0:2.1.31-2.el6 will be installed\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n================================================================================\n Package             Arch         Version                      Repository  Size\n================================================================================\nInstalling:\n httpd               x86_64       2.2.15-59.el6.centos         base       834 k\nInstalling for dependencies:\n apr                 x86_64       1.3.9-5.el6_2                base       123 k\n apr-util            x86_64       1.3.9-3.el6_0.1              base        87 k\n apr-util-ldap       x86_64       1.3.9-3.el6_0.1              base        15 k\n httpd-tools         x86_64       2.2.15-59.el6.centos         base        79 k\n mailcap             noarch       2.1.31-2.el6                 base        27 k\n\nTransaction Summary\n================================================================================\nInstall       6 Package(s)\n\nTotal download size: 1.1 M\nInstalled size: 3.7 M\nDownloading Packages:\n--------------------------------------------------------------------------------\nTotal                                           6.1 MB/s | 1.1 MB     00:00     \nRunning rpm_check_debug\nRunning Transaction Test\nTransaction Test Succeeded\nRunning Transaction\n\r  Installing : apr-1.3.9-5.el6_2.x86_64                                     1/6 \n\r  Installing : apr-util-1.3.9-3.el6_0.1.x86_64                              2/6 \n\r  Installing : httpd-tools-2.2.15-59.el6.centos.x86_64                      3/6 \n\r  Installing : apr-util-ldap-1.3.9-3.el6_0.1.x86_64                         4/6 \n\r  Installing : mailcap-2.1.31-2.el6.noarch                                  5/6 \n\r  Installing : httpd-2.2.15-59.el6.centos.x86_64                            6/6 \n\r  Verifying  : httpd-tools-2.2.15-59.el6.centos.x86_64                      1/6 \n\r  Verifying  : apr-util-ldap-1.3.9-3.el6_0.1.x86_64                         2/6 \n\r  Verifying  : httpd-2.2.15-59.el6.centos.x86_64                            3/6 \n\r  Verifying  : apr-1.3.9-5.el6_2.x86_64                                     4/6 \n\r  Verifying  : mailcap-2.1.31-2.el6.noarch                                  5/6 \n\r  Verifying  : apr-util-1.3.9-3.el6_0.1.x86_64                              6/6 \n\nInstalled:\n  httpd.x86_64 0:2.2.15-59.el6.centos                                           \n\nDependency Installed:\n  apr.x86_64 0:1.3.9-5.el6_2                                                    \n  apr-util.x86_64 0:1.3.9-3.el6_0.1                                             \n  apr-util-ldap.x86_64 0:1.3.9-3.el6_0.1                                        \n  httpd-tools.x86_64 0:2.2.15-59.el6.centos                                     \n  mailcap.noarch 0:2.1.31-2.el6                                                 \n\nComplete!\n&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -a &apos;rpm -q httpd&apos;        # 确认，已经安装</span><br><span class="line">192.168.8.14 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">httpd-2.2.15-59.el6.centos.x86_64</span><br><span class="line"></span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">httpd-2.2.15-59.el6.centos.x86_64</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m yum  -a &apos;name=&quot;httpd&quot; state=&quot;absent&quot;&apos;         # 卸载httpd软件包</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;msg&quot;: &quot;&quot;, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;results&quot;: [</span><br><span class="line">        &quot;Loaded plugins: fastestmirror, security\nSetting up Remove Process\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package httpd.x86_64 0:2.2.15-59.el6.centos will be erased\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n================================================================================\n Package       Arch           Version                       Repository     Size\n================================================================================\nRemoving:\n httpd         x86_64         2.2.15-59.el6.centos          @base         3.0 M\n\nTransaction Summary\n================================================================================\nRemove        1 Package(s)\n\nInstalled size: 3.0 M\nDownloading Packages:\nRunning rpm_check_debug\nRunning Transaction Test\nTransaction Test Succeeded\nRunning Transaction\n\r  Erasing    : httpd-2.2.15-59.el6.centos.x86_64                            1/1 \n\r  Verifying  : httpd-2.2.15-59.el6.centos.x86_64                            1/1 \n\nRemoved:\n  httpd.x86_64 0:2.2.15-59.el6.centos                                           \n\nComplete!\n&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.14 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;msg&quot;: &quot;&quot;, </span><br><span class="line">    &quot;rc&quot;: 0, </span><br><span class="line">    &quot;results&quot;: [</span><br><span class="line">        &quot;Loaded plugins: fastestmirror, security\nSetting up Remove Process\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package httpd.x86_64 0:2.2.15-59.el6.centos will be erased\n--&gt; Finished Dependency Resolution\n\nDependencies Resolved\n\n================================================================================\n Package       Arch           Version                       Repository     Size\n================================================================================\nRemoving:\n httpd         x86_64         2.2.15-59.el6.centos          @base         3.0 M\n\nTransaction Summary\n================================================================================\nRemove        1 Package(s)\n\nInstalled size: 3.0 M\nDownloading Packages:\nRunning rpm_check_debug\nRunning Transaction Test\nTransaction Test Succeeded\nRunning Transaction\n\r  Erasing    : httpd-2.2.15-59.el6.centos.x86_64                            1/1 \n\r  Verifying  : httpd-2.2.15-59.el6.centos.x86_64                            1/1 \n\nRemoved:\n  httpd.x86_64 0:2.2.15-59.el6.centos                                           \n\nComplete!\n&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -a &apos;rpm -q httpd&apos;        # 确认，已经卸载</span><br><span class="line">192.168.8.14 | FAILED | rc=1 &gt;&gt;</span><br><span class="line">package httpd is not installed</span><br><span class="line"></span><br><span class="line">192.168.8.13 | FAILED | rc=1 &gt;&gt;</span><br><span class="line">package httpd is not installed</span><br></pre></td></tr></table></figure><h3 id="setup模块"><a href="#setup模块" class="headerlink" title="setup模块"></a>setup模块</h3><p><code>setup</code>模块：收集远程主机的<code>facts</code>。</p><ul><li>每个被管理节点在接收并运行管理命令之前。会将自己主机相关信息，如操作系统版本、<code>IP</code>地址等报告给<code>ansbile</code>主机。</li></ul><h4 id="帮助信息-4"><a href="#帮助信息-4" class="headerlink" title="帮助信息"></a>帮助信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible-doc -s setup          # 信息如下</span><br><span class="line">- name: Gathers facts about remote hosts</span><br><span class="line">  action: setup</span><br><span class="line">      fact_path              # path used for local ansible facts (*.fact) - files in this dir will be run (if executable) and their results be added to ansible_local facts if a file is not</span><br><span class="line">                               executable it is read. Check notes for Windows options. (from 2.1 on) File/results format can be json or ini-format</span><br><span class="line">      filter                 # if supplied, only return facts that match this shell-style (fnmatch) wildcard.</span><br><span class="line">      gather_subset          # if supplied, restrict the additional facts collected to the given subset. Possible values: all, hardware, network, virtual, ohai, and facter Can specify a list</span><br><span class="line">                               of values to specify a larger subset. Values can also be used with an initial `!&apos; to specify that that specific subset should not</span><br><span class="line">                               be collected.  For instance: !hardware, !network, !virtual, !ohai, !facter.  Note that a few facts are always collected.  Use the</span><br><span class="line">                               filter parameter if you do not want to display those.</span><br><span class="line">      gather_timeout         # Set the default timeout in seconds for individual fact gathering</span><br></pre></td></tr></table></figure><h4 id="实例-4"><a href="#实例-4" class="headerlink" title="实例"></a>实例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible web1 -m setup </span><br><span class="line">192.168.8.14 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_all_ipv4_addresses&quot;: [</span><br><span class="line">            &quot;172.18.254.49&quot;, </span><br><span class="line">            &quot;192.168.8.14&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_all_ipv6_addresses&quot;: [</span><br><span class="line">            &quot;fe80::20c:29ff:fefc:1402&quot;, </span><br><span class="line">            &quot;fe80::20c:29ff:fefc:140c&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_architecture&quot;: &quot;x86_64&quot;, </span><br><span class="line">        &quot;ansible_bios_date&quot;: &quot;07/02/2015&quot;, </span><br><span class="line">        &quot;ansible_bios_version&quot;: &quot;6.00&quot;, </span><br><span class="line">        &quot;ansible_cmdline&quot;: &#123;</span><br><span class="line">            &quot;KEYBOARDTYPE&quot;: &quot;pc&quot;, </span><br><span class="line">            &quot;KEYTABLE&quot;: &quot;us&quot;, </span><br><span class="line">            &quot;LANG&quot;: &quot;en_US.UTF-8&quot;, </span><br><span class="line">            &quot;SYSFONT&quot;: &quot;latarcyrheb-sun16&quot;, </span><br><span class="line">            &quot;quiet&quot;: true, </span><br><span class="line">            &quot;rd_NO_DM&quot;: true, </span><br><span class="line">            &quot;rd_NO_LUKS&quot;: true, </span><br><span class="line">            &quot;rd_NO_LVM&quot;: true, </span><br><span class="line">            &quot;rd_NO_MD&quot;: true, </span><br><span class="line">            &quot;rhgb&quot;: true, </span><br><span class="line">            &quot;ro&quot;: true, </span><br><span class="line">            &quot;root&quot;: &quot;UUID=de56e176-3b0b-4c02-84bc-84c99bfda1ac&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_date_time&quot;: &#123;</span><br><span class="line">            &quot;date&quot;: &quot;2017-10-30&quot;, </span><br><span class="line">            &quot;day&quot;: &quot;30&quot;, </span><br><span class="line">            &quot;epoch&quot;: &quot;1509373858&quot;, </span><br><span class="line">            &quot;hour&quot;: &quot;22&quot;, </span><br><span class="line">            &quot;iso8601&quot;: &quot;2017-10-30T14:30:58Z&quot;, </span><br><span class="line">            &quot;iso8601_basic&quot;: &quot;20171030T223058088697&quot;, </span><br><span class="line">            &quot;iso8601_basic_short&quot;: &quot;20171030T223058&quot;, </span><br><span class="line">            &quot;iso8601_micro&quot;: &quot;2017-10-30T14:30:58.088808Z&quot;, </span><br><span class="line">            &quot;minute&quot;: &quot;30&quot;, </span><br><span class="line">            &quot;month&quot;: &quot;10&quot;, </span><br><span class="line">            &quot;second&quot;: &quot;58&quot;, </span><br><span class="line">            &quot;time&quot;: &quot;22:30:58&quot;, </span><br><span class="line">            &quot;tz&quot;: &quot;CST&quot;, </span><br><span class="line">            &quot;tz_offset&quot;: &quot;+0800&quot;, </span><br><span class="line">            &quot;weekday&quot;: &quot;Monday&quot;, </span><br><span class="line">            &quot;weekday_number&quot;: &quot;1&quot;, </span><br><span class="line">            &quot;weeknumber&quot;: &quot;44&quot;, </span><br><span class="line">            &quot;year&quot;: &quot;2017&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_default_ipv4&quot;: &#123;</span><br><span class="line">            &quot;address&quot;: &quot;172.18.254.49&quot;, </span><br><span class="line">            &quot;alias&quot;: &quot;eth0&quot;, </span><br><span class="line">            &quot;broadcast&quot;: &quot;172.18.255.255&quot;, </span><br><span class="line">            &quot;gateway&quot;: &quot;172.18.0.1&quot;, </span><br><span class="line">            &quot;interface&quot;: &quot;eth0&quot;, </span><br><span class="line">            &quot;macaddress&quot;: &quot;00:0c:29:fc:14:02&quot;, </span><br><span class="line">            &quot;mtu&quot;: 1500, </span><br><span class="line">            &quot;netmask&quot;: &quot;255.255.0.0&quot;, </span><br><span class="line">            &quot;network&quot;: &quot;172.18.0.0&quot;, </span><br><span class="line">            &quot;type&quot;: &quot;ether&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_default_ipv6&quot;: &#123;&#125;, </span><br><span class="line">        &quot;ansible_devices&quot;: &#123;</span><br><span class="line">            &quot;sda&quot;: &#123;</span><br><span class="line">                &quot;holders&quot;: [], </span><br><span class="line">                &quot;host&quot;: &quot;SCSI storage controller: LSI Logic / Symbios Logic 53c1030 PCI-X Fusion-MPT Dual Ultra320 SCSI (rev 01)&quot;, </span><br><span class="line">                &quot;model&quot;: &quot;VMware Virtual S&quot;, </span><br><span class="line">                &quot;partitions&quot;: &#123;</span><br><span class="line">                    &quot;sda1&quot;: &#123;</span><br><span class="line">                        &quot;holders&quot;: [], </span><br><span class="line">                        &quot;sectors&quot;: &quot;8388608&quot;, </span><br><span class="line">                        &quot;sectorsize&quot;: 512, </span><br><span class="line">                        &quot;size&quot;: &quot;4.00 GB&quot;, </span><br><span class="line">                        &quot;start&quot;: &quot;2048&quot;, </span><br><span class="line">                        &quot;uuid&quot;: &quot;bbebea2d-5e04-4638-9a48-fb59c406bbbc&quot;</span><br><span class="line">                    &#125;, </span><br><span class="line">                    &quot;sda2&quot;: &#123;</span><br><span class="line">                        &quot;holders&quot;: [], </span><br><span class="line">                        &quot;sectors&quot;: &quot;104857600&quot;, </span><br><span class="line">                        &quot;sectorsize&quot;: 512, </span><br><span class="line">                        &quot;size&quot;: &quot;50.00 GB&quot;, </span><br><span class="line">                        &quot;start&quot;: &quot;8390656&quot;, </span><br><span class="line">                        &quot;uuid&quot;: &quot;de56e176-3b0b-4c02-84bc-84c99bfda1ac&quot;</span><br><span class="line">                    &#125;, </span><br><span class="line">                    &quot;sda3&quot;: &#123;</span><br><span class="line">                        &quot;holders&quot;: [], </span><br><span class="line">                        &quot;sectors&quot;: &quot;104857600&quot;, </span><br><span class="line">                        &quot;sectorsize&quot;: 512, </span><br><span class="line">                        &quot;size&quot;: &quot;50.00 GB&quot;, </span><br><span class="line">                        &quot;start&quot;: &quot;113248256&quot;, </span><br><span class="line">                        &quot;uuid&quot;: &quot;2cd02e07-26b7-45d4-bdd1-432e0fc763f9&quot;</span><br><span class="line">                    &#125;, </span><br><span class="line">                    &quot;sda4&quot;: &#123;</span><br><span class="line">                        &quot;holders&quot;: [], </span><br><span class="line">                        &quot;sectors&quot;: &quot;2&quot;, </span><br><span class="line">                        &quot;sectorsize&quot;: 512, </span><br><span class="line">                        &quot;size&quot;: &quot;1.00 KB&quot;, </span><br><span class="line">                        &quot;start&quot;: &quot;218105856&quot;, </span><br><span class="line">                        &quot;uuid&quot;: null</span><br><span class="line">                    &#125;, </span><br><span class="line">                    &quot;sda5&quot;: &#123;</span><br><span class="line">                        &quot;holders&quot;: [], </span><br><span class="line">                        &quot;sectors&quot;: &quot;41943040&quot;, </span><br><span class="line">                        &quot;sectorsize&quot;: 512, </span><br><span class="line">                        &quot;size&quot;: &quot;20.00 GB&quot;, </span><br><span class="line">                        &quot;start&quot;: &quot;218109952&quot;, </span><br><span class="line">                        &quot;uuid&quot;: &quot;0eb283d4-fc17-40a7-b025-4aea863a9858&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, </span><br><span class="line">                &quot;removable&quot;: &quot;0&quot;, </span><br><span class="line">                &quot;rotational&quot;: &quot;1&quot;, </span><br><span class="line">                &quot;sas_address&quot;: null, </span><br><span class="line">                &quot;sas_device_handle&quot;: null, </span><br><span class="line">                &quot;scheduler_mode&quot;: &quot;cfq&quot;, </span><br><span class="line">                &quot;sectors&quot;: &quot;419430400&quot;, </span><br><span class="line">                &quot;sectorsize&quot;: &quot;512&quot;, </span><br><span class="line">                &quot;size&quot;: &quot;200.00 GB&quot;, </span><br><span class="line">                &quot;support_discard&quot;: &quot;0&quot;, </span><br><span class="line">                &quot;vendor&quot;: &quot;VMware,&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;sr0&quot;: &#123;</span><br><span class="line">                &quot;holders&quot;: [], </span><br><span class="line">                &quot;host&quot;: &quot;IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)&quot;, </span><br><span class="line">                &quot;model&quot;: &quot;VMware IDE CDR10&quot;, </span><br><span class="line">                &quot;partitions&quot;: &#123;&#125;, </span><br><span class="line">                &quot;removable&quot;: &quot;1&quot;, </span><br><span class="line">                &quot;rotational&quot;: &quot;1&quot;, </span><br><span class="line">                &quot;sas_address&quot;: null, </span><br><span class="line">                &quot;sas_device_handle&quot;: null, </span><br><span class="line">                &quot;scheduler_mode&quot;: &quot;cfq&quot;, </span><br><span class="line">                &quot;sectors&quot;: &quot;7757824&quot;, </span><br><span class="line">                &quot;sectorsize&quot;: &quot;2048&quot;, </span><br><span class="line">                &quot;size&quot;: &quot;14.80 GB&quot;, </span><br><span class="line">                &quot;support_discard&quot;: &quot;0&quot;, </span><br><span class="line">                &quot;vendor&quot;: &quot;NECVMWar&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_distribution&quot;: &quot;CentOS&quot;, </span><br><span class="line">        &quot;ansible_distribution_major_version&quot;: &quot;6&quot;, </span><br><span class="line">        &quot;ansible_distribution_release&quot;: &quot;Final&quot;, </span><br><span class="line">        &quot;ansible_distribution_version&quot;: &quot;6.9&quot;, </span><br><span class="line">        &quot;ansible_dns&quot;: &#123;</span><br><span class="line">            &quot;nameservers&quot;: [</span><br><span class="line">                &quot;172.18.0.1&quot;</span><br><span class="line">            ], </span><br><span class="line">            &quot;search&quot;: [</span><br><span class="line">                &quot;magedu.com&quot;, </span><br><span class="line">                &quot;haiyun.com&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_domain&quot;: &quot;genericreverse.com&quot;, </span><br><span class="line">        &quot;ansible_env&quot;: &#123;</span><br><span class="line">            &quot;G_BROKEN_FILENAMES&quot;: &quot;1&quot;, </span><br><span class="line">            &quot;HOME&quot;: &quot;/root&quot;, </span><br><span class="line">            &quot;LANG&quot;: &quot;en_US.UTF-8&quot;, </span><br><span class="line">            &quot;LESSOPEN&quot;: &quot;||/usr/bin/lesspipe.sh %s&quot;, </span><br><span class="line">            &quot;LOGNAME&quot;: &quot;root&quot;, </span><br><span class="line">            &quot;LS_COLORS&quot;: &quot;rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=01;05;37;41:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lz=01;31:*.xz=01;31:*.bz2=01;31:*.tbz=01;31:*.tbz2=01;31:*.bz=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.rar=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=01;36:*.au=01;36:*.flac=01;36:*.mid=01;36:*.midi=01;36:*.mka=01;36:*.mp3=01;36:*.mpc=01;36:*.ogg=01;36:*.ra=01;36:*.wav=01;36:*.axa=01;36:*.oga=01;36:*.spx=01;36:*.xspf=01;36:&quot;, </span><br><span class="line">            &quot;MAIL&quot;: &quot;/var/mail/root&quot;, </span><br><span class="line">            &quot;PATH&quot;: &quot;/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin&quot;, </span><br><span class="line">            &quot;PWD&quot;: &quot;/root&quot;, </span><br><span class="line">            &quot;SHELL&quot;: &quot;/bin/bash&quot;, </span><br><span class="line">            &quot;SHLVL&quot;: &quot;2&quot;, </span><br><span class="line">            &quot;SSH_CLIENT&quot;: &quot;192.168.8.11 34978 22&quot;, </span><br><span class="line">            &quot;SSH_CONNECTION&quot;: &quot;192.168.8.11 34978 192.168.8.14 22&quot;, </span><br><span class="line">            &quot;SSH_TTY&quot;: &quot;/dev/pts/1&quot;, </span><br><span class="line">            &quot;TERM&quot;: &quot;xterm&quot;, </span><br><span class="line">            &quot;USER&quot;: &quot;root&quot;, </span><br><span class="line">            &quot;_&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_eth0&quot;: &#123;</span><br><span class="line">            &quot;active&quot;: true, </span><br><span class="line">            &quot;device&quot;: &quot;eth0&quot;, </span><br><span class="line">            &quot;features&quot;: &#123;</span><br><span class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;highdma&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;loopback&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;netns_local&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;rx_checksumming&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;rx_vlan_filter&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;rx_vlan_offload&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_checksum_sctp&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_unneeded&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_gre_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_gso_robust&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_lockless&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_scatter_gather&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_vlan_offload&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;udp_fragmentation_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;vlan_challenged&quot;: &quot;off [fixed]&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;ipv4&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;172.18.254.49&quot;, </span><br><span class="line">                &quot;broadcast&quot;: &quot;172.18.255.255&quot;, </span><br><span class="line">                &quot;netmask&quot;: &quot;255.255.0.0&quot;, </span><br><span class="line">                &quot;network&quot;: &quot;172.18.0.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;ipv6&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;address&quot;: &quot;fe80::20c:29ff:fefc:1402&quot;, </span><br><span class="line">                    &quot;prefix&quot;: &quot;64&quot;, </span><br><span class="line">                    &quot;scope&quot;: &quot;link&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ], </span><br><span class="line">            &quot;macaddress&quot;: &quot;00:0c:29:fc:14:02&quot;, </span><br><span class="line">            &quot;module&quot;: &quot;e1000&quot;, </span><br><span class="line">            &quot;mtu&quot;: 1500, </span><br><span class="line">            &quot;pciid&quot;: &quot;0000:02:01.0&quot;, </span><br><span class="line">            &quot;promisc&quot;: false, </span><br><span class="line">            &quot;speed&quot;: 1000, </span><br><span class="line">            &quot;type&quot;: &quot;ether&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_eth1&quot;: &#123;</span><br><span class="line">            &quot;active&quot;: true, </span><br><span class="line">            &quot;device&quot;: &quot;eth1&quot;, </span><br><span class="line">            &quot;features&quot;: &#123;</span><br><span class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;highdma&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;loopback&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;netns_local&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;rx_checksumming&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;rx_vlan_filter&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;rx_vlan_offload&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_checksum_sctp&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_unneeded&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_gre_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_gso_robust&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_lockless&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_scatter_gather&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_vlan_offload&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;udp_fragmentation_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;vlan_challenged&quot;: &quot;off [fixed]&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;ipv4&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;192.168.8.14&quot;, </span><br><span class="line">                &quot;broadcast&quot;: &quot;192.168.8.255&quot;, </span><br><span class="line">                &quot;netmask&quot;: &quot;255.255.255.0&quot;, </span><br><span class="line">                &quot;network&quot;: &quot;192.168.8.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;ipv6&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;address&quot;: &quot;fe80::20c:29ff:fefc:140c&quot;, </span><br><span class="line">                    &quot;prefix&quot;: &quot;64&quot;, </span><br><span class="line">                    &quot;scope&quot;: &quot;link&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ], </span><br><span class="line">            &quot;macaddress&quot;: &quot;00:0c:29:fc:14:0c&quot;, </span><br><span class="line">            &quot;module&quot;: &quot;e1000&quot;, </span><br><span class="line">            &quot;mtu&quot;: 1500, </span><br><span class="line">            &quot;pciid&quot;: &quot;0000:02:02.0&quot;, </span><br><span class="line">            &quot;promisc&quot;: false, </span><br><span class="line">            &quot;speed&quot;: 1000, </span><br><span class="line">            &quot;type&quot;: &quot;ether&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_fips&quot;: false, </span><br><span class="line">        &quot;ansible_form_factor&quot;: &quot;Other&quot;, </span><br><span class="line">        &quot;ansible_fqdn&quot;: &quot;204-74-211-183.genericreverse.com&quot;, </span><br><span class="line">        &quot;ansible_gather_subset&quot;: [</span><br><span class="line">            &quot;hardware&quot;, </span><br><span class="line">            &quot;network&quot;, </span><br><span class="line">            &quot;virtual&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_hostname&quot;: &quot;centos6&quot;, </span><br><span class="line">        &quot;ansible_interfaces&quot;: [</span><br><span class="line">            &quot;lo&quot;, </span><br><span class="line">            &quot;eth1&quot;, </span><br><span class="line">            &quot;eth0&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_kernel&quot;: &quot;2.6.32-696.el6.x86_64&quot;, </span><br><span class="line">        &quot;ansible_lo&quot;: &#123;</span><br><span class="line">            &quot;active&quot;: true, </span><br><span class="line">            &quot;device&quot;: &quot;lo&quot;, </span><br><span class="line">            &quot;features&quot;: &#123;</span><br><span class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;highdma&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;loopback&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;netns_local&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;rx_checksumming&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;rx_vlan_filter&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;rx_vlan_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_sctp&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_unneeded&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_gre_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_gso_robust&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_lockless&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;tx_scatter_gather&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_vlan_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;udp_fragmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;vlan_challenged&quot;: &quot;on [fixed]&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;ipv4&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;127.0.0.1&quot;, </span><br><span class="line">                &quot;broadcast&quot;: &quot;host&quot;, </span><br><span class="line">                &quot;netmask&quot;: &quot;255.0.0.0&quot;, </span><br><span class="line">                &quot;network&quot;: &quot;127.0.0.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;ipv6&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;address&quot;: &quot;::1&quot;, </span><br><span class="line">                    &quot;prefix&quot;: &quot;128&quot;, </span><br><span class="line">                    &quot;scope&quot;: &quot;host&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ], </span><br><span class="line">            &quot;mtu&quot;: 65536, </span><br><span class="line">            &quot;promisc&quot;: false, </span><br><span class="line">            &quot;type&quot;: &quot;loopback&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_lvm&quot;: &#123;</span><br><span class="line">            &quot;lvs&quot;: &#123;&#125;, </span><br><span class="line">            &quot;vgs&quot;: &#123;&#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_machine&quot;: &quot;x86_64&quot;, </span><br><span class="line">        &quot;ansible_machine_id&quot;: &quot;948d9e6668675b7782adc61a00000008&quot;, </span><br><span class="line">        &quot;ansible_memfree_mb&quot;: 555, </span><br><span class="line">        &quot;ansible_memory_mb&quot;: &#123;</span><br><span class="line">            &quot;nocache&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 848, </span><br><span class="line">                &quot;used&quot;: 132</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;real&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 555, </span><br><span class="line">                &quot;total&quot;: 980, </span><br><span class="line">                &quot;used&quot;: 425</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;swap&quot;: &#123;</span><br><span class="line">                &quot;cached&quot;: 0, </span><br><span class="line">                &quot;free&quot;: 0, </span><br><span class="line">                &quot;total&quot;: 0, </span><br><span class="line">                &quot;used&quot;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_memtotal_mb&quot;: 980, </span><br><span class="line">        &quot;ansible_mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;device&quot;: &quot;/dev/sda2&quot;, </span><br><span class="line">                &quot;fstype&quot;: &quot;ext4&quot;, </span><br><span class="line">                &quot;mount&quot;: &quot;/&quot;, </span><br><span class="line">                &quot;options&quot;: &quot;rw&quot;, </span><br><span class="line">                &quot;size_available&quot;: 49024323584, </span><br><span class="line">                &quot;size_total&quot;: 52710469632, </span><br><span class="line">                &quot;uuid&quot;: &quot;N/A&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                &quot;device&quot;: &quot;/dev/sda3&quot;, </span><br><span class="line">                &quot;fstype&quot;: &quot;ext4&quot;, </span><br><span class="line">                &quot;mount&quot;: &quot;/app&quot;, </span><br><span class="line">                &quot;options&quot;: &quot;rw&quot;, </span><br><span class="line">                &quot;size_available&quot;: 49971777536, </span><br><span class="line">                &quot;size_total&quot;: 52710469632, </span><br><span class="line">                &quot;uuid&quot;: &quot;N/A&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                &quot;device&quot;: &quot;/dev/sda1&quot;, </span><br><span class="line">                &quot;fstype&quot;: &quot;ext4&quot;, </span><br><span class="line">                &quot;mount&quot;: &quot;/boot&quot;, </span><br><span class="line">                &quot;options&quot;: &quot;rw&quot;, </span><br><span class="line">                &quot;size_available&quot;: 3836063744, </span><br><span class="line">                &quot;size_total&quot;: 4093313024, </span><br><span class="line">                &quot;uuid&quot;: &quot;N/A&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                &quot;device&quot;: &quot;/dev/sda5&quot;, </span><br><span class="line">                &quot;fstype&quot;: &quot;ext4&quot;, </span><br><span class="line">                &quot;mount&quot;: &quot;/script&quot;, </span><br><span class="line">                &quot;options&quot;: &quot;rw&quot;, </span><br><span class="line">                &quot;size_available&quot;: 19883814912, </span><br><span class="line">                &quot;size_total&quot;: 21003628544, </span><br><span class="line">                &quot;uuid&quot;: &quot;N/A&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_nodename&quot;: &quot;centos6.haiyun.com&quot;, </span><br><span class="line">        &quot;ansible_os_family&quot;: &quot;RedHat&quot;, </span><br><span class="line">        &quot;ansible_pkg_mgr&quot;: &quot;yum&quot;, </span><br><span class="line">        &quot;ansible_processor&quot;: [</span><br><span class="line">            &quot;GenuineIntel&quot;, </span><br><span class="line">            &quot;Intel(R) Core(TM) i5-6300HQ CPU @ 2.30GHz&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_processor_cores&quot;: 1, </span><br><span class="line">        &quot;ansible_processor_count&quot;: 1, </span><br><span class="line">        &quot;ansible_processor_threads_per_core&quot;: 1, </span><br><span class="line">        &quot;ansible_processor_vcpus&quot;: 1, </span><br><span class="line">        &quot;ansible_product_name&quot;: &quot;VMware Virtual Platform&quot;, </span><br><span class="line">        &quot;ansible_product_serial&quot;: &quot;VMware-56 4d 06 1b 69 98 c0 ca-2d a3 33 45 27 fc 14 02&quot;, </span><br><span class="line">        &quot;ansible_product_uuid&quot;: &quot;564D061B-6998-C0CA-2DA3-334527FC1402&quot;, </span><br><span class="line">        &quot;ansible_product_version&quot;: &quot;None&quot;, </span><br><span class="line">        &quot;ansible_python&quot;: &#123;</span><br><span class="line">            &quot;executable&quot;: &quot;/usr/bin/python&quot;, </span><br><span class="line">            &quot;has_sslcontext&quot;: false, </span><br><span class="line">            &quot;type&quot;: &quot;CPython&quot;, </span><br><span class="line">            &quot;version&quot;: &#123;</span><br><span class="line">                &quot;major&quot;: 2, </span><br><span class="line">                &quot;micro&quot;: 6, </span><br><span class="line">                &quot;minor&quot;: 6, </span><br><span class="line">                &quot;releaselevel&quot;: &quot;final&quot;, </span><br><span class="line">                &quot;serial&quot;: 0</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;version_info&quot;: [</span><br><span class="line">                2, </span><br><span class="line">                6, </span><br><span class="line">                6, </span><br><span class="line">                &quot;final&quot;, </span><br><span class="line">                0</span><br><span class="line">            ]</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_python_version&quot;: &quot;2.6.6&quot;, </span><br><span class="line">        &quot;ansible_selinux&quot;: false, </span><br><span class="line">        &quot;ansible_service_mgr&quot;: &quot;upstart&quot;, </span><br><span class="line">        &quot;ansible_ssh_host_key_dsa_public&quot;: &quot;AAAAB3NzaC1kc3MAAACBAKOv91aUcemUhm61/jFfJpGMzX3dLgIsB/OR3Lnmif6auk7p988B6SVPttdYJZOItwKCAfruQ9M1AAEdqkRWYLWrbc6bhW9GEbJuzCzX65l+Y7b0a11DPHiajLiBg2guCcGgtfzRCVVQU4fJYq5bAMEn4yAHFATqzOi3r6sc+DIrAAAAFQDRRDvw4Y6dfZE6HA+sCkWYOWaYqQAAAIAf8KH81rbsaUOSARJooK+PukNqnp1OoT5l9c5HTZdUTSBOhvZbL+dJ75rtdeDoQRRd3P6EiQXnNdvG2Oq9pvOgpBnkstJHSCHvaDnY61ROMUUm5nc5NTxN7Si/6TBoBv1Fwfxco3wfjeAbP5ysWcYlJjcL0pAysmq1kuHFEUKOdgAAAIEAnZr2Ph9SGCgK/wuZfGnqC+mkpBpG2KTHj20rRhH1zJe7srJp2XI+smVQXyhDJ15+ChOLLEVYOw8HOef3YyJzLYW3jWAWjDegAiPKBYICLTlOqtK1U8nWDocI+nIcAsLdP2SNvDx8JR//rJq3WlHa0d069r1uGgsMgItpdaWCFpo=&quot;, </span><br><span class="line">        &quot;ansible_ssh_host_key_rsa_public&quot;: &quot;AAAAB3NzaC1yc2EAAAABIwAAAQEAn//HP/nZQ/N4JvIh49zYrA+g17FwCcxpDNWF5bQT+suU757PwA91gWtbG5dF0a3pYgMr/Ob3+tYTRrA/v+SkyQ5gcqUzwfYSstv7dEc+75jxUaq/STKnD8TLRcXIHkH02fK/H634nsZfsChFmUqh6gs07pdHeWE7kdGqupokzfTQOzbFBSQVpCOZ653Hkl3drwniawmXNyyZReKqtefmuKxbejfji7R4WUQpg56Cvl4gY0KD3uIE3MQsVm/DDfA/YbnW7S8uqRmrC7JS7T6q34U+9O6BRZf6YsiG+cv5oSc7XgnetIlv/UW2pDSoJQMhAlhLodY9pqg4ebvz/irjtQ==&quot;, </span><br><span class="line">        &quot;ansible_swapfree_mb&quot;: 0, </span><br><span class="line">        &quot;ansible_swaptotal_mb&quot;: 0, </span><br><span class="line">        &quot;ansible_system&quot;: &quot;Linux&quot;, </span><br><span class="line">        &quot;ansible_system_capabilities&quot;: [], </span><br><span class="line">        &quot;ansible_system_capabilities_enforced&quot;: &quot;False&quot;, </span><br><span class="line">        &quot;ansible_system_vendor&quot;: &quot;VMware, Inc.&quot;, </span><br><span class="line">        &quot;ansible_uptime_seconds&quot;: 34566, </span><br><span class="line">        &quot;ansible_user_dir&quot;: &quot;/root&quot;, </span><br><span class="line">        &quot;ansible_user_gecos&quot;: &quot;root&quot;, </span><br><span class="line">        &quot;ansible_user_gid&quot;: 0, </span><br><span class="line">        &quot;ansible_user_id&quot;: &quot;root&quot;, </span><br><span class="line">        &quot;ansible_user_shell&quot;: &quot;/bin/bash&quot;, </span><br><span class="line">        &quot;ansible_user_uid&quot;: 0, </span><br><span class="line">        &quot;ansible_userspace_architecture&quot;: &quot;x86_64&quot;, </span><br><span class="line">        &quot;ansible_userspace_bits&quot;: &quot;64&quot;, </span><br><span class="line">        &quot;ansible_virtualization_role&quot;: &quot;guest&quot;, </span><br><span class="line">        &quot;ansible_virtualization_type&quot;: &quot;VMware&quot;, </span><br><span class="line">        &quot;module_setup&quot;: true</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;ansible_facts&quot;: &#123;</span><br><span class="line">        &quot;ansible_all_ipv4_addresses&quot;: [</span><br><span class="line">            &quot;172.18.252.116&quot;, </span><br><span class="line">            &quot;192.168.8.13&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_all_ipv6_addresses&quot;: [</span><br><span class="line">            &quot;fe80::20c:29ff:fe23:dba5&quot;, </span><br><span class="line">            &quot;fe80::20c:29ff:fe23:dbaf&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_architecture&quot;: &quot;x86_64&quot;, </span><br><span class="line">        &quot;ansible_bios_date&quot;: &quot;07/02/2015&quot;, </span><br><span class="line">        &quot;ansible_bios_version&quot;: &quot;6.00&quot;, </span><br><span class="line">        &quot;ansible_cmdline&quot;: &#123;</span><br><span class="line">            &quot;KEYBOARDTYPE&quot;: &quot;pc&quot;, </span><br><span class="line">            &quot;KEYTABLE&quot;: &quot;us&quot;, </span><br><span class="line">            &quot;LANG&quot;: &quot;en_US.UTF-8&quot;, </span><br><span class="line">            &quot;SYSFONT&quot;: &quot;latarcyrheb-sun16&quot;, </span><br><span class="line">            &quot;quiet&quot;: true, </span><br><span class="line">            &quot;rd_NO_DM&quot;: true, </span><br><span class="line">            &quot;rd_NO_LUKS&quot;: true, </span><br><span class="line">            &quot;rd_NO_LVM&quot;: true, </span><br><span class="line">            &quot;rd_NO_MD&quot;: true, </span><br><span class="line">            &quot;rhgb&quot;: true, </span><br><span class="line">            &quot;ro&quot;: true, </span><br><span class="line">            &quot;root&quot;: &quot;UUID=840675ee-da1d-49fc-a8b6-1a3b6cf60d42&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_date_time&quot;: &#123;</span><br><span class="line">            &quot;date&quot;: &quot;2017-10-30&quot;, </span><br><span class="line">            &quot;day&quot;: &quot;30&quot;, </span><br><span class="line">            &quot;epoch&quot;: &quot;1509373858&quot;, </span><br><span class="line">            &quot;hour&quot;: &quot;22&quot;, </span><br><span class="line">            &quot;iso8601&quot;: &quot;2017-10-30T14:30:58Z&quot;, </span><br><span class="line">            &quot;iso8601_basic&quot;: &quot;20171030T223058630164&quot;, </span><br><span class="line">            &quot;iso8601_basic_short&quot;: &quot;20171030T223058&quot;, </span><br><span class="line">            &quot;iso8601_micro&quot;: &quot;2017-10-30T14:30:58.630319Z&quot;, </span><br><span class="line">            &quot;minute&quot;: &quot;30&quot;, </span><br><span class="line">            &quot;month&quot;: &quot;10&quot;, </span><br><span class="line">            &quot;second&quot;: &quot;58&quot;, </span><br><span class="line">            &quot;time&quot;: &quot;22:30:58&quot;, </span><br><span class="line">            &quot;tz&quot;: &quot;CST&quot;, </span><br><span class="line">            &quot;tz_offset&quot;: &quot;+0800&quot;, </span><br><span class="line">            &quot;weekday&quot;: &quot;Monday&quot;, </span><br><span class="line">            &quot;weekday_number&quot;: &quot;1&quot;, </span><br><span class="line">            &quot;weeknumber&quot;: &quot;44&quot;, </span><br><span class="line">            &quot;year&quot;: &quot;2017&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_default_ipv4&quot;: &#123;</span><br><span class="line">            &quot;address&quot;: &quot;172.18.252.116&quot;, </span><br><span class="line">            &quot;alias&quot;: &quot;eth0&quot;, </span><br><span class="line">            &quot;broadcast&quot;: &quot;172.18.255.255&quot;, </span><br><span class="line">            &quot;gateway&quot;: &quot;172.18.0.1&quot;, </span><br><span class="line">            &quot;interface&quot;: &quot;eth0&quot;, </span><br><span class="line">            &quot;macaddress&quot;: &quot;00:0c:29:23:db:a5&quot;, </span><br><span class="line">            &quot;mtu&quot;: 1500, </span><br><span class="line">            &quot;netmask&quot;: &quot;255.255.0.0&quot;, </span><br><span class="line">            &quot;network&quot;: &quot;172.18.0.0&quot;, </span><br><span class="line">            &quot;type&quot;: &quot;ether&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_default_ipv6&quot;: &#123;&#125;, </span><br><span class="line">        &quot;ansible_devices&quot;: &#123;</span><br><span class="line">            &quot;sda&quot;: &#123;</span><br><span class="line">                &quot;holders&quot;: [], </span><br><span class="line">                &quot;host&quot;: &quot;SCSI storage controller: LSI Logic / Symbios Logic 53c1030 PCI-X Fusion-MPT Dual Ultra320 SCSI (rev 01)&quot;, </span><br><span class="line">                &quot;model&quot;: &quot;VMware Virtual S&quot;, </span><br><span class="line">                &quot;partitions&quot;: &#123;</span><br><span class="line">                    &quot;sda1&quot;: &#123;</span><br><span class="line">                        &quot;holders&quot;: [], </span><br><span class="line">                        &quot;sectors&quot;: &quot;8388608&quot;, </span><br><span class="line">                        &quot;sectorsize&quot;: 512, </span><br><span class="line">                        &quot;size&quot;: &quot;4.00 GB&quot;, </span><br><span class="line">                        &quot;start&quot;: &quot;2048&quot;, </span><br><span class="line">                        &quot;uuid&quot;: &quot;86061bf6-eda8-4277-939d-f45c73fe3d27&quot;</span><br><span class="line">                    &#125;, </span><br><span class="line">                    &quot;sda2&quot;: &#123;</span><br><span class="line">                        &quot;holders&quot;: [], </span><br><span class="line">                        &quot;sectors&quot;: &quot;104857600&quot;, </span><br><span class="line">                        &quot;sectorsize&quot;: 512, </span><br><span class="line">                        &quot;size&quot;: &quot;50.00 GB&quot;, </span><br><span class="line">                        &quot;start&quot;: &quot;8390656&quot;, </span><br><span class="line">                        &quot;uuid&quot;: &quot;840675ee-da1d-49fc-a8b6-1a3b6cf60d42&quot;</span><br><span class="line">                    &#125;, </span><br><span class="line">                    &quot;sda3&quot;: &#123;</span><br><span class="line">                        &quot;holders&quot;: [], </span><br><span class="line">                        &quot;sectors&quot;: &quot;104857600&quot;, </span><br><span class="line">                        &quot;sectorsize&quot;: 512, </span><br><span class="line">                        &quot;size&quot;: &quot;50.00 GB&quot;, </span><br><span class="line">                        &quot;start&quot;: &quot;113248256&quot;, </span><br><span class="line">                        &quot;uuid&quot;: &quot;5675ce63-c9a2-4957-8793-e0755927322f&quot;</span><br><span class="line">                    &#125;, </span><br><span class="line">                    &quot;sda4&quot;: &#123;</span><br><span class="line">                        &quot;holders&quot;: [], </span><br><span class="line">                        &quot;sectors&quot;: &quot;2&quot;, </span><br><span class="line">                        &quot;sectorsize&quot;: 512, </span><br><span class="line">                        &quot;size&quot;: &quot;1.00 KB&quot;, </span><br><span class="line">                        &quot;start&quot;: &quot;218105856&quot;, </span><br><span class="line">                        &quot;uuid&quot;: null</span><br><span class="line">                    &#125;, </span><br><span class="line">                    &quot;sda5&quot;: &#123;</span><br><span class="line">                        &quot;holders&quot;: [], </span><br><span class="line">                        &quot;sectors&quot;: &quot;41943040&quot;, </span><br><span class="line">                        &quot;sectorsize&quot;: 512, </span><br><span class="line">                        &quot;size&quot;: &quot;20.00 GB&quot;, </span><br><span class="line">                        &quot;start&quot;: &quot;218109952&quot;, </span><br><span class="line">                        &quot;uuid&quot;: &quot;1ec30f49-a41a-4ef7-836f-ff231c6b20bb&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, </span><br><span class="line">                &quot;removable&quot;: &quot;0&quot;, </span><br><span class="line">                &quot;rotational&quot;: &quot;1&quot;, </span><br><span class="line">                &quot;sas_address&quot;: null, </span><br><span class="line">                &quot;sas_device_handle&quot;: null, </span><br><span class="line">                &quot;scheduler_mode&quot;: &quot;cfq&quot;, </span><br><span class="line">                &quot;sectors&quot;: &quot;419430400&quot;, </span><br><span class="line">                &quot;sectorsize&quot;: &quot;512&quot;, </span><br><span class="line">                &quot;size&quot;: &quot;200.00 GB&quot;, </span><br><span class="line">                &quot;support_discard&quot;: &quot;0&quot;, </span><br><span class="line">                &quot;vendor&quot;: &quot;VMware,&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;sr0&quot;: &#123;</span><br><span class="line">                &quot;holders&quot;: [], </span><br><span class="line">                &quot;host&quot;: &quot;IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)&quot;, </span><br><span class="line">                &quot;model&quot;: &quot;VMware IDE CDR10&quot;, </span><br><span class="line">                &quot;partitions&quot;: &#123;&#125;, </span><br><span class="line">                &quot;removable&quot;: &quot;1&quot;, </span><br><span class="line">                &quot;rotational&quot;: &quot;1&quot;, </span><br><span class="line">                &quot;sas_address&quot;: null, </span><br><span class="line">                &quot;sas_device_handle&quot;: null, </span><br><span class="line">                &quot;scheduler_mode&quot;: &quot;cfq&quot;, </span><br><span class="line">                &quot;sectors&quot;: &quot;7757824&quot;, </span><br><span class="line">                &quot;sectorsize&quot;: &quot;2048&quot;, </span><br><span class="line">                &quot;size&quot;: &quot;14.80 GB&quot;, </span><br><span class="line">                &quot;support_discard&quot;: &quot;0&quot;, </span><br><span class="line">                &quot;vendor&quot;: &quot;NECVMWar&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_distribution&quot;: &quot;CentOS&quot;, </span><br><span class="line">        &quot;ansible_distribution_major_version&quot;: &quot;6&quot;, </span><br><span class="line">        &quot;ansible_distribution_release&quot;: &quot;Final&quot;, </span><br><span class="line">        &quot;ansible_distribution_version&quot;: &quot;6.9&quot;, </span><br><span class="line">        &quot;ansible_dns&quot;: &#123;</span><br><span class="line">            &quot;nameservers&quot;: [</span><br><span class="line">                &quot;172.18.0.1&quot;</span><br><span class="line">            ], </span><br><span class="line">            &quot;search&quot;: [</span><br><span class="line">                &quot;magedu.com&quot;, </span><br><span class="line">                &quot;haiyun.com&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_domain&quot;: &quot;genericreverse.com&quot;, </span><br><span class="line">        &quot;ansible_env&quot;: &#123;</span><br><span class="line">            &quot;G_BROKEN_FILENAMES&quot;: &quot;1&quot;, </span><br><span class="line">            &quot;HOME&quot;: &quot;/root&quot;, </span><br><span class="line">            &quot;LANG&quot;: &quot;en_US.UTF-8&quot;, </span><br><span class="line">            &quot;LESSOPEN&quot;: &quot;||/usr/bin/lesspipe.sh %s&quot;, </span><br><span class="line">            &quot;LOGNAME&quot;: &quot;root&quot;, </span><br><span class="line">            &quot;LS_COLORS&quot;: &quot;rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=01;05;37;41:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lz=01;31:*.xz=01;31:*.bz2=01;31:*.tbz=01;31:*.tbz2=01;31:*.bz=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.rar=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=01;36:*.au=01;36:*.flac=01;36:*.mid=01;36:*.midi=01;36:*.mka=01;36:*.mp3=01;36:*.mpc=01;36:*.ogg=01;36:*.ra=01;36:*.wav=01;36:*.axa=01;36:*.oga=01;36:*.spx=01;36:*.xspf=01;36:&quot;, </span><br><span class="line">            &quot;MAIL&quot;: &quot;/var/mail/root&quot;, </span><br><span class="line">            &quot;PATH&quot;: &quot;/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin&quot;, </span><br><span class="line">            &quot;PWD&quot;: &quot;/root&quot;, </span><br><span class="line">            &quot;SHELL&quot;: &quot;/bin/bash&quot;, </span><br><span class="line">            &quot;SHLVL&quot;: &quot;2&quot;, </span><br><span class="line">            &quot;SSH_CLIENT&quot;: &quot;192.168.8.11 56942 22&quot;, </span><br><span class="line">            &quot;SSH_CONNECTION&quot;: &quot;192.168.8.11 56942 192.168.8.13 22&quot;, </span><br><span class="line">            &quot;SSH_TTY&quot;: &quot;/dev/pts/1&quot;, </span><br><span class="line">            &quot;TERM&quot;: &quot;xterm&quot;, </span><br><span class="line">            &quot;USER&quot;: &quot;root&quot;, </span><br><span class="line">            &quot;_&quot;: &quot;/usr/bin/python&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_eth0&quot;: &#123;</span><br><span class="line">            &quot;active&quot;: true, </span><br><span class="line">            &quot;device&quot;: &quot;eth0&quot;, </span><br><span class="line">            &quot;features&quot;: &#123;</span><br><span class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;highdma&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;loopback&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;netns_local&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;rx_checksumming&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;rx_vlan_filter&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;rx_vlan_offload&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_checksum_sctp&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_unneeded&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_gre_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_gso_robust&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_lockless&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_scatter_gather&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_vlan_offload&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;udp_fragmentation_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;vlan_challenged&quot;: &quot;off [fixed]&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;ipv4&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;172.18.252.116&quot;, </span><br><span class="line">                &quot;broadcast&quot;: &quot;172.18.255.255&quot;, </span><br><span class="line">                &quot;netmask&quot;: &quot;255.255.0.0&quot;, </span><br><span class="line">                &quot;network&quot;: &quot;172.18.0.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;ipv6&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;address&quot;: &quot;fe80::20c:29ff:fe23:dba5&quot;, </span><br><span class="line">                    &quot;prefix&quot;: &quot;64&quot;, </span><br><span class="line">                    &quot;scope&quot;: &quot;link&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ], </span><br><span class="line">            &quot;macaddress&quot;: &quot;00:0c:29:23:db:a5&quot;, </span><br><span class="line">            &quot;module&quot;: &quot;e1000&quot;, </span><br><span class="line">            &quot;mtu&quot;: 1500, </span><br><span class="line">            &quot;pciid&quot;: &quot;0000:02:01.0&quot;, </span><br><span class="line">            &quot;promisc&quot;: false, </span><br><span class="line">            &quot;speed&quot;: 1000, </span><br><span class="line">            &quot;type&quot;: &quot;ether&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_eth1&quot;: &#123;</span><br><span class="line">            &quot;active&quot;: true, </span><br><span class="line">            &quot;device&quot;: &quot;eth1&quot;, </span><br><span class="line">            &quot;features&quot;: &#123;</span><br><span class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;highdma&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;loopback&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;netns_local&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;rx_checksumming&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;rx_vlan_filter&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;rx_vlan_offload&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_checksum_sctp&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_unneeded&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_gre_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_gso_robust&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_lockless&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_scatter_gather&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;off&quot;, </span><br><span class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_vlan_offload&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;udp_fragmentation_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;vlan_challenged&quot;: &quot;off [fixed]&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;ipv4&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;192.168.8.13&quot;, </span><br><span class="line">                &quot;broadcast&quot;: &quot;192.168.8.255&quot;, </span><br><span class="line">                &quot;netmask&quot;: &quot;255.255.255.0&quot;, </span><br><span class="line">                &quot;network&quot;: &quot;192.168.8.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;ipv6&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;address&quot;: &quot;fe80::20c:29ff:fe23:dbaf&quot;, </span><br><span class="line">                    &quot;prefix&quot;: &quot;64&quot;, </span><br><span class="line">                    &quot;scope&quot;: &quot;link&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ], </span><br><span class="line">            &quot;macaddress&quot;: &quot;00:0c:29:23:db:af&quot;, </span><br><span class="line">            &quot;module&quot;: &quot;e1000&quot;, </span><br><span class="line">            &quot;mtu&quot;: 1500, </span><br><span class="line">            &quot;pciid&quot;: &quot;0000:02:02.0&quot;, </span><br><span class="line">            &quot;promisc&quot;: false, </span><br><span class="line">            &quot;speed&quot;: 1000, </span><br><span class="line">            &quot;type&quot;: &quot;ether&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_fips&quot;: false, </span><br><span class="line">        &quot;ansible_form_factor&quot;: &quot;Other&quot;, </span><br><span class="line">        &quot;ansible_fqdn&quot;: &quot;204-74-211-183.genericreverse.com&quot;, </span><br><span class="line">        &quot;ansible_gather_subset&quot;: [</span><br><span class="line">            &quot;hardware&quot;, </span><br><span class="line">            &quot;network&quot;, </span><br><span class="line">            &quot;virtual&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_hostname&quot;: &quot;centos6&quot;, </span><br><span class="line">        &quot;ansible_interfaces&quot;: [</span><br><span class="line">            &quot;lo&quot;, </span><br><span class="line">            &quot;eth1&quot;, </span><br><span class="line">            &quot;eth0&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_kernel&quot;: &quot;2.6.32-696.el6.x86_64&quot;, </span><br><span class="line">        &quot;ansible_lo&quot;: &#123;</span><br><span class="line">            &quot;active&quot;: true, </span><br><span class="line">            &quot;device&quot;: &quot;lo&quot;, </span><br><span class="line">            &quot;features&quot;: &#123;</span><br><span class="line">                &quot;fcoe_mtu&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;generic_receive_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;generic_segmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;highdma&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;large_receive_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;loopback&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;netns_local&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;ntuple_filters&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;receive_hashing&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;rx_checksumming&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;rx_vlan_filter&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;rx_vlan_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;scatter_gather&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tcp_segmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_checksum_fcoe_crc&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_ip_generic&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_ipv4&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_ipv6&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_sctp&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksum_unneeded&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_checksumming&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_fcoe_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_gre_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_gso_robust&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_lockless&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;tx_scatter_gather&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;tx_scatter_gather_fraglist&quot;: &quot;on [fixed]&quot;, </span><br><span class="line">                &quot;tx_tcp6_segmentation&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_tcp_ecn_segmentation&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_tcp_segmentation&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;tx_udp_tnl_segmentation&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;tx_vlan_offload&quot;: &quot;off [fixed]&quot;, </span><br><span class="line">                &quot;udp_fragmentation_offload&quot;: &quot;on&quot;, </span><br><span class="line">                &quot;vlan_challenged&quot;: &quot;on [fixed]&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;ipv4&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;127.0.0.1&quot;, </span><br><span class="line">                &quot;broadcast&quot;: &quot;host&quot;, </span><br><span class="line">                &quot;netmask&quot;: &quot;255.0.0.0&quot;, </span><br><span class="line">                &quot;network&quot;: &quot;127.0.0.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;ipv6&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;address&quot;: &quot;::1&quot;, </span><br><span class="line">                    &quot;prefix&quot;: &quot;128&quot;, </span><br><span class="line">                    &quot;scope&quot;: &quot;host&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ], </span><br><span class="line">            &quot;mtu&quot;: 65536, </span><br><span class="line">            &quot;promisc&quot;: false, </span><br><span class="line">            &quot;type&quot;: &quot;loopback&quot;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_lvm&quot;: &#123;</span><br><span class="line">            &quot;lvs&quot;: &#123;&#125;, </span><br><span class="line">            &quot;vgs&quot;: &#123;&#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_machine&quot;: &quot;x86_64&quot;, </span><br><span class="line">        &quot;ansible_machine_id&quot;: &quot;4216c081cfdf095a74b92fee0000003e&quot;, </span><br><span class="line">        &quot;ansible_memfree_mb&quot;: 547, </span><br><span class="line">        &quot;ansible_memory_mb&quot;: &#123;</span><br><span class="line">            &quot;nocache&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 844, </span><br><span class="line">                &quot;used&quot;: 136</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;real&quot;: &#123;</span><br><span class="line">                &quot;free&quot;: 547, </span><br><span class="line">                &quot;total&quot;: 980, </span><br><span class="line">                &quot;used&quot;: 433</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;swap&quot;: &#123;</span><br><span class="line">                &quot;cached&quot;: 0, </span><br><span class="line">                &quot;free&quot;: 0, </span><br><span class="line">                &quot;total&quot;: 0, </span><br><span class="line">                &quot;used&quot;: 0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_memtotal_mb&quot;: 980, </span><br><span class="line">        &quot;ansible_mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;device&quot;: &quot;/dev/sda2&quot;, </span><br><span class="line">                &quot;fstype&quot;: &quot;ext4&quot;, </span><br><span class="line">                &quot;mount&quot;: &quot;/&quot;, </span><br><span class="line">                &quot;options&quot;: &quot;rw&quot;, </span><br><span class="line">                &quot;size_available&quot;: 49005813760, </span><br><span class="line">                &quot;size_total&quot;: 52710469632, </span><br><span class="line">                &quot;uuid&quot;: &quot;N/A&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                &quot;device&quot;: &quot;/dev/sda3&quot;, </span><br><span class="line">                &quot;fstype&quot;: &quot;ext4&quot;, </span><br><span class="line">                &quot;mount&quot;: &quot;/app&quot;, </span><br><span class="line">                &quot;options&quot;: &quot;rw&quot;, </span><br><span class="line">                &quot;size_available&quot;: 49971777536, </span><br><span class="line">                &quot;size_total&quot;: 52710469632, </span><br><span class="line">                &quot;uuid&quot;: &quot;N/A&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                &quot;device&quot;: &quot;/dev/sda1&quot;, </span><br><span class="line">                &quot;fstype&quot;: &quot;ext4&quot;, </span><br><span class="line">                &quot;mount&quot;: &quot;/boot&quot;, </span><br><span class="line">                &quot;options&quot;: &quot;rw&quot;, </span><br><span class="line">                &quot;size_available&quot;: 3830882304, </span><br><span class="line">                &quot;size_total&quot;: 4093313024, </span><br><span class="line">                &quot;uuid&quot;: &quot;N/A&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                &quot;device&quot;: &quot;/dev/sda5&quot;, </span><br><span class="line">                &quot;fstype&quot;: &quot;ext4&quot;, </span><br><span class="line">                &quot;mount&quot;: &quot;/script&quot;, </span><br><span class="line">                &quot;options&quot;: &quot;rw&quot;, </span><br><span class="line">                &quot;size_available&quot;: 19883814912, </span><br><span class="line">                &quot;size_total&quot;: 21003628544, </span><br><span class="line">                &quot;uuid&quot;: &quot;N/A&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_nodename&quot;: &quot;centos6.haiyun.com&quot;, </span><br><span class="line">        &quot;ansible_os_family&quot;: &quot;RedHat&quot;, </span><br><span class="line">        &quot;ansible_pkg_mgr&quot;: &quot;yum&quot;, </span><br><span class="line">        &quot;ansible_processor&quot;: [</span><br><span class="line">            &quot;GenuineIntel&quot;, </span><br><span class="line">            &quot;Intel(R) Core(TM) i5-6300HQ CPU @ 2.30GHz&quot;, </span><br><span class="line">            &quot;GenuineIntel&quot;, </span><br><span class="line">            &quot;Intel(R) Core(TM) i5-6300HQ CPU @ 2.30GHz&quot;</span><br><span class="line">        ], </span><br><span class="line">        &quot;ansible_processor_cores&quot;: 1, </span><br><span class="line">        &quot;ansible_processor_count&quot;: 2, </span><br><span class="line">        &quot;ansible_processor_threads_per_core&quot;: 1, </span><br><span class="line">        &quot;ansible_processor_vcpus&quot;: 2, </span><br><span class="line">        &quot;ansible_product_name&quot;: &quot;VMware Virtual Platform&quot;, </span><br><span class="line">        &quot;ansible_product_serial&quot;: &quot;VMware-56 4d b7 19 7b a2 0d 80-50 6a 56 da 9c 23 db a5&quot;, </span><br><span class="line">        &quot;ansible_product_uuid&quot;: &quot;564DB719-7BA2-0D80-506A-56DA9C23DBA5&quot;, </span><br><span class="line">        &quot;ansible_product_version&quot;: &quot;None&quot;, </span><br><span class="line">        &quot;ansible_python&quot;: &#123;</span><br><span class="line">            &quot;executable&quot;: &quot;/usr/bin/python&quot;, </span><br><span class="line">            &quot;has_sslcontext&quot;: false, </span><br><span class="line">            &quot;type&quot;: &quot;CPython&quot;, </span><br><span class="line">            &quot;version&quot;: &#123;</span><br><span class="line">                &quot;major&quot;: 2, </span><br><span class="line">                &quot;micro&quot;: 6, </span><br><span class="line">                &quot;minor&quot;: 6, </span><br><span class="line">                &quot;releaselevel&quot;: &quot;final&quot;, </span><br><span class="line">                &quot;serial&quot;: 0</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;version_info&quot;: [</span><br><span class="line">                2, </span><br><span class="line">                6, </span><br><span class="line">                6, </span><br><span class="line">                &quot;final&quot;, </span><br><span class="line">                0</span><br><span class="line">            ]</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;ansible_python_version&quot;: &quot;2.6.6&quot;, </span><br><span class="line">        &quot;ansible_selinux&quot;: false, </span><br><span class="line">        &quot;ansible_service_mgr&quot;: &quot;upstart&quot;, </span><br><span class="line">        &quot;ansible_ssh_host_key_dsa_public&quot;: &quot;AAAAB3NzaC1kc3MAAACBAPRIWDZiqPIc5FmjLpNJ/9QHSfvMiMv3TxfSiUKsqO3XpX9RAyo+AriszHCydkLS2+44kkzSxEFpGxluDfTkbamOcAs44jJzT7vNU9H8nvMWGGU8YyqiA4Tgp0HbwGGx0mQkqBNaugBicwO1TX8/byHwYtJyuOfXStsQVvChARvhAAAAFQDmEZtIwR11CVBLllpeoyYFLQzfLwAAAIBCnrDJIUeqgzS0iqUt//vOvD4pxajtpbKht4YKiRuOOghSAICpsOaed9SDNEyF12SRnxMeGHazC8pJWscEXh35smEtBG62MakqThYBUKeycIgm3x/M+9s5GKzDCavDzNbjB/8Vi+pvQicQ2E84OO2FYHPhTPdC4kAT+z/NSK1VjAAAAIBNiJTkKRkF8cjMPHnjTYDzy+Q/QcVQIZrUIyIC/TfXDxVypY5d37HZYBPE8PzxmvCCd5VQqr4p6uDvtGHfi2bOENBK/KG3sgU1N7VJ7V9fmNqOBV2EYcDpSkRIQjUFBdXXWdzJOdgw3BWJ8HWAHbwQduZQn+XabUlaiP6F46EZjg==&quot;, </span><br><span class="line">        &quot;ansible_ssh_host_key_rsa_public&quot;: &quot;AAAAB3NzaC1yc2EAAAABIwAAAQEA6dR/9agjYJTDK3qmM+YPpjDVApbmOGntmVbnrQlu2i+wXb7ueedTckV9m+w0OUBuuxgosEhRAOIwM/gsi1nw5WAJCENXUJVPj2fo7Aw0U6xsrwPAuTD574/lB2q8byQPgJIksaTKmMrtZgewmbYXOjhb017lIyJkBCTebOl3bFf76GarC8oYfW3ZCATm7B0bNmw51hJmbn4Q44uGQlF0Eamuq8+tKgkT28xoCBevgnks064zWOrn4HjWeNXyf+TXpx0YgA4d8MzRjq4E/ayA1AoIZSXTBS9eVZlxPe31Y+1zVwjBJe2WURbFldOwGK9f9rpOruNmXAdrP/qEHBDxsw==&quot;, </span><br><span class="line">        &quot;ansible_swapfree_mb&quot;: 0, </span><br><span class="line">        &quot;ansible_swaptotal_mb&quot;: 0, </span><br><span class="line">        &quot;ansible_system&quot;: &quot;Linux&quot;, </span><br><span class="line">        &quot;ansible_system_capabilities&quot;: [], </span><br><span class="line">        &quot;ansible_system_capabilities_enforced&quot;: &quot;False&quot;, </span><br><span class="line">        &quot;ansible_system_vendor&quot;: &quot;VMware, Inc.&quot;, </span><br><span class="line">        &quot;ansible_uptime_seconds&quot;: 34568, </span><br><span class="line">        &quot;ansible_user_dir&quot;: &quot;/root&quot;, </span><br><span class="line">        &quot;ansible_user_gecos&quot;: &quot;root&quot;, </span><br><span class="line">        &quot;ansible_user_gid&quot;: 0, </span><br><span class="line">        &quot;ansible_user_id&quot;: &quot;root&quot;, </span><br><span class="line">        &quot;ansible_user_shell&quot;: &quot;/bin/bash&quot;, </span><br><span class="line">        &quot;ansible_user_uid&quot;: 0, </span><br><span class="line">        &quot;ansible_userspace_architecture&quot;: &quot;x86_64&quot;, </span><br><span class="line">        &quot;ansible_userspace_bits&quot;: &quot;64&quot;, </span><br><span class="line">        &quot;ansible_virtualization_role&quot;: &quot;guest&quot;, </span><br><span class="line">        &quot;ansible_virtualization_type&quot;: &quot;VMware&quot;, </span><br><span class="line">        &quot;module_setup&quot;: true</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;changed&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 自动化运维 </category>
          
          <category> Ansible常用模块二 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ansible </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Ansible常用模块一</title>
      <link href="/2017/10/30/Ansible-configure1/"/>
      <url>/2017/10/30/Ansible-configure1/</url>
      <content type="html"><![CDATA[<h3 id="模块帮助"><a href="#模块帮助" class="headerlink" title="模块帮助"></a>模块帮助</h3><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc -l      # 获取列表</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible-doc -l        # 列出模块</span><br><span class="line">a10_server                         Manage A10 Networks AX/SoftAX/Thunder/vThunder devices</span><br><span class="line">a10_service_group                  Manage A10 Networks devices&apos; service groups           </span><br><span class="line">a10_virtual_server                 Manage A10 Networks devices&apos; virtual servers          </span><br><span class="line">acl                                Sets and retrieves file ACL information.              </span><br><span class="line">add_host                           add a host (and alternatively a group) to the ansible-...</span><br><span class="line">airbrake_deployment                Notify airbrake about app deployments                 </span><br><span class="line">alternatives                       Manages alternative programs for common commands      </span><br><span class="line">apache2_mod_proxy                  Set and/or get members&apos; attributes of an Apache httpd ...</span><br><span class="line">apache2_module                     enables/disables a module of the Apache2 webserver    </span><br><span class="line">apk                                Manages apk packages                                  </span><br><span class="line">apt                                Manages apt-packages                                  </span><br><span class="line">apt_key                            Add or remove an apt key                              </span><br><span class="line">apt_repository                     Add and remove APT repositories                       </span><br><span class="line">apt_rpm                            apt_rpm package manager                               </span><br><span class="line">asa_acl                            Manage access-lists on a Cisco ASA                    </span><br><span class="line">asa_command                        Run arbitrary commands on Cisco ASA devices.          </span><br><span class="line">asa_config                         Manage Cisco ASA configuration sections               </span><br><span class="line">assemble                           Assembles a configuration file from fragments         </span><br><span class="line">assert                             Asserts given expressions are true                    </span><br><span class="line">async_status                       Obtain status of asynchronous task                    </span><br><span class="line">at                                 Schedule the execution of a command or script file via...</span><br><span class="line">atomic_host                        Manage the atomic host platform                       </span><br><span class="line">atomic_image                       Manage the container images on the atomic host platfor...</span><br><span class="line">authorized_key                     Adds or removes an SSH authorized key                 </span><br><span class="line">。。。省略后面内容</span><br><span class="line"></span><br><span class="line">ansible-doc -s  module_name     # 获取指定模块的使用信息</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible-doc -s at     # -s 指定查看at模块的帮助</span><br><span class="line">- name: Schedule the execution of a command or script file via the at command.</span><br><span class="line">  action: at</span><br><span class="line">      command                # A command to be executed in the future.</span><br><span class="line">      count=                 # The count of units in the future to execute the command or</span><br><span class="line">                               script file.</span><br><span class="line">      script_file            # An existing script file to be executed in the future.</span><br><span class="line">      state                  # The state dictates if the command or script file should be</span><br><span class="line">                               evaluated as present(added) or</span><br><span class="line">                               absent(deleted).</span><br><span class="line">      unique                 # If a matching job is present a new job will not be added.</span><br><span class="line">      units=                 # The type of units in the future to execute the command or</span><br><span class="line">                               script file.</span><br></pre></td></tr></table></figure><h3 id="ansible命令"><a href="#ansible命令" class="headerlink" title="ansible命令"></a>ansible命令</h3><h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><p><code>ansible &lt;host-pattern&gt; [-f forks] [-m module_name] [-a args] [options]</code></p><h4 id=""><a href="#" class="headerlink" title=""></a><host-pattern></host-pattern></h4><p><code>&lt;host-pattern&gt;</code>指明管控主机，以模式形式表示或者直接给定<code>IP</code>，必须事先定义在文件中；<code>all</code>设置所有</p><h4 id="f-forks"><a href="#f-forks" class="headerlink" title="[-f forks]"></a>[-f forks]</h4><p><code>[-f forks]</code>：指明每批管控多少主机，默认为5个主机一批次</p><h4 id="m-module-name"><a href="#m-module-name" class="headerlink" title="[-m module_name]"></a>[-m module_name]</h4><p><code>[-m module_name]</code>：使用何种模块管理操作，所有的操作都需要通过模块来指定</p><h4 id="a-args"><a href="#a-args" class="headerlink" title="[-a args]"></a>[-a args]</h4><p><code>[-a args]</code>：指明模块专用参数；<code>args</code>一般为<code>key=value</code>格式</p><h3 id="command模块"><a href="#command模块" class="headerlink" title="command模块"></a>command模块</h3><p><code>command</code> ：命令模块，默认模块，用于在远程执行命令。</p><h4 id="帮助信息"><a href="#帮助信息" class="headerlink" title="帮助信息"></a>帮助信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible-doc -s command</span><br><span class="line">- name: Executes a command on a remote node</span><br><span class="line">  action: command</span><br><span class="line">      chdir                  # cd into this directory before running the command</span><br><span class="line">      creates                # a filename or (since 2.0) glob pattern, when it already exists, this step will *not* be run.</span><br><span class="line">      executable             # change the shell used to execute the command. Should be an absolute path to the executable.</span><br><span class="line">      free_form=             # the command module takes a free form command to run.  There is no parameter actually named &apos;free form&apos;. See the examples!</span><br><span class="line">      removes                # a filename or (since 2.0) glob pattern, when it does not exist, this step will *not* be run.</span><br><span class="line">      warn                   # if command warnings are on in ansible.cfg, do not warn about this particular line if set to no/false.</span><br></pre></td></tr></table></figure><h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible web1 -a &quot;date&quot;        # 因为command是默认模块，所以可以不用指定</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Mon Oct 30 19:21:52 CST 2017</span><br><span class="line"></span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">Mon Oct 30 19:21:53 CST 2017</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m command -a &quot;/bin/echo hello world&quot;        # 执行命令echo hello world  </span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello world</span><br><span class="line"></span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello world</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m command -a &quot;useradd testuser&quot;         # 执行命令添加用户testuser</span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m command -a &quot;userdel -r  testuser&quot;     # 执行命令删除testuser</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible 192.168.8.12 -m command -a &quot;echo hello&quot;       # 也可以指定主机IP来使用</span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello</span><br></pre></td></tr></table></figure><h3 id="cron模块"><a href="#cron模块" class="headerlink" title="cron模块"></a>cron模块</h3><h4 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h4><p><code>state</code>：</p><ul><li><code>present</code>：安装(默认)</li><li><code>absent</code>：移除</li></ul><h4 id="帮助信息-1"><a href="#帮助信息-1" class="headerlink" title="帮助信息"></a>帮助信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible-doc -s cron</span><br><span class="line">- name: Manage cron.d and crontab entries.</span><br><span class="line">  action: cron</span><br><span class="line">      backup                 # If set, create a backup of the crontab before it is modified. The location of the backup is returned in the `backup_file&apos; variable by this module.</span><br><span class="line">      cron_file              # If specified, uses this file instead of an individual user&apos;s crontab. If this is a relative path, it is interpreted with respect to /etc/cron.d. (If it is</span><br><span class="line">                               absolute, it will typically be /etc/crontab). To use the `cron_file&apos; parameter you must specify the `user&apos; as well.</span><br><span class="line">      day                    # Day of the month the job should run ( 1-31, *, */2, etc )</span><br><span class="line">      disabled               # If the job should be disabled (commented out) in the crontab. Only has effect if state=present</span><br><span class="line">      env                    # If set, manages a crontab&apos;s environment variable. New variables are added on top of crontab. &quot;name&quot; and &quot;value&quot; parameters are the name and the value of</span><br><span class="line">                               environment variable.</span><br><span class="line">      hour                   # Hour when the job should run ( 0-23, *, */2, etc )</span><br><span class="line">      insertafter            # Used with `state=present&apos; and `env&apos;. If specified, the environment variable will be inserted after the declaration of specified environment variable.</span><br><span class="line">      insertbefore           # Used with `state=present&apos; and `env&apos;. If specified, the environment variable will be inserted before the declaration of specified environment variable.</span><br><span class="line">      job                    # The command to execute or, if env is set, the value of environment variable. Required if state=present.</span><br><span class="line">      minute                 # Minute when the job should run ( 0-59, *, */2, etc )</span><br><span class="line">      month                  # Month of the year the job should run ( 1-12, *, */2, etc )</span><br><span class="line">      name                   # Description of a crontab entry or, if env is set, the name of environment variable. Required if state=absent. Note that if name is not set and state=present,</span><br><span class="line">                               then a new crontab entry will always be created, regardless of existing ones.</span><br><span class="line">      reboot                 # If the job should be run at reboot. This option is deprecated. Users should use special_time.</span><br><span class="line">      special_time           # Special time specification nickname.</span><br><span class="line">      state                  # Whether to ensure the job or environment variable is present or absent.</span><br><span class="line">      user                   # The specific user whose crontab should be modified.</span><br><span class="line">      weekday                # Day of the week that the job should run ( 0-6 for Sunday-Saturday, *, etc )</span><br></pre></td></tr></table></figure><h4 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible web1 -m cron  -a &quot;minute=&quot;*/10&quot; job=&apos;/bin/bash /etc/backup.sh&apos; name=&apos;This is a bakcup cron&apos;&quot;       # 指定每10分钟执行/etc/backup.sh，name为This is a bakcup cron</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;envs&quot;: [], </span><br><span class="line">    &quot;jobs&quot;: [</span><br><span class="line">        &quot;This is a bakcup cron&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;envs&quot;: [], </span><br><span class="line">    &quot;jobs&quot;: [</span><br><span class="line">        &quot;This is a bakcup cron&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -a &quot;crontab -l&quot;          # 查看执行状态已经执行成功</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">#Ansible: This is a bakcup cron</span><br><span class="line">*/10 * * * * /bin/bash /etc/backup.sh</span><br><span class="line"></span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">#Ansible: This is a bakcup cron</span><br><span class="line">*/10 * * * * /bin/bash /etc/backup.sh</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m cron -a &quot;minute=&apos;*/10&apos; job=&apos;/bin/bash /etc/backup.sh&apos; name=&apos;This is a bakcup cron&apos; state=&apos;absent&apos;&quot;        # 删除此计划任务，删除和创建的state是不同，创建为present，删除为absent，其它都是相同的。</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;envs&quot;: [], </span><br><span class="line">    &quot;jobs&quot;: []</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;envs&quot;: [], </span><br><span class="line">    &quot;jobs&quot;: []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">[root@centos6 ~]# ansible web1 -a &quot;crontab -l&quot;          # 计划任务已经被删除</span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br></pre></td></tr></table></figure><h3 id="user模块"><a href="#user模块" class="headerlink" title="user模块"></a>user模块</h3><h4 id="常用参数-1"><a href="#常用参数-1" class="headerlink" title="常用参数"></a>常用参数</h4><ul><li><code>name</code>：指明创建用户的名字</li></ul><h4 id="帮助信息-2"><a href="#帮助信息-2" class="headerlink" title="帮助信息"></a>帮助信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible-doc -s user</span><br><span class="line">- name: Manage user accounts</span><br><span class="line">  action: user</span><br><span class="line">      append                 # If `yes&apos;, will only add groups, not set them to just the list in `groups&apos;.</span><br><span class="line">      comment                # Optionally sets the description (aka `GECOS&apos;) of user account.</span><br><span class="line">      createhome             # Unless set to `no&apos;, a home directory will be made for the user when the account is created or if the home directory does not exist.</span><br><span class="line">      expires                # An expiry time for the user in epoch, it will be ignored on platforms that do not support this. Currently supported on Linux and FreeBSD.</span><br><span class="line">      force                  # When used with `state=absent&apos;, behavior is as with `userdel --force&apos;.</span><br><span class="line">      generate_ssh_key       # Whether to generate a SSH key for the user in question. This will *not* overwrite an existing SSH key.</span><br><span class="line">      group                  # Optionally sets the user&apos;s primary group (takes a group name).</span><br><span class="line">      groups                 # Puts the user in this comma-delimited list of groups. When set to the empty string (&apos;groups=&apos;), the user is removed from all groups except the primary group.</span><br><span class="line">      home                   # Optionally set the user&apos;s home directory.</span><br><span class="line">      login_class            # Optionally sets the user&apos;s login class for FreeBSD, OpenBSD and NetBSD systems.</span><br><span class="line">      move_home              # If set to `yes&apos; when used with `home=&apos;, attempt to move the user&apos;s home directory to the specified directory if it isn&apos;t there already.</span><br><span class="line">      name=                  # Name of the user to create, remove or modify.</span><br><span class="line">      non_unique             # Optionally when used with the -u option, this option allows to change the user ID to a non-unique value.</span><br><span class="line">      password               # Optionally set the user&apos;s password to this crypted value.  See the user example in the github examples directory for what this looks like in a playbook. See</span><br><span class="line">                               http://docs.ansible.com/ansible/faq.html#how-do-i-generate-crypted-passwords-for-the-user-module for details on various ways to</span><br><span class="line">                               generate these password values. Note on Darwin system, this value has to be cleartext. Beware of security issues.</span><br><span class="line">      remove                 # When used with `state=absent&apos;, behavior is as with `userdel --remove&apos;.</span><br><span class="line">      seuser                 # Optionally sets the seuser type (user_u) on selinux enabled systems.</span><br><span class="line">      shell                  # Optionally set the user&apos;s shell.</span><br><span class="line">      skeleton               # Optionally set a home skeleton directory. Requires createhome option!</span><br><span class="line">      ssh_key_bits           # Optionally specify number of bits in SSH key to create.</span><br><span class="line">      ssh_key_comment        # Optionally define the comment for the SSH key.</span><br><span class="line">      ssh_key_file           # Optionally specify the SSH key filename. If this is a relative filename then it will be relative to the user&apos;s home directory.</span><br><span class="line">      ssh_key_passphrase     # Set a passphrase for the SSH key.  If no passphrase is provided, the SSH key will default to having no passphrase.</span><br><span class="line">      ssh_key_type           # Optionally specify the type of SSH key to generate. Available SSH key types will depend on implementation present on target host.</span><br><span class="line">      state                  # Whether the account should exist or not, taking action if the state is different from what is stated.</span><br><span class="line">      system                 # When creating an account, setting this to `yes&apos; makes the user a system account.  This setting cannot be changed on existing users.</span><br><span class="line">      uid                    # Optionally sets the `UID&apos; of the user.</span><br><span class="line">      update_password        # `always&apos; will update passwords if they differ.  `on_create&apos; will only set the password for newly created users.</span><br></pre></td></tr></table></figure><h4 id="实例-2"><a href="#实例-2" class="headerlink" title="实例"></a>实例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible web1 -m user -a &quot;name=&apos;mysql&apos; shell=&apos;/sbin/nologin&apos; uid=&apos;2222&apos; &quot;      # 创建用户mysql，shell为/sbin/nologin，uid为2222</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 2222, </span><br><span class="line">    &quot;home&quot;: &quot;/home/mysql&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;mysql&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;/sbin/nologin&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: false, </span><br><span class="line">    &quot;uid&quot;: 2222</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 2222, </span><br><span class="line">    &quot;home&quot;: &quot;/home/mysql&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;mysql&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;/sbin/nologin&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: false, </span><br><span class="line">    &quot;uid&quot;: 2222</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m user -a &quot;name=&apos;test&apos; system=&quot;yes&quot;   uid=&apos;321&apos; &quot;       # 创建test用户为系统用户UID为321</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 321, </span><br><span class="line">    &quot;home&quot;: &quot;/home/test&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;test&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: true, </span><br><span class="line">    &quot;uid&quot;: 321</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;comment&quot;: &quot;&quot;, </span><br><span class="line">    &quot;createhome&quot;: true, </span><br><span class="line">    &quot;group&quot;: 321, </span><br><span class="line">    &quot;home&quot;: &quot;/home/test&quot;, </span><br><span class="line">    &quot;name&quot;: &quot;test&quot;, </span><br><span class="line">    &quot;shell&quot;: &quot;/bin/bash&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: true, </span><br><span class="line">    &quot;uid&quot;: 321</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -a &quot;id test&quot;         # 查看test用户ID信息，321是对的</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">uid=321(test) gid=321(test) groups=321(test)</span><br><span class="line"></span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">uid=321(test) gid=321(test) groups=321(test)</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m user -a &quot;name=&apos;test&apos; state=&apos;absent&apos;&quot;          # 删除用户tset</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;force&quot;: false, </span><br><span class="line">    &quot;name&quot;: &quot;test&quot;, </span><br><span class="line">    &quot;remove&quot;: false, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;force&quot;: false, </span><br><span class="line">    &quot;name&quot;: &quot;test&quot;, </span><br><span class="line">    &quot;remove&quot;: false, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@centos6 ~]# ansible web1 -a &quot;id test&quot;         # 确认用户被删除</span><br><span class="line">192.168.8.13 | FAILED | rc=1 &gt;&gt;</span><br><span class="line">id: test: No such user</span><br><span class="line"></span><br><span class="line">192.168.8.12 | FAILED | rc=1 &gt;&gt;</span><br><span class="line">id: test: no such user</span><br></pre></td></tr></table></figure><h3 id="group模块"><a href="#group模块" class="headerlink" title="group模块"></a>group模块</h3><h4 id="帮助信息-3"><a href="#帮助信息-3" class="headerlink" title="帮助信息"></a>帮助信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible-doc -s group</span><br><span class="line">- name: Add or remove groups</span><br><span class="line">  action: group</span><br><span class="line">      gid                    # Optional `GID&apos; to set for the group.</span><br><span class="line">      name=                  # Name of the group to manage.</span><br><span class="line">      state                  # Whether the group should be present or not on the remote host.</span><br><span class="line">      system                 # If `yes&apos;, indicates that the group created is a system group.</span><br></pre></td></tr></table></figure><h4 id="实例-3"><a href="#实例-3" class="headerlink" title="实例"></a>实例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible web1  -m group -a &quot;name=&apos;test&apos; gid=&apos;456&apos; system=&apos;yes&apos; state=&apos;present&apos;&quot;        # 添加组test，gid为456，是系统组</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 456, </span><br><span class="line">    &quot;name&quot;: &quot;test&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 456, </span><br><span class="line">    &quot;name&quot;: &quot;test&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;present&quot;, </span><br><span class="line">    &quot;system&quot;: true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -a &quot;getent group test&quot;           # test用户已创建</span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">test<img class="github-emoji" title="x" alt="x" src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8" height="20" width="20">456:</span><br><span class="line"></span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">test<img class="github-emoji" title="x" alt="x" src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png?v8" height="20" width="20">456:</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m group -a &quot;name=&apos;test&apos; state=&apos;absent&apos;&quot;     # 删除test组</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;test&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;name&quot;: &quot;test&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;absent&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@centos6 ~]# ansible web1 -a &quot;getent group test&quot;           # 组已经被删除</span><br><span class="line">192.168.8.13 | FAILED | rc=2 &gt;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">192.168.8.12 | FAILED | rc=2 &gt;&gt;</span><br></pre></td></tr></table></figure><h3 id="copy模块"><a href="#copy模块" class="headerlink" title="copy模块"></a>copy模块</h3><p>用来复制文件。</p><h4 id="帮助信息-4"><a href="#帮助信息-4" class="headerlink" title="帮助信息"></a>帮助信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]#  ansible-doc -s copy</span><br><span class="line">- name: Copies files to remote locations.</span><br><span class="line">  action: copy</span><br><span class="line">      backup                 # Create a backup file including the timestamp information so you can get the original file back if you somehow clobbered it incorrectly.</span><br><span class="line">      content                # When used instead of &apos;src&apos;, sets the contents of a file directly to the specified value. This is for simple values, for anything complex or with formatting</span><br><span class="line">                               please switch to the template module.</span><br><span class="line">      dest=                  # Remote absolute path where the file should be copied to. If src is a directory, this must be a directory too.</span><br><span class="line">      directory_mode         # When doing a recursive copy set the mode for the directories. If this is not set we will use the system defaults. The mode is only set on directories which are</span><br><span class="line">                               newly created, and will not affect those that already existed.</span><br><span class="line">      follow                 # This flag indicates that filesystem links, if they exist, should be followed.</span><br><span class="line">      force                  # the default is `yes&apos;, which will replace the remote file when contents are different than the source. If `no&apos;, the file will only be transferred if the</span><br><span class="line">                               destination does not exist.</span><br><span class="line">      group                  # name of the group that should own the file/directory, as would be fed to `chown&apos;</span><br><span class="line">      mode                   # mode the file or directory should be. For those used to `/usr/bin/chmod&apos; remember that modes are actually octal numbers (like 0644). Leaving off the leading</span><br><span class="line">                               zero will likely have unexpected results. As of version 1.8, the mode may be specified as a symbolic mode (for example, `u+rwx&apos;</span><br><span class="line">                               or `u=rw,g=r,o=r&apos;).</span><br><span class="line">      owner                  # name of the user that should own the file/directory, as would be fed to `chown&apos;</span><br><span class="line">      remote_src             # If False, it will search for src at originating/master machine, if True it will go to the remote/target machine for the src. Default is False. Currently</span><br><span class="line">                               remote_src does not support recursive copying.</span><br><span class="line">      selevel                # level part of the SELinux file context. This is the MLS/MCS attribute, sometimes known as the `range&apos;. `_default&apos; feature works as for `seuser&apos;.</span><br><span class="line">      serole                 # role part of SELinux file context, `_default&apos; feature works as for `seuser&apos;.</span><br><span class="line">      setype                 # type part of SELinux file context, `_default&apos; feature works as for `seuser&apos;.</span><br><span class="line">      seuser                 # user part of SELinux file context. Will default to system policy, if applicable. If set to `_default&apos;, it will use the `user&apos; portion of the policy if available</span><br><span class="line">      src                    # Local path to a file to copy to the remote server; can be absolute or relative. If path is a directory, it is copied recursively. In this case, if path ends</span><br><span class="line">                               with &quot;/&quot;, only inside contents of that directory are copied to destination. Otherwise, if it does not end with &quot;/&quot;, the directory</span><br><span class="line">                               itself with all contents is copied. This behavior is similar to Rsync.</span><br><span class="line">      unsafe_writes          # Normally this module uses atomic operations to prevent data corruption or inconsistent reads from the target files, sometimes systems are configured or just</span><br><span class="line">                               broken in ways that prevent this. One example are docker mounted files, they cannot be updated atomically and can only be done in</span><br><span class="line">                               an unsafe manner. This boolean option allows ansible to fall back to unsafe methods of updating files for those cases in which</span><br><span class="line">                               you do not have any other choice. Be aware that this is subject to race conditions and can lead to data corruption.</span><br><span class="line">      validate               # The validation command to run before copying into place. The path to the file to validate is passed in via &apos;%s&apos; which must be present as in the example below.</span><br><span class="line">                               The command is passed securely so shell features like expansion and pipes won&apos;t work.</span><br></pre></td></tr></table></figure><h4 id="实例-4"><a href="#实例-4" class="headerlink" title="实例"></a>实例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible web1 -m copy -a &apos;src=/etc/issue dest=/tmp/issue.test owner=root mode=600&apos;     # 复制/etc/issue文件到/tmp/issue.test，属主为root，权限为600</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;4bcf51306f70feaba156df3a40057c7f39291b0e&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/issue.test&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;311289dd6930cf0c2c1239db2005977c&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0600&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 87, </span><br><span class="line">    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1509368382.57-193403017102094/source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;4bcf51306f70feaba156df3a40057c7f39291b0e&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/issue.test&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;311289dd6930cf0c2c1239db2005977c&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0600&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 87, </span><br><span class="line">    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1509368382.61-233451926726318/source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -a &quot;ls -l /tmp/issue.test&quot;       # 查看上面拷贝的issue.text文件，权限是600，属主600，ok</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">-rw------- 1 root root 87 Oct 30 20:59 /tmp/issue.test</span><br><span class="line"></span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">-rw------- 1 root root 87 Oct 30 20:59 /tmp/issue.test</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m copy -a &apos;content=&quot;hello world\nwww.ihaiyun.cc\n&quot; dest=&apos;/tmp/file&apos;&apos;        # 生成文本内容到指定文件</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;fbc4006923a9a0d66b58d32f363b6b00e33d71db&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/file&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;7efb37bf97c9e50207309ec306f2b261&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 27, </span><br><span class="line">    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1509369457.92-279733809519544/source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;fbc4006923a9a0d66b58d32f363b6b00e33d71db&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/file&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;md5sum&quot;: &quot;7efb37bf97c9e50207309ec306f2b261&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0644&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 27, </span><br><span class="line">    &quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1509369457.91-73533303521348/source&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -a &quot;cat /tmp/file&quot;       # 查看生成的文本，ok</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello world</span><br><span class="line">www.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">hello world</span><br><span class="line">www.ihaiyun.cc</span><br></pre></td></tr></table></figure><h3 id="file模块"><a href="#file模块" class="headerlink" title="file模块"></a>file模块</h3><p>用来设定文件属性。</p><h4 id="帮助信息-5"><a href="#帮助信息-5" class="headerlink" title="帮助信息"></a>帮助信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible-doc -s file</span><br><span class="line">- name: Sets attributes of files</span><br><span class="line">  action: file</span><br><span class="line">      follow                 # This flag indicates that filesystem links, if they exist, should be followed.</span><br><span class="line">      force                  # force the creation of the symlinks in two cases: the source file does not exist (but will appear later); the destination exists and is a file (so, we need to</span><br><span class="line">                               unlink the &quot;path&quot; file and create symlink to the &quot;src&quot; file in place of it).</span><br><span class="line">      group                  # name of the group that should own the file/directory, as would be fed to `chown&apos;</span><br><span class="line">      mode                   # mode the file or directory should be. For those used to `/usr/bin/chmod&apos; remember that modes are actually octal numbers (like 0644). Leaving off the leading</span><br><span class="line">                               zero will likely have unexpected results. As of version 1.8, the mode may be specified as a symbolic mode (for example, `u+rwx&apos;</span><br><span class="line">                               or `u=rw,g=r,o=r&apos;).</span><br><span class="line">      owner                  # name of the user that should own the file/directory, as would be fed to `chown&apos;</span><br><span class="line">      path=                  # path to the file being managed.  Aliases: `dest&apos;, `name&apos;</span><br><span class="line">      recurse                # recursively set the specified file attributes (applies only to state=directory)</span><br><span class="line">      selevel                # level part of the SELinux file context. This is the MLS/MCS attribute, sometimes known as the `range&apos;. `_default&apos; feature works as for `seuser&apos;.</span><br><span class="line">      serole                 # role part of SELinux file context, `_default&apos; feature works as for `seuser&apos;.</span><br><span class="line">      setype                 # type part of SELinux file context, `_default&apos; feature works as for `seuser&apos;.</span><br><span class="line">      seuser                 # user part of SELinux file context. Will default to system policy, if applicable. If set to `_default&apos;, it will use the `user&apos; portion of the policy if available</span><br><span class="line">      src                    # path of the file to link to (applies only to `state=link&apos;). Will accept absolute, relative and nonexisting paths. Relative paths are not expanded.</span><br><span class="line">      state                  # If `directory&apos;, all immediate subdirectories will be created if they do not exist, since 1.7 they will be created with the supplied permissions. If `file&apos;, the</span><br><span class="line">                               file will NOT be created if it does not exist, see the [copy] or [template] module if you want that behavior.  If `link&apos;, the</span><br><span class="line">                               symbolic link will be created or changed. Use `hard&apos; for hardlinks. If `absent&apos;, directories will be recursively deleted, and</span><br><span class="line">                               files or symlinks will be unlinked. Note that [file] will not fail if the `path&apos; does not exist as the state did not change. If</span><br><span class="line">                               `touch&apos; (new in 1.4), an empty file will be created if the `path&apos; does not exist, while an existing file or directory will</span><br><span class="line">                               receive updated file access and modification times (similar to the way `touch` works from the command line).</span><br><span class="line">      unsafe_writes          # Normally this module uses atomic operations to prevent data corruption or inconsistent reads from the target files, sometimes systems are configured or just</span><br><span class="line">                               broken in ways that prevent this. One example are docker mounted files, they cannot be updated atomically and can only be done in</span><br><span class="line">                               an unsafe manner. This boolean option allows ansible to fall back to unsafe methods of updating files for those cases in which</span><br><span class="line">                               you do not have any other choice. Be aware that this is subject to race conditions and can lead to data corruption.</span><br></pre></td></tr></table></figure><h4 id="实例-5"><a href="#实例-5" class="headerlink" title="实例"></a>实例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible web1 -m file -a &apos;path=&quot;/tmp/file&quot; owner=&quot;mysql&quot; group=&quot;mysql&quot; mode=&quot;400&quot;&apos;         # 修改/tmp/file文件，用户和组为mysql，权限为400</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 2222, </span><br><span class="line">    &quot;group&quot;: &quot;mysql&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0400&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;mysql&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;/tmp/file&quot;, </span><br><span class="line">    &quot;size&quot;: 27, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 2222</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;gid&quot;: 2222, </span><br><span class="line">    &quot;group&quot;: &quot;mysql&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0400&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;mysql&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;/tmp/file&quot;, </span><br><span class="line">    &quot;size&quot;: 27, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 2222</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -a &apos;ls -l /tmp/file&apos;         # 查看/tmp/file文件，用户和组为mysql，权限为400</span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">-r-------- 1 mysql mysql 27 Oct 30 21:17 /tmp/file</span><br><span class="line"></span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">-r-------- 1 mysql mysql 27 Oct 30 21:17 /tmp/file</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ansible web1 -m file -m file -a &apos;src=&quot;/etc/fstab&quot; path=&quot;/tmp/fstab&quot; state=&quot;link&quot;&apos;         # 创建符号链接文件</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/fstab&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0777&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 10, </span><br><span class="line">    &quot;src&quot;: &quot;/etc/fstab&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;link&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/fstab&quot;, </span><br><span class="line">    &quot;gid&quot;: 0, </span><br><span class="line">    &quot;group&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0777&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;root&quot;, </span><br><span class="line">    &quot;size&quot;: 10, </span><br><span class="line">    &quot;src&quot;: &quot;/etc/fstab&quot;, </span><br><span class="line">    &quot;state&quot;: &quot;link&quot;, </span><br><span class="line">    &quot;uid&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">[root@centos6 ~]# ansible web1 -a &apos;ls -l /tmp/fstab&apos;        # 确认创建</span><br><span class="line">192.168.8.13 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">lrwxrwxrwx 1 root root 10 Oct 30 21:31 /tmp/fstab -&gt; /etc/fstab</span><br><span class="line"></span><br><span class="line">192.168.8.12 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">lrwxrwxrwx 1 root root 10 Oct 30 21:31 /tmp/fstab -&gt; /etc/fstab</span><br></pre></td></tr></table></figure><h3 id="ping模块"><a href="#ping模块" class="headerlink" title="ping模块"></a>ping模块</h3><p>测试远程主机的连通性。</p><h4 id="帮助信息-6"><a href="#帮助信息-6" class="headerlink" title="帮助信息"></a>帮助信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible-doc -s ping</span><br><span class="line">- name: Try to connect to host, verify a usable python and return `pong&apos; on success.</span><br><span class="line">  action: ping</span><br></pre></td></tr></table></figure><h4 id="实例-6"><a href="#实例-6" class="headerlink" title="实例"></a>实例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible web1 -m ping          # 测试如果能ping同就pong</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 自动化运维 </category>
          
          <category> Ansible常用模块一 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ansible </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Ansible安装与使用</title>
      <link href="/2017/10/30/Ansible-Install/"/>
      <url>/2017/10/30/Ansible-Install/</url>
      <content type="html"><![CDATA[<h3 id="密钥管理"><a href="#密钥管理" class="headerlink" title="密钥管理"></a>密钥管理</h3><p>编辑(或创建)<code>/etc/ansible/hosts</code> 并在其中加入一个或多个远程系统.你的<code>public SSH key</code>必须在这些系统的<code>authorized_keys</code>中:</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# ssh-keygen -t rsa             # 创建密钥</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">9e:f9:9b:5b:48:51:d8:2b:c3:81:df:f6:b8:2c:3e:b9 root@centos7.haiyun.com</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|         . o.    |</span><br><span class="line">|        . o..    |</span><br><span class="line">|         o.o .   |</span><br><span class="line">|          =.+    |</span><br><span class="line">|        S .+ o   |</span><br><span class="line">|       . + .. .  |</span><br><span class="line">|        + .o..   |</span><br><span class="line">|         .+oo    |</span><br><span class="line">|         .E*     |</span><br><span class="line">+-----------------+</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ssh-copy-id 192.168.8.14          # 将公钥拷贝到要管理的主机</span><br><span class="line">The authenticity of host &apos;192.168.8.14 (192.168.8.14)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is 64:c7:ef:02:89:b1:33:af:14:0f:83:5b:83:f1:01:c4.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;192.168.8.14&apos; (RSA) to the list of known hosts.</span><br><span class="line">root@192.168.8.14&apos;s password: </span><br><span class="line">Now try logging into the machine, with &quot;ssh &apos;192.168.8.14&apos;&quot;, and check in:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">to make sure we haven&apos;t added extra keys that you weren&apos;t expecting.</span><br></pre></td></tr></table></figure><h3 id="安装ansible"><a href="#安装ansible" class="headerlink" title="安装ansible"></a>安装ansible</h3><h4 id="配置aliyun-epel-yum源"><a href="#配置aliyun-epel-yum源" class="headerlink" title="配置aliyun epel yum源"></a>配置aliyun epel yum源</h4><p><strong>注意：</strong> 安装<code>Ansible</code>可以通过<code>yum</code>的方式或源码编译安装。<code>yum</code>安装是使用<code>epel</code>源的。下面是关于<code>aliyun</code> <code>epel</code> 的<code>yum</code>配置。大家根据自己的服务器版本自行选择。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 yum.repos.d]# wget -O /etc/yum.repos.d/epel-6.repo http://mirrors.aliyun.com/repo/epel-6.repo          # 下载centos6的epel yum源</span><br><span class="line">--2017-10-30 17:26:45--  http://mirrors.aliyun.com/repo/epel-6.repo</span><br><span class="line">Resolving mirrors.aliyun.com... 111.7.187.235, 111.7.187.217, 111.7.187.219, ...</span><br><span class="line">Connecting to mirrors.aliyun.com|111.7.187.235|:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 1083 (1.1K) [application/octet-stream]</span><br><span class="line">Saving to: “/etc/yum.repos.d/epel-6.repo”</span><br><span class="line"></span><br><span class="line">100%[===================================================&gt;] 1,083       --.-K/s   in 0s      </span><br><span class="line"></span><br><span class="line">2017-10-30 17:26:47 (91.2 MB/s) - “/etc/yum.repos.d/epel-6.repo” saved [1083/1083]</span><br><span class="line"></span><br><span class="line">[root@centos6 yum.repos.d]# wget -O /etc/yum.repos.d/epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo          # 下载centos7的epel yum源</span><br><span class="line">--2017-10-30 17:27:04--  http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line">Resolving mirrors.aliyun.com... 111.7.187.217, 111.7.187.219, 111.7.187.234, ...</span><br><span class="line">Connecting to mirrors.aliyun.com|111.7.187.217|:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 1084 (1.1K) [application/octet-stream]</span><br><span class="line">Saving to: “/etc/yum.repos.d/epel-7.repo”</span><br><span class="line"></span><br><span class="line">100%[===================================================&gt;] 1,084       --.-K/s   in 0s      </span><br><span class="line"></span><br><span class="line">2017-10-30 17:27:04 (176 MB/s) - “/etc/yum.repos.d/epel-7.repo” saved [1084/1084]</span><br><span class="line"></span><br><span class="line">[root@centos6 yum.repos.d]# cat epel-6.repo             # 查看6的epel源</span><br><span class="line">[epel]</span><br><span class="line">name=Extra Packages for Enterprise Linux 6 - $basearch</span><br><span class="line">baseurl=http://mirrors.aliyun.com/epel/6/$basearch</span><br><span class="line">        http://mirrors.aliyuncs.com/epel/6/$basearch</span><br><span class="line">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-6&amp;arch=$basearch</span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6</span><br><span class="line"> </span><br><span class="line">[epel-debuginfo]</span><br><span class="line">name=Extra Packages for Enterprise Linux 6 - $basearch - Debug</span><br><span class="line">baseurl=http://mirrors.aliyun.com/epel/6/$basearch/debug</span><br><span class="line">        http://mirrors.aliyuncs.com/epel/6/$basearch/debug</span><br><span class="line">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-debug-6&amp;arch=$basearch</span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6</span><br><span class="line">gpgcheck=0</span><br><span class="line"> </span><br><span class="line">[epel-source]</span><br><span class="line">name=Extra Packages for Enterprise Linux 6 - $basearch - Source</span><br><span class="line">baseurl=http://mirrors.aliyun.com/epel/6/SRPMS</span><br><span class="line">        http://mirrors.aliyuncs.com/epel/6/SRPMS</span><br><span class="line">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-source-6&amp;arch=$basearch</span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[root@centos6 yum.repos.d]# cat epel-7.repo         # 查看7的epel源</span><br><span class="line">[epel]</span><br><span class="line">name=Extra Packages for Enterprise Linux 7 - $basearch</span><br><span class="line">baseurl=http://mirrors.aliyun.com/epel/7/$basearch</span><br><span class="line">        http://mirrors.aliyuncs.com/epel/7/$basearch</span><br><span class="line">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&amp;arch=$basearch</span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7</span><br><span class="line"> </span><br><span class="line">[epel-debuginfo]</span><br><span class="line">name=Extra Packages for Enterprise Linux 7 - $basearch - Debug</span><br><span class="line">baseurl=http://mirrors.aliyun.com/epel/7/$basearch/debug</span><br><span class="line">        http://mirrors.aliyuncs.com/epel/7/$basearch/debug</span><br><span class="line">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-debug-7&amp;arch=$basearch</span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7</span><br><span class="line">gpgcheck=0</span><br><span class="line"> </span><br><span class="line">[epel-source]</span><br><span class="line">name=Extra Packages for Enterprise Linux 7 - $basearch - Source</span><br><span class="line">baseurl=http://mirrors.aliyun.com/epel/7/SRPMS</span><br><span class="line">        http://mirrors.aliyuncs.com/epel/7/SRPMS</span><br><span class="line">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-source-7&amp;arch=$basearch</span><br><span class="line">failovermethod=priority</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7</span><br><span class="line">gpgcheck=0</span><br><span class="line">[root@centos6 yum.repos.d]#</span><br></pre></td></tr></table></figure><h4 id="安装Ansible"><a href="#安装Ansible" class="headerlink" title="安装Ansible"></a>安装Ansible</h4><p>此处，采用<code>yum</code>方式来安装<code>ansible</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# yum install -y ansible     </span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# yum info ansible      # 查看ansible相关信息</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Repository epel is listed more than once in the configuration</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">file://misc/cd/repodata/repomd.xml: [Errno 14] Could not open/read file://misc/cd/repodata/repomd.xml</span><br><span class="line">Trying other mirror.</span><br><span class="line">Installed Packages</span><br><span class="line">Name        : ansible</span><br><span class="line">Arch        : noarch</span><br><span class="line">Version     : 2.2.1.0</span><br><span class="line">Release     : 1.el6</span><br><span class="line">Size        : 22 M</span><br><span class="line">Repo        : installed</span><br><span class="line">From repo   : epel</span><br><span class="line">Summary     : SSH-based configuration management, deployment, and task execution system</span><br><span class="line">URL         : http://ansible.com</span><br><span class="line">License     : GPLv3+</span><br><span class="line">Description : </span><br><span class="line">            : Ansible is a radically simple model-driven configuration management,</span><br><span class="line">            : multi-node deployment, and remote task execution system. Ansible works</span><br><span class="line">            : over SSH and does not require any software or daemons to be installed</span><br><span class="line">            : on remote nodes. Extension modules can be written in any language and</span><br><span class="line">            : are transferred to managed machines automatically.</span><br></pre></td></tr></table></figure><h3 id="使用ansible"><a href="#使用ansible" class="headerlink" title="使用ansible"></a>使用ansible</h3><h4 id="导入公钥"><a href="#导入公钥" class="headerlink" title="导入公钥"></a>导入公钥</h4><p><a href="http://www.ihaiyun.cc/2017/10/30/Expect-Copy-Ssh-Key-2017-10-30/" target="_blank" rel="noopener">关于导入公钥大家可以参考我的另外一篇博客：批量拷贝SSH密钥</a></p><h4 id="定义Host-Inventory"><a href="#定义Host-Inventory" class="headerlink" title="定义Host Inventory"></a>定义Host Inventory</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# vim /etc/ansible/hosts </span><br><span class="line"></span><br><span class="line"># This is the default ansible &apos;hosts&apos; file.</span><br><span class="line">#</span><br><span class="line"># It should live in /etc/ansible/hosts</span><br><span class="line">#</span><br><span class="line">#   - Comments begin with the &apos;#&apos; character</span><br><span class="line">#   - Blank lines are ignored</span><br><span class="line">#   - Groups of hosts are delimited by [header] elements</span><br><span class="line">#   - You can enter hostnames or ip addresses</span><br><span class="line">#   - A hostname/ip can be a member of multiple groups</span><br><span class="line"></span><br><span class="line"># Ex 1: Ungrouped hosts, specify before any group headers.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[web1]</span><br><span class="line">192.168.8.12 </span><br><span class="line">192.168.8.13</span><br></pre></td></tr></table></figure><h4 id="第一条命令"><a href="#第一条命令" class="headerlink" title="第一条命令"></a>第一条命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ansible web1 -m ping      # 对web1定义的主机ping一下，如果成功了就返回pong</span><br><span class="line">192.168.8.12 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.8.13 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 自动化运维 </category>
          
          <category> Ansible安装与使用 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ansible </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>脚本实例四：批量拷贝SSH密钥</title>
      <link href="/2017/10/30/Expect-Copy-Ssh-Key/"/>
      <url>/2017/10/30/Expect-Copy-Ssh-Key/</url>
      <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>通常管理<code>Linux</code>服务器时，使用 <code>SSH Key</code>管理可能会更方便一点。如果机器特别多的话，那么<code>cp</code>密钥又是个问题。利用<code>expect</code>就可以实现批量<code>cp</code>密钥。</p><a id="more"></a><h3 id="脚本内容"><a href="#脚本内容" class="headerlink" title="脚本内容"></a>脚本内容</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# vim expect.sh             # 此脚本使用来创建密钥，安装expect</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">#——————————————————————————————————————————————</span><br><span class="line"># File name:    expect.sh</span><br><span class="line"># Revision:     2.0</span><br><span class="line"># Date:         2017-10-30 11:02:54</span><br><span class="line"># Author:       houhaiyun</span><br><span class="line"># Email:        houhaiyun18@163.com</span><br><span class="line"># Website:      http://www.ihaiyun.cc/</span><br><span class="line"># Copyright:    @2017 haiyun</span><br><span class="line"># License:      LGPL v3</span><br><span class="line"># Description:  </span><br><span class="line">#——————————————————————————————————————————————</span><br><span class="line"></span><br><span class="line">source /etc/init.d/functions        # 使用系统的functions函数</span><br><span class="line"></span><br><span class="line">null=&apos;/dev/null&apos;        # 定义变量null=/dev/null</span><br><span class="line"></span><br><span class="line">CHK () &#123;        # 定义检查脚本</span><br><span class="line">    if [ $? -eq 0 ] ; then      </span><br><span class="line">        action &quot;$1&quot;  /bin/true</span><br><span class="line">    else</span><br><span class="line">        action &quot;$1&quot; /bin/false</span><br><span class="line">    fi  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Install_expect () &#123;     # 安装expect脚本</span><br><span class="line">    rpm -q expect &amp;&gt; $null</span><br><span class="line">    </span><br><span class="line">    if [ $? -ne 0 ] ; then </span><br><span class="line">        yum  install -y expect &amp;&gt; $null</span><br><span class="line">    fi  </span><br><span class="line">    </span><br><span class="line">    CHK &quot;Install expect&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SSH-Key () &#123;        # 定义生成ssh-key</span><br><span class="line">    if [ -f ~/.ssh/id_rsa ] ; then </span><br><span class="line">    return 2</span><br><span class="line">    fi  </span><br><span class="line">    ssh-keygen -t rsa -P &apos;&apos; -f ~/.ssh/id_rsa &amp;&gt; $null</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    CHK &quot;Generating public/private rsa key pair&quot;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">Copy () &#123;       # 通过调用expect脚本来实现cp密钥到你定义的主机</span><br><span class="line">    for i in &#123;11..14&#125; ; do</span><br><span class="line">    /usr/bin/expect expect root 192.168.8.$i &amp;&gt; $null</span><br><span class="line">    CHK &quot;Copy ssh-key 192.168.8.$i&quot;</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Install_expect</span><br><span class="line">SSH-Key</span><br><span class="line">Copy</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# vim expect        # except脚本如下</span><br><span class="line"></span><br><span class="line">#!/usr/bin/expect</span><br><span class="line">#——————————————————————————————————————————————</span><br><span class="line"># File name:    except</span><br><span class="line"># Revision:     2.0</span><br><span class="line"># Date:         2017-10-30 11:24:45</span><br><span class="line"># Author:       houhaiyun</span><br><span class="line"># Email:        houhaiyun18@163.com</span><br><span class="line"># Website:      http://www.ihaiyun.cc/</span><br><span class="line"># Copyright:    @2017 haiyun</span><br><span class="line"># License:      LGPL v3</span><br><span class="line"># Description:  </span><br><span class="line">#——————————————————————————————————————————————</span><br><span class="line"></span><br><span class="line">if &#123; $argc != 2 &#125; &#123;         # 判断输入参数，如果不等于2就提示用法</span><br><span class="line">    send_user &quot;usage: expect expect user ip \n&quot;</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">set user [lindex $argv 0]       # 定义变量user</span><br><span class="line">set ip [lindex $argv 1]         # 定义变量ip</span><br><span class="line">set password &quot;haiyun&quot;           # 定义密码为haiyun</span><br><span class="line"></span><br><span class="line">spawn ssh-copy-id   $user@$ip       # 执行命令ssh-copy-id</span><br><span class="line">expect &#123;</span><br><span class="line">    &quot;yes/no&quot;    &#123;send &quot;yes\r&quot;;exp_continue&#125;         # 捕获yes/no，捕获到后输入回车</span><br><span class="line">    &quot;*password&quot; &#123;send &quot;$password\r&quot;&#125;                # 捕获到password输入密码</span><br><span class="line">&#125;</span><br><span class="line">expect eof          # 结束</span><br></pre></td></tr></table></figure><h3 id="脚本使用"><a href="#脚本使用" class="headerlink" title="脚本使用"></a>脚本使用</h3><p><strong>注意：</strong>  上面是两个脚本。通过<code>expect.sh</code>来调用<code>expect</code>。所以需要将两个脚本放到同一目录下。当然也可以放到不同目录，那就需要修改一下了。</p><p>本脚任然不够完善，大家可以根据需求来自行修改。也可以给我留言哦，帮助别人解决困难和痛苦是人生最大的幸福和快乐<code>^_^</code>。</p><h3 id="脚本执行"><a href="#脚本执行" class="headerlink" title="脚本执行"></a>脚本执行</h3><p>通过以上两个脚本来实现对<code>192.168.8.11-14</code>的批量密钥拷贝。</p><center><img src="https://houhaiyun.github.io/img/images/Expect-Copy-Ssh-Key-1.gif" title="脚本执行"></center><h3 id="完整脚本"><a href="#完整脚本" class="headerlink" title="完整脚本"></a>完整脚本</h3><p>脚本内容如下，拷贝即可使用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# vim expect</span><br><span class="line"></span><br><span class="line">#!/usr/bin/expect</span><br><span class="line">#——————————————————————————————————————————————</span><br><span class="line"># File name:    except</span><br><span class="line"># Revision:     2.0</span><br><span class="line"># Date:         2017-10-30 11:24:45</span><br><span class="line"># Author:       houhaiyun</span><br><span class="line"># Email:        houhaiyun18@163.com</span><br><span class="line"># Website:      http://www.ihaiyun.cc/</span><br><span class="line"># Copyright:    @2017 haiyun</span><br><span class="line"># License:      LGPL v3</span><br><span class="line"># Description:  </span><br><span class="line">#——————————————————————————————————————————————</span><br><span class="line"></span><br><span class="line">if &#123; $argc != 2 &#125; &#123; </span><br><span class="line">    send_user &quot;usage: expect expect user ip \n&quot;</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">set user [lindex $argv 0]  </span><br><span class="line">set ip [lindex $argv 1]</span><br><span class="line">#set file [lindex $argv 2]</span><br><span class="line">set password &quot;haiyun&quot;</span><br><span class="line"></span><br><span class="line">spawn ssh-copy-id   $user@$ip </span><br><span class="line">expect &#123;</span><br><span class="line">    &quot;yes/no&quot;    &#123;send &quot;yes\r&quot;;exp_continue&#125;</span><br><span class="line">    &quot;*password&quot; &#123;send &quot;$password\r&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">expect eof </span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# vim expect.sh </span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">#——————————————————————————————————————————————</span><br><span class="line"># File name:    expect.sh</span><br><span class="line"># Revision:     2.0</span><br><span class="line"># Date:         2017-10-30 11:02:54</span><br><span class="line"># Author:       houhaiyun</span><br><span class="line"># Email:        houhaiyun18@163.com</span><br><span class="line"># Website:      http://www.ihaiyun.cc/</span><br><span class="line"># Copyright:    @2017 haiyun</span><br><span class="line"># License:      LGPL v3</span><br><span class="line"># Description:  </span><br><span class="line">#——————————————————————————————————————————————</span><br><span class="line"></span><br><span class="line">source /etc/init.d/functions</span><br><span class="line"></span><br><span class="line">null=&apos;/dev/null&apos;</span><br><span class="line"></span><br><span class="line">CHK () &#123;</span><br><span class="line">    if [ $? -eq 0 ] ; then </span><br><span class="line">        action &quot;$1&quot;  /bin/true</span><br><span class="line">    else</span><br><span class="line">        action &quot;$1&quot; /bin/false</span><br><span class="line">    fi  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Install_expect () &#123;</span><br><span class="line">    rpm -q expect &amp;&gt; $null</span><br><span class="line">    </span><br><span class="line">    if [ $? -ne 0 ] ; then </span><br><span class="line">        yum  install -y expect &amp;&gt; $null</span><br><span class="line">    fi  </span><br><span class="line">    </span><br><span class="line">    CHK &quot;Install expect&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SSH-Key () &#123;</span><br><span class="line">    if [ -f ~/.ssh/id_rsa ] ; then </span><br><span class="line">    return 2</span><br><span class="line">    fi  </span><br><span class="line">    ssh-keygen -t rsa -P &apos;&apos; -f ~/.ssh/id_rsa &amp;&gt; $null</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    CHK &quot;Generating public/private rsa key pair&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Copy () &#123;</span><br><span class="line">    for i in &#123;11..14&#125; ; do</span><br><span class="line">    /usr/bin/expect expect root 192.168.8.$i &amp;&gt; $null</span><br><span class="line">    CHK &quot;Copy ssh-key 192.168.8.$i&quot;</span><br><span class="line">    done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Install_expect</span><br><span class="line">SSH-Key</span><br><span class="line">Copy</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Shell脚本 </category>
          
          <category> 脚本实例四：批量拷贝SSH密钥 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 脚本实例四 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>实现Nginx+KeepAlived单主模式</title>
      <link href="/2017/10/29/KeepAlived-Danzhu-Nginx/"/>
      <url>/2017/10/29/KeepAlived-Danzhu-Nginx/</url>
      <content type="html"><![CDATA[<h3 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h3><center><img src="https://houhaiyun.github.io/img/images/KeepAlived-Danzhu-Nginx-1.jpg" title="拓扑图"></center><table><thead><tr><th>服务</th><th>IP</th><th>功能</th></tr></thead><tbody><tr><td>Nginx+KeepALived(master)</td><td>RIP：192.168.8.138 VIP：192.168.8.8</td><td>实现Nginx高可用</td></tr><tr><td>Nginx+KeepALived(backup)</td><td>RIP：192.168.8.140 VIP：192.168.8.8</td><td>实现Nginx高可用</td></tr><tr><td>Apache1</td><td>RIP：192.168.8.128 VIP：192.168.8.8</td><td>提供web服务</td></tr><tr><td>Apache2</td><td>RIP：192.168.8.136 VIP：192.168.8.8</td><td>提供web服务</td></tr><tr><td>测试调度</td><td>192.168.8.139</td><td>测试客户端(可选)</td></tr></tbody></table><a id="more"></a><h3 id="Real-Server-配置"><a href="#Real-Server-配置" class="headerlink" title="Real Server 配置"></a>Real Server 配置</h3><h4 id="Apache1配置"><a href="#Apache1配置" class="headerlink" title="Apache1配置"></a>Apache1配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@Web1 ~]# hostname Apache1</span><br><span class="line">[root@Apache1 ~]# ifconfig      # 查看IP</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:DE:D2:8C  </span><br><span class="line">          inet addr:192.168.8.128  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fede:d28c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:47719 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:37888 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:3929892 (3.7 MiB)  TX bytes:5227016 (4.9 MiB)</span><br><span class="line"></span><br><span class="line">[root@Apache1 ~]# yum -y  install httpd</span><br><span class="line">[root@Apache1 ~]# echo `hostname` &gt; /var/www/html/index.html </span><br><span class="line">[root@Apache1 ~]# cat /var/www/html/index.html</span><br><span class="line">Apache1</span><br><span class="line">[root@Apache1 ~]# service httpd start</span><br><span class="line">Starting httpd:                                            [  OK  ]</span><br><span class="line">[root@Apache1 ~]# curl 192.168.8.128</span><br><span class="line">Apache1</span><br></pre></td></tr></table></figure><h4 id="Apache2配置"><a href="#Apache2配置" class="headerlink" title="Apache2配置"></a>Apache2配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@Web2 ~]# hostname Apache2</span><br><span class="line">[root@Apache2 ~]# ifconfig </span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:23:DB:AF  </span><br><span class="line">          inet addr:192.168.8.136  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fe23:dbaf/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:48342 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:38477 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:3981864 (3.7 MiB)  TX bytes:5292854 (5.0 MiB)</span><br><span class="line"></span><br><span class="line">[root@Apache2 ~]# echo `hostname` &gt; /var/www/html/index.html </span><br><span class="line">[root@Apache2 ~]# service httpd start</span><br><span class="line">Starting httpd:                                            [  OK  ]</span><br><span class="line">[root@Apache2 ~]# cat /var/www/html/index.html</span><br><span class="line">Apache2</span><br><span class="line">[root@Apache2 ~]# curl 192.168.8.136</span><br><span class="line">Apache2</span><br></pre></td></tr></table></figure><h3 id="Nginx服务器配置"><a href="#Nginx服务器配置" class="headerlink" title="Nginx服务器配置"></a>Nginx服务器配置</h3><p><a href="http://www.ihaiyun.cc/2017/10/28/Nginx-ngx-stream-core-module/" target="_blank" rel="noopener">关于Nginx代理，可以参考我的另外一篇文章</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># master配置</span><br><span class="line">[root@master ~]# yum install -y nginx</span><br><span class="line">[root@master ~]# vim /etc/nginx/nginx.conf          # 此处需要注意默认配置文件设置了default_server,我们需要把默认的default_server改成现在的，切记。</span><br><span class="line">http &#123;</span><br><span class="line">    upstream web &#123;</span><br><span class="line">        server 192.168.8.128:80 weight=1 ;</span><br><span class="line">        server 192.168.8.136:80 weight=2 ;</span><br><span class="line">    &#125;   </span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80 default_server;</span><br><span class="line">        location / &#123; </span><br><span class="line">            proxy_pass http://web;</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@master ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@master ~]# nginx </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># backup配置</span><br><span class="line">[root@backup ~]# yum install -y nginx</span><br><span class="line">[root@backup ~]# vim /etc/nginx/nginx.conf        # 此处需要注意默认配置文件设置了default_server,我们需要把默认的default_server改成现在的，切记。  </span><br><span class="line">http &#123;</span><br><span class="line">    upstream web &#123;</span><br><span class="line">        server 192.168.8.128:80 weight=1 ;</span><br><span class="line">        server 192.168.8.136:80 weight=2 ;</span><br><span class="line">    &#125;   </span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80 default_server;</span><br><span class="line">        location / &#123; </span><br><span class="line">            proxy_pass http://web;</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@backup ~]# nginx -t </span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@backup ~]# nginx</span><br></pre></td></tr></table></figure><h3 id="编写keepalived通知脚本"><a href="#编写keepalived通知脚本" class="headerlink" title="编写keepalived通知脚本"></a>编写keepalived通知脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># master 脚本：此脚本用来如果发生切换模式就发送邮件给用户</span><br><span class="line">[root@master ~]# vim /etc/keepalived/notify.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">#</span><br><span class="line">contact=&apos;root@localhost&apos;</span><br><span class="line">notify() &#123;</span><br><span class="line">mailsubject=&quot;$(hostname) to be $1, vip floating&quot;</span><br><span class="line">mailbody=&quot;$(date +&apos;%F %T&apos;): vrrp transition, $(hostname) changed to be $1&quot;</span><br><span class="line">echo &quot;$mailbody&quot; | mail -s &quot;$mailsubject&quot; $contact</span><br><span class="line">&#125;</span><br><span class="line">case $1 in</span><br><span class="line">master)</span><br><span class="line">notify master</span><br><span class="line">;;</span><br><span class="line">backup)</span><br><span class="line">notify backup</span><br><span class="line">;;</span><br><span class="line">fault)</span><br><span class="line">notify fault</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">echo &quot;Usage: $(basename $0) &#123;master|backup|fault&#125;&quot;</span><br><span class="line">exit 1</span><br><span class="line">;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line"># backup 脚本：此脚本用来如果发生切换模式就发送邮件给用户。和上面脚本内容是相同的</span><br><span class="line">[root@master ~]# vim /etc/keepalived/notify.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">#</span><br><span class="line">contact=&apos;root@localhost&apos;</span><br><span class="line">notify() &#123;</span><br><span class="line">mailsubject=&quot;$(hostname) to be $1, vip floating&quot;</span><br><span class="line">mailbody=&quot;$(date +&apos;%F %T&apos;): vrrp transition, $(hostname) changed to be $1&quot;</span><br><span class="line">echo &quot;$mailbody&quot; | mail -s &quot;$mailsubject&quot; $contact</span><br><span class="line">&#125;</span><br><span class="line">case $1 in</span><br><span class="line">master)</span><br><span class="line">notify master</span><br><span class="line">;;</span><br><span class="line">backup)</span><br><span class="line">notify backup</span><br><span class="line">;;</span><br><span class="line">fault)</span><br><span class="line">notify fault</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">echo &quot;Usage: $(basename $0) &#123;master|backup|fault&#125;&quot;</span><br><span class="line">exit 1</span><br><span class="line">;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure><h3 id="KeepAlived配置"><a href="#KeepAlived配置" class="headerlink" title="KeepAlived配置"></a>KeepAlived配置</h3><h4 id="master配置"><a href="#master配置" class="headerlink" title="master配置"></a>master配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;   </span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id master</span><br><span class="line">   vrrp_mcast_group 224.18.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;killall -0 nginx &quot;</span><br><span class="line">    interval 1</span><br><span class="line">    weight -20 </span><br><span class="line">    fall 3</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens34</span><br><span class="line">    virtual_router_id 8</span><br><span class="line">    priority 100 </span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass psdfuhg</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.8/24 dev ens34 label ens34:0</span><br><span class="line">    &#125;   </span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;   </span><br><span class="line">    notify_master &quot;/etc/keepalived/notify.sh master&quot;</span><br><span class="line">    notify_backup &quot;/etc/keepalived/notify.sh backup&quot;</span><br><span class="line">    notify_fault &quot;/etc/keepalived/notify.sh fault&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="backup配置"><a href="#backup配置" class="headerlink" title="backup配置"></a>backup配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;   </span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id master</span><br><span class="line">   vrrp_mcast_group 224.18.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;killall -0 nginx &amp;&amp; exit 0 || exit 1&quot;</span><br><span class="line">    interval 1</span><br><span class="line">    weight -20 </span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens34</span><br><span class="line">    virtual_router_id 8</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass psdfuhg</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.8/24 dev ens34 label ens34:0</span><br><span class="line">    &#125;   </span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_down</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;   </span><br><span class="line">    notify_master &quot;/etc/keepalived/notify.sh master&quot;</span><br><span class="line">    notify_backup &quot;/etc/keepalived/notify.sh backup&quot;</span><br><span class="line">    notify_fault &quot;/etc/keepalived/notify.sh fault&quot;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="直接测试"><a href="#直接测试" class="headerlink" title="直接测试"></a>直接测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 在master和backup上面启动keepalived</span><br><span class="line">[root@master ~]# systemctl start keepalived</span><br><span class="line">[root@backup ~]# systemctl start keepalived</span><br><span class="line"></span><br><span class="line">[root@master ~]# ifconfig               # VIP已经飘到master上面了，因为master的优先级高</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.138  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:2438  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 100742  bytes 12189024 (11.6 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 122068  bytes 10944494 (10.4 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.8  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">[root@User ~]# curl 192.168.8.8         # 测试，可以访问</span><br><span class="line">Apache2</span><br><span class="line">[root@User ~]# curl 192.168.8.8</span><br><span class="line">Apache1</span><br><span class="line">[root@User ~]# curl 192.168.8.8</span><br><span class="line">Apache2</span><br><span class="line">[root@User ~]# curl 192.168.8.8</span><br><span class="line">Apache1</span><br></pre></td></tr></table></figure><h4 id="停止master上面的nginx测试"><a href="#停止master上面的nginx测试" class="headerlink" title="停止master上面的nginx测试"></a>停止master上面的nginx测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# systemctl stop nginx </span><br><span class="line">[root@master ~]# ifconfig           # master上面的VIP已经没有</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.138  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:2438  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 100874  bytes 12201538 (11.6 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 122295  bytes 10965872 (10.4 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@backup ~]# ifconfig           # IP已经飘到backup</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.140  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::250:56ff:fe37:a834  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 136056  bytes 16820538 (16.0 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 167644  bytes 13735575 (13.0 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.8  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">[root@User ~]# curl 192.168.8.8         # 测试，可以访问</span><br><span class="line">Apache1</span><br><span class="line">[root@User ~]# curl 192.168.8.8</span><br><span class="line">Apache2</span><br><span class="line">[root@User ~]# curl 192.168.8.8</span><br><span class="line">Apache1</span><br><span class="line">[root@User ~]# curl 192.168.8.8</span><br><span class="line">Apache2</span><br></pre></td></tr></table></figure><h4 id="启动master上面的nginx测试"><a href="#启动master上面的nginx测试" class="headerlink" title="启动master上面的nginx测试"></a>启动master上面的nginx测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# nginx</span><br><span class="line">[root@master ~]# ifconfig           # IP已经飘回来了</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.138  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:2438  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 101135  bytes 12219498 (11.6 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 122372  bytes 10975972 (10.4 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.8  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">[root@User ~]# curl 192.168.8.8         # 测试，可以访问</span><br><span class="line">Apache1</span><br><span class="line">[root@User ~]# curl 192.168.8.8</span><br><span class="line">Apache2</span><br><span class="line">[root@User ~]# curl 192.168.8.8</span><br><span class="line">Apache1</span><br><span class="line">[root@User ~]# curl 192.168.8.8</span><br><span class="line">Apache2</span><br></pre></td></tr></table></figure><h4 id="停止master上面的keepalived测试"><a href="#停止master上面的keepalived测试" class="headerlink" title="停止master上面的keepalived测试"></a>停止master上面的keepalived测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# systemctl stop keepalived          # IP已经飘没了，是对的</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.138  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:2438  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 101216  bytes 12225968 (11.6 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 122497  bytes 10988370 (10.4 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@backup ~]# ifconfig           # VIP已经切换</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.140  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::250:56ff:fe37:a834  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 136290  bytes 16839058 (16.0 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 167907  bytes 13768733 (13.1 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.8  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">[root@User ~]# curl 192.168.8.8         # 测试，可以访问</span><br><span class="line">Apache1</span><br><span class="line">[root@User ~]# curl 192.168.8.8</span><br><span class="line">Apache2</span><br><span class="line">[root@User ~]# curl 192.168.8.8</span><br><span class="line">Apache1</span><br><span class="line">[root@User ~]# curl 192.168.8.8</span><br><span class="line">Apache2</span><br></pre></td></tr></table></figure><h4 id="查看发送邮件是否发送成功"><a href="#查看发送邮件是否发送成功" class="headerlink" title="查看发送邮件是否发送成功"></a>查看发送邮件是否发送成功</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mail               # 在master上面查看邮件，ok</span><br><span class="line">Heirloom Mail version 12.5 7/5/10.  Type ? for help.</span><br><span class="line">&quot;/var/spool/mail/root&quot;: 15 messages 3 new 11 unread</span><br><span class="line">    1 keepalived@localhost  Sun Oct 29 13:32  18/664   &quot;[master] Realserver [192.168.8.128&quot;</span><br><span class="line">    2 keepalived@localhost  Sun Oct 29 13:32  18/644   &quot;[master] Realserver [192.168.8.128&quot;</span><br><span class="line">    3 keepalived@localhost  Sun Oct 29 17:45  18/664   &quot;[master] Realserver [192.168.8.128&quot;</span><br><span class="line">    4 keepalived@localhost  Sun Oct 29 17:45  18/644   &quot;[master] Realserver [192.168.8.128&quot;</span><br><span class="line"> U  5 root                  Sun Oct 29 19:58  19/720   &quot;centos7.haiyum.com to be master, v&quot;</span><br><span class="line"> U  6 root                  Sun Oct 29 20:02  19/720   &quot;centos7.haiyum.com to be master, v&quot;</span><br><span class="line"> U  7 root                  Sun Oct 29 20:12  19/720   &quot;centos7.haiyum.com to be master, v&quot;</span><br><span class="line"> U  8 root                  Sun Oct 29 20:22  19/720   &quot;centos7.haiyum.com to be master, v&quot;</span><br><span class="line"> U  9 root                  Sun Oct 29 20:26  19/720   &quot;centos7.haiyum.com to be master, v&quot;</span><br><span class="line"> U 10 root                  Sun Oct 29 20:28  19/720   &quot;centos7.haiyum.com to be master, v&quot;</span><br><span class="line"> U 11 root                  Sun Oct 29 20:28  19/720   &quot;centos7.haiyum.com to be backup, v&quot;</span><br><span class="line"> U 12 root                  Sun Oct 29 20:29  19/720   &quot;centos7.haiyum.com to be master, v&quot;</span><br><span class="line">&gt;N 13 root                  Sun Oct 29 20:58  18/710   &quot;centos7.haiyum.com to be backup, v&quot;</span><br><span class="line"> N 14 root                  Sun Oct 29 21:00  18/710   &quot;centos7.haiyum.com to be master, v&quot;</span><br><span class="line"> N 15 root                  Sun Oct 29 21:03  18/710   &quot;centos7.haiyum.com to be master, v&quot;</span><br><span class="line">&amp; 15</span><br><span class="line">Message 15:</span><br><span class="line">From root@centos7.haiyum.com  Sun Oct 29 21:03:39 2017</span><br><span class="line">Return-Path: &lt;root@centos7.haiyum.com&gt;</span><br><span class="line">X-Original-To: root@localhost</span><br><span class="line">Delivered-To: root@localhost.haiyum.com</span><br><span class="line">Date: Sun, 29 Oct 2017 21:03:39 +0800</span><br><span class="line">To: root@localhost.haiyum.com</span><br><span class="line">Subject: centos7.haiyum.com to be master, vip floating</span><br><span class="line">User-Agent: Heirloom mailx 12.5 7/5/10</span><br><span class="line">Content-Type: text/plain; charset=us-ascii</span><br><span class="line">From: root@centos7.haiyum.com (root)</span><br><span class="line">Status: R</span><br><span class="line"></span><br><span class="line">2017-10-29 21:03:39: vrrp transition, centos7.haiyum.com changed to be master</span><br><span class="line"></span><br><span class="line">&amp; quit</span><br><span class="line">Held 15 messages in /var/spool/mail/root</span><br><span class="line">You have mail in /var/spool/mail/root</span><br><span class="line"></span><br><span class="line">[root@backup ~]# mail           # 提示命令没找到</span><br><span class="line">bash: mail: command not found</span><br><span class="line">[root@backup ~]# yum install -y mailx       # 安装mailx包</span><br><span class="line">[root@backup ~]# mail           # 查看邮件，ok</span><br><span class="line">Heirloom Mail version 12.5 7/5/10.  Type ? for help.</span><br><span class="line">&quot;/var/spool/mail/root&quot;: 8 messages 8 new</span><br><span class="line">&gt;N  1 keepalived@localhost  Sun Oct 29 13:31  17/646   &quot;[master] Realserver [192.168.8.128&quot;</span><br><span class="line"> N  2 keepalived@localhost  Sun Oct 29 13:31  17/626   &quot;[master] Realserver [192.168.8.128&quot;</span><br><span class="line"> N  3 keepalived@localhost  Sun Oct 29 16:06  17/646   &quot;[master] Realserver [192.168.8.128&quot;</span><br><span class="line"> N  4 keepalived@localhost  Sun Oct 29 16:06  17/626   &quot;[master] Realserver [192.168.8.128&quot;</span><br><span class="line"> N  5 keepalived@localhost  Sun Oct 29 16:08  17/646   &quot;[master] Realserver [192.168.8.136&quot;</span><br><span class="line"> N  6 keepalived@localhost  Sun Oct 29 16:08  17/626   &quot;[master] Realserver [192.168.8.136&quot;</span><br><span class="line"> N  7 keepalived@localhost  Sun Oct 29 17:44  17/646   &quot;[master] Realserver [192.168.8.128&quot;</span><br><span class="line"> N  8 keepalived@localhost  Sun Oct 29 17:44  17/626   &quot;[master] Realserver [192.168.8.128&quot;</span><br><span class="line">&amp; 8</span><br><span class="line">Message  8:</span><br><span class="line">From keepalived@localhost.haiyun.com  Sun Oct 29 17:44:23 2017</span><br><span class="line">Return-Path: &lt;keepalived@localhost.haiyun.com&gt;</span><br><span class="line">X-Original-To: root@localhost</span><br><span class="line">Delivered-To: root@localhost.haiyun.com</span><br><span class="line">Date: Sun, 29 Oct 2017 09:44:23 +0000</span><br><span class="line">From: keepalived@localhost.haiyun.com</span><br><span class="line">Subject: [master] Realserver [192.168.8.128]:80 - UP</span><br><span class="line">X-Mailer: Keepalived</span><br><span class="line">To: root@localhost.haiyun.com</span><br><span class="line">Status: R</span><br><span class="line"></span><br><span class="line">=&gt; CHECK succeed on service &lt;=</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&amp; quit</span><br><span class="line">Held 8 messages in /var/spool/mail/root</span><br></pre></td></tr></table></figure><h3 id="故障排查"><a href="#故障排查" class="headerlink" title="故障排查"></a>故障排查</h3><p>如果测试<code>nginx</code>故障失败的话，可能是<code>killall</code>命令没有安装。可以通过<code>yum install psmisc</code>来安装。</p>]]></content>
      
      <categories>
          
          <category> 高可用 </category>
          
          <category> 实现Nginx+KeepAlived单主模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> KeepAlived </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>KeepAlived单独记录日志</title>
      <link href="/2017/10/29/KeepAlived-Log/"/>
      <url>/2017/10/29/KeepAlived-Log/</url>
      <content type="html"><![CDATA[<h3 id="查看默认日志"><a href="#查看默认日志" class="headerlink" title="查看默认日志"></a>查看默认日志</h3><p><code>KeepAlived</code>默认是把日志记录<code>/var/log/messages</code>里面的，感觉有点乱，所以还是把日志单独存放比较好。</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# tail /var/log/messages         </span><br><span class="line">Oct 29 17:03:12 centos7 Keepalived_vrrp[3170]: Using LinkWatch kernel netlink reflector...</span><br><span class="line">Oct 29 17:03:12 centos7 Keepalived_vrrp[3170]: VRRP_Instance(VI_2) Entering BACKUP STATE</span><br><span class="line">Oct 29 17:03:12 centos7 Keepalived_vrrp[3170]: VRRP sockpool: [ifindex(3), proto(112), unicast(0), fd(10,11)]</span><br><span class="line">Oct 29 17:03:13 centos7 Keepalived_vrrp[3170]: VRRP_Instance(VI_1) Transition to MASTER STATE</span><br><span class="line">Oct 29 17:03:13 centos7 Keepalived_vrrp[3170]: VRRP_Instance(VI_1) Received lower prio advert, forcing new election</span><br><span class="line">Oct 29 17:03:14 centos7 Keepalived_vrrp[3170]: VRRP_Instance(VI_1) Entering MASTER STATE</span><br><span class="line">Oct 29 17:03:14 centos7 Keepalived_vrrp[3170]: VRRP_Instance(VI_1) setting protocol VIPs.</span><br><span class="line">Oct 29 17:03:14 centos7 Keepalived_healthcheckers[3169]: Netlink reflector reports IP 192.168.8.8 added</span><br><span class="line">Oct 29 17:03:14 centos7 Keepalived_vrrp[3170]: VRRP_Instance(VI_1) Sending gratuitous ARPs on ens34 for 192.168.8.8</span><br><span class="line">Oct 29 17:03:19 centos7 Keepalived_vrrp[3170]: VRRP_Instance(VI_1) Sending gratuitous ARPs on ens34 for 192.168.8.8</span><br></pre></td></tr></table></figure><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim /etc/sysconfig/keepalived </span><br><span class="line"></span><br><span class="line"># Options for keepalived. See `keepalived --help&apos; output and keepalived(8) and</span><br><span class="line"># keepalived.conf(5) man pages for a list of all options. Here are the most</span><br><span class="line"># common ones :</span><br><span class="line">#</span><br><span class="line"># --vrrp               -P    Only run with VRRP subsystem.</span><br><span class="line"># --check              -C    Only run with Health-checker subsystem.</span><br><span class="line"># --dont-release-vrrp  -V    Dont remove VRRP VIPs &amp; VROUTEs on daemon stop.</span><br><span class="line"># --dont-release-ipvs  -I    Dont remove IPVS topology on daemon stop.</span><br><span class="line"># --dump-conf          -d    Dump the configuration data.</span><br><span class="line"># --log-detail         -D    Detailed log messages.</span><br><span class="line"># --log-facility       -S    0-7 Set local syslog facility (default=LOG_DAEMON)</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">KEEPALIVED_OPTIONS=&quot;-D -d -S 0&quot;         # 修改此项</span><br></pre></td></tr></table></figure><h3 id="修改-etc-rsuslog-conf"><a href="#修改-etc-rsuslog-conf" class="headerlink" title="修改/etc/rsuslog.conf"></a>修改/etc/rsuslog.conf</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim /etc/rsyslog.conf          # 添加一下两行</span><br><span class="line"># Save KeepAlived log.</span><br><span class="line">local0.*                                            /var/log/keepalived.log</span><br></pre></td></tr></table></figure><h3 id="重启日志服务和Keepalived"><a href="#重启日志服务和Keepalived" class="headerlink" title="重启日志服务和Keepalived"></a>重启日志服务和Keepalived</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# systemctl restart rsyslog.service keepalived.service</span><br></pre></td></tr></table></figure><h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# tail /var/log/keepalived.log </span><br><span class="line">Oct 29 17:25:19 centos7 Keepalived_vrrp[3568]: Using LinkWatch kernel netlink reflector...</span><br><span class="line">Oct 29 17:25:19 centos7 Keepalived_vrrp[3568]: VRRP_Instance(VI_2) Entering BACKUP STATE</span><br><span class="line">Oct 29 17:25:19 centos7 Keepalived_vrrp[3568]: VRRP sockpool: [ifindex(3), proto(112), unicast(0), fd(10,11)]</span><br><span class="line">Oct 29 17:25:20 centos7 Keepalived_vrrp[3568]: VRRP_Instance(VI_1) Transition to MASTER STATE</span><br><span class="line">Oct 29 17:25:20 centos7 Keepalived_vrrp[3568]: VRRP_Instance(VI_1) Received lower prio advert, forcing new election</span><br><span class="line">Oct 29 17:25:21 centos7 Keepalived_vrrp[3568]: VRRP_Instance(VI_1) Entering MASTER STATE</span><br><span class="line">Oct 29 17:25:21 centos7 Keepalived_vrrp[3568]: VRRP_Instance(VI_1) setting protocol VIPs.</span><br><span class="line">Oct 29 17:25:21 centos7 Keepalived_vrrp[3568]: VRRP_Instance(VI_1) Sending gratuitous ARPs on ens34 for 192.168.8.8</span><br><span class="line">Oct 29 17:25:21 centos7 Keepalived_healthcheckers[3567]: Netlink reflector reports IP 192.168.8.8 added</span><br><span class="line">Oct 29 17:25:26 centos7 Keepalived_vrrp[3568]: VRRP_Instance(VI_1) Sending gratuitous ARPs on ens34 for 192.168.8.8</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 高可用 </category>
          
          <category> KeepAlived单独记录日志 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> KeepAlived </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>实现LVS+KeepAlived双主模式</title>
      <link href="/2017/10/29/KeepAlived-Shuangzhu-LVS/"/>
      <url>/2017/10/29/KeepAlived-Shuangzhu-LVS/</url>
      <content type="html"><![CDATA[<h3 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h3><center><img src="https://houhaiyun.github.io/img/images/KeepAlived-Shuangzhu-LVS-1.jpg" title="拓扑图"></center><table><thead><tr><th>服务</th><th>IP</th><th>功能</th></tr></thead><tbody><tr><td>LVS+KeepALived(master/backup)</td><td>RIP：192.168.8.138 VIP：192.168.8.8</td><td>实现LVS高可用</td></tr><tr><td>LVS+KeepALived(backup/master)</td><td>RIP：192.168.8.140 VIP：192.168.8.6</td><td>实现LVS高可用</td></tr><tr><td>Apache1</td><td>RIP：192.168.8.128 VIP：192.168.8.8</td><td>提供web服务</td></tr><tr><td>Apache2</td><td>RIP：192.168.8.136 VIP：192.168.8.8</td><td>提供web服务</td></tr><tr><td>Apache3</td><td>RIP：192.168.8.137 VIP：192.168.8.6</td><td>提供web服务</td></tr><tr><td>Apache4</td><td>RIP：192.168.8.139 VIP：192.168.8.6</td><td>提供web服务</td></tr></tbody></table><a id="more"></a><h3 id="Real-Server配置"><a href="#Real-Server配置" class="headerlink" title="Real Server配置"></a>Real Server配置</h3><h4 id="Apache1配置"><a href="#Apache1配置" class="headerlink" title="Apache1配置"></a>Apache1配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@Web1 ~]# hostname Apache1</span><br><span class="line">[root@Apache1 ~]# cat lvs_dr_rs.sh          # 执行real server 脚本</span><br><span class="line">#!/bin/bash</span><br><span class="line"># Author: haiyun</span><br><span class="line"># Date: 2017-08-13</span><br><span class="line"></span><br><span class="line">vip=&apos;192.168.8.8&apos;</span><br><span class="line">mask=&apos;255.255.255.255&apos;</span><br><span class="line">dev=lo:1</span><br><span class="line">rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null</span><br><span class="line">service httpd start &amp;&gt; /dev/null &amp;&amp; echo &quot;The httpd Server is Ready!&quot;</span><br><span class="line">echo &quot;&lt;h1&gt;`hostname`&lt;/h1&gt;&quot; &gt; /var/www/html/index.html</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">    echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    ifconfig $dev $vip netmask $mask broadcast $vip up</span><br><span class="line">    #route add -host $vip dev $dev</span><br><span class="line">    echo &quot;The RS Server is Ready!&quot;</span><br><span class="line">    ;;</span><br><span class="line">stop)</span><br><span class="line">    ifconfig $dev down</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    echo &quot;The RS Server is Canceled!&quot;</span><br><span class="line">    ;;</span><br><span class="line">*) </span><br><span class="line">    echo &quot;Usage: $(basename $0) start|stop&quot;</span><br><span class="line">    exit 1</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">[root@Apache1 ~]# bash lvs_dr_rs.sh start</span><br><span class="line">The httpd Server is Ready!</span><br><span class="line">The RS Server is Ready!</span><br><span class="line">[root@Apache1 ~]# ifconfig      # 虚拟IP已经配置</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:DE:D2:8C  </span><br><span class="line">          inet addr:192.168.8.128  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fede:d28c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:32600 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:25885 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:2694652 (2.5 MiB)  TX bytes:3566219 (3.4 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:20 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:20 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:2168 (2.1 KiB)  TX bytes:2168 (2.1 KiB)</span><br><span class="line"></span><br><span class="line">lo:1      Link encap:Local Loopback  </span><br><span class="line">          inet addr:192.168.8.8  Mask:255.255.255.255</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line"></span><br><span class="line">[root@Apache1 ~]# curl 192.168.8.128        # 本地测试，ok</span><br><span class="line">&lt;h1&gt;Apache1&lt;/h1&gt;</span><br></pre></td></tr></table></figure><h4 id="Apache2配置"><a href="#Apache2配置" class="headerlink" title="Apache2配置"></a>Apache2配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@Web2 ~]# hostname Apache2</span><br><span class="line">[root@Apache2 ~]# bash lvs_dr_rs.sh start           # 执行real server 脚本，此脚本的内容和Apache1中是相同的</span><br><span class="line">The httpd Server is Ready!</span><br><span class="line">The RS Server is Ready!</span><br><span class="line">[root@Apache2 ~]# ifconfig          # 虚拟IP已经配置</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:23:DB:AF  </span><br><span class="line">          inet addr:192.168.8.136  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fe23:dbaf/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:32677 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:26075 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:2696522 (2.5 MiB)  TX bytes:3582485 (3.4 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:20 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:20 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:2168 (2.1 KiB)  TX bytes:2168 (2.1 KiB)</span><br><span class="line"></span><br><span class="line">lo:1      Link encap:Local Loopback  </span><br><span class="line">          inet addr:192.168.8.8  Mask:255.255.255.255</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line"></span><br><span class="line">[root@Apache2 ~]# curl 192.168.8.136         # 本地测试，ok</span><br><span class="line">&lt;h1&gt;Apache2&lt;/h1&gt;</span><br></pre></td></tr></table></figure><h4 id="Apache3配置"><a href="#Apache3配置" class="headerlink" title="Apache3配置"></a>Apache3配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# hostname Apache3</span><br><span class="line">[root@localhost ~]# bash</span><br><span class="line">[root@Apache3 ~]# cat lvs_dr_rs.sh          # 查看你real server 脚本和Apache1的虚拟IP是不同的</span><br><span class="line">#!/bin/bash</span><br><span class="line">#Author:wangxiaochun</span><br><span class="line">#Date:2017-08-13</span><br><span class="line">vip=&apos;192.168.8.6&apos;       # 虚拟IP已改变</span><br><span class="line">mask=&apos;255.255.255.255&apos;</span><br><span class="line">dev=lo:1</span><br><span class="line">rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null</span><br><span class="line">service httpd start &amp;&gt; /dev/null &amp;&amp; echo &quot;The httpd Server is Ready!&quot;</span><br><span class="line">echo &quot;&lt;h1&gt;`hostname`&lt;/h1&gt;&quot; &gt; /var/www/html/index.html</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">    echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    ifconfig $dev $vip netmask $mask broadcast $vip up</span><br><span class="line">    #route add -host $vip dev $dev</span><br><span class="line">    echo &quot;The RS Server is Ready!&quot;</span><br><span class="line">    ;;</span><br><span class="line">stop)</span><br><span class="line">    ifconfig $dev down</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    echo &quot;The RS Server is Canceled!&quot;</span><br><span class="line">    ;;</span><br><span class="line">*) </span><br><span class="line">    echo &quot;Usage: $(basename $0) start|stop&quot;</span><br><span class="line">    exit 1</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line">[root@Apache3 ~]# bash lvs_dr_rs.sh start</span><br><span class="line">The httpd Server is Ready!</span><br><span class="line">The RS Server is Ready!</span><br><span class="line">[root@Apache3 ~]# ifconfig          # 虚拟IP已配置</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:FC:14:0C  </span><br><span class="line">          inet addr:192.168.8.137  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fefc:140c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:260 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:204 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:28838 (28.1 KiB)  TX bytes:32999 (32.2 KiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)</span><br><span class="line"></span><br><span class="line">lo:1      Link encap:Local Loopback  </span><br><span class="line">          inet addr:192.168.8.6  Mask:255.255.255.255</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line"></span><br><span class="line">[root@Apache3 ~]# curl 192.168.8.137        # 本地访问测试，ok</span><br><span class="line">&lt;h1&gt;Apache3&lt;/h1&gt;</span><br></pre></td></tr></table></figure><h4 id="Apache4配置"><a href="#Apache4配置" class="headerlink" title="Apache4配置"></a>Apache4配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@Client ~]# hostname Apache4</span><br><span class="line">[root@Client ~]# bash</span><br><span class="line">[root@Apache4 ~]# bash lvs_dr_rs.sh start       # 执行real server脚本，此脚本的内容和Apache3中是相同的</span><br><span class="line">The httpd Server is Ready!</span><br><span class="line">The RS Server is Ready!</span><br><span class="line"></span><br><span class="line">[root@Apache4 ~]# ifconfig </span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:E3:36:5F  </span><br><span class="line">          inet addr:192.168.8.139  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fee3:365f/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:1326 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:1026 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:121526 (118.6 KiB)  TX bytes:133312 (130.1 KiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)</span><br><span class="line"></span><br><span class="line">lo:1      Link encap:Local Loopback  </span><br><span class="line">          inet addr:192.168.8.6  Mask:255.255.255.255</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line"></span><br><span class="line">[root@Apache4 ~]# curl 192.168.8.139        # 本地访问测试，ok</span><br><span class="line">&lt;h1&gt;Apache4&lt;/h1&gt;</span><br></pre></td></tr></table></figure><h3 id="KeepAlived配置"><a href="#KeepAlived配置" class="headerlink" title="KeepAlived配置"></a>KeepAlived配置</h3><h4 id="master-192-168-8-138-配置"><a href="#master-192-168-8-138-配置" class="headerlink" title="master(192.168.8.138)配置"></a>master(192.168.8.138)配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;   </span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id master</span><br><span class="line">   vrrp_mcast_group 224.18.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens34</span><br><span class="line">    virtual_router_id 8</span><br><span class="line">    priority 100 </span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass psdfuhg</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.8/24 dev ens34 label ens34:0</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.8.8 80 &#123;</span><br><span class="line">    delay_loop 3 </span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP </span><br><span class="line">    </span><br><span class="line">    sorry_server 127.0.0.1 80  </span><br><span class="line">    </span><br><span class="line">    real_server 192.168.8.128 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">        url &#123;</span><br><span class="line">            path /</span><br><span class="line">            status_code 200 </span><br><span class="line">        &#125;   </span><br><span class="line">        connect_timeout 1</span><br><span class="line">        nb_get_retry 3 </span><br><span class="line">        delay_before_retyr 1</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    real_server 192.168.8.136 80 &#123;</span><br><span class="line">            weight 1</span><br><span class="line">            HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 1</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retyr 1</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens34</span><br><span class="line">    virtual_router_id 6</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass dsdfuhg</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.6/24 dev ens34 label ens34:1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.8.6 80 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    sorry_server 127.0.0.1 80</span><br><span class="line"></span><br><span class="line">    real_server 192.168.8.137 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">        url &#123;</span><br><span class="line">            path /</span><br><span class="line">            status_code 200</span><br><span class="line">        &#125;</span><br><span class="line">        connect_timeout 1</span><br><span class="line">        nb_get_retry 3</span><br><span class="line">        delay_before_retyr 1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 192.168.8.139 80 &#123;</span><br><span class="line">            weight 1</span><br><span class="line">            HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 1</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retyr 1</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="backup-192-168-8-140-配置"><a href="#backup-192-168-8-140-配置" class="headerlink" title="backup(192.168.8.140)配置"></a>backup(192.168.8.140)配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;   </span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id master</span><br><span class="line">   vrrp_mcast_group 224.18.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens34</span><br><span class="line">    virtual_router_id 8</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass psdfuhg</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.8/24 dev ens34 label ens34:0</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.8.8 80 &#123;</span><br><span class="line">    delay_loop 3 </span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP </span><br><span class="line">    </span><br><span class="line">    sorry_server 127.0.0.1 80  </span><br><span class="line">    </span><br><span class="line">    real_server 192.168.8.128 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">        url &#123;</span><br><span class="line">            path /</span><br><span class="line">            status_code 200 </span><br><span class="line">        &#125;   </span><br><span class="line">        connect_timeout 1</span><br><span class="line">        nb_get_retry 3 </span><br><span class="line">        delay_before_retyr 1</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    real_server 192.168.8.136 80 &#123;</span><br><span class="line">            weight 1</span><br><span class="line">            HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 1</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retyr 1</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_2 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens34</span><br><span class="line">    virtual_router_id 6</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass dsdfuhg</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.6/24 dev ens34 label ens34:1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.8.6 80 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    sorry_server 127.0.0.1 80</span><br><span class="line"></span><br><span class="line">    real_server 192.168.8.137 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">        url &#123;</span><br><span class="line">            path /</span><br><span class="line">            status_code 200</span><br><span class="line">        &#125;</span><br><span class="line">        connect_timeout 1</span><br><span class="line">        nb_get_retry 3</span><br><span class="line">        delay_before_retyr 1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 192.168.8.139 80 &#123;</span><br><span class="line">            weight 1</span><br><span class="line">            HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 1</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retyr 1</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="查看ipvs规则"><a href="#查看ipvs规则" class="headerlink" title="查看ipvs规则"></a>查看ipvs规则</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ipvsadm -Ln            # master</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.8.6:80 rr</span><br><span class="line">  -&gt; 192.168.8.137:80             Route   1      0          0         </span><br><span class="line">  -&gt; 192.168.8.139:80             Route   1      0          0         </span><br><span class="line">TCP  192.168.8.8:80 rr</span><br><span class="line">  -&gt; 192.168.8.128:80             Route   1      0          0         </span><br><span class="line">  -&gt; 192.168.8.136:80             Route   1      0          0    </span><br><span class="line"></span><br><span class="line">[root@backup ~]# ipvsadm -Ln        # backup</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.8.6:80 rr</span><br><span class="line">  -&gt; 192.168.8.137:80             Route   1      0          0         </span><br><span class="line">  -&gt; 192.168.8.139:80             Route   1      0          0         </span><br><span class="line">TCP  192.168.8.8:80 rr</span><br><span class="line">  -&gt; 192.168.8.128:80             Route   1      0          0         </span><br><span class="line">  -&gt; 192.168.8.136:80             Route   1      0          0</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ifconfig           # 目前192.168.8.8是在master上面的</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.138  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:2438  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 21907  bytes 2653801 (2.5 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 29003  bytes 2770719 (2.6 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.8  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">[root@backup ~]# ifconfig       # 目前192.168.8.6是在backup上面的</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.140  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::250:56ff:fe37:a834  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 52094  bytes 6502536 (6.2 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 68423  bytes 5624418 (5.3 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.6  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">[root@Client ~]# curl 192.168.8.8           # 测试192.168.8.8没问题</span><br><span class="line">&lt;h1&gt;Apache2&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Apache1&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Apache2&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Apache1&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@Client ~]# curl 192.168.8.6           # 测试192.168.8.6没问题</span><br><span class="line">&lt;h1&gt;Apache4&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.6</span><br><span class="line">&lt;h1&gt;Apache3&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.6</span><br><span class="line">&lt;h1&gt;Apache4&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.6</span><br><span class="line">&lt;h1&gt;Apache3&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@master ~]# systemctl stop keepalived          # 停止keepalived</span><br><span class="line">[root@master ~]# ifconfig           # 查看IP，已经没有192.168.8.8了</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.138  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:2438  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 23569  bytes 2859248 (2.7 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 30953  bytes 2932185 (2.7 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@backup ~]# ifconfig           # 查看IP，已经全部飘到backup上面了</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.140  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::250:56ff:fe37:a834  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 54253  bytes 6771078 (6.4 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 71125  bytes 5855084 (5.5 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.8  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">ens34:1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.6  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">[root@Client ~]# curl 192.168.8.6           # 测试访问，依旧可以</span><br><span class="line">&lt;h1&gt;Apache3&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.6</span><br><span class="line">&lt;h1&gt;Apache4&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.6</span><br><span class="line">&lt;h1&gt;Apache3&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.6</span><br><span class="line">&lt;h1&gt;Apache4&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@Client ~]# curl 192.168.8.8           # 测试访问，依旧可以</span><br><span class="line">&lt;h1&gt;Apache2&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Apache1&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Apache2&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Apache1&lt;/h1&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 高可用 </category>
          
          <category> 实现LVS+KeepAlived双主模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> KeepAlived </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>实现LVS+KeepAlived单主模式</title>
      <link href="/2017/10/29/KeepAlived-Danzhu-LVS/"/>
      <url>/2017/10/29/KeepAlived-Danzhu-LVS/</url>
      <content type="html"><![CDATA[<p>本实验接着上面实现单主的<code>Keepalived</code>继续搭建。</p><h3 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h3><center><img src="https://houhaiyun.github.io/img/images/KeepAlived-Danzhu-LVS-1.jpg" title="拓扑图"></center><table><thead><tr><th>服务</th><th>IP</th><th>功能</th></tr></thead><tbody><tr><td>LVS+KeepALived(master)</td><td>RIP：192.168.8.138 VIP：192.168.8.8</td><td>实现LVS高可用</td></tr><tr><td>LVS+KeepALived(backup)</td><td>RIP：192.168.8.140 VIP：192.168.8.8</td><td>实现LVS高可用</td></tr><tr><td>httpd</td><td>RIP：192.168.8.128 VIP：192.168.8.8</td><td>提供web服务</td></tr><tr><td>httpd</td><td>RIP：192.168.8.136 VIP：192.168.8.8</td><td>提供web服务</td></tr><tr><td>测试调度</td><td>192.168.8.139</td><td>测试客户端(可选)</td></tr></tbody></table><a id="more"></a><h3 id="Real-Server配置"><a href="#Real-Server配置" class="headerlink" title="Real Server配置"></a>Real Server配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"># web配置</span><br><span class="line">[root@centos6 ~]# yum install -y httpd</span><br><span class="line">[root@centos6 ~]# hostname web1     # 修改主机名为web1</span><br><span class="line">[root@Web1 ~]# vim lvs_dr_rs.sh         # 执行配置Real Server脚本</span><br><span class="line">#!/bin/bash</span><br><span class="line"># Author: haiyun</span><br><span class="line"># Date: 2017-08-13</span><br><span class="line"></span><br><span class="line">vip=&apos;192.168.8.8&apos;</span><br><span class="line">mask=&apos;255.255.255.255&apos;</span><br><span class="line">dev=lo:1</span><br><span class="line">rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null</span><br><span class="line">service httpd start &amp;&gt; /dev/null &amp;&amp; echo &quot;The httpd Server is Ready!&quot;</span><br><span class="line">echo &quot;&lt;h1&gt;`hostname`&lt;/h1&gt;&quot; &gt; /var/www/html/index.html</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">    echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    ifconfig $dev $vip netmask $mask broadcast $vip up</span><br><span class="line">    #route add -host $vip dev $dev</span><br><span class="line">    echo &quot;The RS Server is Ready!&quot;</span><br><span class="line">    ;;  </span><br><span class="line">stop)</span><br><span class="line">    ifconfig $dev down</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    echo &quot;The RS Server is Canceled!&quot;</span><br><span class="line">    ;;  </span><br><span class="line">*) </span><br><span class="line">    echo &quot;Usage: $(basename $0) start|stop&quot;</span><br><span class="line">    exit 1</span><br><span class="line">    ;;  </span><br><span class="line">esac</span><br><span class="line">[root@Web1 ~]# service httpd start      </span><br><span class="line">Starting httpd:                                            [  OK  ] </span><br><span class="line">[root@Web1 ~]# curl 192.168.8.128       # 本地测试可以访问</span><br><span class="line">&lt;h1&gt;Web1&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># backup配置</span><br><span class="line">[root@centos6 ~]# yum install -y httpd</span><br><span class="line">[root@centos6 ~]# hostname web2</span><br><span class="line">[root@Web2 ~]# vim lvs_dr_rs.sh         # 执行配置Real Server脚本</span><br><span class="line">#!/bin/bash</span><br><span class="line"># Author: haiyun</span><br><span class="line"># Date: 2017-08-13</span><br><span class="line"></span><br><span class="line">vip=&apos;192.168.8.8&apos;</span><br><span class="line">mask=&apos;255.255.255.255&apos;</span><br><span class="line">dev=lo:1</span><br><span class="line">rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt;/dev/null</span><br><span class="line">service httpd start &amp;&gt; /dev/null &amp;&amp; echo &quot;The httpd Server is Ready!&quot;</span><br><span class="line">echo &quot;&lt;h1&gt;`hostname`&lt;/h1&gt;&quot; &gt; /var/www/html/index.html</span><br><span class="line"></span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">    echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    ifconfig $dev $vip netmask $mask broadcast $vip up</span><br><span class="line">    #route add -host $vip dev $dev</span><br><span class="line">    echo &quot;The RS Server is Ready!&quot;</span><br><span class="line">    ;;  </span><br><span class="line">stop)</span><br><span class="line">    ifconfig $dev down</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    echo &quot;The RS Server is Canceled!&quot;</span><br><span class="line">    ;;  </span><br><span class="line">*) </span><br><span class="line">    echo &quot;Usage: $(basename $0) start|stop&quot;</span><br><span class="line">    exit 1</span><br><span class="line">    ;;  </span><br><span class="line">esac</span><br><span class="line">[root@Web2 ~]# service httpd start      </span><br><span class="line">Starting httpd:                                            [  OK  ] </span><br><span class="line">[root@Web2 ~]# curl 192.168.8.136       # 本地测试可以访问</span><br><span class="line">&lt;h1&gt;Web2&lt;/h1&gt;</span><br></pre></td></tr></table></figure><h3 id="Keepalived配置"><a href="#Keepalived配置" class="headerlink" title="Keepalived配置"></a>Keepalived配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"># Master配置</span><br><span class="line">[root@master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id master</span><br><span class="line">   vrrp_mcast_group 224.18.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens34</span><br><span class="line">    virtual_router_id 8</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass psdfuhg</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.8/24 dev ens34 label ens34:0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.8.8 80 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    sorry_server 127.0.0.1 80</span><br><span class="line"></span><br><span class="line">    real_server 192.168.8.128 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">        url &#123;</span><br><span class="line">            path /</span><br><span class="line">            status_code 200</span><br><span class="line">        &#125;</span><br><span class="line">        connect_timeout 1</span><br><span class="line">        nb_get_retry 3</span><br><span class="line">        delay_before_retyr 1</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 192.168.8.136 80 &#123;</span><br><span class="line">            weight 1</span><br><span class="line">            HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 1</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retyr 1</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># backup配置</span><br><span class="line"></span><br><span class="line">[root@backup ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line"></span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id master</span><br><span class="line">   vrrp_mcast_group 224.18.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens34</span><br><span class="line">    virtual_router_id 8</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass psdfuhg</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.8/24 dev ens34 label ens34:0</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.8.8 80 &#123;</span><br><span class="line">    delay_loop 3 </span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP </span><br><span class="line">    </span><br><span class="line">    sorry_server 127.0.0.1 80  </span><br><span class="line">    </span><br><span class="line">    real_server 192.168.8.128 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        HTTP_GET &#123;</span><br><span class="line">        url &#123;</span><br><span class="line">            path /</span><br><span class="line">            status_code 200 </span><br><span class="line">        &#125;   </span><br><span class="line">        connect_timeout 1</span><br><span class="line">        nb_get_retry 3 </span><br><span class="line">        delay_before_retyr 1</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    real_server 192.168.8.136 80 &#123;</span><br><span class="line">            weight 1</span><br><span class="line">            HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 1</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retyr 1</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试访问"><a href="#测试访问" class="headerlink" title="测试访问"></a>测试访问</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"># 在客户端测试访问，ok</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Web2&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Web1&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Web2&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Web1&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">[root@master ~]# ifconfig               # 现在VIP是在master上面</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.138  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:2438  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 17133  bytes 2118339 (2.0 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 24290  bytes 2165669 (2.0 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.8  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">[root@master ~]# systemctl stop keepalived      # 停止master的keepalived</span><br><span class="line">[root@master ~]# ifconfig           # 已经没有虚拟IP</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.138  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:2438  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 17523  bytes 2165286 (2.0 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 24796  bytes 2209771 (2.1 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@backup ~]# ifconfig           # VIP已经飘逸到了backup上面</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.140  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::250:56ff:fe37:a834  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 21342  bytes 2330926 (2.2 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 20514  bytes 1801946 (1.7 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.8  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">[root@Client ~]# curl 192.168.8.8           # 再次测试依旧可以访问</span><br><span class="line">&lt;h1&gt;Web1&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Web2&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Web1&lt;/h1&gt;</span><br><span class="line">[root@Client ~]# curl 192.168.8.8</span><br><span class="line">&lt;h1&gt;Web2&lt;/h1&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 高可用 </category>
          
          <category> 实现LVS+KeepAlived单主模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> KeepAlived </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>实现KeepAlived单主模式</title>
      <link href="/2017/10/29/KeepAlived-Danzhu/"/>
      <url>/2017/10/29/KeepAlived-Danzhu/</url>
      <content type="html"><![CDATA[<h3 id="准备条件"><a href="#准备条件" class="headerlink" title="准备条件"></a>准备条件</h3><h4 id="配置IP及主机名"><a href="#配置IP及主机名" class="headerlink" title="配置IP及主机名"></a>配置IP及主机名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ifconfig ens34         # 192.168.8.138是master</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.138  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:2438  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 237  bytes 21347 (20.8 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 153  bytes 21995 (21.4 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@master ~]# hostname       # 主机名也已修改为master</span><br><span class="line">master</span><br><span class="line"></span><br><span class="line">[root@backup ~]# ifconfig ens34         # 192.168.8.140是backup</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.140  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::250:56ff:fe37:a834  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 145  bytes 13493 (13.1 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 99  bytes 13701 (13.3 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@backup ~]# hostname       # 主机名也已修改为backup</span><br><span class="line">backup</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="关闭防火墙和SELINUX"><a href="#关闭防火墙和SELINUX" class="headerlink" title="关闭防火墙和SELINUX"></a>关闭防火墙和SELINUX</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># master配置</span><br><span class="line">[root@master ~]# getenforce         # 查看SELINUX已经禁用，如果没关闭，使用命令 setenforce 0来先临时关闭</span><br><span class="line">Disabled</span><br><span class="line">[root@master ~]# systemctl status iptables      # 防火墙也已经关闭</span><br><span class="line">Unit iptables.service could not be found.</span><br><span class="line">[root@master ~]# systemctl status firewalld</span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">     Docs: man:firewalld(1)</span><br><span class="line"></span><br><span class="line"># backup配置</span><br><span class="line">[root@backup ~]# getenforce </span><br><span class="line">Disabled</span><br><span class="line">[root@backup ~]# systemctl status firewalld</span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">     Docs: man:firewalld(1)</span><br></pre></td></tr></table></figure><h4 id="同步时间"><a href="#同步时间" class="headerlink" title="同步时间"></a>同步时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># master配置</span><br><span class="line">[root@master ~]# ntpdate            # 使用ntpdate同步时间</span><br><span class="line">bash: ntpdate: command not found</span><br><span class="line">[root@master ~]# yum install ntpdate        # 安装ntpdate</span><br><span class="line"></span><br><span class="line">[root@master ~]# ntpdate 172.18.0.1         # master同步时间</span><br><span class="line">28 Oct 21:55:22 ntpdate[9397]: step time server 172.18.0.1 offset 62.614049 sec</span><br><span class="line">[root@master ~]# date</span><br><span class="line">Sat Oct 28 21:55:25 CST 2017</span><br><span class="line"></span><br><span class="line"># backup配置</span><br><span class="line">[root@backup ~]# yum install -y ntpdate     </span><br><span class="line">[root@backup ~]# ntpdate 172.18.0.1         # backup同步时间</span><br><span class="line">28 Oct 22:04:19 ntpdate[9397]: step time server 172.18.0.1 offset 62.614049 sec</span><br><span class="line">[root@backup ~]# date</span><br><span class="line">Sat Oct 28 22:04:35 CST 2017</span><br></pre></td></tr></table></figure><h3 id="配置KeepAlived"><a href="#配置KeepAlived" class="headerlink" title="配置KeepAlived"></a>配置KeepAlived</h3><h4 id="安装KeepAlived"><a href="#安装KeepAlived" class="headerlink" title="安装KeepAlived"></a>安装KeepAlived</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># master配置</span><br><span class="line">[root@master ~]# yum install -y keepalived</span><br><span class="line"></span><br><span class="line"># backup配置</span><br><span class="line">[root@backup ~]# yum install -y keepalived</span><br></pre></td></tr></table></figure><h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p>使用192.168.8.8来当<code>VIP</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># master配置</span><br><span class="line">[root@master ~]# cp -a  /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak     # 先备份配置文件</span><br><span class="line">[root@master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;   </span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id master</span><br><span class="line">   vrrp_mcast_group 224.18.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens34</span><br><span class="line">    virtual_router_id 8</span><br><span class="line">    priority 100 </span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass psdfuhg</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.8/24 dev ens34 label ens34:0</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># backup配置</span><br><span class="line">[root@backup ~]# cp -a  /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br><span class="line">[root@backup ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     root@localhost</span><br><span class="line">   &#125;   </span><br><span class="line">   notification_email_from keepalived@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id master</span><br><span class="line">   vrrp_mcast_group 224.18.100.100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens34</span><br><span class="line">    virtual_router_id 8</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass psdfuhg</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.8/24 dev ens34 label ens34:0</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># master启动</span><br><span class="line">[root@master ~]# systemctl start keepalived</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># backup启动</span><br><span class="line">[root@backup ~]# systemctl start keepalived</span><br><span class="line"></span><br><span class="line">[root@master ~]# ifconfig       # 在master查看IP已经配置上IP地址</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.138  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:2438  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 753  bytes 66263 (64.7 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 1603  bytes 155108 (151.4 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.8  netmask 255.255.255.0  broadcast 0.0.0.0</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">[root@backup ~]# ifconfig           # 在backup查看IP地址，没有变化ok</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.140  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::250:56ff:fe37:a834  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 4160  bytes 321764 (314.2 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 2840  bytes 377028 (368.1 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/KeepAlived-Danzhu-1.gif" title="测试访问"></center>]]></content>
      
      <categories>
          
          <category> 高可用 </category>
          
          <category> 实现KeepAlived单主模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> KeepAlived </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Keepalived配置文件</title>
      <link href="/2017/10/29/KeepAlived-Configuration-File/"/>
      <url>/2017/10/29/KeepAlived-Configuration-File/</url>
      <content type="html"><![CDATA[<h3 id="Keepalived的配置文件"><a href="#Keepalived的配置文件" class="headerlink" title="Keepalived的配置文件"></a>Keepalived的配置文件</h3><p><code>keepalived</code>只有一个配置文件<code>keepalived.conf</code>，里面主要包括以下几个配置区域，分别是<code>global_defs</code>、<code>static_ipaddress</code>、<code>static_routes</code>、<code>vrrp_script</code>、<code>vrrp_instance</code>和<code>virtual_server</code>。</p><a id="more"></a><h4 id="global-defs区域"><a href="#global-defs区域" class="headerlink" title="global_defs区域"></a>global_defs区域</h4><p>主要是配置故障发生时的通知对象以及机器标识</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;                       # 全局配置</span><br><span class="line">   notification_email &#123;             # 通告邮件的用户</span><br><span class="line">     root@localhost                 # 指定keepalived在发生切换时需要发送email到的对象，一行一个</span><br><span class="line">   &#125;   </span><br><span class="line">   # 邮件服务器配置</span><br><span class="line">   notification_email_from keepalived@localhost         # 指定发件人</span><br><span class="line">   smtp_server 127.0.0.1            # smtp 服务器地址</span><br><span class="line">   smtp_connect_timeout 30          # smtp 服务器连接超时时间</span><br><span class="line">   router_id master                 # 标识本节点的字符串,通常为hostname,但不一定非得是hostname,故障发生时,邮件通知会用到</span><br><span class="line">   vrrp_mcast_group4 224.0.0.18     # 同一个组播域，ipv4的默认组播域，如果没有指定这里使用224.0.0.18</span><br><span class="line">   vrrp_mcast_group6 ff02::12       # ipv6多播地址</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="static-ipaddress和static-routes区域"><a href="#static-ipaddress和static-routes区域" class="headerlink" title="static_ipaddress和static_routes区域"></a>static_ipaddress和static_routes区域</h4><p><code>static_ipaddress</code>和<code>static_routes</code>区域配置的是是本节点的<code>IP</code>和路由信息。如果你的机器上已经配置了<code>IP</code>和路由，那么这两个区域可以不用配置。其实，一般情况下你的机器都会有IP地址和路由信息的，因此没必要再在这两个区域配置。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static_ipaddress &#123;</span><br><span class="line">    10.210.214.163/24 brd 10.210.214.255 dev eth0</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">static_routes &#123;</span><br><span class="line">    10.0.0.0/8 via 10.210.214.1 dev eth0</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="vrrp-instance和vrrp-sync-group区域"><a href="#vrrp-instance和vrrp-sync-group区域" class="headerlink" title="vrrp_instance和vrrp_sync_group区域"></a>vrrp_instance和vrrp_sync_group区域</h4><p><code>vrrp_instance</code>用来定义对外提供服务的VIP区域及其相关属性。</p><p><code>vrrp_rsync_group</code>用来定义<code>vrrp_intance</code>组，使得这个组内成员动作一致。举个例子来说明一下其功能：</p><ul><li>两个<code>vrrp_instance</code>同属于一个<code>vrrp_rsync_group</code>，那么其中一个<code>vrrp_instance</code>发生故障切换时，另一个<code>vrrp_instance</code>也会跟着切换（即使这个<code>instance</code>没有发生故障）。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">vrrp_sync_group VG_1 &#123; </span><br><span class="line">    group &#123;</span><br><span class="line">    VI_1 # name of vrrp_instance (below)</span><br><span class="line">    VI_2 # One for each moveable IP.</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master /path/to_master.sh    # notify_master/backup/fault 分别表示切换为主/备/出错时所执行的脚本。</span><br><span class="line">    notify_backup /path/to_backup.sh</span><br><span class="line">    notify_fault &quot;/path/fault.sh VG_1&quot;</span><br><span class="line">    notify /path/notify.sh          # notify 表示任何一状态切换时都会调用该脚本，并且该脚本在以上三个脚本执行完成之后进行调用，keepalived会自动传递三个参数（$1 = &quot;GROUP&quot;|&quot;INSTANCE&quot;，$2 = name of group or instance，$3 = target state of transition(MASTER/BACKUP/FAULT)）。</span><br><span class="line">    smtp_alert              # smtp_alert 表示是否开启邮件通知（用全局区域的邮件设置来发通知）。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;        # 实例名称     </span><br><span class="line">    state MASTER            # 可以是MASTER或BACKUP，不过当其他节点keepalived启动时会将priority比较大的节点选举为MASTER,因此该项其实没有实质用途。</span><br><span class="line">    interface ens34         # 节点固有IP（非VIP）的网卡，用来发VRRP包做心跳检测 </span><br><span class="line">    virtual_router_id 8     # 虚拟路由ID,取值在0-255之间,用来区分多个instance的VRRP组播,同一网段内ID不能重复;主备必须为一样;</span><br><span class="line">    priority 100            # 用来选举master的,要成为master那么这个选项的值最好高于其他机器,该项取值范围是1-255(在此范围之外会被识别成默认值100)</span><br><span class="line">    lvs_sync_daemon_interface       # 绑定lvs syncd的网卡。</span><br><span class="line">    garp_master_delay       # 当切为主状态后多久更新ARP缓存，默认5秒。</span><br><span class="line">    track_interface         # 监控以下网卡，如果任何一个不通就会切换到FALT状态。（可选项）</span><br><span class="line">    dont_track_primary      # 忽略VRRP网卡错误。（默认未设置）</span><br><span class="line">    advert_int 1            # 检查间隔默认为1秒,即1秒进行一次master选举(可以认为是健康查检时间间隔)</span><br><span class="line">    authentication &#123;        # 认证区域,认证类型有PASS和HA（IPSEC）,推荐使用PASS(密码只识别前8位)</span><br><span class="line">        auth_type PASS      # 认证区域,认证类型有PASS和HA（IPSEC）,推荐使用PASS(密码只识别前8位)</span><br><span class="line">        auth_pass psdfuhg   # PASS认证密码</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.8/24 dev ens34 label ens34:0      # 虚拟VIP地址，允许有多个</span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    virtual_routes &#123;        # 虚拟路由，当IP漂过来之后需要添加的路由信息。</span><br><span class="line">        172.16.0.0/12 via 10.210.214.1</span><br><span class="line">        192.168.1.0/24 via 192.168.1.1 dev eth1</span><br><span class="line">        default via 202.102.152.1</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    preempt_delay 300        # 启动多久之后进行接管资源（VIP/Route信息等），并提是没有nopreempt选项。</span><br><span class="line">    </span><br><span class="line">    debug：debug级别</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    notify_master /path/to_master.sh    # notify_master/backup/fault 分别表示切换为主/备/出错时所执行的脚本。</span><br><span class="line">    notify_backup /path/to_backup.sh</span><br><span class="line">    notify_fault &quot;/path/fault.sh VG_1&quot;</span><br><span class="line">    notify /path/notify.sh          # notify 表示任何一状态切换时都会调用该脚本，并且该脚本在以上三个脚本执行完成之后进行调用，keepalived会自动传递三个参数（$1 = &quot;GROUP&quot;|&quot;INSTANCE&quot;，$2 = name of group or instance，$3 = target state of transition(MASTER/BACKUP/FAULT)）。</span><br><span class="line">    smtp_alert              # smtp_alert 表示是否开启邮件通知（用全局区域的邮件设置来发通知）。</span><br><span class="line">    </span><br><span class="line">    nopreempt           # 设置不抢占，允许一个priority比较低的节点作为master，即使有priority更高的节点启动。</span><br><span class="line">    # 首先nopreemt必须在state为BACKUP的节点上才生效（因为是BACKUP节点决定是否来成为MASTER的），</span><br><span class="line">    其次要实现类似于关闭auto failback的功能需要将所有节点的state都设置为BACKUP，或者将master节点的priority设置的比BACKUP低。</span><br><span class="line">    我个人推荐使用将所有节点的state都设置成BACKUP并且都加上nopreempt选项，这样就完成了关于autofailback功能，</span><br><span class="line">    当想手动将某节点切换为MASTER时只需去掉该节点的nopreempt选项并且将priority改的比其他节点大，</span><br><span class="line">    然后重新加载配置文件即可（等MASTER切过来之后再将配置文件改回去再reload一下）。</span><br><span class="line">    </span><br><span class="line">    当使用track_script时可以不用加nopreempt，只需要加上preempt_delay 5，这里的间隔时间要大于vrrp_script中定义的时长。</span><br><span class="line">    </span><br><span class="line">    track interface         # 跟踪接口，设置额外的监控，里面任意一块网卡出现问题，都会进入故障(FAULT)状态，例如，用nginx做均衡器的时候，内网必须正常工作，如果内网出问题了，这个均衡器也就无法运作了，所以必须对内外网同时做健康检查</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="vrrp-script区域"><a href="#vrrp-script区域" class="headerlink" title="vrrp_script区域"></a>vrrp_script区域</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script chk_httpd &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_and_start_httpd.sh&quot;   # apache httpd 服务检测并试图重启</span><br><span class="line">    interval 2                    # 每2s检查一次</span><br><span class="line">    weight -5                     # 检测失败（脚本返回非0）则优先级减少5个值</span><br><span class="line">    fall 3                        # 如果连续失败次数达到此值，则认为服务器已down</span><br><span class="line">    rise 2                        # 如果连续成功次数达到此值，则认为服务器已up</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="virtual-server-group和virtual-server区域"><a href="#virtual-server-group和virtual-server区域" class="headerlink" title="virtual_server_group和virtual_server区域"></a>virtual_server_group和virtual_server区域</h4><p><code>virtual_server_group</code>一般在超大型的LVS中用到，一般<code>LVS</code>用不着这东西，因此不多说。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">virtual_server 192.168.8.8 80 &#123;</span><br><span class="line">    delay_loop 3            # 检查后端服务器的时间间隔（单位秒）</span><br><span class="line">    lb_algo rr              # 后端调试算法（load balancing algorithm）</span><br><span class="line">    lb_kind DR              #  LVS调度类型NAT/DR/TUN。</span><br><span class="line">    protocol TCP            # 服务协议，进支持TCP</span><br><span class="line">    </span><br><span class="line">    sorry_server 127.0.0.1 80       # 当所有real server宕掉时，sorry server顶替</span><br><span class="line">    </span><br><span class="line">    real_server 192.168.8.128 80 &#123;      # real_server 真正提供服务的服务器</span><br><span class="line">        weight 1            # weight 权重</span><br><span class="line">        HTTP_GET | SSL_GET &#123;          # 健康检查的方式，N多种方式</span><br><span class="line">        url &#123;</span><br><span class="line">            path /          # path 请求real serserver上的路径。</span><br><span class="line">            status_code 200 # digest/status_code 分别表示用genhash算出的结果和http状态码</span><br><span class="line">        &#125;   </span><br><span class="line">        connect_ip 192.168.8.128    # 向当前RS的哪个IP地址发起健康状态检测请求</span><br><span class="line">        connect_port 80     # 健康检查，如果端口通则认为服务器正常</span><br><span class="line">        bindto 192.168.8.138    # 发出健康状态检测请求时使用的源地址</span><br><span class="line">        bind_port 12340         # 发出健康状态检测请求时使用的源端口</span><br><span class="line">        connect_timeout     # 超时时长</span><br><span class="line">        nb_get_retry 3      # 重试次数</span><br><span class="line">        delay_before_retyr 1        # 下次重试的时间延迟</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    real_server 192.168.8.136 80 &#123;</span><br><span class="line">            weight 1</span><br><span class="line">            HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 1</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retyr 1</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    track_script &#123;                # 引用VRRP脚本，即在 vrrp_script 部分指定的名字。定期运行它们来改变优先级，并最终引发主备切换。</span><br><span class="line">        chk_httpd          </span><br><span class="line">    &#125;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://outofmemory.cn/wiki/keepalived-configuration" target="_blank" rel="noopener">keepalived工作原理和配置说明</a></p>]]></content>
      
      <categories>
          
          <category> 高可用 </category>
          
          <category> Keepalived配置文件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> KeepAlived </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Keepalived简介</title>
      <link href="/2017/10/29/KeepAlived/"/>
      <url>/2017/10/29/KeepAlived/</url>
      <content type="html"><![CDATA[<center><img src="https://houhaiyun.github.io/img/images/KeepAlived-1.jpg" title="KeepAlived"></center><h3 id="官网介绍"><a href="#官网介绍" class="headerlink" title="官网介绍"></a>官网介绍</h3><p><a href="http://www.keepalived.org/" target="_blank" rel="noopener">官网：http://www.keepalived.org/</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">What is Keepalived ?</span><br><span class="line">Keepalived is a routing software written in C. The main goal of this project is to provide simple and robust facilities for loadbalancing and high-availability to Linux system and Linux based infrastructures. Loadbalancing framework relies on well-known and widely used Linux Virtual Server (IPVS) kernel module providing Layer4 loadbalancing. Keepalived implements a set of checkers to dynamically and adaptively maintain and manage loadbalanced server pool according their health. On the other hand high-availability is achieved by VRRP protocol. VRRP is a fundamental brick for router failover. In addition, Keepalived implements a set of hooks to the VRRP finite state machine providing low-level and high-speed protocol interactions. Keepalived frameworks can be used independently or all together to provide resilient infrastructures.</span><br><span class="line"></span><br><span class="line">Keepalived is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</span><br></pre></td></tr></table></figure><a id="more"></a><p><code>Keepalived</code>是用C编写的路由软件。该项目的主要目标是为<code>Linux</code>系统和基于<code>Linux</code>的基础设施提供简单而强大的负载平衡和高可用性设施。 负载平衡框架依赖于众所周知的广泛使用的<code>Linux</code>虚拟服务器（<code>IPVS</code>）内核模块，提供<code>Layer4</code>负载平衡。<code>Keepalived</code>实现了一组检查器，以动态和自适应地维护和管理负载平衡的服务器池，以保证其健康。另一方面<code>VRRP</code>实现了高可用性 协议。<code>VRRP</code>是路由器故障切换的基础。此外，<code>Keepalived</code>实现了一组钩子到<code>VRRP</code>有限状态机，提供低级和高速协议交互。<code>Keepalived</code>框架可以单独使用或全部使用，以提供弹性的基础设施。</p><h4 id="VRRP简介"><a href="#VRRP简介" class="headerlink" title="VRRP简介"></a>VRRP简介</h4><p>虚拟路由冗余协议(<code>Virtual Router Redundancy Protocol</code>，简称<code>VRRP</code>)是由<code>IETF</code>提出的解决局域网中配置静态网关出现单点失效现象的路由协议。</p><h3 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a>模块介绍</h3><p><code>Keepalived</code>采用是模块化设计，不同模块实现不同的功能，<code>keepalived</code>主要有三个模块，分别是<code>core</code>、<code>check</code>和<code>vrrp</code>。 <code>core</code>：是<code>keepalived</code>的核心，负责主进程的启动和维护，全局配置文件的加载解析等 <code>check</code>： 负责<code>healthchecker</code>(健康检查)，包括了各种健康检查方式，以及对应的配置的解析包括LVS的配置解析；<br>可基于脚本检查对<code>IPVS</code>后端服务器健康状况进行检查。 <code>vrrp</code>：<code>VRRPD</code>子进程，<code>VRRPD</code>子进程就是来实现<code>VRRP</code>协议的</p><p>以上是主要组件；下面是其他库： <code>libipfwc</code>：<code>iptables/ipchains</code>库，配置<code>LVS</code>会用到 <code>libipvs*</code>：配置LVS会用到。<br><strong>注意</strong>，<code>keepalived</code>和<code>LVS</code>完全是两码事，各司其职相互配合。</p><h4 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h4><center><img src="https://houhaiyun.github.io/img/images/KeepAlived-2.jpg" title="KeepAlived架构图"></center><p><code>Keepalived</code>启动后会有三个进程:</p><ul><li>父进程：内存管理，子进程管理等等</li><li>子进程：<code>vrrpd</code>子进程</li><li>子进程：<code>healthchecker</code>子进程</li></ul><p>由上图可知，两个子进程都被系统<code>WatchDog</code>看管，两个子进程各自实现自己的事，<code>healthchecker</code>子进程实现检查各自服务器的健康程度，例如<code>HTTP</code>，<code>LVS</code>等等，如果<code>healthchecker</code>子进程检查到<code>MASTER</code>上服务不可用，就会通知本机上的兄弟<code>VRRP</code>子进程，让他删除通告，并且去掉虚拟<code>IP</code>，转换为<code>BACKUP</code>状态</p><h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p><code>keepalived</code>是一个类似于<code>layer3, 4 &amp; 5</code>交换机制的软件，也就是第3层、第4层和第5层交换,分别工作在<code>IP/TCP</code>协议栈的<code>IP层</code>、<code>TCP层</code>、<code>应用层</code>，原理分别如下： <code>Layer3</code>： <code>Keepalived</code>使用<code>Layer3</code>的方式工作式时，<code>Keepalived</code>会定期向服务器群中的服务器发送一个<code>ICMP</code>的数据包（既<code>Ping</code>）,如果发现某台服务的<code>IP</code>地址没有激活，<code>Keepalived</code>便报告这台服务器失效，并将它从服务器群中剔除(这种情况的典型例子是某台服务器被非法关机)。<code>Layer3</code>方式是以服务器的<code>IP</code>地址是否有效作为服务器工作正常与否的标准。 <code>Layer4</code>: <code>Layer4</code>主要以<code>TCP</code>端口的状态来决定服务器工作正常与否。如<code>web server</code>的服务端口一般是<code>80</code>，如果<code>Keepalived</code>检测到<code>80</code>端口没有启动，则<code>Keepalived</code>将把这台服务器从服务器群中剔除。 <code>Layer5</code>： <code>Layer5</code>就是工作在具体的应用层了，比<code>Layer3</code>,<code>Layer4</code>要复杂，在网络上占用的带宽也要大一些。<code>Keepalived</code>将根据用户的设定检查服务器相应服务是否运行正常，如果没有正常运行，则<code>Keepalived</code>将把服务器从服务器群中剔除。</p><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://www.userzr.com/57.html" target="_blank" rel="noopener">Keepalived原理</a></p>]]></content>
      
      <categories>
          
          <category> 高可用 </category>
          
          <category> Keepalived简介 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> KeepAlived </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块  ngx_stream_core_module</title>
      <link href="/2017/10/28/Nginx-ngx-stream-core-module/"/>
      <url>/2017/10/28/Nginx-ngx-stream-core-module/</url>
      <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>所述<code>ngx_stream_upstream_module</code>模块（<code>1.9.0</code>）被用于定义可以由被引用的服务器组<code>proxy_pass</code>指令。</p><h3 id="upstream-name-…"><a href="#upstream-name-…" class="headerlink" title="upstream name { … }"></a>upstream name { … }</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:upstream name &#123; ... &#125;</span><br><span class="line">Default:—</span><br><span class="line">Context:stream</span><br></pre></td></tr></table></figure></p><p>定义一组服务器。服务器可以在不同端口上侦听。另外，监听<code>TCP</code>和<code>UNIX</code>域套接字的服务器可以混合使用。</p><a id="more"></a><h3 id="模块-ngx-stream-proxy-module"><a href="#模块-ngx-stream-proxy-module" class="headerlink" title="模块 ngx_stream_proxy_module"></a>模块 ngx_stream_proxy_module</h3><p>可实现代理基于<code>TCP</code>，<code>UDP</code>(1.9.13), <code>UNIX-domain sockets</code>的数据流</p><h4 id="proxy-pass-address"><a href="#proxy-pass-address" class="headerlink" title="proxy_pass address;"></a>proxy_pass address;</h4><p>指定后端服务器地址</p><h4 id="proxy-timeout-timeout"><a href="#proxy-timeout-timeout" class="headerlink" title="proxy_timeout timeout;"></a>proxy_timeout timeout;</h4><p>无数据传输时，保持连接状态的超时时长,默认为10m</p><h4 id="proxy-connect-timeout-time"><a href="#proxy-connect-timeout-time" class="headerlink" title="proxy_connect_timeout time;"></a>proxy_connect_timeout time;</h4><p>设置<code>nginx</code>与被代理的服务器尝试建立连接的超时时长;默认为<code>60s</code></p><h3 id="实现反向代理3306端口的Mysql服务"><a href="#实现反向代理3306端口的Mysql服务" class="headerlink" title="实现反向代理3306端口的Mysql服务"></a>实现反向代理3306端口的Mysql服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"># 192.168.8.128的配置</span><br><span class="line">[root@128 ~]# yum install -y mysql-server           # 安装mysql数据库</span><br><span class="line">[root@128 ~]# service mysqld start              # 启动mysql数据库</span><br><span class="line">Starting mysqld:                                           [  OK  ]</span><br><span class="line">[root@128 ~]# mysql         # 连接Mysql请注意128的mysql版本为5.1</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.1.73 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE USER test IDENTIFIED BY &apos;centos&apos; ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 192.168.8.138的配置</span><br><span class="line">[root@138 ~]# yum -y  install mariadb-server         # 安装Mariadb数据库</span><br><span class="line">[root@138 ~]# systemctl start mariadb               # 启动Mariadb数据库</span><br><span class="line">[root@138 ~]# mysql                 # 连接Mariadb请注意138的Mariadb版本为5.5</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 2</span><br><span class="line">Server version: 5.5.52-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; CREATE USER test IDENTIFIED BY &apos;centos&apos; ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Nginx服务的配置</span><br><span class="line">[root@nginx ~]# vim /etc/nginx/nginx.conf           # 添加一下行</span><br><span class="line">stream &#123;</span><br><span class="line">    upstream mysqlser &#123;         # 此处人可以指定调度算法ip_hash等</span><br><span class="line">        server 192.168.8.128:3306;</span><br><span class="line">        server 192.168.8.138:3306;</span><br><span class="line">    &#125;   </span><br><span class="line">    server &#123;</span><br><span class="line">        listen 192.168.8.140:3306;          # 定义一个server，指定监听本地IP192.168.8.140的3306端口</span><br><span class="line">        proxy_pass mysqlser ;           # 转发到本地的网络组mysqlser</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@nginx ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@nginx ~]# nginx -s reload</span><br><span class="line"></span><br><span class="line">[root@nginx ~]# yum install -y  mariadb             # 安装mysql客户端          </span><br><span class="line">[root@nginx ~]# mysql -utest -pcentos -h 192.168.8.140      # 连接测试，应该是已经连接上192.168.8.128上面的mysql5.1了</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.1.73 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; Bye</span><br><span class="line">[root@nginx ~]# mysql -utest -pcentos -h 192.168.8.140      # 连接测试，应该是已经连接上192.168.8.138上面的mysql5.5了</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 3</span><br><span class="line">Server version: 5.5.52-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; Bye</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块  ngx_stream_core_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块  ngx_stream_core_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Nginx编译安装模块（非重装）</title>
      <link href="/2017/10/28/Nginx-make2/"/>
      <url>/2017/10/28/Nginx-make2/</url>
      <content type="html"><![CDATA[<h3 id="添加mail模块"><a href="#添加mail模块" class="headerlink" title="添加mail模块"></a>添加mail模块</h3><h4 id="查看本地已经编译的模块"><a href="#查看本地已经编译的模块" class="headerlink" title="查看本地已经编译的模块"></a>查看本地已经编译的模块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# cd /usr/local/nginx/sbin/</span><br><span class="line">[root@centos7 sbin]# ./nginx -V</span><br><span class="line">nginx version: HaiYunNginx/6.6.6</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-11) (GCC) </span><br><span class="line">built with OpenSSL 1.0.1e-fips 11 Feb 2013</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx </span><br><span class="line">--conf-path=/etc/nginx/nginx.conf </span><br><span class="line">--error-log-path=/var/log/nginx/error.log </span><br><span class="line">--http-log-path=/var/log/nginx/access.log</span><br><span class="line">--pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock</span><br><span class="line">--http-proxy-temp-path=/var/lib/nginx/tmp/proxy </span><br><span class="line">--http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi</span><br><span class="line">--pid-path=/run/nginx.pid --with-http_mp4_module --with-http_gunzip_module</span><br><span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp</span><br><span class="line">--with-stream_ssl_module --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module</span><br><span class="line">--with-http_dav_module --with-http_stub_status_module --with-threads --with-file-aio</span><br></pre></td></tr></table></figure><a id="more"></a><h4 id="configure脚本"><a href="#configure脚本" class="headerlink" title="configure脚本"></a>configure脚本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 nginx-1.13.6]# ./configure --prefix=/usr/local/nginx \</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log \</span><br><span class="line">--http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid \</span><br><span class="line">--lock-path=/var/run/nginx.lock --http-proxy-temp-path=/var/lib/nginx/tmp/proxy \</span><br><span class="line">--http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --pid-path=/run/nginx.pid \</span><br><span class="line">--with-http_mp4_module --with-http_gunzip_module --http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span><br><span class="line">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --with-stream_ssl_module --user=nginx \</span><br><span class="line">--group=nginx --with-http_ssl_module --with-http_v2_module --with-http_dav_module \</span><br><span class="line">--with-http_stub_status_module --with-threads --with-file-aio \</span><br><span class="line">--with-mail  # 添加mail模块</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：在添加模块的时候，一定要把这些之前编译的模块带上，不然你编译的只有你想提价的模块，之前的模块不会编译。</p><h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 nginx-1.13.6]# make</span><br></pre></td></tr></table></figure><p>注意：不要<code>make install</code>，不然就相当于重装了。</p><h4 id="替换Nginx二进制文件"><a href="#替换Nginx二进制文件" class="headerlink" title="替换Nginx二进制文件"></a>替换Nginx二进制文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 nginx-1.13.6]# cp -a /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak      # 替换前先备份一下    </span><br><span class="line">[root@centos7 nginx-1.13.6]# cp ./objs/nginx /usr/local/nginx/sbin/         # 替换nginx程序</span><br><span class="line">cp: overwrite ‘/usr/local/nginx/sbin/nginx’? y</span><br></pre></td></tr></table></figure><h4 id="启动nginx，并查看编译选项"><a href="#启动nginx，并查看编译选项" class="headerlink" title="启动nginx，并查看编译选项"></a>启动nginx，并查看编译选项</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 nginx-1.13.6]# /usr/local/nginx/sbin/nginx </span><br><span class="line">[root@centos7 nginx-1.13.6]# /usr/local/nginx/sbin/nginx -V</span><br><span class="line">nginx version: HaiYunNginx/6.6.6</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-11) (GCC) </span><br><span class="line">built with OpenSSL 1.0.1e-fips 11 Feb 2013</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx </span><br><span class="line">--conf-path=/etc/nginx/nginx.conf </span><br><span class="line">--error-log-path=/var/log/nginx/error.log </span><br><span class="line">--http-log-path=/var/log/nginx/access.log </span><br><span class="line">--pid-path=/var/run/nginx.pid </span><br><span class="line">--lock-path=/var/run/nginx.lock </span><br><span class="line">--http-proxy-temp-path=/var/lib/nginx/tmp/proxy </span><br><span class="line">--http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi </span><br><span class="line">--pid-path=/run/nginx.pid --with-http_mp4_module </span><br><span class="line">--with-http_gunzip_module --http-scgi-temp-path=/var/cache/nginx/scgi_temp</span><br><span class="line">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --with-stream_ssl_module </span><br><span class="line">--user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module </span><br><span class="line">--with-http_dav_module --with-http_stub_status_module </span><br><span class="line">--with-threads --with-file-aio --with-mail    # 已经添加成功</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> Nginx编译安装模块（非重装） </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx编译安装模块（非重装） </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Nginx编译安装</title>
      <link href="/2017/10/28/Nginx-make/"/>
      <url>/2017/10/28/Nginx-make/</url>
      <content type="html"><![CDATA[<h3 id="安装必备软件包"><a href="#安装必备软件包" class="headerlink" title="安装必备软件包"></a>安装必备软件包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# yum -y install  openssl-devel pcre-devel      # 安装必备包</span><br><span class="line">[root@centos7 nginx-1.10.3]# yum install gcc make gcc-c++       # 安装编译工具</span><br></pre></td></tr></table></figure><h3 id="下载源码包"><a href="#下载源码包" class="headerlink" title="下载源码包"></a>下载源码包</h3><p>目前最新的版本是<code>1.13.6</code>，先来尝个鲜。（生产中可不要这么干！）</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# wget  http://nginx.org/download/nginx-1.13.6.tar.gz       # 下载源码包</span><br><span class="line">--2017-10-28 19:16:52--  http://nginx.org/download/nginx-1.13.6.tar.gz</span><br><span class="line">Resolving nginx.org (nginx.org)... 95.211.80.227, 206.251.255.63, 2001:1af8:4060:a004:21::e3, ...</span><br><span class="line">Connecting to nginx.org (nginx.org)|95.211.80.227|:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 989760 (967K) [application/octet-stream]</span><br><span class="line">Saving to: ‘nginx-1.13.6.tar.gz’</span><br><span class="line"></span><br><span class="line">100%[===================================================&gt;] 989,760      424KB/s   in 2.3s   </span><br><span class="line"></span><br><span class="line">2017-10-28 19:16:55 (424 KB/s) - ‘nginx-1.13.6.tar.gz’ saved [989760/989760]</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# ls</span><br><span class="line">nginx-1.13.6.tar.gz</span><br></pre></td></tr></table></figure><h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# tar xf nginx-1.13.6.tar.gz -C /usr/local/src/         # 解压到/usr/local/src/目录下</span><br></pre></td></tr></table></figure><h3 id="修改隐藏Nginx版本号"><a href="#修改隐藏Nginx版本号" class="headerlink" title="修改隐藏Nginx版本号"></a>修改隐藏Nginx版本号</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# cd /usr/local/src/nginx-1.13.6/src/core/</span><br><span class="line">[root@centos7 core]# vim nginx.h</span><br><span class="line">/*</span><br><span class="line"> * Copyright (C) Igor Sysoev</span><br><span class="line"> * Copyright (C) Nginx, Inc.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#ifndef _NGINX_H_INCLUDED_</span><br><span class="line">#define _NGINX_H_INCLUDED_</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#define nginx_version      1013006</span><br><span class="line">#define NGINX_VERSION      &quot;6.6.6&quot;              # 自定义版本</span><br><span class="line">#define NGINX_VER          &quot;HaiYunNginx/&quot; NGINX_VERSION         # Server自定义</span><br><span class="line"></span><br><span class="line">#ifdef NGX_BUILD</span><br><span class="line">#define NGINX_VER_BUILD    NGINX_VER &quot; (&quot; NGX_BUILD &quot;)&quot;</span><br><span class="line">#else</span><br><span class="line">#define NGINX_VER_BUILD    NGINX_VER</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#define NGINX_VAR          &quot;NGINX&quot;</span><br><span class="line">#define NGX_OLDPID_EXT     &quot;.oldbin&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#endif /* _NGINX_H_INCLUDED_ */</span><br></pre></td></tr></table></figure><h3 id="添加nginx用户"><a href="#添加nginx用户" class="headerlink" title="添加nginx用户"></a>添加nginx用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 nginx-1.13.6]# useradd -r -s /sbin/nologin -m -d   /var/lib/nginx nginx       # 添加用户nginx</span><br></pre></td></tr></table></figure><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 nginx-1.13.6]# ./configure --prefix=/usr/local/nginx \        # 开始编译安装</span><br><span class="line">&gt; --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">&gt; --error-log-path=/var/log/nginx/error.log \</span><br><span class="line">&gt; --http-log-path=/var/log/nginx/access.log \</span><br><span class="line">&gt; --pid-path=/var/run/nginx.pid \</span><br><span class="line">&gt; --lock-path=/var/run/nginx.lock \</span><br><span class="line">&gt; --http-proxy-temp-path=/var/lib/nginx/tmp/proxy \</span><br><span class="line">&gt; --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi \</span><br><span class="line">&gt; --pid-path=/run/nginx.pid \</span><br><span class="line">&gt; --with-http_mp4_module \</span><br><span class="line">&gt; --with-http_gunzip_module \</span><br><span class="line">&gt; --http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span><br><span class="line">&gt;  --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</span><br><span class="line">&gt;  --with-stream_ssl_module \</span><br><span class="line">&gt; --user=nginx \</span><br><span class="line">&gt; --group=nginx \</span><br><span class="line">&gt; --with-http_ssl_module \</span><br><span class="line">&gt; --with-http_v2_module \</span><br><span class="line">&gt; --with-http_dav_module \</span><br><span class="line">&gt; --with-http_stub_status_module \</span><br><span class="line">&gt; --with-threads \</span><br><span class="line">&gt; --with-file-aio \</span><br><span class="line">&gt; </span><br><span class="line"></span><br><span class="line">[root@centos7 nginx-1.13.6]# make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="编译参数说明"><a href="#编译参数说明" class="headerlink" title="编译参数说明"></a>编译参数说明</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">--error-log-path=/var/log/nginx/error.log \</span><br><span class="line">--http-log-path=/var/log/nginx/access.log \</span><br><span class="line">--pid-path=/var/run/nginx.pid \</span><br><span class="line">--lock-path=/var/run/nginx.lock \</span><br><span class="line">--http-proxy-temp-path=/var/lib/nginx/tmp/proxy \</span><br><span class="line">--http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi \</span><br><span class="line">--pid-path=/run/nginx.pid \</span><br><span class="line">--with-http_mp4_module \</span><br><span class="line">--with-http_gunzip_module \</span><br><span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp \</span><br><span class="line"> --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</span><br><span class="line"> --with-stream_ssl_module \</span><br><span class="line">--user=nginx \</span><br><span class="line">--group=nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_dav_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-threads \</span><br><span class="line">--with-file-aio \</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/nginx \ # 安装目录</span><br><span class="line">--conf-path=/etc/nginx/nginx.conf \ # 指定配置文件路径</span><br><span class="line">--error-log-path=/var/log/nginx/error.log \ # 错误日志</span><br><span class="line">--http-log-path=/var/log/nginx/access.log \ # 访问日志</span><br><span class="line">--pid-path=/var/run/nginx.pid \ # pid路径</span><br><span class="line">--lock-path=/var/run/nginx.lock \   #  锁文件安装位置</span><br><span class="line">--http-proxy-temp-path=/var/lib/nginx/tmp/proxy \   作为代理服务器，服务器响应报文的临时文件存放路径</span><br><span class="line">--http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi \ 作为fastcgi代理服务器，服务器响应报文的临时文件存放路径</span><br><span class="line">--with-http_mp4_module \    # 启用MP4视频</span><br><span class="line">--with-http_gunzip_module \ # 启用压缩</span><br><span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp \ # 作为scgi反代服务器，服务器响应报文的临时文件存放路径</span><br><span class="line"> --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \# 作为uwsgi代理服务器，服务器响应报文的临时文件存放路径</span><br><span class="line">--with-stream_ssl_module \ # 启用stream模块的ssl</span><br><span class="line">--user=nginx \  # 指明以那个身份运行worker进程，主控master进程一般由root运行</span><br><span class="line">--group=nginx \ # 组</span><br><span class="line">--with-http_ssl_module \ # 启用ssl</span><br><span class="line">--with-http_v2_module \ # 支持http2.0</span><br><span class="line">--with-http_dav_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--with-threads \</span><br><span class="line">--with-file-aio \   # 异步非阻塞</span><br></pre></td></tr></table></figure><h3 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 nginx-1.13.6]# cd /usr/local/nginx/sbin/</span><br><span class="line">[root@centos7 sbin]# ls</span><br><span class="line">nginx</span><br><span class="line">[root@centos7 sbin]# ./nginx        # 启动nginx，提示找不到目录</span><br><span class="line">nginx: [emerg] mkdir() &quot;/var/lib/nginx/tmp/proxy&quot; failed (2: No such file or directory)</span><br><span class="line">[root@centos7 sbin]# mkdir -p /var/lib/nginx/tmp/proxy  # 创建目录</span><br><span class="line">[root@centos7 sbin]# ./nginx        # 再次启动，还是提示缺少目录</span><br><span class="line">nginx: [emerg] mkdir() &quot;/var/cache/nginx/uwsgi_temp&quot; failed (2: No such file or directory)</span><br><span class="line">[root@centos7 sbin]# mkdir -p /var/cache/nginx/uwsgi_temp   # 创建目录</span><br><span class="line">[root@centos7 sbin]# ./nginx</span><br><span class="line">[root@centos7 sbin]# ss -tnul       # 80端口已经开启</span><br><span class="line">Netid State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">udp   UNCONN     0      0              ::1:323                         :::*                  </span><br><span class="line">udp   UNCONN     0      0               :::34463                       :::*                  </span><br><span class="line">tcp   LISTEN     0      128              *:80                           *:*                  </span><br><span class="line">tcp   LISTEN     0      128              *:22                           *:*                  </span><br><span class="line"></span><br><span class="line">[root@centos7 sbin]# curl -I localhost</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: HaiYunNginx/6.6.6           # 已经修改为我们想要的版本了，呵呵~~~</span><br><span class="line">Date: Sat, 28 Oct 2017 12:07:24 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Sat, 28 Oct 2017 12:01:53 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;59f471b1-264&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure><h3 id="查看已经编译模块"><a href="#查看已经编译模块" class="headerlink" title="查看已经编译模块"></a>查看已经编译模块</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 sbin]# ./nginx -V</span><br><span class="line">nginx version: HaiYunNginx/6.6.6</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-11) (GCC) </span><br><span class="line">built with OpenSSL 1.0.1e-fips 11 Feb 2013</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --pid-path=/run/nginx.pid --with-http_mp4_module --with-http_gunzip_module --http-scgi-temp-path=/var/cache/nginx/scgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --with-stream_ssl_module --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_dav_module --with-http_stub_status_module --with-threads --with-file-aio</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> Nginx编译安装 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx编译安装 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块  ngx_http_upstream_module</title>
      <link href="/2017/10/27/Nginx-ngx-http-upstream-module/"/>
      <url>/2017/10/27/Nginx-ngx-http-upstream-module/</url>
      <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>该<code>ngx_http_upstream_module</code>模块用于定义可由<code>proxy_pass</code>， <code>fastcgi_pass</code>， <code>uwsgi_pass</code>， <code>scgi_pass</code>和<code>memcached_pa​​ss</code>指令引用的服务器组。</p><p>用于将多个服务器定义成服务器组，而由<code>proxy_pass,fastcgi_pass</code>等指令进行引用</p><h3 id="upstream-name-…"><a href="#upstream-name-…" class="headerlink" title="upstream name { … }"></a>upstream name { … }</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:upstream name &#123; ... &#125;</span><br><span class="line">Default:—</span><br><span class="line">Context:http</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>定义一组服务器。服务器可以在不同端口上侦听。另外，监听<code>TCP</code>和<code>UNIX</code>域套接字的服务器可以混合使用。</p><p>定义后端服务器组，会引入一个新的上下文,默认调度算法是wrr</p><h3 id="server-address-parameters"><a href="#server-address-parameters" class="headerlink" title="server address [parameters];"></a>server address [parameters];</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:server address [parameters];</span><br><span class="line">Default:—</span><br><span class="line">Context:upstream</span><br></pre></td></tr></table></figure></p><p>定义 服务器<code>address</code>和其他<code>parameters</code>服务器。可以将该地址指定为具有可选端口的域名或IP地址，或者指定为“ <code>unix:</code>”前缀之后指定的<code>UNIX</code>域套接字路径。如果未指定端口，则使用端口80。解析为多个<code>IP</code>地址的域名一次定义多个服务器。</p><p>在<code>upstream</code>上下文中<code>server</code>成员，以及相关的参数； ·<code>Context:upstream address·</code>的表示格式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unix:/PATH/TO/SOME_SOCK_FILE</span><br><span class="line">IP[:PORT]</span><br><span class="line">HOSTNAME[:PORT]</span><br></pre></td></tr></table></figure></p><h4 id="parameters："><a href="#parameters：" class="headerlink" title="parameters："></a>parameters：</h4><ul><li><code>weight=number</code> 权重，默认为1</li><li><code>max_conns</code> 连接后端报务器最大并发活动连接数， 1.11.5后支持</li><li><code>max_fails=number</code> 失败尝试最大次数；超出此处指定的次数时， server将被标记为不可用,默认为<code>1</code></li><li><code>fail_timeout=time</code> 后端服务器标记为不可用状态的连接超时时长，默认<code>10s</code></li><li><code>backup</code> 将服务器标记为“备用”，即所有服务器均不可用时才启用</li><li><code>down</code> 标记为“不可用”，配合<code>ip_hash</code>使用，实现灰度发布</li></ul><h3 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash;"></a>ip_hash;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:ip_hash;</span><br><span class="line">Default:—</span><br><span class="line">Context:upstream</span><br></pre></td></tr></table></figure></p><p>指定组应该使用根据客户端IP地址在服务器之间分配请求的负载平衡方法。客户端<code>IPv4</code>地址或整个<code>IPv6</code>地址的前三个八位字节被用作散列密钥。该方法确保来自同一客户端的请求将始终传递到同一服务器，除非此服务器不可用。在后一种情况下，客户端请求将被传递到另一个服务器。很可能，它将始终是同一台服务器。</p><p>源地址hash调度方法</p><h3 id="least-conn"><a href="#least-conn" class="headerlink" title="least_conn;"></a>least_conn;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:least_conn;</span><br><span class="line">Default:—</span><br><span class="line">Context:upstream</span><br><span class="line">This directive appeared in versions 1.3.1 and 1.2.2.</span><br></pre></td></tr></table></figure></p><p>指定一个组应该使用负载平衡方法，其中请求被传递到具有最少数量的活动连接的服务器，同时考虑服务器的权重。如果有几个这样的服务器，则依次使用加权循环平衡方法。</p><p>最少连接调度算法，当<code>server</code>拥有不同的权重时其为<code>wlc</code>，当所有后端主机连接数相同时，则使用<code>wrr</code>，适用于长连接</p><h3 id="hash-key-consistent"><a href="#hash-key-consistent" class="headerlink" title="hash key [consistent];"></a>hash key [consistent];</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:hash key [consistent];</span><br><span class="line">Default:—</span><br><span class="line">Context:upstream</span><br><span class="line">This directive appeared in version 1.7.2.</span><br></pre></td></tr></table></figure></p><p>基于指定的<code>key</code>的<code>hash</code>表来实现对请求的调度，此处的<code>key</code>可以直接文本、变量或二者组合</p><p>作用：将请求分类，同一类请求将发往同一个<code>upstream server</code>，使用<code>consistent</code>参数，将使用<code>ketama</code>一致性<code>hash</code>算法，适用于后端是<code>Cache</code>服务器（如<code>varnish</code>）时使用</p><ul><li><code>hash $request_uri consistent;</code></li><li><code>hash $remote_addr;</code></li></ul><h3 id="keepalive-连接数N"><a href="#keepalive-连接数N" class="headerlink" title="keepalive 连接数N;"></a>keepalive 连接数N;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:keepalive connections;</span><br><span class="line">Default:—</span><br><span class="line">Context:upstream</span><br></pre></td></tr></table></figure></p><p>为每个<code>worker</code>进程保留的空闲的长连接数量,可节约<code>nginx</code>端口，并减少连接管理的消耗</p><h3 id="health-check-parameters"><a href="#health-check-parameters" class="headerlink" title="health_check [parameters];"></a>health_check [parameters];</h3><ul><li><code>health_check [parameters];</code></li><li>健康状态检测机制；只能用于location上下文</li></ul><p>常用参数：</p><ul><li><code>interval=time</code>检测的频率，默认为5秒</li><li><code>fails=number</code>：判定服务器不可用的失败检测次数；默认为1次</li><li><code>passes=number</code>：判定服务器可用的失败检测次数；默认为1次</li><li><code>uri=uri</code>：做健康状态检测测试的目标<code>uri</code>；默认为/</li><li><code>match=NAME</code>：健康状态检测的结果评估调用此处指定的<code>match</code>配置块注意：仅对<code>nginx plus</code>有效</li></ul><p><strong>注意：此项仅对商业版nginx有效</strong></p><h3 id="match-name-…"><a href="#match-name-…" class="headerlink" title="match name { … }"></a>match name { … }</h3><p>对<code>backend server</code>做健康状态检测时，定义其结果判断机制；只能用于<code>http</code>上下文</p><p>常用的参数：</p><ul><li><code>status code[ code ...]</code>: 期望的响应状态码</li><li><code>header HEADER[operator value]</code>：期望存在响应首部，也可对期望的响应首部的值基于比较操作符和值进行比较<code>body</code>：期望响应报文的主体部分应该有的内容</li></ul><p><strong>注意：此项仅对商业版nginx有效</strong></p><h3 id="实现upstream"><a href="#实现upstream" class="headerlink" title="实现upstream"></a>实现upstream</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/nginx.conf        # 修改主配置文件</span><br><span class="line">upstream web &#123;          #定义一个网络组，名称为web，网络组定义了两台server，分别为192.168.8.128和192.168.8.138</span><br><span class="line">        server 192.168.8.128:80 weight=1 ;</span><br><span class="line">        server 192.168.8.138:80 weight=2 ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/conf.d/vhost.conf     # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ; </span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    </span><br><span class="line">        location / &#123; </span><br><span class="line">            proxy_pass http://web;              # 定义访问本地的web根目录就代理到网络组web</span><br><span class="line">        &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s reload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 第一台server的配置</span><br><span class="line">[root@138 ~]# ifconfig ens34</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.138  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:2438  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 76396  bytes 13285907 (12.6 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 74734  bytes 17770296 (16.9 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@138 ~]# yum install -y httpd</span><br><span class="line">[root@fast-cgi ~]# echo &quot;192.168.8.138&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@138 ~]# systemctl start httpd</span><br><span class="line">[root@138 ~]# ss -tnul          # 80端口已经打开</span><br><span class="line">Netid State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line"></span><br><span class="line">tcp   LISTEN     0      128              *:9000                         *:*                  </span><br><span class="line">tcp   LISTEN     0      128             :::80                          :::*                  </span><br><span class="line">tcp   LISTEN     0      128             :::22                          :::*                  </span><br><span class="line">tcp   LISTEN     0      100            ::1:25                          :::*      </span><br><span class="line">[root@138 ~]# curl 192.168.8.138        # 本地测试可以访问</span><br><span class="line">192.168.8.138</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 第二台server的配置</span><br><span class="line">[root@128 ~]# ifconfig eth1</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:DE:D2:8C  </span><br><span class="line">          inet addr:192.168.8.128  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fede:d28c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:5031 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:4554 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:843593 (823.8 KiB)  TX bytes:1662926 (1.5 MiB)</span><br><span class="line">[root@128 ~]# yum install -y httpd</span><br><span class="line">[root@128 ~]# echo &quot;192.168.8.128&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@128 ~]# service httpd start</span><br><span class="line">Starting httpd:                             [  OK  ]</span><br><span class="line">[root@128 ~]# ss -tnul      # 80端口已经打开</span><br><span class="line">Netid State      Recv-Q Send-Q            Local Address:Port              Peer Address:Port </span><br><span class="line">udp   UNCONN     0      0                             *:68                           *:*     </span><br><span class="line">tcp   LISTEN     0      50                            *:3306                         *:*     </span><br><span class="line">tcp   LISTEN     0      128                          :::80                          :::*     </span><br><span class="line">tcp   LISTEN     0      128                          :::22                          :::*     </span><br><span class="line">tcp   LISTEN     0      128                           *:22                           *:*     </span><br><span class="line">tcp   LISTEN     0      100                         ::1:25                          :::*     </span><br><span class="line">tcp   LISTEN     0      100                   127.0.0.1:25                           *:*   </span><br><span class="line">[root@128 ~]# curl 192.168.8.128        # 本地测试可以访问</span><br><span class="line">192.168.8.128</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# for i in &#123;1..10&#125; ; do curl 192.168.8.140 ; done       #访问测试，ok</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br></pre></td></tr></table></figure><h3 id="实现upstream，定义Nginx为sorry-server"><a href="#实现upstream，定义Nginx为sorry-server" class="headerlink" title="实现upstream，定义Nginx为sorry server"></a>实现upstream，定义Nginx为sorry server</h3><p>我们还是接着上面的实验来做</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改nginx的主配置文件</span><br><span class="line">http &#123;</span><br><span class="line">upstream web &#123;</span><br><span class="line">        server 192.168.8.128:80 weight=1 ;</span><br><span class="line">        server 192.168.8.138:80 weight=2 ;</span><br><span class="line">        server 127.0.0.1:81 backup ;        # 定义本地服务器81端口为backup服务器，相当于sorry server</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# echo &quot;Soryy! 我们的服务器宕机了！正在抢修中...&quot; &gt; /app/website2/index.html        #修改默认页面的内容</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/conf.d/vhost.conf     # 修改配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ; </span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    </span><br><span class="line">        location / &#123; </span><br><span class="line">            proxy_pass http://web; </span><br><span class="line">        &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 81 ;</span><br><span class="line">    server_name www.b.com ; </span><br><span class="line">    root /app/website2 ;</span><br><span class="line">    error_log /var/log/nginx/b.com.error.log  ;   </span><br><span class="line">    access_log /var/log/nginx/b.com.access.log main ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -t </span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@centos7 ~]# nginx -s reload</span><br><span class="line"></span><br><span class="line">[root@138 ~]# systemctl stop httpd      # 停止138的httpd服务</span><br><span class="line">[root@128 ~]# service httpd stop        # 停止128的httpd服务</span><br><span class="line">Stopping httpd:                                            [  OK  ]</span><br><span class="line">[root@centos7 ~]# curl 192.168.8.140        #访问测试，ok</span><br><span class="line">Soryy! 我们的服务器宕机了！正在抢修中...</span><br><span class="line"></span><br><span class="line">[root@138 ~]# systemctl start httpd         # 启动138的httpd服务</span><br><span class="line">[root@128 ~]# service httpd start       # 启动128的httpd服务</span><br><span class="line">Starting httpd:                             [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# for i in &#123;1..10&#125; ; do curl 192.168.8.140 ; done       # 访问测试，一切正常</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br></pre></td></tr></table></figure><h3 id="实现ip-hash，针对源地址永久调度到一台后部web-server"><a href="#实现ip-hash，针对源地址永久调度到一台后部web-server" class="headerlink" title="实现ip_hash，针对源地址永久调度到一台后部web server"></a>实现ip_hash，针对源地址永久调度到一台后部web server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">http &#123;</span><br><span class="line">upstream web &#123;</span><br><span class="line">        server 192.168.8.128:80 weight=1 ;</span><br><span class="line">        server 192.168.8.138:80 weight=2 ;</span><br><span class="line">        server 127.0.0.1:81 backup ;</span><br><span class="line">        ip_hash ;           # 添加ip_hash</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@centos7 ~]# nginx -s reload</span><br><span class="line">[root@centos7 ~]# for i in &#123;1..10&#125; ; do curl 192.168.8.140 ; done           # 测试，都调度到一台web server了</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br></pre></td></tr></table></figure><h3 id="实现least-conn，根据服务器的真实负载来调度"><a href="#实现least-conn，根据服务器的真实负载来调度" class="headerlink" title="实现least_conn，根据服务器的真实负载来调度"></a>实现least_conn，根据服务器的真实负载来调度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">http &#123;</span><br><span class="line">upstream web &#123;</span><br><span class="line">        server 192.168.8.128:80 weight=1 ;</span><br><span class="line">        server 192.168.8.138:80 weight=2 ;</span><br><span class="line">        server 127.0.0.1:81 backup ;</span><br><span class="line">        least_conn ;            # 添加least_conn</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -s reload</span><br><span class="line">[root@centos7 ~]# for i in &#123;1..10&#125; ; do curl 192.168.8.140 ; done           # 访问测试，ok</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br></pre></td></tr></table></figure><h3 id="实现hash根据用户的URI来调度"><a href="#实现hash根据用户的URI来调度" class="headerlink" title="实现hash根据用户的URI来调度"></a>实现hash根据用户的URI来调度</h3><p>此项可以配合缓存服务器来使用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">http &#123;</span><br><span class="line">upstream web &#123;</span><br><span class="line">        server 192.168.8.128:80 weight=1 ;</span><br><span class="line">        server 192.168.8.138:80 weight=2 ;</span><br><span class="line">        server 127.0.0.1:81 backup ;</span><br><span class="line">        hash  $request_uri ;            # 添加hash key基于URI</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -s reload</span><br><span class="line"></span><br><span class="line">[root@138 ~]# for i in &#123;1..5&#125; ; do echo &quot;$i.html 193.168.8.138&quot; &gt; /var/www/html/$i.html  ; done     # 在138上面创建5个测试页面</span><br><span class="line">[root@138 ~]# ls /var/www/html/</span><br><span class="line">1.html  2.html  3.html  4.html  5.html  blog  index.html</span><br><span class="line">[root@138 ~]# cat /var/www/html/1.html </span><br><span class="line">1.html 193.168.8.138</span><br><span class="line"></span><br><span class="line">[root@128 ~]# for i in &#123;1..5&#125; ; do echo &quot;$i.html 193.168.8.128&quot; &gt; /var/www/html/$i.html  ; done     # 在128上面创建5个测试页面</span><br><span class="line">[root@128 ~]# ls /var/www/html/</span><br><span class="line">1.html  2.html  3.html  4.html  5.html  index.html</span><br><span class="line">[root@128 ~]# cat /var/www/html/1.html </span><br><span class="line">1.html 193.168.8.128</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# for i in &#123;1..5&#125; ; do curl 192.168.8.140/1.html ; done     # 测试访问，1.html都已经调度到128这台server</span><br><span class="line">1.html 193.168.8.128</span><br><span class="line">1.html 193.168.8.128</span><br><span class="line">1.html 193.168.8.128</span><br><span class="line">1.html 193.168.8.128</span><br><span class="line">1.html 193.168.8.128</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# for i in &#123;1..5&#125; ; do curl 192.168.8.140/3.html ; done     # 测试访问，3.html都已经调度到138这台server</span><br><span class="line">3.html 193.168.8.138</span><br><span class="line">3.html 193.168.8.138</span><br><span class="line">3.html 193.168.8.138</span><br><span class="line">3.html 193.168.8.138</span><br><span class="line">3.html 193.168.8.138</span><br></pre></td></tr></table></figure></p><h3 id="一致性hash算法"><a href="#一致性hash算法" class="headerlink" title="一致性hash算法"></a>一致性hash算法</h3><p>作用：一致性hash算法（<code>DHT</code>）通过减少影响范围的方式解决了增减服务器导致的数据散列问题，从而解决了分布式环境下负载均衡问题，如果存在热点数据，那么通过增添节点的方式，对热点区间进行划分，将压力分配至其他服务器。重新达到负载均衡的状态。  </p><p>一致性哈希基本解决了在<code>P2P</code>环境中最为关键的问题——如何在动态的网络拓扑中分布存储和路由。每个节点仅需维护少量相邻节点的信息，并且在节点加入/退出系统时，仅有相关的少量节点参与到拓扑的维护中。所有这一切使得一致性哈希成为第一个实用的<code>DHT</code>算法。</p>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块  ngx_http_upstream_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块  ngx_http_upstream_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>LNAMP搭建WordPress</title>
      <link href="/2017/10/27/Nginx-LNAMP/"/>
      <url>/2017/10/27/Nginx-LNAMP/</url>
      <content type="html"><![CDATA[<h3 id="使用nginx-php-fpm-mariadb-apache-搭建wordpress"><a href="#使用nginx-php-fpm-mariadb-apache-搭建wordpress" class="headerlink" title="使用nginx+ php-fpm + mariadb + apache 搭建wordpress"></a>使用nginx+ php-fpm + mariadb + apache 搭建wordpress</h3><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><center><img src="https://houhaiyun.github.io/img/images/Nginx-LNAMP-1.jpg" title="拓扑图"></center><a id="more"></a><table><thead><tr><th>服务</th><th>IP</th><th>功能</th></tr></thead><tbody><tr><td>Nginx</td><td>192.168.8.140</td><td>反向代理</td></tr><tr><td>Apache</td><td>192.168.8.138</td><td>web服务</td></tr><tr><td>Mysql</td><td>192.168.8.128</td><td>存储数据</td></tr><tr><td>Php-fpm</td><td>192.168.8.138</td><td>解析php文件</td></tr></tbody></table><h4 id="安装配置数据库服务器"><a href="#安装配置数据库服务器" class="headerlink" title="安装配置数据库服务器"></a>安装配置数据库服务器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@Mysql ~]# yum -y  install mysql-server        # 安装mysql数据库</span><br><span class="line">[root@Mysql ~]# service mysqld start        # 启动mysql数据库</span><br><span class="line">Initializing MySQL database:  Installing MySQL system tables...</span><br><span class="line">OK</span><br><span class="line">Filling help tables...</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">To start mysqld at boot time you have to copy</span><br><span class="line">support-files/mysql.server to the right place for your system</span><br><span class="line"></span><br><span class="line">PLEASE REMEMBER TO SET A PASSWORD FOR THE MySQL root USER !</span><br><span class="line">To do so, start the server, then issue the following commands:</span><br><span class="line"></span><br><span class="line">/usr/bin/mysqladmin -u root password &apos;new-password&apos;</span><br><span class="line">/usr/bin/mysqladmin -u root -h Mysql password &apos;new-password&apos;</span><br><span class="line"></span><br><span class="line">Alternatively you can run:</span><br><span class="line">/usr/bin/mysql_secure_installation</span><br><span class="line"></span><br><span class="line">which will also give you the option of removing the test</span><br><span class="line">databases and anonymous user created by default.  This is</span><br><span class="line">strongly recommended for production servers.</span><br><span class="line"></span><br><span class="line">See the manual for more instructions.</span><br><span class="line"></span><br><span class="line">You can start the MySQL daemon with:</span><br><span class="line">cd /usr ; /usr/bin/mysqld_safe &amp;</span><br><span class="line"></span><br><span class="line">You can test the MySQL daemon with mysql-test-run.pl</span><br><span class="line">cd /usr/mysql-test ; perl mysql-test-run.pl</span><br><span class="line"></span><br><span class="line">Please report any problems with the /usr/bin/mysqlbug script!</span><br><span class="line"></span><br><span class="line">                                                           [  OK  ]</span><br><span class="line">Starting mysqld:                                           [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@Mysql ~]# mysql</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 2</span><br><span class="line">Server version: 5.1.73 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE DATABASE wpdb;        # 为wordpress创建数据库</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">mysql&gt; GRANT ALL ON  wpdb.* TO wpuser@&apos;192.168.8.%&apos; IDENTIFIED BY &apos;centos&apos;;     # 为wordpress创建用户并授权</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">mysql&gt; SHOW DATABASES;      # 查看数据库</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| test               |</span><br><span class="line">| wpdb               |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="配置php服务器"><a href="#配置php服务器" class="headerlink" title="配置php服务器"></a>配置php服务器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@fast-cgi ~]# vim /etc/php-fpm.d/www.conf      # 修改php配置文件</span><br><span class="line">listen = 9000       # 指定监听所有IP的9000端口</span><br><span class="line">listen.allowed_clients = 127.0.0.1,192.168.8.140    # 允许192.168.8.140使用php</span><br><span class="line"># 注意：上面两项在本实验中并不是必须的。如果apache和php-fpm不再同一台服务器上面就需要配置了。</span><br></pre></td></tr></table></figure><h3 id="安装配置Apache服务器"><a href="#安装配置Apache服务器" class="headerlink" title="安装配置Apache服务器"></a>安装配置Apache服务器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@fast-cgi ~]# yum install -y httpd</span><br><span class="line">[root@fast-cgi ~]# systemctl start httpd</span><br><span class="line">[root@fast-cgi ~]# vim /etc/httpd/conf/httpd.conf       # 修改主配置文件添加以下行</span><br><span class="line">DirectoryIndex index.php</span><br><span class="line">ProxyRequests Off </span><br><span class="line">ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/var/www/html/$1</span><br></pre></td></tr></table></figure><h3 id="测试链接数据库"><a href="#测试链接数据库" class="headerlink" title="测试链接数据库"></a>测试链接数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@fast-cgi php]# yum install -y php-mysql</span><br><span class="line">[root@fast-cgi php]# systemctl restart php-fpm</span><br><span class="line">[root@fast-cgi php]# cat mysql.php </span><br><span class="line">&lt;?php</span><br><span class="line">$mysqli=new mysqli(&quot;192.168.8.128&quot;,&quot;wpuser&quot;,&quot;centos&quot;);</span><br><span class="line">if(mysqli_connect_errno())&#123;</span><br><span class="line">echo &quot;no&quot;;</span><br><span class="line">$mysqli=null;</span><br><span class="line">exit;</span><br><span class="line">&#125;</span><br><span class="line">echo &quot;OK! &quot;;</span><br><span class="line">$mysqli-&gt;close();</span><br><span class="line">?&gt;</span><br><span class="line">[root@fast-cgi ~]# curl 192.168.8.140/mysql.php         # 测试连接，ok</span><br><span class="line">OK!</span><br></pre></td></tr></table></figure><h3 id="下载并配置wordpress"><a href="#下载并配置wordpress" class="headerlink" title="下载并配置wordpress"></a>下载并配置wordpress</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@fast-cgi ~]# wget https://cn.wordpress.org/wordpress-4.8.1-zh_CN.tar.gz</span><br><span class="line">--2017-10-27 20:04:06--  https://cn.wordpress.org/wordpress-4.8.1-zh_CN.tar.gz</span><br><span class="line">Resolving cn.wordpress.org (cn.wordpress.org)... 66.155.40.250, 66.155.40.249</span><br><span class="line">Connecting to cn.wordpress.org (cn.wordpress.org)|66.155.40.250|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 8641990 (8.2M) [application/octet-stream]</span><br><span class="line">Saving to: ‘wordpress-4.8.1-zh_CN.tar.gz’</span><br><span class="line"></span><br><span class="line">100%[===================================================&gt;] 8,641,990   3.09MB/s   in 2.7s   </span><br><span class="line"></span><br><span class="line">2017-10-27 20:04:10 (3.09 MB/s) - ‘wordpress-4.8.1-zh_CN.tar.gz’ saved [8641990/8641990]</span><br><span class="line"></span><br><span class="line">[root@fast-cgi ~]# tar -xf wordpress-4.8.1-zh_CN.tar.gz -C /var/www/html/</span><br><span class="line">[root@fast-cgi ~]# cd /var/www/html/</span><br><span class="line">[root@fast-cgi html]# ls</span><br><span class="line">wordpress</span><br><span class="line">[root@fast-cgi html]# mv wordpress/ blog</span><br><span class="line">[root@fast-cgi html]# ls</span><br><span class="line">blog</span><br><span class="line">[root@fast-cgi blog]# mv wp-config-sample.php wp-config.php</span><br><span class="line">[root@fast-cgi blog]# vim  wp-config.php      # 修改wordpress配置文件</span><br><span class="line">define(&apos;DB_NAME&apos;, &apos;wpdb&apos;);</span><br><span class="line"></span><br><span class="line">/** MySQL数据库用户名 */</span><br><span class="line">define(&apos;DB_USER&apos;, &apos;wpuser&apos;);</span><br><span class="line"></span><br><span class="line">/** MySQL数据库密码 */</span><br><span class="line">define(&apos;DB_PASSWORD&apos;, &apos;centos&apos;);</span><br><span class="line"></span><br><span class="line">/** MySQL主机 */</span><br><span class="line">define(&apos;DB_HOST&apos;, &apos;192.168.8.128&apos;);</span><br><span class="line"></span><br><span class="line">/** 创建数据表时默认的文字编码 */</span><br><span class="line">define(&apos;DB_CHARSET&apos;, &apos;utf8&apos;);</span><br><span class="line"></span><br><span class="line">/** 数据库整理类型。如不确定请勿更改 */</span><br><span class="line">define(&apos;DB_COLLATE&apos;, &apos;&apos;);</span><br></pre></td></tr></table></figure><h3 id="Nginx代理服务器配置"><a href="#Nginx代理服务器配置" class="headerlink" title="Nginx代理服务器配置"></a>Nginx代理服务器配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# yum install -y nginx      # 安装nginx服务</span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改代理服务器的配置</span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ; </span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    location /blog  &#123;       # 定义只要访问/blog目录就跳转到http://192.168.8.138/blog目录</span><br><span class="line">        proxy_pass http://192.168.8.138 ;       </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br></pre></td></tr></table></figure><h3 id="测试访问"><a href="#测试访问" class="headerlink" title="测试访问"></a>测试访问</h3><p>搞定！</p><center><img src="https://houhaiyun.github.io/img/images/Nginx-LNAMP-2.gif" title="测试访问"></center>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> LNAMP搭建WordPress </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LNAMP搭建WordPress </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块 ngx_http_fastcgi_module</title>
      <link href="/2017/10/27/Nginx-ngx-http-fastcgi-module/"/>
      <url>/2017/10/27/Nginx-ngx-http-fastcgi-module/</url>
      <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>该<code>ngx_http_fastcgi_module</code>模块允许将请求传递给<code>FastCGI</code>服务器。</p><h3 id="fastcgi-pass-address"><a href="#fastcgi-pass-address" class="headerlink" title="fastcgi_pass address;"></a>fastcgi_pass address;</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:fastcgi_pass address;</span><br><span class="line">Default:—</span><br><span class="line">Context:location, if in location</span><br></pre></td></tr></table></figure></p><p>设置<code>FastCGI</code>服务器的地址。地址可以指定为域名或<code>IP</code>地址，端口号：</p><a id="more"></a><h3 id="fastcgi-index-name"><a href="#fastcgi-index-name" class="headerlink" title="fastcgi_index name;"></a>fastcgi_index name;</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:fastcgi_index name;</span><br><span class="line">Default:—</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p><code>fastcgi</code>默认的主页资源</p><p>例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_index index.php;</span><br><span class="line">fastcgi_param SCRIPT_FILENAME /home/www/scripts/php$fastcgi_script_name;</span><br></pre></td></tr></table></figure><p>和“ /page.php”请求，SCRIPT_FILENAME参数将等于“ /home/www/scripts/php/page.php”，并且“ /”请求将等于“ /home/www/scripts/php/index.php”。</p><h3 id="fastcgi-param-parameter-value-if-not-empty"><a href="#fastcgi-param-parameter-value-if-not-empty" class="headerlink" title="fastcgi_param parameter value [if_not_empty];"></a>fastcgi_param parameter value [if_not_empty];</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:fastcgi_param parameter value [if_not_empty];</span><br><span class="line">Default:—</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>设置传递给 <code>FastCGI</code>服务器的参数值，可以是文本，变量或组合</p><p>以下示例显示了PHP的最低要求设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_param SCRIPT_FILENAME / home / www / scripts / php $ fastcgi_script_name; </span><br><span class="line">fastcgi_param QUERY_STRING $ query_string;</span><br></pre></td></tr></table></figure></p><h3 id="实现fast-cgi"><a href="#实现fast-cgi" class="headerlink" title="实现fast-cgi"></a>实现fast-cgi</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@fast-cgi ~]# yum -y install php php-fpm mariadb-server</span><br><span class="line"></span><br><span class="line">[root@fast-cgi ~]# vim /etc/php-fpm.d/www.conf          #修改fast-cgi配置文件</span><br><span class="line">listen = 9000           # 监听所有IP的9000端口</span><br><span class="line">listen.allowed_clients = 127.0.0.1,192.168.8.140        # 允许192.168.8.140控制fast-cgi</span><br><span class="line"></span><br><span class="line">[root@fast-cgi ~]# systemctl start php-fpm          # 启动php-fpm程序</span><br><span class="line">[root@fast-cgi ~]# mkdir /app/php</span><br><span class="line">[root@fast-cgi ~]# vim /app/php/test.php        # 编写php测试页</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改代理服务器的配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ; </span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 192.168.8.138:9000;        # 定义处理.php结尾的服务器</span><br><span class="line">        fastcgi_index index.php ;           # 默认fastcgi的默认主页资源</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME /app/php$fastcgi_script_name;     # /app/php代表fastcgi服务器php网页的根目录</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    proxy_cache proxycache ; </span><br><span class="line">    proxy_cache_key $request_uri ;</span><br><span class="line">    proxy_cache_valid 200 302 301 1h ;</span><br><span class="line">    proxy_cache_valid any 1m ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br></pre></td></tr></table></figure><p>测试访问，ok</p><center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-fastcgi-module-1.gif" title="测试访问"></center><h3 id="通过-pm-status和-ping来获取fpm-server状态信息"><a href="#通过-pm-status和-ping来获取fpm-server状态信息" class="headerlink" title="通过/pm_status和/ping来获取fpm server状态信息"></a>通过/pm_status和/ping来获取fpm server状态信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">[root@fast-cgi ~]# vim /etc/php-fpm.d/www.conf          # 修改fast-cgi的配置文件</span><br><span class="line">ping.path = /ping       # 开启ping</span><br><span class="line">pm.status_path = /status    # 开启status</span><br><span class="line">[root@fast-cgi ~]# systemctl restart php-fpm</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改nginx代理服务器的配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ; </span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 192.168.8.138:9000;</span><br><span class="line">        fastcgi_index index.php ;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME /app/php$fastcgi_script_name;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">    &#125;   </span><br><span class="line">    location ~* ^/(status|ping)$ &#123;          # 定义如果访问stats和ping目录就转发到php来处理</span><br><span class="line">        fastcgi_pass 192.168.8.138:9000;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $fastcgi_script_name ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@CLIENT ~]# curl 192.168.8.140/status      # 测试状态</span><br><span class="line">pool:                 www</span><br><span class="line">process manager:      dynamic</span><br><span class="line">start time:           27/Oct/2017:19:12:38 +0800</span><br><span class="line">start since:          258</span><br><span class="line">accepted conn:        4</span><br><span class="line">listen queue:         0</span><br><span class="line">max listen queue:     0</span><br><span class="line">listen queue len:     128</span><br><span class="line">idle processes:       4</span><br><span class="line">active processes:     1</span><br><span class="line">total processes:      5</span><br><span class="line">max active processes: 1</span><br><span class="line">max children reached: 0</span><br><span class="line">slow requests:        0</span><br><span class="line"></span><br><span class="line">[root@CLIENT ~]# curl 192.168.8.140/ping        # 测试ping，ok</span><br><span class="line">pong</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@CLIENT ~]# curl http://192.168.8.140/status?xml       # 测试status，以xml格式显示</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;status&gt;</span><br><span class="line">&lt;pool&gt;www&lt;/pool&gt;</span><br><span class="line">&lt;process-manager&gt;dynamic&lt;/process-manager&gt;</span><br><span class="line">&lt;start-time&gt;1509102758&lt;/start-time&gt;</span><br><span class="line">&lt;start-since&gt;476&lt;/start-since&gt;</span><br><span class="line">&lt;accepted-conn&gt;12344&lt;/accepted-conn&gt;</span><br><span class="line">&lt;listen-queue&gt;0&lt;/listen-queue&gt;</span><br><span class="line">&lt;max-listen-queue&gt;124&lt;/max-listen-queue&gt;</span><br><span class="line">&lt;listen-queue-len&gt;128&lt;/listen-queue-len&gt;</span><br><span class="line">&lt;idle-processes&gt;7&lt;/idle-processes&gt;</span><br><span class="line">&lt;active-processes&gt;1&lt;/active-processes&gt;</span><br><span class="line">&lt;total-processes&gt;8&lt;/total-processes&gt;</span><br><span class="line">&lt;max-active-processes&gt;8&lt;/max-active-processes&gt;</span><br><span class="line">&lt;max-children-reached&gt;0&lt;/max-children-reached&gt;</span><br><span class="line">&lt;slow-requests&gt;0&lt;/slow-requests&gt;</span><br><span class="line">&lt;/status&gt;</span><br><span class="line"></span><br><span class="line">[root@CLIENT ~]# curl http://192.168.8.140/status?json      # 以json格式显示</span><br><span class="line">&#123;&quot;pool&quot;:&quot;www&quot;,&quot;process manager&quot;:&quot;dynamic&quot;,&quot;start time&quot;:1509102758,&quot;start since&quot;:508,&quot;accepted conn&quot;:12346,&quot;listen queue&quot;:0,&quot;max listen queue&quot;:124,&quot;listen queue len&quot;:128,&quot;idle processes&quot;:7,&quot;active processes&quot;:1,&quot;total processes&quot;:8,&quot;max active processes&quot;:8,&quot;max children reached&quot;:0,&quot;slow requests&quot;:0&#125;</span><br><span class="line"></span><br><span class="line">[root@CLIENT ~]# curl http://192.168.8.140/status?full          # 完整格式显示</span><br><span class="line">pool:                 www</span><br><span class="line">process manager:      dynamic</span><br><span class="line">start time:           27/Oct/2017:19:12:38 +0800</span><br><span class="line">start since:          576</span><br><span class="line">accepted conn:        12347</span><br><span class="line">listen queue:         0</span><br><span class="line">max listen queue:     124</span><br><span class="line">listen queue len:     128</span><br><span class="line">idle processes:       7</span><br><span class="line">active processes:     1</span><br><span class="line">total processes:      8</span><br><span class="line">max active processes: 8</span><br><span class="line">max children reached: 0</span><br><span class="line">slow requests:        0</span><br><span class="line"></span><br><span class="line">************************</span><br><span class="line">pid:                  19275</span><br><span class="line">state:                Running</span><br><span class="line">start time:           27/Oct/2017:19:12:38 +0800</span><br><span class="line">start since:          576</span><br><span class="line">requests:             1925</span><br><span class="line">request duration:     175</span><br><span class="line">request method:       GET</span><br><span class="line">request URI:          /status?full</span><br><span class="line">content length:       0</span><br><span class="line">user:                 -</span><br><span class="line">script:               -</span><br><span class="line">last request cpu:     0.00</span><br><span class="line">last request memory:  0</span><br><span class="line"></span><br><span class="line">************************</span><br><span class="line">pid:                  19276</span><br><span class="line">state:                Idle</span><br><span class="line">start time:           27/Oct/2017:19:12:38 +0800</span><br><span class="line">start since:          576</span><br><span class="line">requests:             1667</span><br><span class="line">request duration:     109</span><br><span class="line">request method:       GET</span><br><span class="line">request URI:          /status</span><br><span class="line">content length:       0</span><br><span class="line">user:                 -</span><br><span class="line">script:               -</span><br><span class="line">last request cpu:     0.00</span><br><span class="line">last request memory:  262144</span><br><span class="line"></span><br><span class="line">************************</span><br><span class="line">pid:                  19277</span><br><span class="line">state:                Idle</span><br><span class="line">start time:           27/Oct/2017:19:12:38 +0800</span><br><span class="line">start since:          576</span><br><span class="line">requests:             1748</span><br><span class="line">request duration:     188</span><br><span class="line">request method:       GET</span><br><span class="line">request URI:          /status?php</span><br><span class="line">content length:       0</span><br><span class="line">user:                 -</span><br><span class="line">script:               -</span><br><span class="line">last request cpu:     0.00</span><br><span class="line">last request memory:  262144</span><br><span class="line"></span><br><span class="line">************************</span><br><span class="line">pid:                  19278</span><br><span class="line">state:                Idle</span><br><span class="line">start time:           27/Oct/2017:19:12:38 +0800</span><br><span class="line">start since:          576</span><br><span class="line">requests:             2057</span><br><span class="line">request duration:     268</span><br><span class="line">request method:       GET</span><br><span class="line">request URI:          /status?xml</span><br><span class="line">content length:       0</span><br><span class="line">user:                 -</span><br><span class="line">script:               -</span><br><span class="line">last request cpu:     0.00</span><br><span class="line">last request memory:  262144</span><br><span class="line"></span><br><span class="line">************************</span><br><span class="line">pid:                  19279</span><br><span class="line">state:                Idle</span><br><span class="line">start time:           27/Oct/2017:19:12:38 +0800</span><br><span class="line">start since:          576</span><br><span class="line">requests:             2157</span><br><span class="line">request duration:     173</span><br><span class="line">request method:       GET</span><br><span class="line">request URI:          /status?json</span><br><span class="line">content length:       0</span><br><span class="line">user:                 -</span><br><span class="line">script:               -</span><br><span class="line">last request cpu:     0.00</span><br><span class="line">last request memory:  262144</span><br><span class="line"></span><br><span class="line">************************</span><br><span class="line">pid:                  19281</span><br><span class="line">state:                Idle</span><br><span class="line">start time:           27/Oct/2017:19:18:50 +0800</span><br><span class="line">start since:          204</span><br><span class="line">requests:             1717</span><br><span class="line">request duration:     139</span><br><span class="line">request method:       GET</span><br><span class="line">request URI:          /status</span><br><span class="line">content length:       0</span><br><span class="line">user:                 -</span><br><span class="line">script:               -</span><br><span class="line">last request cpu:     0.00</span><br><span class="line">last request memory:  262144</span><br><span class="line"></span><br><span class="line">************************</span><br><span class="line">pid:                  19282</span><br><span class="line">state:                Idle</span><br><span class="line">start time:           27/Oct/2017:19:19:01 +0800</span><br><span class="line">start since:          193</span><br><span class="line">requests:             678</span><br><span class="line">request duration:     737</span><br><span class="line">request method:       GET</span><br><span class="line">request URI:          /status</span><br><span class="line">content length:       0</span><br><span class="line">user:                 -</span><br><span class="line">script:               -</span><br><span class="line">last request cpu:     0.00</span><br><span class="line">last request memory:  262144</span><br><span class="line"></span><br><span class="line">************************</span><br><span class="line">pid:                  19283</span><br><span class="line">state:                Idle</span><br><span class="line">start time:           27/Oct/2017:19:19:07 +0800</span><br><span class="line">start since:          187</span><br><span class="line">requests:             398</span><br><span class="line">request duration:     320</span><br><span class="line">request method:       GET</span><br><span class="line">request URI:          /status</span><br><span class="line">content length:       0</span><br><span class="line">user:                 -</span><br><span class="line">script:               -</span><br><span class="line">last request cpu:     0.00</span><br><span class="line">last request memory:  262144</span><br></pre></td></tr></table></figure><h3 id="fastcgi-cache-path-path…"><a href="#fastcgi-cache-path-path…" class="headerlink" title="fastcgi_cache_path path…;"></a>fastcgi_cache_path path…;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:fastcgi_cache_path path [levels=levels] [use_temp_path=on|off] keys_zone=name:size [inactive=time] [max_size=size] [manager_files=number] [manager_sleep=time] [manager_threshold=time] [loader_files=number] [loader_sleep=time] [loader_threshold=time] [purger=on|off] [purger_files=number] [purger_sleep=time] [purger_threshold=time];</span><br><span class="line">Default:—</span><br><span class="line">Context:http</span><br></pre></td></tr></table></figure></p><p>定义<code>fastcgi</code>的缓存；</p><ul><li><code>path</code> 缓存位置为磁盘上的文件系统</li><li><code>max_size=size</code><ul><li>磁盘<code>path</code>路径中用于缓存数据的缓存空间上限</li></ul></li><li><code>levels=levels</code>：缓存目录的层级数量，以及每一级的目录数量</li><li><code>levels=ONE:TWO:THREE</code></li></ul><p>示例：<code>leves=1:2:2</code></p><ul><li><code>keys_zone=name:size</code><ul><li><code>k/v</code>映射的内存空间的名称及大小</li></ul></li><li><code>inactive=time`</code><ul><li>非活动时长</li></ul></li></ul><h3 id="fastcgi-cache-zone-off"><a href="#fastcgi-cache-zone-off" class="headerlink" title="fastcgi_cache zone | off;"></a>fastcgi_cache zone | off;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:fastcgi_cache zone | off;</span><br><span class="line">Default:</span><br><span class="line">fastcgi_cache off;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>定义用于缓存的共享内存区域。相同的区域可以在几个地方使用。参数值可以包含变量（1.7.9）。该<code>off</code>参数禁用从先前配置级别继承的缓存。</p><p>调用指定的缓存空间来缓存数据</p><h3 id="fastcgi-cache-key-string"><a href="#fastcgi-cache-key-string" class="headerlink" title="fastcgi_cache_key string;"></a>fastcgi_cache_key string;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:fastcgi_cache_key string;</span><br><span class="line">Default:—</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>定义用作缓存项的<code>key</code>的字符串<br>示例：<code>fastcgi_cache_key $request_rui;</code></p><h3 id="fastcgi-cache-methods-GET-HEAD-POST-…"><a href="#fastcgi-cache-methods-GET-HEAD-POST-…" class="headerlink" title="fastcgi_cache_methods GET | HEAD | POST …;"></a>fastcgi_cache_methods GET | HEAD | POST …;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:fastcgi_cache_methods GET | HEAD | POST ...;</span><br><span class="line">Default:</span><br><span class="line">fastcgi_cache_methods GET HEAD;</span><br><span class="line">Context:http, server, location</span><br><span class="line">This directive appeared in version 0.7.59.</span><br></pre></td></tr></table></figure></p><p>为哪些请求方法使用缓存</p><p>如果客户端请求方法在此指令中列出，则响应将被缓存。<code>“ GET”</code>和<code>“ HEAD”</code>方法总是添加到列表中，尽管建议明确指定它们。</p><h3 id="fastcgi-cache-min-uses-number"><a href="#fastcgi-cache-min-uses-number" class="headerlink" title="fastcgi_cache_min_uses number;"></a>fastcgi_cache_min_uses number;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:fastcgi_cache_min_uses number;</span><br><span class="line">Default:</span><br><span class="line">fastcgi_cache_min_uses 1;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>缓存空间中的缓存项在<code>inactive</code>定义的非活动时间内至少要被访问到此处所指定的次数方可被认作活动项</p><h3 id="fastcgi-keep-conn-on-off"><a href="#fastcgi-keep-conn-on-off" class="headerlink" title="fastcgi_keep_conn on | off;"></a>fastcgi_keep_conn on | off;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:fastcgi_keep_conn on | off;</span><br><span class="line">Default:</span><br><span class="line">fastcgi_keep_conn off;</span><br><span class="line">Context:http, server, location</span><br><span class="line">This directive appeared in version 1.1.4.</span><br></pre></td></tr></table></figure></p><p>收到后端服务器响应后， <code>fastcgi</code>服务器是否关闭连接，建议启用长连接</p><h3 id="fastcgi-cache-valid-code-…-time"><a href="#fastcgi-cache-valid-code-…-time" class="headerlink" title="fastcgi_cache_valid [code …] time;"></a>fastcgi_cache_valid [code …] time;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:fastcgi_cache_valid [code ...] time;</span><br><span class="line">Default:—</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>不同的响应码各自的缓存时长</p><h3 id="实现fastcgi缓存"><a href="#实现fastcgi缓存" class="headerlink" title="实现fastcgi缓存"></a>实现fastcgi缓存</h3><p>还是使用上面的实验环境<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# mkdir -p  /var/cache/nginx/fcgi_cache        # 创建缓存目录</span><br><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/nginx.conf        # 在nginx主配置文件中添加如下，是在http中</span><br><span class="line">http &#123;</span><br><span class="line">    fastcgi_cache_path /var/cache/nginx/fcgi_cache</span><br><span class="line">    levels=1:1:2 keys_zone=fcgicache:20m</span><br><span class="line">    inactive=120s max_size=1g;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ; </span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    </span><br><span class="line">        location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass 192.168.8.138:9000;</span><br><span class="line">        fastcgi_index index.php ;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME /app/php$fastcgi_script_name;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        fastcgi_cache fcgicache ;</span><br><span class="line">        fastcgi_cache_key $request_uri; </span><br><span class="line">        fastcgi_cache_valid 301 1h ;</span><br><span class="line">        fastcgi_cache_valid any 1m ;</span><br><span class="line">        &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl 192.168.8.140/test.php</span><br><span class="line">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;DTD/xhtml1-transitional.dtd&quot;&gt;</span><br><span class="line">&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;head&gt;</span><br><span class="line">&lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line">body &#123;background-color: #ffffff; color: #000000;&#125;</span><br><span class="line">body, td, th, h1, h2 &#123;font-family: sans-serif;&#125;</span><br><span class="line">pre &#123;margin: 0px; font-family: monospace;&#125;</span><br><span class="line">a:link &#123;color: #000099; text-decoration: none; background-color: #ffffff;&#125;</span><br><span class="line">a:hover &#123;text-decoration: underline;&#125;</span><br><span class="line">table &#123;border-collapse: collapse;&#125;</span><br><span class="line">.center &#123;text-align: center;&#125;</span><br><span class="line">.center table &#123; margin-left: auto; margin-right: auto; text-align: left;&#125;</span><br><span class="line">.center th &#123; text-align: center !important; &#125;</span><br><span class="line">td, th &#123; border: 1px solid #000000; font-size: 75%; vertical-align: baseline;&#125;</span><br><span class="line">h1 &#123;font-size: 150%;&#125;</span><br><span class="line">h2 &#123;font-size: 125%;&#125;</span><br><span class="line">.p &#123;text-align: left;&#125;</span><br><span class="line">.e &#123;background-color: #ccccff; font-weight: bold; color: #000000;&#125;</span><br><span class="line">.h &#123;background-color: #9999cc; font-weight: bold; color: #000000;&#125;</span><br><span class="line">.v &#123;background-color: #cccccc; color: #000000;&#125;</span><br><span class="line">.vr &#123;background-color: #cccccc; text-align: right; color: #000000;&#125;</span><br><span class="line">img &#123;float: right; border: 0px;&#125;</span><br><span class="line">hr &#123;width: 600px; background-color: #cccccc; border: 0px; height: 1px; color: #000000;&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;title&gt;phpinfo()&lt;/title&gt;&lt;meta name=&quot;ROBOTS&quot; content=&quot;NOINDEX,NOFOLLOW,NOARCHIVE&quot; /&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;&lt;div class=&quot;center&quot;&gt;</span><br><span class="line">&lt;table border=&quot;0&quot; cellpadding=&quot;3&quot; width=&quot;600&quot;&gt;</span><br><span class="line">&lt;tr class=&quot;h&quot;&gt;&lt;td&gt;</span><br><span class="line">&lt;a href=&quot;http://www.php.net/&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;/test.php?=PHPE9568F34-D428-11d2-A769-00AA001ACF42&quot; alt=&quot;PHP Logo&quot; /&gt;&lt;/a&gt;&lt;h1 class=&quot;p&quot;&gt;PHP Version 5.4.16&lt;/h1&gt;</span><br><span class="line">&lt;/td&gt;&lt;/tr&gt;</span><br><span class="line">&lt;/table&gt;&lt;br /&gt;</span><br><span class="line">。。。省略</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# cd /var/cache/nginx/fcgi_cache/      ＃进入缓存目录</span><br><span class="line">[root@Nginx-Server fcgi_cache]# ls      # 已经缓存</span><br><span class="line">1  7  b</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server fcgi_cache]# tree        #查看目录结构</span><br><span class="line">.</span><br><span class="line">├── 1</span><br><span class="line">│   └── a</span><br><span class="line">│       └── ed</span><br><span class="line">│           └── 05d649e04370121f2343846df6b2eda1</span><br><span class="line">├── 7</span><br><span class="line">│   └── 5</span><br><span class="line">│       └── 6f</span><br><span class="line">│           └── 1c4d0ba4e0548244739027d15ed56f57</span><br><span class="line">└── b</span><br><span class="line">    └── d</span><br><span class="line">        └── 77</span><br><span class="line">            └── bf6813c2bc0becb369a8d8367b6b77db</span><br><span class="line"></span><br><span class="line">9 directories, 3 files</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server fcgi_cache]# ll      </span><br><span class="line">total 0</span><br><span class="line">drwx------ 3 nginx nginx 15 Oct 27 21:21 1</span><br><span class="line">drwx------ 3 nginx nginx 15 Oct 27 21:21 7</span><br><span class="line">drwx------ 3 nginx nginx 15 Oct 27 21:21 b</span><br></pre></td></tr></table></figure></p>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块 ngx_http_fastcgi_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块 ngx_http_fastcgi_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块 ngx_http_headers_module</title>
      <link href="/2017/10/27/Nginx-ngx-http-headers-module/"/>
      <url>/2017/10/27/Nginx-ngx-http-headers-module/</url>
      <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>该<code>ngx_http_headers_module</code>模块允许将<code>“Expires”和“Cache-Control”</code>头字段以及任意字段添加到响应头。</p><p>向由代理服务器响应给客户端的响应报文添加自定义首部，或修改指定首部的值</p><h3 id="add-header-name-value-always"><a href="#add-header-name-value-always" class="headerlink" title="add_header name value [always];"></a>add_header name value [always];</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:add_header name value [always];</span><br><span class="line">Default:—</span><br><span class="line">Context:http, server, location, if in location</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>如果响应代码等于200,201（1.3.10），204,206,301,302,303,304,307（1.1.16,1.0.13）或308（1.13），则将指定的字段添加到响应头部.0）。该值可以包含变量。</p><p>可能有几个add_header指令。当且仅当add_header 在当前级别上没有定义指令时，这些指令将从上一级继承 。</p><p>如果always指定了参数（1.7.5），则将添加头字段，而不管响应代码如何。</p><p>添加自定义首部</p><h3 id="add-trailer-name-value-always"><a href="#add-trailer-name-value-always" class="headerlink" title="add_trailer name value [always];"></a>add_trailer name value [always];</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:add_trailer name value [always];</span><br><span class="line">Default:—</span><br><span class="line">Context:http, server, location, if in location</span><br><span class="line">This directive appeared in version 1.13.2.</span><br></pre></td></tr></table></figure></p><p>将响应代码等于200，201，206，301，302，303，307或308的指定字段添加到响应的结尾。该值可以包含变量。</p><p>可能有几个add_trailer指令。当且仅当add_trailer 在当前级别上没有定义指令时，这些指令将从上一级继承 。</p><p>如果always指定了参数，则无论响应代码如何，都将添加指定的字段。</p><p>添加自定义响应信息的尾部</p><h3 id="实现add-header-name"><a href="#实现add-header-name" class="headerlink" title="实现add_header name"></a>实现add_header name</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf </span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ;</span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ;</span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ;</span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    location /html &#123;</span><br><span class="line">        proxy_set_header Real-server $remote_addr ;</span><br><span class="line">        proxy_pass http://192.168.8.136;</span><br><span class="line">        add_header X-via $server_addr ;</span><br><span class="line">        add_header X-cache $upstream_cache_status;</span><br><span class="line">        add_header X-Accel $server_name ;</span><br><span class="line">    &#125;</span><br><span class="line">    proxy_cache proxycache ; </span><br><span class="line">    proxy_cache_key $request_uri ;</span><br><span class="line">    proxy_cache_valid 200 302 301 1h ;</span><br><span class="line">    proxy_cache_valid any 1m ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br><span class="line"></span><br><span class="line">[root@CLIENT ~]# curl -I  http://192.168.8.140/html/        # 查看访问包头，添加成功</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Fri, 27 Oct 2017 09:22:21 GMT</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Content-Length: 503737</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Last-Modified: Fri, 27 Oct 2017 08:52:43 GMT</span><br><span class="line">ETag: &quot;2205a0-7afb9-55c836975649a&quot;</span><br><span class="line">X-via: 192.168.8.140</span><br><span class="line">X-cache: HIT</span><br><span class="line">X-Accel: www.a.com</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure><h3 id="实现add-trailer-name"><a href="#实现add-trailer-name" class="headerlink" title="实现add_trailer name"></a>实现add_trailer name</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf </span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ;</span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ;</span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ;</span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    location /html &#123;</span><br><span class="line">        proxy_set_header Real-server $remote_addr ;</span><br><span class="line">        proxy_pass http://192.168.8.136;</span><br><span class="line">        add_header X-via $server_addr ;</span><br><span class="line">        add_header X-cache $upstream_cache_status;</span><br><span class="line">        add_header X-Accel $server_name ;</span><br><span class="line">        add_header Via $server_addr ;</span><br><span class="line">        add_header Cache $upstream_cache_status;  </span><br><span class="line">        add_header Accel $server_name ;</span><br><span class="line">    &#125;</span><br><span class="line">    proxy_cache proxycache ; </span><br><span class="line">    proxy_cache_key $request_uri ;</span><br><span class="line">    proxy_cache_valid 200 302 301 1h ;</span><br><span class="line">    proxy_cache_valid any 1m ;</span><br><span class="line">&#125;</span><br><span class="line">[root@Nginx-Server ~]# nginx -t </span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@CLIENT ~]# curl -I  http://192.168.8.140/html/        # 查看头部，已经添加</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Fri, 27 Oct 2017 09:25:00 GMT</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Content-Length: 503737</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Last-Modified: Fri, 27 Oct 2017 08:52:43 GMT</span><br><span class="line">ETag: &quot;2205a0-7afb9-55c836975649a&quot;</span><br><span class="line">X-via: 192.168.8.140</span><br><span class="line">X-cache: MISS</span><br><span class="line">X-Accel: www.a.com</span><br><span class="line">Via: 192.168.8.140</span><br><span class="line">Cache: MISS</span><br><span class="line">Accel: www.a.com</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块 ngx_http_headers_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块 ngx_http_headers_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块 ngx_http_proxy_module</title>
      <link href="/2017/10/27/Nginx-ngx-http-proxy-module/"/>
      <url>/2017/10/27/Nginx-ngx-http-proxy-module/</url>
      <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>The ngx_http_proxy_module module allows passing requests to another server.</p><p>该<code>ngx_http_proxy_module</code>模块允许将请求传递给另一个服务器。</p><p><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass" target="_blank" rel="noopener">官网帮助文档：http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass</a></p><a id="more"></a><h3 id="proxy-pass-URL"><a href="#proxy-pass-URL" class="headerlink" title="proxy_pass URL;"></a>proxy_pass URL;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_pass URL;</span><br><span class="line">Default:—</span><br><span class="line">Context:location, if in location, limit_except</span><br></pre></td></tr></table></figure></p><p>设置代理服务器的协议和地址以及位置应映射到的可选<code>URI</code>。作为协议，可以指定<code>“ http”</code>或<code>“ https”</code>。该地址可以指定为域名或<code>IP</code>地址，也可以指定为可选端口：</p><h4 id="实现反向代理服务"><a href="#实现反向代理服务" class="headerlink" title="实现反向代理服务"></a>实现反向代理服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@Apache ~]# ifconfig eth1      # 查看Real Server的IP</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:23:DB:AF  </span><br><span class="line">          inet addr:192.168.8.136  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fe23:dbaf/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:216 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:153 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:22726 (22.1 KiB)  TX bytes:23032 (22.4 KiB)</span><br><span class="line">[root@Apache ~]# yum install -y httpd        # 安装httpd服务</span><br><span class="line">[root@Apache ~]# service httpd start    </span><br><span class="line">[root@Apache ~]# echo &quot;Apache server 192.168.8.136&quot; &gt; /var/www/html/index.html </span><br><span class="line">[root@Apache ~]# curl localhost</span><br><span class="line">Apache server 192.168.8.136</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf </span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ; </span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    location / &#123; </span><br><span class="line">        proxy_pass http://192.168.8.136 ; </span><br><span class="line">    &#125;   </span><br><span class="line">     </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl www.a.com       # 访问测试，ok</span><br><span class="line">Apache server 192.168.8.136</span><br><span class="line"></span><br><span class="line">[root@Apache ~]# tail -1  /var/log/httpd/access_log         # 查看APache服务器的日志，apache认为是代理服务器访问的</span><br><span class="line">192.168.8.140 - - [27/Oct/2017:14:19:30 +0800] &quot;GET / HTTP/1.0&quot; 200 28 &quot;-&quot; &quot;curl/7.29.0&quot;</span><br></pre></td></tr></table></figure><h4 id="实现访问以-php结尾的文件都代理到192-168-8-136"><a href="#实现访问以-php结尾的文件都代理到192-168-8-136" class="headerlink" title="实现访问以.php结尾的文件都代理到192.168.8.136"></a>实现访问以.php结尾的文件都代理到192.168.8.136</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 我们接着上面的实验来做</span><br><span class="line">[root@Apache ~]# yum install -y php</span><br><span class="line">[root@Apache ~]# service httpd restart</span><br><span class="line">Stopping httpd:                                            [  OK  ]</span><br><span class="line">Starting httpd:                                            [  OK  ]</span><br><span class="line">[root@Apache ~]# vim /var/www/html/a.php        # 编写php页面</span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>本地访问php测试，可以访问</p><center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-proxy-module-1.jpg" title="测试访问"></center><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf      # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ;</span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ;</span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ;</span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        proxy_pass http://192.168.8.136 ; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br></pre></td></tr></table></figure><p>访问测试，ok</p><center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-proxy-module-2.jpg" title="测试访问"></center><h4 id="代理服务器加-和不加-的区别？"><a href="#代理服务器加-和不加-的区别？" class="headerlink" title="代理服务器加/和不加/的区别？"></a>代理服务器加/和不加/的区别？</h4><h5 id="不加"><a href="#不加" class="headerlink" title="不加/"></a>不加/</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@Apache ~]# mkdir /var/www/html/html/          #创建测试文件夹</span><br><span class="line">[root@Apache ~]# echo &quot;This is test file&quot; &gt; /var/www/html/html/index.html       # 创建测试文件</span><br><span class="line">[root@Apache ~]# cat /var/www/html/html/index.html</span><br><span class="line">This is test file</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          #修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ;</span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ;</span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ;</span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    location /html &#123;</span><br><span class="line">        proxy_pass http://192.168.8.136;        # 先来个不加/的</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl www.a.com/html/     # 访问测试，看到的是192.168.8.136/html/index.html的内容</span><br><span class="line">This is test file</span><br><span class="line">[root@Nginx-Server ~]# curl 192.168.8.136/html/     # 直接访问192.168.8.136/html和上面效果是相同的</span><br><span class="line">This is test file</span><br><span class="line"># 由此我们可以得出：不加/的话，访问的就是代理服务和location中定义的路径的组合。</span><br><span class="line"># 例如：</span><br><span class="line">location /img &#123;</span><br><span class="line">    proxy_pass http://192.168.8.136 ; </span><br><span class="line">&#125;</span><br><span class="line"># 那么，我们访问的应该是那个目录呢？ 当然是http://192.168.8.8.136/img了。</span><br></pre></td></tr></table></figure><h5 id="加"><a href="#加" class="headerlink" title="加/"></a>加/</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf      # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ;</span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ;</span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ;</span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    location /html &#123;</span><br><span class="line">        proxy_pass http://192.168.8.136/;       # 注意：这次我们加/了</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl www.a.com/html/     # 访问测试，看到的是192.168.8.136/index.html的内容</span><br><span class="line">Apache server 192.168.8.136</span><br><span class="line">[root@Nginx-Server ~]# curl 192.168.8.136       # 直接访问192.168.8.136和上面效果是相同的</span><br><span class="line">Apache server 192.168.8.136</span><br><span class="line"></span><br><span class="line"># 由此，我们得出，如果加上/的话，访问的就是加上/后的内容了，和location中定义的路径已经被替换为/了。</span><br><span class="line"># 例如</span><br><span class="line">location /img &#123;</span><br><span class="line">    proxy_pass http://192.168.8.136/; </span><br><span class="line">&#125;</span><br><span class="line"># 上面这个例子，应该访问那个路径呢？ 当然是http://192.168.8.136/了。</span><br><span class="line"></span><br><span class="line">如果location定义其uri时使用了正则表达式的模式，则proxy_pass之后必须不能使用uri; 用户请求时传递的uri将直</span><br><span class="line">接附加代理到的服务的之后server &#123;</span><br><span class="line">    ...</span><br><span class="line">    server_name HOSTNAME;</span><br><span class="line">    location ~|~* /uri/ &#123;</span><br><span class="line">    proxy_pass http://host; 不能加/</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">http://HOSTNAME/uri/ --&gt; http://host/uri/</span><br></pre></td></tr></table></figure><h3 id="proxy-set-header-field-value"><a href="#proxy-set-header-field-value" class="headerlink" title="proxy_set_header field value;"></a>proxy_set_header field value;</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_set_header field value;</span><br><span class="line">Default:</span><br><span class="line">proxy_set_header Host $proxy_host;</span><br><span class="line">proxy_set_header Connection close;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>设定发往后端主机的请求报文的请求首部的值</p><p>设定发往后端主机的请求报文的请求首部的值</p><ul><li><code>Context: http, server, location</code></li><li><code>proxy_set_header X-Real-IP $remote_addr;</code></li><li><code>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</code><br>标准格式如下：</li><li><code>X-Forwarded-For: client1, proxy1, proxy2</code></li><li><code>$remote_addr</code>是一个变量代表<code>client address</code></li><li><code>X-Forwarded-For</code>也是一个变量代表“X-Forwarded-For”客户机请求头域，$remote_addr附加变量，用逗号分隔。如果客户端请求头中不存在“X-Forwarded-For”字段，则该$proxy_add_x_forwarded_for变量等于该$remote_addr变量。</li></ul><h4 id="实现proxy-set-header-field-value"><a href="#实现proxy-set-header-field-value" class="headerlink" title="实现proxy_set_header field value;"></a>实现proxy_set_header field value;</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ;</span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ;</span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ;</span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    location /html &#123;</span><br><span class="line">        proxy_set_header Real-server $remote_addr ;     # 添加真实服务器地址</span><br><span class="line">        proxy_pass http://192.168.8.136/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@Apache ~]# vim /etc/httpd/conf/httpd.conf         # 修改apache服务的配置文件</span><br><span class="line">LogFormat &quot;%&#123;Real-server&#125;i %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;&quot; Nginx-proxy        # 定义一个新的日志格式，使apache能够识别代理服务器发过来的真实IP</span><br><span class="line">CustomLog logs/access_log Nginx-proxy       # 使用新的服务器IP</span><br><span class="line"></span><br><span class="line">[root@Apache ~]# service httpd restart</span><br><span class="line">Stopping httpd:                                            [  OK  ]</span><br><span class="line">Starting httpd:                                            [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@CLIENT ~]# ifconfig eth1      # 测试客户端IP</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:DE:D2:8C  </span><br><span class="line">          inet addr:192.168.8.128  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fede:d28c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:3446 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:1197 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:316040 (308.6 KiB)  TX bytes:93833 (91.6 KiB)</span><br><span class="line"></span><br><span class="line">[root@CLIENT ~]# curl 192.168.8.140/html/       # 测试访问代理服务器</span><br><span class="line">Apache server 192.168.8.136</span><br><span class="line"></span><br><span class="line">[root@Apache ~]# tail -1 /var/log/httpd/access_log      # 查看Apache的访问日志，已经将真实服务器的iP添加进来</span><br><span class="line">192.168.8.128 192.168.8.140 - - [27/Oct/2017:15:56:20 +0800] &quot;GET // HTTP/1.0&quot; 200 28 &quot;-&quot; &quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span><br></pre></td></tr></table></figure><h3 id="proxy-cache-use-stale-error"><a href="#proxy-cache-use-stale-error" class="headerlink" title="proxy_cache_use_stale error"></a>proxy_cache_use_stale error</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_cache_use_stale error | timeout | invalid_header | updating | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | http_429 | off ...;</span><br><span class="line">Default:</span><br><span class="line">proxy_cache_use_stale off;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>在被代理的后端服务器出现哪种情况下，可以真接使用过期的缓存响应客户端</p><h3 id="proxy-cache-methods-GET-HEAD-POST-…"><a href="#proxy-cache-methods-GET-HEAD-POST-…" class="headerlink" title="proxy_cache_methods GET | HEAD | POST …;"></a>proxy_cache_methods GET | HEAD | POST …;</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_cache_methods GET | HEAD | POST ...;</span><br><span class="line">Default:</span><br><span class="line">proxy_cache_methods GET HEAD;</span><br><span class="line">Context:http, server, location</span><br><span class="line">This directive appeared in version 0.7.59.</span><br></pre></td></tr></table></figure></p><p>如果客户端请求方法在此指令中列出，则响应将被缓存。<code>“ GET”</code>和<code>“HEAD”</code>方法总是添加到列表中，尽管建议明确指定它们。</p><h3 id="proxy-hide-header-field"><a href="#proxy-hide-header-field" class="headerlink" title="proxy_hide_header field;"></a>proxy_hide_header field;</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_hide_header field;</span><br><span class="line">Default:—</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>默认情况下，<code>nginx</code>不会将代理服务器的响应中的头字段<code>“Date”</code>，<code>“Server”</code>，<code>“X-Pad”</code>和<code>“X-Accel -...”</code>传递给客户端。该<code>proxy_hide_header</code>指令设置不会传递的其他字段。如果相反，需要允许字段的传递，则可以使用<code>proxy_pass_header</code>指令。</p><p>用于隐藏后端服务器特定的响应首部</p><h3 id="proxy-connect-timeout-time"><a href="#proxy-connect-timeout-time" class="headerlink" title="proxy_connect_timeout time;"></a>proxy_connect_timeout time;</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_connect_timeout time;</span><br><span class="line">Default:</span><br><span class="line">proxy_connect_timeout 60s;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>定义与后端服务器建立连接的超时时长，如超时会出现502错误，默认为60s，一般不建议超出75s，</p><h3 id="proxy-send-timeout-time"><a href="#proxy-send-timeout-time" class="headerlink" title="proxy_send_timeout time;"></a>proxy_send_timeout time;</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_send_timeout time;</span><br><span class="line">Default:</span><br><span class="line">proxy_send_timeout 60s;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>设置将代理服务器发送请求的超时时间。超时仅在两个连续的写入操作之间设置，而不是传输整个请求。如果代理服务器在此时间内没有收到任何内容，则连接被关闭。</p><p>把请求发送给后端服务器的超时时长；默认为60s</p><h3 id="proxy-read-timeout-time"><a href="#proxy-read-timeout-time" class="headerlink" title="proxy_read_timeout time;"></a>proxy_read_timeout time;</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_read_timeout time;</span><br><span class="line">Default:</span><br><span class="line">proxy_read_timeout 60s;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>定义从代理服务器读取响应的超时。超时仅在两个连续读操作之间设置，而不是传输整个响应。如果代理的服务器在此时间内没有传输任何内容，则连接被关闭。</p><p>等待后端服务器发送响应报文的超时时长， 默认为60s</p><h3 id="proxy-cache-key-string"><a href="#proxy-cache-key-string" class="headerlink" title="proxy_cache_key string;"></a>proxy_cache_key string;</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_cache_key string;</span><br><span class="line">Default:</span><br><span class="line">proxy_cache_key $scheme$proxy_host$request_uri;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><ul><li>缓存中用于“键”的内容</li><li>默认值：<code>proxy_cache_key $scheme$proxy_host$request_uri;</code></li></ul><h3 id="proxy-cache-valid-code-…-time"><a href="#proxy-cache-valid-code-…-time" class="headerlink" title="proxy_cache_valid [code …] time;"></a>proxy_cache_valid [code …] time;</h3><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:proxy_cache_valid [code ...] time;</span><br><span class="line">Default:—</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><ul><li>定义对特定响应码的响应内容的缓存时长</li><li>定义在http{…}中</li><li>示例:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_valid 200 302 10m;</span><br><span class="line">proxy_cache_valid 404 1m;</span><br></pre></td></tr></table></figure></li></ul><h3 id="实现代理缓存"><a href="#实现代理缓存" class="headerlink" title="实现代理缓存"></a>实现代理缓存</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">[root@Apache ~]# cp /var/log/messages /var/www/html/html/index.html &amp;&amp; chmod a+r /var/www/html/html/index.html       # 准备测试网页</span><br><span class="line">[root@Apache ~]# ll -h /var/www/html/html/index.html</span><br><span class="line">-rw-r--r-- 1 root root 492K Oct 27 16:52 /var/www/html/html/index.html</span><br><span class="line"></span><br><span class="line">[root@CLIENT ~]# ab -c 100 -n 2000 http://192.168.8.140/html/       # 没启用缓存功能测试，平均每秒170个</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking 192.168.8.140 (be patient)</span><br><span class="line">Completed 200 requests</span><br><span class="line">Completed 400 requests</span><br><span class="line">Completed 600 requests</span><br><span class="line">Completed 800 requests</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 1200 requests</span><br><span class="line">Completed 1400 requests</span><br><span class="line">Completed 1600 requests</span><br><span class="line">Completed 1800 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Finished 2000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx/1.10.2</span><br><span class="line">Server Hostname:        192.168.8.140</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /html/</span><br><span class="line">Document Length:        503737 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      100</span><br><span class="line">Time taken for tests:   11.739 seconds</span><br><span class="line">Complete requests:      2000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      1008004000 bytes</span><br><span class="line">HTML transferred:       1007474000 bytes</span><br><span class="line">Requests per second:    170.38 [#/sec] (mean)</span><br><span class="line">Time per request:       586.938 [ms] (mean)</span><br><span class="line">Time per request:       5.869 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          83857.12 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    4  38.9      1    1001</span><br><span class="line">Processing:    48  573 240.2    554    1986</span><br><span class="line">Waiting:        2  280 207.4    306    1076</span><br><span class="line">Total:         54  577 243.8    557    1987</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%    557</span><br><span class="line">  66%    605</span><br><span class="line">  75%    641</span><br><span class="line">  80%    670</span><br><span class="line">  90%    775</span><br><span class="line">  95%   1014</span><br><span class="line">  98%   1419</span><br><span class="line">  99%   1521</span><br><span class="line"> 100%   1987 (longest request)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# mkdir -p  /var/cache/nginx/proxy_cache       # 创建缓存目录</span><br><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/nginx.conf        # 在http配置定义缓存信</span><br><span class="line">http &#123;</span><br><span class="line">    proxy_cache_path /var/cache/nginx/proxy_cache</span><br><span class="line">    levels=1:1:2 keys_zone=proxycache:20m</span><br><span class="line">    inactive=120s max_size=1g;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf      # 调用缓存功能，需要定义在相应的配置段</span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ;</span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ;</span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ;</span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    location /html &#123;</span><br><span class="line">        proxy_set_header Real-server $remote_addr ;</span><br><span class="line">        proxy_pass http://192.168.8.136;</span><br><span class="line">    &#125;</span><br><span class="line">    proxy_cache proxycache ;</span><br><span class="line">    proxy_cache_key $request_uri ;</span><br><span class="line">    proxy_cache_valid 200 302 301 1h ;</span><br><span class="line">    proxy_cache_valid any 1m ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line">[root@CLIENT ~]# ab -c 100 -n 2000 http://192.168.8.140/html/       # 速度已经明显加快，平均每秒294个，已经快了一倍多</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;$Revision: 655654 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking 192.168.8.140 (be patient)</span><br><span class="line">Completed 200 requests</span><br><span class="line">Completed 400 requests</span><br><span class="line">Completed 600 requests</span><br><span class="line">Completed 800 requests</span><br><span class="line">Completed 1000 requests</span><br><span class="line">Completed 1200 requests</span><br><span class="line">Completed 1400 requests</span><br><span class="line">Completed 1600 requests</span><br><span class="line">Completed 1800 requests</span><br><span class="line">Completed 2000 requests</span><br><span class="line">Finished 2000 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        nginx/1.10.2</span><br><span class="line">Server Hostname:        192.168.8.140</span><br><span class="line">Server Port:            80</span><br><span class="line"></span><br><span class="line">Document Path:          /html/</span><br><span class="line">Document Length:        503737 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      100</span><br><span class="line">Time taken for tests:   6.794 seconds</span><br><span class="line">Complete requests:      2000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Write errors:           0</span><br><span class="line">Total transferred:      1008004000 bytes</span><br><span class="line">HTML transferred:       1007474000 bytes</span><br><span class="line">Requests per second:    294.36 [#/sec] (mean)</span><br><span class="line">Time per request:       339.718 [ms] (mean)</span><br><span class="line">Time per request:       3.397 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          144881.64 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0   11   5.1     10      50</span><br><span class="line">Processing:   229  328  32.3    316     440</span><br><span class="line">Waiting:        1   13   8.6     11      52</span><br><span class="line">Total:        241  339  32.7    329     454</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%    329</span><br><span class="line">  66%    346</span><br><span class="line">  75%    354</span><br><span class="line">  80%    367</span><br><span class="line">  90%    378</span><br><span class="line">  95%    408</span><br><span class="line">  98%    432</span><br><span class="line">  99%    433</span><br><span class="line"> 100%    454 (longest request)</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# cd /var/cache/nginx/proxy_cache/     # 查看缓存目录</span><br><span class="line">[root@Nginx-Server proxy_cache]# tree       # 可以看到目录其实就是去文件的后1，1，2</span><br><span class="line">.</span><br><span class="line">└── f</span><br><span class="line">    └── f</span><br><span class="line">        └── ed</span><br><span class="line">            └── 2232907628d080965cf7017637f5edff</span><br><span class="line"></span><br><span class="line">3 directories, 1 file</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块 ngx_http_proxy_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块 ngx_http_proxy_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块 ngx_http_rewrite_module</title>
      <link href="/2017/10/27/Nginx-ngx-http-rewrite-module/"/>
      <url>/2017/10/27/Nginx-ngx-http-rewrite-module/</url>
      <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><strong>官网的介绍：</strong></p><p><code>The ngx_http_rewrite_module module is used to change request URI using PCRE regular expressions, return redirects, and conditionally select configurations.</code></p><p>将用户请求的<code>URI</code>基于<code>PCRE regex</code>所描述的模式进行检查，而后完成重定向替换</p><a id="more"></a><h3 id="rewrite-regex-replacement-flag"><a href="#rewrite-regex-replacement-flag" class="headerlink" title="rewrite regex replacement [flag];"></a>rewrite regex replacement [flag];</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:rewrite regex replacement [flag];</span><br><span class="line">Default:—</span><br><span class="line">Context:server, location, if</span><br></pre></td></tr></table></figure></p><ul><li>如果指定的正则表达式与请求<code>URI</code>匹配，则<code>URI</code>将按照<code>replacement</code>字符串中的指定进行更改。该<code>rewrite</code>指令在其在配置文件中出现的顺序顺序地执行。可以使用标志终止对伪指令的进一步处理。如果替换字符串以<code>“ http://”，“ https://”</code>或<code>“ $scheme”</code>开头，则处理停止，并将重定向返回给客户端。</li><li>将用户请求的<code>URI</code>基于<code>regex</code>所描述的模式进行检查，匹配到时将其替换为<code>replacement</code>指定的新的<code>URI</code></li><li>注意：如果在同一级配置块中存在多个<code>rewrite</code>规则，那么会自下而下逐个检查；被某条件规则替换完成后，会重新一轮的替换检查</li><li>隐含有循环机制,但不超过10次；如果超过，提示500响应码， <code>[flag]</code>所表示的标志位用于控制此循环机制</li><li>如果<code>replacement</code>是以<code>http://</code>或<code>https://</code>开头，则替换结果会直接以重向返回给客户端</li><li>301：永久重定向</li></ul><h4 id="flag"><a href="#flag" class="headerlink" title="[flag]"></a>[flag]</h4><ul><li><code>last</code>：重写完成后停止对当前<code>URI</code>在当前<code>location</code>中后续的其它重写操作，而后对新的<code>URI</code>启动新一轮重写检查；提前重启新一轮循环</li><li><code>break</code>：重写完成后停止对当前<code>URI</code>在当前<code>location</code>中后续的其它重写操作，而后直接跳转至重写规则配置块之后的其它配置；结束循环，建议在<code>location</code>中使用</li><li><code>redirect</code>：临时重定向，重写完成后以临时重定向方式直接返回重写后生成的新<code>URI</code>给客户端，由客户端重新发起请求；不能以<code>http://</code>或<code>https://</code>开头，使用相对路径，状态码： 302</li><li><code>permanent</code>:重写完成后以永久重定向方式直接返回重写后生成的新URI给客户端，由客户端重新发起请求，状态码：301</li></ul><h3 id="return-code-text"><a href="#return-code-text" class="headerlink" title="return code [text];"></a>return code [text];</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:return code [text];</span><br><span class="line">return code URL;</span><br><span class="line">return URL;</span><br><span class="line">Default:—</span><br><span class="line">Context:server, location, if</span><br></pre></td></tr></table></figure></p><p>停止处理，并返回给客户端指定的响应码</p><h3 id="rewrite-log-on-off"><a href="#rewrite-log-on-off" class="headerlink" title="rewrite_log on | off;"></a>rewrite_log on | off;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:rewrite_log on | off;</span><br><span class="line">Default:</span><br><span class="line">rewrite_log off;</span><br><span class="line">Context:http, server, location, if</span><br></pre></td></tr></table></figure></p><p>是否开启重写日志, 发送至<code>error_log</code>（<code>notice level</code>）</p><h3 id="set-variable-value"><a href="#set-variable-value" class="headerlink" title="set $variable value;"></a>set $variable value;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:set $variable value;</span><br><span class="line">Default:—</span><br><span class="line">Context:server, location, if</span><br></pre></td></tr></table></figure></p><p>用户自定义变量（注意：变量定义和调用都要以<code>$</code>开头）</p><h3 id="if-condition-…"><a href="#if-condition-…" class="headerlink" title="if (condition) { … }"></a>if (condition) { … }</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:if (condition) &#123; ... &#125;</span><br><span class="line">Default:—</span><br><span class="line">Context:server, location</span><br></pre></td></tr></table></figure></p><ul><li>指定的<code>condition</code>被评估。如果为<code>true</code>，则在该大括号内指定的此模块指令将被执行，并且请求被分配给该<code>if</code>指令内的配置 。<code>if</code>指令内的配置继承自以前的配置级别。</li><li>引入新的上下文,条件满足时，执行配置块中的配置指令</li></ul><h4 id="比较操作符："><a href="#比较操作符：" class="headerlink" title="比较操作符："></a>比较操作符：</h4><ul><li><code>==</code>相同</li><li><code>!=</code> 不同</li><li><code>~</code>：模式匹配，区分字符大小写</li><li><code>~*</code>：模式匹配，不区分字符大小写</li><li><code>!~</code>：模式不匹配，区分字符大小写</li><li><code>!~*</code>：模式不匹配，不区分字符大小写</li></ul><h4 id="文件及目录存在性判断："><a href="#文件及目录存在性判断：" class="headerlink" title="文件及目录存在性判断："></a>文件及目录存在性判断：</h4><ul><li><code>-e</code>, <code>!-e</code> 存在（包括文件，目录，软链接）</li><li><code>-f</code>, <code>!-f</code> 文件</li><li><code>-d</code>, <code>!-d</code> 目录</li><li><code>-x</code>, <code>!-x</code> 执行</li></ul><h3 id="实现last跳转：bj目录下面的任何文件都跳转到beijing"><a href="#实现last跳转：bj目录下面的任何文件都跳转到beijing" class="headerlink" title="实现last跳转：bj目录下面的任何文件都跳转到beijing"></a>实现last跳转：bj目录下面的任何文件都跳转到beijing</h3><p>服务器内部跳转，在浏览器是看不到任何变化的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# mkdir /app/website1/beijing         #创建跳转目录</span><br><span class="line">[root@Nginx-Server ~]# cat /app/website1/beijing/index.html </span><br><span class="line">bi --&gt; beijing</span><br><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/conf.d/vhost.conf         #修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ;  </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123;</span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 last ;   </span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl 192.168.8.140/bj/index.html     # 注意已经跳转，因为我们是没有bj这个目录的</span><br><span class="line">bi --&gt; beijing</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-rewrite-module-1.gif" title="测试访问"></center><h3 id="实现break跳转"><a href="#实现break跳转" class="headerlink" title="实现break跳转"></a>实现break跳转</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123; </span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 break ;          # break跳转</span><br><span class="line">    </span><br><span class="line">    &#125;   </span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl 192.168.8.140/bj/           # 已经跳转</span><br><span class="line">bi --&gt; beijing</span><br></pre></td></tr></table></figure><h3 id="实现redirect-302临时重定向"><a href="#实现redirect-302临时重定向" class="headerlink" title="实现redirect 302临时重定向"></a>实现redirect 302临时重定向</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf </span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123; </span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 redirect ;</span><br><span class="line">    </span><br><span class="line">    &#125;   </span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl  -I  192.168.8.140/bj/      # 查看响应头部信息，已经是302重定向</span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Fri, 27 Oct 2017 00:51:30 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 161</span><br><span class="line">Location: http://192.168.8.140/beijing/</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl   192.168.8.140/bj/     # 直接访问bj目录会提示302</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;302 Found&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;302 Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.10.2&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Nginx-Server ~]# curl -L   192.168.8.140/bj/      # 需要加上-L来跟踪重定向</span><br><span class="line">bi --&gt; beijing</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-rewrite-module-2.gif" title="测试访问"></center><h3 id="实现permanent-301永久重定向"><a href="#实现permanent-301永久重定向" class="headerlink" title="实现permanent 301永久重定向"></a>实现permanent 301永久重定向</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf </span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123; </span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 permanent ;</span><br><span class="line">    </span><br><span class="line">    &#125;   </span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl -I 192.168.8.140/bj/</span><br><span class="line">HTTP/1.1 301 Moved Permanently</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Fri, 27 Oct 2017 01:01:23 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 185</span><br><span class="line">Location: http://192.168.8.140/beijing/</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl -L 192.168.8.140/bj/</span><br><span class="line">bi --&gt; beijing</span><br></pre></td></tr></table></figure><h3 id="return实现禁止访问某个资源，并返回状态码"><a href="#return实现禁止访问某个资源，并返回状态码" class="headerlink" title="return实现禁止访问某个资源，并返回状态码"></a>return实现禁止访问某个资源，并返回状态码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123; </span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 permanent ;</span><br><span class="line">    </span><br><span class="line">    &#125;   </span><br><span class="line">    location /admin &#123;           # 定义当访问/admin目录时，返回信息&quot;access denied&quot;，且状态码为403</span><br><span class="line">        return 403 &quot;access denied&quot; ; </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl 192.168.8.140/admin     # 已经看到定义的拒绝信息</span><br><span class="line">access denied[root@Nginx-Server ~]# </span><br><span class="line">[root@Nginx-Server ~]# curl -I  192.168.8.140/admin     # 状态码为403</span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Fri, 27 Oct 2017 01:16:22 GMT</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line">Content-Length: 13</span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure><h3 id="return实现跳转到新的URL"><a href="#return实现跳转到新的URL" class="headerlink" title="return实现跳转到新的URL"></a>return实现跳转到新的URL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123; </span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 permanent ;</span><br><span class="line">    </span><br><span class="line">    &#125;   </span><br><span class="line">    location /admin &#123;</span><br><span class="line">        return 403 &quot;access denied&quot; ;</span><br><span class="line">    &#125;   </span><br><span class="line">    location /return &#123;          # 当访问/return时，就跳转到http://www.ihaiyun.cc/</span><br><span class="line">        return http://www.ihaiyun.cc/ ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl -I 192.168.8.140/return     # 已经可以跳转</span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Fri, 27 Oct 2017 01:22:09 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 161</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: http://www.ihaiyun.cc/</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-rewrite-module-3.gif" title="测试访问"></center><h3 id="开启重写日志"><a href="#开启重写日志" class="headerlink" title="开启重写日志"></a>开启重写日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf      # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123; </span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 permanent ;</span><br><span class="line">    </span><br><span class="line">    &#125;   </span><br><span class="line">    location /admin &#123;</span><br><span class="line">        return 403 &quot;access denied&quot; ;</span><br><span class="line">    &#125;   </span><br><span class="line">    location /return &#123;</span><br><span class="line">        return http://www.ihaiyun.cc/ ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    rewrite_log on ;            # 开启重写日志</span><br><span class="line">    error_log /var/log/nginx/return.log ;       # 定义error_log存放位置，因为rewrite_log默认发送到error_log中</span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line">    </span><br><span class="line">[root@CLIENT ~]# curl -L 192.168.8.140/bj/      # 访问测试</span><br><span class="line">bi --&gt; beijing</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# tail /var/log/nginx/return.log       # 查看日志</span><br><span class="line">2017/10/27 09:38:11 [error] 2536#0: *4 open() &quot;/app/website1/bj&quot; failed (2: No such file or directory), client: 192.168.8.128, server: www.a.com, request: &quot;GET /bj HTTP/1.1&quot;, host: &quot;192.168.8.140&quot;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块 ngx_http_rewrite_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块 ngx_http_rewrite_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块 ngx_http_referer_module</title>
      <link href="/2017/10/27/Nginx-ngx-http-referer-module/"/>
      <url>/2017/10/27/Nginx-ngx-http-referer-module/</url>
      <content type="html"><![CDATA[<h3 id="官网介绍"><a href="#官网介绍" class="headerlink" title="官网介绍"></a>官网介绍</h3><p>The ngx_http_referer_module module is used to block access to a site for requests with invalid values in the “Referer” header field. It should be kept in mind that fabricating a request with an appropriate “Referer” field value is quite easy, and so the intended purpose of this module is not to block such requests thoroughly but to block the mass flow of requests sent by regular browsers. It should also be taken into consideration that regular browsers may not send the “Referer” field even for valid requests.</p><p>该<code>ngx_http_referer_module</code>模块用于在<code>“Referer”</code>标题字段中阻止对具有无效值的请求的站点访问。应该记住，使用适当的<code>“Referer”</code>字段值制造请求是非常容易的，因此本模块的预期目的不是彻底阻止这些请求，而是阻止常规浏览器发送的请求的大量流量。还应该考虑到，即使有效的请求，常规浏览器也可能不会发送<code>“Referer”</code>字段。</p><h3 id="valid-referers-none-blocked-server-names-string-…"><a href="#valid-referers-none-blocked-server-names-string-…" class="headerlink" title="valid_referers none | blocked | server_names | string …;"></a>valid_referers none | blocked | server_names | string …;</h3><a id="more"></a><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:valid_referers none | blocked | server_names | string ...;</span><br><span class="line">Default:—</span><br><span class="line">Context:server, location</span><br></pre></td></tr></table></figure></p><p>定义<code>referer</code>首部的合法可用值，不能匹配的将是非法值</p><h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><ul><li><code>none</code>：请求报文首部没有<code>referer</code>首部</li><li><code>blocked</code>：请求报文有<code>referer</code>首部，但无有效值</li><li><code>server_names</code>：参数，其可以有值作为主机名或主机名模式</li><li><code>arbitrary_string</code>：任意字符串，但可使用<code>*</code>作通配符</li><li><code>regular expression</code>：被指定的正则表达式模式匹配到的字符串,要使用<code>~</code>开头，例如：<code>~.*\.magedu\.com</code></li></ul><h3 id="理解什么是referer？"><a href="#理解什么是referer？" class="headerlink" title="理解什么是referer？"></a>理解什么是referer？</h3><p><code>HTTP Referer</code>是<code>header</code>的一部分，当浏览器向<code>web</code>服务器发送请求的时候，一般会带上<code>Referer</code>，告诉服务器我是从哪个页面链接过来的，服务器基此可以获得一些信息用于处理。</p><h3 id="模拟盗链现象"><a href="#模拟盗链现象" class="headerlink" title="模拟盗链现象"></a>模拟盗链现象</h3><h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 定义两台虚拟主机，wwww.a.com（默认）和www.b.com；分别定义了access_log和error_log。</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 创建配置文件，用来定义虚拟主机   </span><br><span class="line"></span><br><span class="line">server &#123;            # 第一台虚拟主机</span><br><span class="line">    listen   default_server ;</span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ;</span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ;</span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;            # 第二台虚拟主机</span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.b.com ;</span><br><span class="line">    root /app/website2 ;</span><br><span class="line">    error_log /var/log/nginx/b.com.error.log  ; </span><br><span class="line">    access_log /var/log/nginx/b.com.access.log main ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="准备访问资源"><a href="#准备访问资源" class="headerlink" title="准备访问资源"></a>准备访问资源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# mkdir -p  /app/website&#123;1,2&#125;</span><br><span class="line">[root@Nginx-Server app]# cd /app/</span><br><span class="line">[root@Nginx-Server app]# echo &quot;website1&quot; &gt; /app/website1/index.html </span><br><span class="line">[root@Nginx-Server app]# echo &quot;website2&quot; &gt; /app/website2/index.html </span><br><span class="line">[root@Nginx-Server app]# find /  -name &quot;*.jpg&quot;      # find几个图片</span><br><span class="line">/usr/share/backgrounds/morning.jpg</span><br><span class="line">/usr/share/backgrounds/night.jpg</span><br><span class="line">/usr/share/backgrounds/day.jpg</span><br><span class="line">/usr/share/backgrounds/default.jpg</span><br><span class="line">/usr/share/kde4/apps/ksplash/Themes/CentOS7/2560x1600/background.jpg</span><br><span class="line">/usr/share/wallpapers/CentOS7/contents/images/2560x1600.jpg</span><br><span class="line">[root@Nginx-Server app]# cp /usr/share/wallpapers/CentOS7/contents/images/2560x1600.jpg /app/website1/aa.jpg        # cp图片</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server app]# cd website2/</span><br><span class="line">[root@Nginx-Server website2]# vim dao.html      #编写盗链html文件，图片是指向www.a.com的</span><br><span class="line">&lt;img src=http://www.a.com/a.jpg&gt;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server app]# tree       # 目录结构，注意b站点中是没有图片文件</span><br><span class="line">.</span><br><span class="line">├── website1</span><br><span class="line">│   ├── aa.jpg</span><br><span class="line">│   ├── a.jpg</span><br><span class="line">│   └── index.html</span><br><span class="line">└── website2</span><br><span class="line">    ├── dao.html</span><br><span class="line">    └── index.html</span><br><span class="line"></span><br><span class="line">2 directories, 5 files</span><br></pre></td></tr></table></figure><h4 id="启动服务测试"><a href="#启动服务测试" class="headerlink" title="启动服务测试"></a>启动服务测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# nginx -t         # 检查配置文件，ok</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop        # 停止nginx服务</span><br><span class="line">[root@Nginx-Server ~]# nginx        # 启动nginx服务</span><br></pre></td></tr></table></figure><ol><li>测试<a href="http://www.a.com/a.jpg" target="_blank" rel="noopener">www.a.com/a.jpg</a></li><li>访问<a href="http://www.b.com/dao.html" target="_blank" rel="noopener">www.b.com/dao.html</a></li><li>查看图片来源</li></ol><center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-referer-module-1.gif" title="测试访问"></center><h4 id="分析日志"><a href="#分析日志" class="headerlink" title="分析日志"></a>分析日志</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# tail -1  /var/log/nginx/a.com.access.log         # 查看a的日志，从日志可以看出referer是http://www.b.com/dao.html，这肯定是有问题的。</span><br><span class="line">192.168.8.100 - - [27/Oct/2017:11:07:48 +0800] &quot;GET /a.jpg HTTP/1.1&quot; 304 0 &quot;http://www.b.com/dao.html&quot; &quot;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:55.0) Gecko/20100101 Firefox/55.0&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure><h3 id="实现防盗链"><a href="#实现防盗链" class="headerlink" title="实现防盗链"></a>实现防盗链</h3><p>上面的实验我们已经实现了盗链，现在我们来阻止盗链，呵呵~~~</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ; </span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    </span><br><span class="line">    valid_referers none blocked server_names</span><br><span class="line">               *.a.com a\.com.* www\.a\.com.*</span><br><span class="line">               ~\.google\.</span><br><span class="line">               ~\.baidu\.;</span><br><span class="line"></span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        return 403 &quot;禁止盗链！！！&quot; ;</span><br><span class="line">    &#125;   </span><br><span class="line">        </span><br><span class="line">    location / &#123; </span><br><span class="line">         </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80  ;</span><br><span class="line">    listen 81 ;</span><br><span class="line">    server_name www.b.com ; </span><br><span class="line">    root /app/website2 ;</span><br><span class="line">    error_log /var/log/nginx/b.com.error.log  ;   </span><br><span class="line">    access_log /var/log/nginx/b.com.access.log main ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br></pre></td></tr></table></figure><ol><li>在b站点已经无法查看图片</li><li>在a站点依旧可以查看</li></ol><center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-referer-module-2.gif" title="测试访问"></center><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://baike.baidu.com/item/HTTP_REFERER/5358396?fr=aladdin" target="_blank" rel="noopener">百度百科：HTTP_REFERER</a></p>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块 ngx_http_referer_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块 ngx_http_referer_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块 ngx_http_ssl_module</title>
      <link href="/2017/10/26/Nginx-ngx-http-ssl-module/"/>
      <url>/2017/10/26/Nginx-ngx-http-ssl-module/</url>
      <content type="html"><![CDATA[<h3 id="Syntax-ssl-on-off"><a href="#Syntax-ssl-on-off" class="headerlink" title="Syntax:    ssl on | off;"></a>Syntax:    ssl on | off;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:ssl on | off;</span><br><span class="line">Default:</span><br><span class="line">ssl off;</span><br><span class="line">Context:http, server</span><br></pre></td></tr></table></figure></p><p>为指定虚拟机启用HTTPS protocol， 建议用listen指令代替</p><a id="more"></a><h3 id="ssl-certificate-file"><a href="#ssl-certificate-file" class="headerlink" title="ssl_certificate file;"></a>ssl_certificate file;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:ssl_certificate file;</span><br><span class="line">Default:—</span><br><span class="line">Context:http, server</span><br></pre></td></tr></table></figure></p><p>当前虚拟主机使用PEM格式的证书文件</p><h3 id="ssl-certificate-key-file"><a href="#ssl-certificate-key-file" class="headerlink" title="ssl_certificate_key file;"></a>ssl_certificate_key file;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:ssl_certificate_key file;</span><br><span class="line">Default:—</span><br><span class="line">Context:http, server</span><br></pre></td></tr></table></figure></p><p>当前虚拟主机上与其证书匹配的私钥文件</p><h3 id="ssl-protocols-SSLv2-…"><a href="#ssl-protocols-SSLv2-…" class="headerlink" title="ssl_protocols [SSLv2] …;"></a>ssl_protocols [SSLv2] …;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:ssl_protocols [SSLv2] [SSLv3] [TLSv1] [TLSv1.1] [TLSv1.2] [TLSv1.3];</span><br><span class="line">Default:</span><br><span class="line">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">Context:http, server</span><br></pre></td></tr></table></figure></p><p>支持<code>ssl</code>协议版本，默认为后三个</p><h3 id="ssl-session-cache-off-none-…"><a href="#ssl-session-cache-off-none-…" class="headerlink" title="ssl_session_cache off | none …;"></a>ssl_session_cache off | none …;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:ssl_session_cache off | none | [builtin[:size]] [shared:name:size];</span><br><span class="line">Default:</span><br><span class="line">ssl_session_cache none;</span><br><span class="line">Context:http, server</span><br></pre></td></tr></table></figure></p><h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><p>设置存储会话参数的高速缓存的类型和大小。缓存可以是以下类型之一：</p><ul><li><code>off</code><ul><li>严格禁止使用会话缓存：<code>nginx</code>明确告诉客户端会话可能不被重用。</li></ul></li><li><code>none</code><ul><li>会话缓存的使用被轻轻地禁止：<code>nginx</code>告诉客户端会话可能被重用，但实际上并没有将会话参数存储在缓存中。</li></ul></li><li><code>builtin</code><ul><li>一个内置<code>OpenSSL</code>的缓存; 仅由一个工作进程使用。缓存大小在会话中指定。如果没有给出大小，则等于<code>20480</code>次会话。使用内置缓存可能会导致内存碎片。</li></ul></li><li><code>shared</code><ul><li>在所有工作进程之间共享缓存。缓存大小以字节为单位指定; 一兆字节可以存储约4000个会话。每个共享缓存应具有任意名称。具有相同名称的缓存可用于多个虚拟服务器。</li></ul></li><li>两种缓存类型可以同时使用，例如：<ul><li><code>ssl_session_cache builtin:1000 shared:SSL:10m;</code></li></ul></li><li>但只使用共享缓存而不使用内置缓存应该更有效率。<ul><li><code>builtin[:size]</code>：使用<code>OpenSSL</code>内建缓存，为每worker进程私有</li><li><code>[shared:name:size]</code>：在各<code>worker</code>之间使用一个共享的缓存73</li></ul></li></ul><h3 id="ssl-session-timeout-time"><a href="#ssl-session-timeout-time" class="headerlink" title="ssl_session_timeout time;"></a>ssl_session_timeout time;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:ssl_session_timeout time;</span><br><span class="line">Default:</span><br><span class="line">ssl_session_timeout 5m;</span><br><span class="line">Context:http, server</span><br></pre></td></tr></table></figure></p><p>客户端连接可以复用<code>ssl session cache</code>中缓存的<code>ssl</code>参数的有效时长，默认<code>5m</code></p><h3 id="实现SSL"><a href="#实现SSL" class="headerlink" title="实现SSL"></a>实现SSL</h3><h4 id="1-创建证书"><a href="#1-创建证书" class="headerlink" title="1. 创建证书"></a>1. 创建证书</h4><p><a href="http://blog.csdn.net/hai__yun/article/details/77921134" target="_blank" rel="noopener">关于创建证书可以查看我的另外一篇博客：http://blog.csdn.net/hai__yun/article/details/77921134</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# cd /etc/pki/tls/certs/</span><br><span class="line">[root@Nginx-Server certs]# make nginx.crt</span><br><span class="line">umask 77 ; \</span><br><span class="line">/usr/bin/openssl genrsa -aes128 2048 &gt; nginx.key</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">...........................+++</span><br><span class="line">....+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">Enter pass phrase:</span><br><span class="line">Verifying - Enter pass phrase:</span><br><span class="line">umask 77 ; \</span><br><span class="line">/usr/bin/openssl req -utf8 -new -key nginx.key -x509 -days 365 -out nginx.crt -set_serial 0</span><br><span class="line">Enter pass phrase for nginx.key:</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN  </span><br><span class="line">State or Province Name (full name) []:BJ</span><br><span class="line">Locality Name (eg, city) [Default City]:haidian</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:haiyun</span><br><span class="line">Organizational Unit Name (eg, section) []:opt</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:www.a.com</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure><h4 id="2-解密私钥"><a href="#2-解密私钥" class="headerlink" title="2. 解密私钥"></a>2. 解密私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server certs]# ls</span><br><span class="line">ca-bundle.crt        make-dummy-cert  nginx.crt  renew-dummy-cert</span><br><span class="line">ca-bundle.trust.crt  Makefile         nginx.key</span><br><span class="line">[root@Nginx-Server certs]# openssl rsa -in nginx.key -out nginx.key </span><br><span class="line">Enter pass phrase for nginx.key:</span><br><span class="line">writing RSA key</span><br><span class="line">[root@Nginx-Server certs]# ls</span><br><span class="line">ca-bundle.crt        make-dummy-cert  nginx.crt  renew-dummy-cert</span><br><span class="line">ca-bundle.trust.crt  Makefile         nginx.key</span><br></pre></td></tr></table></figure><h4 id="3-创建证书目录和拷贝证书"><a href="#3-创建证书目录和拷贝证书" class="headerlink" title="3. 创建证书目录和拷贝证书"></a>3. 创建证书目录和拷贝证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server certs]# mkdir /etc/nginx/ssl         # 创建存放证书目录</span><br><span class="line">[root@Nginx-Server certs]# cp nginx.* /etc/nginx/ssl/       </span><br><span class="line">[root@Nginx-Server certs]# ls /etc/nginx/ssl/</span><br><span class="line">nginx.crt  nginx.key</span><br></pre></td></tr></table></figure><h4 id="4-修改配置文件"><a href="#4-修改配置文件" class="headerlink" title="4. 修改配置文件"></a>4. 修改配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/conf.d/vhost.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl  default_server ; </span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    gzip on; </span><br><span class="line">    gzip_comp_level 9;</span><br><span class="line">    gzip_min_length 64; </span><br><span class="line">    gzip_proxied any;</span><br><span class="line">    gzip_types text/xml text/css application/javascript ;</span><br><span class="line">        </span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="启动服务，测试"><a href="#启动服务，测试" class="headerlink" title="启动服务，测试"></a>启动服务，测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">nginx: configuration file /etc/nginx/nginx.conf test failed</span><br><span class="line">[root@Nginx-Server ~]# nginx -t </span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line">[root@Nginx-Server ~]# ss -tnul             # 查看端口是否打开</span><br><span class="line">Netid State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">udp   UNCONN     0      0        127.0.0.1:323                          *:*                  </span><br><span class="line">udp   UNCONN     0      0                *:50190                        *:*                  </span><br><span class="line">udp   UNCONN     0      0                *:68                           *:*                  </span><br><span class="line">udp   UNCONN     0      0              ::1:323                         :::*                  </span><br><span class="line">udp   UNCONN     0      0               :::31402                       :::*                  </span><br><span class="line">tcp   LISTEN     0      128              *:80                           *:*                  </span><br><span class="line">tcp   LISTEN     0      128              *:22                           *:*                  </span><br><span class="line">tcp   LISTEN     0      100      127.0.0.1:25                           *:*                  </span><br><span class="line">tcp   LISTEN     0      128              *:443                          *:*                  </span><br><span class="line">tcp   LISTEN     0      128             :::80                          :::*                  </span><br><span class="line">tcp   LISTEN     0      128             :::22                          :::*                  </span><br><span class="line">tcp   LISTEN     0      100            ::1:25                          :::*</span><br></pre></td></tr></table></figure><center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-ssl-module-1.gif" title="测试访问"></center><h3 id="实现多虚拟主机支持https"><a href="#实现多虚拟主机支持https" class="headerlink" title="实现多虚拟主机支持https"></a>实现多虚拟主机支持https</h3><h4 id="1-创建证书-1"><a href="#1-创建证书-1" class="headerlink" title="1. 创建证书"></a>1. 创建证书</h4><p>上面实验已经创建一个虚拟主机了，所以我们就直接用了。这次再创建一个就OK了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# cd /etc/pki/tls/certs/</span><br><span class="line">[root@Nginx-Server certs]# make nginx2.crt</span><br><span class="line">umask 77 ; \</span><br><span class="line">/usr/bin/openssl genrsa -aes128 2048 &gt; nginx2.key</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">.....................+++</span><br><span class="line">........+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">Enter pass phrase:</span><br><span class="line">Verifying - Enter pass phrase:</span><br><span class="line">umask 77 ; \</span><br><span class="line">/usr/bin/openssl req -utf8 -new -key nginx2.key -x509 -days 365 -out nginx2.crt -set_serial 0</span><br><span class="line">Enter pass phrase for nginx2.key:</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:BJ</span><br><span class="line">Locality Name (eg, city) [Default City]:haidian</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:haiyun</span><br><span class="line">Organizational Unit Name (eg, section) []:cto</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:www.b.com</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure></p><h4 id="2-解密私钥-1"><a href="#2-解密私钥-1" class="headerlink" title="2. 解密私钥"></a>2. 解密私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server certs]# openssl rsa -in nginx2.key -out nginx2.key </span><br><span class="line">Enter pass phrase for nginx2.key:</span><br><span class="line">writing RSA key</span><br><span class="line">[root@Nginx-Server certs]# ls</span><br><span class="line">ca-bundle.crt        make-dummy-cert  nginx2.crt  nginx.crt  renew-dummy-cert</span><br><span class="line">ca-bundle.trust.crt  Makefile         nginx2.key  nginx.key</span><br></pre></td></tr></table></figure><h4 id="3-拷贝证书"><a href="#3-拷贝证书" class="headerlink" title="3. 拷贝证书"></a>3. 拷贝证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server certs]# cp nginx2.* /etc/nginx/ssl/</span><br><span class="line">[root@Nginx-Server certs]# ls /etc/nginx/ssl/</span><br><span class="line">nginx2.crt  nginx2.key  nginx.crt  nginx.key</span><br></pre></td></tr></table></figure><h4 id="4-创建访问目录"><a href="#4-创建访问目录" class="headerlink" title="4. 创建访问目录"></a>4. 创建访问目录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# cat /app/website2/index.html         # 注意此文件是需要创建</span><br><span class="line">Nginx-Server --&gt; website2</span><br></pre></td></tr></table></figure><h4 id="5-修改配置文件"><a href="#5-修改配置文件" class="headerlink" title="5. 修改配置文件"></a>5. 修改配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/conf.d/vhost.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl  default_server ; </span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl  ;</span><br><span class="line">    server_name www.b.com ;</span><br><span class="line">    root /app/website2 ;</span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx2.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx2.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-配置hosts文件"><a href="#6-配置hosts文件" class="headerlink" title="6. 配置hosts文件"></a>6. 配置hosts文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# cat /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.140 www.a.com www.b.com</span><br></pre></td></tr></table></figure><h4 id="7-启动服务，测试"><a href="#7-启动服务，测试" class="headerlink" title="7. 启动服务，测试"></a>7. 启动服务，测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line">[root@Nginx-Server ~]# ss -tnul             # 端口已监听</span><br><span class="line">Netid State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line">udp   UNCONN     0      0        127.0.0.1:323                          *:*                  </span><br><span class="line">udp   UNCONN     0      0                *:50190                        *:*                  </span><br><span class="line">udp   UNCONN     0      0                *:68                           *:*                  </span><br><span class="line">udp   UNCONN     0      0              ::1:323                         :::*                  </span><br><span class="line">udp   UNCONN     0      0               :::31402                       :::*                  </span><br><span class="line">tcp   LISTEN     0      128              *:80                           *:*                  </span><br><span class="line">tcp   LISTEN     0      128              *:22                           *:*                  </span><br><span class="line">tcp   LISTEN     0      100      127.0.0.1:25                           *:*                  </span><br><span class="line">tcp   LISTEN     0      128              *:443                          *:*                  </span><br><span class="line">tcp   LISTEN     0      128             :::80                          :::*                  </span><br><span class="line">tcp   LISTEN     0      128             :::22                          :::*                  </span><br><span class="line">tcp   LISTEN     0      100            ::1:25                          :::*      </span><br><span class="line">[root@Nginx-Server ~]# curl -k https://www.a.com/       # 可以访问，ok</span><br><span class="line">Nginx-Server --&gt; website1   </span><br><span class="line">[root@Nginx-Server ~]# curl -k https://www.b.com/       # 可以访问，ok</span><br><span class="line">Nginx-Server --&gt; website2</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块 ngx_http_ssl_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块 ngx_http_ssl_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块 ngx_http_gzip_module</title>
      <link href="/2017/10/26/Nginx-ngx-http-gzip-module/"/>
      <url>/2017/10/26/Nginx-ngx-http-gzip-module/</url>
      <content type="html"><![CDATA[<h3 id="gzip-on-off"><a href="#gzip-on-off" class="headerlink" title="gzip on | off;"></a>gzip on | off;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:gzip on | off;</span><br><span class="line">Default:</span><br><span class="line">gzip off;</span><br><span class="line">Context:http, server, location, if in location</span><br></pre></td></tr></table></figure></p><p><a href="http://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip" target="_blank" rel="noopener">帮助文档：http://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip</a></p><a id="more"></a><ul><li><code>nginx</code>对于代理服务器请求的响应报文，在何种条件下启用压缩功能</li></ul><ul><li><code>off</code>：对被代理的请求不启用压缩</li></ul><ul><li><code>expired,no-cache</code>, <code>no-store</code>， <code>private</code>：对代理服务器请求的响应报文首部<code>Cache-Control</code>值任何一个，启用压缩功能</li></ul><h3 id="gzip-comp-level-level"><a href="#gzip-comp-level-level" class="headerlink" title="gzip_comp_level level;"></a>gzip_comp_level level;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:gzip_comp_level level;</span><br><span class="line">Default:</span><br><span class="line">gzip_comp_level 1;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>指定压缩比，范围是1-9</p><h3 id="gzip-min-length-length"><a href="#gzip-min-length-length" class="headerlink" title="gzip_min_length length;"></a>gzip_min_length length;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:gzip_min_length length;</span><br><span class="line">Default:</span><br><span class="line">gzip_min_length 20;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>指定小于多少字节就取消压缩，因为文件特别小的话，压缩完成后，也许比原文件大，呵呵。</p><h3 id="gzip-proxied-off-expired-…"><a href="#gzip-proxied-off-expired-…" class="headerlink" title="gzip_proxied off | expired …;"></a>gzip_proxied off | expired …;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">句法：gzip_proxied off | expired | no-cache | no-store | private | no_last_modified | no_etag | auth | any ...;</span><br><span class="line">默认：</span><br><span class="line">gzip_proxied关闭</span><br><span class="line">语境：http，server，location</span><br></pre></td></tr></table></figure></p><p>根据请求和响应，启用或禁用代理请求的响应。请求被代理的事实由“Via”请求头字段的存在确定。该指令接受多个参数：</p><h4 id="参数："><a href="#参数：" class="headerlink" title="参数："></a>参数：</h4><ul><li><code>off</code><ul><li>禁用所有代理请求的压缩，忽略其他参数;</li></ul></li><li><code>expired</code><ul><li>如果响应头包含具有禁用缓存的值的<code>“Expires”</code>字段，则启用压缩;</li></ul></li><li><code>no-cache</code> <ul><li>如果响应头包含<code>“Cache-Control”</code>字段和<code>“ no-cache”</code>参数，则启用压缩。</li></ul></li><li><code>no-store</code><ul><li>如果响应头包含<code>“Cache-Control”</code>字段和<code>“ no-store”</code>参数，则启用压缩。</li></ul></li><li><code>private</code><ul><li>如果响应头包含<code>“Cache-Control”</code>字段和<code>“ private”</code>参数，则启用压缩。</li></ul></li><li><code>no_last_modified</code><ul><li>如果响应头不包含<code>“Last-Modified”</code>字段，则启用压缩;</li></ul></li><li><code>no_etag</code><ul><li>如果响应头不包含<code>“ETag”</code>字段，则启用压缩;</li></ul></li><li><code>auth</code><ul><li>如果请求头包含<code>“auth”</code>字段，则启用压缩;</li></ul></li><li><code>any</code><ul><li>为所有代理的请求启用压缩。</li></ul></li></ul><h3 id="gzip-types-mime-type-…"><a href="#gzip-types-mime-type-…" class="headerlink" title="gzip_types mime-type …;"></a>gzip_types mime-type …;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:gzip_types mime-type ...;</span><br><span class="line">Default:</span><br><span class="line">gzip_types text/html;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>Enables gzipping of responses for the specified MIME types in addition to “text/html”. The special value “*” matches any MIME type (0.8.29). Responses with the “text/html” type are always compressed.</p><h4 id="查看Nginx的MIME类型"><a href="#查看Nginx的MIME类型" class="headerlink" title="查看Nginx的MIME类型"></a>查看Nginx的MIME类型</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# cat /etc/nginx/mime.types</span><br><span class="line"></span><br><span class="line">types &#123;</span><br><span class="line">    text/html                             html htm shtml;</span><br><span class="line">    text/css                              css;</span><br><span class="line">    text/xml                              xml;</span><br><span class="line">    image/gif                             gif;</span><br><span class="line">    image/jpeg                            jpeg jpg;</span><br><span class="line">    application/javascript                js;</span><br><span class="line">    application/atom+xml                  atom;</span><br><span class="line">    application/rss+xml                   rss;</span><br><span class="line"></span><br><span class="line">    text/mathml                           mml;</span><br><span class="line">    text/plain                            txt;</span><br><span class="line">    text/vnd.sun.j2me.app-descriptor      jad;</span><br><span class="line">    text/vnd.wap.wml                      wml;</span><br><span class="line">    text/x-component                      htc;</span><br><span class="line"></span><br><span class="line">    image/png                             png;</span><br><span class="line">    image/tiff                            tif tiff;</span><br><span class="line">    image/vnd.wap.wbmp                    wbmp;</span><br><span class="line">    image/x-icon                          ico;</span><br><span class="line">    image/x-jng                           jng;</span><br><span class="line">    image/x-ms-bmp                        bmp;</span><br><span class="line">    image/svg+xml                         svg svgz;</span><br><span class="line">    image/webp                            webp;</span><br><span class="line"></span><br><span class="line">    application/font-woff                 woff;</span><br><span class="line">    application/java-archive              jar war ear;</span><br><span class="line">    application/json                      json;</span><br><span class="line">    application/mac-binhex40              hqx;</span><br><span class="line">    application/msword                    doc;</span><br><span class="line">    application/pdf                       pdf;</span><br><span class="line">    application/postscript                ps eps ai;</span><br><span class="line">    application/rtf                       rtf;</span><br><span class="line">    application/vnd.apple.mpegurl         m3u8;</span><br><span class="line">    application/vnd.ms-excel              xls;</span><br><span class="line">    application/vnd.ms-fontobject         eot;</span><br><span class="line">    application/vnd.ms-powerpoint         ppt;</span><br><span class="line">    application/vnd.wap.wmlc              wmlc;</span><br><span class="line">    application/vnd.google-earth.kml+xml  kml;</span><br><span class="line">    application/vnd.google-earth.kmz      kmz;</span><br><span class="line">    application/x-7z-compressed           7z;</span><br><span class="line">    application/x-cocoa                   cco;</span><br><span class="line">    application/x-java-archive-diff       jardiff;</span><br><span class="line">    application/x-java-jnlp-file          jnlp;</span><br><span class="line">    application/x-makeself                run;</span><br><span class="line">    application/x-perl                    pl pm;</span><br><span class="line">    application/x-pilot                   prc pdb;</span><br><span class="line">    application/x-rar-compressed          rar;</span><br><span class="line">    application/x-redhat-package-manager  rpm;</span><br><span class="line">    application/x-sea                     sea;</span><br><span class="line">    application/x-shockwave-flash         swf;</span><br><span class="line">    application/x-stuffit                 sit;</span><br><span class="line">    application/x-tcl                     tcl tk;</span><br><span class="line">    application/x-x509-ca-cert            der pem crt;</span><br><span class="line">    application/x-xpinstall               xpi;</span><br><span class="line">    application/xhtml+xml                 xhtml;</span><br><span class="line">    application/xspf+xml                  xspf;</span><br><span class="line">    application/zip                       zip;</span><br><span class="line"></span><br><span class="line">    application/octet-stream              bin exe dll;</span><br><span class="line">    application/octet-stream              deb;</span><br><span class="line">    application/octet-stream              dmg;</span><br><span class="line">    application/octet-stream              iso img;</span><br><span class="line">    application/octet-stream              msi msp msm;</span><br><span class="line"></span><br><span class="line">    application/vnd.openxmlformats-officedocument.wordprocessingml.document    docx;</span><br><span class="line">    application/vnd.openxmlformats-officedocument.spreadsheetml.sheet          xlsx;</span><br><span class="line">    application/vnd.openxmlformats-officedocument.presentationml.presentation  pptx;</span><br><span class="line"></span><br><span class="line">    audio/midi                            mid midi kar;</span><br><span class="line">    audio/mpeg                            mp3;</span><br><span class="line">    audio/ogg                             ogg;</span><br><span class="line">    audio/x-m4a                           m4a;</span><br><span class="line">    audio/x-realaudio                     ra;</span><br><span class="line"></span><br><span class="line">    video/3gpp                            3gpp 3gp;</span><br><span class="line">    video/mp2t                            ts;</span><br><span class="line">    video/mp4                             mp4;</span><br><span class="line">    video/mpeg                            mpeg mpg;</span><br><span class="line">    video/quicktime                       mov;</span><br><span class="line">    video/webm                            webm;</span><br><span class="line">    video/x-flv                           flv;</span><br><span class="line">    video/x-m4v                           m4v;</span><br><span class="line">    video/x-mng                           mng;</span><br><span class="line">    video/x-ms-asf                        asx asf;</span><br><span class="line">    video/x-ms-wmv                        wmv;</span><br><span class="line">    video/x-msvideo                       avi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="实现Nginx压缩功能"><a href="#实现Nginx压缩功能" class="headerlink" title="实现Nginx压缩功能"></a>实现Nginx压缩功能</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# mkdir /app/website1</span><br><span class="line">[root@Nginx-Server ~]# ll -h /var/log/messages </span><br><span class="line">-rw-------. 1 root root 568K Oct 26 19:11 /var/log/messages</span><br><span class="line">[root@Nginx-Server ~]# cp /var/log/messages /app/website1/gzip.html &amp;&amp; chmod a+r /app/website1/gzip.html</span><br><span class="line">[root@Nginx-Server ~]# ll -h /app/website1/gzip.html</span><br><span class="line">-rw-r--r-- 1 root root 568K Oct 26 19:16 /app/website1/gzip.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl -I 192.168.8.140/gzip.html      # 直接测试</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Thu, 26 Oct 2017 11:19:24 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 580711  </span><br><span class="line">Last-Modified: Thu, 26 Oct 2017 11:16:58 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;59f1c42a-8dc67&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# ll  /app/website1/gzip.html          # 可以看到，并没有压缩</span><br><span class="line">-rw-r--r-- 1 root root 580711 Oct 26 19:16 /app/website1/gzip.html</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/conf.d/vhost.conf         # 修改配置文件，启用压缩功能</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80 default_server ; </span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    gzip on; </span><br><span class="line">    gzip_comp_level 6;</span><br><span class="line">    gzip_min_length 64; </span><br><span class="line">    gzip_proxied any;</span><br><span class="line">    gzip_types text/xml text/css application/javascript;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line">[root@Nginx-Server ~]# curl -I --compressed 192.168.8.140/gzip.html         # 再次测试</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Thu, 26 Oct 2017 11:27:35 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Last-Modified: Thu, 26 Oct 2017 11:16:58 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: W/&quot;59f1c42a-8dc67&quot;</span><br><span class="line">Content-Encoding: gzip          # 已经压缩</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块 ngx_http_gzip_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块 ngx_http_gzip_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块ngx_http_stub_status_module</title>
      <link href="/2017/10/26/Nginx-ngx-http-stub-status-module/"/>
      <url>/2017/10/26/Nginx-ngx-http-stub-status-module/</url>
      <content type="html"><![CDATA[<h3 id="模块ngx-http-stub-status-module"><a href="#模块ngx-http-stub-status-module" class="headerlink" title="模块ngx_http_stub_status_module"></a>模块ngx_http_stub_status_module</h3><p>用于输出nginx的基本状态信息</p><a id="more"></a><h3 id="实现nginx的基本状态信息"><a href="#实现nginx的基本状态信息" class="headerlink" title="实现nginx的基本状态信息"></a>实现nginx的基本状态信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf </span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    keepalive_requests 1000 ;</span><br><span class="line">    error_page 404 =200 /404.html ; </span><br><span class="line">    keepalive_timeout   100 ;</span><br><span class="line">    location /admin &#123;</span><br><span class="line">        auth_basic &quot;Admin&quot; ;</span><br><span class="line">        auth_basic_user_file /etc/nginx/.passwd ;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    location /status &#123;</span><br><span class="line">    stub_status;</span><br><span class="line">    allow 192.168.8.0/24;</span><br><span class="line">    deny all;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -s stop</span><br><span class="line">[root@centos7 ~]# nginx </span><br><span class="line">[root@centos7 ~]# curl 192.168.8.140/status/</span><br><span class="line">Active connections: 1 </span><br><span class="line">server accepts handled requests</span><br><span class="line"> 1 1 1</span><br></pre></td></tr></table></figure><h3 id="status信息"><a href="#status信息" class="headerlink" title="status信息"></a>status信息</h3><ul><li>Active connections:当前状态，活动状态的连接数</li><li>accepts：统计总值，已经接受的客户端请求的总数</li><li>handled：统计总值，已经处理完成的客户端请求的总数</li><li>requests：统计总值，客户端发来的总的请求数</li><li>Reading：当前状态，正在读取客户端请求报文首部的连接的连接数</li><li>Writing：当前状态，正在向客户端发送响应报文过程中的连接数</li><li>Waiting：当前状态，正在等待客户端发出请求的空闲连接数</li></ul>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块ngx_http_stub_status_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块ngx_http_stub_status_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块 ngx_http_log_module</title>
      <link href="/2017/10/26/Nginx-ngx-http-log-module/"/>
      <url>/2017/10/26/Nginx-ngx-http-log-module/</url>
      <content type="html"><![CDATA[<h3 id="ngx-http-log-module模块"><a href="#ngx-http-log-module模块" class="headerlink" title="ngx_http_log_module模块"></a>ngx_http_log_module模块</h3><p>指定日志格式记录请求</p><h3 id="1、-log-format-name-string-…"><a href="#1、-log-format-name-string-…" class="headerlink" title="1、 log_format name string …;"></a>1、 log_format name string …;</h3><p>string可以使用nginx核心模块及其它模块内嵌的变量</p><a id="more"></a><h3 id="2、-access-log-path-format-buffer-size-gzip-level-flush-time-if-condition"><a href="#2、-access-log-path-format-buffer-size-gzip-level-flush-time-if-condition" class="headerlink" title="2、 access_log path [format [buffer=size] [gzip[=level]][flush=time] [if=condition]];"></a>2、 access_log path [format [buffer=size] [gzip[=level]][flush=time] [if=condition]];</h3><ul><li>access_log off;</li><li>访问日志文件路径，格式及相关的缓冲的配置<ul><li>buffer=size</li><li>flush=time</li></ul></li></ul><h3 id="实现自定义日志"><a href="#实现自定义日志" class="headerlink" title="实现自定义日志"></a>实现自定义日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 注意在http中添加</span><br><span class="line">http &#123;</span><br><span class="line"> log_format test &apos;$remote_addr-$remote_user [$time_local] &apos;</span><br><span class="line">                            &apos;&quot;$request&quot; $status $bytes_sent &apos;</span><br><span class="line">                            &apos;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$gzip_ratio&quot;&apos;;</span><br><span class="line">&#125;</span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf      # 定义日志</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    keepalive_requests 1000 ;</span><br><span class="line">    error_page 404 =200 /404.html ; </span><br><span class="line">    keepalive_timeout   100 ;</span><br><span class="line">    access_log /var/log/nginx/nginx-access.log test buffer=32k ;        # 定义日志的路径和缓冲的配置</span><br><span class="line">    location /admin &#123;</span><br><span class="line">        auth_basic &quot;Admin&quot; ;</span><br><span class="line">        auth_basic_user_file /etc/nginx/.passwd ;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# tail -5 /var/log/nginx/nginx-access.log       # 测试</span><br><span class="line">192.168.8.136-- [25/Oct/2017:17:25:03 +0800] &quot;GET / HTTP/1.1&quot; 200 243 &quot;-&quot; &quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot; &quot;-&quot;</span><br><span class="line">192.168.8.136-- [25/Oct/2017:17:25:03 +0800] &quot;GET / HTTP/1.1&quot; 200 243 &quot;-&quot; &quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot; &quot;-&quot;</span><br><span class="line">192.168.8.136-- [25/Oct/2017:17:25:03 +0800] &quot;GET / HTTP/1.1&quot; 200 243 &quot;-&quot; &quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot; &quot;-&quot;</span><br><span class="line">192.168.8.136-- [25/Oct/2017:17:25:03 +0800] &quot;GET / HTTP/1.1&quot; 200 243 &quot;-&quot; &quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot; &quot;-&quot;</span><br><span class="line">192.168.8.136-- [25/Oct/2017:17:25:03 +0800] &quot;GET / HTTP/1.1&quot; 200 243 &quot;-&quot; &quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure><h3 id="3、-open-log-file-cache-max-N-inactive-time"><a href="#3、-open-log-file-cache-max-N-inactive-time" class="headerlink" title="3、 open_log_file_cache max=N [inactive=time]"></a>3、 open_log_file_cache max=N [inactive=time]</h3><ul><li>[min_uses=N] [valid=time];</li><li>open_log_file_cache off;</li><li>缓存各日志文件相关的元数据信息</li><li>max：缓存的最大文件描述符数量</li><li>min_uses：在inactive指定的时长内访问大于等于此值方</li><li>可被当作活动项<ul><li>inactive：非活动时长</li><li>valid：验正缓存中各缓存项是否为活动项的时间间隔</li></ul></li></ul>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块 ngx_http_log_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块 ngx_http_log_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块 ngx_http_auth_basic_module</title>
      <link href="/2017/10/25/Nginx-http-auth-basic-module/"/>
      <url>/2017/10/25/Nginx-http-auth-basic-module/</url>
      <content type="html"><![CDATA[<h3 id="ngx-http-auth-basic-module模块"><a href="#ngx-http-auth-basic-module模块" class="headerlink" title="ngx_http_auth_basic_module模块"></a>ngx_http_auth_basic_module模块</h3><p>实现基于用户的访问控制，使用basic机制进行用户认证</p><ol><li>auth_basic string | off;</li><li>auth_basic_user_file file;<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location /admin/ &#123;</span><br><span class="line">auth_basic &quot;Admin Area&quot;;</span><br><span class="line">auth_basic_user_file /etc/nginx/.ngxpasswd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><a id="more"></a><h4 id="用户口令："><a href="#用户口令：" class="headerlink" title="用户口令："></a>用户口令：</h4><ol><li>明文文本：格式name:password:comment</li><li>加密文本：由htpasswd命令实现(httpd-tools所提供)</li></ol><h3 id="实现基于用户的访问控制"><a href="#实现基于用户的访问控制" class="headerlink" title="实现基于用户的访问控制"></a>实现基于用户的访问控制</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf      # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    keepalive_requests 1000 ;</span><br><span class="line">    error_page 404 =200 /404.html ; </span><br><span class="line">    keepalive_timeout   100 ;</span><br><span class="line">    location /admin &#123;</span><br><span class="line">        auth_basic &quot;Admin&quot; ;         # 指定提示语</span><br><span class="line">        auth_basic_user_file /etc/nginx/.passwd ;       # 指定密码文件</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# htpasswd -c -m /etc/nginx/.passwd user1       # 创建用户和文件</span><br><span class="line">New password: </span><br><span class="line">Re-type new password: </span><br><span class="line">Adding password for user user1</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -s stop</span><br><span class="line">[root@centos7 ~]# nginx </span><br><span class="line">[root@centos7 ~]# curl 192.168.8.140/admin/     # 访问测试，需要验证</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.10.2&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><center><img src="https://houhaiyun.github.io/img/images/Nginx-http-auth-basic-module-1.gif" title="测试访问"></center>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块 ngx_http_auth_basic_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块 ngx_http_auth_basic_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>模块 ngx_http_access_module</title>
      <link href="/2017/10/25/Nginx-http-access-module/"/>
      <url>/2017/10/25/Nginx-http-access-module/</url>
      <content type="html"><![CDATA[<h3 id="ngx-http-access-module模块"><a href="#ngx-http-access-module模块" class="headerlink" title="ngx_http_access_module模块"></a>ngx_http_access_module模块</h3><p>实现基于ip的访问控制功能</p><a id="more"></a><ol><li>allow address | CIDR | unix: | all;</li><li>deny address | CIDR | unix: | all;<ul><li>http, server, location, limit_except</li><li>自上而下检查，一旦匹配，将生效，条件严格的置前</li></ul></li></ol><h3 id="实现访问控制"><a href="#实现访问控制" class="headerlink" title="实现访问控制"></a>实现访问控制</h3><p>允许192.168.8.128访问/admin目录，其它全部拒绝<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    keepalive_requests 1000 ;</span><br><span class="line">    error_page 404 =200 /404.html ; </span><br><span class="line">    keepalive_timeout   100 ;</span><br><span class="line">    location /admin &#123;</span><br><span class="line">            allow 192.168.8.128/32 ;</span><br><span class="line">            deny all ;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -s stop</span><br><span class="line">[root@centos7 ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ifconfig eth1         # 128测试</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:DE:D2:8C  </span><br><span class="line">          inet addr:192.168.8.128  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fede:d28c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:13630 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:11400 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:8834196 (8.4 MiB)  TX bytes:968772 (946.0 KiB)</span><br><span class="line">[root@centos6 ~]# curl 192.168.8.140/admin/</span><br><span class="line">admin--&gt; Path: /app/admin/admin</span><br><span class="line">    </span><br><span class="line">[root@centos6 ~]# ifconfig eth1     # 其它测试</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:23:DB:AF  </span><br><span class="line">          inet addr:192.168.8.136  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fe23:dbaf/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:290 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:233 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:32163 (31.4 KiB)  TX bytes:31517 (30.7 KiB)</span><br><span class="line">[root@centos6 ~]# curl 192.168.8.140/admin/     # 已经被拒绝</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.10.2&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> 模块 ngx_http_access_module </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模块 ngx_http_access_module </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Nginx配置文件2</title>
      <link href="/2017/10/25/Nginx-configure2/"/>
      <url>/2017/10/25/Nginx-configure2/</url>
      <content type="html"><![CDATA[<h3 id="http协议相关的配置结构"><a href="#http协议相关的配置结构" class="headerlink" title="http协议相关的配置结构"></a>http协议相关的配置结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">    ... 各server的公共配置</span><br><span class="line">    server &#123; 每个server用于定义一个虚拟主机</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        ...</span><br><span class="line">        server_name 虚拟主机名</span><br><span class="line">        root 主目录</span><br><span class="line">        alias 路径别名</span><br><span class="line">        location [OPERATOR] URL &#123; 指定URL的特性</span><br><span class="line">            ...</span><br><span class="line">            if CONDITION &#123;</span><br><span class="line">            ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="核心模块：ngx-http-core-module"><a href="#核心模块：ngx-http-core-module" class="headerlink" title="核心模块：ngx_http_core_module"></a>核心模块：ngx_http_core_module</h3><h3 id="与套接字相关的配置："><a href="#与套接字相关的配置：" class="headerlink" title="与套接字相关的配置："></a>与套接字相关的配置：</h3><h4 id="1-虚拟主机"><a href="#1-虚拟主机" class="headerlink" title="1. 虚拟主机"></a>1. 虚拟主机</h4><h5 id="1-配置一个基于IP的虚拟主机"><a href="#1-配置一个基于IP的虚拟主机" class="headerlink" title="1. 配置一个基于IP的虚拟主机"></a>1. 配置一个基于IP的虚拟主机</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# mkdir /app/wesite&#123;1..3&#125;       # 创建虚拟主机目录</span><br><span class="line">[root@centos7 ~]# ls /app/</span><br><span class="line">wesite1  wesite2  wesite3</span><br><span class="line">[root@centos7 ~]# echo website1 &gt; /app/wesite1/index.html       # 创建虚拟主机测试网页</span><br><span class="line">[root@centos7 ~]# echo website2 &gt; /app/wesite2/index.html</span><br><span class="line">[root@centos7 ~]# echo website3 &gt; /app/wesite3/index.html</span><br><span class="line">[root@centos7 ~]# cd /app/</span><br><span class="line">[root@centos7 app]# tree            # 目录结构如下</span><br><span class="line">.</span><br><span class="line">├── wesite1</span><br><span class="line">│   └── index.html</span><br><span class="line">├── wesite2</span><br><span class="line">│   └── index.html</span><br><span class="line">└── wesite3</span><br><span class="line">    └── index.html</span><br><span class="line"></span><br><span class="line">3 directories, 3 files</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# ifconfig ens34:0 192.168.8.141 up     # 配置虚拟IP</span><br><span class="line">[root@centos7 ~]# ifconfig ens34:1 192.168.8.142 up</span><br><span class="line">[root@centos7 ~]# ifconfig ens34:2 192.168.8.143 up</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# ifconfig          # 查看IP地址</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.140  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::250:56ff:fe37:a834  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 15474  bytes 1341411 (1.2 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 15674  bytes 9744197 (9.2 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.141  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">ens34:1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.142  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">ens34:2: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.143  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 此配置文件是不存在的，需要手动创建。为什么，此配置文件能生效呢？因为此配置文件是include在/etc/nginx/nginx.conf文件中的</span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.141:80 ;</span><br><span class="line">    server_name  _;  </span><br><span class="line">    root         /app/wesite1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.142:80 ;</span><br><span class="line">    server_name  _;  </span><br><span class="line">    root         /app/wesite2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.143:80 ;</span><br><span class="line">    server_name  _;  </span><br><span class="line">    root         /app/wesite3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# curl 192.168.8.141        # 测试访问，ok</span><br><span class="line">website1</span><br><span class="line">[root@centos7 ~]# curl 192.168.8.142</span><br><span class="line">website2</span><br><span class="line">[root@centos7 ~]# curl 192.168.8.143</span><br><span class="line">website3</span><br></pre></td></tr></table></figure><h5 id="2-配置一个基于域名的虚拟主机"><a href="#2-配置一个基于域名的虚拟主机" class="headerlink" title="2. 配置一个基于域名的虚拟主机"></a>2. 配置一个基于域名的虚拟主机</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          #修改配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.140:80 ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root         /app/wesite1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.140:80 ;</span><br><span class="line">    server_name  www.b.com;</span><br><span class="line">    root         /app/wesite2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.140:80 ;</span><br><span class="line">    server_name  www.c.com;</span><br><span class="line">    root         /app/wesite3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# cat /etc/hosts            # 添加hosts文件</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.8.140 www.a.com  www.b.com www.c.com</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -s  stop </span><br><span class="line">[root@centos7 ~]# nginx</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# curl www.a.com        # 测试访问，ok</span><br><span class="line">website1</span><br><span class="line">[root@centos7 ~]# curl www.b.com </span><br><span class="line">website2</span><br><span class="line">[root@centos7 ~]# curl www.c.com </span><br><span class="line">website3</span><br></pre></td></tr></table></figure><h5 id="3-配置一个基于端口的虚拟主机"><a href="#3-配置一个基于端口的虚拟主机" class="headerlink" title="3. 配置一个基于端口的虚拟主机"></a>3. 配置一个基于端口的虚拟主机</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          #修改配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.140:81 ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root         /app/wesite1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.140:82 ;</span><br><span class="line">    server_name  www.b.com;</span><br><span class="line">    root         /app/wesite2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.140:83 ;</span><br><span class="line">    server_name  www.c.com;</span><br><span class="line">    root         /app/wesite3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -t              # 检查配置文件，ok</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@centos7 ~]# nginx -s stop</span><br><span class="line">[root@centos7 ~]# nginx </span><br><span class="line">[root@centos7 ~]# curl 192.168.8.140:81         # 测试访问，ok</span><br><span class="line">website1</span><br><span class="line">[root@centos7 ~]# curl 192.168.8.140:82</span><br><span class="line">website2</span><br><span class="line">[root@centos7 ~]# curl 192.168.8.140:83</span><br><span class="line">website3</span><br></pre></td></tr></table></figure><h4 id="2-listen-PORT"><a href="#2-listen-PORT" class="headerlink" title="2.  listen PORT"></a>2.  listen PORT</h4><p> listen PORT|address[:port]|unix:/PATH/TO/SOCKET_FILE<br>listen address[:port] [default_server] [ssl] [http2 | spdy]<br>[backlog=number] [rcvbuf=size] [sndbuf=size]</p><h5 id="1-default-server-设定为默认虚拟主机"><a href="#1-default-server-设定为默认虚拟主机" class="headerlink" title="1. default_server 设定为默认虚拟主机"></a>1. default_server 设定为默认虚拟主机</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 将上面搭建的虚拟主机的www.a.com设置为虚拟主机</span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改nginx主配置文件</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;         # 主配置文件设置了默认虚拟机，所以我们要将此项删除掉</span><br><span class="line">        server_name  _;  </span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        # Load configuration files for the default server block.</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        location / &#123; </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          #修改配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.140:80 default_server ;          # 将www.a.com设置为虚拟主机</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root         /app/wesite1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.140:80 ;</span><br><span class="line">    server_name  www.b.com;</span><br><span class="line">    root         /app/wesite2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.140:80 ;</span><br><span class="line">    server_name  www.c.com;</span><br><span class="line">    root         /app/wesite3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@centos7 ~]# nginx -s stop</span><br><span class="line">[root@centos7 ~]# nginx         </span><br><span class="line">[root@centos7 ~]# curl 192.168.8.140        # 测试访问，192.168.8.140已经配置为，默认虚拟主机</span><br><span class="line">website1</span><br></pre></td></tr></table></figure><h5 id="2-ssl-限制仅能够通过ssl连接提供服务"><a href="#2-ssl-限制仅能够通过ssl连接提供服务" class="headerlink" title="2. ssl 限制仅能够通过ssl连接提供服务"></a>2. ssl 限制仅能够通过ssl连接提供服务</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          #修改配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl ;      # 使虚拟主机提供ssl加密</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root         /app/wesite1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.140:80 ;</span><br><span class="line">    server_name  www.b.com;</span><br><span class="line">    root         /app/wesite2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       192.168.8.140:80 ;</span><br><span class="line">    server_name  www.c.com;</span><br><span class="line">    root         /app/wesite3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-backlog-number-超过并发连接数后，新请求进入后援队列的长度"><a href="#3-backlog-number-超过并发连接数后，新请求进入后援队列的长度" class="headerlink" title="3. backlog=number 超过并发连接数后，新请求进入后援队列的长度"></a>3. backlog=number 超过并发连接数后，新请求进入后援队列的长度</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rcvbuf=size 接收缓冲区大小</span><br><span class="line">sndbuf=size 发送缓冲区大小</span><br></pre></td></tr></table></figure><h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><ul><li>(1) 基于port；<ul><li>listen PORT; 指令监听在不同的端口</li></ul></li><li>(2) 基于ip的虚拟主机<ul><li>listen IP:PORT; IP 地址不同</li></ul></li><li>(3) 基于hostname<ul><li>server_name fqdn; 指令指向不同的主机名</li></ul></li></ul><h4 id="3-server-name-name"><a href="#3-server-name-name" class="headerlink" title="3.  server_name name"></a>3.  server_name name</h4><ul><li>虚拟主机的主机名称后可跟多个由空白字符分隔的字符串</li><li>支持*通配任意长度的任意字符<ul><li>server_name <em>.magedu.com <a href="http://www.magedu" target="_blank" rel="noopener">www.magedu</a>.</em></li></ul></li><li>支持~起始的字符做正则表达式模式匹配，性能原因慎用<ul><li>server_name ~^www\d+.magedu.com$</li><li>\d 表示 [0-9]</li></ul></li></ul><p><strong>匹配优先级机制从高到低：</strong></p><ul><li>(1) 首先是字符串精确匹配 如： <a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a></li><li>(2) 左侧<em>通配符 如： </em>.magedu.com</li><li>(3) 右侧<em>通配符 如： <a href="http://www.magedu" target="_blank" rel="noopener">www.magedu</a>.</em></li><li>(4) 正则表达式 如： ~^.*.magedu.com$</li><li>(5) default_server</li></ul><h4 id="4-tcp-nodelay-on-off"><a href="#4-tcp-nodelay-on-off" class="headerlink" title="4. tcp_nodelay on | off;"></a>4. tcp_nodelay on | off;</h4><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:sendfile on | off;</span><br><span class="line">Default:</span><br><span class="line">sendfile off;</span><br><span class="line">Context:http, server, location, if in location</span><br></pre></td></tr></table></figure></p><ul><li>在keepalived模式下的连接是否启用TCP_NODELAY选项</li><li>当为off时，延迟发送，合并多个请求后再发送</li><li>默认On时，不延迟发送</li><li>可用于： http, server, location</li><li>此项设置并不建议改为off，延迟发送会降低用户的体验</li></ul><h4 id="5-sendfile-on-off"><a href="#5-sendfile-on-off" class="headerlink" title="5. sendfile on | off;"></a>5. sendfile on | off;</h4><p>是否启用sendfile功能，在内核中封装报文直接发送，默认Off</p><h5 id="启动sendfile"><a href="#启动sendfile" class="headerlink" title="启动sendfile"></a>启动sendfile</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          #修改配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    sendfile on ;</span><br><span class="line">    root         /app/wesite1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-server-tokens-on-off-build-string"><a href="#6-server-tokens-on-off-build-string" class="headerlink" title="6. server_tokens on | off | build | string"></a>6. server_tokens on | off | build | string</h4><p><strong>官网帮助：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:server_tokens on | off | build | string;</span><br><span class="line">Default:</span><br><span class="line">server_tokens on;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure><p>是否在响应报文的Server首部显示nginx版本</p><h5 id="实现隐藏版本号"><a href="#实现隐藏版本号" class="headerlink" title="实现隐藏版本号"></a>实现隐藏版本号</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# curl -I localhost         #我们默认访问是会显示版本号的</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Wed, 25 Oct 2017 00:52:37 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 3700</span><br><span class="line">Last-Modified: Mon, 31 Oct 2016 12:37:02 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;58173aee-e74&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]#  vim /etc/nginx/nginx.conf        # 编辑配置文件，添加到http中隐藏其版本号。</span><br><span class="line">server_tokens off;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -s stop </span><br><span class="line">[root@centos7 ~]# nginx</span><br><span class="line">[root@centos7 ~]# curl -I localhost         # 重启后再次测试</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx           # 已经不再啊显示版本号</span><br><span class="line">Date: Wed, 25 Oct 2017 00:53:18 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 3700</span><br><span class="line">Last-Modified: Mon, 31 Oct 2016 12:37:02 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;58173aee-e74&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure><h3 id="定义路径相关的配置"><a href="#定义路径相关的配置" class="headerlink" title="定义路径相关的配置"></a>定义路径相关的配置</h3><h4 id="1-root"><a href="#1-root" class="headerlink" title="1. root"></a>1. root</h4><p>设置web资源的路径映射；用于指明请求的URL所对应的文档的目录路径，可用于http, server, location, if in location</p><h5 id="定义路径web资源的路径"><a href="#定义路径web资源的路径" class="headerlink" title="定义路径web资源的路径"></a>定义路径web资源的路径</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]#  vim /etc/nginx/nginx.conf        # 编辑配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    sendfile on ;</span><br><span class="line">    root         /app/wesite1;          #定义资源的路径为/app/website1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-location-uri-…"><a href="#2-location-uri-…" class="headerlink" title="2.  location [ = | ~ | ~* | ^~ ] uri { … }"></a>2.  location [ = | ~ | ~* | ^~ ] uri { … }</h4><ul><li><code>location @name { ... }</code></li><li>在一个server中location配置段可存在多个，用于实现从uri到文件系统的路径映射；ngnix会根据用户请求的URI来检查定义的所有location，并找出一个最佳匹配，而后应用其配置</li></ul><h5 id="定义location"><a href="#定义location" class="headerlink" title="定义location"></a>定义location</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# mkdir -p /app/admin/admin         # 创建访问目录</span><br><span class="line">[root@centos7 ~]# echo &quot;admin--&gt; Path: /app/admin/admin&quot; &gt; /app/admin/admin/index.html      # 创建测试页面</span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf      # 编辑配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    location /admin &#123;</span><br><span class="line">        root /app/admin/ ; </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -s stop</span><br><span class="line">[root@centos7 ~]# nginx</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# curl www.a.com/admin/         # 访问的路径是/app/admin/admin</span><br><span class="line">admin--&gt; Path: /app/admin/admin</span><br></pre></td></tr></table></figure><p>由上面的实验可以看出，location中定义的路径是相对于location中的root中所定义的路径的</p><h4 id="3-：对URI做精确匹配；"><a href="#3-：对URI做精确匹配；" class="headerlink" title="3. =：对URI做精确匹配；"></a>3. =：对URI做精确匹配；</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><a href="http://www.magedu.com/" target="_blank" rel="noopener">http://www.magedu.com/</a> 匹配</li><li><a href="http://www.magedu.com/index.html" target="_blank" rel="noopener">http://www.magedu.com/index.html</a> 不匹配</li><li>^~：对URI的最左边部分做匹配检查，不区分字符大小写</li><li>~：对URI做正则表达式模式匹配，区分字符大小写</li><li>~*：对URI做正则表达式模式匹配，不区分字符大小写</li><li>不带符号：匹配起始于此uri的所有的uri</li><li>匹配优先级从高到低：</li><li>=, ^~, ～/～*, 不带符号</li></ul><h5 id="location定义和匹配"><a href="#location定义和匹配" class="headerlink" title="location定义和匹配"></a>location定义和匹配</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80 ;</span><br><span class="line">    service_name www.ihaiyun.cc ; </span><br><span class="line">    location = / &#123;</span><br><span class="line">        [ configuration A ]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        [ configuration B ]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location /documents/ &#123;</span><br><span class="line">        [ configuration C ]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location ^~ /images/ &#123;</span><br><span class="line">        [ configuration D ]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location ~* \.(gif|jpg|jpeg)$ &#123;</span><br><span class="line">        [ configuration E ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面是一段关于location的定义，下面我们来匹配：</p><ul><li><strong>问：</strong> 假如我们访问：<a href="http://www.ihaiyun.cc将会匹配那个呢？" target="_blank" rel="noopener">http://www.ihaiyun.cc将会匹配那个呢？</a></li><li><strong>答：</strong> 当然访问的是<code>configuration A</code>中的内容了。为什么呢？因为：利用排除法来解决此问题，首先我们访问的是/，就把后面的三项都排除了，最后就剩下A和B了。=比不带符号的优先级要高，所以就是A了。</li></ul><ul><li><strong>问：</strong> 假如我们访问：<a href="http://www.ihaiyun.cc/index.html将会匹配那个呢？" target="_blank" rel="noopener">http://www.ihaiyun.cc/index.html将会匹配那个呢？</a></li><li><strong>答：</strong> 当然访问的是<code>configuration B</code>中的内容了。为什么呢？因为：指定了路径。</li></ul><ul><li><strong>问：</strong> 假如我们访问：<a href="http://www.ihaiyun.cc/documents/index.html将会匹配那个呢？" target="_blank" rel="noopener">http://www.ihaiyun.cc/documents/index.html将会匹配那个呢？</a></li><li><strong>答：</strong> 当然访问的是<code>configuration C</code>中的内容了。为什么呢？因为：指定了路径。</li></ul><ul><li><strong>问：</strong> 假如我们访问：<a href="http://www.ihaiyun.cc/documents/images/test.jpg将会匹配那个呢？" target="_blank" rel="noopener">http://www.ihaiyun.cc/documents/images/test.jpg将会匹配那个呢？</a></li><li><strong>答：</strong> 当然访问的是<code>configuration D</code>中的内容了。为什么呢？因为：指定了路径。</li></ul><ul><li><strong>问：</strong> 假如我们访问：<a href="http://www.ihaiyun.cc/documents/test.jpg将会匹配那个呢？" target="_blank" rel="noopener">http://www.ihaiyun.cc/documents/test.jpg将会匹配那个呢？</a></li><li><strong>答：</strong> 当然访问的是<code>configuration E</code>中的内容了。为什么呢？因为：只有E能配置到此URL，且没有比E优先级高的location</li></ul><h4 id="4-alias-path"><a href="#4-alias-path" class="headerlink" title="4.  alias path;"></a>4.  alias path;</h4><p>路径别名，文档映射的另一种机制；仅能用于location上下文</p><h5 id="实现路径别名"><a href="#实现路径别名" class="headerlink" title="实现路径别名"></a>实现路径别名</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf      # 编辑配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    location /ad &#123;</span><br><span class="line">        alias /app/admin/ ;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# echo &quot;admin Path: --&gt; /app/admin&quot; &gt; /app/admin/index.html</span><br><span class="line">[root@centos7 ~]# nginx -s stop</span><br><span class="line">[root@centos7 ~]# nginx</span><br><span class="line">[root@centos7 ~]# curl www.a.com/ad/         # 测试访问可以看到访问的是，/app/admin/</span><br><span class="line">admin Path: --&gt; /app/admin</span><br></pre></td></tr></table></figure><h5 id="alias和root的区别、"><a href="#alias和root的区别、" class="headerlink" title="alias和root的区别、"></a>alias和root的区别、</h5><ul><li>alias：定义了路径别名，别名可以随意定义，别名是不存在的，访问的真实路径为alias后面定义的路径</li><li>root：定义了路径的父路径，父路径和定义的路径组合成为一个完整的路径。</li></ul><p><strong>注意</strong> ： location中使用root指令和alias指令的意义不同</p><ul><li>(a) root，给定的路径对应于location中的/uri/左侧的/</li><li>(b) alias，给定的路径对应于location中的/uri/右侧的/</li></ul><h4 id="5-index-file-…"><a href="#5-index-file-…" class="headerlink" title="5. index file …;"></a>5. index file …;</h4><p>指定默认网页资源，注意： ngx_http_index_module模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 添加默认index.php资源</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    index index.html;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    location /ad &#123;</span><br><span class="line">        alias /app/admin/ ;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="6-error-page-code-…-response-uri"><a href="#6-error-page-code-…-response-uri" class="headerlink" title="6. error_page code … [=[response]] uri;"></a>6. error_page code … [=[response]] uri;</h4><ul><li>模块： ngx_http_core_module</li><li>定义错误页， 以指定的响应状态码进行响应</li><li>可用位置： http, server, location, if in location</li><li>error_page 404 /404.html</li><li>error_page 404 =200 /404.html</li></ul><h5 id="定义错误页面，返回指定结果"><a href="#定义错误页面，返回指定结果" class="headerlink" title="定义错误页面，返回指定结果"></a>定义错误页面，返回指定结果</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    error_page 404 /404.html ;      # 定义访问指定的404错误页面</span><br><span class="line">    location /ad &#123;</span><br><span class="line">        alias /app/admin/ ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">[root@centos7 ~]# echo &quot;页面跑丢了！&quot; &gt; /app/wesite1/404.html       # 创建404界面</span><br><span class="line">[root@centos7 ~]# nginx -s stop</span><br><span class="line">[root@centos7 ~]# nginx         </span><br><span class="line">[root@centos7 ~]# curl www.a.com/asdf.txxt      # 测试访问asdf.txt是不存在的，已经是我们自定义的404页面</span><br><span class="line">页面跑丢了！</span><br><span class="line">[root@centos7 ~]# curl -I  www.a.com/asdf.txxt      # 查看状态码还是404</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Wed, 25 Oct 2017 06:11:03 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 19</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;59f02ad7-13&quot;</span><br></pre></td></tr></table></figure><h5 id="定义错误页面，指定为返回状态码为200-ok"><a href="#定义错误页面，指定为返回状态码为200-ok" class="headerlink" title="定义错误页面，指定为返回状态码为200 ok"></a>定义错误页面，指定为返回状态码为200 ok</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    error_page 404 =200 /404.html ;     # 定义状态码由404转换为200</span><br><span class="line">    location /ad &#123;</span><br><span class="line">        alias /app/admin/ ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -t      </span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@centos7 ~]# nginx -s stop</span><br><span class="line">[root@centos7 ~]# nginx </span><br><span class="line">[root@centos7 ~]# curl www.a.com/asdfkl.asdf        # 测试访问</span><br><span class="line">页面跑丢了！</span><br><span class="line">[root@centos7 ~]# curl -I  www.a.com/asdfkl.asdf        # 查看状态码已经是200，这么做的好处是可以防止浏览器页面劫持</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Wed, 25 Oct 2017 06:19:07 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 19</span><br><span class="line">Last-Modified: Wed, 25 Oct 2017 06:10:31 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;59f02ad7-13&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure><h4 id="7-try-files-file-…-uri"><a href="#7-try-files-file-…-uri" class="headerlink" title="7. try_files file … uri;"></a>7. try_files file … uri;</h4><ul><li><code>try_files file ... =code;</code></li><li>按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示为文件夹），如果所有的文件或文件夹都找不到，会进行一个内部重定向到最后一个参数。只有最后一个参数可以引起一个内部重定向，之前的参数只设置内部URI的指向。最后一个参数是回退URI且必须存在，否则会出现内部500错误</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">location /images/ &#123; try_files $uri /images/default.gif; &#125;</span><br><span class="line">location / &#123; try_files $uri $uri/index.html $uri.html =404; &#125;</span><br></pre></td></tr></table></figure><h5 id="实现目录下找不到文件，返回默认文件"><a href="#实现目录下找不到文件，返回默认文件" class="headerlink" title="实现目录下找不到文件，返回默认文件"></a>实现目录下找不到文件，返回默认文件</h5><p><strong>注：</strong> try_files的文件路径是相对于上面定义的root目录的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf      # 修改配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    location /admin/ &#123;</span><br><span class="line">        try_files $uri /admin/default.html ;        # 指定如果找不到URI中的文件就返回default.html文件</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# mkdir /app/wesite1/admin      # 创建访问目录</span><br><span class="line">[root@centos7 ~]# cd /app/wesite1/admin/</span><br><span class="line">[root@centos7 admin]# ls</span><br><span class="line">default.html  index.html  test.html </span><br><span class="line">[root@centos7 admin]# cat default.html          # 创建三个test文件</span><br><span class="line">This is default file!</span><br><span class="line">[root@centos7 admin]# cat index.html </span><br><span class="line">admin--&gt; Path: /app/admin/admin</span><br><span class="line">[root@centos7 admin]# cat test.html </span><br><span class="line">this is a test file!</span><br><span class="line"></span><br><span class="line">[root@centos7 admin]# nginx -s stop</span><br><span class="line">[root@centos7 admin]# nginx </span><br><span class="line">[root@centos7 admin]# curl www.a.com/admin/         # 测试，此时就需要手动指定默认网页了</span><br><span class="line">This is default file!</span><br><span class="line">[root@centos7 admin]# curl www.a.com/admin/index.html       </span><br><span class="line">admin--&gt; Path: /app/admin/admin</span><br><span class="line">[root@centos7 admin]# curl www.a.com/admin/test.html</span><br><span class="line">this is a test file!</span><br><span class="line">[root@centos7 admin]# curl www.a.com/admin/asdfjlk      # 随便输入一个文件，返回的是默认文件</span><br><span class="line">This is default file!</span><br><span class="line">[root@centos7 admin]# curl www.a.com/admin/s123kjsdfjk</span><br><span class="line">This is default file!</span><br></pre></td></tr></table></figure><h5 id="定义查找多个资源，如果找不到就返回404页面"><a href="#定义查找多个资源，如果找不到就返回404页面" class="headerlink" title="定义查找多个资源，如果找不到就返回404页面"></a>定义查找多个资源，如果找不到就返回404页面</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    error_page 404 =200 /404.html ;         </span><br><span class="line">    </span><br><span class="line">    location /admin/ &#123;</span><br><span class="line">        try_files $uri $uri/index =404;     # 定义了如果第一个uri找不着，就找第二个uri，第二个uri也找不着的话，那么就返回404页面，且状态为成功</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 admin]# nginx -s stop</span><br><span class="line">[root@centos7 admin]# nginx </span><br><span class="line">[root@centos7 admin]# curl www.a.com/admin/index.html       # 页面可以找着是正常的</span><br><span class="line">admin--&gt; Path: /app/admin/admin </span><br><span class="line">[root@centos7 admin]# curl www.a.com/admin/asdfjklasd       # 访问不存在的资源，返回404</span><br><span class="line">页面跑丢了！</span><br><span class="line">[root@centos7 admin]# curl -I  www.a.com/admin/asdfjklasd       # 状态码是200，OK的</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Wed, 25 Oct 2017 07:04:54 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 19</span><br><span class="line">Last-Modified: Wed, 25 Oct 2017 06:10:31 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;59f02ad7-13&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure><h3 id="定义客户端请求的相关配置"><a href="#定义客户端请求的相关配置" class="headerlink" title="定义客户端请求的相关配置"></a>定义客户端请求的相关配置</h3><h4 id="8-keepalive-timeout-timeout-header-timeout"><a href="#8-keepalive-timeout-timeout-header-timeout" class="headerlink" title="8 keepalive_timeout timeout [header_timeout];"></a>8 keepalive_timeout timeout [header_timeout];</h4><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:keepalive_timeout timeout [header_timeout];</span><br><span class="line">Default:</span><br><span class="line">keepalive_timeout 75s;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>设定保持连接超时时长， 0表示禁止长连接， 默认为75s</p><h5 id="测试超时时间"><a href="#测试超时时间" class="headerlink" title="测试超时时间"></a>测试超时时间</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf     # 查看主配置文件，默认就是支持keepalive的，65s</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# date &amp;&amp; telnet 192.168.8.140 80  ; date       # 通过telnet测试</span><br><span class="line">Wed Oct 25 15:15:50 CST 2017</span><br><span class="line">Trying 192.168.8.140...</span><br><span class="line">Connected to 192.168.8.140.</span><br><span class="line">Escape character is &apos;^]&apos;.</span><br><span class="line">GET /index.html HTTP/1.1</span><br><span class="line">HOST: www.a.com</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Wed, 25 Oct 2017 07:16:11 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 9</span><br><span class="line">Last-Modified: Wed, 25 Oct 2017 02:11:13 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;59eff2c1-9&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">website1</span><br><span class="line">Connection closed by foreign host.</span><br><span class="line">Wed Oct 25 15:17:51 CST 2017</span><br></pre></td></tr></table></figure><h4 id="9-keepalive-requests-number"><a href="#9-keepalive-requests-number" class="headerlink" title="9.  keepalive_requests number;"></a>9.  keepalive_requests number;</h4><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:keepalive_requests number;</span><br><span class="line">Default:</span><br><span class="line">keepalive_requests 100;</span><br><span class="line">Context:http, server, location</span><br><span class="line">This directive appeared in version 0.8.0.</span><br></pre></td></tr></table></figure></p><p>在一次长连接上所允许请求的资源的最大数量默认为100</p><h5 id="定义长连接上所允许请求的资源的最大数量默认为1000"><a href="#定义长连接上所允许请求的资源的最大数量默认为1000" class="headerlink" title="定义长连接上所允许请求的资源的最大数量默认为1000"></a>定义长连接上所允许请求的资源的最大数量默认为1000</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 定义长连接最大资源数为1000个，只是为了测试哦</span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    keepalive_requests 1000 ;</span><br><span class="line">    error_page 404 =200 /404.html ; </span><br><span class="line">    keepalive_timeout   100 ;</span><br><span class="line">    location /admin/ &#123;</span><br><span class="line">        try_files $uri $uri/index =404; </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="10-keepalive-disable-none-browser-…"><a href="#10-keepalive-disable-none-browser-…" class="headerlink" title="10. keepalive_disable none | browser …"></a>10. keepalive_disable none | browser …</h4><p><strong>官网帮助</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:keepalive_disable none | browser ...;</span><br><span class="line">Default:</span><br><span class="line">keepalive_disable msie6;</span><br><span class="line">Context:http, server, location</span><br></pre></td></tr></table></figure></p><p>对哪种浏览器禁用长连接</p><h4 id="11-send-timeout-time"><a href="#11-send-timeout-time" class="headerlink" title="11. send_timeout time;"></a>11. send_timeout time;</h4><p>向客户端发送响应报文的超时时长，此处是指两次写操作之间的间隔时长，而非整个响应过程的传输时长    </p><h4 id="12-client-body-buffer-size-size"><a href="#12-client-body-buffer-size-size" class="headerlink" title="12. client_body_buffer_size size;"></a>12. client_body_buffer_size size;</h4><p>用于接收每个客户端请求报文的body部分的缓冲区大小；默认为16k；超出此大小时，其将被暂存到磁盘上的由client_body_temp_path指令所定义的位置</p><h4 id="13-client-body-temp-path-path-level1-level2-level3"><a href="#13-client-body-temp-path-path-level1-level2-level3" class="headerlink" title="13. client_body_temp_path path [level1 [level2[level3]]];"></a>13. client_body_temp_path path [level1 [level2[level3]]];</h4><ul><li>设定用于存储客户端请求报文的body部分的临时存储路径及子目录结构和数量</li><li>目录名为16进制的数字；</li><li>client_body_temp_path /var/tmp/client_body 1 2 2</li><li>1 1级目录占1位16进制，即2^4=16个目录 0-f</li><li>2 2级目录占2位16进制，即2^8=256个目录 00-ff</li><li>2 3级目录占2位16进制， 即2^8=256个目录 00-ff</li></ul><h3 id="对客户端进行限制的相关配置"><a href="#对客户端进行限制的相关配置" class="headerlink" title="对客户端进行限制的相关配置"></a>对客户端进行限制的相关配置</h3><h4 id="1-limit-rate-rate"><a href="#1-limit-rate-rate" class="headerlink" title="1. limit_rate rate;"></a>1. limit_rate rate;</h4><p>限制响应给客户端的传输速率，单位是bytes/second<br>默认值0表示无限制</p><h4 id="2-限制客户端除了GET之外的其它请求方法"><a href="#2-限制客户端除了GET之外的其它请求方法" class="headerlink" title="2. 限制客户端除了GET之外的其它请求方法"></a>2. 限制客户端除了GET之外的其它请求方法</h4><ul><li>limit_except method … { … }，仅用于location</li><li>限制客户端使用除了指定的请求方法之外的其它方法<br>method:GET, HEAD, POST, PUT, DELETE，MKCOL, COPY, MOVE, OPTIONS, PROPFIND,PROPPATCH, LOCK, UNLOCK, PATCH</li></ul><h5 id="实现限制主机使用除了GET之外的其它指令"><a href="#实现限制主机使用除了GET之外的其它指令" class="headerlink" title="实现限制主机使用除了GET之外的其它指令"></a>实现限制主机使用除了GET之外的其它指令</h5><p>实现允许192.168.8.128这台主机使用除了GET之外的其它指令，其它全部拒绝。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf      #修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server ;</span><br><span class="line">    server_name  www.a.com ;</span><br><span class="line">    root        /app/wesite1;</span><br><span class="line">    keepalive_requests 1000 ;</span><br><span class="line">    error_page 404 =200 /404.html ; </span><br><span class="line">    keepalive_timeout   100 ;</span><br><span class="line">    location /admin &#123;</span><br><span class="line">        limit_except GET &#123;</span><br><span class="line">            allow 192.168.8.128/32 ;</span><br><span class="line">            deny all ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -s stop</span><br><span class="line">[root@centos7 ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ifconfig eth1         # 128测试</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:DE:D2:8C  </span><br><span class="line">          inet addr:192.168.8.128  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fede:d28c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:13630 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:11400 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:8834196 (8.4 MiB)  TX bytes:968772 (946.0 KiB)</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# curl -XPUT 192.168.8.140/admin/       # 测试PUT，状态码为：405 其实允许的只是服务器端不支持此方法</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;405 Not Allowed&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;405 Not Allowed&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.10.2&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# curl -XPUT 192.168.8.140/admin/</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.10.2&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ifconfig eth1     # 136测试</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:23:DB:AF  </span><br><span class="line">          inet addr:192.168.8.136  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fe23:dbaf/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:290 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:233 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:32163 (31.4 KiB)  TX bytes:31517 (30.7 KiB)</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# curl -XPUT 192.168.8.140/admin/       # 测试put，状态码为403，已经被拒绝</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.10.2&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><h3 id="文件操作优化的配置"><a href="#文件操作优化的配置" class="headerlink" title="文件操作优化的配置"></a>文件操作优化的配置</h3><h4 id="1-aio-on-off-threads-pool"><a href="#1-aio-on-off-threads-pool" class="headerlink" title="1. aio on | off | threads[=pool];"></a>1. aio on | off | threads[=pool];</h4><p>是否启用aio功能；异步IO</p><h4 id="2-directio-size-off"><a href="#2-directio-size-off" class="headerlink" title="2. directio size | off;"></a>2. directio size | off;</h4><p>同步IO，</p><p>是否同步（直接）写磁盘，而非写缓存，在Linux主机启用O_DIRECT标记， 则文件大于等于给定大小时使用，例如directio 4m</p><h4 id="3-open-file-cache-off"><a href="#3-open-file-cache-off" class="headerlink" title="3. open_file_cache off;"></a>3. open_file_cache off;</h4><ul><li>open_file_cache max=N [inactive=time];</li><li>nginx可以缓存以下三种信息：</li><li>(1) 文件元数据：文件的描述符、文件大小和最近一次的修改时间</li><li>(2) 打开的目录结构</li><li>(3) 没有找到的或者没有权限访问的文件的相关信息</li><li>max=N：可缓存的缓存项上限；达到上限后会使用LRU算法实现管理inactive=time：缓存项的非活动时长，在此处指定的时长内未被命中的或命中的次数少于open_file_cache_min_uses指令所指定的次数的缓存项即为非活动项， 将被删除</li></ul><h4 id="4-open-file-cache-errors-on-off"><a href="#4-open-file-cache-errors-on-off" class="headerlink" title="4. open_file_cache_errors on | off;"></a>4. open_file_cache_errors on | off;</h4><ul><li>是否缓存查找时发生错误的文件一类的信息</li><li>默认值为off</li></ul><h4 id="5-open-file-cache-min-uses-number"><a href="#5-open-file-cache-min-uses-number" class="headerlink" title="5. open_file_cache_min_uses number;"></a>5. open_file_cache_min_uses number;</h4><ul><li>open_file_cache指令的inactive参数指定的时长内，至少被命中此处指定的次数方可被归类为活动项</li><li>默认值为1</li></ul><h4 id="6-open-file-cache-valid-time"><a href="#6-open-file-cache-valid-time" class="headerlink" title="6. open_file_cache_valid time;"></a>6. open_file_cache_valid time;</h4><p>缓存项有效性的检查频率<br>默认值为60s</p>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> Nginx配置文件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx配置文件 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Nginx配置文件</title>
      <link href="/2017/10/25/Nginx-configure/"/>
      <url>/2017/10/25/Nginx-configure/</url>
      <content type="html"><![CDATA[<h3 id="配置文件组成部分"><a href="#配置文件组成部分" class="headerlink" title="配置文件组成部分"></a>配置文件组成部分</h3><ul><li>主配置文件： nginx.conf<ul><li>子配置文件 include conf.d/*.conf</li></ul></li><li>fastcgi， uwsgi， scgi等协议相关的配置文件</li><li>mime.types：支持的mime类型</li></ul><a id="more"></a><h4 id="主配置文件的配置指令"><a href="#主配置文件的配置指令" class="headerlink" title="主配置文件的配置指令"></a>主配置文件的配置指令</h4><p><code>directive value [value2 ...];</code>     (directive：指令)</p><ul><li>注意：</li></ul><ol><li>指令必须以分号结尾</li><li>支持使用配置变量<ul><li>自建变量：由Nginx模块引入，可直接引用</li><li>自定义变量：由用户使用set命令定义<ul><li><code>set variable_name value;</code></li></ul></li><li>引用变量：<code>$variable_name</code></li></ul></li></ol><h3 id="Nginx配置文件"><a href="#Nginx配置文件" class="headerlink" title="Nginx配置文件"></a>Nginx配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">main block：主配置段，即全局配置段，对http,mail都有效</span><br><span class="line">    event &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125; 事件驱动相关的配置</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125; http/https 协议相关配置段</span><br><span class="line"></span><br><span class="line">mail &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125; mail 协议相关配置段</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125; stream 服务器相关配置段</span><br></pre></td></tr></table></figure><h4 id="http协议相关的配置结构"><a href="#http协议相关的配置结构" class="headerlink" title="http协议相关的配置结构"></a>http协议相关的配置结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">    ... 各server的公共配置</span><br><span class="line">    server &#123; 每个server用于定义一个虚拟主机</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        ...</span><br><span class="line">        server_name 虚拟主机名</span><br><span class="line">        root 主目录</span><br><span class="line">        alias 路径别名</span><br><span class="line">        location [OPERATOR] URL &#123; 指定URL的特性</span><br><span class="line">            ...</span><br><span class="line">            if CONDITION &#123;</span><br><span class="line">            ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Nginx全局配置分类："><a href="#Nginx全局配置分类：" class="headerlink" title="Nginx全局配置分类："></a>Nginx全局配置分类：</h3><p><strong>Main全局配置段常见的配置指令分类：</strong></p><ul><li>正常运行必备的配置</li><li>优化性能相关的配置</li><li>用于调试及定位问题相关的配置</li><li>事件驱动相关的配置</li><li>帮助文档<ul><li><a href="http://nginx.org/en/docs/" target="_blank" rel="noopener">http://nginx.org/en/docs/</a></li></ul></li></ul><h3 id="Nginx全局配置main：正常运行必备的配置"><a href="#Nginx全局配置main：正常运行必备的配置" class="headerlink" title="Nginx全局配置main：正常运行必备的配置"></a>Nginx全局配置main：正常运行必备的配置</h3><p><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html" target="_blank" rel="noopener">帮助文档：http://nginx.org/en/docs/http/ngx_http_core_module.html</a></p><h4 id="1-user"><a href="#1-user" class="headerlink" title="1. user"></a>1. user</h4><p><a href="http://nginx.org/en/docs/ngx_core_module.html#user" target="_blank" rel="noopener">官网帮助：http://nginx.org/en/docs/ngx_core_module.html#user</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">官网帮助：如下</span><br><span class="line">Syntax:user user [group];</span><br><span class="line">Default:</span><br><span class="line">user nobody nobody;</span><br><span class="line">Context:main</span><br></pre></td></tr></table></figure></p><p>指定worker进程的运行身份，如组不指定，默认和用户名同名</p><h4 id="2-pid-PATH-TO-PID-FILE"><a href="#2-pid-PATH-TO-PID-FILE" class="headerlink" title="2. pid /PATH/TO/PID_FILE"></a>2. pid /PATH/TO/PID_FILE</h4><p>指定存储nginx主进程PID的文件路径</p><p>yum安装默认的PID文件路径为：<code>pid /run/nginx.pid;</code></p><h5 id="查看PID文件"><a href="#查看PID文件" class="headerlink" title="查看PID文件"></a>查看PID文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# nginx </span><br><span class="line">[root@centos7 ~]# ss -tnul      # 端口已经打开</span><br><span class="line">Netid State      Recv-Q Send-Q Local Address:Port                Peer Address:Port              </span><br><span class="line">udp   UNCONN     0      0          127.0.0.1:323                            *:*                  </span><br><span class="line">tcp   LISTEN     0      128                *:80                             *:*                  </span><br><span class="line">tcp   LISTEN     0      128               :::80                            :::*                  </span><br><span class="line">tcp   LISTEN     0      128               :::22                            :::*                  </span><br><span class="line">[root@centos7 ~]# cat  /run/nginx.pid </span><br><span class="line">11278</span><br><span class="line">[root@centos7 ~]# ps -ef | grep nginx       # 主进程的PID为11278</span><br><span class="line">root      11253   1431  0 22:43 pts/0    00:00:00 vim /etc/nginx/nginx.conf</span><br><span class="line">root      11278      1  0 22:45 ?        00:00:00 nginx: master process nginx</span><br><span class="line">nginx     11279  11278  0 22:45 ?        00:00:00 nginx: worker process</span><br><span class="line">nginx     11280  11278  0 22:45 ?        00:00:00 nginx: worker process</span><br><span class="line">root      11292  11257  0 22:46 pts/1    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure><h4 id="3-include-file-mask"><a href="#3-include-file-mask" class="headerlink" title="3. include file | mask"></a>3. include file | mask</h4><p><a href="http://nginx.org/en/docs/ngx_core_module.html#include" target="_blank" rel="noopener">官网帮助：http://nginx.org/en/docs/ngx_core_module.html#include</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:include file | mask;</span><br><span class="line">Default:—</span><br><span class="line">Context:any</span><br></pre></td></tr></table></figure></p><p>指明包含进来的其它配置文件片断</p><h5 id="指定绝对路径"><a href="#指定绝对路径" class="headerlink" title="指定绝对路径"></a>指定绝对路径</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">include /usr/share/nginx/modules/*.conf;        # 此处就是一个绝对路径</span><br></pre></td></tr></table></figure><h5 id="指定相对路径"><a href="#指定相对路径" class="headerlink" title="指定相对路径"></a>指定相对路径</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf</span><br><span class="line">include vhost/a.conf;           # 此处就是一个绝对路径，这个相对路径是不存在的</span><br><span class="line">[root@centos7 ~]# nginx -t      # 检查配置文件，提示我们配置文件不存在，需要创建，由此我们知道了，nginx是以/etc/nginx/这个目录下作为相对路径的开始</span><br><span class="line">nginx: [emerg] open() &quot;/etc/nginx/vhost/a.conf&quot; failed (2: No such file or directory) in /etc/nginx/nginx.conf:12</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test failed</span><br></pre></td></tr></table></figure><h5 id="相对路径的路径"><a href="#相对路径的路径" class="headerlink" title="相对路径的路径"></a>相对路径的路径</h5><p>yum安装的相对路径的路径为：<code>/etc/nginx/</code></p><h4 id="4-load-module-file"><a href="#4-load-module-file" class="headerlink" title="4. load_module file"></a>4. load_module file</h4><ul><li>模块加载配置文件： <code>/usr/share/nginx/modules/*.conf</code></li><li>指明要装载的动态模块路径: <code>/usr/lib64/nginx/modules</code></li></ul><h5 id="查看-usr-share-nginx-modules下的配置文件"><a href="#查看-usr-share-nginx-modules下的配置文件" class="headerlink" title="查看/usr/share/nginx/modules下的配置文件"></a>查看/usr/share/nginx/modules下的配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 nginx]# ls /usr/share/nginx/modules       # 查看/usr/share/nginx/modules下的配置文件</span><br><span class="line">mod-http-geoip.conf         mod-http-perl.conf         mod-mail.conf</span><br><span class="line">mod-http-image-filter.conf  mod-http-xslt-filter.conf  mod-stream.conf</span><br><span class="line"></span><br><span class="line">[root@centos7 nginx]# cat /usr/share/nginx/modules/mod-mail.conf        # 随便查看一个配置文件，加载了一个模块</span><br><span class="line">load_module &quot;/usr/lib64/nginx/modules/ngx_mail_module.so&quot;;</span><br></pre></td></tr></table></figure><h3 id="Nginx全局配置main：性能优化相关的配置："><a href="#Nginx全局配置main：性能优化相关的配置：" class="headerlink" title="Nginx全局配置main：性能优化相关的配置："></a>Nginx全局配置main：性能优化相关的配置：</h3><h4 id="1-worker-processes-number-auto"><a href="#1-worker-processes-number-auto" class="headerlink" title="1.  worker_processes number | auto"></a>1.  worker_processes number | auto</h4><p><a href="http://nginx.org/en/docs/ngx_core_module.html#worker_processes" target="_blank" rel="noopener">官网帮助：http://nginx.org/en/docs/ngx_core_module.html#worker_processes</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[link](http://note.youdao.com/)</span><br><span class="line">Syntax:worker_processes number | auto;</span><br><span class="line">Default:</span><br><span class="line">worker_processes 1;</span><br><span class="line">Context:main</span><br></pre></td></tr></table></figure></p><p>worker进程的数量；通常应该为当前主机的cpu的物理核心数</p><h5 id="查看当前主机CPU的物理核心数"><a href="#查看当前主机CPU的物理核心数" class="headerlink" title="查看当前主机CPU的物理核心数"></a>查看当前主机CPU的物理核心数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# lscpu | grep &quot;^CPU(s)&quot;</span><br><span class="line">CPU(s):                2</span><br></pre></td></tr></table></figure><h5 id="配置worker-processes-number"><a href="#配置worker-processes-number" class="headerlink" title="配置worker_processes number"></a>配置worker_processes number</h5><ul><li>官网对<code>worker_processes</code> 给出的解释如下：<ul><li><code>最优值取决于许多因素，包括（但不限于）CPU内核数，存储数据的硬盘驱动器数量以及加载模式。当有疑问时，将其设置为可用CPU内核的数量将是一个好的开始（值“ auto”将尝试自动检测它）。</code></li><li>worker进程的数量；通常应该为当前主机的cpu的物理核心数</li></ul></li></ul><p><strong>注意</strong>：下面的实验仅用于实验，具体还得根据情况而定哦！</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# !lscpu        # 查看当前主机CPU的物理核心数</span><br><span class="line">lscpu | grep &quot;^CPU(s)&quot;</span><br><span class="line">CPU(s):                2</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 我们故意将值调大，用于测试哦</span><br><span class="line">worker_processes 4;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -s stop         </span><br><span class="line">[root@centos7 ~]# nginx </span><br><span class="line">[root@centos7 ~]# !ps       # 查看进程开启数量已经开启4个进程</span><br><span class="line">ps -ef | grep nginx</span><br><span class="line">root      11253   1431  0 22:43 pts/0    00:00:00 vim /etc/nginx/nginx.conf</span><br><span class="line">root      11412      1  0 23:24 ?        00:00:00 nginx: master process nginx</span><br><span class="line">nginx     11413  11412  0 23:24 ?        00:00:00 nginx: worker process</span><br><span class="line">nginx     11414  11412  0 23:24 ?        00:00:00 nginx: worker process</span><br><span class="line">nginx     11415  11412  0 23:24 ?        00:00:00 nginx: worker process</span><br><span class="line">nginx     11416  11412  0 23:24 ?        00:00:00 nginx: worker process</span><br><span class="line">root      11418  11257  0 23:24 pts/1    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure><h4 id="2-worker-cpu-affinity-cpumask-…"><a href="#2-worker-cpu-affinity-cpumask-…" class="headerlink" title="2. worker_cpu_affinity cpumask …"></a>2. worker_cpu_affinity cpumask …</h4><p>官网帮助：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:worker_cpu_affinity cpumask ...;</span><br><span class="line">worker_cpu_affinity auto [cpumask];</span><br><span class="line">Default:—</span><br><span class="line">Context:main</span><br></pre></td></tr></table></figure></p><p>将工作流程绑定到一组CPU。每个CPU组由允许的CPU的位掩码表示。应为每个工作进程定义一个单独的集合。默认情况下，工作进程没有绑定到任何特定的CPU。</p><h4 id="CPU-MASK"><a href="#CPU-MASK" class="headerlink" title="CPU MASK"></a>CPU MASK</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CPU MASK： </span><br><span class="line">00000001： 0号CPU</span><br><span class="line">00000010： 1号CPU</span><br><span class="line">00000100： 2号CPU</span><br><span class="line">10000000： 8号CPU</span><br><span class="line">那么n号CPU就是，n后面跟n-1个0</span><br></pre></td></tr></table></figure><h4 id="将workeri进程绑定CPU"><a href="#将workeri进程绑定CPU" class="headerlink" title="将workeri进程绑定CPU"></a>将workeri进程绑定CPU</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">worker_cpu_affinity auto [cpumask] 提高缓存命中率</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;        # 将进程绑定到0号，1号，2号，3号CPU上面</span><br><span class="line">worker_cpu_affinity 0101 1010;          # 将进程绑定到0号和2号 2号和4号CPU上面；</span><br></pre></td></tr></table></figure><h4 id="3-worker-priority-number"><a href="#3-worker-priority-number" class="headerlink" title="3. worker_priority number"></a>3. worker_priority number</h4><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:worker_priority number;</span><br><span class="line">Default:</span><br><span class="line">worker_priority 0;</span><br><span class="line">Context:main</span><br></pre></td></tr></table></figure></p><p>指定worker进程的nice值，设定worker进程优先级： [-20,20]；数越小代表者优先级越高。</p><h5 id="修改worker-priority"><a href="#修改worker-priority" class="headerlink" title="修改worker_priority"></a>修改worker_priority</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">worker_priority -10;</span><br></pre></td></tr></table></figure><h4 id="4-worker-rlimit-nofile-number"><a href="#4-worker-rlimit-nofile-number" class="headerlink" title="4. worker_rlimit_nofile number"></a>4. worker_rlimit_nofile number</h4><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:worker_rlimit_nofile number;</span><br><span class="line">Default:—</span><br><span class="line">Context:main</span><br></pre></td></tr></table></figure></p><p>worker进程所能够打开的文件数量上限,如65535</p><p>变化对打开文件的最大数量的限制（rlimit_nofile）工作流程。用来增加限制而无需重新启动的主要过程。</p><h5 id="修改worker-rlimit-nofile-number"><a href="#修改worker-rlimit-nofile-number" class="headerlink" title="修改worker_rlimit_nofile number"></a>修改worker_rlimit_nofile number</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">worker_rlimit_nofile 65535;</span><br></pre></td></tr></table></figure><h3 id="Nginx事件驱动相关的配置"><a href="#Nginx事件驱动相关的配置" class="headerlink" title="Nginx事件驱动相关的配置"></a>Nginx事件驱动相关的配置</h3><h4 id="1-worker-connections-number"><a href="#1-worker-connections-number" class="headerlink" title="1. worker_connections number"></a>1. worker_connections number</h4><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:worker_connections number;</span><br><span class="line">Default:</span><br><span class="line">worker_connections 512;</span><br><span class="line">Context:events</span><br></pre></td></tr></table></figure></p><p>每个worker进程所能够打开的最大并发连接数数量，如10240</p><p>总最大并发数： worker_processes * worker_connections</p><h5 id="将worker-connections-number调大"><a href="#将worker-connections-number调大" class="headerlink" title="将worker_connections number调大"></a>将worker_connections number调大</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件，将值调为102400</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 10240;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-use-method"><a href="#2-use-method" class="headerlink" title="2. use method"></a>2. use method</h4><p>指明并发连接请求的处理方法,默认自动选择最优方法<br><code>use epoll;</code></p><h5 id="将并发连接请求的处理方法调为epoll"><a href="#将并发连接请求的处理方法调为epoll" class="headerlink" title="将并发连接请求的处理方法调为epoll"></a>将并发连接请求的处理方法调为epoll</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 10240;</span><br><span class="line">    use epoll;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-accept-mutex-on-off-互斥"><a href="#3-accept-mutex-on-off-互斥" class="headerlink" title="3. accept_mutex on | off 互斥"></a>3. accept_mutex on | off 互斥</h4><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:accept_mutex on | off;</span><br><span class="line">Default:</span><br><span class="line">accept_mutex off;</span><br><span class="line">Context:events</span><br></pre></td></tr></table></figure></p><p>处理新的连接请求的方法； on指由各个worker轮流处理新请求，Off指每个新请求的到达都会通知(唤醒)所有的worker进程，但只有一个进程可获得连接，造成“惊群”，影响性能，默认on</p><h5 id="启用accept-mutex"><a href="#启用accept-mutex" class="headerlink" title="启用accept_mutex"></a>启用accept_mutex</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 10240;</span><br><span class="line">    use epoll;</span><br><span class="line">    accept_mutex on ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Nginx：调试和定位问题"><a href="#Nginx：调试和定位问题" class="headerlink" title="Nginx：调试和定位问题"></a>Nginx：调试和定位问题</h3><h4 id="1-daemon-on-off"><a href="#1-daemon-on-off" class="headerlink" title="1. daemon on|off"></a>1. daemon on|off</h4><p>是否以守护进程方式运行nignx，默认是守护进程方式</p><h4 id="修改为非守护进程运行nginx"><a href="#修改为非守护进程运行nginx" class="headerlink" title="修改为非守护进程运行nginx"></a>修改为非守护进程运行nginx</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">daemon off ;</span><br><span class="line">[root@centos7 ~]# nginx -s stop</span><br><span class="line">[root@centos7 ~]# nginx         # 启动nginx就在前台运行了</span><br><span class="line"></span><br><span class="line">^C[root@centos7 ~]#             # Ctrl+C就停止了</span><br></pre></td></tr></table></figure><h4 id="2-master-process-on-off"><a href="#2-master-process-on-off" class="headerlink" title="2. master_process on|off"></a>2. master_process on|off</h4><p>是否以master/worker模型运行nginx；默认为on，off 将不启动worker</p><h5 id="修改nginx不以master-worker模型启动"><a href="#修改nginx不以master-worker模型启动" class="headerlink" title="修改nginx不以master/worker模型启动"></a>修改nginx不以master/worker模型启动</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">master_process off ;</span><br><span class="line">[root@centos7 ~]# nginx             # 只启动了master进程</span><br><span class="line">[root@centos7 ~]# ps -ef | grep nginx</span><br><span class="line">root       2117   2077  0 08:47 pts/0    00:00:00 vim /etc/nginx/nginx.conf</span><br><span class="line">root       2390      1  0 09:42 ?        00:00:00 nginx</span><br><span class="line">root       2392   2120  0 09:43 pts/1    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure><h4 id="3-error-log-file-level"><a href="#3-error-log-file-level" class="headerlink" title="3. error_log file [level]"></a>3. error_log file [level]</h4><p>错误日志文件及其级别；出于调试需要， 可设定为debug；但debug仅在编译时使用了“–with-debug”选项时才有效<br>方式： file /path/logfile;</p><ul><li><p>stderr:发送到标准错误</p><ul><li>syslog:server-address[,parameter=values]:发送到syslog</li></ul></li><li><p>memory:size 内存</p><ul><li>level:debug|info|notice|warn|error|crit|alter|emerg</li></ul></li></ul><h5 id="将日志级别调为debug"><a href="#将日志级别调为debug" class="headerlink" title="将日志级别调为debug"></a>将日志级别调为debug</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">error_log /var/log/nginx/error.log debug ;</span><br><span class="line">[root@centos7 ~]# nginx -s stop </span><br><span class="line">[root@centos7 ~]# nginx </span><br><span class="line">[root@centos7 ~]# tail /var/log/nginx/error.log </span><br><span class="line">2017/10/25 09:55:00 [debug] 2398#0: *2002 free: 00007F5246F24010, unused: 1</span><br><span class="line">2017/10/25 09:55:00 [debug] 2398#0: *2002 free: 00007F5246F25020, unused: 3068</span><br><span class="line">2017/10/25 09:55:00 [debug] 2398#0: *2002 close http connection: 13</span><br><span class="line">2017/10/25 09:55:00 [debug] 2398#0: *2002 event timer del: 13: 1508896505040</span><br><span class="line">2017/10/25 09:55:00 [debug] 2398#0: *2002 reusable connection: 0</span><br><span class="line">2017/10/25 09:55:00 [debug] 2398#0: *2002 free: 00007F5246E759D0</span><br><span class="line">2017/10/25 09:55:00 [debug] 2398#0: *2002 free: 00007F5246EB3040, unused: 128</span><br><span class="line">2017/10/25 09:55:00 [debug] 2398#0: timer delta: 1</span><br><span class="line">2017/10/25 09:55:00 [debug] 2398#0: worker cycle</span><br><span class="line">2017/10/25 09:55:00 [debug] 2398#0: epoll timer: -1</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Nginx </category>
          
          <category> Nginx配置文件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx配置文件 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>LVS调度算法</title>
      <link href="/2017/10/21/Linux-LVS-suanfa/"/>
      <url>/2017/10/21/Linux-LVS-suanfa/</url>
      <content type="html"><![CDATA[<h3 id="LVS的调度算法分为静态与动态两类："><a href="#LVS的调度算法分为静态与动态两类：" class="headerlink" title="LVS的调度算法分为静态与动态两类："></a>LVS的调度算法分为静态与动态两类：</h3><center><img src="https://houhaiyun.github.io/img/images/Linux-LVS-suanfa-1.jpg" title="LVS调度算法"></center><a id="more"></a><h4 id="1-静态算法（4种）：只根据算法进行调度-而不考虑后端服务器的实际连接情况和负载情况"><a href="#1-静态算法（4种）：只根据算法进行调度-而不考虑后端服务器的实际连接情况和负载情况" class="headerlink" title="1.静态算法（4种）：只根据算法进行调度 而不考虑后端服务器的实际连接情况和负载情况"></a>1.静态算法（4种）：只根据算法进行调度 而不考虑后端服务器的实际连接情况和负载情况</h4><blockquote><p>①.RR：轮叫调度（Round Robin）<br>　 调度器通过”轮叫”调度算法将外部请求按顺序轮流分配到集群中的真实服务器上，它均等地对待每一台服务器，而不管服务器上实际的连接数和系统负载｡</p><p>②.WRR：加权轮叫（Weight RR）<br>　 调度器通过“加权轮叫”调度算法根据真实服务器的不同处理能力来调度访问请求。这样可以保证处理能力强的服务器处理更多的访问流量。调度器可以自动问询真实服务器的负载情况,并动态地调整其权值。</p><p>③.DH：目标地址散列调度（Destination Hash ）<br>　 根据请求的目标IP地址，作为散列键(HashKey)从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</p><p>④.SH：源地址 hash（Source Hash）<br>　 源地址散列”调度算法根据请求的源IP地址，作为散列键(HashKey)从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空｡</p></blockquote><h4 id="2-动态算法（6种）：前端的调度器会根据后端真实服务器的实际连接情况来分配请求"><a href="#2-动态算法（6种）：前端的调度器会根据后端真实服务器的实际连接情况来分配请求" class="headerlink" title="2.动态算法（6种）：前端的调度器会根据后端真实服务器的实际连接情况来分配请求"></a>2.动态算法（6种）：前端的调度器会根据后端真实服务器的实际连接情况来分配请求</h4><blockquote><p>①.LC：最少链接（Least Connections）<br>　 调度器通过”最少连接”调度算法动态地将网络请求调度到已建立的链接数最少的服务器上。如果集群系统的真实服务器具有相近的系统性能，采用”最小连接”调度算法可以较好地均衡负载。</p><p>②.WLC：加权最少连接(默认采用的就是这种)（Weighted Least Connections）<br>　 在集群系统中的服务器性能差异较大的情况下，调度器采用“加权最少链接”调度算法优化负载均衡性能，具有较高权值的服务器将承受较大比例的活动连接负载｡调度器可以自动问询真实服务器的负载情况,并动态地调整其权值。</p><p>③.SED：最短延迟调度（Shortest Expected Delay ）<br>　 在WLC基础上改进，Overhead = （ACTIVE+1）*256/加权，不再考虑非活动状态，把当前处于活动状态的数目+1来实现，数目最小的，接受下次请求，+1的目的是为了考虑加权的时候，非活动连接过多缺陷：当权限过大的时候，会倒置空闲服务器一直处于无连接状态。</p><p>④.NQ永不排队/最少队列调度（Never Queue Scheduling NQ）<br>　 无需队列。如果有台 realserver的连接数＝0就直接分配过去，不需要再进行sed运算，保证不会有一个主机很空间。在SED基础上无论+几，第二次一定给下一个，保证不会有一个主机不会很空闲着，不考虑非活动连接，才用NQ，SED要考虑活动状态连接，对于DNS的UDP不需要考虑非活动连接，而httpd的处于保持状态的服务就需要考虑非活动连接给服务器的压力。</p><p>⑤.LBLC：基于局部性的最少链接（locality-Based Least Connections）<br>　 基于局部性的最少链接”调度算法是针对目标IP地址的负载均衡，目前主要用于Cache集群系统｡该算法根据请求的目标IP地址找出该目标IP地址最近使用的服务器，若该服务器是可用的且没有超载，将请求发送到该服务器;若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用“最少链接”的原则选出一个可用的服务器，将请求发送到该服务器｡</p><p>⑥. LBLCR：带复制的基于局部性最少连接（Locality-Based Least Connections with Replication）<br>　 带复制的基于局部性最少链接”调度算法也是针对目标IP地址的负载均衡，目前主要用于Cache集群系统｡它与LBLC算法的不同之处是它要维护从一个目标IP地址到一组服务器的映射，而LBLC算法维护从一个目标IP地址到一台服务器的映射｡该算法根据请求的目标IP地址找出该目标IP地址对应的服务器组，按”最小连接”原则从服务器组中选出一台服务器，若服务器没有超载，将请求发送到该服务器；若服务器超载，则按“最小连接”原则从这个集群中选出一台服务器，将该服务器加入到服务器组中，将请求发送到该服务器｡同时，当该服务器组有一段时间没有被修改，将最忙的服务器从服务器组中删除，以降低复制的程度。</p></blockquote><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://www.178linux.com/13570" target="_blank" rel="noopener">本文来自：Linux运维部落-LVS原理详解</a></p>]]></content>
      
      <categories>
          
          <category> 负载均衡 </category>
          
          <category> LVS调度算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LVS调度算法 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>LVS负载均衡技术</title>
      <link href="/2017/10/21/Linux-LVS/"/>
      <url>/2017/10/21/Linux-LVS/</url>
      <content type="html"><![CDATA[<h3 id="LVS-集群的通用结构"><a href="#LVS-集群的通用结构" class="headerlink" title="LVS 集群的通用结构"></a>LVS 集群的通用结构</h3><p><code>LVS</code>集群采用 <code>IP</code> 负载均衡技术，属于 <code>IP</code> 层的交换（<code>L4</code>） , 具有很好的吞吐率。调度器分析客户端到服务器的 <code>IP</code> 报头信息， 将请求均衡地转移到不同的服务器上执行，且调度器自动屏蔽掉服务器的故障，从而将一组服务器构成一个高性能的、高可用的虚拟服务器， <code>LVS</code> 集群系统的通用结构如图所示， 主要包含四大部分：</p><a id="more"></a><center><img src="https://houhaiyun.github.io/img/images/Linux-LVS-1.jpg" title="LVS 集群的通用结构"></center><p><strong>负载调度器</strong>（<code>load balancer</code>），它是整个集群对外面的前端机，负责将客户的请求发送到一组服务器上执行，而客户认为服务是来自一个 <code>IP</code> 地址上的。当客户请求到达时，调度器只根据负载情况从服务器池中选出一个服务器，将该请求转发到选出的服务器，并记录这个调度；当这个请求的其他报文到达，也会被转发到前面选出的服务器。因为所有的操作都是在操作系统核心空间中将完成的，它的调度开销很小，所以具有很高的吞吐率</p><p><strong>服务器池</strong>（<code>server pool</code>），是一组真正执行客户请求的服务器，执行的任务有<code>WEB</code>、 <code>MAIL</code>、 <code>FTP</code> 和 <code>DNS</code> 等。服务器池的结点数目是可变的， 当整个系统收到的负载超过目前所有结点的处理能力时，可以在服务器池中增加服务器来满足不断增长的请求负载。对大多数网络服务来说，结点与结点间不存在很强的相关性，所以整个系统的性能可以随着服务器池的结点数目增加而线性增长</p><p><strong>后端存储</strong>（<code>backend storage</code>），它为服务器池提供一个共享的存储区，这样很容易使得服务器池拥有相同的内容，提供相同的服务。</p><p><strong><code>Graphic Monitor</code></strong> 是为系统管理员提供整个集群系统的监视器，它可以监视系统中每个结点的状况。</p><h3 id="IP-负载均衡技术"><a href="#IP-负载均衡技术" class="headerlink" title="IP 负载均衡技术"></a>IP 负载均衡技术</h3><p>在已有的 <code>IP</code> 负载均衡技术中有三种（据说还有第四种<code>lvs-fullnat</code>，本文中不会涉及），一是通过网络地址转换实现虚拟服务器的 <code>VS/NAT</code> 技术（<code>Virtual Server via Network Address Translation</code>）， 二是通过直接路由的 <code>VS/DR</code> 技术（<code>Virtual Server via Direct Routing</code>），三是通过 <code>IP</code> 隧道实现虚拟服务器的 <code>VS/TUN</code> 技术（<code>Virtual Server via IP Tunneling</code>）。</p><h3 id="通过NAT实现虚拟服务器（VS-NAT）"><a href="#通过NAT实现虚拟服务器（VS-NAT）" class="headerlink" title="通过NAT实现虚拟服务器（VS/NAT）"></a>通过NAT实现虚拟服务器（VS/NAT）</h3><p><code>VS/NAT</code> 的体系结构如下图所示， 在一组服务器前有一个调度器，它们是通过 Switch 相连接的。这些服务器提供相同的网络服务、相同的内容，即不管请求被发送到哪一台服务器，执行结果是一样的。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-LVS-2.jpg" title="VS/NAT 的体系结构"></center><h4 id="通过如下的VS-NAT配置为例，来了解报文的结构："><a href="#通过如下的VS-NAT配置为例，来了解报文的结构：" class="headerlink" title="通过如下的VS/NAT配置为例，来了解报文的结构："></a>通过如下的VS/NAT配置为例，来了解报文的结构：</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-LVS-3.jpg" title="报文的结构"></center><h3 id="通过直接路由实现虚拟服务器（VS-DR）"><a href="#通过直接路由实现虚拟服务器（VS-DR）" class="headerlink" title="通过直接路由实现虚拟服务器（VS/DR）"></a>通过直接路由实现虚拟服务器（VS/DR）</h3><p>在 <code>VS/NAT</code> 的集群系统中，请求和响应的数据报文都需要通过负载调度器，当真实服务器的数目在 10 台和 20 台之间时，负载调度器将成为整个集群系统的新瓶颈。大多数 <code>Internet</code> 服务都有这样的特点：请求报文较短而响应报文往往含大量的数据。如果能将请求和响应分开处理，即在负载调度器中只负责调度请求而响应直接返回给客户，将极大地提高整个集群系统的吞吐量。 <code>VS/DR</code> 的体系结构如下图所示：调度器和服务器组都必须在物理上有一个网卡通过不分断的局域相连，如通过交换机或者高速的 HUB 相连。 <code>VIP</code> 地址为调度器和服务器组共享，调度器配置的 <code>VIP</code> 地址是对外可见的，用于接收虚拟服务的请求报文；所有的服务器把 <code>VIP</code> 地址配置在各自的 <code>Non-ARP</code> 网络设备上，它对外面是不可见的，只是用于处理目标地址为 <code>VIP</code> 的网络请求。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-LVS-4.jpg" title="通过直接路由实现虚拟服务器（VS/DR）"></center><h4 id="通过如下的VS-DR配置为例，来了解报文的结构："><a href="#通过如下的VS-DR配置为例，来了解报文的结构：" class="headerlink" title="通过如下的VS/DR配置为例，来了解报文的结构："></a>通过如下的VS/DR配置为例，来了解报文的结构：</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-LVS-5.jpg" title="VS/DR配置"></center><h3 id="通过-IP-隧道实现虚拟服务器（VS-TUN）"><a href="#通过-IP-隧道实现虚拟服务器（VS-TUN）" class="headerlink" title="通过 IP 隧道实现虚拟服务器（VS/TUN）"></a>通过 IP 隧道实现虚拟服务器（VS/TUN）</h3><p>跟 <code>VS/DR</code> 方法相同， <code>VS/TUN</code> 多数 <code>Internet</code> 服务的非对称特点，负载调度器中只负责调度请求，而服务器直接将响应返回给客户，可以极大地提高整个集群系统的吞吐量。 <code>IP</code> 隧道（<code>IP tunneling</code>）是将一个 <code>IP</code> 报文封装在另一个 <code>IP</code>报文的技术，这可以使得目标为一个 IP 地址的数据报文能被封装和转发到另一个<code>IP</code> 地址。我们利用 <code>IP</code> 隧道技术将请求报文封装转发给后端服务器，响应报文能从后端服务器直接返回给客户。但在这里，后端服务器有一组而非一个，所以我们不可能静态地建立一一对应的隧道，而是动态地选择一台服务器，将请求报文封装和转发给选出的服务器。这样，我们可以利用 <code>IP</code> 隧道的原理将一组服务器上的网络服务组成在一个 <code>IP</code> 地址上的虚拟网络服务。 <code>VS/TUN</code> 的体系结构如图 3.3 所示，各个服务器将 <code>VIP</code> 地址配置在自己的 <code>IP</code> 隧道设备上。 <code>VS/TUN</code> 的体系结构如图 1.7 所示</p><center><img src="https://houhaiyun.github.io/img/images/Linux-LVS-6.jpg" title="通过 IP 隧道实现虚拟服务器（VS/TUN）"></center><h3 id="三种IP负载均衡技术比较"><a href="#三种IP负载均衡技术比较" class="headerlink" title="三种IP负载均衡技术比较"></a>三种IP负载均衡技术比较</h3><p>三种 IP 负载均衡技术的优缺点归纳在下表中：</p><table><thead><tr><th></th><th>VS/NAT</th><th>VS/DR</th><th>VS/TUN</th></tr></thead><tbody><tr><td>Server</td><td>any</td><td>Non-arp device</td><td>Tunneling</td></tr><tr><td>server network</td><td>private</td><td>LAN</td><td>LAN/WAN</td></tr><tr><td>server number</td><td>low (10~20)</td><td>High (100)</td><td>High (100)</td></tr><tr><td>server gateway</td><td>load balancer</td><td>Own router</td><td>own route</td></tr></tbody></table><p><code>VS/NAT</code> 的<strong>优点</strong>是服务器可以运行任何支持 <code>TCP/IP</code> 的操作系统，它只需要一个 <code>IP</code> 地址配置在调度器上，服务器组可以用私有的 <code>IP</code> 地址。<strong>缺点</strong>是它的伸缩能力有限，当服务器结点数目升到 20 时，调度器本身有可能成为系统的新瓶颈，因为在 <code>VS/NAT</code> 中请求和响应报文都需要通过负载调度器。</p><p><code>VS/DR</code> <strong>优点</strong>是负载调度器可以处理大量的请求， 因为调度器只处理客户到服务器端的连接，响应数据可以直接从独立的网络路由返回给客户， 这可以极大地提高 <code>LVS</code> 集群系统的伸缩性。 <strong>缺点</strong>是要求负载调度器与实际服务器都有块网卡连在同一物理网段上，服务器网络设备（或者设备别名）不作 <code>ARP</code> 响，或者能将报文重定向（<code>Redirec</code>）到本地的 <code>Socket</code> 端口上。</p><p><code>VS/TUN</code> 的<strong>优点</strong>是负载调度器可以处理大量的请求，它甚至可以调度百台以上的服务器（同等规模的服务器），而它不会成为系统的瓶颈，因为负载调度器只请求调度到不同的后端服务器，后端服务器将应答的数据直接返回给用户。<strong>缺点</strong>是 <code>VS/TUN</code> 技术有 <code>IP</code> 隧道的开销并且对服务器有要求，即所有的服务器必须支持“<code>IP Tunneling</code>”或者“<code>IP Encapsulation</code>”协议。</p><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://www.linuxvirtualserver.org/" target="_blank" rel="noopener">本文多数内容来自：LVS 官方站点</a></p>]]></content>
      
      <categories>
          
          <category> 负载均衡 </category>
          
          <category> LVS负载均衡技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LVS负载均衡技术 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>SNAT与DNAT</title>
      <link href="/2017/10/21/Linux-iptables-SNAT/"/>
      <url>/2017/10/21/Linux-iptables-SNAT/</url>
      <content type="html"><![CDATA[<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><h4 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-iptables-SNAT-1.jpg" title="拓扑图"></center><a id="more"></a><h4 id="局域网主机"><a href="#局域网主机" class="headerlink" title="局域网主机"></a>局域网主机</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@LAN-host ~]# ifconfig eth1            # 查看IP</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:DE:D2:8C  </span><br><span class="line">          inet addr:192.168.8.128  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fede:d28c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:154351 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:9823 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:220149822 (209.9 MiB)  TX bytes:959486 (936.9 KiB)</span><br><span class="line">[root@LAN-host ~]# ip route             # 查看路由，配置SNAT、DNAT都需要将忘光指向192.168.8.140</span><br><span class="line">192.168.8.0/24 dev eth1  proto kernel  scope link  src 192.168.8.128 </span><br><span class="line">169.254.0.0/16 dev eth1  scope link  metric 1003 </span><br><span class="line">default via 192.168.8.140 dev eth1</span><br></pre></td></tr></table></figure><h4 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@Firewalld ~]# ifconfig        # 查看IP</span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.18.251.146  netmask 255.255.0.0  broadcast 172.18.255.255</span><br><span class="line">        inet6 fe80::250:56ff:fe34:70b8  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:50:56:34:70:b8  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 106496  bytes 8353964 (7.9 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 493  bytes 42866 (41.8 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.140  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::250:56ff:fe37:a834  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:50:56:37:a8:34  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 4622  bytes 397342 (388.0 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 2833  bytes 324367 (316.7 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1  (Local Loopback)</span><br><span class="line">        RX packets 68  bytes 5876 (5.7 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 68  bytes 5876 (5.7 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@Firewalld ~]# echo 1 &gt; /proc/sys/net/ipv4/ip_forward          # 开启防火墙的路由功能</span><br><span class="line">[root@Firewalld ~]# cat /proc/sys/net/ipv4/ip_forward</span><br><span class="line">1</span><br></pre></td></tr></table></figure><h4 id="互联网主机"><a href="#互联网主机" class="headerlink" title="互联网主机"></a>互联网主机</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@WAN-host ~]# ifconfig ens33           # 查看IP</span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.18.252.112  netmask 255.255.0.0  broadcast 172.18.255.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:242e  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:2e  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 301840  bytes 27336566 (26.0 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 3790  bytes 497705 (486.0 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line">[root@WAN-host ~]# ping 192.168.8.128 -c 1          # 在互联网主机是无法ping通局域网主机的</span><br><span class="line">PING 192.168.8.128 (192.168.8.128) 56(84) bytes of data.</span><br><span class="line"></span><br><span class="line">--- 192.168.8.128 ping statistics ---</span><br><span class="line">1 packets transmitted, 0 received, 100% packet loss, time 0ms</span><br></pre></td></tr></table></figure><h3 id="SNAT策略"><a href="#SNAT策略" class="headerlink" title="SNAT策略"></a>SNAT策略</h3><h4 id="SNAT工作原理"><a href="#SNAT工作原理" class="headerlink" title="SNAT工作原理"></a>SNAT工作原理</h4><p><code>SNAT</code>：<strong>将请求报文的源地址替换为防火墙所定义的源地址。</strong></p><center><img src="https://houhaiyun.github.io/img/images/Linux-iptables-SNAT-2.jpg" title="SNAT工作原理"></center><h4 id="配置SNAT"><a href="#配置SNAT" class="headerlink" title="配置SNAT"></a>配置SNAT</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 访问互联网80端口时，将源IP转换为防火墙的IP</span><br><span class="line"></span><br><span class="line">[root@Firewalld ~]# iptables -t nat -A POSTROUTING -s 192.168.8.0/24 -j SNAT --to-source 172.18.251.146</span><br><span class="line">        # 定义规则：将192.168.8.0网段访问外部IP时，转换为172.18.251.146</span><br><span class="line">[root@Firewalld ~]# iptables -vnL POSTROUTING -t nat </span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    1    84 SNAT       all  --  *      *       192.168.8.0/24       0.0.0.0/0            to:172.18.251.146</span><br><span class="line"></span><br><span class="line">[root@LAN-host ~]# ping -c 2 172.18.252.112         # 在内网主机ping互联网主机，是可以ping通的</span><br><span class="line">PING 172.18.252.112 (172.18.252.112) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.18.252.112: icmp_seq=1 ttl=63 time=0.596 ms</span><br><span class="line">64 bytes from 172.18.252.112: icmp_seq=2 ttl=63 time=1.31 ms</span><br><span class="line"></span><br><span class="line">--- 172.18.252.112 ping statistics ---</span><br><span class="line">2 packets transmitted, 2 received, 0% packet loss, time 1005ms</span><br><span class="line">rtt min/avg/max/mdev = 0.596/0.955/1.314/0.359 ms</span><br><span class="line"></span><br><span class="line">[root@WAN-host ~]# tcpdump -i ens33 icmp -nn        # 通过tcpdump抓包查看，可以看到是172.18.251.146去ping172.18.252.112的</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on ens33, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">22:45:17.891996 IP 172.18.251.146 &gt; 172.18.252.112: ICMP echo request, id 20754, seq 1, length 64</span><br><span class="line">22:45:17.892047 IP 172.18.252.112 &gt; 172.18.251.146: ICMP echo reply, id 20754, seq 1, length 64</span><br><span class="line">22:45:18.894542 IP 172.18.251.146 &gt; 172.18.252.112: ICMP echo request, id 20754, seq 2, length 64</span><br><span class="line">22:45:18.894586 IP 172.18.252.112 &gt; 172.18.251.146: ICMP echo reply, id 20754, seq 2, length 64</span><br><span class="line">^C</span><br><span class="line">4 packets captured</span><br><span class="line">4 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line"></span><br><span class="line">[root@LAN-host ~]# curl 172.18.252.112</span><br><span class="line">www.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">[root@WAN-host ~]# tail -1 /var/log/httpd/access_log       # 查看http服务访问日志，可以看到是172.18.251.146去访问172.18.252.112的 </span><br><span class="line">172.18.251.146 - - [20/Oct/2017:22:47:14 +0800] &quot;GET / HTTP/1.1&quot; 200 15 &quot;-&quot; &quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span><br></pre></td></tr></table></figure><h3 id="拨号SNAT策略"><a href="#拨号SNAT策略" class="headerlink" title="拨号SNAT策略"></a>拨号SNAT策略</h3><p><strong>拨号SNAT策略主要是为了解决通过拨号上网IP地址不固定的状况。拨号SNAT的效率没有固定IP SNAT策略效率高。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 访问互联网80端口时，将源IP转换为防火墙的IP</span><br><span class="line"></span><br><span class="line">[root@Firewalld ~]# iptables -t nat -A POSTROUTING -s 192.168.8.0/24 -j MASQUERADE      # 修改后面为MASQUERADE策略，解决了拨号上网IP不固定的情况</span><br><span class="line">[root@Firewalld ~]# iptables -vnL POSTROUTING -t nat        # 查看nat表</span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    0     0 MASQUERADE  all  --  *      *       192.168.8.0/24       0.0.0.0/0        </span><br><span class="line"></span><br><span class="line">[root@LAN-host ~]# curl 172.18.252.112      # 在局域网主机访问测试</span><br><span class="line">www.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">[root@WAN-host ~]# tail -1 /var/log/httpd/access_log            # 查看日志</span><br><span class="line">172.18.251.146 - - [20/Oct/2017:23:04:32 +0800] &quot;GET / HTTP/1.1&quot; 200 15 &quot;-&quot; &quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;</span><br></pre></td></tr></table></figure><h3 id="DNAT策略"><a href="#DNAT策略" class="headerlink" title="DNAT策略"></a>DNAT策略</h3><h4 id="DNAT工作原理"><a href="#DNAT工作原理" class="headerlink" title="DNAT工作原理"></a>DNAT工作原理</h4><p><code>DNAT</code>：<strong>将请求报文的目标地址替换为防火墙所定义的目标地址。</strong></p><center><img src="https://houhaiyun.github.io/img/images/Linux-iptables-SNAT-3.jpg" title="DNAT工作原理"></center><h4 id="配置DNAT"><a href="#配置DNAT" class="headerlink" title="配置DNAT"></a>配置DNAT</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 将访问防火墙的80端口转发到局域网的80端口</span><br><span class="line"></span><br><span class="line">[root@Firewalld ~]# iptables -t nat -A PREROUTING -s 0/0 -d 0/0 -p tcp --dport 80 -j DNAT --to-destination 192.168.8.128          # 将外网访问防火墙的80端口转发给内网</span><br><span class="line">[root@Firewalld ~]# iptables -vnL -t nat </span><br><span class="line">Chain PREROUTING (policy ACCEPT 1 packets, 207 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    1    60 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:192.168.8.128</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 1 packets, 207 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 1 packets, 60 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">[root@WAN-host ~]# curl 172.18.251.146      # 在互联主机测试访问防火墙的80端口</span><br><span class="line">www.ihaiyun.cc</span><br><span class="line"></span><br><span class="line">[root@LAN-host ~]# tail -1 /var/log/httpd/access_log        # 查看日志</span><br><span class="line">172.18.252.112 - - [20/Oct/2017:13:26:35 +0800] &quot;GET / HTTP/1.1&quot; 200 15 &quot;-&quot; &quot;curl/7.29.0&quot;</span><br></pre></td></tr></table></figure><h3 id="转发REDIRECT"><a href="#转发REDIRECT" class="headerlink" title="转发REDIRECT"></a>转发REDIRECT</h3><p><strong>将访问本地端口请求，转发到本地的其它端口。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 将访问本地1234端口转发到本地的80端口</span><br><span class="line"></span><br><span class="line">[root@Firewalld ~]# iptables -t nat -A PREROUTING -d 0/0 -p tcp --dport 1234 -j REDIRECT --to-port 80       # 基于上面实验的基础，配置端口转发，当访问本地1234端口时就转发到本地的80端口</span><br><span class="line">[root@Firewalld ~]# iptables -vnL -t nat </span><br><span class="line">Chain PREROUTING (policy ACCEPT 105 packets, 19073 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    8   480 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:192.168.8.128</span><br><span class="line">    1    60 REDIRECT   tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:1234 redir ports 80</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 102 packets, 18181 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 4 packets, 304 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 4 packets, 304 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination  </span><br><span class="line"></span><br><span class="line">[root@WAN-host ~]# curl 172.18.251.146:1234         # 可以访问</span><br><span class="line">www.ihaiyun.cc</span><br><span class="line">[root@LAN_host ~]# tail -1 /var/log/httpd/access_log        # 查看访问日志</span><br><span class="line">172.18.252.112 - - [21/Oct/2017:21:36:19 +0800] &quot;GET / HTTP/1.1&quot; 200 15 &quot;-&quot; &quot;curl/7.29.0&quot;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Iptables </category>
          
          <category> SNAT与DNAT </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SNAT与DNAT </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>实现基于SSL的FTPS</title>
      <link href="/2017/10/16/FTP-SSL/"/>
      <url>/2017/10/16/FTP-SSL/</url>
      <content type="html"><![CDATA[<center><img src="https://houhaiyun.github.io/img/images/FTP-SSL-1.jpg" title="ftps"></center><h3 id="查看是否支持SSL"><a href="#查看是否支持SSL" class="headerlink" title="查看是否支持SSL"></a>查看是否支持SSL</h3><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# ldd `which vsftpd`</span><br><span class="line">linux-vdso.so.1 =&gt;  (0x00007fff729c8000)</span><br><span class="line">libssl.so.10 =&gt; /lib64/libssl.so.10 (0x00007f6358444000)</span><br><span class="line">libwrap.so.0 =&gt; /lib64/libwrap.so.0 (0x00007f6358239000)</span><br><span class="line">libnsl.so.1 =&gt; /lib64/libnsl.so.1 (0x00007f635801f000)</span><br><span class="line">libpam.so.0 =&gt; /lib64/libpam.so.0 (0x00007f6357e10000)</span><br><span class="line">libcap.so.2 =&gt; /lib64/libcap.so.2 (0x00007f6357c0b000)</span><br><span class="line">libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f6357a06000)</span><br><span class="line">libcrypto.so.10 =&gt; /lib64/libcrypto.so.10 (0x00007f635761c000)</span><br><span class="line">libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f635725b000)</span><br><span class="line">libgssapi_krb5.so.2 =&gt; /lib64/libgssapi_krb5.so.2 (0x00007f635700c000)</span><br><span class="line">libkrb5.so.3 =&gt; /lib64/libkrb5.so.3 (0x00007f6356d25000)</span><br><span class="line">libcom_err.so.2 =&gt; /lib64/libcom_err.so.2 (0x00007f6356b21000)</span><br><span class="line">libk5crypto.so.3 =&gt; /lib64/libk5crypto.so.3 (0x00007f63568ee000)</span><br><span class="line">libz.so.1 =&gt; /lib64/libz.so.1 (0x00007f63566d8000)</span><br><span class="line">libaudit.so.1 =&gt; /lib64/libaudit.so.1 (0x00007f63564b0000)</span><br><span class="line">libattr.so.1 =&gt; /lib64/libattr.so.1 (0x00007f63562aa000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f63588e4000)</span><br><span class="line">libkrb5support.so.0 =&gt; /lib64/libkrb5support.so.0 (0x00007f635609b000)</span><br><span class="line">libkeyutils.so.1 =&gt; /lib64/libkeyutils.so.1 (0x00007f6355e97000)</span><br><span class="line">libresolv.so.2 =&gt; /lib64/libresolv.so.2 (0x00007f6355c7c000)</span><br><span class="line">libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007f6355a60000)</span><br><span class="line">libcap-ng.so.0 =&gt; /lib64/libcap-ng.so.0 (0x00007f6355859000)</span><br><span class="line">libselinux.so.1 =&gt; /lib64/libselinux.so.1 (0x00007f6355632000)</span><br><span class="line">libpcre.so.1 =&gt; /lib64/libpcre.so.1 (0x00007f63553d1000)</span><br><span class="line">[root@centos7 ~]# ldd `which vsftpd` | grep libssl          # 支持的</span><br><span class="line">libssl.so.10 =&gt; /lib64/libssl.so.10 (0x00007f69c6fe5000)</span><br></pre></td></tr></table></figure><h3 id="创建自签名证书"><a href="#创建自签名证书" class="headerlink" title="创建自签名证书"></a>创建自签名证书</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# cd /etc/pki/tls/certs</span><br><span class="line">[root@centos7 certs]# make vsftpd.pem</span><br><span class="line">umask 77 ; \</span><br><span class="line">PEM1=`/bin/mktemp /tmp/openssl.XXXXXX` ; \</span><br><span class="line">PEM2=`/bin/mktemp /tmp/openssl.XXXXXX` ; \</span><br><span class="line">/usr/bin/openssl req -utf8 -newkey rsa:2048 -keyout $PEM1 -nodes -x509 -days 365 -out $PEM2 -set_serial 0 ; \</span><br><span class="line">cat $PEM1 &gt;  vsftpd.pem ; \</span><br><span class="line">echo &quot;&quot;    &gt;&gt; vsftpd.pem ; \</span><br><span class="line">cat $PEM2 &gt;&gt; vsftpd.pem ; \</span><br><span class="line">rm -f $PEM1 $PEM2</span><br><span class="line">Generating a 2048 bit RSA private key</span><br><span class="line">.........................................+++</span><br><span class="line">.......................................................+++</span><br><span class="line">writing new private key to &apos;/tmp/openssl.7gPwj6&apos;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:haidian</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:haiyun.com</span><br><span class="line">Organizational Unit Name (eg, section) []:opt</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:www.ihaiyun.cc</span><br><span class="line">Email Address []:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 certs]# openssl x509 -in vsftpd.pem -noout -text          # 查看证书</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 0 (0x0)</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: C=CN, ST=beijing, L=haidian, O=haiyun.com, OU=opt, CN=www.ihaiyun.cc</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Oct 13 07:10:13 2017 GMT</span><br><span class="line">            Not After : Oct 13 07:10:13 2018 GMT</span><br><span class="line">        Subject: C=CN, ST=beijing, L=haidian, O=haiyun.com, OU=opt, CN=www.ihaiyun.cc</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:d3:7d:40:95:ed:7b:c1:a2:ed:88:6e:bd:0c:c6:</span><br><span class="line">                    7d:24:d1:5e:b3:f1:d5:9a:ef:6b:83:95:89:13:64:</span><br><span class="line">                    7b:91:12:60:c9<img class="github-emoji" title="cd" alt="cd" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f4bf.png?v8" height="20" width="20">32:ed:2c:fe:48:48:9f:bb:d7:</span><br><span class="line">                    b3:48:5f:b4:5a:1e:74:d1:d1:71:37:e6:7b:9c:bc:</span><br><span class="line">                    df:ce:a4:64:f4:8e:bd:23:0e:13:5d:54:a3:94:90:</span><br><span class="line">                    6c:6f:34:bb:b3:8a:ab:57:f0:95:d0:95:18:1d:24:</span><br><span class="line">                    20:cb:fd:4f:57:9a:62:c6:7c:0e:78:10:3a:9c:56:</span><br><span class="line">                    46:3a:3f:b8:6a:88:d5:c6:43:88:a2:8b:5d:96:d6:</span><br><span class="line">                    a3:7e:8f:47:bb:d5:95:3d:6a:4f:1c:f7:a6:a4:2d:</span><br><span class="line">                    65:7e:c6:23:fd:b4:e5:a8:a5:1a:e4:0f:2c:27:d5:</span><br><span class="line">                    bc:b0:2e:51:50:8e:8f:cf:b9:ea:e6:4c:5c:24:05:</span><br><span class="line">                    d1:76:68:32:3e:23:38:02:81:9d:a2:40:c8:ca:91:</span><br><span class="line">                    b9:ee:4b:e5:bb:75:06:09:7f:9b:47:6e:c3:3f:e1:</span><br><span class="line">                    b4:48:ad:39:c8:7d:ab:a0:61:1c:bb:c5:ba:f5:e2:</span><br><span class="line">                    9c:3e:e4:34:d0:7e:f8:8c:51:0d:e8:0c:c4:66:6f:</span><br><span class="line">                    3a:44:a9:e2:56:be:1e:26:f3:d5:18:0a:86:4e:22:</span><br><span class="line">                    bd:ac:a6:12:25:b6:56:7c:fb:9b:25:02:01:17:e4:</span><br><span class="line">                    a7:7d</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                48:F2:61:FD:CD:29:64:49:18:14:7B:E5:DF:A5:DC:CC:69:1C:44:C4</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:48:F2:61:FD:CD:29:64:49:18:14:7B:E5:DF:A5:DC:CC:69:1C:44:C4</span><br><span class="line"></span><br><span class="line">            X509v3 Basic Constraints: </span><br><span class="line">                CA:TRUE</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         08:a0:5d:34:eb:05:f8:75:f2:15:5e:38:0b:cf:1d:86:7d:8e:</span><br><span class="line">         cb:f9:b5:7e:b3:15:1b:b5:b2:4b:e4:d8:64:09:c4:71:9b:17:</span><br><span class="line">         67:12:7d:24:6b:af:cb:22:6b:08:6f:e9:af:35:5e:54:5f:43:</span><br><span class="line">         38:57:3c:8c:c5:ac:28:43:cf:6c:9b:1e:46:28:e3:6a:05:f3:</span><br><span class="line">         70:0e:d1:26:2e:44:2c:4b:c6:26:70:82:a3:97:f6:fc:ea:1d:</span><br><span class="line">         76:19:f7:96:3d:76:9a:95:19:5b:14:7f:4f:e0:87:18:df:cb:</span><br><span class="line">         79:20:b4:f2:f7:e1:b9:aa:ae:3b:0d:b2:98:e4:76:ee:35:77:</span><br><span class="line">         f3:e4:03:7c:77:47:47:e4:78:6b:1a:45:04:1a:37:ca:f5:58:</span><br><span class="line">         e3:a5:8e:07:31:0d:2c:cc:79:d5:00:1c:85:a5:00:8f:f1:fa:</span><br><span class="line">         20:bb:4e:1e:a0:3a:64:55:d4:76:04:75:85:6d:de:24:bb:54:</span><br><span class="line">         56:bb:62:3d:1b:49:90:36:af:09:3d:df:56:28:e7:c8:f5:e6:</span><br><span class="line">         ee:ca:0f:43:00:c7:1a:f3:d4:56:24:5e:da:73:73:0c:ed:6b:</span><br><span class="line">         d8:82:47:3e:6c:5d:3c:23:03:e4:8d:43:31:e9:c4:c5:df:90:</span><br><span class="line">         79:c3:c9:fb:cd:44:45:8d:27:a7:e6:30:a8:a8:3f:bb:f1:a2:</span><br><span class="line">         ae:c1:f5:a4</span><br></pre></td></tr></table></figure><h3 id="配置vsftpd服务支持SSL"><a href="#配置vsftpd服务支持SSL" class="headerlink" title="配置vsftpd服务支持SSL"></a>配置vsftpd服务支持SSL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">ssl_enable=YES      # 启用SSL</span><br><span class="line">allow_anon_ssl=YES      # 匿名不支持SSL</span><br><span class="line">force_local_logins_ssl=YES      # 本地用户登录加密</span><br><span class="line">force_local_data_ssl=YES        # 本地用户数据传输加密</span><br><span class="line">rsa_cert_file=/etc/pki/tls/certs/vsftpd.pem</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><center><img src="https://houhaiyun.github.io/img/images/FTP-SSL-2.gif" title="测试"></center>]]></content>
      
      <categories>
          
          <category> FTP </category>
          
          <category> 实现基于SSL的FTPS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vsftp </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Vsftp常用配置</title>
      <link href="/2017/10/16/FTP-config/"/>
      <url>/2017/10/16/FTP-config/</url>
      <content type="html"><![CDATA[<center><img src="https://houhaiyun.github.io/img/images/FTP-config-1.png" title="vsftp"></center><h3 id="Vsftpd"><a href="#Vsftpd" class="headerlink" title="Vsftpd"></a>Vsftpd</h3><p><code>vsftpd</code>:<code>Very Secure FTP Daemon</code>， <code>CentOS</code>默认FTP服务器。</p><a id="more"></a><ul><li>用户认证配置文件:<code>/etc/pam.d/vsftpd</code></li><li>服务脚本： <code>/usr/lib/systemd/system/vsftpd.service</code> <code>/etc/rc.d/init.d/vsftpd</code></li><li>配置文件:<code>/etc/vsftpd/vsftpd.conf</code><ul><li><code>man 5 vsftpd.conf</code></li><li>格式： <code>option=value</code></li><li>注意： <code>=</code>前后不要有空格</li></ul></li><li>匿名用户（映射为系统用户<code>ftp</code> ）共享文件位置： <code>/var/ftp</code></li><li>系统用户共享文件位置：用户家目录</li><li>虚拟用户共享文件位置：为其映射的系统用户的家目录</li></ul><h3 id="Vsftpd服务配置"><a href="#Vsftpd服务配置" class="headerlink" title="Vsftpd服务配置"></a>Vsftpd服务配置</h3><h3 id="命令端口"><a href="#命令端口" class="headerlink" title="命令端口"></a>命令端口</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# systemctl start vsftpd        # 启动vsftpd服务</span><br><span class="line">[root@centos7 ~]# ss -tnul          # 默认开启端口为21</span><br><span class="line">Netid  State      Recv-Q Send-Q Local Address:Port                Peer Address:Port              </span><br><span class="line">udp    UNCONN     0      0          127.0.0.1:323                            *:*                  </span><br><span class="line">udp    UNCONN     0      0                  *:27830                          *:*                  </span><br><span class="line">udp    UNCONN     0      0                  *:68                             *:*                  </span><br><span class="line">udp    UNCONN     0      0                ::1:323                           :::*                  </span><br><span class="line">udp    UNCONN     0      0                 :::61443                         :::*                  </span><br><span class="line">tcp    LISTEN     0      128                *:22                             *:*                  </span><br><span class="line">tcp    LISTEN     0      100        127.0.0.1:25                             *:*                  </span><br><span class="line">tcp    LISTEN     0      80                :::3306                          :::*                  </span><br><span class="line">tcp    LISTEN     0      32                :::21                            :::*                  </span><br><span class="line">tcp    LISTEN     0      128               :::22                            :::*                  </span><br><span class="line">tcp    LISTEN     0      100              ::1:25                            :::*     </span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# cp /etc/vsftpd/vsftpd.conf /etc/vsftpd/vsftpd.conf.bak      # 备份配置文件</span><br><span class="line">[root@centos7 ~]# cd /etc/vsftpd/</span><br><span class="line">[root@centos7 vsftpd]# ls</span><br><span class="line">ftpusers  user_list  vsftpd.conf  vsftpd.conf.bak  vsftpd_conf_migrate.sh</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# vim vsftpd.conf      # 修改配置文件把端口修改为123</span><br><span class="line">listen_port=123             # 添加此行</span><br><span class="line">[root@centos7 vsftpd]# systemctl restart vsftpd</span><br><span class="line">[root@centos7 vsftpd]# ss -tnul </span><br><span class="line">Netid  State      Recv-Q Send-Q Local Address:Port                Peer Address:Port              </span><br><span class="line">udp    UNCONN     0      0          127.0.0.1:323                            *:*                  </span><br><span class="line">udp    UNCONN     0      0                  *:27830                          *:*                  </span><br><span class="line">udp    UNCONN     0      0                  *:68                             *:*                  </span><br><span class="line">udp    UNCONN     0      0                ::1:323                           :::*                  </span><br><span class="line">udp    UNCONN     0      0                 :::61443                         :::*                  </span><br><span class="line">tcp    LISTEN     0      128                *:22                             *:*                  </span><br><span class="line">tcp    LISTEN     0      100        127.0.0.1:25                             *:*                  </span><br><span class="line">tcp    LISTEN     0      80                :::3306                          :::*                  </span><br><span class="line">tcp    LISTEN     0      128               :::22                            :::*                  </span><br><span class="line">tcp    LISTEN     0      100              ::1:25                            :::*                  </span><br><span class="line">tcp    LISTEN     0      32                :::123                           :::*</span><br></pre></td></tr></table></figure><h3 id="主动和被动模式"><a href="#主动和被动模式" class="headerlink" title="主动和被动模式"></a>主动和被动模式</h3><h4 id="配置文件：主动模式端口"><a href="#配置文件：主动模式端口" class="headerlink" title="配置文件：主动模式端口"></a>配置文件：主动模式端口</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">connect_from_port_20=YES 主动模式端口为20</span><br><span class="line">ftp_data_port=20 指定主动模式的端口</span><br></pre></td></tr></table></figure><h4 id="实现主动模式端口"><a href="#实现主动模式端口" class="headerlink" title="实现主动模式端口"></a>实现主动模式端口</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# cd /var/ftp/pub/              # 现在ftp服务器上面创建一个大文件</span><br><span class="line">[root@centos7 ftp]# dd if=/dev/zero of=f1 bs=1G count=1</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB) copied, 15.2404 s, 70.5 MB/s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140         # 使用gcentos6区连接ftp服务器</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): ftp              # 使用匿名账户</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; ls             # 列出</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,42,104).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">-rw-r--r--    1 0        0        1073741824 Oct 13 01:26 f1</span><br><span class="line">drwxr-xr-x    2 0        0               6 Nov 05  2016 pub</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; ?          # 查看帮助</span><br><span class="line">Commands may be abbreviated.  Commands are:</span><br><span class="line"></span><br><span class="line">!debugmdirsendportsite</span><br><span class="line">$dirmgetputsize</span><br><span class="line">accountdisconnectmkdirpwdstatus</span><br><span class="line">appendexitmlsquitstruct</span><br><span class="line">asciiformmodequotesystem</span><br><span class="line">bellgetmodtimerecvsunique</span><br><span class="line">binaryglobmputregettenex</span><br><span class="line">byehashnewerrstatustick</span><br><span class="line">casehelpnmaprhelptrace</span><br><span class="line">cdidlenlistrenametype</span><br><span class="line">cdupimagentransresetuser</span><br><span class="line">chmodlcdopenrestartumask</span><br><span class="line">closelspromptrmdirverbose</span><br><span class="line">crmacdefpassiverunique?</span><br><span class="line">deletemdeleteproxysend</span><br><span class="line">ftp&gt; passive            # 关闭被动模式，就相当于开启主动模式</span><br><span class="line">Passive mode off.</span><br><span class="line">ftp&gt; get f1         # 下载f1文件</span><br><span class="line">local: f1 remote: f1</span><br><span class="line">200 PORT command successful. Consider using PASV.</span><br><span class="line">150 Opening BINARY mode data connection for f1 (1073741824 bytes).</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# netstat -anp | grep ftp          # 回到ftp服务器上面查看，已经打开20端口传输数据</span><br><span class="line">tcp6       0      0 :::21                   :::*                    LISTEN      2186/vsftpd         </span><br><span class="line">tcp6       0 4039920 192.168.8.140:20        192.168.8.128:46817     ESTABLISHED 2222/vsftpd         </span><br><span class="line">tcp6       0      0 192.168.8.140:21        192.168.8.128:35124     ESTABLISHED 2220/vsftpd         </span><br><span class="line">unix  3      [ ]         STREAM     CONNECTED     20963    2220/vsftpd          </span><br><span class="line">unix  3      [ ]         STREAM     CONNECTED     20964    2222/vsftpd          </span><br><span class="line">unix  2      [ ]         DGRAM                    21608    2220/vsftpd</span><br></pre></td></tr></table></figure><h4 id="使用主动模式的端口为123"><a href="#使用主动模式的端口为123" class="headerlink" title="使用主动模式的端口为123"></a>使用主动模式的端口为123</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 vsftpd]# vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line">ftp_data_port=123       # 修改主动模式的端口为123</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140         # 再次连接ftp服务器</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): ftp</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; passive        # 开启主动模式</span><br><span class="line">Passive mode off.</span><br><span class="line">ftp&gt; get f1 </span><br><span class="line">local: f1 remote: f1</span><br><span class="line">200 PORT command successful. Consider using PASV.</span><br><span class="line">150 Opening BINARY mode data connection for f1 (1073741824 bytes).</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# netstat -anp | grep ftp      # 查看数据传输端口已经为123</span><br><span class="line">tcp6       0      0 :::21                   :::*                    LISTEN      2248/vsftpd         </span><br><span class="line">tcp6       0      0 192.168.8.140:21        192.168.8.128:35126     ESTABLISHED 2249/vsftpd         </span><br><span class="line">tcp6       0 3601472 192.168.8.140:123       192.168.8.128:39712     ESTABLISHED 2251/vsftpd         </span><br><span class="line">unix  3      [ ]         STREAM     CONNECTED     22784    2249/vsftpd          </span><br><span class="line">unix  2      [ ]         DGRAM                    21760    2249/vsftpd          </span><br><span class="line">unix  3      [ ]         STREAM     CONNECTED     22785    2251/vsftpd</span><br></pre></td></tr></table></figure><h4 id="被动模式端口范围"><a href="#被动模式端口范围" class="headerlink" title="被动模式端口范围"></a>被动模式端口范围</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">linux客户端默认使用被动模式</span><br><span class="line">windows 客户端默认使用主动模式</span><br><span class="line">pasv_min_port=6000 0为随机分配</span><br><span class="line">pasv_max_port=6010</span><br></pre></td></tr></table></figure><h4 id="使用被动模式传输"><a href="#使用被动模式传输" class="headerlink" title="使用被动模式传输"></a>使用被动模式传输</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# !ftp          # 直接访问ftp服务器</span><br><span class="line">ftp 192.168.8.140</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): ftp</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; ls</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,193,204).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">-rw-r--r--    1 0        0        1073741824 Oct 13 01:26 f1</span><br><span class="line">drwxr-xr-x    2 0        0               6 Nov 05  2016 pub</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; get f1         # 下载f1文件</span><br><span class="line">local: f1 remote: f1</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,78,255).</span><br><span class="line">150 Opening BINARY mode data connection for f1 (1073741824 bytes).</span><br><span class="line">    </span><br><span class="line">[root@centos7 vsftpd]# netstat -anp | grep ftp      # 在centos7上面查看开启的端口是随机开启的</span><br><span class="line">tcp6       0      0 :::21                   :::*                    LISTEN      2271/vsftpd         </span><br><span class="line">tcp6       0      0 192.168.8.140:20223     :::*                    LISTEN      2272/vsftpd         </span><br><span class="line">tcp6       0 3714120 192.168.8.140:20223     192.168.8.128:44845     ESTABLISHED 2274/vsftpd         </span><br><span class="line">tcp6       0      0 192.168.8.140:21        192.168.8.128:35128     ESTABLISHED 2272/vsftpd</span><br><span class="line"></span><br><span class="line">ftp&gt; !rm -f f1      # 删除本地文件f1，加上!可以执行本地命令</span><br><span class="line">ftp&gt; get f1         # 下载f1文件</span><br><span class="line">local: f1 remote: f1</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,73,74).</span><br><span class="line">150 Opening BINARY mode data connection for f1 (1073741824 bytes).</span><br><span class="line">226 Transfer complete.</span><br><span class="line">1073741824 bytes received in 6.76 secs (158891.58 Kbytes/sec)</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# netstat -anp | grep ftp          # 查看端口是随机打开的</span><br><span class="line">tcp6       0      0 192.168.8.140:18762     :::*                    LISTEN      2272/vsftpd         </span><br><span class="line">tcp6       0      0 :::21                   :::*                    LISTEN      2271/vsftpd         </span><br><span class="line">tcp6       0 3991160 192.168.8.140:18762     192.168.8.128:58139     ESTABLISHED 2274/vsftpd         </span><br><span class="line">tcp6       0      0 192.168.8.140:21        192.168.8.128:35128     ESTABLISHED 2272/vsftpd</span><br></pre></td></tr></table></figure><h4 id="指定被动模式端口范围"><a href="#指定被动模式端口范围" class="headerlink" title="指定被动模式端口范围"></a>指定被动模式端口范围</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 vsftpd]# vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">pasv_min_port=8000      # 最小端口为8000</span><br><span class="line">pasv_max_port=8001      # 最大端口为8001</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# !sys         #重启服务让其生效</span><br><span class="line">systemctl restart vsftpd</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# !ftp          # 连接下载数据</span><br><span class="line">ftp 192.168.8.140</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): ftp</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; get f1</span><br><span class="line">local: f1 remote: f1</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,31,65).</span><br><span class="line">150 Opening BINARY mode data connection for f1 (1073741824 bytes).</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# netstat -anp | grep ftp      # 查看端口已经是我们打开的8001</span><br><span class="line">tcp6       0      0 :::21                   :::*                    LISTEN      2289/vsftpd         </span><br><span class="line">tcp6       0      0 192.168.8.140:8001      :::*                    LISTEN      2291/vsftpd         </span><br><span class="line">tcp6       0 3844440 192.168.8.140:8001      192.168.8.128:39485     ESTABLISHED 2293/vsftpd         </span><br><span class="line">tcp6       0      0 192.168.8.140:21        192.168.8.128:35130     ESTABLISHED 2291/vsftpd</span><br></pre></td></tr></table></figure><h3 id="使用当地时间"><a href="#使用当地时间" class="headerlink" title="使用当地时间"></a>使用当地时间</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 vsftpd]# vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">use_localtime=YES     # 使用当地时间（默认为NO，使用GMT）</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# !sys</span><br><span class="line">systemctl restart vsftpd</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): ftp</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; ls         # 看的不是特别明显，因为原来时间就是对的</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,169,47).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">-rw-r--r--    1 0        0        1073741824 Oct 13 09:26 f1</span><br><span class="line">drwxr-xr-x    2 0        0               6 Nov 06  2016 pub</span><br><span class="line">226 Directory send OK.</span><br></pre></td></tr></table></figure><h3 id="匿名用户"><a href="#匿名用户" class="headerlink" title="匿名用户"></a>匿名用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">anonymous_enable=YES 支持匿名用户</span><br><span class="line">no_anon_password=YES(默认NO) 匿名用户略过口令检查</span><br><span class="line">anon_world_readable_only (默认YES)只能下载全部读的文件</span><br><span class="line">anon_upload_enable=YES 匿名上传，注意:文件系统权限</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">anon_other_write_enable=YES 可删除和修改上传的文件</span><br><span class="line">anon_umask=077 指定匿名上传umask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chown_uploads=YES(默认NO)</span><br><span class="line">chown_username=wang     指定上传文件的默认的所有者</span><br><span class="line">chown_upload_mode=0644  指定上传文件的默认的权限</span><br></pre></td></tr></table></figure><h4 id="使匿名可以用户上传文件"><a href="#使匿名可以用户上传文件" class="headerlink" title="使匿名可以用户上传文件"></a>使匿名可以用户上传文件</h4><p>解决方法为：</p><ol><li>修改配置文件使匿名用户可以上传和创建文件</li><li>因为ftp默认是不支持登陆根就有w权限的，所以在ftp创建一个可以上传的目录，并对其设置ACL，让其拥有rwx权限，就可以了。</li><li>ftp上传文件需要注意：文件系统上面的权限和vsftpd上面配置的权限。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# dd if=/dev/zero of=f2 bs=1G count=1       # 先创建一个测试文件f2</span><br><span class="line">1+0 records in</span><br><span class="line">1+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB) copied, 14.6191 s, 73.4 MB/s</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140             # 连接ftp</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): ftp</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; ls</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,176,223).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">-rw-r--r--    1 0        0        1073741824 Oct 13 01:26 f1</span><br><span class="line">drwxr-xr-x    2 0        0               6 Nov 05  2016 pub</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; put f2         # 传输文件失败，权限被拒绝</span><br><span class="line">local: f2 remote: f2</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,173,117).</span><br><span class="line">550 Permission denied.      </span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# vim /etc/vsftpd/vsftpd.conf      # 修改配置文件</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# !sys</span><br><span class="line">systemctl restart vsftpd</span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): ftp</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; put f2         # 上传还是失败</span><br><span class="line">local: f2 remote: f2</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,122,54).</span><br><span class="line">550 Permission denied.</span><br><span class="line"></span><br><span class="line">[root@centos7 ftp]# setfacl -m u:ftp:rwx pub        # 使ftp用户对pub目录拥有rwx权限</span><br><span class="line">[root@centos7 ftp]# ll</span><br><span class="line">total 1048576</span><br><span class="line">-rw-r--r--  1 root root 1073741824 Oct 13 09:26 f1</span><br><span class="line">drwxrwxr-x+ 2 root root          6 Oct 13 10:51 pub</span><br><span class="line">[root@centos7 ftp]# getfacl pub</span><br><span class="line"># file: pub</span><br><span class="line"># owner: root</span><br><span class="line"># group: root</span><br><span class="line">user::rwx</span><br><span class="line">user:ftp:rwx</span><br><span class="line">group::r-x</span><br><span class="line">mask::rwx</span><br><span class="line">other::r-x</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): ftp</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; cd pub</span><br><span class="line">250 Directory successfully changed.</span><br><span class="line">ftp&gt; put f2         # 已经可以上传</span><br><span class="line">local: f2 remote: f2</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,122,181).</span><br><span class="line">150 Ok to send data.</span><br><span class="line">226 Transfer complete.</span><br><span class="line">1073741824 bytes sent in 13.4 secs (79893.42 Kbytes/sec)</span><br></pre></td></tr></table></figure></li></ol><h3 id="Linux系统用户"><a href="#Linux系统用户" class="headerlink" title="Linux系统用户"></a>Linux系统用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">guest_enable=YES 所有系统用户都映射成guest用户</span><br><span class="line">guest_username=ftp 配合上面选项才生效，指定guest用户</span><br><span class="line">local_enable=YES 是否允许linux用户登录</span><br><span class="line">write_enable-YES 允许linux用户上传文件</span><br><span class="line">local_umask=022 指定系统用户上传文件的默认权限</span><br><span class="line">local_root=/ftproot 非匿名用户登录所在目录</span><br></pre></td></tr></table></figure><h4 id="所有系统用户都映射成guest用户"><a href="#所有系统用户都映射成guest用户" class="headerlink" title="所有系统用户都映射成guest用户"></a>所有系统用户都映射成guest用户</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 vsftpd]# vim /etc/vsftpd/vsftpd.conf      # 修改配置文件</span><br><span class="line">guest_enable=YES</span><br><span class="line">guest_username=ftp</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# useradd haiyun</span><br><span class="line">[root@centos7 vsftpd]# passwd haiyun</span><br><span class="line">Changing password for user haiyun.</span><br><span class="line">New password: </span><br><span class="line">BAD PASSWORD: The password is shorter than 8 characters</span><br><span class="line">Retype new password: </span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# !sys</span><br><span class="line">systemctl restart vsftpd</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): haiyun</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">530 Login incorrect.</span><br><span class="line">Login failed.</span><br><span class="line">ftp&gt; 221 Goodbye.</span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): haiyun</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; ls</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,154,38).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">-rw-r--r--    1 0        0        1073741824 Oct 13 01:26 f1</span><br><span class="line">drwxrwxr-x    2 0        0              16 Oct 13 02:53 pub</span><br><span class="line">226 Directory send OK.</span><br></pre></td></tr></table></figure><h3 id="禁锢所有系统用户在家目录中"><a href="#禁锢所有系统用户在家目录中" class="headerlink" title="禁锢所有系统用户在家目录中"></a>禁锢所有系统用户在家目录中</h3><p><code>chroot_local_user=YES（默认NO，不禁锢）禁锢系统用户</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ftp&gt; [root@centos6 ~]# ftp 192.168.8.140            # 默认是可以切换到根目录的</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): haiyun</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; ls</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,97,169).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; pwd</span><br><span class="line">257 &quot;/home/haiyun&quot;</span><br><span class="line">ftp&gt; cd /</span><br><span class="line">250 Directory successfully changed.</span><br><span class="line">ftp&gt; ls</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,135,197).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">drwxr-xr-x    2 0        0               6 Oct 05 16:31 app</span><br><span class="line">lrwxrwxrwx    1 0        0               7 Oct 05 16:31 bin -&gt; usr/bin</span><br><span class="line">dr-xr-xr-x    4 0        0            4096 Oct 10 13:52 boot</span><br><span class="line">drwxr-xr-x   19 0        0            3200 Oct 13 01:21 dev</span><br><span class="line">drwxr-xr-x   80 0        0            8192 Oct 13 03:21 etc</span><br><span class="line">drwxr-xr-x    3 0        0              20 Oct 13 03:20 home</span><br><span class="line">lrwxrwxrwx    1 0        0               7 Oct 05 16:31 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx    1 0        0               9 Oct 05 16:31 lib64 -&gt; usr/lib64</span><br><span class="line">drwxr-xr-x    2 0        0               6 Nov 05  2016 media</span><br><span class="line">drwxr-xr-x    2 0        0               6 Nov 05  2016 mnt</span><br><span class="line">drwxr-xr-x    2 0        0               6 Nov 05  2016 opt</span><br><span class="line">dr-xr-xr-x  128 0        0               0 Oct 13  2017 proc</span><br><span class="line">dr-xr-x---    2 0        0             142 Oct 13 03:20 root</span><br><span class="line">drwxr-xr-x   20 0        0             560 Oct 13 01:29 run</span><br><span class="line">lrwxrwxrwx    1 0        0               8 Oct 05 16:31 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x    2 0        0               6 Oct 05 16:31 script</span><br><span class="line">drwxr-xr-x    2 0        0               6 Nov 05  2016 srv</span><br><span class="line">dr-xr-xr-x   13 0        0               0 Oct 13  2017 sys</span><br><span class="line">drwxrwxrwt    8 0        0             236 Oct 13 02:51 tmp</span><br><span class="line">drwxr-xr-x   13 0        0             155 Oct 05 16:31 usr</span><br><span class="line">drwxr-xr-x   20 0        0             278 Oct 13 01:24 var</span><br><span class="line">226 Directory send OK.</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# vim /etc/vsftpd/vsftpd.conf      # 修改配置文件</span><br><span class="line">chroot_local_user=YES</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# !sys</span><br><span class="line">systemctl restart vsftpd</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root)haiyun   </span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">500 OOPS: vsftpd: refusing to run with writable root inside chroot()</span><br><span class="line">Login failed.</span><br><span class="line">421 Service not available, remote server has closed connection</span><br><span class="line">ftp&gt; [root@centos6 ~]# ftp 192.168.8.140            # 连接失败</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): </span><br><span class="line">530 Permission denied.</span><br><span class="line">Login failed.</span><br><span class="line"></span><br><span class="line">[root@centos7 home]# ll </span><br><span class="line">total 0</span><br><span class="line">drwx------ 2 haiyun haiyun 62 Oct 13 11:20 haiyun</span><br><span class="line">[root@centos7 home]# chmod -w haiyun/           # 去掉w权限就可以了</span><br><span class="line">[root@centos7 home]# ll </span><br><span class="line">total 0</span><br><span class="line">dr-x------ 2 haiyun haiyun 62 Oct 13 11:20 haiyun</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): haiyun</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; ls</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,87,198).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; pwd</span><br><span class="line">257 &quot;/&quot;</span><br></pre></td></tr></table></figure></p><h4 id="禁锢或不禁锢特定的系统用户在家目录中，与上面设置功能相反"><a href="#禁锢或不禁锢特定的系统用户在家目录中，与上面设置功能相反" class="headerlink" title="禁锢或不禁锢特定的系统用户在家目录中，与上面设置功能相反"></a>禁锢或不禁锢特定的系统用户在家目录中，与上面设置功能相反</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chroot_list_enable=YES</span><br><span class="line">chroot_list_file=/etc/vsftpd/chroot_list</span><br><span class="line">当chroot_local_user=YES时，则chroot_list中用户不禁锢</span><br><span class="line">当chroot_local_user=NO时， 则chroot_list中用户禁锢</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 home]# useradd test           # 添加测试用户</span><br><span class="line">[root@centos7 home]# passwd test</span><br><span class="line">Changing password for user test.</span><br><span class="line">New password: </span><br><span class="line">BAD PASSWORD: The password is shorter than 8 characters</span><br><span class="line">Retype new password: </span><br><span class="line">passwd: all authentication tokens updated successfully.</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# vim /etc/vsftpd/vsftpd.conf      # 修改配置文件</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">chroot_list_enable=YES</span><br><span class="line">chroot_list_file=/etc/vsftpd/chroot_list</span><br><span class="line"></span><br><span class="line">[root@centos7 ftp]# cd /etc/vsftpd/         # 把test用户添加到chroot_list中</span><br><span class="line">[root@centos7 vsftpd]# echo &quot;test&quot; &gt; chroot_list</span><br><span class="line">[root@centos7 vsftpd]# cat chroot_list </span><br><span class="line">test</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140         # 连接测试</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): haiyun</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; pwd</span><br><span class="line">257 &quot;/&quot;</span><br><span class="line">ftp&gt; 221 Goodbye.</span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140     # 连接测试</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): test</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; pwd</span><br><span class="line">257 &quot;/home/test&quot;</span><br><span class="line">ftp&gt; 221 Goodbye.</span><br></pre></td></tr></table></figure><h3 id="wu-ftp日志：默认启动"><a href="#wu-ftp日志：默认启动" class="headerlink" title="wu-ftp日志：默认启动"></a>wu-ftp日志：默认启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xferlog_enable=YES （默认） 启用记录上传下载日志</span><br><span class="line">xferlog_std_format=YES （默认）使用wu-ftp日志格式</span><br><span class="line">xferlog_file=/var/log/xferlog （默认）可自动生成</span><br></pre></td></tr></table></figure><h4 id="查看wu-ftp日志"><a href="#查看wu-ftp日志" class="headerlink" title="查看wu-ftp日志"></a>查看wu-ftp日志</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 home]# tail /var/log/xferlog </span><br><span class="line">Fri Oct 13 09:38:48 2017 8 ::ffff:192.168.8.128 1073741824 /f1 b _ o a ? ftp 0 * c</span><br><span class="line">Fri Oct 13 09:39:29 2017 8 ::ffff:192.168.8.128 1073741824 /f1 b _ o a ? ftp 0 * c</span><br><span class="line">Fri Oct 13 09:45:31 2017 9 ::ffff:192.168.8.128 1073741824 /f1 b _ o a ? ftp 0 * c</span><br><span class="line">Fri Oct 13 09:47:48 2017 7 ::ffff:192.168.8.128 1073741824 /f1 b _ o a ? ftp 0 * c</span><br><span class="line">Fri Oct 13 09:51:31 2017 8 ::ffff:192.168.8.128 1073741824 /f1 b _ o a ? ftp 0 * c</span><br><span class="line">Fri Oct 13 10:36:19 2017 1 ::ffff:192.168.8.128 0 /f2 b _ i a ? ftp 0 * i</span><br><span class="line">Fri Oct 13 10:36:23 2017 1 ::ffff:192.168.8.128 0 /f2 b _ i a ? ftp 0 * i</span><br><span class="line">Fri Oct 13 10:48:52 2017 1 ::ffff:192.168.8.128 0 /pub/f2 b _ o a ? ftp 0 * i</span><br><span class="line">Fri Oct 13 10:51:12 2017 2 ::ffff:192.168.8.128 357091608 /pub/f2 b _ i a ? ftp 0 * c</span><br><span class="line">Fri Oct 13 10:54:02 2017 14 ::ffff:192.168.8.128 1073741824 /pub/f2 b _ i a ? ftp 0 * c</span><br></pre></td></tr></table></figure><h3 id="vsftpd日志：默认不启用"><a href="#vsftpd日志：默认不启用" class="headerlink" title="vsftpd日志：默认不启用"></a>vsftpd日志：默认不启用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dual_log_enable=YES 使用vsftpd日志格式，默认不启用</span><br><span class="line">vsftpd_log_file=/var/log/vsftpd.log（默认）可自动生成</span><br></pre></td></tr></table></figure><h4 id="开启vsftpd日志并查看"><a href="#开启vsftpd日志并查看" class="headerlink" title="开启vsftpd日志并查看"></a>开启vsftpd日志并查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 vsftpd]# vim /etc/vsftpd/vsftpd.conf      # 修改配置文件</span><br><span class="line">dual_log_enable=YES</span><br><span class="line">vsftpd_log_file=/var/log/vsftpd.log</span><br><span class="line"></span><br><span class="line">[root@centos7 home]# !sys</span><br><span class="line">systemctl restart vsftpd</span><br><span class="line"></span><br><span class="line">root@centos6 ~]# ftp 192.168.8.140          # 访问测试</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 (vsFTPd 3.0.2)</span><br><span class="line">Name (192.168.8.140:root): haiyun</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; ls</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,254,209).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; ls</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,73,11).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; ls</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,225,241).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; get f1</span><br><span class="line">local: f1 remote: f1</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,169,98).</span><br><span class="line">550 Failed to open file.</span><br><span class="line">ftp&gt; 221 Goodbye.</span><br><span class="line"></span><br><span class="line">[root@centos7 home]# tail /var/log/vsftpd.log       # 查看日志</span><br><span class="line">Fri Oct 13 11:42:41 2017 [pid 11671] CONNECT: Client &quot;::ffff:192.168.8.128&quot;</span><br><span class="line">Fri Oct 13 11:42:45 2017 [pid 11670] [haiyun] OK LOGIN: Client &quot;::ffff:192.168.8.128&quot;</span><br><span class="line">Fri Oct 13 11:43:07 2017 [pid 11672] [haiyun] FAIL DOWNLOAD: Client &quot;::ffff:192.168.8.128&quot;, &quot;/home/haiyun/f1&quot;, 0.00Kbyte/sec</span><br></pre></td></tr></table></figure><h3 id="登陆提示信息"><a href="#登陆提示信息" class="headerlink" title="登陆提示信息"></a>登陆提示信息</h3><h4 id="两种方法"><a href="#两种方法" class="headerlink" title="两种方法"></a>两种方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ftpd_banner=“welcome to mage ftp server&quot;</span><br><span class="line">banner_file=/etc/vsftpd/ftpbanner.txt 优先上面项生效</span><br></pre></td></tr></table></figure><h4 id="方法一，优先生效"><a href="#方法一，优先生效" class="headerlink" title="方法一，优先生效"></a>方法一，优先生效</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 vsftpd]# vim /etc/vsftpd/vsftpd.conf      # 修改配置文件</span><br><span class="line">ftpd_banner=&quot;Welcome to blah haiyun FTP service.&quot;</span><br><span class="line"></span><br><span class="line">[root@centos7 home]# systemctl restart vsftpd</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220 &quot;Welcome to blah haiyun FTP service.&quot;</span><br><span class="line">Name (192.168.8.140:root): haiyun</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt;</span><br></pre></td></tr></table></figure><h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 vsftpd]# vim /etc/vsftpd/vsftpd.conf      # 修改配置文件</span><br><span class="line">banner_file=/etc/vsftpd/ftpbanner.txt</span><br><span class="line"></span><br><span class="line">[root@centos7 vsftpd]# pwd</span><br><span class="line">/etc/vsftpd</span><br><span class="line">[root@centos7 vsftpd]# touch ftpbanner.txt</span><br><span class="line">[root@centos7 vsftpd]# echo &quot;http://www.ihaiyun.cc/&quot;  &gt; ftpbanner.txt</span><br><span class="line"></span><br><span class="line">[root@centos7 home]# systemctl restart vsftpd</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220-http://www.ihaiyun.cc/</span><br><span class="line">220 </span><br><span class="line">Name (192.168.8.140:root): haiyun </span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt;</span><br></pre></td></tr></table></figure><h3 id="目录访问提示信息"><a href="#目录访问提示信息" class="headerlink" title="目录访问提示信息"></a>目录访问提示信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dirmessage_enable=YES (默认)</span><br><span class="line">message_file=.message(默认)信息存放在指定目录下.message</span><br></pre></td></tr></table></figure><h4 id="目录访问提示信息实现"><a href="#目录访问提示信息实现" class="headerlink" title="目录访问提示信息实现"></a>目录访问提示信息实现</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 vsftpd]# vim /etc/vsftpd/vsftpd.conf      # 查看配置文件，因为此项默认就是开启的</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">message_file=.message       # 此项可以修改文件名</span><br><span class="line"></span><br><span class="line">root@centos7 home]# cd /var/ftp/</span><br><span class="line">[root@centos7 ftp]# mkdir test      # 创建测试目录</span><br><span class="line">[root@centos7 ftp]# echo &quot;This is a test dir&quot; &gt; test/.message       # 测试信息</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ftp 192.168.8.140</span><br><span class="line">Connected to 192.168.8.140 (192.168.8.140).</span><br><span class="line">220-http://www.ihaiyun.cc/</span><br><span class="line">220 </span><br><span class="line">Name (192.168.8.140:root): ftp</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt; ls</span><br><span class="line">227 Entering Passive Mode (192,168,8,140,125,170).</span><br><span class="line">150 Here comes the directory listing.</span><br><span class="line">-rw-r--r--    1 0        0        1073741824 Oct 13 01:26 f1</span><br><span class="line">drwxrwxr-x    2 0        0              16 Oct 13 02:53 pub</span><br><span class="line">drwxr-xr-x    2 0        0              22 Oct 13 03:53 test</span><br><span class="line">226 Directory send OK.</span><br><span class="line">ftp&gt; cd test    </span><br><span class="line">250-This is a test dir          # 已经看到测试信息</span><br><span class="line">250 Directory successfully changed.</span><br><span class="line">ftp&gt;</span><br></pre></td></tr></table></figure><h3 id="传输速率：-字节-秒"><a href="#传输速率：-字节-秒" class="headerlink" title="传输速率： 字节/秒"></a>传输速率： 字节/秒</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">传输速率： 字节/秒</span><br><span class="line">anon_max_rate=0 匿名用户的最大传输速率</span><br><span class="line">local_max_rate=0 本地用户的最大传输速率</span><br></pre></td></tr></table></figure><h4 id="传输速率实现"><a href="#传输速率实现" class="headerlink" title="传输速率实现"></a>传输速率实现</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 vsftpd]# vim /etc/vsftpd/vsftpd.conf      # 修改配置文件</span><br><span class="line">anon_max_rate=1024000</span><br><span class="line">local_max_rate=1024000000</span><br><span class="line"></span><br><span class="line">[root@centos7 ftp]# systemctl restart vsftpd</span><br><span class="line"></span><br><span class="line">[root@centos7 ftp]# dd if=/dev/zero of=ftest bs=1024M count=2       # 生成测试文件</span><br><span class="line">2+0 records in</span><br><span class="line">2+0 records out</span><br><span class="line">2147483648 bytes (2.1 GB) copied, 25.5866 s, 83.9 MB/s</span><br><span class="line"></span><br><span class="line">[root@centos7 haiyun]# ln /var/ftp/ftest ftest</span><br><span class="line">[root@centos7 haiyun]# pwd</span><br><span class="line">/home/haiyun</span><br></pre></td></tr></table></figure><h4 id="匿名用户测速"><a href="#匿名用户测速" class="headerlink" title="匿名用户测速"></a>匿名用户测速</h4><center><img src="https://houhaiyun.github.io/img/images/FTP-config-2.gif" title="匿名用户测速"></center><h4 id="普通用户测速"><a href="#普通用户测速" class="headerlink" title="普通用户测速"></a>普通用户测速</h4><center><img src="https://houhaiyun.github.io/img/images/FTP-config-2.gif" title="普通用户测速"></center><h3 id="连接时间：秒为单位"><a href="#连接时间：秒为单位" class="headerlink" title="连接时间：秒为单位"></a>连接时间：秒为单位</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connect_timeout=60 主动模式数据连接超时时长</span><br><span class="line">accept_timeout=60 被动模式数据连接超时时长</span><br><span class="line">data_connection_timeout=300 数据连接无数据输超时时长</span><br><span class="line">idle_session_timeout=60 无命令操作超时时长</span><br></pre></td></tr></table></figure><h3 id="优先以文本方式传输"><a href="#优先以文本方式传输" class="headerlink" title="优先以文本方式传输"></a>优先以文本方式传输</h3><ul><li>ascii：文本方式传输数据，可能会破坏数据。例如：把windows的文本文件通过ftp下载到linux上面，会进行转换。那么如果传输一个图片的话可能会把图片破坏。</li><li>binary：二进制方式传输数据</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ascii_upload_enable=YES</span><br><span class="line">ascii_download_enable=YES</span><br></pre></td></tr></table></figure><h3 id="Centos-6-配置VSFTPD为非独立服务"><a href="#Centos-6-配置VSFTPD为非独立服务" class="headerlink" title="Centos 6 配置VSFTPD为非独立服务"></a>Centos 6 配置VSFTPD为非独立服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# vim /etc/vsftpd/vsftpd.conf       # 修改配置文件</span><br><span class="line">listen=NO</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# cat /etc/xinetd.d/vsftpd          # 此文件默认是不存在的，需要手动写一份</span><br><span class="line">service ftp</span><br><span class="line">&#123;</span><br><span class="line">flags = REUSE</span><br><span class="line">socket_type = stream</span><br><span class="line">wait = no</span><br><span class="line">user = root</span><br><span class="line">server = /usr/sbin/vsftpd</span><br><span class="line">log_on_failure += USERID</span><br><span class="line">disable = no</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# ss -tnul </span><br><span class="line">Netid  State      Recv-Q Send-Q          Local Address:Port            Peer Address:Port </span><br><span class="line">udp    UNCONN     0      0                           *:68                         *:*     </span><br><span class="line">tcp    LISTEN     0      128                        :::22                        :::*     </span><br><span class="line">tcp    LISTEN     0      128                         *:22                         *:*     </span><br><span class="line">tcp    LISTEN     0      100                       ::1:25                        :::*     </span><br><span class="line">tcp    LISTEN     0      100                 127.0.0.1:25                         *:*     </span><br><span class="line">[root@centos6 ~]# service xinetd start </span><br><span class="line">Starting xinetd:                                           [  OK  ]</span><br><span class="line">[root@centos6 ~]# ss -tnul          #端口已经打开</span><br><span class="line">Netid  State      Recv-Q Send-Q          Local Address:Port            Peer Address:Port </span><br><span class="line">udp    UNCONN     0      0                           *:68                         *:*     </span><br><span class="line">tcp    LISTEN     0      64                         :::21                        :::*     </span><br><span class="line">tcp    LISTEN     0      128                        :::22                        :::*     </span><br><span class="line">tcp    LISTEN     0      128                         *:22                         *:*     </span><br><span class="line">tcp    LISTEN     0      100                       ::1:25                        :::*     </span><br><span class="line">tcp    LISTEN     0      100                 127.0.0.1:25                         *:*  </span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# netstat -anp | grep 21        # 可以看到21端口是有xinetd服务监听的</span><br><span class="line">tcp        0      0 :::21                       :::*                        LISTEN      1891/xinetd         </span><br><span class="line">unix  3      [ ]         DGRAM                    10021  492/udevd   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# ftp 192.168.8.128         # </span><br><span class="line">Connected to 192.168.8.128 (192.168.8.128).</span><br><span class="line">220 (vsFTPd 2.2.2)</span><br><span class="line">Name (192.168.8.128:root): ftp</span><br><span class="line">331 Please specify the password.</span><br><span class="line">Password:</span><br><span class="line">230 Login successful.</span><br><span class="line">Remote system type is UNIX.</span><br><span class="line">Using binary mode to transfer files.</span><br><span class="line">ftp&gt;</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# netstat -anp | grep 21        # 再次查看21端口是由vsftpd提供服务的</span><br><span class="line">tcp        0      0 192.168.8.128:21            192.168.8.140:46626         ESTABLISHED 1901/vsftpd         </span><br><span class="line">tcp        0      0 :::21                       :::*                        LISTEN      1891/xinetd         </span><br><span class="line">unix  3      [ ]         DGRAM                    10021  492/udevd</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> FTP </category>
          
          <category> Vsftp常用配置 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Vsftp </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>httpd-2.2 实现https</title>
      <link href="/2017/10/09/Httpd-https/"/>
      <url>/2017/10/09/Httpd-https/</url>
      <content type="html"><![CDATA[<center><img src="https://houhaiyun.github.io/img/images/Httpd-https-1.jpg" title="https"></center><a id="more"></a><h3 id="主要步骤"><a href="#主要步骤" class="headerlink" title="主要步骤"></a>主要步骤</h3><ol><li>安装mod_ssl模块，使其支持ssl</li><li>为服务器申请数字证书<ul><li>创建私有CA</li><li>在服务器创建证书签署请求</li><li>CA签证</li></ul></li><li>搭建DNS</li><li>修改配置文件</li><li>测试基于https访问响应的主机</li></ol><h3 id="1-安装mod-ssl模块，使其支持ssl"><a href="#1-安装mod-ssl模块，使其支持ssl" class="headerlink" title="1. 安装mod_ssl模块，使其支持ssl"></a>1. 安装mod_ssl模块，使其支持ssl</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# yum install -y mod_ssl</span><br><span class="line">[root@centos6 ~]# rpm -ql mod_ssl       # 生成了以下文件</span><br><span class="line">/etc/httpd/conf.d/ssl.conf              # 新生成的配置文件</span><br><span class="line">/usr/lib64/httpd/modules/mod_ssl.so</span><br><span class="line">/var/cache/mod_ssl</span><br><span class="line">/var/cache/mod_ssl/scache.dir</span><br><span class="line">/var/cache/mod_ssl/scache.pag</span><br><span class="line">/var/cache/mod_ssl/scache.sem</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# service httpd reload          # 重新加载配置文件</span><br><span class="line">Reloading httpd:</span><br></pre></td></tr></table></figure><h4 id="直接访问测试"><a href="#直接访问测试" class="headerlink" title="直接访问测试"></a>直接访问测试</h4><p>现在我们已经可以访问了，还有两个问题：站点还未被信任和证书并不是自己的。</p><center><img src="https://houhaiyun.github.io/img/images/Httpd-https-2.gif" title="测试访问"></center><h4 id="问题如下"><a href="#问题如下" class="headerlink" title="问题如下"></a>问题如下</h4><center><img src="https://houhaiyun.github.io/img/images/Httpd-https-3.jpg" title="问题"></center><h3 id="2-为服务器申请数字证书"><a href="#2-为服务器申请数字证书" class="headerlink" title="2. 为服务器申请数字证书"></a>2. 为服务器申请数字证书</h3><h4 id="创建私有CA"><a href="#创建私有CA" class="headerlink" title="创建私有CA"></a>创建私有CA</h4><p><a href="http://blog.csdn.net/hai__yun/article/details/77921134" target="_blank" rel="noopener">关于创建私有CA，可以参考我的另外一篇博客</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# touch /etc/pki/CA/index.txt</span><br><span class="line">[root@centos7 ~]# echo 01 &gt; /etc/pki/CA/serial</span><br><span class="line">[root@centos7 ~]# cd /etc/pki/CA/</span><br><span class="line">[root@centos7 CA]# (umask 066 ; openssl genrsa -out /etc/pki/CA/private/cakey.pem 2048)</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">...................+++</span><br><span class="line">.....................................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">[root@centos7 CA]# openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days 7300 -out /etc/pki/CA/cacert.pem</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:hlg</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:ihaiyun.com</span><br><span class="line">Organizational Unit Name (eg, section) []:opt</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:ca.ihaiyun.com</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure></p><h4 id="在服务器创建证书签署请求"><a href="#在服务器创建证书签署请求" class="headerlink" title="在服务器创建证书签署请求"></a>在服务器创建证书签署请求</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# (umask 066 ; openssl genrsa -out /etc/pki/tls/private/test.key 2048)</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">..........................................................+++</span><br><span class="line">.............................................................................................................................................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">[root@centos6 ~]# openssl req -new -key /etc/pki/tls/private/test.key -days 365 -out /etc/pki/tls/test.csr</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:caoyang</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:ihaiyun.com</span><br><span class="line">Organizational Unit Name (eg, section) []:opt</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:www.ihaiyun.com</span><br><span class="line">Email Address []:</span><br><span class="line"></span><br><span class="line">Please enter the following &apos;extra&apos; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br><span class="line">[root@centos6 tls]# scp test.csr 192.168.8.135:/etc/pki/CA</span><br><span class="line">root@192.168.8.135&apos;s password: </span><br><span class="line">test.csr                                                       100% 1029     1.0KB/s   00:00</span><br></pre></td></tr></table></figure><h4 id="CA签证"><a href="#CA签证" class="headerlink" title="CA签证"></a>CA签证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 CA]# openssl ca -in /etc/pki/CA/test.csr -out /etc/pki/CA/certs/test.crt  </span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">Certificate Details:</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Oct  9 01:18:33 2017 GMT</span><br><span class="line">            Not After : Oct  9 01:18:33 2018 GMT</span><br><span class="line">        Subject:</span><br><span class="line">            countryName               = CN</span><br><span class="line">            stateOrProvinceName       = beijing</span><br><span class="line">            organizationName          = ihaiyun.com</span><br><span class="line">            organizationalUnitName    = www.ihaiyun.com</span><br><span class="line">            commonName                = www.ihaiyun.com</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints: </span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment: </span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                A6:59:85:90:9D:84:C4:80:6B:27:E2:A2:57:44:58:FA:69:64:CB:00</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:43:65:C5:B5:03:8E:E9:2E:82:C9:0D:5F:87:72:2D:F1:81:5F:FB:CE</span><br><span class="line"></span><br><span class="line">Certificate is to be certified until Oct  9 01:18:33 2018 GMT (365 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure><h4 id="获取证书"><a href="#获取证书" class="headerlink" title="获取证书"></a>获取证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# mkdir /etc/httpd/ssl          # 新建目录用来存放证书文件</span><br><span class="line">[root@centos7 CA]# scp certs/test.crt 192.168.8.128:/etc/httpd/ssl          # 将证书发送到192.168.8.128</span><br><span class="line">root@192.168.8.128&apos;s password: </span><br><span class="line">test.crt                                                       100% 4507     4.4KB/s   00:00 </span><br><span class="line">[root@centos7 CA]# scp cacert.pem 192.168.8.128:/etc/httpd/ssl              # 将根的证书发送给192.168.8.128</span><br><span class="line">root@192.168.8.128&apos;s password: </span><br><span class="line">cacert.pem                                                     100% 1326     1.3KB/s   00:00</span><br></pre></td></tr></table></figure><h3 id="3-搭建DNS"><a href="#3-搭建DNS" class="headerlink" title="3. 搭建DNS"></a>3. 搭建DNS</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/named.conf </span><br><span class="line">options &#123;</span><br><span class="line">//  listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">    listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">    directory   &quot;/var/named&quot;;</span><br><span class="line">    dump-file   &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">    statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">    memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">//  allow-query     &#123; localhost; &#125;;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# tail -5 /etc/named.rfc1912.zones </span><br><span class="line">zone &quot;ihaiyun.com&quot; IN &#123;</span><br><span class="line">type master;</span><br><span class="line">file &quot;ihaiyun.com.zone&quot;;</span><br><span class="line">allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# cp -p /var/named/named.localhost /var/named/ihaiyun.com.zone</span><br><span class="line">[root@centos7 ~]# cat /var/named/ihaiyun.com.zone </span><br><span class="line">$TTL 1D</span><br><span class="line">@IN SOAdns1 admin.ihaiyun.com. (</span><br><span class="line">0; serial</span><br><span class="line">1D; refresh</span><br><span class="line">1H; retry</span><br><span class="line">1W; expire</span><br><span class="line">3H ); minimum</span><br><span class="line">NSdns1</span><br><span class="line">dns1 A192.168.8.135</span><br><span class="line">www A192.168.8.128</span><br></pre></td></tr></table></figure><h3 id="4-修改配置文件"><a href="#4-修改配置文件" class="headerlink" title="4. 修改配置文件"></a>4. 修改配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# cp /etc/pki/tls/private/test.key /etc/httpd/ssl/          # 将key文件cp到/etc/httpd/ssl目录下方便管理</span><br><span class="line">[root@centos6 ~]# vim /etc/httpd/conf.d/ssl.conf</span><br><span class="line">SSLCertificateFile /etc/httpd/ssl/test.crt</span><br><span class="line">SSLCertificateKeyFile /etc/httpd/ssl/test.key</span><br><span class="line">SSLCACertificateFile /etc/httpd/ssl/cacert.pem</span><br><span class="line">[root@centos6 ~]# service httpd restart</span><br><span class="line">Stopping httpd:                                            [  OK  ]</span><br><span class="line">Starting httpd:                                            [  OK  ]</span><br></pre></td></tr></table></figure><h3 id="5-测试"><a href="#5-测试" class="headerlink" title="5. 测试"></a>5. 测试</h3><h4 id="直接访问测试-1"><a href="#直接访问测试-1" class="headerlink" title="直接访问测试"></a>直接访问测试</h4><p>还是提醒我们证书不安全</p><center><img src="https://houhaiyun.github.io/img/images/Httpd-https-4.gif" title="访问测试"></center><h4 id="将根证书导入到测试客户端中"><a href="#将根证书导入到测试客户端中" class="headerlink" title="将根证书导入到测试客户端中"></a>将根证书导入到测试客户端中</h4><p>需要把根证书下载到客户端中，具体怎么下载，相信你们会有办法。导入方法如下：</p><center><img src="https://houhaiyun.github.io/img/images/Httpd-https-5.gif" title="将根证书导入到测试客户端中"></center><h4 id="再次测试"><a href="#再次测试" class="headerlink" title="再次测试"></a>再次测试</h4><center><img src="https://houhaiyun.github.io/img/images/Httpd-https-6.gif" title="再次测试"></center><p>https已经实现!</p>]]></content>
      
      <categories>
          
          <category> Web </category>
          
          <category> httpd-2.2 实现https </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Apache </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Dropbear-轻量级SSH服务器和客户端</title>
      <link href="/2017/09/11/Dropbear/"/>
      <url>/2017/09/11/Dropbear/</url>
      <content type="html"><![CDATA[<h3 id="Dropbear简介"><a href="#Dropbear简介" class="headerlink" title="Dropbear简介"></a>Dropbear简介</h3><p><code>Dropbear</code>是一个相对较小的SSH服务器和客户端。它运行在各种基于<code>POSIX</code>的平台上。<code>Dropbear</code>是一种开源软件，以<code>MIT</code>风格的许可证分发。<code>Dropbear</code>对于“嵌入”型<code>Linux</code>（或其他<code>Unix</code>）系统（如无线路由器）特别有用。——<code>Dropbear</code>官网</p><p><a href="https://matt.ucc.asn.au/dropbear/dropbear.html" target="_blank" rel="noopener">官网：https://matt.ucc.asn.au/dropbear/dropbear.html</a></p><a id="more"></a><h3 id="安装drobear"><a href="#安装drobear" class="headerlink" title="安装drobear"></a>安装drobear</h3><h4 id="1、安装依赖包"><a href="#1、安装依赖包" class="headerlink" title="1、安装依赖包"></a>1、安装依赖包</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@A dropbear-2017.75]# yum groupinstall -y "Development tools"#安装开发包组</span><br><span class="line">[root@A dropbear-2017.75]# yum install -y zlib-devel zlib#安装zlib数据压缩库</span><br></pre></td></tr></table></figure><h4 id="2、下载dropbear"><a href="#2、下载dropbear" class="headerlink" title="2、下载dropbear"></a>2、下载dropbear</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@A ~]# wget https://matt.ucc.asn.au/dropbear/dropbear-2017.75.tar.bz2#通过wget下载</span><br><span class="line">--2017-09-13 11:58:07--  https://matt.ucc.asn.au/dropbear/dropbear-2017.75.tar.bz2</span><br><span class="line">Resolving matt.ucc.asn.au... 130.95.13.18, 2405:3c00:5200<img class="github-emoji" title="100" alt="100" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f4af.png?v8" height="20" width="20">:18</span><br><span class="line">Connecting to matt.ucc.asn.au|130.95.13.18|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 1623392 (1.5M) [application/x-bzip2]</span><br><span class="line">Saving to: “dropbear-2017.75.tar.bz2”</span><br><span class="line"></span><br><span class="line"><span class="meta">100%</span>[=======================================&gt;] 1,623,392    441K/s   in 3.6s    </span><br><span class="line"></span><br><span class="line">2017-09-13 11:58:13 (441 KB/s) - “dropbear-2017.75.tar.bz2” saved [1623392/1623392]</span><br></pre></td></tr></table></figure><h4 id="3、安装Drobear"><a href="#3、安装Drobear" class="headerlink" title="3、安装Drobear"></a>3、安装Drobear</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@A app]# tar xf dropbear-2017.75.tar.bz2 #解压</span><br><span class="line">[root@A app]# ls#查看解压后的目录</span><br><span class="line">dropbear-2017.75  dropbear-2017.75.tar.bz2</span><br><span class="line">[root@A app]# cd dropbear-2017.75/#切换到解压后的目录中</span><br><span class="line">[root@A dropbear-2017.75]# ./configure#开始检查环境，并生成makefile文件</span><br><span class="line">。。。省略部分内容</span><br><span class="line">configure: creating ./config.status</span><br><span class="line">config.status: creating Makefile</span><br><span class="line">config.status: creating libtomcrypt/Makefile</span><br><span class="line">config.status: creating libtommath/Makefile</span><br><span class="line">config.status: creating config.h</span><br><span class="line">configure: </span><br><span class="line">configure: Using bundled libtomcrypt and libtommath</span><br><span class="line">configure: </span><br><span class="line">configure: Now edit options.h to choose features.</span><br><span class="line">[root@A dropbear-2017.75]# make#根据Makefile文件，构建应用程序dropbear</span><br><span class="line">[root@A dropbear-2017.75]# make install #开始安装，复制文件到相应路径</span><br><span class="line">install -d /usr/local/sbin</span><br><span class="line">install dropbear /usr/local/sbin</span><br><span class="line">install -d /usr/local/share/man/man8</span><br><span class="line">install -m 644 ./dropbear.8 /usr/local/share/man/man8/dropbear.8</span><br><span class="line">install -d /usr/local/bin</span><br><span class="line">install dbclient /usr/local/bin</span><br><span class="line">install -d /usr/local/share/man/man1</span><br><span class="line">if test -e dbclient.1; then install -m 644 dbclient.1 /usr/local/share/man/man1/dbclient.1; fi</span><br><span class="line">install -d /usr/local/bin</span><br><span class="line">install dropbearkey /usr/local/bin</span><br><span class="line">install -d /usr/local/share/man/man1</span><br><span class="line">if test -e dropbearkey.1; then install -m 644 dropbearkey.1 /usr/local/share/man/man1/dropbearkey.1; fi</span><br><span class="line">install -d /usr/local/bin</span><br><span class="line">install dropbearconvert /usr/local/bin</span><br><span class="line">install -d /usr/local/share/man/man1</span><br><span class="line">if test -e dropbearconvert.1; then install -m 644 dropbearconvert.1 /usr/local/share/man/man1/dropbearconvert.1; fi</span><br></pre></td></tr></table></figure><h3 id="Dropbear的使用"><a href="#Dropbear的使用" class="headerlink" title="Dropbear的使用"></a>Dropbear的使用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">[root@A dropbear-2017.75]# ls /usr/local/sbin/ /usr/local/bin/#查看是否在对应的目录下生成文件</span><br><span class="line">/usr/local/bin/:</span><br><span class="line">dbclient  dropbearconvert  dropbearkey</span><br><span class="line"></span><br><span class="line">/usr/local/sbin/:</span><br><span class="line">dropbear</span><br><span class="line">[root@A dropbear-2017.75]# /usr/local/sbin/dropbear -h #查看帮助信息</span><br><span class="line">Dropbear server v2017.75 https://matt.ucc.asn.au/dropbear/dropbear.html</span><br><span class="line">Usage: /usr/local/sbin/dropbear [options]</span><br><span class="line">-b bannerfileDisplay the contents of bannerfile before user login</span><br><span class="line">(default: none)</span><br><span class="line">-r keyfile  Specify hostkeys (repeatable)</span><br><span class="line">defaults: </span><br><span class="line">dss /etc/dropbear/dropbear_dss_host_key</span><br><span class="line">rsa /etc/dropbear/dropbear_rsa_host_key</span><br><span class="line">ecdsa /etc/dropbear/dropbear_ecdsa_host_key</span><br><span class="line">-RCreate hostkeys as required</span><br><span class="line">-FDon't fork into background</span><br><span class="line">-ELog to stderr rather than syslog</span><br><span class="line">-mDon't display the motd on login</span><br><span class="line">-wDisallow root logins</span><br><span class="line">-sDisable password logins</span><br><span class="line">-gDisable password logins for root</span><br><span class="line">-BAllow blank password logins</span><br><span class="line">-jDisable local port forwarding</span><br><span class="line">-kDisable remote port forwarding</span><br><span class="line">-aAllow connections to forwarded ports from any host</span><br><span class="line">-p [address:]port</span><br><span class="line">Listen on specified tcp port (and optionally address),</span><br><span class="line">up to 10 can be specified</span><br><span class="line">(default port is 22 if none specified)</span><br><span class="line">-P PidFileCreate pid file PidFile</span><br><span class="line">(default /var/run/dropbear.pid)</span><br><span class="line">-iStart for inetd</span><br><span class="line">-W &lt;receive_window_buffer&gt; (default 24576, larger may be faster, max 1MB)</span><br><span class="line">-K &lt;keepalive&gt;  (0 is never, default 0, in seconds)</span><br><span class="line">-I &lt;idle_timeout&gt;  (0 is never, default 0, in seconds)</span><br><span class="line">-V    Version</span><br><span class="line">[root@A ~]# mkdir /etc/dropbear#创建存放密钥目录</span><br><span class="line">[root@A ~]# dropbearkey -t rsa -f /etc/dropbear/dropbear_rsa_host_key -s 2048#使用rsa算法生成2048位的密钥</span><br><span class="line">Generating key, this may take a while...</span><br><span class="line">Public key portion is:</span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7Pq2ndItUzwY/iHEs/xhIscet510HnQq0lE1yz43B5dXNCv+jDNOdMf3j2XySxtr0J82r2b/+qIp2tRBBmlO7URI8VQA+1J7nM9CP6oJ3ucLSAyVsbc/aIba9JFeKxZLcFdoLT4+M657ef7NcSE2IDvzPBriNXKQxR8Erda5xIcnPDSvNawSn809iJVhjq+gAWVxwHuLNpZst2xb9A6Q+8FCM44UZUpSnIh0u5LNstCGsMc9ClQDSeyNhhBcftBG1oYf2eTEVhpNF5Pu26MA/mXAbTbhgaB/2yaF93Xx6vFO2mAy/6o5xcRJrEdXkD9X3ZQr7xKDdwPtKEJKh4d15 root@A</span><br><span class="line">Fingerprint: md5 76:65:cb:ee:4e:a5:41:bd:2e:81:3a:5e:3b:b6:14:99</span><br><span class="line">[root@A ~]# dropbearkey -t dss -f /etc/dropbear/dropbear_dsa_host_key#使用dss算法生成密钥</span><br><span class="line">Generating key, this may take a while...</span><br><span class="line">Public key portion is:</span><br><span class="line">ssh-dss AAAAB3NzaC1kc3MAAACBAOVp1GiSHc0Jgr/zTODQUlt7jF+jOyv0abzQKY7V6hY5UZAQhz0I0vxWCMHzcY+SVY7svSQCC9iWsoJ2ZO6rPkZLF3adOuG7EFFD6AvNtKF5w5W6cAzOzlqycf7U9JHuszZbVawtthX5w1p5f8eq8kP6sPwCrFzV883Na76MxfVBAAAAFQCT5pQj9ZYapyfPszAv3DyKsAwO6QAAAIEApZzegodTTfU/aX8Tlca2SBZ7Rlj3MF8zeQBjktFZHWeUoEhpRk41bsScuydgs8uW6HX+U8Nk9gx1AHur1rUi/qAZvRUGnUJndm/4Mljc4tmDobu8bKzR0HFtUHidlHailLOFpQTOAxOGcvY2Uv0mkuouG48nloS63bEDUtGPxUMAAACBAL76pIb4YBsT+eGvsvIgNXDZHKnz8QUZYR/+XBV6OelCt26rvbiwot7kTlvbwADJBMIIP0YVar2K8Z5CyYza5A2h6rvs4rgrKSmb/EHb1v1q/Nqjmk33BqWkNf6D3o649yjJd3Lk2/N1hLuhYrvZhq7NUoo2oH5H0RNTTkEYDfYC root@A</span><br><span class="line">Fingerprint: md5 ff:5d:02:f5:7f:8b:9d:ad:64:d1:ca:7c:16:b5:1c:1b</span><br><span class="line">[root@A ~]# dropbear -p :2222 -F -E#在前台启动dropbear端口位2222</span><br><span class="line">[7250] Sep 13 13:42:07 Failed loading /etc/dropbear/dropbear_dss_host_key</span><br><span class="line">[7250] Sep 13 13:42:07 Failed loading /etc/dropbear/dropbear_ecdsa_host_key</span><br><span class="line">[7250] Sep 13 13:42:07 Not backgrounding</span><br><span class="line"></span><br><span class="line">[7281] Sep 13 13:42:52 Child connection from 192.168.8.129:49634</span><br><span class="line">[7281] Sep 13 13:42:56 Password auth succeeded for 'root' from 192.168.8.129:49634</span><br><span class="line">[root@B ~]# ssh 192.168.8.128 -p 2222#使用B去连A可以链接</span><br><span class="line">The authenticity of host '[192.168.8.128]:2222 ([192.168.8.128]:2222)' can't be established.</span><br><span class="line">RSA key fingerprint is 76:65:cb:ee:4e:a5:41:bd:2e:81:3a:5e:3b:b6:14:99.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added '[192.168.8.128]:2222' (RSA) to the list of known hosts.</span><br><span class="line">root@192.168.8.128's password: </span><br><span class="line">[root@A ~]# dbclient 192.168.8.129#使用dropbear的客户端工具连接B，可以连接</span><br><span class="line"></span><br><span class="line">Host '192.168.8.129' is not in the trusted hosts file.</span><br><span class="line">(ecdsa-sha2-nistp256 fingerprint md5 22:11:3a:21:03:37:06:e4:8c:45:65:ae:6e:a4:37:9a)</span><br><span class="line">Do you want to continue connecting? (y/n) y</span><br><span class="line">root@192.168.8.129's password: </span><br><span class="line">Last login: Wed Sep 13 14:09:45 2017 from 192.168.8.1</span><br><span class="line">[root@A ~]# dropbear -p :2345 #在后台启动dropbear端口为2345</span><br><span class="line">[root@A ~]# netstat -anp| grep 2345#2345端口已经启动</span><br><span class="line">tcp        0      0 0.0.0.0:2345                0.0.0.0:*                   LISTEN      7315/dropbear       </span><br><span class="line">tcp        0      0 :::2345                     :::*                        LISTEN      7315/dropbear   </span><br><span class="line">[root@B ~]# ssh 192.168.8.128 -p 2345#在B上去连A的2345端口可以连接</span><br><span class="line">The authenticity of host '[192.168.8.128]:2345 ([192.168.8.128]:2345)' can't be established.</span><br><span class="line">RSA key fingerprint is 76:65:cb:ee:4e:a5:41:bd:2e:81:3a:5e:3b:b6:14:99.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added '[192.168.8.128]:2345' (RSA) to the list of known hosts.</span><br><span class="line">root@192.168.8.128's password:</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> SSH </category>
          
          <category> Dropbear-轻量级SSH服务器和客户端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>AIDE</title>
      <link href="/2017/09/10/AIDE/"/>
      <url>/2017/09/10/AIDE/</url>
      <content type="html"><![CDATA[<h3 id="AIDE简介"><a href="#AIDE简介" class="headerlink" title="AIDE简介"></a>AIDE简介</h3><p>当一个入侵者进入了你的系统并且种植了木马，通常会想法来隐蔽这个木马（除了木马自身的一些隐蔽特性外，他会尽量给你检查系统的过程设置障碍），通常入侵者会修改一些文件，比如管理员通常用<code>ps -aux</code>来查看系统进程，那么入侵者很可能用自己经过修改的<code>ps</code>程序来替换掉你系统上的<code>ps</code>程序，以使用ps命令查不到正在运行的木马程序。如果入侵者发现管理员正在运行<code>crontab</code>作业，也有可能替换掉<code>crontab</code>程序等等。所以由此可以看出对于系统文件或是关键文件的检查是很必要的。目前就系统完整性检查的工具用的比较多的有两款： <code>Tripwire</code>和<code>AIDE</code>，前者是一款商业软件，后者是一款免费的但功能也很强大的工具。</p><ul><li><code>AIDE</code>(<code>Advanced Intrusion Detection Environment</code>,高级入侵检测环境)是个入侵检测工具，主要用途是检查文档的完整性。</li></ul><a id="more"></a><ul><li><code>AIDE</code>能够构造一个指定文件的数据库，它使用<code>aide.conf</code>作为其配置文件。 <code>AIDE</code>数据库能够保存文件的各种属性，包括：权限(<code>permission</code>)、索引节点序号(<code>inode number</code>)、所属用户(<code>user</code>)、所属用户组(<code>group</code>)、文件大小、最后修改时间(<code>mtime</code>)、创建时间(<code>ctime</code>)、最后访问时间(<code>atime</code>)、增加的大小以及连接数。 <code>AIDE</code>还能够使用下列算法： <code>sha1</code>、 <code>md5</code>、 <code>rmd160</code>、 <code>tiger</code>，以密文形式建立每个文件的校验码或散列号.</li><li>这个数据库不应该保存那些经常变动的文件信息，例如：日志文件、邮件、 <code>/proc</code>文件系统、用户起始目录以及临时目录.</li></ul><h3 id="使用AIDE"><a href="#使用AIDE" class="headerlink" title="使用AIDE"></a>使用AIDE</h3><h4 id="安装AIDE"><a href="#安装AIDE" class="headerlink" title="安装AIDE"></a>安装AIDE</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@A ~]# yum install -y aide#使用yum安装</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Setting up Install Process</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Resolving Dependencies</span><br><span class="line"><span class="meta">--&gt;</span> Running transaction check</span><br><span class="line"><span class="meta">---&gt;</span> Package aide.x86_64 0:0.14-11.el6 will be installed</span><br><span class="line"><span class="meta">--&gt;</span> Finished Dependency Resolution</span><br><span class="line">。。。省略后面内容</span><br></pre></td></tr></table></figure><h4 id="修改配置文件，定义监控目录"><a href="#修改配置文件，定义监控目录" class="headerlink" title="修改配置文件，定义监控目录"></a>修改配置文件，定义监控目录</h4><p>配置文件路径：<code>/etc/aide.conf</code></p><p>定义监控<code>/app</code>目录，但不监控<code>/app</code>目录下的<code>f3</code>文件。规则为：权限+所有者+所属组+sha512+修改时间+访问时间+改变时间</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[root@A ~]# cp /etc/aide.conf /etc/aide.conf.bak#对配置文件修改前建议备份</span><br><span class="line">[root@A ~]# vim /etc/aide.conf#编辑配置文件</span><br><span class="line"><span class="meta">#</span> Example configuration file for AIDE.</span><br><span class="line"></span><br><span class="line">@@define DBDIR /var/lib/aide#数据库目录</span><br><span class="line">@@define LOGDIR /var/log/aide#日志目录</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> The location of the database to be read.</span><br><span class="line">database=file:@@&#123;DBDIR&#125;/aide.db.gz#数据库文件</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> The location of the database to be written.</span><br><span class="line"><span class="meta">#</span>database_out=sql:host:port:database:login_name:passwd:table</span><br><span class="line"><span class="meta">#</span>database_out=file:aide.db.new</span><br><span class="line">database_out=file:@@&#123;DBDIR&#125;/aide.db.new.gz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Whether to gzip the output to database</span><br><span class="line">gzip_dbout=yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Default.</span><br><span class="line">verbose=5</span><br><span class="line"></span><br><span class="line">report_url=file:@@&#123;LOGDIR&#125;/aide.log</span><br><span class="line">report_url=stdout</span><br><span class="line"><span class="meta">#</span>report_url=stderr</span><br><span class="line"><span class="meta">#</span>NOT IMPLEMENTED report_url=mailto:root@foo.com</span><br><span class="line"><span class="meta">#</span>NOT IMPLEMENTED report_url=syslog:LOG_AUTH</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> These are the default rules.</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span>p:      permissions#权限</span><br><span class="line"><span class="meta">#</span>i:      inode:#索引节点</span><br><span class="line"><span class="meta">#</span>n:      number of links#链接数</span><br><span class="line"><span class="meta">#</span>u:      user#用户</span><br><span class="line"><span class="meta">#</span>g:      group#组</span><br><span class="line"><span class="meta">#</span>s:      size#大小</span><br><span class="line"><span class="meta">#</span>b:      block count# 块大小</span><br><span class="line"><span class="meta">#</span>m:      mtime# 修改时间</span><br><span class="line"><span class="meta">#</span>a:      atime# 访问时间</span><br><span class="line"><span class="meta">#</span>c:      ctime# 改变时间</span><br><span class="line"><span class="meta">#</span>S:      check for growing size#检查增加的大小</span><br><span class="line"><span class="meta">#</span>acl:           Access Control Lists</span><br><span class="line"><span class="meta">#</span>selinux        SELinux security context</span><br><span class="line"><span class="meta">#</span>xattrs:        Extended file attributes</span><br><span class="line"><span class="meta">#</span>md5:    md5 checksum#md5校验</span><br><span class="line"><span class="meta">#</span>sha1:   sha1 checksum# sha1校验</span><br><span class="line"><span class="meta">#</span>sha256:        sha256 checksum#sha256校验</span><br><span class="line"><span class="meta">#</span>sha512:        sha512 checksum#sha512校验</span><br><span class="line"><span class="meta">#</span>rmd160: rmd160 checksum#rmd160校验</span><br><span class="line"><span class="meta">#</span>tiger:  tiger checksum#tiger校验</span><br><span class="line"><span class="meta">#</span>rmd160: rmd160 checksum#rmd160校验</span><br><span class="line"><span class="meta">#</span>tiger:  tiger checksum#tiger校验</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>haval:  haval checksum (MHASH only)# haval校验</span><br><span class="line"><span class="meta">#</span>gost:   gost checksum (MHASH only)# gost校验</span><br><span class="line"><span class="meta">#</span>crc32:  crc32 checksum (MHASH only)# crc32校验</span><br><span class="line"><span class="meta">#</span>whirlpool:     whirlpool checksum (MHASH only)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>R:             p+i+n+u+g+s+m+c+acl+selinux+xattrs+md5</span><br><span class="line"><span class="meta">#</span>L:             p+i+n+u+g+acl+selinux+xattrs</span><br><span class="line"><span class="meta">#</span>E:             Empty group</span><br><span class="line"><span class="meta">#</span>&gt;:             Growing logfile p+u+g+i+n+S+acl+selinux+xattrs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> You can create custom rules like this.</span><br><span class="line"><span class="meta">#</span> With MHASH...</span><br><span class="line"><span class="meta">#</span> ALLXTRAHASHES = sha1+rmd160+sha256+sha512+whirlpool+tiger+haval+gost+crc32</span><br><span class="line">ALLXTRAHASHES = sha1+rmd160+sha256+sha512+tiger</span><br><span class="line"><span class="meta">#</span> Everything but access time (Ie. all changes)</span><br><span class="line">EVERYTHING = R+ALLXTRAHASHES</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Sane, with multiple hashes</span><br><span class="line"><span class="meta">#</span> NORMAL = R+rmd160+sha256+whirlpool</span><br><span class="line">NORMAL = R+rmd160+sha256</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> For directories, don't bother doing hashes</span><br><span class="line">DIR = p+i+n+u+g+acl+selinux+xattrs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Access control only</span><br><span class="line">PERMS = p+i+u+g+acl+selinux</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Logfile are special, in that they often change</span><br><span class="line">LOG = &gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Just do md5 and sha256 hashes</span><br><span class="line">LSPP = R+sha256</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Some files get updated automatically, so the inode/ctime/mtime change</span><br><span class="line"><span class="meta">#</span> but we want to know when the data inside them changes</span><br><span class="line">DATAONLY =  p+n+u+g+s+acl+selinux+xattrs+md5+sha256+rmd160+tiger</span><br><span class="line"></span><br><span class="line">mon = p+u+g+sha512+m+a+c#自定义规则监控：权限+所有者+所属组+sha512+修改时间+访问时间+改变时间</span><br><span class="line">/app mon#定义/app目录使用规则 mon</span><br><span class="line">!/app/f3#但是/app目录下的f3文件不监控，“!”表示忽略这个文件的检查</span><br></pre></td></tr></table></figure><h4 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@A app]# cp /etc/fstab /app/f1#先把文件创建好</span><br><span class="line">[root@A app]# echo 123 &gt; f2</span><br><span class="line">[root@A app]# echo www.iav18.cn &gt; f3</span><br><span class="line">[root@A app]# ls</span><br><span class="line">f1  f2  f3</span><br><span class="line">[root@A app]# aide --init </span><br><span class="line"></span><br><span class="line">AIDE, version 0.14</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>## AIDE database at /var/lib/aide/aide.db.new.gz initialized.</span><br></pre></td></tr></table></figure><h4 id="生成检查数据库"><a href="#生成检查数据库" class="headerlink" title="生成检查数据库"></a>生成检查数据库</h4><p>把当前初始化的数据库作为开始的基础数据库（建议初始数据库存放到安全的地方） </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@A ~]# cd /var/lib/aide/</span><br><span class="line">[root@A aide]# ls</span><br><span class="line">aide.db.new.gz</span><br><span class="line">[root@A aide]# cp aide.db.new.gz aide.db.gz</span><br><span class="line">[root@A aide]# ls</span><br><span class="line">aide.db.gz  aide.db.new.gz</span><br></pre></td></tr></table></figure><h4 id="检测"><a href="#检测" class="headerlink" title="检测"></a>检测</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@A ~]# aide --check#检测定义的/app目录是否被改动，没有被改动</span><br><span class="line"></span><br><span class="line">AIDE, version 0.14</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>## All files match AIDE database. Looks okay!</span><br><span class="line">[root@A ~]# cd /app/#切换到/app目录</span><br><span class="line">[root@A app]# ls# 列出目录下的内容</span><br><span class="line">f1  f2  f3</span><br><span class="line">[root@A app]# echo &gt; f1#输入一个换行符到f1文件</span><br><span class="line">[root@A app]# aide --check#再次检查，发现文件f1的 SHA512、Ctime、Mtime已经被修改</span><br><span class="line">AIDE found differences between database and filesystem!!</span><br><span class="line">Start timestamp: 2017-09-13 15:18:54</span><br><span class="line"></span><br><span class="line">Summary:</span><br><span class="line">  Total number of files:4</span><br><span class="line">  Added files:0</span><br><span class="line">  Removed files:0</span><br><span class="line">  Changed files:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------------------------</span><br><span class="line">Changed files:</span><br><span class="line">---------------------------------------------------</span><br><span class="line"></span><br><span class="line">changed: /app/f1</span><br><span class="line"></span><br><span class="line">--------------------------------------------------</span><br><span class="line">Detailed information about changes:</span><br><span class="line">---------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">File: /app/f1</span><br><span class="line">  Mtime    : 2017-09-13 15:08:30              , 2017-09-13 15:18:51</span><br><span class="line">  Ctime    : 2017-09-13 15:08:30              , 2017-09-13 15:18:51</span><br><span class="line">  SHA512   : ej+ts/Q6q9CANmKXMfdEdCv3Lcl1otID , vmiIOMqGhuXJBom/KrWFzvETfJmbSMcL</span><br></pre></td></tr></table></figure><h4 id="更新数据库"><a href="#更新数据库" class="headerlink" title="更新数据库"></a>更新数据库</h4><p>如果是合法的修改，那么也会被检测出有问题。此时就需要更新数据了。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@A app]# aide -c /etc/aide.conf --update #更新数据库</span><br><span class="line">AIDE found differences between database and filesystem!!</span><br><span class="line">Start timestamp: 2017-09-13 15:25:29</span><br><span class="line"></span><br><span class="line">Summary:</span><br><span class="line">  Total number of files:4</span><br><span class="line">  Added files:0</span><br><span class="line">  Removed files:0</span><br><span class="line">  Changed files:1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---------------------------------------------------</span><br><span class="line">Changed files:</span><br><span class="line">---------------------------------------------------</span><br><span class="line"></span><br><span class="line">changed: /app/f1</span><br><span class="line"></span><br><span class="line">--------------------------------------------------</span><br><span class="line">Detailed information about changes:</span><br><span class="line">---------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">File: /app/f1</span><br><span class="line">  Atime    : 2017-09-13 15:10:09              , 2017-09-13 15:18:54</span><br><span class="line">  Mtime    : 2017-09-13 15:08:30              , 2017-09-13 15:18:51</span><br><span class="line">  Ctime    : 2017-09-13 15:08:30              , 2017-09-13 15:18:51</span><br><span class="line">  SHA512   : ej+ts/Q6q9CANmKXMfdEdCv3Lcl1otID , vmiIOMqGhuXJBom/KrWFzvETfJmbSMcL</span><br><span class="line">[root@A app]# cd /var/lib/aide/#cd到/var/lib/aide/目录</span><br><span class="line">[root@A aide]# ls</span><br><span class="line">aide.db.gz  aide.db.new.gz</span><br><span class="line">[root@A aide]# cp aide.db.new.gz aide.db.gz #覆盖基准数据库</span><br><span class="line">cp: overwrite `aide.db.gz'? y</span><br><span class="line">[root@A aide]# aide --check#再次检查数据库就没问题了。</span><br><span class="line"></span><br><span class="line">AIDE, version 0.14</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>## All files match AIDE database. Looks okay!</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 安全相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AIDE </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>SSH命令与ssh免密登陆</title>
      <link href="/2017/09/08/SSH-mianmi/"/>
      <url>/2017/09/08/SSH-mianmi/</url>
      <content type="html"><![CDATA[<h3 id="what-is-SSH"><a href="#what-is-SSH" class="headerlink" title="what is SSH?"></a>what is SSH?</h3><p>Secure Shell（缩写为SSH），由IETF的网络工作小组（Network Working Group）所制定；SSH为一项创建在应用层和传输层基础上的安全协议，为计算机上的Shell（壳层）提供安全的传输和使用环境。使用Tcp 22端口。</p><p>ssh协议目前有SSH1和SSH2，SSH2协议兼容SSH1。目前实现SSH1和SSH2协议的主要软件有OpenSSH和SSH Communications Security Corporation　公司的SSH Communications 软件。前者是OpenBSD组织开发的一款免费的SSH软件，后者是商业软件，因此在linux、FreeBSD、OpenBSD、NetBSD等免费类UNIX系统种，通畅都使用OpenSSH作为SSH协议的实现软件。</p><a id="more"></a><h4 id="两种方式的用户登录认证："><a href="#两种方式的用户登录认证：" class="headerlink" title="两种方式的用户登录认证："></a>两种方式的用户登录认证：</h4><ul><li>基于<code>password</code>：知道帐号和密码，就可以登录到远程主机，并且所有传输的数据都会被加密。但是，可能会有别的服务器在冒充真正的服务器，无法避免被“中间人”攻击。</li><li>基于<code>key</code>：需要依靠密钥，也就是你必须为自己创建一对密钥，并把公有密钥放在需要访问的服务器上。客户端软件会向服务器发出请求，请求用你的密钥进行安全验证。服务器收到请求之后，先在你在该服务器的用户根目录下寻找你的公有密钥，然后把它和你发送过来的公有密钥进行比较。如果两个密钥一致，服务器就用公有密钥加密“质询”（challenge）并把它发送给客户端软件。从而避免被“中间人”攻击。</li></ul><h3 id="what-is-OpenSSH"><a href="#what-is-OpenSSH" class="headerlink" title="what is OpenSSH?"></a>what is OpenSSH?</h3><p><code>OpenSSH</code>（<code>OpenBSD Secure Shell</code>）是使用<code>SSH</code>通过计算机网络加密通信的实现。</p><p><code>Centos</code>默认都会装有<code>SSH</code>，默认就是<code>OpenSSH</code>，可以通过 <code>ssh -V</code> 命令来查看安装的<code>ssh</code>版本信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# ssh -V</span><br><span class="line">OpenSSH_6.6.1p1, OpenSSL 1.0.1e-fips 11 Feb 2013</span><br></pre></td></tr></table></figure><p><strong>SSH的客户端工具：</strong></p><p><code>SSH</code>是基于C/S（客户端/服务器端）架构的。</p><ul><li>Linux Client: ssh, scp, sftp， slogin</li><li>Windows客户端：<ul><li>xshell, putty, securecrt, sshsecureshellclient</li></ul></li><li>Server: sshd</li></ul><h3 id="ssh客户端"><a href="#ssh客户端" class="headerlink" title="ssh客户端"></a>ssh客户端</h3><h4 id="配置文件："><a href="#配置文件：" class="headerlink" title="配置文件："></a>配置文件：</h4><p>系统配置文件：(<code>/etc/ssh/ssh_config</code>)</p><p>用户配置文件： (<code>~/.ssh/config</code>)</p><p>下面介绍一些常用的配置项：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Host 别名</span><br><span class="line">HostName 主机名</span><br><span class="line">Port 端口</span><br><span class="line">User 用户名</span><br><span class="line">IdentityFile 密钥文件的路径</span><br><span class="line">IdentitiesOnly 只接受SSH key 登录</span><br><span class="line">PreferredAuthentications 强制使用Public Key验证</span><br><span class="line">StrictHostKeyChecking ask 首次登陆系统是否显示检查提示</span><br></pre></td></tr></table></figure><h4 id="ssh命令"><a href="#ssh命令" class="headerlink" title="ssh命令"></a>ssh命令</h4><p>两种格式：  </p><ul><li>ssh [user@]host [COMMAND]</li><li>ssh [-l user] host [COMMAND]<ul><li><code>-p port</code>：远程服务器监听的端口</li><li><code>-b</code>:指定连接的源IP</li><li><code>-v</code>:调试模式</li><li><code>-C</code>：压缩方式</li><li><code>-X</code>: 支持x11转发</li><li><code>-Y</code>：支持信任x11转发；<code>ForwardX11Trusted yes</code>（需要修改配置文件）</li><li><code>-t</code>: 强制伪tty分配</li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -t remoteserver1 ssh remoteserver2</span><br><span class="line">[root@centos7 .ssh]# ssh -t 192.168.8.128 ssh 192.168.8.141#&lt;==通过192.168.8.128 做跳转机去连接192.168.8.141</span><br></pre></td></tr></table></figure><ul><li>允许实现对远程系统经验证地加密安全访问</li><li>当用户远程连接ssh服务器时，会复制ssh服务器/etc/ssh/ssh_hostkey.pub（CentOS7默认是ssh_host_ecdsa_key.pub）文件中的公钥到客户机的~./ssh/know_hosts中。下次连接时，会自动匹配相应私钥，不能匹配，将拒绝连接</li></ul><h4 id="ssh服务登陆验证"><a href="#ssh服务登陆验证" class="headerlink" title="ssh服务登陆验证"></a>ssh服务登陆验证</h4><h5 id="基于用户和口令登录验证"><a href="#基于用户和口令登录验证" class="headerlink" title="基于用户和口令登录验证"></a>基于用户和口令登录验证</h5><ul><li>1 客户端发起ssh请求，服务器会把自己的公钥发送给用户</li><li>2 用户会根据服务器发来的公钥对密码进行加密</li><li>3 加密后的信息回传给服务器，服务器用自己的私钥解密，如果密码正确，则用户登录成功</li></ul><h5 id="基于密钥的登录方式"><a href="#基于密钥的登录方式" class="headerlink" title="基于密钥的登录方式"></a>基于密钥的登录方式</h5><ul><li>1 首先在客户端生成一对密钥（ssh-keygen）</li><li>2 并将客户端的公钥ssh-copy-id 拷贝到服务端</li><li>3 当客户端再次发送一个连接请求，包括ip、用户名</li><li>4 服务端得到客户端的请求后，会到authorized_keys中查找，如果有响应的IP和用户，就会随机生成一个字符串，例如： acdf</li><li>5 服务端将使用客户端拷贝过来的公钥进行加密，然后发送给客户端</li><li>6 得到服务端发来的消息后，客户端会使用私钥进行解密，然后将解密后的字符串发送给服务端</li><li>7 服务端接受到客户端发来的字符串后，跟之前的字符串进行对比，如果一致，就允许免密码登录</li></ul><p>基于密钥的认证的实现：</p><h6 id="1-在客户端生成密钥对"><a href="#1-在客户端生成密钥对" class="headerlink" title="(1) 在客户端生成密钥对"></a>(1) 在客户端生成密钥对</h6><pre><code><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa [-P ''] [-f “~/.ssh/id_rsa"]  （-P 指定密码）</span><br><span class="line">[root@centos6 ~]# ssh-keygen -t rsa#&lt;==生成密钥对</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">68:ce:fb:1b:e3:ee:ad:d0:06:d4:cd:2f:de:42:26:d3 root@centos6.haiyun.com</span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|                 |</span><br><span class="line">|       . o       |</span><br><span class="line">|      . . o      |</span><br><span class="line">|     . . . .     |</span><br><span class="line">|      + S E .    |</span><br><span class="line">|     + o * o     |</span><br><span class="line">|      + = o .    |</span><br><span class="line">|       = + .     |</span><br><span class="line">|      .+Bo.      |</span><br><span class="line">+-----------------+</span><br></pre></td></tr></table></figure></code></pre><h6 id="2-把公钥文件传输至远程服务器对应用户的家目录"><a href="#2-把公钥文件传输至远程服务器对应用户的家目录" class="headerlink" title="(2) 把公钥文件传输至远程服务器对应用户的家目录"></a>(2) 把公钥文件传输至远程服务器对应用户的家目录</h6><pre><code><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">`ssh-copy-id [-i [identity_file]] [user@]host`#&lt;==注：后面不要加路径</span><br><span class="line">[root@centos7 ~]# ssh-copy-id -i .ssh/id_rsa.pub root@192.168.8.128</span><br><span class="line">root@192.168.8.128's password: </span><br><span class="line">Now try logging into the machine, with "ssh 'root@192.168.8.128'", and check in:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">to make sure we haven't added extra keys that you weren't expecting.</span><br><span class="line">[root@centos6 ~]# ls -l .ssh/authorized_keys #&lt;==查看复制过去的密钥，已改名为authorized_keys</span><br><span class="line">-rw-------. 1 root root 405 Sep 10 16:22 .ssh/authorized_keys</span><br></pre></td></tr></table></figure></code></pre><h6 id="3-测试"><a href="#3-测试" class="headerlink" title="(3) 测试"></a>(3) 测试</h6><pre><code><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# ssh 192.168.8.128#&lt;==已实现免密登陆</span><br><span class="line">Last login: Sun Sep 10 16:09:15 2017 from 192.168.8.128</span><br><span class="line">﻿ </span><br><span class="line">  .--,       .--,</span><br><span class="line"> ( (  \.---./  ) )</span><br><span class="line">  '.__/o   o\__.'</span><br><span class="line">     &#123;=  ^  =&#125;</span><br><span class="line">      &gt;  -  &lt;</span><br><span class="line">     /       \</span><br><span class="line">    //       \\</span><br><span class="line">   //|   .   |\\</span><br><span class="line">   "'\       /'"_.-~^`'-.</span><br><span class="line">      \  _  /--'         `</span><br><span class="line">    ___)( )(___</span><br><span class="line">   (((__) (__)))    高山仰止,景行行止.虽不能至,心向往之。</span><br></pre></td></tr></table></figure></code></pre><h6 id="4-在SecureCRT或Xshell实现基于key验证在SecureCRT工具—-gt-创建公钥—-gt-生成Identity-pub文件转化为openssh兼容格式（适合SecureCRT，-Xshell不需要转化格式），并复制到需登录主机上相应文件authorized-keys中-注意权限必须为600，在需登录的ssh主机上执行："><a href="#4-在SecureCRT或Xshell实现基于key验证在SecureCRT工具—-gt-创建公钥—-gt-生成Identity-pub文件转化为openssh兼容格式（适合SecureCRT，-Xshell不需要转化格式），并复制到需登录主机上相应文件authorized-keys中-注意权限必须为600，在需登录的ssh主机上执行：" class="headerlink" title="(4) 在SecureCRT或Xshell实现基于key验证在SecureCRT工具—&gt;创建公钥—&gt;生成Identity.pub文件转化为openssh兼容格式（适合SecureCRT， Xshell不需要转化格式），并复制到需登录主机上相应文件authorized_keys中,注意权限必须为600，在需登录的ssh主机上执行："></a>(4) 在SecureCRT或Xshell实现基于key验证在SecureCRT工具—&gt;创建公钥—&gt;生成Identity.pub文件转化为openssh兼容格式（适合SecureCRT， Xshell不需要转化格式），并复制到需登录主机上相应文件authorized_keys中,注意权限必须为600，在需登录的ssh主机上执行：</h6><p>在xshell中生成密钥</p><center><img src="https://houhaiyun.github.io/img/images/SSH-mianmi-1.jpg" title="在xshell中生成密钥"></center><pre><code><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">将xshell生成的公钥传到服务器中，传到服务器应该不是问题。</span><br><span class="line">[root@centos6 ~]# cat id_rsa_2048.pub &gt;&gt; .ssh/authorized_keys  #&lt;==将生成的公钥导入到.ssh/authorized_keys文件中</span><br></pre></td></tr></table></figure>新建会话：&lt;div align=&quot;center&quot;&gt;![](http://ovuhiuqqd.bkt.clouddn.com/ssh%E7%94%9F%E6%88%90%E5%AF%86%E9%92%A5-1.jpg)</code></pre><h6 id="5-重设私钥口令："><a href="#5-重设私钥口令：" class="headerlink" title="(5)重设私钥口令："></a>(5)重设私钥口令：</h6><pre><code>如果认为这样不够安全，我们可以对私钥设置口令：`ssh-keygen –p`<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ssh-keygen -p #&lt;==会自动找到私钥文件</span><br><span class="line">Enter file in which the key is (/root/.ssh/id_rsa): </span><br><span class="line">Key has comment '/root/.ssh/id_rsa'</span><br><span class="line">Enter new passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved with the new passphrase.</span><br><span class="line">[root@centos7 ~]# ssh 192.168.8.128#&lt;==加密后只需要输入一次口令即可</span><br><span class="line">Enter passphrase for key '/root/.ssh/id_rsa': </span><br><span class="line">Last login: Sun Sep 10 16:55:33 2017 from 192.168.8.1</span><br></pre></td></tr></table></figure></code></pre><h6 id="6-验证代理（authentication-agent）保密解密后的密钥，这样口令就只需要输入一次在GNOME中，代理被自动提供给root用户，否则运行ssh-agent-bash"><a href="#6-验证代理（authentication-agent）保密解密后的密钥，这样口令就只需要输入一次在GNOME中，代理被自动提供给root用户，否则运行ssh-agent-bash" class="headerlink" title="(6)验证代理（authentication agent）保密解密后的密钥，这样口令就只需要输入一次在GNOME中，代理被自动提供给root用户，否则运行ssh-agent bash"></a>(6)验证代理（<code>authentication agent</code>）保密解密后的密钥，这样口令就只需要输入一次在GNOME中，代理被自动提供给<code>root</code>用户，否则运行<code>ssh-agent bash</code></h6><pre><code><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# ssh-agent bash #&lt;==ssh验证代理</span><br></pre></td></tr></table></figure></code></pre><h6 id="7-钥匙通过命令添加给代理"><a href="#7-钥匙通过命令添加给代理" class="headerlink" title="(7)钥匙通过命令添加给代理"></a>(7)钥匙通过命令添加给代理</h6><pre><code>代理只会一次性生效，当退出这个`bash` 代理将失效。添加代理命令：`ssh-add`</code></pre><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# ssh-add#&lt;==添加代理</span><br><span class="line">Enter passphrase for /root/.ssh/id_rsa: </span><br><span class="line">Identity added: /root/.ssh/id_rsa (/root/.ssh/id_rsa)</span><br><span class="line">[root@centos7 ~]# ssh 192.168.8.128#&lt;==代理成功</span><br><span class="line">Last login: Sun Sep 10 17:11:24 2017 from 192.168.8.128</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> SSH </category>
          
          <category> SSH命令与ssh免密登陆 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Openssl证书请求和自签名</title>
      <link href="/2017/09/06/Openssl/"/>
      <url>/2017/09/06/Openssl/</url>
      <content type="html"><![CDATA[<h3 id="概念："><a href="#概念：" class="headerlink" title="概念："></a>概念：</h3><h4 id="PKI、CA、X-509"><a href="#PKI、CA、X-509" class="headerlink" title="PKI、CA、X.509"></a>PKI、CA、X.509</h4><p><strong>PKI:</strong> Public Key Infrastructure </p><p><strong>公开密钥基础建设：</strong> 是一组由硬件、软件、参与者、管理政策与流程组成的基础架构，其目的在于创造、管理、分配、使用、存储以及撤销数字证书。</p><p><strong>X.509：</strong> 是由ITU-T为了公开密钥基础建设（PKI）与授权管理基础建设（PMI）提出的产业标准。X.509标准，规范了公开密钥认证、证书吊销列表、授权证书、证书路径验证算法等。</p><p><strong>CA：</strong> 数字证书认证机构(英文全称：Catificate Authority)。主要负责：证书发放、证书更新、证书撤销和证书验证。</p><a id="more"></a><h3 id="证书获取"><a href="#证书获取" class="headerlink" title="证书获取"></a>证书获取</h3><h4 id="获取证书两种方法："><a href="#获取证书两种方法：" class="headerlink" title="获取证书两种方法："></a>获取证书两种方法：</h4><p><strong>使用证书授权机构</strong></p><ul><li>生成签名请求（<code>csr</code>）</li><li>将<code>csr</code>发送给<code>CA</code></li><li>从<code>CA</code>处接收签名</li></ul><p><strong>自签名的证书</strong></p><ul><li>自已签发自己的公钥</li></ul><h3 id="安全协议"><a href="#安全协议" class="headerlink" title="安全协议"></a>安全协议</h3><h4 id="SSL和TLS协议"><a href="#SSL和TLS协议" class="headerlink" title="SSL和TLS协议"></a>SSL和TLS协议</h4><p>SSL(Secure Sockets Layer 安全套接层),及其继任者传输层安全（Transport Layer Security，TLS）是为网络通信提供安全及数据完整性的一种安全协议。TLS与SSL在传输层对网络连接进行加密。</p><ul><li><code>Handshake</code>协议：包括协商安全参数和密码套件、服务器身份认证（客户端身份认证可选）、密钥交换</li><li><code>ChangeCipherSpec</code> 协议：一条消息表明握手协议已经完成</li><li><code>Alert</code> 协议：对握手协议中一些异常的错误提醒，分为<code>fatal`</code>和<code>warning</code>两个级别， <code>fatal</code>类型错误会直接中断<code>SSL</code>链接，而<code>warning</code>级别的错误<code>SSL</code>链接仍可继续，只是会给出错误警告</li><li><code>Record</code> 协议：包括对消息的分段、压缩、消息认证和完整性保护、加密等</li><li><code>HTTPS</code> 协议：就是<code>“HTTP 协议”</code>和<code>“SSL/TLS 协议</code>”的组合。 <code>HTTP over SSL”</code>或<code>“HTTP over TLS”</code>，对<code>http</code>协议的文本数据进行加密处理后，成为二进制形式传输</li></ul><h3 id="OpenSSL"><a href="#OpenSSL" class="headerlink" title="OpenSSL"></a>OpenSSL</h3><h4 id="OpenSSL：开源项目"><a href="#OpenSSL：开源项目" class="headerlink" title="OpenSSL：开源项目"></a>OpenSSL：开源项目</h4><p><code>OpenSSL</code> 是一个安全套接字层密码库，囊括主要的密码算法、常用的密钥和证书封装管理功能及<code>SSL</code>协议，并提供丰富的应用程序供测试或其它目的使用。</p><p><strong>三个组件：</strong></p><ul><li><code>openssl</code>: 多用途的命令行工具，包<code>openssl</code></li><li><code>libcrypto</code>: 加密算法库，包<code>openssl-libs</code></li><li><code>libssl</code>：加密模块应用库，实现了<code>ssl</code>及<code>tls</code>，包<code>nss</code></li></ul><h4 id="OpenSSL命令："><a href="#OpenSSL命令：" class="headerlink" title="OpenSSL命令："></a>OpenSSL命令：</h4><ul><li>两种运行模式：交互模式和批处理模式</li><li><code>openssl version</code>：查看<code>OpenSSL</code>程序版本号</li><li>标准命令：enc<code>(对称加密),</code>ca<code>(签署证书),</code>req`(生成自签名证书), …</li></ul><h4 id="对称加密enc："><a href="#对称加密enc：" class="headerlink" title="对称加密enc："></a>对称加密enc：</h4><ul><li>工具： <code>openssl enc</code>, <code>gpg</code></li><li>算法： <code>3des</code>, <code>aes</code>, <code>blowfish</code>, <code>twofish</code></li><li>enc命令：<ul><li>帮助： <code>man enc</code></li><li>加密：<code>openssl enc -e -des3 -a -salt -in testfile -out testfile.cipher</code></li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# openssl enc -e -des3 -a -salt -in testfile -out testfile.cipher#&lt;==使用des3算法对testfile文件加密，输出为testfile.cipher</span><br><span class="line">enter des-ede3-cbc encryption password:#&lt;==输入密码</span><br><span class="line">Verifying - enter des-ede3-cbc encryption password:#&lt;==再次输入密码</span><br><span class="line">[root@centos7 app]# cat testfile testfile.cipher #&lt;==查看加密和未加密的文件</span><br><span class="line">this is a test file</span><br><span class="line">U2FsdGVkX1/a0QHbk2ol6aB39zpO7+yS2cZ+jI7YqUQiKfGhC4SqZg==</span><br></pre></td></tr></table></figure><ul><li>解密：<ul><li><code>openssl enc -d -des3 -a -salt –in testfile.cipher-out testfile</code></li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# rm -f testfile#&lt;==删除testfile文件</span><br><span class="line">[root@centos7 app]# openssl enc -d -des3 -a -salt -in testfile.cipher -out testfile#&lt;==使用des3算法对testfile.cipher文件</span><br><span class="line">enter des-ede3-cbc decryption password:#&lt;==输入密码</span><br><span class="line">[root@centos7 app]# ls</span><br><span class="line">testfile  testfile.cipher</span><br><span class="line">[root@centos7 app]# cat testfile#&lt;==查看testfile内容和原来是一样的。</span><br><span class="line">this is a test file</span><br></pre></td></tr></table></figure><pre><code>​</code></pre><h4 id="单向加密dgst"><a href="#单向加密dgst" class="headerlink" title="单向加密dgst"></a>单向加密dgst</h4><p><strong>单向加密：</strong></p><ul><li>工具： <code>md5sum</code>, <code>sha1sum</code>, <code>sha224sum</code>,<code>sha256sum</code>openssl dgst<code>…</code>dgst<code>命令：  帮助：</code>man dgst<code>`</code>openssl dgst -md5 [-hex默认] /PATH/SOMEFILE<code></code>openssl dgst -md5 testfile<code></code>md5sum /PATH/TO/SOMEFILE<code></code></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# openssl dgst -md5 testfile #&lt;==计算testfile的md5</span><br><span class="line">MD5(testfile)= 4221d002ceb5d3c9e9137e495ceaa647</span><br><span class="line">[root@centos7 app]# openssl dgst -md5 -hex testfile #&lt;==-hex是转换为16进制（默认）</span><br><span class="line">MD5(testfile)= 4221d002ceb5d3c9e9137e495ceaa647</span><br><span class="line">[root@centos7 app]# md5sum testfile #&lt;==计算testfile的md5</span><br><span class="line">4221d002ceb5d3c9e9137e495ceaa647  testfile</span><br></pre></td></tr></table></figure><p>  ​</p><h4 id="生成用户密码和随机数："><a href="#生成用户密码和随机数：" class="headerlink" title="生成用户密码和随机数："></a>生成用户密码和随机数：</h4><p><strong>生成用户密码：</strong></p><ul><li><code>passwd</code>命令:</li><li>帮助： <code>man sslpasswd</code></li><li><code>openssl passwd -1 -salt SALT</code>(最多8位)</li><li><code>openssl passwd -1 –salt centos</code></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# openssl passwd -1 -salt 12345678#&lt;==生成openssl对passwd密码加密并加盐</span><br><span class="line">Password: </span><br><span class="line">$1$12345678$tRy4cXc3kmcfRZVj4iFXr/</span><br><span class="line">[root@centos7 app]# openssl passwd -1 -salt 123456789#&lt;==注：盐最多8位，如果输入9位是不显示的</span><br><span class="line">Password: </span><br><span class="line">$1$12345678$tRy4cXc3kmcfRZVj4iFXr/</span><br></pre></td></tr></table></figure><p>  ​</p><p><strong>生成随机数：</strong></p><ul><li>帮助： <code>man sslrand</code></li><li><code>openssl rand -base64|-hex NUM</code></li><li><code>NUM</code>: 表示字节数；<code>hex</code>时，每个字符为十六进制，相当于4位二进制，出现的字符数为<code>NUM*2</code></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# openssl rand -hex 16#&lt;==生成的是32位的随机数</span><br><span class="line">5666c7c5f5369120f0c8c3254fa82abe</span><br><span class="line">[root@centos7 app]# openssl rand -base64 16#&lt;==生成的是16位的随机数</span><br><span class="line">EHpDSxUBcX/uCvYBfhW61w==</span><br><span class="line">[root@centos7 app]# openssl rand -base64 -hex 16#&lt;==-hex和-base64是不能放在一块使用的</span><br><span class="line">Usage: rand [options] num</span><br></pre></td></tr></table></figure><p>  ​</p><h4 id="生成密码对儿：man-genresa"><a href="#生成密码对儿：man-genresa" class="headerlink" title="生成密码对儿：man genresa"></a>生成密码对儿：man genresa</h4><p><strong>生成私钥：</strong></p><ul><li><code>openssl genrsa -out /PATH/TO/PRIVATEKEY.FILE NUM_BITS</code></li><li><code>(umask 077; openssl genrsa –out test.key –des 2048)</code><br><strong>从私钥中提取出公钥</strong></li><li><code>openssl rsa -in PRIVATEKEYFILE –pubout –out PUBLICKEYFILE</code></li><li><code>Openssl rsa –in test.key –pubout –out test.key.pub</code></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# (umask 077 ; openssl genrsa -out test.key -des3 2048)#&lt;==生成私钥，其权限为600</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">................................+++</span><br><span class="line">.........+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">Enter pass phrase for test.key:</span><br><span class="line">Verifying - Enter pass phrase for test.key:</span><br><span class="line">[root@centos7 app]# openssl rsa -in test.key -pubout -out test.key.pub#&lt;==从私钥中，提取出公钥</span><br><span class="line">Enter pass phrase for test.key:</span><br><span class="line">writing RSA key</span><br><span class="line">[root@centos7 app]# ll#&lt;==查看生成的私钥和提取出来的公钥</span><br><span class="line">total 8</span><br><span class="line">-rw-------. 1 root root 1751 Sep  9 21:29 test.key</span><br><span class="line">-rw-r--r--. 1 root root  451 Sep  9 21:30 test.key.pub</span><br></pre></td></tr></table></figure><p>  ​</p><h4 id="随机数生成器：伪随机数字"><a href="#随机数生成器：伪随机数字" class="headerlink" title="随机数生成器：伪随机数字"></a>随机数生成器：伪随机数字</h4><ul><li>键盘和鼠标</li><li>块设备中断：cp一个大文件可以生成很多随机数</li><li><code>/dev/random</code>：仅从熵池返回随机数；随机数用尽，阻塞</li><li><code>/dev/urandom</code>：从熵池返回随机数；随机数用尽，会利用软件生成伪随机数,非阻塞</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 script]#  head /dev/urandom | cksum #&lt;==通过/dev/urandom配合cksum生成随机数</span><br><span class="line">1712568099 3350</span><br><span class="line">[root@centos6 script]#  head /dev/urandom | cksum </span><br><span class="line">1558657086 1998</span><br></pre></td></tr></table></figure><p>  ​</p><h3 id="建立私有CA"><a href="#建立私有CA" class="headerlink" title="建立私有CA"></a>建立私有CA</h3><ul><li><code>openssl</code>的配置文件： <code>/etc/pki/tls/openssl.cnf</code></li><li>三种策略： 匹配、支持和可选</li><li>匹配指要求申请填写的信息跟<code>CA</code>设置信息必须一致， 支持指必须填写这项申请信息， 可选指可有可无</li></ul><h5 id="1-创建所需要的文件"><a href="#1-创建所需要的文件" class="headerlink" title="1. 创建所需要的文件"></a>1. 创建所需要的文件</h5><p><code>touch /etc/pki/CA/index.txt</code> 生成证书索引数据库文件<br><code>echo 01 &gt; /etc/pki/CA/serial</code> 指定第一个颁发证书的序列号</p><h5 id="2-CA自签证书"><a href="#2-CA自签证书" class="headerlink" title="2.  CA自签证书"></a>2.  CA自签证书</h5><p><strong>生成私钥</strong><br><code>cd /etc/pki/CA/</code><br><code>(umask 066; openssl genrsa -out  /etc/pki/CA/private/cakey.pem 2048)</code></p><h5 id="3-生成自签名证书"><a href="#3-生成自签名证书" class="headerlink" title="3. 生成自签名证书"></a>3. 生成自签名证书</h5><p><code>openssl req -new -x509 –key</code><br><code>/etc/pki/CA/private/cakey.pem -days 7300 -out /etc/pki/CA/cacert.pem</code><br>  <code>-new</code>: 生成新证书签署请求<br>  <code>-x509</code>: 专用于<code>CA</code>生成自签证书<br>  <code>-key</code>: 生成请求时用到的私钥文件<br>  <code>-days n</code>：证书的有效期限<br>  <code>-out /PATH/TO/SOMECERTFILE</code>: 证书的保存路径</p><h5 id="4-生成证书的各字段详解："><a href="#4-生成证书的各字段详解：" class="headerlink" title="4. 生成证书的各字段详解："></a>4. 生成证书的各字段详解：</h5><table><thead><tr><th><strong>DN字段名</strong></th><th><strong>缩写</strong></th><th><strong>说明</strong></th><th><strong>填写要求</strong></th></tr></thead><tbody><tr><td>Country Name</td><td>C</td><td>证书持有者所在国家</td><td>要求填写国家代码，用2个字母表示</td></tr><tr><td>State or Province Name</td><td>ST</td><td>证书持有者所在州或省份</td><td>填写全称，可省略不填</td></tr><tr><td>Locality Name</td><td>L</td><td>证书持有者所在城市</td><td>可省略不填</td></tr><tr><td>Organization Name</td><td>O</td><td>证书持有者所属组织或公司</td><td>最好还是填一下</td></tr><tr><td>Organizational Unit Name</td><td>OU</td><td>证书持有者所属部门</td><td>可省略不填</td></tr><tr><td>Common Name</td><td>CN</td><td>证书持有者的通用名</td><td>必填。对于非应用证书，它应该在一定程度上具有惟一性；对于应用证书，一般填写服务器域名或通配符样式的域名。</td></tr><tr><td>Email Address</td><td></td><td>证书持有者的通信邮箱</td><td>可省略不填</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# touch /etc/pki/CA/index.txt#&lt;==生成证书索引数据库文件</span><br><span class="line">[root@centos7 ~]# echo 01 &gt; /etc/pki/CA/serial#&lt;==指定第一个颁发证书的序列号</span><br><span class="line">[root@centos7 ~]# cd /etc/pki/CA/</span><br><span class="line">[root@centos7 CA]# (umask 066 ; openssl genrsa -out /etc/pki/CA/private/cakey.pem 2048)#&lt;== 生成私钥</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">.................................+++</span><br><span class="line">......................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">[root@centos7 CA]# openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days 7300 -out /etc/pki/CA/cacert.pem #&lt;==生成自签名证书</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter '.', the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:haidian  </span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:iav18.com</span><br><span class="line">Organizational Unit Name (eg, section) []:opt</span><br><span class="line">Common Name (eg, your name or your server's hostname) []:ca.iav18.com</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure><h3 id="证书申请过程："><a href="#证书申请过程：" class="headerlink" title="证书申请过程："></a>证书申请过程：</h3><h4 id="证书申请及签署步骤："><a href="#证书申请及签署步骤：" class="headerlink" title="证书申请及签署步骤："></a>证书申请及签署步骤：</h4><ol><li>生成申请请求</li><li><code>RA</code>核验</li><li><code>CA</code>签署</li><li>获取证书</li></ol><h4 id="创建CA和申请证书"><a href="#创建CA和申请证书" class="headerlink" title="创建CA和申请证书"></a>创建CA和申请证书</h4><h5 id="1-在需要使用证书的主机生成证书请求"><a href="#1-在需要使用证书的主机生成证书请求" class="headerlink" title="1. 在需要使用证书的主机生成证书请求"></a>1. 在需要使用证书的主机生成证书请求</h5><p>  给<code>web</code>服务器生成私钥<br>  <code>(umask 066; openssl genrsa -out /etc/pki/tls/private/test.key 2048)</code><br>  生成证书申请文件<br>  <code>openssl req -new -key /etc/pki/tls/private/test.key -days 365 -out etc/pki/tls/test.csr</code></p><p>将证书请求文件传输给<code>CA</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# (umask 066 ; openssl genrsa -out /etc/pki/tls/private/test.key 2048)#&lt;== 生成私钥</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">...............................................+++</span><br><span class="line">..................................................................................................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">[root@centos6 ~]# openssl req -new -key /etc/pki/tls/private/test.key -days 365 -out /etc/pki/tls/test.csr#&lt;==生成证书申请文件</span><br><span class="line">[root@centos6 ~]# openssl req -new -key /etc/pki/CA/private/test.key -out test.csr </span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter '.', the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN#&lt;==此项必须一样</span><br><span class="line">State or Province Name (full name) []:beijing#&lt;==此项必须一样</span><br><span class="line">Locality Name (eg, city) [Default City]:caoyang</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:iav18.com#&lt;==此项必须一样</span><br><span class="line">Organizational Unit Name (eg, section) []:opt</span><br><span class="line">Common Name (eg, your name or your server's hostname) []:www.ihaiyun.com</span><br><span class="line">Email Address []:</span><br><span class="line"></span><br><span class="line">Please enter the following 'extra' attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:#&lt;==是否添加密码</span><br><span class="line">An optional company name []:#&lt;==公司名称</span><br><span class="line">[root@centos6 ~]# scp test.csr 192.168.8.129:/etc/pki/CA#&lt;==将证书请求文件传输给CA</span><br><span class="line">root@192.168.8.129's password: </span><br><span class="line">test.csr                      100% 1013     1.0KB/s   00:00</span><br></pre></td></tr></table></figure><h5 id="2-RA核验与CA签署"><a href="#2-RA核验与CA签署" class="headerlink" title="2. RA核验与CA签署"></a>2. <code>RA</code>核验与<code>CA</code>签署</h5><p><code>CA</code>签署证书<br>  <code>openssl ca -in /tmp/test.csr –out /etc/pki/CA/certs/test.crt -days 365</code><br>  同一个请求默认是不能签署两次的，修改配文件也能允许修改两次（还未截图，需要截图）<br>注意：默认国家，省，公司名称三项必须和<code>CA</code>一致   </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 CA]# openssl ca -in /etc/pki/CA/test.csr -out /etc/pki/CA/certs/test.crt#&lt;==CA签署认证</span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">Certificate Details:</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep  9 16:31:14 2017 GMT</span><br><span class="line">            Not After : Sep  9 16:31:14 2018 GMT</span><br><span class="line">        Subject:</span><br><span class="line">            countryName               = CN</span><br><span class="line">            stateOrProvinceName       = beijing</span><br><span class="line">            localityName              = caoyang</span><br><span class="line">            organizationName          = iav18.com</span><br><span class="line">            organizationalUnitName    = opt</span><br><span class="line">            commonName                = www.ihaiyun.com</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints: </span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment: </span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                C6:DC:8C:69:C1:5F:D2:53:D3:F4:74:D7:AE:4F:0D:8E:4E:5D:3B:13</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:58:76:AE:27:21:CB:7F:FF:7F:BC:B7:BA:31:72:E2:BF:12:AF:78:6A</span><br><span class="line"></span><br><span class="line">Certificate is to be certified until Sep  9 16:31:14 2018 GMT (365 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br><span class="line">[root@centos7 CA]# tree </span><br><span class="line">.</span><br><span class="line">├── cacert.pem</span><br><span class="line">├── certs</span><br><span class="line">│   └── test.crt#&lt;==可以看到证书生成到certs目录下</span><br><span class="line">├── crl</span><br><span class="line">├── index.txt</span><br><span class="line">├── index.txt.attr</span><br><span class="line">├── index.txt.old</span><br><span class="line">├── newcerts</span><br><span class="line">│   └── 01.pem#&lt;==此处也是证书</span><br><span class="line">├── private</span><br><span class="line">│   └── cakey.pem</span><br><span class="line">├── serial</span><br><span class="line">├── serial.old</span><br><span class="line">└── test.csr</span><br><span class="line"></span><br><span class="line">4 directories, 10 files</span><br><span class="line">[root@centos7 CA]# diff certs/test.crt newcerts/01.pem #&lt;==比较这两个文件是相同的</span><br></pre></td></tr></table></figure><h5 id="3-获取证书"><a href="#3-获取证书" class="headerlink" title="3. 获取证书"></a>3. 获取证书</h5><p>安装证书：需要在客户端安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 CA]# scp certs/test.crt 192.168.8.128:/etc/pki/tls/certs#&lt;==复制证书到客户端</span><br><span class="line">root@192.168.8.128's password: </span><br><span class="line">test.crt                      100% 4508     4.4KB/s   00:00    </span><br><span class="line">[root@centos6 ~]# ls -l  /etc/pki/tls/certs/test.crt #&lt;==在客户端确认证书是否存在</span><br><span class="line">-rw-r--r--. 1 root root 4508 Sep 10 00:17 /etc/pki/tls/certs/test.crt</span><br></pre></td></tr></table></figure><p>查看证书中的信息：</p><ul><li><code>openssl x509 -in /PATH/FROM/CERT_FILE -noout -text|issuer|subject|serial|dates</code></li><li><code>penssl ca -status SERIAL</code>查看指定编号的证书状态</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# openssl x509 -in /etc/pki/tls/certs/test.crt -text#&lt;==查看证书内容</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: C=CN, ST=beijing, L=haidian, O=iav18.com, OU=opt, CN=ca.iav18.com</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Sep  9 16:31:14 2017 GMT</span><br><span class="line">            Not After : Sep  9 16:31:14 2018 GMT</span><br><span class="line">        Subject: C=CN, ST=beijing, L=caoyang, O=iav18.com, OU=opt, CN=www.ihaiyun.com</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00<img class="github-emoji" title="de" alt="de" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f1e9-1f1ea.png?v8" height="20" width="20">2c:75:19:dd:13:a2:14:ac:9d:2e:23:59:43:</span><br><span class="line">                    1e:3e:68:40:2b:0f:98:a4:10:23:9d:62:5e:bb:af:</span><br><span class="line">                    51:e6:f2:ff:a6:3a:87:df:7c:a7:05:33:7c:16:86:</span><br><span class="line">                    5d:6b:c7:c6:19:bb:71:2c:1e:0a:3d:13:61:6b:ae:</span><br><span class="line">                    47:5b:08:b3:66:c7:60:44:5d:14:d9:e0:50:64:26:</span><br><span class="line">                    40:24:3f:a2:4b:6a:a1:19:e6:6f:5c:76:1e:7e:81:</span><br><span class="line">                    91:b7:ca:97:66:50:dc:40:4b:2f:3d:d3:1b:b8:26:</span><br><span class="line">                    79:4d:00:69:d9:8c:51:3e:24:36:14:14:33:a2:86:</span><br><span class="line">                    57:ed:70:6c:52:b8:0a:c2:5a:51:9b:36:5b:33:72:</span><br><span class="line">                    79<img class="github-emoji" title="cd" alt="cd" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f4bf.png?v8" height="20" width="20">13:1d:a4:13:64:5b:20:46:04:a2:62:e8:0b:</span><br><span class="line">                    e9:06:5f:04:b4:3a:b9:15:b0:14:f5:a1:5d:29:3a:</span><br><span class="line">                    71:9c:bb:5b:b5:7a:77:c5:72:fc:b9:79:e9:df:07:</span><br><span class="line">                    91:6c:df:60:b2:41:72:6b:9d:2c:54:b5:35:dc:84:</span><br><span class="line">                    de:a4:1b:80:15:48:16:40:c2:42:95:bb:ff:0e:d0:</span><br><span class="line">                    66:22:01:4e:02:30:64:53:13:7a:75:5d:37:58:50:</span><br><span class="line">                    df:33:e7:72:f2:97:66:ac:90:ed:22:73:84:ac:88:</span><br><span class="line">                    c7:dd:0e:1c:86:ce:18:bf:2f:fe:b0:c4:42:bb:a9:</span><br><span class="line">                    b1:a9</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints: </span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment: </span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                C6:DC:8C:69:C1:5F:D2:53:D3:F4:74:D7:AE:4F:0D:8E:4E:5D:3B:13</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:58:76:AE:27:21:CB:7F:FF:7F:BC:B7:BA:31:72:E2:BF:12:AF:78:6A</span><br><span class="line"></span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         9a:12:6a:92:f7:c1:b3:fb:fe:2b:f5:89:24:86:b4:b0:8f:af:</span><br><span class="line">         8d:c7:06:92:aa:76:6b:f8:6b:5c:45:5f:21:41:a8:e0:41:00:</span><br><span class="line">         f7:57:51:55:88:f9:0f:cc:2b:7d:c0:b0:99:65:d4:f4:56:e0:</span><br><span class="line">         39:3b:bf:45:db:f1:4a:80:7a:d5:2e:1c:0f:ac:9b:02:ac:28:</span><br><span class="line">         70:19:6d:ba:36:c7:56:0b:7e:96:ea:55:ae:e3:f0:5c:2a:10:</span><br><span class="line">         f4:7e:ea:60:48:63:9e:04:26:d2:92:76:d7:f2:9a:3a:8e:5a:</span><br><span class="line">         20:aa:69:20:d9:25:ec:f5:3d:91:c3:84:fb:8c:50:bf:93:47:</span><br><span class="line">         ff:9a:3e:1a:f2:da:9e:36:f2:3f:81:a8:cc:d5:23:19:ad:b3:</span><br><span class="line">         ee:e2:87:ca:3f:10:3f:9c:bf:72:bd:9c:c8:73:56:28:1f:75:</span><br><span class="line">         fb:f5:10:16:37:6f:ce:b7:56:68:49:e5:8b:24:9c:02:63:67:</span><br><span class="line">         bb:e0:7c:7b:06:f1:82:1a:59:21:06:d9:9f:8d:e4:4e:e6:25:</span><br><span class="line">         cf:96:40:9a:39:69:8b:7e:70:aa:df:93:40:66:e8:8e:3b:52:</span><br><span class="line">         c6:58:2a:ad:54:a6:1d:a2:e6:b6:0a:1d:c3:9c:92:b1:c6:2b:</span><br><span class="line">         7d:30:3a:42:36:57:4a:9e:d9:b0:75:05:9d:19:4b:cf:eb:8d:</span><br><span class="line">         9a:61:0a:b7</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIDzTCCArWgAwIBAgIBATANBgkqhkiG9w0BAQsFADBqMQswCQYDVQQGEwJDTjEQ</span><br><span class="line">MA4GA1UECAwHYmVpamluZzEQMA4GA1UEBwwHaGFpZGlhbjESMBAGA1UECgwJaWF2</span><br><span class="line">MTguY29tMQwwCgYDVQQLDANvcHQxFTATBgNVBAMMDGNhLmlhdjE4LmNvbTAeFw0x</span><br><span class="line">NzA5MDkxNjMxMTRaFw0xODA5MDkxNjMxMTRaMG0xCzAJBgNVBAYTAkNOMRAwDgYD</span><br><span class="line">VQQIDAdiZWlqaW5nMRAwDgYDVQQHDAdjYW95YW5nMRIwEAYDVQQKDAlpYXYxOC5j</span><br><span class="line">b20xDDAKBgNVBAsMA29wdDEYMBYGA1UEAwwPd3d3LmloYWl5dW4uY29tMIIBIjAN</span><br><span class="line">BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA3ix1Gd0TohSsnS4jWUMePmhAKw+Y</span><br><span class="line">pBAjnWJeu69R5vL/pjqH33ynBTN8FoZda8fGGbtxLB4KPRNha65HWwizZsdgRF0U</span><br><span class="line">2eBQZCZAJD+iS2qhGeZvXHYefoGRt8qXZlDcQEsvPdMbuCZ5TQBp2YxRPiQ2FBQz</span><br><span class="line">ooZX7XBsUrgKwlpRmzZbM3J5zRMdpBNkWyBGBKJi6AvpBl8EtDq5FbAU9aFdKTpx</span><br><span class="line">nLtbtXp3xXL8uXnp3weRbN9gskFya50sVLU13ITepBuAFUgWQMJClbv/DtBmIgFO</span><br><span class="line">AjBkUxN6dV03WFDfM+dy8pdmrJDtInOErIjH3Q4chs4Yvy/+sMRCu6mxqQIDAQAB</span><br><span class="line">o3sweTAJBgNVHRMEAjAAMCwGCWCGSAGG+EIBDQQfFh1PcGVuU1NMIEdlbmVyYXRl</span><br><span class="line">ZCBDZXJ0aWZpY2F0ZTAdBgNVHQ4EFgQUxtyMacFf0lPT9HTXrk8Njk5dOxMwHwYD</span><br><span class="line">VR0jBBgwFoAUWHauJyHLf/9/vLe6MXLivxKveGowDQYJKoZIhvcNAQELBQADggEB</span><br><span class="line">AJoSapL3wbP7/iv1iSSGtLCPr43HBpKqdmv4a1xFXyFBqOBBAPdXUVWI+Q/MK33A</span><br><span class="line">sJll1PRW4Dk7v0Xb8UqAetUuHA+smwKsKHAZbbo2x1YLfpbqVa7j8FwqEPR+6mBI</span><br><span class="line">Y54EJtKSdtfymjqOWiCqaSDZJez1PZHDhPuMUL+TR/+aPhry2p428j+BqMzVIxmt</span><br><span class="line">s+7ih8o/ED+cv3K9nMhzVigfdfv1EBY3b863VmhJ5YsknAJjZ7vgfHsG8YIaWSEG</span><br><span class="line">2Z+N5E7mJc+WQJo5aYt+cKrfk0Bm6I47UsZYKq1Uph2i5rYKHcOckrHGK30wOkI2</span><br><span class="line">V0qe2bB1BZ0ZS8/rjZphCrc=</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure><h4 id="吊销证书"><a href="#吊销证书" class="headerlink" title="吊销证书"></a>吊销证书</h4><h5 id="1-在客户端获取要吊销的证书的serial"><a href="#1-在客户端获取要吊销的证书的serial" class="headerlink" title="1. 在客户端获取要吊销的证书的serial"></a>1. 在客户端获取要吊销的证书的<code>serial</code></h5><p><code>openssl x509 -in /PATH/FROM/CERT_FILE -noout -serial -subject</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# openssl x509 -in /etc/pki/tls/certs/test.crt -noout -serial -subject</span><br><span class="line">serial=01</span><br><span class="line">subject= /C=CN/ST=beijing/L=caoyang/O=iav18.com/OU=opt/CN=www.ihaiyun.com</span><br></pre></td></tr></table></figure><h5 id="2-在CA上，根据客户提交的serial与subject信息，对比检验是否与index-txt文件中的信息一致，吊销证书："><a href="#2-在CA上，根据客户提交的serial与subject信息，对比检验是否与index-txt文件中的信息一致，吊销证书：" class="headerlink" title="2. 在CA上，根据客户提交的serial与subject信息，对比检验是否与index.txt文件中的信息一致，吊销证书："></a>2. 在CA上，根据客户提交的<code>serial</code>与<code>subject</code>信息，对比检验是否与<code>index.txt</code>文件中的信息一致，吊销证书：</h5><p><code>openssl ca -revoke /etc/pki/CA/newcerts/SERIAL.pem</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 CA]# openssl ca -revoke /etc/pki/CA/newcerts/01.pem </span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Revoking Certificate 01.</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure><h5 id="3-指定第一个吊销证书的编号"><a href="#3-指定第一个吊销证书的编号" class="headerlink" title="3. 指定第一个吊销证书的编号"></a>3. 指定第一个吊销证书的编号</h5><p>注意：第一次更新证书吊销列表前，才需要执行<br>echo 01 &gt; /etc/pki/CA/crlnumber</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 CA]# echo 01 &gt; /etc/pki/CA/crlnumber</span><br></pre></td></tr></table></figure><h5 id="4-更新证书吊销列表"><a href="#4-更新证书吊销列表" class="headerlink" title="4. 更新证书吊销列表"></a>4. 更新证书吊销列表</h5><p>更新证书吊销列</p><p>openssl ca -gencrl -out /etc/pki/CA/crl/crl.pem<br>查看crl文件：<br>openssl crl -in /etc/pki/CA/crl/crl.pem -noout -text </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 CA]# openssl ca -gencrl -out /etc/pki/CA/crl/crl.pem#&lt;==更新证书吊销列表</span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">[root@centos7 CA]# openssl crl -in /etc/pki/CA/crl/crl.pem -noout -text#&lt;==查看crl文件</span><br><span class="line">Certificate Revocation List (CRL):</span><br><span class="line">        Version 2 (0x1)</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: /C=CN/ST=beijing/L=haidian/O=iav18.com/OU=opt/CN=ca.iav18.com</span><br><span class="line">        Last Update: Sep  9 17:10:46 2017 GMT</span><br><span class="line">        Next Update: Oct  9 17:10:46 2017 GMT</span><br><span class="line">        CRL extensions:</span><br><span class="line">            X509v3 CRL Number: </span><br><span class="line">                1</span><br><span class="line">Revoked Certificates:</span><br><span class="line">    Serial Number: 01</span><br><span class="line">        Revocation Date: Sep  9 17:07:32 2017 GMT</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         0c:64:a1:42:af:0d:e0:32:f3:3c:29:80:bb:cf:a3:10:dc:e4:</span><br><span class="line">         b5:61:f1:8c:c0:a2:8d:92:03:82:83:0a:b2:5f:e7:37:a1:7d:</span><br><span class="line">         e2:e9:a7:3c:4b:95:e3:0e:57:b7:f3:af:cf:ba:7c:ce:e6:a5:</span><br><span class="line">         be:cc:78:cb:2b:3e:73:a7:0e:c8:d8:f7:a5:5b:5b:61:70:fe:</span><br><span class="line">         94:1a:41:6f:cb:fb:29:5d:04:56:e4:a1:44:85:d9:69:56:a5:</span><br><span class="line">         01:2e:a1:f8:35:97:e3:ba:91:31:ab:e3:9b:f7:e2:34:03:3b:</span><br><span class="line">         9e:b7:19:8c:96<img class="github-emoji" title="cd" alt="cd" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f4bf.png?v8" height="20" width="20">89:e7:47:42:49:5b:8e:24:e6:10:d5:4b:</span><br><span class="line">         e6:8d:c2:73:42:e5:eb:a9:87:6b:20:52:66:47:f4:55:2b:09:</span><br><span class="line">         78:a6:d0:17:0d:39:d2:6b:4e:c4:d4:61:98:31:28:19:d3:b7:</span><br><span class="line">         c1:3f:08:09:2b:61:b7:87:a3:f4:4a:10:fa:59:e8:6f:06:db:</span><br><span class="line">         8d:89:7c:10:29:fc:bc:37:52:4b:35:48:1c:4d:af:a9:fd:f2:</span><br><span class="line">         38:69:d7:e0:4f:45:98:61:f8:03:cf:ca:a5:8e:3b:f2:ca:0d:</span><br><span class="line">         d7:b0:de:81:ec:65:8f:39:41:1d:f1:98:46:6a:a9:3d:7e:72:</span><br><span class="line">         b1:13:4d:fd:e6:a8:20:57:06:e7:51:98:dd:e1:a1:49:95:5c:</span><br><span class="line">         9c:ce:10:0f</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> 安全相关 </category>
          
          <category> Openssl证书请求和自签名 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Openssl </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>IP地址</title>
      <link href="/2017/09/01/Linux-IP-Address/"/>
      <url>/2017/09/01/Linux-IP-Address/</url>
      <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>互联网协议地址（英语：Internet Protocol Address，又译为网际协议地址），缩写为IP地址（英语：IP Address），是分配给网络上使用网际协议（英语：Internet Protocol, IP）的设备的数字标签。常见的IP地址分为IPv4与IPv6两大类。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-IP-Address-1.jpg" title="IP地址"></center><a id="more"></a><p>IP地址是在计算机网络中被用来唯一标识一台设备的一组数字，各个节点（设备）之间使用IP协议进行通信。IP地址的层次是按网络结构进行划分，一个IP地址是由网络号和主机号两部分组成。</p><h3 id="IP地址组成"><a href="#IP地址组成" class="headerlink" title="IP地址组成"></a>IP地址组成</h3><p><strong>IP地址有两部分组成：</strong></p><p><strong>网络号码字段（net-id）：</strong></p><ul><li>用于区分不同网络。网络号码字段的前几位称为类别字段（又称为类别比特），用来区分IP地址的类型。</li></ul><p><strong>主机ID（host-id）：</strong></p><ul><li>用于区分一个网络内的不同主机</li></ul><p>IP地址的网络号码字段用来标识一个网络，主机号码字段用来标识网络中网络设备的一个连接。如果有多台网络设备，无论它们分别处于任何物理位置，只要它们具有相同的网络号，那他们就处在同一网络中。也就是说，在公共网络内的多台网络设备是否处于相同网络与它们所处的物理位置无关。</p><h3 id="IPv4地址"><a href="#IPv4地址" class="headerlink" title="IPv4地址"></a>IPv4地址</h3><p>IP地址由32位二进制数值组成，但为了便于用户识别和记忆，采用了“点分十进制表示法”。采用了这种表示法的IP地址由4个由点分隔的十进制整数来表示，每个十进制整数对应一个字节。例如，A主机的IP地址使用二进制的表示形式为00001010 00000001 00000001 00000010，采用点分十进制表示法表示为10.1.1.2。</p><p>IP地址是唯一的。目前IP技术可能使用的IP地址最多可有4,294,967,296个（即232）。骤看可能觉得很难会用尽，但由于早期编码和分配上的问题，使很多区域的编码实际上被空出或不能使用。加上互联网的普及，使大部分家庭都至少有一部电脑，连同公司的电脑，以及连接网络的各种设备都消耗了大量IPv4地址资源。</p><p>随着互联网的快速成长，IPv4的42亿个地址的分配最终于2011年2月3日用尽。相应的科研组织已研究出128位的 IPv6，其IP地址数量最高可达3.402823669 × 1038个，届时每个人家居中的每件电器，每件对象，甚至地球上每一粒沙子都可以拥有自己的IP地址。</p><h4 id="地址分类"><a href="#地址分类" class="headerlink" title="地址分类"></a>地址分类</h4><p>地址可分为A、B、C、D、E五大类，其中E类属于特殊保留地址。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-IP-Address-2.jpg" title="地址分类"></center><p>通过网络号码字段的前几个比特就可以判断IP地址属于哪一类，这是区分各类地址最简单的方法。</p><h4 id="地址范围"><a href="#地址范围" class="headerlink" title="地址范围"></a>地址范围</h4><p>在A类、B类、C类IP地址中，如果主机号是全1，那么这个地址为直接广播地址，它是用来使路由器将一个分组以广播形式发送给特定网络上的所有主机。32位全为1的IP地址“255.255.255.255”为受限广播地址（”limited broadcast” destination address），用来将一个分组以广播方式发送给本网络中的所有主机，路由器则阻挡该分组通过，将其广播功能限制在本网内部。</p><table><thead><tr><th>网络类型</th><th>地址范围</th><th>用户可用的IP网络范围</th><th>说明</th></tr></thead><tbody><tr><td>A</td><td>0.0.0.0～127.255.255.255</td><td>1.0.0.0～126.0.0.0</td><td>全0的主机号码表示该IP地址就是网络的地址，用于网络路由；全1的主机号码表示广播地址，即对该网络上所有的主机进行广播；IP地址0.0.0.0仅在采用DHCP方式的系统启动时允许本主机利用它进行临时的通信，并且永远不是有效目的地址；网络号码为0的IP地址表示当前网络的主机，可以让机器引用自己的网络而不必知道其网络号；所有形如127.X.Y.Z的地址都保留作环回测试，发送到这个地址的分组不会输出到线路上，它们被内部处理并当作输入分组。</td></tr><tr><td>B</td><td>128.0.0.0～191.255.255.255</td><td>128.1.0.0～191.254.0.0</td><td>全0的主机号码表示该IP地址就是网络的地址，用于网络路由；全1的主机号码表示广播地址，即对该网络上所有的主机进行广播。</td></tr><tr><td>C</td><td>192.0.0.0～223.255.255.255</td><td>192.0.1.0～223.255.254.0</td><td>全0的主机号码表示该IP地址就是网络的地址，用于网络路由；全1的主机号码表示广播地址，即对该网络上所有的主机进行广播。</td></tr><tr><td>D</td><td>224.0.0.0～239.255.255.255</td><td>无</td><td>D类地址是一种组播地址。</td></tr><tr><td>E</td><td>240.0.0.0～255.255.255.255</td><td>无</td><td>保留。255.255.255.255用于局域网广播地址。</td></tr></tbody></table><h4 id="特殊地址"><a href="#特殊地址" class="headerlink" title="特殊地址"></a>特殊地址</h4><table><thead><tr><th>IP地址网络号</th><th>IP地址子网号</th><th>IP地址主机号</th><th>能否作为源端地址</th><th>能否作为目的端地址</th><th>描述</th></tr></thead><tbody><tr><td>全0</td><td>-</td><td>全0</td><td>可以</td><td>不可以</td><td>用于网络上的主机</td></tr><tr><td>全0</td><td>-</td><td>主机号</td><td>可以</td><td>不可以</td><td>用于网络上的特定主机</td></tr><tr><td>127</td><td>-</td><td>任何值</td><td>可以</td><td>可以</td><td>用于环回地址</td></tr><tr><td>全1</td><td>-</td><td>全1</td><td>不可以</td><td>可以</td><td>用于受限的广播（永远不被转发）</td></tr><tr><td>net-id</td><td>-</td><td>全1</td><td>不可以</td><td>可以</td><td>用于向以net-id为目的的网络广播</td></tr><tr><td>net-id</td><td>subnet-id</td><td>全1</td><td>不可以</td><td>可以</td><td>用于向以net-id，subnet-id为目的的子网广播</td></tr><tr><td>net-id</td><td>全1</td><td>全1</td><td>不可以</td><td>可以</td><td>用于向以net-id为目的的所有子网广播</td></tr></tbody></table><h4 id="私有IP地址"><a href="#私有IP地址" class="headerlink" title="私有IP地址"></a>私有IP地址</h4><p>为了解决IP地址短缺的问题，提出了私有地址的概念。私有地址是指内部网络或主机地址，这些地址只能用于某个内部网络，不能用于公共网络。RFC1918描述了为私有网络预留的3个IP地址段。</p><p>IP地址分配组织规定将下列的IP地址保留用作私有地址，如下</p><table><thead><tr><th>网络类型</th><th>地址范围</th></tr></thead><tbody><tr><td>A</td><td>10.0.0.0～10.255.255.255</td></tr><tr><td>B</td><td>172.16.0.0～172.31.255.255</td></tr><tr><td>C</td><td>192.168.0.0～192.168.255.255</td></tr></tbody></table><h3 id="IPv6地址"><a href="#IPv6地址" class="headerlink" title="IPv6地址"></a>IPv6地址</h3><p>从IPv4到IPv6最显著的变化就是网络地址的长度，有128位长；IPv6地址的表达形式，一般采用32个十六进制数。</p><p>本文中大多数IP地址指的是IPv4地址，不对IPv6做过多讲解。</p><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://zh.wikipedia.org/wiki/IP%E5%9C%B0%E5%9D%80" target="_blank" rel="noopener">维基百科：IP地址</a><br><a href="http://support.huawei.com/enterprise/docinforeader!loadDocument1.action?contentId=DOC0000645520&amp;partNo=10092" target="_blank" rel="noopener">华为：IP地址</a></p>]]></content>
      
      <categories>
          
          <category> 网络 </category>
          
          <category> IP地址 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> IP地址 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>at命令</title>
      <link href="/2017/08/28/JiHuaRenWu-AT/"/>
      <url>/2017/08/28/JiHuaRenWu-AT/</url>
      <content type="html"><![CDATA[<h3 id="at命令简介"><a href="#at命令简介" class="headerlink" title="at命令简介"></a>at命令简介</h3><p><strong>Linux at命令可以让使用者指定在 TIME 这个特定时刻执行某个程序或指令</strong></p><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>at [option] TIME</p><a id="more"></a><h3 id="常用选项"><a href="#常用选项" class="headerlink" title="常用选项"></a>常用选项</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-V 显示版本信息:</span><br><span class="line">-l: 列出指定队列中等待运行的作业；相当于atq</span><br><span class="line">-d: 删除指定的作业；相当于atrm</span><br><span class="line">-c: 查看具体作业任务</span><br><span class="line">-f /path/from/somefile：从指定的文件中读取任务</span><br><span class="line">-m:当任务被完成之后，将给用户发送邮件，即使没有标准输出</span><br></pre></td></tr></table></figure><ul><li><strong>注意：作业执行命令的结果中的标准输出和错误以邮件通知给相关用户</strong></li></ul><p><strong>TIME：</strong> 定义出什么时候进行 at 这项任务的时间<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HH:MM [YYYY-mm-dd]</span><br><span class="line">    noon（中午12:00）, midnight（午夜00:00）, teatime（4pm，下午4:00）</span><br><span class="line">    tomorrow（明天）</span><br><span class="line">    now+#&#123;minutes,hours,days, OR weeks&#125;，从现在开始多长时间之后</span><br></pre></td></tr></table></figure></p><h3 id="时间格式"><a href="#时间格式" class="headerlink" title="时间格式"></a>时间格式</h3><ul><li><code>HH:MM 02:00</code><br>  在今日的 HH:MM 进行，若该时刻已过，则明天此时执行任务</li><li><code>HH:MM YYYY-MM-DD 02:00 2016-09-20</code><br>  规定在某年某月的某一天的特殊时刻进行该项任务</li><li><code>HH:MM[am|pm] [Month] [Date]</code><br>  <code>04pm March 17</code>，3月17日下午4:00<br>  <code>17:20 tomorrow</code>，明天17:20</li><li><code>HH:MM[am|pm] + number [minutes|hours|days|weeks]</code><br>  从现在开始多长时间之后才进行该项任务<br>  <code>now + 5 minutes</code>，从现在开始五分钟后<br>  <code>02pm + 3 days</code>，三天后的下午2:00</li></ul><h3 id="at任务执行方式"><a href="#at任务执行方式" class="headerlink" title="at任务执行方式"></a>at任务执行方式</h3><ol><li><p><strong>交互式</strong> </p><p>[root@centos6 ~]# at 12:00<br>at&gt; ifconfig<br>at&gt; <eot><br>job 1 at 2017-08-24 12:00</eot></p></li><li><p><strong>输入重定向</strong> </p></li></ol><pre><code>[root@centos6 ~]# at 15:00 &lt;&lt; END&gt; ifconfig&gt; echo hello haiyun&gt; ENDjob 2 at 2017-08-24 15:00</code></pre><ol start="3"><li><strong>at –f 文件</strong></li></ol><pre><code>[root@centos6 ~]# echo ifconfig &gt; at.txt[root@centos6 ~]# at 12:00 -f at.txt job 3 at 2017-08-24 12:00</code></pre><h3 id="etc-at-allow-deny-控制用户是否能执行at任务"><a href="#etc-at-allow-deny-控制用户是否能执行at任务" class="headerlink" title="/etc/at.{allow,deny}控制用户是否能执行at任务"></a><code>/etc/at.{allow,deny}</code>控制用户是否能执行at任务</h3><p><code>/etc/at.{allow,deny}</code>控制用户是否能执行at任务</p><ul><li>白名单： <code>/etc/at.allow</code> 默认不存在，需要手动创建，只有该文件中的用户才能执行at命令，如果有<code>at.allow</code>文件那么/etc/at.deny将会失效</li><li>黑名单： <code>/etc/at.deny</code> 默认存在，拒绝该文件中用户执行</li><li>at命令， 而没有在at.deny 文件中的使用者则可执行</li><li>如果两个文件都不存在，只有 root 可以执行 at 命令</li></ul><h3 id="at工作原理"><a href="#at工作原理" class="headerlink" title="at工作原理"></a>at工作原理</h3><p><strong>事实上，我们使用at这个命令来生成所要运行的工作，并将这个工作以文本文件的方式写入/var/spool/at目录内，该工作便能等待atd这个服务的去用与执行了。</strong></p><p><strong>at队列存放在/var/spool/at目录中</strong></p><h3 id="atd的启动"><a href="#atd的启动" class="headerlink" title="atd的启动"></a>atd的启动</h3><ul><li><strong>依赖与atd服务,需要启动才能实现at任务</strong></li><li>centos 6：<br>  [root@centos6 ~]# service atd start</li><li>centos 7：<br>  [root@centos7 ~]# systemctl start atd</li></ul><h3 id="查看是否安装at包"><a href="#查看是否安装at包" class="headerlink" title="查看是否安装at包"></a>查看是否安装at包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# rpm -q at         &lt;==查看at包是否安装</span><br><span class="line">at-3.1.13-22.el7.x86_64</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# rpm -ql at        &lt;==查看at安装完成后生成的所有文件</span><br><span class="line">/etc/at.deny</span><br><span class="line">/etc/pam.d/atd</span><br><span class="line">/etc/sysconfig/atd</span><br><span class="line">/usr/bin/at</span><br><span class="line">/usr/bin/atq</span><br><span class="line">/usr/bin/atrm</span><br><span class="line">/usr/bin/batch</span><br><span class="line">/usr/lib/systemd/system/atd.service</span><br><span class="line">/usr/sbin/atd</span><br><span class="line">/usr/sbin/atrun</span><br><span class="line">/usr/share/doc/at-3.1.13</span><br><span class="line">/usr/share/doc/at-3.1.13/ChangeLog</span><br><span class="line">/usr/share/doc/at-3.1.13/Copyright</span><br><span class="line">/usr/share/doc/at-3.1.13/Problems</span><br><span class="line">/usr/share/doc/at-3.1.13/README</span><br><span class="line">/usr/share/doc/at-3.1.13/timespec</span><br><span class="line">/usr/share/man/man1/at.1.gz</span><br><span class="line">/usr/share/man/man1/atq.1.gz</span><br><span class="line">/usr/share/man/man1/atrm.1.gz</span><br><span class="line">/usr/share/man/man1/batch.1.gz</span><br><span class="line">/usr/share/man/man5/at.allow.5.gz</span><br><span class="line">/usr/share/man/man5/at.deny.5.gz</span><br><span class="line">/usr/share/man/man8/atd.8.gz</span><br><span class="line">/usr/share/man/man8/atrun.8.gz</span><br><span class="line">/var/spool/at</span><br><span class="line">/var/spool/at/.SEQ</span><br><span class="line">/var/spool/at/spool</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# rpm -qi at        &lt;==查看at包的相关信息</span><br><span class="line">Name        : at</span><br><span class="line">Version     : 3.1.13</span><br><span class="line">Release     : 22.el7</span><br><span class="line">Architecture: x86_64</span><br><span class="line">Install Date: Wed 23 Aug 2017 09:45:15 AM CST</span><br><span class="line">Group       : System Environment/Daemons</span><br><span class="line">Size        : 97524</span><br><span class="line">License     : GPLv3+ and GPLv2+ and ISC and MIT and Public Domain</span><br><span class="line">Signature   : RSA/SHA256, Mon 21 Nov 2016 01:07:58 AM CST, Key ID 24c6a8a7f4a80eb5</span><br><span class="line">Source RPM  : at-3.1.13-22.el7.src.rpm</span><br><span class="line">Build Date  : Sun 06 Nov 2016 02:16:27 AM CST</span><br><span class="line">Build Host  : worker1.bsys.centos.org</span><br><span class="line">Relocations : (not relocatable)</span><br><span class="line">Packager    : CentOS BuildSystem &lt;http://bugs.centos.org&gt;</span><br><span class="line">Vendor      : CentOS</span><br><span class="line">URL         : http://ftp.debian.org/debian/pool/main/a/at</span><br><span class="line">Summary     : Job spooling tools</span><br><span class="line">Description :</span><br><span class="line">At and batch read commands from standard input or from a specified</span><br><span class="line">file. At allows you to specify that a command will be run at a</span><br><span class="line">particular time. Batch will execute commands when the system load</span><br><span class="line">levels drop to a particular level. Both commands use user&apos;s shell.</span><br><span class="line"></span><br><span class="line">You should install the at package if you need a utility for</span><br><span class="line">time-oriented job control. Note: If it is a recurring job that will</span><br><span class="line">need to be repeated at the same time every day/week, etc. you should</span><br><span class="line">use crontab instead.</span><br></pre></td></tr></table></figure><h3 id="范例"><a href="#范例" class="headerlink" title="范例"></a>范例</h3><h4 id="范例一："><a href="#范例一：" class="headerlink" title="范例一："></a>范例一：</h4><p>再过5分钟后，将/root/.bashrc寄给root自己</p><pre><code>[root@centos6 ~]# at now + 5 minutes        &lt;==记得加sat&gt; /bin/mail/ root -s &quot;testing at job&quot; &lt; /root/.bashrc     &lt;==尽量写绝对路径，因为计划任务的PATH（环境变量）和我们当前bash的PATH是有区别的at&gt; &lt;EOT&gt;job 6 at 2017-08-23 16:49</code></pre><h4 id="范例二："><a href="#范例二：" class="headerlink" title="范例二："></a>范例二：</h4><p>将上述的第6项工作内容列出来查阅</p><pre><code>[root@centos6 ~]# at -c 6#!/bin/sh# atrun uid=0 gid=0# mail root 0umask 22HOSTNAME=centos6.haiyun.com; export HOSTNAMESELINUX_ROLE_REQUESTED=; export SELINUX_ROLE_REQUESTEDSHELL=/bin/bash; export SHELLHISTSIZE=1000; export HISTSIZESSH_CLIENT=192.168.8.1\ 60005\ 22; export SSH_CLIENTSELINUX_USE_CURRENT_RANGE=; export SELINUX_USE_CURRENT_RANGESSH_TTY=/dev/pts/0; export SSH_TTYUSER=root; export USER。。。此处省略一些环境变量MAIL=/var/spool/mail/root; export MAILPATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin; export PATHPWD=/root; export PWDLANG=en_US.UTF-8; export LANGSELINUX_LEVEL_REQUESTED=; export SELINUX_LEVEL_REQUESTEDHISTCONTROL=ignoredups; export HISTCONTROLSHLVL=1; export SHLVLHOME=/root; export HOMELOGNAME=root; export LOGNAMECVS_RSH=ssh; export CVS_RSHSSH_CONNECTION=192.168.8.1\ 60005\ 192.168.8.128\ 22; export SSH_CONNECTIONLESSOPEN=\|\|/usr/bin/lesspipe.sh\ %s; export LESSOPENG_BROKEN_FILENAMES=1; export G_BROKEN_FILENAMEScd /root || {     echo &apos;Execution directory inaccessible&apos; &gt;&amp;2     exit 1}${SHELL:-/bin/sh} &lt;&lt; &apos;marcinDELIMITER2eb18f7b&apos;/bin/mail/ root -s &quot;testing at job&quot; &lt; /root/.bashrc     &lt;==命令marcinDELIMITER2eb18f7b</code></pre><h4 id="范例三："><a href="#范例三：" class="headerlink" title="范例三："></a>范例三：</h4><p>计划在2017-10-08 20:00关机</p><pre><code>[root@centos6 ~]# at 20:00 2017-10-08at&gt; /sbin/poweroff at&gt; &lt;EOT&gt;job 7 at 2017-10-08 20:00</code></pre><h4 id="范例四："><a href="#范例四：" class="headerlink" title="范例四："></a>范例四：</h4><p>删除上面刚刚创建的计划任务</p><pre><code>[root@centos6 ~]# at -l         &lt;==查看计划任务列表1    2017-08-24 12:00 a root7    2017-10-08 20:00 a root3    2017-08-24 12:00 a root2    2017-08-24 15:00 a root[root@centos6 ~]# at -d 7       &lt;==删除计划任务7[root@centos6 ~]# at -l         &lt;==再次查看已被删除1    2017-08-24 12:00 a root3    2017-08-24 12:00 a root2    2017-08-24 15:00 a root</code></pre><h3 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h3><ol><li><code>atm -m</code> 命令，当任务被完成之后，将给用户发送邮件，即使没有标准输出。因为有些命令是没有标准输出的如：<code>useradd</code>，那么如果我们计划任务中写useradd添加用户，我们是看不到输出的，邮件也没有，此时<code>-m</code>选项就可以强制用户发送邮件。</li><li>计划任务中，要使用绝对路径</li><li><code>at.allow</code>要比<code>at.deny</code>优先级高。如果两个文件同时存在的话，那么<code>at.allow</code>生效。如果都不存在,那么就只有root用户可以使用at</li><li><code>at</code>命令是有<code>SUID</code>权限的<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# ll /usr/bin/at</span><br><span class="line">-rwsr-xr-x. 1 root root 54464 Mar 22 08:13 /usr/bin/at</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      <categories>
          
          <category> Linux基础 </category>
          
          <category> at命令 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cron </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>脚本实例一：创建脚本的脚本</title>
      <link href="/2017/08/25/Linux-shell-script1/"/>
      <url>/2017/08/25/Linux-shell-script1/</url>
      <content type="html"><![CDATA[<h3 id="脚本实例一：创建脚本的脚本"><a href="#脚本实例一：创建脚本的脚本" class="headerlink" title="脚本实例一：创建脚本的脚本"></a>脚本实例一：创建脚本的脚本</h3><a id="more"></a><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">read -p "please input scrpit name: " NAME# 输入脚本名</span><br><span class="line">[ -f $NAME ] &amp;&amp;  &#123; echo "$NAME" is already exists &amp;&amp; exit 100 ; &#125;# 判断文件是否存在，如果存在就退出</span><br><span class="line">touch $NAME &amp;&gt; /dev/null            # 创建文件</span><br><span class="line">chmod +x $NAME &amp;&gt; /dev/null # 添加执行权限</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 向脚本输入一下描述内容</span><br><span class="line">cat &gt; $NAME &lt;&lt; END</span><br><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span>——————————————————————————————————————————————</span><br><span class="line"><span class="meta">#</span> File name: $NAME</span><br><span class="line"><span class="meta">#</span> Revision: 2.0</span><br><span class="line"><span class="meta">#</span> Date: `date '+%F %T'`</span><br><span class="line"><span class="meta">#</span> Author: houhaiyun</span><br><span class="line"><span class="meta">#</span> Email: houhaiyun18@163.com</span><br><span class="line"><span class="meta">#</span> Website: http://www.ihaiyun.cc/</span><br><span class="line"><span class="meta">#</span> Copyright: @2017 haiyun</span><br><span class="line"><span class="meta">#</span> License: LGPL v3</span><br><span class="line"><span class="meta">#</span> Description:  </span><br><span class="line"><span class="meta">#</span>——————————————————————————————————————————————</span><br><span class="line"></span><br><span class="line">END</span><br><span class="line"></span><br><span class="line">vim + $NAME # 编辑完成直接打开脚本文件且定位到最后一行，方便编辑</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> END———————————————————————————————————————————</span><br></pre></td></tr></table></figure><h3 id="脚本功能："><a href="#脚本功能：" class="headerlink" title="脚本功能："></a>脚本功能：</h3><p>使用此脚本创建的脚本自动添加执行权限，并添加描述信息，最后直接打开脚本文件，直接编辑。是不是很方便呢？</p><h3 id="脚本执行"><a href="#脚本执行" class="headerlink" title="脚本执行"></a>脚本执行</h3><center><img src="https://houhaiyun.github.io/img/images/Linux-shell-script1-1.gif" title="脚本执行"></center>]]></content>
      
      <categories>
          
          <category> Shell脚本 </category>
          
          <category> 脚本实例一 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 脚本实例一 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Shell 变量简介</title>
      <link href="/2017/08/20/Linux-Shell-bianliang/"/>
      <url>/2017/08/20/Linux-Shell-bianliang/</url>
      <content type="html"><![CDATA[<center><img src="https://houhaiyun.github.io/img/images/Linux-Shell-bianliang.jpg" title="Bash"></center><a id="more"></a><h3 id="什么是变量？"><a href="#什么是变量？" class="headerlink" title="什么是变量？"></a>什么是变量？</h3><p>在程序设计中，变数（英语：<code>variable，scalar</code>）是指一个包含部分已知或未知数值或资讯（即一个值）之储存位址，以及相对应之符号名称（识别字）。通常使用变数名称参照储存值；将名称和内容分开能让被使用的名称独立于所表示的精确讯息之外。电脑源代码中的识别字能在执行期间绑扎一个值，且该变数的值可能在程式执行期间改变。 程序设计中的变数不一定能直接对应到数学中所谓的变数之概念。在程序设计中，变数的值不一定要为方程或数学公式之一部分。程序设计中的变数可使用在一段可重复的程序：在一处赋值，然后使用于另一处，接着在一次赋值，且以相同方式再使用一次（见迭代）。程序设计中的变数通常会给定一个较长的名称，以描述其用途；数学中的变数通常较为简洁，只给定一、两个字母，以方便抄写及操作。</p><h3 id="变量类型"><a href="#变量类型" class="headerlink" title="变量类型"></a>变量类型</h3><ul><li>强类型：变量不经过强制转换，它永远是这个数据类型，不允许隐式的类型转换。一般定义变量时必须指定类型、参与运算必须符合类型要求；调用未声明变量会产生错误 <ul><li>如：<code>java</code>，<code>c#</code></li></ul></li><li>弱类型：语言的运行时会隐式做数据类型转换。无须指定类型，默认均为字符型；参与运算会自动进行隐式类型转换；变量无须事先定义可直接调用 <ul><li>如：<code>bash</code>不支持浮点数，<code>php</code></li></ul></li></ul><h3 id="shell变量命名规则"><a href="#shell变量命名规则" class="headerlink" title="shell变量命名规则"></a>shell变量命名规则</h3><ol><li>不能使程序中的保留字：例如<code>if</code>, <code>for</code></li><li>只能使用数字、字母及下划线，且不能以数字开头</li><li>见名知义</li><li>统一命名规则：驼峰命名法 </li></ol><h3 id="shell变量种类"><a href="#shell变量种类" class="headerlink" title="shell变量种类"></a>shell变量种类</h3><p><strong>根据变量的生效范围等标准：</strong></p><ul><li>本地变量：生效范围为当前<code>shell</code>进程；对当前<code>shell</code>之外的其它<code>shell</code>进程，包括当前<code>shell</code>的子<code>shell</code>进程均无效 </li><li>环境变量：生效范围为当前<code>shell</code>进程及其子进程 </li><li>局部变量：生效范围为当前<code>shell</code>进程中某代码片断(通常指函数) </li><li>位置变量： <code>$1</code>, <code>$2</code>, …来表示，用于让脚本在脚本代码中调用通过命令行传递给它的参数 </li><li>特殊变量： <code>$?</code>, <code>$0</code>, <code>$*</code>, <code>$@</code>, <code>$#</code>,<code>$$</code> </li></ul><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://zh.wikipedia.org/wiki/%E5%8F%98%E9%87%8F_(%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1" target="_blank" rel="noopener">维基百科：变量</a></p>]]></content>
      
      <categories>
          
          <category> Linux基础 </category>
          
          <category> shell脚本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Shell变量 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>硬盘结构</title>
      <link href="/2017/08/02/Linux-Disk-jiegou/"/>
      <url>/2017/08/02/Linux-Disk-jiegou/</url>
      <content type="html"><![CDATA[<h3 id="硬盘盘结构"><a href="#硬盘盘结构" class="headerlink" title="硬盘盘结构"></a>硬盘盘结构</h3><p>硬盘的物理结构一般由磁头与碟片、电动机、主控芯片与排线等部件组成；当主电动机带动碟片旋转时，副电动机带动一组（<strong>磁头</strong>）到相对应的碟片上并确定读取正面还是反面的碟面，磁头悬浮在碟面上画出一个与碟片同心的圆形轨道（<strong>磁轨</strong>或称<strong>柱面</strong>），这时由磁头的磁感线圈感应碟面上的磁性与使用硬盘厂商指定的读取时间或数据间隔定位<strong>扇区</strong>，从而得到该扇区的数据内容；</p><a id="more"></a><center><img src="https://houhaiyun.github.io/img/images/Linux-Disk-jiegou-1.jpg" title="硬盘结构"></center><ul><li>磁道</li></ul><p>当磁盘旋转时，磁头若保持在一个位置上，则每个磁头都会在磁盘表面划出一个圆形轨迹，这些圆形轨迹就叫做磁道（Track）。</p><ul><li>柱面</li></ul><p>在有多个盘片构成的盘组中，由不同盘片的面，但处于同一半径圆的多个磁道组成的一个圆柱面（Cylinder）。</p><ul><li>扇区</li></ul><p>磁盘上的每个磁道被等分为若干个弧段，这些弧段便是硬盘的扇区（Sector）。硬盘的第一个扇区，叫做引导扇区。</p><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://zh.wikipedia.org/wiki/%E7%A1%AC%E7%9B%98#.E7.89.A9.E7.90.86.E7.BB.93.E6.9E.84" target="_blank" rel="noopener">维基百科：硬盘</a></p>]]></content>
      
      <categories>
          
          <category> 计算机基础知识 </category>
          
          <category> 磁盘管理 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 磁盘管理 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>硬盘</title>
      <link href="/2017/08/01/Linux-Disk/"/>
      <url>/2017/08/01/Linux-Disk/</url>
      <content type="html"><![CDATA[<h3 id="机械硬盘"><a href="#机械硬盘" class="headerlink" title="机械硬盘"></a>机械硬盘</h3><p>机械硬盘（<code>HDD</code>）：<code>Hard Disk Drive</code>，即是传统普通硬盘，主要由：盘片，磁头，盘片转轴及控制电机，磁头控制器，数据转换器，接口，缓存等几个部分组成。机械硬盘中所有的盘片都装在一个旋转轴上，每张盘片之间是平行的，在每个盘片的存储面上有一个磁头，磁头与盘片之间的距离比头发丝的直径还小，所有的磁头联在一个磁头控制器上，由磁头控制器负责各个磁头的运动。磁头可沿盘片的半径方向运动，加上盘片每分钟几千转的高速旋转，磁头就可以定位在盘片的指定位置上进行数据的读写操作。数据通过磁头由电磁流来改变极性方式被电磁流写到磁盘上，也可以通过相反方式读取。硬盘为精密设备，进入硬盘的空气必须过滤。</p><a id="more"></a><center><img src="https://houhaiyun.github.io/img/images/Linux-Disk-1.jpg" title="机械硬盘"></center><h4 id="数据接口"><a href="#数据接口" class="headerlink" title="数据接口"></a>数据接口</h4><p>硬盘按数据接口不同，大致分为<code>ATA</code>（<code>IDE</code>）和<code>SATA</code>以及<code>SCSI</code>和<code>SAS</code>。接口速度不是实际硬盘数据传输的速度，目前非基于闪存技术的硬盘数据实际传输速度一般不会超过300MB/s。</p><p><code>ATA</code>，全称<code>Advanced Technology Attachment</code>，是用传统的<code>40-pin</code>并口数据线连接主板与硬盘的，接口速度最大为133MB/s，因为并口线的抗干扰性太差，且排线占用空间较大，不利电脑内部散热，已逐渐被<code>SATA</code>所取代。</p><p><code>SATA</code>，全称<code>Serial ATA</code>，也就是使用串口的<code>ATA</code>接口，因抗干扰性强，且对数据线的长度要求比<code>ATA</code>低很多，支持热插拔等功能，<code>SATA-II</code>的接口速度为<code>300MiB/s</code>，而新的<code>SATA-III</code>标准可达到<code>600MiB/s</code>的传输速度。<code>SATA</code>的数据线也比<code>ATA</code>的细得多，有利于机箱内的空气流通，整理线材也比较方便。</p><p><code>SCSI</code>，全称是<code>Small Computer System Interface</code>（小型机系统接口），经历多代的发展，从早期的<code>SCSI-II</code>，到目前的<code>Ultra320 SCSI</code>以及<code>Fiber-Channel</code>（光纤通道），接口型式也多种多样。<code>SCSI</code>硬盘广为工作站级个人电脑以及服务器所使用，因此会使用较为先进的技术，如碟片转速<code>15000rpm</code>的高转速，且资料传输时<code>CPU</code>占用率较低，但是单价也比相同容量的<code>ATA</code>及<code>SATA</code>硬盘更加昂贵。</p><p><code>SAS</code>（<code>Serial Attached SCSI</code>）是新一代的<code>SCSI</code>技术，和<code>SATA</code>硬盘相同，都是采取序列式技术以获得更高的传输速度，可达到<code>6Gb/s</code>。此外也透过缩小连接线改善系统内部空间等。此外，由于<code>SAS</code>硬盘可以与<code>SATA</code>硬盘共享同样的背板，因此在同一个<code>SAS</code>存储系统中，可以用<code>SATA</code>硬盘来取代部分昂贵的<code>SAS</code>硬盘，节省整体的存储成本。但<code>SATA</code>存储系统并不能连接<code>SAS</code>硬盘。</p><p><code>FC</code>（<code>Fibre Channel</code>，光纤通道接口），拥有此接口的硬盘在使用光纤联接时具有热插拔性、高速带宽（<code>4Gb/s</code>或<code>10Gb/s</code>）、远程连接等特点；内部传输速率也比普通硬盘更高。限制于其高昂的售价，通常用于高端服务器领域。</p><h5 id="RPM转速"><a href="#RPM转速" class="headerlink" title="RPM转速"></a>RPM转速</h5><p>主要用于表征机械转子的转速，硬盘转速也可用此表示。</p><p><code>RPM =round per minute</code> 每分钟多少转</p><h4 id="电源接口"><a href="#电源接口" class="headerlink" title="电源接口"></a>电源接口</h4><p><code>3.5</code>寸的台式机硬盘，与<code>ATA</code>配合使用的是“<code>D形4针电源接口</code>”（俗称“<code>大4pin</code>”），由<code>Molex</code>公司设计并持有专利；而<code>SATA</code>接口也有相应的<code>SATA</code>电源线。</p><p><code>2.5</code>寸的笔记本电脑用硬盘，可直接由数据口供电，不需要额外的电源接口。在插上外接的便携式硬盘盒之后，由计算机外部的<code>USB</code>接口提供电力来源，而单个<code>USB</code>接口供电约为<code>4~5V 500mA</code>，若移动硬盘盒用电需求较高，有时需要接上两个<code>USB</code>接口才能使用，否则，需要外接电源供电。但如今多数新型硬盘盒（使用<code>2.5寸</code>或以下硬盘）已可方便地使用单个<code>USB</code>口供电。</p><h3 id="固态硬盘"><a href="#固态硬盘" class="headerlink" title="固态硬盘"></a>固态硬盘</h3><p>固态硬盘（<code>SSD</code>）： <code>Solid State Drive</code>，用固态电子存储芯片阵列而制成的硬盘，由控制单元和存储单元（<code>FLASH</code>芯片、 <code>DRAM</code>芯片）组成。固态硬盘在接口的规范和定义、功能及使用方法上与普通硬盘的完全相同，在产品外形和尺寸上也与普通硬盘一致。</p><p>本文中只对固态硬盘简单了解。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-Disk-2.jpg" title="固态硬盘"></center>]]></content>
      
      <categories>
          
          <category> 计算机基础知识 </category>
          
          <category> 硬盘 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 硬盘 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>输入输出重定向</title>
      <link href="/2017/07/20/IO-chongdingxiang/"/>
      <url>/2017/07/20/IO-chongdingxiang/</url>
      <content type="html"><![CDATA[<h3 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h3><blockquote><p>在我们开始学习重定向之前，我们先来了解一下文件描述符（fd：file descriptor）</p><p>一切皆文件，大家应该都听过这句话吧，linux的哲学思想。当我们对这些文件进行处理的时候，系统对会对每个打开的文件分配一个文件描述符。<br>文件描述符是一个数字。不同数字代表不同的含义，默认情况下，系统占用了3个，分别是0标准输入（stdin）,1标准输出(stdout), 2标准错误(stderr), 另外3-9是保留的标识符，可以把这些标识符指定成标准输入，输出或者错误作为临时连接。通常这样可以解决很多复杂的重定向请求。</p></blockquote><a id="more"></a><blockquote><p>我们可以在/proc/1/fd目录下查看文件通配符，如下：<br>    [root@centos7 ~]# ll /proc/1/fd<br>    total 0<br>    lrwx——. 1 root root 64 Jul 22 08:00 0 -&gt; /dev/null<br>    lrwx——. 1 root root 64 Jul 22 08:00 1 -&gt; /dev/null<br>    lr-x——. 1 root root 64 Jul 22 11:49 10 -&gt; anon_inode:inotify<br>    lr-x——. 1 root root 64 Jul 22 11:49 11 -&gt; /proc/swaps</p></blockquote><h3 id="I-O重定向出重定向是什么呢？"><a href="#I-O重定向出重定向是什么呢？" class="headerlink" title="I/O重定向出重定向是什么呢？"></a>I/O重定向出重定向是什么呢？</h3><blockquote><p>简单的来讲，I/O重定向就是一个过程，将命令、程序或脚本的输出，作为输入发送到另外一个程序、文件、或命令。</p></blockquote><p><strong>我们在Linux执行命令，它的过程如下图：</strong></p><center><img src="https://houhaiyun.github.io/img/images/IO-chongdingxiang-1.png" title="输入输出重定向"></center><blockquote><ul><li>我们先通过键盘或者文件，进行指令输入</li><li>指令执行完成后，如果正确，会把结果输出到屏幕（因为默认标准输出到屏幕）</li><li>指令执行完成后，如果错误，会把结果输出到屏幕（因为默认标准输出到屏幕）</li></ul></blockquote><h3 id="为何要使用输出重定向呢？"><a href="#为何要使用输出重定向呢？" class="headerlink" title="为何要使用输出重定向呢？"></a>为何要使用输出重定向呢？</h3><blockquote><p>1.当屏幕输出信息较为重要，而我们也需要将信息存下来时</p><p>2.当 执行脚本时，我们不希望看到一些命令的输出结果，可以将它输出到/dev/null（俗称黑洞）丢掉</p><p>3.当执行命令时，需要把错误与正确讯息分别输出时</p></blockquote><h3 id="标准输出和标准错误输出"><a href="#标准输出和标准错误输出" class="headerlink" title="标准输出和标准错误输出"></a>标准输出和标准错误输出</h3><p><strong>标准输出(stdout)：代码为 1 ，使用 &gt; 或 &gt;&gt;</strong></p><p><strong>++示例++</strong>：</p><blockquote><p>1.查看命令执行结果的默认输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# ls  # 我们可以看到默认输出是屏幕</span><br><span class="line">a.txt  b.txt  c.txt  d.txt</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>2.将命令的执行结果输出到文件中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# ls &gt; output.txt # 将ls命令的执行结果重定向到output.txt中</span><br><span class="line">[root@centos7 app]# cat output.txt  # 查看output.txt，ls命令的执行结果已经被重定向到output.txt                              </span><br><span class="line">a.txt</span><br><span class="line">b.txt</span><br><span class="line">c.txt</span><br><span class="line">d.txt</span><br><span class="line">output.txt</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>3.将命令的输出结果追加到一个文件中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# hostname &gt;&gt; output.txt  # 将hostname命令的执行结果重定向到output.txt</span><br><span class="line">[root@centos7 app]# cat output.txt      # 查看output.txt，hostname命令的执行结果已经被重定向到output.txt</span><br><span class="line">a.txt</span><br><span class="line">b.txt</span><br><span class="line">c.txt</span><br><span class="line">d.txt</span><br><span class="line">output.txt</span><br><span class="line">centos7.magedu.com</span><br></pre></td></tr></table></figure></p></blockquote><p><strong>标准错误输出(stdout)：代码为 2 ，使用 2&gt; 或 2&gt;&gt;</strong></p><p><strong>示例</strong></p><blockquote><p>1.错误命令的执行结果默认会输出到屏幕上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# xxx  # 错误命令执行后默认会输出到屏幕</span><br><span class="line">bash: xxx: command not found...</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>2.将错误命令的执行结果输出到文本中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# xxx 2&gt; errput.txt   # 将xxx这个命令执行结果错误重定向到errput.txt文本中</span><br><span class="line">[root@centos7 app]# cat errput.txt      # 查看errput.txt，xxx命令的执行结果已经被重定向到errput.txt</span><br><span class="line">bash: xxx: command not found...</span><br><span class="line"></span><br><span class="line">注意：&gt;默认会覆盖文件，我们可以使用set命令来调整</span><br><span class="line">    set -C: 禁止将内容覆盖已有文件,但可追加</span><br><span class="line">    &gt;| file：强制覆盖</span><br><span class="line">    set +C: 允许覆盖</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>3.将错误命令的执行结果追加到文本中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# ls /hello 2&gt;&gt; errput.txt    # 将ls /hello命令的执行结果追加到errput.txt</span><br><span class="line">[root@centos7 app]# cat errput.txt              # 查看errput.txt，ls /hello命令的执行结果已经追加到errput.txt</span><br><span class="line">bash: xxx: command not found...</span><br><span class="line">ls: cannot access /hello: No such file or directory</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>4.将标准输出和错误标准输出到不同的文件中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# cat a.txt www   # 查看a.txt和www，a.txt是一个文本，www则是一个不存在的文件</span><br><span class="line">123</span><br><span class="line">cat: www: No such file or directory</span><br><span class="line">[root@centos7 app]# cat a.txt www &gt; output.txt 2&gt; errput.txt # 将cat命令的执行结果，输出到output.txt和错误输出到errput.txt</span><br><span class="line">[root@centos7 app]# cat errput.txt  # 查看errput.txt，cat命令执行结果的错误信息已经输出到errput.txt</span><br><span class="line">cat: www: No such file or directory</span><br><span class="line">[root@centos7 app]# cat output.txt  # 查看output.txt，cat命令执行结果的正确信息已经输出到output.txt</span><br><span class="line">123</span><br></pre></td></tr></table></figure></p></blockquote><p><strong>标准输入(stdin) ：代码为 0 ，使用 &lt; 或 &lt;&lt; </strong></p><p><strong>示例</strong></p><blockquote><ol><li>标准输入读入数据<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# cat &lt; output.txt # 使用cat命令，从output.txt读入数据</span><br><span class="line">123</span><br></pre></td></tr></table></figure></li></ol></blockquote><blockquote><p>2.标准输入读入数据，输出到文本中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# cat &lt; output.txt &gt; 1.txt  # 从output.txt读入文本，再输出到1.txt中    </span><br><span class="line">[root@centos7 app]# cat 1.txt   # 查看1.txt和output.txt的文本是相同的（也可使用此方法拷贝文本）</span><br><span class="line">123</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="特殊用法"><a href="#特殊用法" class="headerlink" title="特殊用法"></a>特殊用法</h4><blockquote><p>1.将命令执行结果错误和正确都重定向到同一个文本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">方法一：使用2&gt;&amp;1</span><br><span class="line">    [root@centos7 app]# cat a.txt   # 查看文本a.txt</span><br><span class="line">    123</span><br><span class="line">    [root@centos7 app]# cat a.txt www &gt; output.txt 2&gt;&amp;1 # 执行命令cat a.txt www 将结果的正确和错误信息输出到output.txt</span><br><span class="line">    [root@centos7 app]# cat output.txt  # 查看output.txt，错误和正确的信息都存在</span><br><span class="line">    123</span><br><span class="line">    cat: www: No such file or directory</span><br><span class="line">    注意：使用2&gt;&amp;1要注意顺序，放到最后，最后，最后，重要的事要说三遍！</span><br><span class="line"></span><br><span class="line">方法二：使用&amp;&gt;</span><br><span class="line">    [root@centos7 app]# cat a.txt xxx &amp;&gt; output.txt #  执行命令cat a.txt www 将结果的正确和错误信息输出到output.txt</span><br><span class="line">    [root@centos7 app]# cat output.txt  # 查看output.txt，错误和正确的信息都存在</span><br><span class="line">    123</span><br><span class="line">    cat: xxx: No such file or directory</span><br><span class="line">    注意：此写法较新，可能在老系统中不支持。也可以使用&amp;&gt;&gt;追加</span><br><span class="line">方法三：使用&gt;&amp;</span><br><span class="line">    [root@centos7 app]# cat a.txt qqq &gt;&amp; output.txt #  执行命令cat a.txt www 将结果的正确和错误信息输出到output.txt</span><br><span class="line">    [root@centos7 app]# cat output.txt  # 查看output.txt，错误和正确的信息都存在</span><br><span class="line">    123</span><br><span class="line">    123</span><br><span class="line">    cat: qqq: No such file or directory</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>2.使用重定向来写文本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">方法一：使用&gt;</span><br><span class="line">    [root@centos7 app]# cat &gt; file  # 将从键盘的输入写入到文件中</span><br><span class="line">    ls</span><br><span class="line">    ifconfig</span><br><span class="line">    pwd</span><br><span class="line">    ls</span><br><span class="line">    [root@centos7 app]# cat file # 查看file文件，刚才输入文字已经输入到file文件中 </span><br><span class="line">    ls</span><br><span class="line">    ifconfig</span><br><span class="line">    pwd</span><br><span class="line">    ls</span><br><span class="line">    注意：退出时需要使用Ctrl+D</span><br><span class="line">方法二：使用&gt;，&lt;&lt;</span><br><span class="line">    [root@centos7 app]# cat &gt; file &lt;&lt; END</span><br><span class="line">    &gt; ls</span><br><span class="line">    &gt; hello</span><br><span class="line">    &gt; ifconfig</span><br><span class="line">    &gt; END</span><br><span class="line">    [root@centos7 app]# cat file</span><br><span class="line">    ls</span><br><span class="line">    hello</span><br><span class="line">    ifconfig</span><br><span class="line">    注意：后面的END是在文本结束时输入，当然文本也不会记录这个END符号，END也是可以自定义的哦！</span><br><span class="line"></span><br><span class="line">两种方法的区别：方法一是敲完回车之后就会保存文本，方法二是输入定义的结束符号后才会结束。</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>3.合并多个程序的标准输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 app]# (date ; cal) &gt; all.txt  # 将多个程序的标准输出到同一个文件</span><br><span class="line">[root@centos7 app]# cat all.txt </span><br><span class="line">Sun Jul 23 13:32:51 CST 2017</span><br><span class="line">      July 2017     </span><br><span class="line">Su Mo Tu We Th Fr Sa</span><br><span class="line">                   1</span><br><span class="line"> 2  3  4  5  6  7  8</span><br><span class="line"> 9 10 11 12 13 14 15</span><br><span class="line">16 17 18 19 20 21 22</span><br><span class="line">23 24 25 26 27 28 29</span><br><span class="line">30 31</span><br></pre></td></tr></table></figure></p></blockquote><p><strong>重定向命令列表</strong></p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>command &gt; file</td><td>将输出重定向到文件</td></tr><tr><td>command &lt; file</td><td>将输入重定向到文件</td></tr><tr><td>command &gt;&gt; file</td><td>将输出以追加的方式重定向到file</td></tr><tr><td>n &gt; file</td><td>将文件描述符为n的文件重定向到file</td></tr><tr><td>n &gt;&gt; file</td><td>将文件描述符为n的文件以追加的方式重定向到file</td></tr><tr><td>2&gt;&amp;1</td><td>将所有从定向到文件</td></tr><tr><td>&amp;&gt;</td><td>将所有从定向到文件</td></tr><tr><td>&gt;&amp;</td><td>将所有从定向到文件</td></tr><tr><td>command 2&gt; file</td><td>将错误输出重定向到file</td></tr><tr><td>command 2&gt;&gt; file</td><td>将错误输出以追加的方式重定向到file</td></tr><tr><td>()</td><td>合并多个程序的标准输出</td></tr></tbody></table>]]></content>
      
      <categories>
          
          <category> Linux基础 </category>
          
          <category> 输入输出重定向 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 重定向和管道 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Linux Shell</title>
      <link href="/2017/07/07/Linux-Shell/"/>
      <url>/2017/07/07/Linux-Shell/</url>
      <content type="html"><![CDATA[<p><center><img src="https://houhaiyun.github.io/img/images/Linux-Shell.jpg" title="Linux Shell"></center><br><a id="more"></a></p><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>计算机理解了被称为二进制语言的零语言。在计算的早期，使用二进制语言提供了指令，这对我们所有人来说都是难以阅读和写入的。因此，在操作系统中有一个称为<code>shell</code>的特殊程序。<code>shell</code>接受人类可读命令并将其转换为内核可以读取和处理的内容。</p><h3 id="什么是shell？"><a href="#什么是shell？" class="headerlink" title="什么是shell？"></a>什么是shell？</h3><ul><li><code>shell</code>是一个用户程序，也是为用户交互提供的环境。</li><li>它是一个命令语言解释器，执行从标准输入设备（如键盘或文件）读取的命令。</li><li>当您登录或打开控制台（终端）时，<code>shell</code>将启动。</li><li>快速而脏的方式来执行实用程序。</li><li><code>shell</code>不是系统内核的一部分，而是使用系统内核执行程序，创建文件等。</li></ul><h3 id="Linux提供的shell"><a href="#Linux提供的shell" class="headerlink" title="Linux提供的shell"></a>Linux提供的shell</h3><ul><li><code>BASH</code>（<code>Bourne-Again SHELL</code>） - <code>Linux</code>中最常见的<code>shell</code>。它是开源的，CentOS默认使用 。</li><li><code>CSH</code>（<code>C SHELL</code>） - <code>C shell</code>的语法和用法与<code>C</code>编程语言非常相似。</li><li><code>KSH</code>（<code>Korn shell</code>中） -创建者戴维·科恩在<code>AT＆T</code>贝尔实验室。<code>Korn Shell</code>是<code>POSIX Shell</code>标准规范的基础。</li><li><code>TCSH</code> - 它是<code>Berkeley UNIX C shell</code>（<code>CSH</code>）的增强但完全兼容的版本。</li></ul><p>请注意，每个<code>shell</code>执行相同的作业，但每个<code>shell</code>都会了解不同的命令语法，并提供不同的内置函数。在<code>Windows</code>下，<code>shell</code>名称是<code>cmd.exe</code>，它也用于相同的目的，但它远远不如我们的<code>Linux Shells</code>那么强大！</p><h4 id="显示当前shell"><a href="#显示当前shell" class="headerlink" title="显示当前shell"></a>显示当前shell</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# echo $SHELL#此命令可以显示当前使用的shell，当前使用的为BASH</span><br><span class="line">/bin/bash</span><br></pre></td></tr></table></figure><h4 id="查看当前系统支持的所有shell"><a href="#查看当前系统支持的所有shell" class="headerlink" title="查看当前系统支持的所有shell"></a>查看当前系统支持的所有shell</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# cat /etc/shells </span><br><span class="line">/bin/sh</span><br><span class="line">/bin/bash</span><br><span class="line">/sbin/nologin</span><br><span class="line">/usr/bin/sh</span><br><span class="line">/usr/bin/bash</span><br><span class="line">/usr/sbin/nologin</span><br><span class="line">/bin/tcsh</span><br><span class="line">/bin/csh</span><br></pre></td></tr></table></figure><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://bash.cyberciti.biz/guide/What_is_Linux_Shell" target="_blank" rel="noopener">维基百科：What is Linux Shell</a></p>]]></content>
      
      <categories>
          
          <category> Linux基础 </category>
          
          <category> Linux Shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux Shell </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>GUI和CLI</title>
      <link href="/2017/07/06/Linux-GUI-CLI/"/>
      <url>/2017/07/06/Linux-GUI-CLI/</url>
      <content type="html"><![CDATA[<h3 id="GUI"><a href="#GUI" class="headerlink" title="GUI"></a>GUI</h3><p>图形用户界面（<code>Graphical User Interface</code>，简称<code>GUI</code>）是指采用图形方式显示的计算机操作用户界面。与早期计算机使用的命令行界面相比，图形界面对于用户来说在视觉上更易于接受。</p><a id="more"></a><center><img src="https://houhaiyun.github.io/img/images/Linux-GUI-CLI-1.jpg" title="GUI"></center><h3 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h3><p>命令行界面（英语：<code>command-line interface</code>，缩写：<code>CLI</code>）是在图形用户界面得到普及之前使用最为广泛的用户界面，它通常不支持鼠标，用户通过键盘输入指令，计算机接收到指令后，予以执行。也有人称之为字符用户界面（<code>character user interface</code>, <code>CUI</code>）。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-GUI-CLI-2.jpg" title="CLI"></center><p><strong>一般我们是使用<code>CLI</code>的，比较酷。。。</strong></p>]]></content>
      
      <categories>
          
          <category> Linux基础 </category>
          
          <category> GUI和CLI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GUI和CLI </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>终端 Terminal</title>
      <link href="/2017/07/05/Linux-Terminal/"/>
      <url>/2017/07/05/Linux-Terminal/</url>
      <content type="html"><![CDATA[<center><img src="https://houhaiyun.github.io/img/images/Linux-Terminal.png" title="终端"></center><a id="more"></a><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>终端（<code>Terminal</code>）也称终端设备，是计算机网络中处于网络最外围的设备，主要用于用户信息的输入以及处理结果的输出等。</p><p>Linux系统的终端主要包括设备终端、物理终端、虚拟终端、图形终端、串行终端和伪终端</p><p><strong>查看当前的终端设备：#tty</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# tty#这就是一个伪终端</span><br><span class="line">/dev/pts/1</span><br><span class="line">[root@centos6 ~]#</span><br></pre></td></tr></table></figure><h4 id="1-设备终端"><a href="#1-设备终端" class="headerlink" title="1.设备终端"></a>1.设备终端</h4><p>键盘鼠标显示器</p><h4 id="2-物理终端"><a href="#2-物理终端" class="headerlink" title="2.物理终端"></a>2.物理终端</h4><p>在Unix系统中，计算机显示器通常被称为控制台终端。Console与虚拟终端相关联，内核将信息送到控制台上（/dev/console），通过与console相关联的虚拟终端将信息显示到屏幕上。</p><h4 id="3-虚拟终端"><a href="#3-虚拟终端" class="headerlink" title="3.虚拟终端"></a>3.虚拟终端</h4><p>虚拟终端，ctrl+alt+f[1-6]切换的就是虚拟终端</p><h4 id="4-图形终端（-dev-tty7）StartlX，xwindows"><a href="#4-图形终端（-dev-tty7）StartlX，xwindows" class="headerlink" title="4.图形终端（/dev/tty7）StartlX，xwindows"></a>4.图形终端（/dev/tty7）StartlX，xwindows</h4><p>Centos 6：Ctrl+Alt+F7</p><p>Centos 7：在哪个终端启动，即位于那个虚拟终端</p><h4 id="5-串行终端（-dev-ttyS-）"><a href="#5-串行终端（-dev-ttyS-）" class="headerlink" title="5.串行终端（/dev/ttyS#）"></a>5.串行终端（/dev/ttyS#）</h4><p>通过串口线连接的终端</p><h4 id="6-伪终端（pty：pseudo-tty，-dev-pts-）"><a href="#6-伪终端（pty：pseudo-tty，-dev-pts-）" class="headerlink" title="6.伪终端（pty：pseudo-tty，/dev/pts/#）"></a>6.伪终端（pty：pseudo-tty，/dev/pts/#）</h4><p>pty,SSH远程连接</p><h3 id="wall命令"><a href="#wall命令" class="headerlink" title="wall命令"></a>wall命令</h3><p><code>wall</code>命令用于向系统当前所有打开的终端上输出信息。通过<code>wall</code>命令可将信息发送给每位同意接收公众信息的终端机用户，若不给予其信息内容，则<code>wall</code>命令会从标准输入设备读取数据，然后再把所得到的数据传送给所有终端机用户。</p><p><strong>语法</strong></p><p><code>wall 参数（消息：指定广播消息）</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">    [root@centos6 ~]# wall houhaiyum.com</span><br><span class="line">    [root@centos6 ~]# </span><br><span class="line">    Broadcast message from root@centos6.magedu.com (pts/5) (Fri Jul 14 22:28:19 2017):</span><br><span class="line">    </span><br><span class="line">    houhaiyun.com</span><br></pre></td></tr></table></figure><h3 id="mesg命令"><a href="#mesg命令" class="headerlink" title="mesg命令"></a>mesg命令</h3><p> mesg命令用于设置当前终端的写权限，即是否让其他用户向本终端发信息。将mesg设置y时，其他用户可利用write命令将信息直接显示在您的屏幕上。</p><p><strong>语法</strong></p><p><code>mesg 参数</code></p><p>y/n：y表示运行向当前终端写信息，n表示禁止向当前终端写信息。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">    [root@centos6 ~]# mesg y    #允许系统用户将信息直接显示在你的屏幕上。</span><br><span class="line">    [root@centos6 ~]# mesg n    #不允许系统用户将信息直接显示在你的屏幕上。</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Linux基础 </category>
          
          <category> Terminal </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Terminal </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Centos6.9 安装详解</title>
      <link href="/2017/07/04/Linux-Centos6-9-Install/"/>
      <url>/2017/07/04/Linux-Centos6-9-Install/</url>
      <content type="html"><![CDATA[<p><code>CentOS</code>（<code>Community Enterprise Operating System</code>，中文意思是：社区企业操作系统）是<code>Linux</code>发行版之一，它是来自于<code>Red Hat Enterprise Linux</code>依照开放源代码规定释出的源代码所编译而成。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-1.png" title="Centos"></center><a id="more"></a><h3 id="虚拟机配置"><a href="#虚拟机配置" class="headerlink" title="虚拟机配置"></a>虚拟机配置</h3><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-2.jpg" title="虚拟机配置"></center><h3 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h3><h4 id="开启虚拟机后我们看到如下安装界面："><a href="#开启虚拟机后我们看到如下安装界面：" class="headerlink" title="开启虚拟机后我们看到如下安装界面："></a>开启虚拟机后我们看到如下安装界面：</h4><ol><li><p>安装或更新系统</p></li><li><p>安装显示卡驱动</p></li><li><p>系统修复</p></li><li><p>从硬盘启动</p></li><li><p>内存测试</p></li></ol><p>我们直接回车即可，即使你不动，默认也会在自动倒数结束后，开始安装。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-3.jpg" title="开始安装"></center><h4 id="进入下一个界面测试安装媒体"><a href="#进入下一个界面测试安装媒体" class="headerlink" title="进入下一个界面测试安装媒体"></a>进入下一个界面测试安装媒体</h4><p>测试你的安装媒体是否损坏，按OK测试你的安装媒体（你所选的ISO文件），我们这里直接按SKIP跳过。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-4.jpg" title="测试安装媒体"></center><h4 id="第一个界面"><a href="#第一个界面" class="headerlink" title="第一个界面"></a>第一个界面</h4><p>选右下角的“NEXT”，下一步。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-5.jpg" title="第一个界面"></center><h4 id="然后就到了选语言，这里我们选英文。如图："><a href="#然后就到了选语言，这里我们选英文。如图：" class="headerlink" title="然后就到了选语言，这里我们选英文。如图："></a>然后就到了选语言，这里我们选英文。如图：</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-6.jpg" title="选语言"></center><h4 id="选择键盘"><a href="#选择键盘" class="headerlink" title="选择键盘"></a>选择键盘</h4><p>这个不要选错了，默认就可以。如图：</p><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-7.jpg" title="选择键盘"></center><h4 id="这里选择安装的存储设备"><a href="#这里选择安装的存储设备" class="headerlink" title="这里选择安装的存储设备"></a>这里选择安装的存储设备</h4><p>我想大家都是安装到本地硬盘吧，那就是上面这个了啦，第二个选线的意思是指定专用的存储设备（例如存储区域网络SAN），如图。选择：基本存储设备后，点击下一步。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-8.jpg" title="安装的存储设备"></center><h4 id="弹出警告"><a href="#弹出警告" class="headerlink" title="弹出警告"></a>弹出警告</h4><p>会删除检测到的这个硬盘（204800MB）的所有数据，如果是多硬盘安装或升级安装的话，要小心注意了，全新安装的话，直接点击：是，如图。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-9.jpg" title="弹出警告"></center><h4 id="这里是选择时区"><a href="#这里是选择时区" class="headerlink" title="这里是选择时区"></a>这里是选择时区</h4><p>我们选择：亚洲/中国/上海，如图。下一步。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-10.jpg" title="选择时区"></center><h4 id="这里是设置根账户（root）的密码"><a href="#这里是设置根账户（root）的密码" class="headerlink" title="这里是设置根账户（root）的密码"></a>这里是设置根账户（root）的密码</h4><p>如图，如果你的密码过于简单，则会有另一个提示，我可以选择：无论如何都使用，如图：</p><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-11.jpg" title="设置根账户（root）的密码"></center><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-12.jpg" title="设置根账户（root）的密码"></center><h4 id="设置主机名"><a href="#设置主机名" class="headerlink" title="设置主机名"></a>设置主机名</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-13.jpg" title="设置主机名"></center><h4 id="设置网络"><a href="#设置网络" class="headerlink" title="设置网络"></a>设置网络</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-14.jpg" title="设置网络"></center><h4 id="下面我们就到了分区：此处我们选择“创建自定义布局”"><a href="#下面我们就到了分区：此处我们选择“创建自定义布局”" class="headerlink" title="下面我们就到了分区：此处我们选择“创建自定义布局”"></a>下面我们就到了分区：此处我们选择“创建自定义布局”</h4><ul><li>使用所有空间</li><li>替换现有的Linux系统</li><li>缩小当前系统</li><li>使用自由空间</li><li>创建自定义布局</li></ul><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-15.jpg" title="分区"></center><h4 id="自定义分区："><a href="#自定义分区：" class="headerlink" title="自定义分区："></a>自定义分区：</h4><table><thead><tr><th>挂载点</th><th>大小</th><th>分区名称</th></tr></thead><tbody><tr><td>/</td><td>50G</td><td>/dev/sdba1</td></tr><tr><td>/boot</td><td>1G</td><td>/dev/sda2</td></tr><tr><td>/app</td><td>50G</td><td>/dev/sda3</td></tr><tr><td>swap</td><td>4G</td><td>/dev/sda4</td></tr></tbody></table><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-16.jpg" title="分区"></center><h4 id="创建-boot分区"><a href="#创建-boot分区" class="headerlink" title="创建/boot分区"></a>创建/boot分区</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-17.jpg" title="创建/boot分区"></center><h4 id="创建-分区"><a href="#创建-分区" class="headerlink" title="创建/分区"></a>创建/分区</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-18.jpg" title="创建/分区"></center><h4 id="创建-app分区"><a href="#创建-app分区" class="headerlink" title="创建/app分区"></a>创建/app分区</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-19.jpg" title="创建/app分区"></center><h4 id="创建交换分区"><a href="#创建交换分区" class="headerlink" title="创建交换分区"></a>创建交换分区</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-20.jpg" title="创建交换分区"></center><h4 id="分区图"><a href="#分区图" class="headerlink" title="分区图"></a>分区图</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-21.jpg" title="分区图"></center><h4 id="是否格式化"><a href="#是否格式化" class="headerlink" title="是否格式化"></a>是否格式化</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-22.jpg" title="是否格式化"></center><h4 id="点击下一步，将修改写入磁盘"><a href="#点击下一步，将修改写入磁盘" class="headerlink" title="点击下一步，将修改写入磁盘"></a>点击下一步，将修改写入磁盘</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-23.jpg" title="点击下一步，将修改写入磁盘。"></center><h4 id="然后，到了选择安装Centos组件的时候"><a href="#然后，到了选择安装Centos组件的时候" class="headerlink" title="然后，到了选择安装Centos组件的时候"></a>然后，到了选择安装Centos组件的时候</h4><p>这一步是选择机子是做什么用的，如图，分别是：</p><ol><li>桌面系统的安装</li><li>最小化桌面系统的安装</li><li>最小化安装</li><li>基本服务器的安装</li><li>数据库服务器的安装</li><li>WEB网页服务器的安装</li><li>虚拟主机的安装</li><li>软件开发工作站的安装</li></ol><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-24.jpg" title="选择安装Centos组件"></center><p>选择一种，系统会自动给你安装上一些需要的软件，当然也可以选择底下的：现在自定义，来选择要安装的组件。</p><h4 id="下一步后，就开始安装了。"><a href="#下一步后，就开始安装了。" class="headerlink" title="下一步后，就开始安装了。"></a>下一步后，就开始安装了。</h4><p>安装过程则根据你选择的组件内容所用的时间而不同……如图。</p><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-25.jpg" title="安装过程则根据你选择的组件内容所用的时间而不同"></center><h4 id="安装完成后就可以重启系统了，按一下“reboot”。如图："><a href="#安装完成后就可以重启系统了，按一下“reboot”。如图：" class="headerlink" title="安装完成后就可以重启系统了，按一下“reboot”。如图："></a>安装完成后就可以重启系统了，按一下“reboot”。如图：</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-26.jpg" title="完成后就可以重启系统了，按一下“reboot”"></center><h4 id="重启完成后，进入欢迎界面，点击“Forward”"><a href="#重启完成后，进入欢迎界面，点击“Forward”" class="headerlink" title="重启完成后，进入欢迎界面，点击“Forward”"></a>重启完成后，进入欢迎界面，点击“Forward”</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-27.jpg" title="重启完成后，进入欢迎界面，点击“Forward”"></center><h4 id="是否同意，点击“Forward”"><a href="#是否同意，点击“Forward”" class="headerlink" title="是否同意，点击“Forward”"></a>是否同意，点击“Forward”</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-28.jpg" title="是否同意，点击“Forward”"></center><h4 id="创建一个普通用户haiyun-也可以不创建"><a href="#创建一个普通用户haiyun-也可以不创建" class="headerlink" title="创建一个普通用户haiyun,也可以不创建"></a>创建一个普通用户haiyun,也可以不创建</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-29.jpg" title="创建一个普通用户haiyun,也可以不创建"></center><h4 id="设置时间，如果时间不对可以重新调整"><a href="#设置时间，如果时间不对可以重新调整" class="headerlink" title="设置时间，如果时间不对可以重新调整"></a>设置时间，如果时间不对可以重新调整</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-30.jpg" title="设置时间，如果时间不对可以重新调整"></center><h4 id="是否开启kdump"><a href="#是否开启kdump" class="headerlink" title="是否开启kdump"></a>是否开启kdump</h4><p>kdump是在系统崩溃、死锁或者死机的时候用来转储内存运行参数的一个工具和服务，此处就就不开启了。也可开启，根据需求自行选择</p><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-31.jpg" title="是否开启kdump"></center><h4 id="点击确认，需要重启"><a href="#点击确认，需要重启" class="headerlink" title="点击确认，需要重启"></a>点击确认，需要重启</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-32.jpg" title="点击确认，需要重启"></center><h4 id="重启完成，如下图可以愉快的登陆系统了。"><a href="#重启完成，如下图可以愉快的登陆系统了。" class="headerlink" title="重启完成，如下图可以愉快的登陆系统了。"></a>重启完成，如下图可以愉快的登陆系统了。</h4><center><img src="https://houhaiyun.github.io/img/images/Linux-Centos6-9-Install-33.jpg" title="重启完成"></center>]]></content>
      
      <categories>
          
          <category> Linux基础 </category>
          
          <category> Centos6.9 安装详解 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Centos6.9 安装详解 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>用户空间和内核空间</title>
      <link href="/2017/07/03/Linux-User-space/"/>
      <url>/2017/07/03/Linux-User-space/</url>
      <content type="html"><![CDATA[<h3 id="用户空间：-User-space"><a href="#用户空间：-User-space" class="headerlink" title="用户空间： User space"></a>用户空间： User space</h3><ul><li>用户程序的运行空间。为了安全，它们是隔离的，即使用户的程序崩溃了，内核也不受影响</li><li>只能执行简单的运算，不能直接调用系统资源，必须通过系统接口（<code>system call</code>），才能向内核发出指令 </li></ul><a id="more"></a><h3 id="内核空间：-Kernel-space"><a href="#内核空间：-Kernel-space" class="headerlink" title="内核空间： Kernel space"></a>内核空间： Kernel space</h3><ul><li>是 <code>Linux</code> 内核的运行空间</li></ul><ul><li>可以执行任意命令，调用系统的一切资源 </li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">str = "www.ihaiyun.cc" # 用户空间</span><br><span class="line">x = x + 2</span><br><span class="line">file.write(str) # 切换到内核空间</span><br><span class="line">y = x + 4 # 切换回用户空间</span><br></pre></td></tr></table></figure><p>上面代码中，第一行和第二行都是简单的赋值运算，在 <code>User space</code> 执行。第三行需要写入文件，就要切换到 <code>Kernel space</code>，因为用户不能直接写文件，必须通过内核安排。第四行又是赋值运算，就切换回 <code>User space</code>。</p><h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ul><li>内核空间可以访问所有的<code>CPU</code>指令和所有的内存空间、<code>I/O</code>空间。</li><li>用户空间只能访问有限的资源，若需要特殊权限，可以通过系统调用获取相应的资源。</li><li>用户空间允许页面中断，而内核空间则不允许。</li><li><code>x86 CPU</code>中用户空间是<code>0-3G</code>的地址范围，内核空间是<code>3G-4G</code>的地址范围。<code>x86_64 CPU</code>用户空间地址范围为<code>0x0000000000000000</code> – <code>0x00007fffffffffff</code>，内核地址空间为<code>0xffff880000000000</code>~最大地址。</li><li>内核空间和用户空间是针对线性地址空间的。</li><li>所有内核进（线）程共用一个地址空间，而用户进程都有各自的地址空间。</li></ul><center><img src="https://houhaiyun.github.io/img/images/Linux-User-space-1.png" title="用户空间和内核空间"></center><h3 id="单处程序时间统计使用time"><a href="#单处程序时间统计使用time" class="headerlink" title="单处程序时间统计使用time"></a>单处程序时间统计使用time</h3><p>如果想查看单个程序的耗时，一般使用<code>time</code>命令。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@blog ~]# time ifconfig </span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.18.252.210  netmask 255.255.0.0  broadcast 172.18.255.255</span><br><span class="line">        inet6 fe80::20c:29ff:fef8:15f5  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:f8:15:f5  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 16981  bytes 1356968 (1.2 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 93  bytes 23042 (22.5 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.135  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:fef8:15ff  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:f8:15:ff  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 11279  bytes 1036041 (1011.7 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 59808  bytes 130371849 (124.3 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1  (Local Loopback)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">virbr0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.122.1  netmask 255.255.255.0  broadcast 192.168.122.255</span><br><span class="line">        ether 52:54:00:d7:0c:d1  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">real0m0.003s</span><br><span class="line">user0m0.001s</span><br><span class="line">sys0m0.002s</span><br></pre></td></tr></table></figure><p>程序名之前加上<code>time</code>命令，会在程序执行完毕以后，默认显示三行统计。</p><ul><li><code>real</code>：程序从开始运行到结束的全部时间，这是用户能感知到的时间，包括 CPU 切换去执行其他任务的时间。</li><li><code>user</code>：程序在 User space 执行的时间</li><li><code>sys</code>：程序在 Kernel space 执行的时间</li></ul><p><code>user</code>和<code>sys</code>之和，一般情况下，应该小于<code>real</code>。</p><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://www.ait24.com/1256.html" target="_blank" rel="noopener">爱T网：linux中的内核空间Kernel space用户空间User space</a></p><p><a href="http://ilinuxkernel.com/?p=528" target="_blank" rel="noopener">Linux内核空间与用户空间</a></p>]]></content>
      
      <categories>
          
          <category> Linux基础 </category>
          
          <category> 用户空间和内核空间 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 用户空间和内核空间 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Linux 发行版时间线</title>
      <link href="/2017/07/03/Linux-time/"/>
      <url>/2017/07/03/Linux-time/</url>
      <content type="html"><![CDATA[<center><img src="https://houhaiyun.github.io/img/images/Linux-time-1.png" title="Linux 发行版时间线"></center><a id="more"></a><p><strong>时间线请参见：</strong> <a href="https://en.wikipedia.org/wiki/File:Linux_Distribution_Timeline.svg" target="_blank" rel="noopener">Wikipedia</a></p>]]></content>
      
      <categories>
          
          <category> Linux基础 </category>
          
          <category> Linux发行版时间线 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux发行版时间线 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>常见开源协议</title>
      <link href="/2017/07/02/Linux-open-source/"/>
      <url>/2017/07/02/Linux-open-source/</url>
      <content type="html"><![CDATA[<center><img src="https://houhaiyun.github.io/img/images/Linux-open-source-2.jpeg" title="Public License"></center><a id="more"></a><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>现今存在的开源协议很多，而经过<code>Open Source Initiative</code>组织通过批准的开源协议目前有 <a href="http://www.opensource.org/licenses/alphabetical" target="_blank" rel="noopener">80种</a>。我们在常见的开源协议如<code>BSD</code>, <code>Apache</code>, <code>GPL</code>, <code>LGPL</code>, <code>MIT</code>等都是<code>OSI</code>批准的协议。如果要开源自己的代码，最好也是选择这些被批准的开源协议。</p><p>这里我们来看几种最常用的开源协议及它们的适用范围，供那些准备开源或者使用开源产品的开发人员/厂家参考。</p><h3 id="BSD开源协议（original-BSD-license、FreeBSD-license、Original-BSD-license）"><a href="#BSD开源协议（original-BSD-license、FreeBSD-license、Original-BSD-license）" class="headerlink" title="BSD开源协议（original BSD license、FreeBSD license、Original BSD license）"></a>BSD开源协议（original BSD license、FreeBSD license、Original BSD license）</h3><p><code>BSD</code>开源协议是一个给于使用者很大自由的协议。基本上使用者可以”为所欲为”,可以自由的使用，修改源代码，也可以将修改后的代码作为开源或者专有软件再发布。</p><p>但“为所欲为”的前提当你发布使用了<code>BSD</code>协议的代码，或则以<code>BSD</code>协议代码为基础做二次开发自己的产品时，需要满足三个条件：</p><ul><li>如果再发布的产品中包含源代码，则在源代码中必须带有原来代码中的BSD协议。</li><li>如果再发布的只是二进制类库/软件，则需要在类库/软件的文档和版权声明中包含原来代码中的BSD协议。</li><li>不可以用开源代码的作者/机构名字和原来产品的名字做市场推广。</li></ul><p><code>BSD</code> 代码鼓励代码共享，但需要尊重代码作者的著作权。<code>BSD</code>由于允许使用者修改和重新发布代码，也允许使用或在<code>BSD</code>代码上开发商业软件发布和销售，因此是对商业集成很友好的协议。而很多的公司企业在选用开源产品的时候都首选<code>BSD</code>协议，因为可以完全控制这些第三方的代码，在必要的时候可以修改或者二次开发。</p><h3 id="Apache-Licence-2-0（Apache-License-Version-2-0、Apache-License-Version-1-1、Apache-License-Version-1-0）"><a href="#Apache-Licence-2-0（Apache-License-Version-2-0、Apache-License-Version-1-1、Apache-License-Version-1-0）" class="headerlink" title="Apache Licence 2.0（Apache License, Version 2.0、Apache License, Version 1.1、Apache License, Version 1.0）"></a>Apache Licence 2.0（Apache License, Version 2.0、Apache License, Version 1.1、Apache License, Version 1.0）</h3><p><code>Apache Licence</code>是著名的非盈利开源组织<code>Apache</code>采用的协议。该协议和<code>BSD</code>类似，同样鼓励代码共享和尊重原作者的著作权，同样允许代码修改，再发布（作为开源或商业软件）。需要满足的条件也和<code>BSD</code>类似：</p><ul><li>需要给代码的用户一份<code>Apache Licence</code></li><li>如果你修改了代码，需要再被修改的文件中说明。</li><li>在延伸的代码中（修改和有源代码衍生的代码中）需要带有原来代码中的协议，商标，专利声明和其他原来作者规定需要包含的说明。</li><li>如果再发布的产品中包含一个<code>Notice</code>文件，则在<code>Notice</code>文件中需要带有<code>Apache Licence</code>。你可以在<code>Notice</code>中增加自己的许可，但不可以表现为对<code>Apache Licence</code>构成更改。</li></ul><p><code>Apache Licence</code>也是对商业应用友好的许可。使用者也可以在需要的时候修改代码来满足需要并作为开源或商业产品发布/销售。</p><h3 id="GPL（GNU-General-Public-License）通用性公开许可证"><a href="#GPL（GNU-General-Public-License）通用性公开许可证" class="headerlink" title="GPL（GNU General Public License）通用性公开许可证"></a>GPL（GNU General Public License）通用性公开许可证</h3><p>我们很熟悉的<code>Linux</code>就是采用了<code>GPL</code>。<code>GPL</code>协议和<code>BSD</code>, <code>Apache Licence</code>等鼓励代码重用的许可很不一样。<code>GPL</code>的出发点是代码的开源/免费使用和引用/修改/衍生代码的开源/免费使用，但不允许修改后和衍生的代码做为闭源的商业软件发布和销售。这也就是为什么我们能用免费的各种<code>linux</code>，包括商业公司的<code>linux</code>和<code>linux</code>上各种各样的由个人，组织，以及商业软件公司开发的免费软件了。</p><p><code>GPL</code>规定：只要这种修改文本在整体上或者其某个部分来源于遵循<code>GPL</code>的程序，该修改文本的 整体就必须按照GPL流通，不仅该修改文本的源码必须向社会公开，而且对于这种修改文本的流通不准许附加修改者自己作出的限制。因此，一项遵循<code>GPL</code>流通 的程序不能同非自由的软件合并。<code>GPL</code>所表达的这种流通规则称为<code>copyleft</code>，表示与<code>copyright</code>(版权)的概念“相左”。</p><h4 id="GPL协议最主要的几个原则："><a href="#GPL协议最主要的几个原则：" class="headerlink" title="GPL协议最主要的几个原则："></a>GPL协议最主要的几个原则：</h4><ul><li>确保软件自始至终都以开放源代码形式发布，保护开发成果不被窃取用作商业发售。任何一套软 件，只要其中使用了受 <code>GPL</code> 协议保护的第三方软件的源程序，并向非开发人员发布时，软件本身也就自动成为受 <code>GPL</code> 保护并且约束的实体。也就是说，此时它必须开放源代码。</li><li><code>GPL</code> 大致就是一个左侧版权（<code>Copyleft</code>，或译为“反版权”、“版权属左”、“版权所无”、“版责”等）的体现。你可以去掉所有原作的版权 信息，只要你保持开源，并且随源代码、二进制版附上 <code>GPL</code> 的许可证就行，让后人可以很明确地得知此软件的授权信息。GPL 精髓就是，只要使软件在完整开源 的情况下，尽可能使使用者得到自由发挥的空间，使软件得到更快更好的发展。</li><li>无论软件以何种形式发布，都必须同时附上源代码。例如在 <code>Web</code> 上提供下载，就必须在二进制版本（如果有的话）下载的同一个页面，清楚地提供源代码下载的链接。如果以光盘形式发布，就必须同时附上源文件的光盘。</li><li>开发或维护遵循 <code>GPL</code> 协议开发的软件的公司或个人，可以对使用者收取一定的服务费用。但还是一句老话——必须无偿提供软件的完整源代码，不得将源代码与服务做捆绑或任何变相捆绑销售。</li></ul><p><code>GPL</code> 只是规定用户在获取你的程序的时候必须可以获得源代码，但并没有规定必须免费，因此理论上说，你仍然可以收取费用。如果你的确需要发布你的程序，但又不想开源，规避 <code>GPL</code> 的方法是通过 <code>LPC</code> 或者 <code>RPC</code> 间接调用库里的接口。只要库和你的程序不运行在同一进程下，就不需要开源。</p><p>另外，你需要区分 <code>GPL</code> 和 <code>LGPL</code>。<code>LGPL</code> 的要求比 <code>GPL</code> 低，你可以动态链接一个 <code>LGPL</code> 的库而不需要开源你自己的程序，而 <code>GPL</code> 是不行的。</p><h4 id="LGPL（GNU-Lesser-General-Public-License）宽松公共许可证"><a href="#LGPL（GNU-Lesser-General-Public-License）宽松公共许可证" class="headerlink" title="LGPL（GNU Lesser General Public License）宽松公共许可证"></a>LGPL（GNU Lesser General Public License）宽松公共许可证</h4><p><code>LGPL</code>是<code>GPL</code>的一个为主要为类库使用设计的开源协议。和<code>GPL</code>要求任何使用/修改/衍生之<code>GPL</code>类库的的软件必须采用<code>GPL</code>协议不同。<code>LGPL</code>允许商业软件通过类库引用(<code>link</code>)方式使用<code>LGPL</code>类库而不需要开源商业软件的代码。这使得采用<code>LGPL</code>协议的开源代码可以被商业软件作为类库引用并发布和销售。</p><p>但是如果修改<code>LGPL</code>协议的代码或者衍生，则所有修改的代码，涉及修改部分的额外代码和衍生的代码都必须采用LGPL协议。因此<code>LGPL</code>协议的开源代码很适合作为第三方类库被商业软件引用，但不适合希望以<code>LGPL</code>协议代码为基础，通过修改和衍生的方式做二次开发的商业软件采用。</p><p><code>GPL</code>/<code>LGPL</code>都保障原作者的知识产权，避免有人利用开源代码复制并开发类似的产品</p><h4 id="AGPL-协议（Affero-General-Public-License）"><a href="#AGPL-协议（Affero-General-Public-License）" class="headerlink" title="AGPL 协议（Affero General Public License）"></a>AGPL 协议（Affero General Public License）</h4><p><code>GPL（2.x ~ 3.x）</code> 协议还有一个非常大的“漏洞”，就是软件“发布” 才必须开源。也就是说，我的软件不发布，即使使用 <code>GPL (2.x ~ 3.x)</code>也可以不用开源。随着以Google为代表的软件作为服务的互联网公司的兴起，它们的“不分发软件，为客户提供网络服务”的商业模式就不受GPL协议的约束</p><p>AGPL则增加了对此做法的约束：</p><pre><code>AGPL = GPL + 一条限制</code></pre><p>一条限制：如果使用<code>AGPL</code>许可的软件与用户通过网络进行交互，也需要提供源代码给用户，所有的修改也要给用户。</p><h3 id="MIT（MIT）"><a href="#MIT（MIT）" class="headerlink" title="MIT（MIT）"></a>MIT（MIT）</h3><p><code>MIT</code>是和<code>BSD</code>一样宽范的许可协议,作者只想保留版权,而无任何其他了限制.也就是说,你必须在你的发行版里包含原许可协议的声明,无论你是以二进制发布的还是以源代码发布的.</p><ul><li>被授权人有权利使用、复制、修改、合并、出版发行、散布、再授权及贩售软体及软体的副本。</li><li>被授权人可根据程式的需要修改授权条款为适当的内容。</li><li>在软件和软件的所有副本中都必须包含版权声明和许可声明</li></ul><h3 id="Zlib-Libpng协议"><a href="#Zlib-Libpng协议" class="headerlink" title="Zlib/Libpng协议"></a><code>Zlib</code>/<code>Libpng</code>协议</h3><p>基于该软件的原样使用，作者不负责使用该软件照成的任何损失。</p><p>该软件修改后的版本将受到以下限制：</p><ul><li>不能歪曲原软件的著作权</li><li>修改后的软件不能歪曲为原版软件</li><li>不能删除源码中的协议许可内容</li></ul><p>如果发布二进制代码可以不用附上源代码。</p><h3 id="MPL-The-Mozilla-Public-License-Mozilla公共许可证"><a href="#MPL-The-Mozilla-Public-License-Mozilla公共许可证" class="headerlink" title="MPL(The Mozilla Public License)Mozilla公共许可证"></a>MPL(The Mozilla Public License)Mozilla公共许可证</h3><p><code>MPL</code>是<code>The Mozilla Public License</code>的简写，是1998年初<code>Netscape</code>的<code>Mozilla</code>小组为其开源软件项目设计的软件许可证。<code>MPL</code>许可证出现的最重要原因就是，<code>Netscape</code>公司认为<code>GPL</code>许可证没有很好地平衡开发者对源代码的需求和他们利用源代码获得的利益。同著名的<code>GPL</code>许可证和<code>BSD</code>许可证相比，<code>MPL</code>在许多权利与义务的约定方面与它们相同（因为都是符合<code>OSIA</code>认定的开源软件许可证）。但是，相比而言<code>MPL</code>还有以下几个显著的不同之处:</p><ul><li><code>MPL</code>虽然要求对于经<code>MPL</code>许可证发布的源代码的修改也要以<code>MPL</code>许可证的方式再许可出来，以保证其他人可以在MPL的条款下共享源代码。但是，在<code>MPL</code> 许可证中对“发布”的定义是“以源代码方式发布的文件”，这就意味着<code>MPL</code>允许一个企业在自己已有的源代码库上加一个接口，除了接口程序的源代码以<code>MPL</code>许可证的形式对外许可外，源代码库中的源代码就可以不用<code>MPL</code>许可证的方式强制对外许可。这些，就为借鉴别人的源代码用做自己商业软件开发的行为留了一个豁口。</li><li><code>MPL</code>许可证第三条第7款中允许被许可人将经过<code>MPL</code>许可证获得的源代码同自己其他类型的代码混合得到自己的软件程序。</li><li>对软件专利的态度，<code>MPL</code>许可证不像<code>GPL</code>许可证那样明确表示反对软件专利，但是却明确要求源代码的提供者不能提供已经受专利保护的源代码（除非他本人是专利权人，并书面向公众免费许可这些源代码），也不能在将这些源代码以开放源代码许可证形式许可后再去申请与这些源代码有关的专利。</li><li>对源代码的定义而在<code>MPL</code>（1.1版本）许可证中，对源代码的定义是:“源代码指的是对作品进行修改最优先择取的形式，它包括:所有模块的所有源程序，加上有关的接口的定义，加上控制可执行作品的安装和编译的‘原本’（原文为‘<code>Script</code>’），或者不是与初始源代码显著不同的源代码就是被源代码贡献者选择的从公共领域可以得到的程序代码。”<ul><li><code>MPL</code>许可证第3条有专门的一款是关于对源代码修改进行描述的规定，就是要求所有再发布者都得有一个专门的文件就对源代码程序修改的时间和修改的方式有描述。</li></ul></li></ul><h4 id="MPL与其他协议的兼容性"><a href="#MPL与其他协议的兼容性" class="headerlink" title="MPL与其他协议的兼容性"></a>MPL与其他协议的兼容性</h4><p>不像那些较严格的<code>Copyleft</code>许可证，使用<code>MPL</code>授权的源代码可以在一个复杂的软件中与任何其他的许可协议相结合，只要仍满足<code>MPL</code>许可协议中3.3节的规定即可。这意味着在一份给定的源文件里面，必须全部的源代码都以MPL授权，否则就所有源代码均以其他方式授权。</p><p><code>MPL</code>第二版与<code>Apache</code>许可证以及<code>GPL</code>第二版或更新、<code>LGPL2.1</code>版或更新，及<code>AGPL</code>第三版或更新兼容。而1.1版因为有“一些复杂的限制”造成与<code>GPL</code>的不兼容（从而阻止升级到<code>MPL 2.0</code>）。</p><h3 id="GPL、BSD、MIT、Mozilla、Apache和LGPL之中做选择"><a href="#GPL、BSD、MIT、Mozilla、Apache和LGPL之中做选择" class="headerlink" title="GPL、BSD、MIT、Mozilla、Apache和LGPL之中做选择"></a>GPL、BSD、MIT、Mozilla、Apache和LGPL之中做选择</h3><center><img src="https://houhaiyun.github.io/img/images/Linux-open-source-1.jpg" title="GPL、BSD、MIT、Mozilla、Apache和LGPL之中做选择"></center><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://ewen0930.github.io/2016/11/open-source-licenses/" target="_blank" rel="noopener">本文转自：Hello EWEN</a></p>]]></content>
      
      <categories>
          
          <category> Linux基础 </category>
          
          <category> 常见开源协议 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 常见开源协议 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Linux 历史?</title>
      <link href="/2017/07/02/Linux-history/"/>
      <url>/2017/07/02/Linux-history/</url>
      <content type="html"><![CDATA[<h3 id="Linux之前的UNIX历史："><a href="#Linux之前的UNIX历史：" class="headerlink" title="Linux之前的UNIX历史："></a><code>Linux</code>之前的<code>UNIX</code>历史：</h3><ul><li>1969年以前伟大的梦想-贝尔实验室 （<code>Bell Labs</code>）通用电气（<code>General Electric</code>）和麻省理工学院（<code>MIT</code>）的<code>Multics</code>系统。</li></ul><ul><li>1969年<code>Ken Thompson</code>使用汇编语言<code>B</code>语言<code>File Server System</code>。<a id="more"></a></li></ul><ul><li>1973年<code>UNIX</code>正式诞生，<code>Ritchie</code>等人以<code>C</code>语言写出第一个正式内核。</li></ul><ul><li>1977年重要的<code>UNIX</code>分支-<code>BSD</code>诞生。</li></ul><pre><code>伯克利大学的Bill Joy在取得了UNIX的内核源码后，修改成为自己的版本，并重新命名为Berkeley Software Distribution(BSD)。BSD是UNIX很重要的一个分支，Bill Joy也是Sun这家公司的创办者。</code></pre><ul><li>1979年重要的<code>System V</code>架构与版权声明。</li></ul><pre><code>由于当时UNIX的高度可移植性与强大的性能，也没有版权纠纷，所以很多商业公司开始了UNIX操作系统的开发。例如：AT&amp;A自家的System V、IBM的AIX等。不过因为AT&amp;T由于商业的考略，于是想将UNIX的版权收回去。因此，AT&amp;T在1979年发行的第七版UNIX中，特别提到了“不可对学生提供源码”的严格限制。</code></pre><ul><li><strong>1984年</strong>：</li></ul><pre><code>X86架构的Minix操作系统诞生。关于1979的版权声明中，影响最大的当然就是学校里的教授了。于是荷兰阿姆斯特丹自由大学计算机科学系Andrew S. Tanenbaum开始编写内核程序，到了1986年终于完成，并于次年出版Minix相关书籍，同时雨新闻组（BBS及News）相结合。    - Richard Stallman发起GNU项目和自由软件基金会。    创建开源的UNIX实用工具版本    创建通用公共许可证（GPL）    开源软件许可实施原则</code></pre><ul><li>1991年：<code>Linus Torvalds</code>发布<code>Linux</code>创建开放源码，类<code>Unix</code>的内核，在<code>GPL</code>下发布。</li></ul><h3 id="老照片哦"><a href="#老照片哦" class="headerlink" title="老照片哦(^_^)"></a>老照片哦(^_^)</h3><h4 id="Ken-Thompson-和Dennis-Ritchie"><a href="#Ken-Thompson-和Dennis-Ritchie" class="headerlink" title="Ken Thompson 和Dennis Ritchie"></a><center>Ken Thompson 和Dennis Ritchie</center></h4><center><img src="https://houhaiyun.github.io/img/images/Linux-history-1.jpg" title="Ken Thompson 和Dennis Ritchie"></center><h4 id="Richard-Matthew-Stallman"><a href="#Richard-Matthew-Stallman" class="headerlink" title="Richard Matthew Stallman"></a><center>Richard Matthew Stallman</center></h4><center><img src="https://houhaiyun.github.io/img/images/Linux-history-2.jpg" title="Richard Matthew Stallman"></center><h4 id="Linus-Torvalds-1991"><a href="#Linus-Torvalds-1991" class="headerlink" title="Linus Torvalds, 1991"></a><center>Linus Torvalds, 1991</center></h4><center><img src="https://houhaiyun.github.io/img/images/Linux-history-3.jpg" title="Linus Torvalds, 1991"></center><h4 id="Linus-Torvalds给Minix新闻组的历史消息"><a href="#Linus-Torvalds给Minix新闻组的历史消息" class="headerlink" title="Linus Torvalds给Minix新闻组的历史消息"></a><center>Linus Torvalds给Minix新闻组的历史消息</center></h4><p><code>Linus Torvalds</code> 在芬兰赫尔辛基开始了 <code>Linux</code> 内核开发，他是为他的硬件-<code>Intel 30386 CPU</code>编写的程序。他也使用<code>Minix</code>和<code>GNU C</code>编译器。下面是<code>Linus Torvalds</code>给<code>Minix</code>新闻组的历史消息：</p><center><img src="https://houhaiyun.github.io/img/images/Linux-history-4.jpg" title="Linus Torvalds给Minix新闻组的历史消息"></center><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://linux.cn/article-6469-1.html" target="_blank" rel="noopener">老照片：Linux的24 年历史，一步一个脚印</a></p><p><a href="http://linux.vbird.org/" target="_blank" rel="noopener">鸟哥<code>linux</code>私房菜</a></p>]]></content>
      
      <categories>
          
          <category> Linux基础 </category>
          
          <category> Linux历史 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux历史 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>什么Linux？</title>
      <link href="/2017/07/01/Linux/"/>
      <url>/2017/07/01/Linux/</url>
      <content type="html"><![CDATA[<h3 id="什么是linux？"><a href="#什么是linux？" class="headerlink" title="什么是linux？"></a>什么是linux？</h3><p><code>Linux</code>是一种自由和开放源代码的类<code>UNIX</code>操作系统。目前运用领域最广泛、使用人数最多的操作系统。该操作系统的内核由林纳斯·托瓦兹在1991年10月5日首次发布。在加上用户空间的应用程序之后，成为<code>Linux</code>操作系统。<code>Linux</code>也是自由软件和开放源代码软件发展中最著名的例子。只要遵循<code>GNU</code>通用公共许可证，任何个人和机构都可以自由地使用<code>Linux</code>的所有底层源代码，也可以自由地修改和再发布。大多数<code>Linux</code>系统还包括像提供<code>GUI</code>的<code>X Window</code>之类的程序。除了一部分专家之外，大多数人都是直接使用<code>Linux</code>发行版，而不是自己选择每一样组件或自行设置。<br><a id="more"></a></p><p><code>Linux</code>严格来说是单指操作系统的内核，因操作系统中包含了许多用户图形接口和其他实用工具。如今<code>Linux</code>常用来指基于<code>Linux</code>的完整操作系统，内核则改以<code>Linux</code>内核称之。由于这些支持用户空间的系统工具和库主要由理查德·斯托曼于1983年发起的<code>GNU</code>计划提供，自由软件基金会提议将其组合系统命名为<code>GNU/Linux</code>，但<code>Linux</code>不属于<code>GNU</code>计划，这个名称并没有得到社区的一致认同。</p><h3 id="linux吉祥物TUX"><a href="#linux吉祥物TUX" class="headerlink" title="linux吉祥物TUX"></a><code>linux</code>吉祥物<code>TUX</code></h3><p><code>Tux</code>是<code>Linux</code>官方的吉祥物，于1996年由<code>Larry Ewing</code>创造</p><center><img src="https://houhaiyun.github.io/img/images/Linux-logo.png" title="Linux 吉祥物"></center><h4 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h4><p><a href="https://zh.wikipedia.org/wiki/" target="_blank" rel="noopener">维基百科：Linux</a></p>]]></content>
      
      <categories>
          
          <category> Linux基础 </category>
          
          <category> 什么Linux？ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 什么Linux？ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>冯.诺依曼体系结构</title>
      <link href="/2017/07/01/Linux-fengnuoyiman/"/>
      <url>/2017/07/01/Linux-fengnuoyiman/</url>
      <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><strong>冯·诺伊曼结构</strong>（英语：<code>von Neumann architecture</code>），也称<strong>冯·诺伊曼模型</strong>（<code>Von Neumann model</code>）或<strong>普林斯顿结构</strong>（<code>Princeton architecture</code>），是一种将程序指令存储器和数据存储器合并在一起的电脑设计概念结构。<br><a id="more"></a></p><h3 id="冯诺依曼体系结构提出"><a href="#冯诺依曼体系结构提出" class="headerlink" title="冯诺依曼体系结构提出"></a>冯诺依曼体系结构提出</h3><p>1946年数学家冯·诺依曼于提出：计算机硬件由运算器、控制器、存储器、输入设备、输出设备组成。</p><center><img src="https://houhaiyun.github.io/img/images/fengnuoyiman-jiegou-1.jpg" title="冯.诺依曼体系结构"></center><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ol><li>以运算单元为中心</li><li>采用存储程序原理</li><li>存储器是按地址访问、线性编址的空间</li><li>控制流由指令流产生</li><li>指令由操作码和地址码组成</li><li>数据以二进制编码</li></ol><h3 id="冯·诺伊曼瓶颈"><a href="#冯·诺伊曼瓶颈" class="headerlink" title="冯·诺伊曼瓶颈"></a>冯·诺伊曼瓶颈</h3><p>将CPU与内存分开并非十全十美，反而会导致所谓的冯·诺伊曼瓶颈（von Neumann bottleneck）：在CPU与内存之间的流量（数据传输率）与内存的容量相比起来相当小，在现代电脑中，流量与CPU的工作效率相比之下非常小，在某些情况下（当CPU需要在巨大的数据上运行一些简单指令时），数据流量就成了整体效率非常严重的限制。CPU将会在数据输入或输出内存时闲置。由于CPU速度远大于内存读写速率，因此瓶颈问题越来越严重。</p><h3 id="冯诺依曼"><a href="#冯诺依曼" class="headerlink" title="冯诺依曼"></a>冯诺依曼</h3><center><img src="https://houhaiyun.github.io/img/images/fengnuoyiman-jiegou-2.jpg" title="冯.诺依曼"></center><h4 id="致谢："><a href="#致谢：" class="headerlink" title="致谢："></a>致谢：</h4><p><a href="https://zh.wikipedia.org/wiki/%E5%86%AF%C2%B7%E8%AF%BA%E4%BC%8A%E6%9B%BC%E7%BB%93%E6%9E%84#.E7.90.86.E8.AB.96" target="_blank" rel="noopener">维基百科：冯·诺伊曼结构</a></p>]]></content>
      
      <categories>
          
          <category> 计算机基础知识 </category>
          
          <category> 冯.诺依曼体系结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 冯.诺依曼体系结构 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ABI和API</title>
      <link href="/2017/07/01/Linux-ABI-API/"/>
      <url>/2017/07/01/Linux-ABI-API/</url>
      <content type="html"><![CDATA[<h3 id="ABI"><a href="#ABI" class="headerlink" title="ABI"></a>ABI</h3><p>应用二进制接口（英语：<code>application binary interface</code>，缩写为 <code>ABI</code>）描述了应用程序（或者其他类型）和操作系统之间或其他应用程序的低级接口。允许编译好的目标代码在使用兼容<code>ABI</code>的系统中无需改动就能运行。<br><a id="more"></a></p><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>应用程序接口（英语：<code>Application Programming Interface</code>，简称：<code>API</code>），又称为应用编程接口，就是软件系统不同组成部分衔接的约定。</p><p>API定义了源代码和库之间的接口，因此同样的源代码可以在支持这个API的任何系统中编译。</p><center><img src="https://houhaiyun.github.io/img/images/ABI-API.gif" title="ABI and API"></center><h4 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h4><p><a href="https://zh.wikipedia.org/wiki/%E5%BA%94%E7%94%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%8E%A5%E5%8F%A3" target="_blank" rel="noopener">维基百科：应用二进制接口</a></p><p><a href="https://zh.wikipedia.org/wiki/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%8E%A5%E5%8F%A3" target="_blank" rel="noopener">维基百科：应用程序接口</a></p>]]></content>
      
      <categories>
          
          <category> 计算机基础知识 </category>
          
          <category> ABI和API </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ABI和API </tag>
            
        </tags>
      
    </entry>
    
  
  
</search>
