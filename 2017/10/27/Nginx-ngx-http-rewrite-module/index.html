<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>模块 ngx_http_rewrite_module | Keep learn!</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Nginx/">Nginx</a></div><div class="post-time">2017-10-27</div></div></div><div class="container post-header"><h1>模块 ngx_http_rewrite_module</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewrite-regex-replacement-flag"><span class="toc-number">2.</span> <span class="toc-text">rewrite regex replacement [flag];</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#flag"><span class="toc-number">2.1.</span> <span class="toc-text">[flag]</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#return-code-text"><span class="toc-number">3.</span> <span class="toc-text">return code [text];</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewrite-log-on-off"><span class="toc-number">4.</span> <span class="toc-text">rewrite_log on | off;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-variable-value"><span class="toc-number">5.</span> <span class="toc-text">set $variable value;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#if-condition-…"><span class="toc-number">6.</span> <span class="toc-text">if (condition) { … }</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#比较操作符："><span class="toc-number">6.1.</span> <span class="toc-text">比较操作符：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#文件及目录存在性判断："><span class="toc-number">6.2.</span> <span class="toc-text">文件及目录存在性判断：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现last跳转：bj目录下面的任何文件都跳转到beijing"><span class="toc-number">7.</span> <span class="toc-text">实现last跳转：bj目录下面的任何文件都跳转到beijing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现break跳转"><span class="toc-number">8.</span> <span class="toc-text">实现break跳转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现redirect-302临时重定向"><span class="toc-number">9.</span> <span class="toc-text">实现redirect 302临时重定向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现permanent-301永久重定向"><span class="toc-number">10.</span> <span class="toc-text">实现permanent 301永久重定向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#return实现禁止访问某个资源，并返回状态码"><span class="toc-number">11.</span> <span class="toc-text">return实现禁止访问某个资源，并返回状态码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#return实现跳转到新的URL"><span class="toc-number">12.</span> <span class="toc-text">return实现跳转到新的URL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#开启重写日志"><span class="toc-number">13.</span> <span class="toc-text">开启重写日志</span></a></li></ol></details></div><div class="container post-content"><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><strong>官网的介绍：</strong></p>
<p><code>The ngx_http_rewrite_module module is used to change request URI using PCRE regular expressions, return redirects, and conditionally select configurations.</code></p>
<p>将用户请求的<code>URI</code>基于<code>PCRE regex</code>所描述的模式进行检查，而后完成重定向替换</p>
<a id="more"></a>
<h3 id="rewrite-regex-replacement-flag"><a href="#rewrite-regex-replacement-flag" class="headerlink" title="rewrite regex replacement [flag];"></a>rewrite regex replacement [flag];</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	rewrite regex replacement [flag];</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, location, if</span><br></pre></td></tr></table></figure></p>
<ul>
<li>如果指定的正则表达式与请求<code>URI</code>匹配，则<code>URI</code>将按照<code>replacement</code>字符串中的指定进行更改。该<code>rewrite</code>指令在其在配置文件中出现的顺序顺序地执行。可以使用标志终止对伪指令的进一步处理。如果替换字符串以<code>“ http://”，“ https://”</code>或<code>“ $scheme”</code>开头，则处理停止，并将重定向返回给客户端。</li>
<li>将用户请求的<code>URI</code>基于<code>regex</code>所描述的模式进行检查，匹配到时将其替换为<code>replacement</code>指定的新的<code>URI</code></li>
<li>注意：如果在同一级配置块中存在多个<code>rewrite</code>规则，那么会自下而下逐个检查；被某条件规则替换完成后，会重新一轮的替换检查</li>
<li>隐含有循环机制,但不超过10次；如果超过，提示500响应码， <code>[flag]</code>所表示的标志位用于控制此循环机制</li>
<li>如果<code>replacement</code>是以<code>http://</code>或<code>https://</code>开头，则替换结果会直接以重向返回给客户端</li>
<li>301：永久重定向</li>
</ul>
<h4 id="flag"><a href="#flag" class="headerlink" title="[flag]"></a>[flag]</h4><ul>
<li><code>last</code>：重写完成后停止对当前<code>URI</code>在当前<code>location</code>中后续的其它重写操作，而后对新的<code>URI</code>启动新一轮重写检查；提前重启新一轮循环</li>
<li><code>break</code>：重写完成后停止对当前<code>URI</code>在当前<code>location</code>中后续的其它重写操作，而后直接跳转至重写规则配置块之后的其它配置；结束循环，建议在<code>location</code>中使用</li>
<li><code>redirect</code>：临时重定向，重写完成后以临时重定向方式直接返回重写后生成的新<code>URI</code>给客户端，由客户端重新发起请求；不能以<code>http://</code>或<code>https://</code>开头，使用相对路径，状态码： 302</li>
<li><code>permanent</code>:重写完成后以永久重定向方式直接返回重写后生成的新URI给客户端，由客户端重新发起请求，状态码：301</li>
</ul>
<h3 id="return-code-text"><a href="#return-code-text" class="headerlink" title="return code [text];"></a>return code [text];</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	return code [text];</span><br><span class="line">return code URL;</span><br><span class="line">return URL;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, location, if</span><br></pre></td></tr></table></figure></p>
<p>停止处理，并返回给客户端指定的响应码</p>
<h3 id="rewrite-log-on-off"><a href="#rewrite-log-on-off" class="headerlink" title="rewrite_log on | off;"></a>rewrite_log on | off;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	rewrite_log on | off;</span><br><span class="line">Default:	</span><br><span class="line">rewrite_log off;</span><br><span class="line">Context:	http, server, location, if</span><br></pre></td></tr></table></figure></p>
<p>是否开启重写日志, 发送至<code>error_log</code>（<code>notice level</code>）</p>
<h3 id="set-variable-value"><a href="#set-variable-value" class="headerlink" title="set $variable value;"></a>set $variable value;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	set $variable value;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, location, if</span><br></pre></td></tr></table></figure></p>
<p>用户自定义变量（注意：变量定义和调用都要以<code>$</code>开头）</p>
<h3 id="if-condition-…"><a href="#if-condition-…" class="headerlink" title="if (condition) { … }"></a>if (condition) { … }</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	if (condition) &#123; ... &#125;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, location</span><br></pre></td></tr></table></figure></p>
<ul>
<li>指定的<code>condition</code>被评估。如果为<code>true</code>，则在该大括号内指定的此模块指令将被执行，并且请求被分配给该<code>if</code>指令内的配置 。<code>if</code>指令内的配置继承自以前的配置级别。</li>
<li>引入新的上下文,条件满足时，执行配置块中的配置指令</li>
</ul>
<h4 id="比较操作符："><a href="#比较操作符：" class="headerlink" title="比较操作符："></a>比较操作符：</h4><ul>
<li><code>==</code>相同</li>
<li><code>!=</code> 不同</li>
<li><code>~</code>：模式匹配，区分字符大小写</li>
<li><code>~*</code>：模式匹配，不区分字符大小写</li>
<li><code>!~</code>：模式不匹配，区分字符大小写</li>
<li><code>!~*</code>：模式不匹配，不区分字符大小写</li>
</ul>
<h4 id="文件及目录存在性判断："><a href="#文件及目录存在性判断：" class="headerlink" title="文件及目录存在性判断："></a>文件及目录存在性判断：</h4><ul>
<li><code>-e</code>, <code>!-e</code> 存在（包括文件，目录，软链接）</li>
<li><code>-f</code>, <code>!-f</code> 文件</li>
<li><code>-d</code>, <code>!-d</code> 目录</li>
<li><code>-x</code>, <code>!-x</code> 执行</li>
</ul>
<h3 id="实现last跳转：bj目录下面的任何文件都跳转到beijing"><a href="#实现last跳转：bj目录下面的任何文件都跳转到beijing" class="headerlink" title="实现last跳转：bj目录下面的任何文件都跳转到beijing"></a>实现last跳转：bj目录下面的任何文件都跳转到beijing</h3><p>服务器内部跳转，在浏览器是看不到任何变化的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# mkdir /app/website1/beijing         #创建跳转目录</span><br><span class="line">[root@Nginx-Server ~]# cat /app/website1/beijing/index.html </span><br><span class="line">bi --&gt; beijing</span><br><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/conf.d/vhost.conf         #修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ;  </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123;</span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 last ;   </span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl 192.168.8.140/bj/index.html     # 注意已经跳转，因为我们是没有bj这个目录的</span><br><span class="line">bi --&gt; beijing</span><br></pre></td></tr></table></figure>
<center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-rewrite-module-1.gif" title="测试访问"></center>


<h3 id="实现break跳转"><a href="#实现break跳转" class="headerlink" title="实现break跳转"></a>实现break跳转</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123; </span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 break ;          # break跳转</span><br><span class="line">    </span><br><span class="line">    &#125;   </span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl 192.168.8.140/bj/           # 已经跳转</span><br><span class="line">bi --&gt; beijing</span><br></pre></td></tr></table></figure>
<h3 id="实现redirect-302临时重定向"><a href="#实现redirect-302临时重定向" class="headerlink" title="实现redirect 302临时重定向"></a>实现redirect 302临时重定向</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf </span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123; </span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 redirect ;</span><br><span class="line">    </span><br><span class="line">    &#125;   </span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl  -I  192.168.8.140/bj/      # 查看响应头部信息，已经是302重定向</span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Fri, 27 Oct 2017 00:51:30 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 161</span><br><span class="line">Location: http://192.168.8.140/beijing/</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl   192.168.8.140/bj/     # 直接访问bj目录会提示302</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;302 Found&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body bgcolor=&quot;white&quot;&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;302 Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.10.2&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[root@Nginx-Server ~]# curl -L   192.168.8.140/bj/      # 需要加上-L来跟踪重定向</span><br><span class="line">bi --&gt; beijing</span><br></pre></td></tr></table></figure>
<center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-rewrite-module-2.gif" title="测试访问"></center>


<h3 id="实现permanent-301永久重定向"><a href="#实现permanent-301永久重定向" class="headerlink" title="实现permanent 301永久重定向"></a>实现permanent 301永久重定向</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf </span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123; </span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 permanent ;</span><br><span class="line">    </span><br><span class="line">    &#125;   </span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl -I 192.168.8.140/bj/</span><br><span class="line">HTTP/1.1 301 Moved Permanently</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Fri, 27 Oct 2017 01:01:23 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 185</span><br><span class="line">Location: http://192.168.8.140/beijing/</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl -L 192.168.8.140/bj/</span><br><span class="line">bi --&gt; beijing</span><br></pre></td></tr></table></figure>
<h3 id="return实现禁止访问某个资源，并返回状态码"><a href="#return实现禁止访问某个资源，并返回状态码" class="headerlink" title="return实现禁止访问某个资源，并返回状态码"></a>return实现禁止访问某个资源，并返回状态码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123; </span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 permanent ;</span><br><span class="line">    </span><br><span class="line">    &#125;   </span><br><span class="line">    location /admin &#123;           # 定义当访问/admin目录时，返回信息&quot;access denied&quot;，且状态码为403</span><br><span class="line">        return 403 &quot;access denied&quot; ; </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl 192.168.8.140/admin     # 已经看到定义的拒绝信息</span><br><span class="line">access denied[root@Nginx-Server ~]# </span><br><span class="line">[root@Nginx-Server ~]# curl -I  192.168.8.140/admin     # 状态码为403</span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Fri, 27 Oct 2017 01:16:22 GMT</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line">Content-Length: 13</span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>
<h3 id="return实现跳转到新的URL"><a href="#return实现跳转到新的URL" class="headerlink" title="return实现跳转到新的URL"></a>return实现跳转到新的URL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123; </span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 permanent ;</span><br><span class="line">    </span><br><span class="line">    &#125;   </span><br><span class="line">    location /admin &#123;</span><br><span class="line">        return 403 &quot;access denied&quot; ;</span><br><span class="line">    &#125;   </span><br><span class="line">    location /return &#123;          # 当访问/return时，就跳转到http://www.ihaiyun.cc/</span><br><span class="line">        return http://www.ihaiyun.cc/ ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# curl -I 192.168.8.140/return     # 已经可以跳转</span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.10.2</span><br><span class="line">Date: Fri, 27 Oct 2017 01:22:09 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 161</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: http://www.ihaiyun.cc/</span><br></pre></td></tr></table></figure>
<center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-rewrite-module-3.gif" title="测试访问"></center>

<h3 id="开启重写日志"><a href="#开启重写日志" class="headerlink" title="开启重写日志"></a>开启重写日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf      # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443  ssl  default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    location / &#123; </span><br><span class="line">    rewrite ^/bj/(.*)$ /beijing/$1 permanent ;</span><br><span class="line">    </span><br><span class="line">    &#125;   </span><br><span class="line">    location /admin &#123;</span><br><span class="line">        return 403 &quot;access denied&quot; ;</span><br><span class="line">    &#125;   </span><br><span class="line">    location /return &#123;</span><br><span class="line">        return http://www.ihaiyun.cc/ ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    rewrite_log on ;            # 开启重写日志</span><br><span class="line">    error_log /var/log/nginx/return.log ;       # 定义error_log存放位置，因为rewrite_log默认发送到error_log中</span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_session_cache shared:sslcache:20m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx </span><br><span class="line">    </span><br><span class="line">[root@CLIENT ~]# curl -L 192.168.8.140/bj/      # 访问测试</span><br><span class="line">bi --&gt; beijing</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# tail /var/log/nginx/return.log       # 查看日志</span><br><span class="line">2017/10/27 09:38:11 [error] 2536#0: *4 open() &quot;/app/website1/bj&quot; failed (2: No such file or directory), client: 192.168.8.128, server: www.a.com, request: &quot;GET /bj HTTP/1.1&quot;, host: &quot;192.168.8.140&quot;</span><br></pre></td></tr></table></figure>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>