<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>模块  ngx_http_upstream_module | Peter's technology stack.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Nginx/">Nginx</a></div><div class="post-time">2017-10-27</div></div></div><div class="container post-header"><h1>模块  ngx_http_upstream_module</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#upstream-name-…"><span class="toc-number">2.</span> <span class="toc-text">upstream name { … }</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server-address-parameters"><span class="toc-number">3.</span> <span class="toc-text">server address [parameters];</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#parameters："><span class="toc-number">3.1.</span> <span class="toc-text">parameters：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ip-hash"><span class="toc-number">4.</span> <span class="toc-text">ip_hash;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#least-conn"><span class="toc-number">5.</span> <span class="toc-text">least_conn;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hash-key-consistent"><span class="toc-number">6.</span> <span class="toc-text">hash key [consistent];</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#keepalive-连接数N"><span class="toc-number">7.</span> <span class="toc-text">keepalive 连接数N;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#health-check-parameters"><span class="toc-number">8.</span> <span class="toc-text">health_check [parameters];</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#match-name-…"><span class="toc-number">9.</span> <span class="toc-text">match name { … }</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现upstream"><span class="toc-number">10.</span> <span class="toc-text">实现upstream</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现upstream，定义Nginx为sorry-server"><span class="toc-number">11.</span> <span class="toc-text">实现upstream，定义Nginx为sorry server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现ip-hash，针对源地址永久调度到一台后部web-server"><span class="toc-number">12.</span> <span class="toc-text">实现ip_hash，针对源地址永久调度到一台后部web server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现least-conn，根据服务器的真实负载来调度"><span class="toc-number">13.</span> <span class="toc-text">实现least_conn，根据服务器的真实负载来调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现hash根据用户的URI来调度"><span class="toc-number">14.</span> <span class="toc-text">实现hash根据用户的URI来调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一致性hash算法"><span class="toc-number">15.</span> <span class="toc-text">一致性hash算法</span></a></li></ol></details></div><div class="container post-content"><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>该<code>ngx_http_upstream_module</code>模块用于定义可由<code>proxy_pass</code>， <code>fastcgi_pass</code>， <code>uwsgi_pass</code>， <code>scgi_pass</code>和<code>memcached_pa​​ss</code>指令引用的服务器组。</p>
<p>用于将多个服务器定义成服务器组，而由<code>proxy_pass,fastcgi_pass</code>等指令进行引用</p>
<h3 id="upstream-name-…"><a href="#upstream-name-…" class="headerlink" title="upstream name { … }"></a>upstream name { … }</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	upstream name &#123; ... &#125;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>定义一组服务器。服务器可以在不同端口上侦听。另外，监听<code>TCP</code>和<code>UNIX</code>域套接字的服务器可以混合使用。</p>
<p>定义后端服务器组，会引入一个新的上下文,默认调度算法是wrr</p>
<h3 id="server-address-parameters"><a href="#server-address-parameters" class="headerlink" title="server address [parameters];"></a>server address [parameters];</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	server address [parameters];</span><br><span class="line">Default:	—</span><br><span class="line">Context:	upstream</span><br></pre></td></tr></table></figure></p>
<p>定义 服务器<code>address</code>和其他<code>parameters</code>服务器。可以将该地址指定为具有可选端口的域名或IP地址，或者指定为“ <code>unix:</code>”前缀之后指定的<code>UNIX</code>域套接字路径。如果未指定端口，则使用端口80。解析为多个<code>IP</code>地址的域名一次定义多个服务器。</p>
<p>在<code>upstream</code>上下文中<code>server</code>成员，以及相关的参数； ·<code>Context:upstream address·</code>的表示格式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unix:/PATH/TO/SOME_SOCK_FILE</span><br><span class="line">IP[:PORT]</span><br><span class="line">HOSTNAME[:PORT]</span><br></pre></td></tr></table></figure></p>
<h4 id="parameters："><a href="#parameters：" class="headerlink" title="parameters："></a>parameters：</h4><ul>
<li><code>weight=number</code> 权重，默认为1</li>
<li><code>max_conns</code> 连接后端报务器最大并发活动连接数， 1.11.5后支持</li>
<li><code>max_fails=number</code> 失败尝试最大次数；超出此处指定的次数时， server将被标记为不可用,默认为<code>1</code></li>
<li><code>fail_timeout=time</code> 后端服务器标记为不可用状态的连接超时时长，默认<code>10s</code></li>
<li><code>backup</code> 将服务器标记为“备用”，即所有服务器均不可用时才启用</li>
<li><code>down</code> 标记为“不可用”，配合<code>ip_hash</code>使用，实现灰度发布</li>
</ul>
<h3 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash;"></a>ip_hash;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	ip_hash;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	upstream</span><br></pre></td></tr></table></figure></p>
<p>指定组应该使用根据客户端IP地址在服务器之间分配请求的负载平衡方法。客户端<code>IPv4</code>地址或整个<code>IPv6</code>地址的前三个八位字节被用作散列密钥。该方法确保来自同一客户端的请求将始终传递到同一服务器，除非此服务器不可用。在后一种情况下，客户端请求将被传递到另一个服务器。很可能，它将始终是同一台服务器。</p>
<p>源地址hash调度方法</p>
<h3 id="least-conn"><a href="#least-conn" class="headerlink" title="least_conn;"></a>least_conn;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	least_conn;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	upstream</span><br><span class="line">This directive appeared in versions 1.3.1 and 1.2.2.</span><br></pre></td></tr></table></figure></p>
<p>指定一个组应该使用负载平衡方法，其中请求被传递到具有最少数量的活动连接的服务器，同时考虑服务器的权重。如果有几个这样的服务器，则依次使用加权循环平衡方法。</p>
<p>最少连接调度算法，当<code>server</code>拥有不同的权重时其为<code>wlc</code>，当所有后端主机连接数相同时，则使用<code>wrr</code>，适用于长连接</p>
<h3 id="hash-key-consistent"><a href="#hash-key-consistent" class="headerlink" title="hash key [consistent];"></a>hash key [consistent];</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	hash key [consistent];</span><br><span class="line">Default:	—</span><br><span class="line">Context:	upstream</span><br><span class="line">This directive appeared in version 1.7.2.</span><br></pre></td></tr></table></figure></p>
<p>基于指定的<code>key</code>的<code>hash</code>表来实现对请求的调度，此处的<code>key</code>可以直接文本、变量或二者组合</p>
<p>作用：将请求分类，同一类请求将发往同一个<code>upstream server</code>，使用<code>consistent</code>参数，将使用<code>ketama</code>一致性<code>hash</code>算法，适用于后端是<code>Cache</code>服务器（如<code>varnish</code>）时使用</p>
<ul>
<li><code>hash $request_uri consistent;</code></li>
<li><code>hash $remote_addr;</code></li>
</ul>
<h3 id="keepalive-连接数N"><a href="#keepalive-连接数N" class="headerlink" title="keepalive 连接数N;"></a>keepalive 连接数N;</h3><p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	keepalive connections;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	upstream</span><br></pre></td></tr></table></figure></p>
<p>为每个<code>worker</code>进程保留的空闲的长连接数量,可节约<code>nginx</code>端口，并减少连接管理的消耗</p>
<h3 id="health-check-parameters"><a href="#health-check-parameters" class="headerlink" title="health_check [parameters];"></a>health_check [parameters];</h3><ul>
<li><code>health_check [parameters];</code></li>
<li>健康状态检测机制；只能用于location上下文</li>
</ul>
<p>常用参数：</p>
<ul>
<li><code>interval=time</code>检测的频率，默认为5秒</li>
<li><code>fails=number</code>：判定服务器不可用的失败检测次数；默认为1次</li>
<li><code>passes=number</code>：判定服务器可用的失败检测次数；默认为1次</li>
<li><code>uri=uri</code>：做健康状态检测测试的目标<code>uri</code>；默认为/</li>
<li><code>match=NAME</code>：健康状态检测的结果评估调用此处指定的<code>match</code>配置块注意：仅对<code>nginx plus</code>有效</li>
</ul>
<p><strong>注意：此项仅对商业版nginx有效</strong></p>
<h3 id="match-name-…"><a href="#match-name-…" class="headerlink" title="match name { … }"></a>match name { … }</h3><p>对<code>backend server</code>做健康状态检测时，定义其结果判断机制；只能用于<code>http</code>上下文</p>
<p>常用的参数：</p>
<ul>
<li><code>status code[ code ...]</code>: 期望的响应状态码</li>
<li><code>header HEADER[operator value]</code>：期望存在响应首部，也可对期望的响应首部的值基于比较操作符和值进行比较<code>body</code>：期望响应报文的主体部分应该有的内容</li>
</ul>
<p><strong>注意：此项仅对商业版nginx有效</strong></p>
<h3 id="实现upstream"><a href="#实现upstream" class="headerlink" title="实现upstream"></a>实现upstream</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/nginx.conf        # 修改主配置文件</span><br><span class="line">upstream web &#123;          #定义一个网络组，名称为web，网络组定义了两台server，分别为192.168.8.128和192.168.8.138</span><br><span class="line">        server 192.168.8.128:80 weight=1 ;</span><br><span class="line">        server 192.168.8.138:80 weight=2 ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/conf.d/vhost.conf     # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ; </span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    </span><br><span class="line">        location / &#123; </span><br><span class="line">            proxy_pass http://web;              # 定义访问本地的web根目录就代理到网络组web</span><br><span class="line">        &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s reload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 第一台server的配置</span><br><span class="line">[root@138 ~]# ifconfig ens34</span><br><span class="line">ens34: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.8.138  netmask 255.255.255.0  broadcast 192.168.8.255</span><br><span class="line">        inet6 fe80::20c:29ff:feba:2438  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:ba:24:38  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 76396  bytes 13285907 (12.6 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 74734  bytes 17770296 (16.9 MiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@138 ~]# yum install -y httpd</span><br><span class="line">[root@fast-cgi ~]# echo &quot;192.168.8.138&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@138 ~]# systemctl start httpd</span><br><span class="line">[root@138 ~]# ss -tnul          # 80端口已经打开</span><br><span class="line">Netid State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              </span><br><span class="line"></span><br><span class="line">tcp   LISTEN     0      128              *:9000                         *:*                  </span><br><span class="line">tcp   LISTEN     0      128             :::80                          :::*                  </span><br><span class="line">tcp   LISTEN     0      128             :::22                          :::*                  </span><br><span class="line">tcp   LISTEN     0      100            ::1:25                          :::*      </span><br><span class="line">[root@138 ~]# curl 192.168.8.138        # 本地测试可以访问</span><br><span class="line">192.168.8.138</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 第二台server的配置</span><br><span class="line">[root@128 ~]# ifconfig eth1</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 00:0C:29:DE:D2:8C  </span><br><span class="line">          inet addr:192.168.8.128  Bcast:192.168.8.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:fede:d28c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:5031 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:4554 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:843593 (823.8 KiB)  TX bytes:1662926 (1.5 MiB)</span><br><span class="line">[root@128 ~]# yum install -y httpd</span><br><span class="line">[root@128 ~]# echo &quot;192.168.8.128&quot; &gt; /var/www/html/index.html</span><br><span class="line">[root@128 ~]# service httpd start</span><br><span class="line">Starting httpd:                             [  OK  ]</span><br><span class="line">[root@128 ~]# ss -tnul      # 80端口已经打开</span><br><span class="line">Netid State      Recv-Q Send-Q            Local Address:Port              Peer Address:Port </span><br><span class="line">udp   UNCONN     0      0                             *:68                           *:*     </span><br><span class="line">tcp   LISTEN     0      50                            *:3306                         *:*     </span><br><span class="line">tcp   LISTEN     0      128                          :::80                          :::*     </span><br><span class="line">tcp   LISTEN     0      128                          :::22                          :::*     </span><br><span class="line">tcp   LISTEN     0      128                           *:22                           *:*     </span><br><span class="line">tcp   LISTEN     0      100                         ::1:25                          :::*     </span><br><span class="line">tcp   LISTEN     0      100                   127.0.0.1:25                           *:*   </span><br><span class="line">[root@128 ~]# curl 192.168.8.128        # 本地测试可以访问</span><br><span class="line">192.168.8.128</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# for i in &#123;1..10&#125; ; do curl 192.168.8.140 ; done       #访问测试，ok</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br></pre></td></tr></table></figure>
<h3 id="实现upstream，定义Nginx为sorry-server"><a href="#实现upstream，定义Nginx为sorry-server" class="headerlink" title="实现upstream，定义Nginx为sorry server"></a>实现upstream，定义Nginx为sorry server</h3><p>我们还是接着上面的实验来做</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改nginx的主配置文件</span><br><span class="line">http &#123;</span><br><span class="line">upstream web &#123;</span><br><span class="line">        server 192.168.8.128:80 weight=1 ;</span><br><span class="line">        server 192.168.8.138:80 weight=2 ;</span><br><span class="line">        server 127.0.0.1:81 backup ;        # 定义本地服务器81端口为backup服务器，相当于sorry server</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# echo &quot;Soryy! 我们的服务器宕机了！正在抢修中...&quot; &gt; /app/website2/index.html        #修改默认页面的内容</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# vim /etc/nginx/conf.d/vhost.conf     # 修改配置文件</span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ; </span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    </span><br><span class="line">        location / &#123; </span><br><span class="line">            proxy_pass http://web; </span><br><span class="line">        &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 81 ;</span><br><span class="line">    server_name www.b.com ; </span><br><span class="line">    root /app/website2 ;</span><br><span class="line">    error_log /var/log/nginx/b.com.error.log  ;   </span><br><span class="line">    access_log /var/log/nginx/b.com.access.log main ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -t </span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@centos7 ~]# nginx -s reload</span><br><span class="line"></span><br><span class="line">[root@138 ~]# systemctl stop httpd      # 停止138的httpd服务</span><br><span class="line">[root@128 ~]# service httpd stop        # 停止128的httpd服务</span><br><span class="line">Stopping httpd:                                            [  OK  ]</span><br><span class="line">[root@centos7 ~]# curl 192.168.8.140        #访问测试，ok</span><br><span class="line">Soryy! 我们的服务器宕机了！正在抢修中...</span><br><span class="line"></span><br><span class="line">[root@138 ~]# systemctl start httpd         # 启动138的httpd服务</span><br><span class="line">[root@128 ~]# service httpd start       # 启动128的httpd服务</span><br><span class="line">Starting httpd:                             [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# for i in &#123;1..10&#125; ; do curl 192.168.8.140 ; done       # 访问测试，一切正常</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br></pre></td></tr></table></figure>
<h3 id="实现ip-hash，针对源地址永久调度到一台后部web-server"><a href="#实现ip-hash，针对源地址永久调度到一台后部web-server" class="headerlink" title="实现ip_hash，针对源地址永久调度到一台后部web server"></a>实现ip_hash，针对源地址永久调度到一台后部web server</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">http &#123;</span><br><span class="line">upstream web &#123;</span><br><span class="line">        server 192.168.8.128:80 weight=1 ;</span><br><span class="line">        server 192.168.8.138:80 weight=2 ;</span><br><span class="line">        server 127.0.0.1:81 backup ;</span><br><span class="line">        ip_hash ;           # 添加ip_hash</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@centos7 ~]# nginx -s reload</span><br><span class="line">[root@centos7 ~]# for i in &#123;1..10&#125; ; do curl 192.168.8.140 ; done           # 测试，都调度到一台web server了</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br></pre></td></tr></table></figure>
<h3 id="实现least-conn，根据服务器的真实负载来调度"><a href="#实现least-conn，根据服务器的真实负载来调度" class="headerlink" title="实现least_conn，根据服务器的真实负载来调度"></a>实现least_conn，根据服务器的真实负载来调度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">http &#123;</span><br><span class="line">upstream web &#123;</span><br><span class="line">        server 192.168.8.128:80 weight=1 ;</span><br><span class="line">        server 192.168.8.138:80 weight=2 ;</span><br><span class="line">        server 127.0.0.1:81 backup ;</span><br><span class="line">        least_conn ;            # 添加least_conn</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -s reload</span><br><span class="line">[root@centos7 ~]# for i in &#123;1..10&#125; ; do curl 192.168.8.140 ; done           # 访问测试，ok</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.128</span><br><span class="line">192.168.8.138</span><br><span class="line">192.168.8.138</span><br></pre></td></tr></table></figure>
<h3 id="实现hash根据用户的URI来调度"><a href="#实现hash根据用户的URI来调度" class="headerlink" title="实现hash根据用户的URI来调度"></a>实现hash根据用户的URI来调度</h3><p>此项可以配合缓存服务器来使用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/nginx.conf         # 修改配置文件</span><br><span class="line">http &#123;</span><br><span class="line">upstream web &#123;</span><br><span class="line">        server 192.168.8.128:80 weight=1 ;</span><br><span class="line">        server 192.168.8.138:80 weight=2 ;</span><br><span class="line">        server 127.0.0.1:81 backup ;</span><br><span class="line">        hash  $request_uri ;            # 添加hash key基于URI</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# nginx -s reload</span><br><span class="line"></span><br><span class="line">[root@138 ~]# for i in &#123;1..5&#125; ; do echo &quot;$i.html 193.168.8.138&quot; &gt; /var/www/html/$i.html  ; done     # 在138上面创建5个测试页面</span><br><span class="line">[root@138 ~]# ls /var/www/html/</span><br><span class="line">1.html  2.html  3.html  4.html  5.html  blog  index.html</span><br><span class="line">[root@138 ~]# cat /var/www/html/1.html </span><br><span class="line">1.html 193.168.8.138</span><br><span class="line"></span><br><span class="line">[root@128 ~]# for i in &#123;1..5&#125; ; do echo &quot;$i.html 193.168.8.128&quot; &gt; /var/www/html/$i.html  ; done     # 在128上面创建5个测试页面</span><br><span class="line">[root@128 ~]# ls /var/www/html/</span><br><span class="line">1.html  2.html  3.html  4.html  5.html  index.html</span><br><span class="line">[root@128 ~]# cat /var/www/html/1.html </span><br><span class="line">1.html 193.168.8.128</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# for i in &#123;1..5&#125; ; do curl 192.168.8.140/1.html ; done     # 测试访问，1.html都已经调度到128这台server</span><br><span class="line">1.html 193.168.8.128</span><br><span class="line">1.html 193.168.8.128</span><br><span class="line">1.html 193.168.8.128</span><br><span class="line">1.html 193.168.8.128</span><br><span class="line">1.html 193.168.8.128</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# for i in &#123;1..5&#125; ; do curl 192.168.8.140/3.html ; done     # 测试访问，3.html都已经调度到138这台server</span><br><span class="line">3.html 193.168.8.138</span><br><span class="line">3.html 193.168.8.138</span><br><span class="line">3.html 193.168.8.138</span><br><span class="line">3.html 193.168.8.138</span><br><span class="line">3.html 193.168.8.138</span><br></pre></td></tr></table></figure></p>
<h3 id="一致性hash算法"><a href="#一致性hash算法" class="headerlink" title="一致性hash算法"></a>一致性hash算法</h3><p>作用：一致性hash算法（<code>DHT</code>）通过减少影响范围的方式解决了增减服务器导致的数据散列问题，从而解决了分布式环境下负载均衡问题，如果存在热点数据，那么通过增添节点的方式，对热点区间进行划分，将压力分配至其他服务器。重新达到负载均衡的状态。  </p>
<p>一致性哈希基本解决了在<code>P2P</code>环境中最为关键的问题——如何在动态的网络拓扑中分布存储和路由。每个节点仅需维护少量相邻节点的信息，并且在节点加入/退出系统时，仅有相关的少量节点参与到拓扑的维护中。所有这一切使得一致性哈希成为第一个实用的<code>DHT</code>算法。</p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>