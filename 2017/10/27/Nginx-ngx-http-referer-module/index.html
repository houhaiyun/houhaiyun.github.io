<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>模块 ngx_http_referer_module | Keep learn!</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Nginx/">Nginx</a></div><div class="post-time">2017-10-27</div></div></div><div class="container post-header"><h1>模块 ngx_http_referer_module</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#官网介绍"><span class="toc-number">1.</span> <span class="toc-text">官网介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#valid-referers-none-blocked-server-names-string-…"><span class="toc-number">2.</span> <span class="toc-text">valid_referers none | blocked | server_names | string …;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#参数"><span class="toc-number">2.1.</span> <span class="toc-text">参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#理解什么是referer？"><span class="toc-number">3.</span> <span class="toc-text">理解什么是referer？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模拟盗链现象"><span class="toc-number">4.</span> <span class="toc-text">模拟盗链现象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#修改配置文件"><span class="toc-number">4.1.</span> <span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#准备访问资源"><span class="toc-number">4.2.</span> <span class="toc-text">准备访问资源</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动服务测试"><span class="toc-number">4.3.</span> <span class="toc-text">启动服务测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分析日志"><span class="toc-number">4.4.</span> <span class="toc-text">分析日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现防盗链"><span class="toc-number">5.</span> <span class="toc-text">实现防盗链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#致谢"><span class="toc-number">6.</span> <span class="toc-text">致谢</span></a></li></ol></details></div><div class="container post-content"><h3 id="官网介绍"><a href="#官网介绍" class="headerlink" title="官网介绍"></a>官网介绍</h3><p>The ngx_http_referer_module module is used to block access to a site for requests with invalid values in the “Referer” header field. It should be kept in mind that fabricating a request with an appropriate “Referer” field value is quite easy, and so the intended purpose of this module is not to block such requests thoroughly but to block the mass flow of requests sent by regular browsers. It should also be taken into consideration that regular browsers may not send the “Referer” field even for valid requests.</p>
<p>该<code>ngx_http_referer_module</code>模块用于在<code>“Referer”</code>标题字段中阻止对具有无效值的请求的站点访问。应该记住，使用适当的<code>“Referer”</code>字段值制造请求是非常容易的，因此本模块的预期目的不是彻底阻止这些请求，而是阻止常规浏览器发送的请求的大量流量。还应该考虑到，即使有效的请求，常规浏览器也可能不会发送<code>“Referer”</code>字段。</p>
<h3 id="valid-referers-none-blocked-server-names-string-…"><a href="#valid-referers-none-blocked-server-names-string-…" class="headerlink" title="valid_referers none | blocked | server_names | string …;"></a>valid_referers none | blocked | server_names | string …;</h3><a id="more"></a>
<p><strong>官网帮助：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax:	valid_referers none | blocked | server_names | string ...;</span><br><span class="line">Default:	—</span><br><span class="line">Context:	server, location</span><br></pre></td></tr></table></figure></p>
<p>定义<code>referer</code>首部的合法可用值，不能匹配的将是非法值</p>
<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><ul>
<li><code>none</code>：请求报文首部没有<code>referer</code>首部</li>
<li><code>blocked</code>：请求报文有<code>referer</code>首部，但无有效值</li>
<li><code>server_names</code>：参数，其可以有值作为主机名或主机名模式</li>
<li><code>arbitrary_string</code>：任意字符串，但可使用<code>*</code>作通配符</li>
<li><code>regular expression</code>：被指定的正则表达式模式匹配到的字符串,要使用<code>~</code>开头，例如：<code>~.*\.magedu\.com</code></li>
</ul>
<h3 id="理解什么是referer？"><a href="#理解什么是referer？" class="headerlink" title="理解什么是referer？"></a>理解什么是referer？</h3><p><code>HTTP Referer</code>是<code>header</code>的一部分，当浏览器向<code>web</code>服务器发送请求的时候，一般会带上<code>Referer</code>，告诉服务器我是从哪个页面链接过来的，服务器基此可以获得一些信息用于处理。</p>
<h3 id="模拟盗链现象"><a href="#模拟盗链现象" class="headerlink" title="模拟盗链现象"></a>模拟盗链现象</h3><h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 定义两台虚拟主机，wwww.a.com（默认）和www.b.com；分别定义了access_log和error_log。</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 创建配置文件，用来定义虚拟主机   </span><br><span class="line"></span><br><span class="line">server &#123;            # 第一台虚拟主机</span><br><span class="line">    listen   default_server ;</span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ;</span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ;</span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;            # 第二台虚拟主机</span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.b.com ;</span><br><span class="line">    root /app/website2 ;</span><br><span class="line">    error_log /var/log/nginx/b.com.error.log  ; </span><br><span class="line">    access_log /var/log/nginx/b.com.access.log main ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="准备访问资源"><a href="#准备访问资源" class="headerlink" title="准备访问资源"></a>准备访问资源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# mkdir -p  /app/website&#123;1,2&#125;</span><br><span class="line">[root@Nginx-Server app]# cd /app/</span><br><span class="line">[root@Nginx-Server app]# echo &quot;website1&quot; &gt; /app/website1/index.html </span><br><span class="line">[root@Nginx-Server app]# echo &quot;website2&quot; &gt; /app/website2/index.html </span><br><span class="line">[root@Nginx-Server app]# find /  -name &quot;*.jpg&quot;      # find几个图片</span><br><span class="line">/usr/share/backgrounds/morning.jpg</span><br><span class="line">/usr/share/backgrounds/night.jpg</span><br><span class="line">/usr/share/backgrounds/day.jpg</span><br><span class="line">/usr/share/backgrounds/default.jpg</span><br><span class="line">/usr/share/kde4/apps/ksplash/Themes/CentOS7/2560x1600/background.jpg</span><br><span class="line">/usr/share/wallpapers/CentOS7/contents/images/2560x1600.jpg</span><br><span class="line">[root@Nginx-Server app]# cp /usr/share/wallpapers/CentOS7/contents/images/2560x1600.jpg /app/website1/aa.jpg        # cp图片</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server app]# cd website2/</span><br><span class="line">[root@Nginx-Server website2]# vim dao.html      #编写盗链html文件，图片是指向www.a.com的</span><br><span class="line">&lt;img src=http://www.a.com/a.jpg&gt;</span><br><span class="line"></span><br><span class="line">[root@Nginx-Server app]# tree       # 目录结构，注意b站点中是没有图片文件</span><br><span class="line">.</span><br><span class="line">├── website1</span><br><span class="line">│   ├── aa.jpg</span><br><span class="line">│   ├── a.jpg</span><br><span class="line">│   └── index.html</span><br><span class="line">└── website2</span><br><span class="line">    ├── dao.html</span><br><span class="line">    └── index.html</span><br><span class="line"></span><br><span class="line">2 directories, 5 files</span><br></pre></td></tr></table></figure>
<h4 id="启动服务测试"><a href="#启动服务测试" class="headerlink" title="启动服务测试"></a>启动服务测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# nginx -t         # 检查配置文件，ok</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop        # 停止nginx服务</span><br><span class="line">[root@Nginx-Server ~]# nginx        # 启动nginx服务</span><br></pre></td></tr></table></figure>
<ol>
<li>测试<a href="http://www.a.com/a.jpg" target="_blank" rel="noopener">www.a.com/a.jpg</a></li>
<li>访问<a href="http://www.b.com/dao.html" target="_blank" rel="noopener">www.b.com/dao.html</a></li>
<li>查看图片来源</li>
</ol>
<center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-referer-module-1.gif" title="测试访问"></center>


<h4 id="分析日志"><a href="#分析日志" class="headerlink" title="分析日志"></a>分析日志</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Nginx-Server ~]# tail -1  /var/log/nginx/a.com.access.log         # 查看a的日志，从日志可以看出referer是http://www.b.com/dao.html，这肯定是有问题的。</span><br><span class="line">192.168.8.100 - - [27/Oct/2017:11:07:48 +0800] &quot;GET /a.jpg HTTP/1.1&quot; 304 0 &quot;http://www.b.com/dao.html&quot; &quot;Mozilla/5.0 (Windows NT 6.1; WOW64; rv:55.0) Gecko/20100101 Firefox/55.0&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure>
<h3 id="实现防盗链"><a href="#实现防盗链" class="headerlink" title="实现防盗链"></a>实现防盗链</h3><p>上面的实验我们已经实现了盗链，现在我们来阻止盗链，呵呵~~~</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/nginx/conf.d/vhost.conf          # 修改配置文件</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen   default_server ; </span><br><span class="line">    listen 80  ;</span><br><span class="line">    server_name www.a.com ; </span><br><span class="line">    root /app/website1 ;</span><br><span class="line">    error_log /var/log/nginx/a.com.error.log ; </span><br><span class="line">    access_log /var/log/nginx/a.com.access.log main ;</span><br><span class="line">    </span><br><span class="line">    valid_referers none blocked server_names</span><br><span class="line">               *.a.com a\.com.* www\.a\.com.*</span><br><span class="line">               ~\.google\.</span><br><span class="line">               ~\.baidu\.;</span><br><span class="line"></span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        return 403 &quot;禁止盗链！！！&quot; ;</span><br><span class="line">    &#125;   </span><br><span class="line">        </span><br><span class="line">    location / &#123; </span><br><span class="line">         </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80  ;</span><br><span class="line">    listen 81 ;</span><br><span class="line">    server_name www.b.com ; </span><br><span class="line">    root /app/website2 ;</span><br><span class="line">    error_log /var/log/nginx/b.com.error.log  ;   </span><br><span class="line">    access_log /var/log/nginx/b.com.access.log main ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@Nginx-Server ~]# nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line">[root@Nginx-Server ~]# nginx -s stop</span><br><span class="line">[root@Nginx-Server ~]# nginx</span><br></pre></td></tr></table></figure>
<ol>
<li>在b站点已经无法查看图片</li>
<li>在a站点依旧可以查看</li>
</ol>
<center><img src="https://houhaiyun.github.io/img/images/Nginx-ngx-http-referer-module-2.gif" title="测试访问"></center>

<h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://baike.baidu.com/item/HTTP_REFERER/5358396?fr=aladdin" target="_blank" rel="noopener">百度百科：HTTP_REFERER</a></p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>