<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>Keepalived配置文件 | Peter's technology stack.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/KeepAlived/">KeepAlived</a></div><div class="post-time">2017-10-29</div></div></div><div class="container post-header"><h1>Keepalived配置文件</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Keepalived的配置文件"><span class="toc-number">1.</span> <span class="toc-text">Keepalived的配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#global-defs区域"><span class="toc-number">1.1.</span> <span class="toc-text">global_defs区域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#static-ipaddress和static-routes区域"><span class="toc-number">1.2.</span> <span class="toc-text">static_ipaddress和static_routes区域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vrrp-instance和vrrp-sync-group区域"><span class="toc-number">1.3.</span> <span class="toc-text">vrrp_instance和vrrp_sync_group区域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vrrp-script区域"><span class="toc-number">1.4.</span> <span class="toc-text">vrrp_script区域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#virtual-server-group和virtual-server区域"><span class="toc-number">1.5.</span> <span class="toc-text">virtual_server_group和virtual_server区域</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#致谢"><span class="toc-number">2.</span> <span class="toc-text">致谢</span></a></li></ol></details></div><div class="container post-content"><h3 id="Keepalived的配置文件"><a href="#Keepalived的配置文件" class="headerlink" title="Keepalived的配置文件"></a>Keepalived的配置文件</h3><p><code>keepalived</code>只有一个配置文件<code>keepalived.conf</code>，里面主要包括以下几个配置区域，分别是<code>global_defs</code>、<code>static_ipaddress</code>、<code>static_routes</code>、<code>vrrp_script</code>、<code>vrrp_instance</code>和<code>virtual_server</code>。</p>
<a id="more"></a>
<h4 id="global-defs区域"><a href="#global-defs区域" class="headerlink" title="global_defs区域"></a>global_defs区域</h4><p>主要是配置故障发生时的通知对象以及机器标识</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;                       # 全局配置</span><br><span class="line">   notification_email &#123;             # 通告邮件的用户</span><br><span class="line">     root@localhost                 # 指定keepalived在发生切换时需要发送email到的对象，一行一个</span><br><span class="line">   &#125;   </span><br><span class="line">   # 邮件服务器配置</span><br><span class="line">   notification_email_from keepalived@localhost         # 指定发件人</span><br><span class="line">   smtp_server 127.0.0.1            # smtp 服务器地址</span><br><span class="line">   smtp_connect_timeout 30          # smtp 服务器连接超时时间</span><br><span class="line">   router_id master                 # 标识本节点的字符串,通常为hostname,但不一定非得是hostname,故障发生时,邮件通知会用到</span><br><span class="line">   vrrp_mcast_group4 224.0.0.18     # 同一个组播域，ipv4的默认组播域，如果没有指定这里使用224.0.0.18</span><br><span class="line">   vrrp_mcast_group6 ff02::12       # ipv6多播地址</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="static-ipaddress和static-routes区域"><a href="#static-ipaddress和static-routes区域" class="headerlink" title="static_ipaddress和static_routes区域"></a>static_ipaddress和static_routes区域</h4><p><code>static_ipaddress</code>和<code>static_routes</code>区域配置的是是本节点的<code>IP</code>和路由信息。如果你的机器上已经配置了<code>IP</code>和路由，那么这两个区域可以不用配置。其实，一般情况下你的机器都会有IP地址和路由信息的，因此没必要再在这两个区域配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static_ipaddress &#123;</span><br><span class="line">    10.210.214.163/24 brd 10.210.214.255 dev eth0</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">static_routes &#123;</span><br><span class="line">    10.0.0.0/8 via 10.210.214.1 dev eth0</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="vrrp-instance和vrrp-sync-group区域"><a href="#vrrp-instance和vrrp-sync-group区域" class="headerlink" title="vrrp_instance和vrrp_sync_group区域"></a>vrrp_instance和vrrp_sync_group区域</h4><p><code>vrrp_instance</code>用来定义对外提供服务的VIP区域及其相关属性。</p>
<p><code>vrrp_rsync_group</code>用来定义<code>vrrp_intance</code>组，使得这个组内成员动作一致。举个例子来说明一下其功能：</p>
<ul>
<li>两个<code>vrrp_instance</code>同属于一个<code>vrrp_rsync_group</code>，那么其中一个<code>vrrp_instance</code>发生故障切换时，另一个<code>vrrp_instance</code>也会跟着切换（即使这个<code>instance</code>没有发生故障）。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">vrrp_sync_group VG_1 &#123; </span><br><span class="line">    group &#123;</span><br><span class="line">    VI_1 # name of vrrp_instance (below)</span><br><span class="line">    VI_2 # One for each moveable IP.</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master /path/to_master.sh    # notify_master/backup/fault 分别表示切换为主/备/出错时所执行的脚本。</span><br><span class="line">    notify_backup /path/to_backup.sh</span><br><span class="line">    notify_fault &quot;/path/fault.sh VG_1&quot;</span><br><span class="line">    notify /path/notify.sh          # notify 表示任何一状态切换时都会调用该脚本，并且该脚本在以上三个脚本执行完成之后进行调用，keepalived会自动传递三个参数（$1 = &quot;GROUP&quot;|&quot;INSTANCE&quot;，$2 = name of group or instance，$3 = target state of transition(MASTER/BACKUP/FAULT)）。</span><br><span class="line">    smtp_alert              # smtp_alert 表示是否开启邮件通知（用全局区域的邮件设置来发通知）。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;        # 实例名称     </span><br><span class="line">    state MASTER            # 可以是MASTER或BACKUP，不过当其他节点keepalived启动时会将priority比较大的节点选举为MASTER,因此该项其实没有实质用途。</span><br><span class="line">    interface ens34         # 节点固有IP（非VIP）的网卡，用来发VRRP包做心跳检测 </span><br><span class="line">    virtual_router_id 8     # 虚拟路由ID,取值在0-255之间,用来区分多个instance的VRRP组播,同一网段内ID不能重复;主备必须为一样;</span><br><span class="line">    priority 100            # 用来选举master的,要成为master那么这个选项的值最好高于其他机器,该项取值范围是1-255(在此范围之外会被识别成默认值100)</span><br><span class="line">    lvs_sync_daemon_interface       # 绑定lvs syncd的网卡。</span><br><span class="line">    garp_master_delay       # 当切为主状态后多久更新ARP缓存，默认5秒。</span><br><span class="line">    track_interface         # 监控以下网卡，如果任何一个不通就会切换到FALT状态。（可选项）</span><br><span class="line">    dont_track_primary      # 忽略VRRP网卡错误。（默认未设置）</span><br><span class="line">    advert_int 1            # 检查间隔默认为1秒,即1秒进行一次master选举(可以认为是健康查检时间间隔)</span><br><span class="line">    authentication &#123;        # 认证区域,认证类型有PASS和HA（IPSEC）,推荐使用PASS(密码只识别前8位)</span><br><span class="line">        auth_type PASS      # 认证区域,认证类型有PASS和HA（IPSEC）,推荐使用PASS(密码只识别前8位)</span><br><span class="line">        auth_pass psdfuhg   # PASS认证密码</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.8.8/24 dev ens34 label ens34:0      # 虚拟VIP地址，允许有多个</span><br><span class="line">    &#125; </span><br><span class="line">    </span><br><span class="line">    virtual_routes &#123;        # 虚拟路由，当IP漂过来之后需要添加的路由信息。</span><br><span class="line">        172.16.0.0/12 via 10.210.214.1</span><br><span class="line">        192.168.1.0/24 via 192.168.1.1 dev eth1</span><br><span class="line">        default via 202.102.152.1</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    preempt_delay 300        # 启动多久之后进行接管资源（VIP/Route信息等），并提是没有nopreempt选项。</span><br><span class="line">    </span><br><span class="line">    debug：debug级别</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    notify_master /path/to_master.sh    # notify_master/backup/fault 分别表示切换为主/备/出错时所执行的脚本。</span><br><span class="line">    notify_backup /path/to_backup.sh</span><br><span class="line">    notify_fault &quot;/path/fault.sh VG_1&quot;</span><br><span class="line">    notify /path/notify.sh          # notify 表示任何一状态切换时都会调用该脚本，并且该脚本在以上三个脚本执行完成之后进行调用，keepalived会自动传递三个参数（$1 = &quot;GROUP&quot;|&quot;INSTANCE&quot;，$2 = name of group or instance，$3 = target state of transition(MASTER/BACKUP/FAULT)）。</span><br><span class="line">    smtp_alert              # smtp_alert 表示是否开启邮件通知（用全局区域的邮件设置来发通知）。</span><br><span class="line">    </span><br><span class="line">    nopreempt           # 设置不抢占，允许一个priority比较低的节点作为master，即使有priority更高的节点启动。</span><br><span class="line">    # 首先nopreemt必须在state为BACKUP的节点上才生效（因为是BACKUP节点决定是否来成为MASTER的），</span><br><span class="line">    其次要实现类似于关闭auto failback的功能需要将所有节点的state都设置为BACKUP，或者将master节点的priority设置的比BACKUP低。</span><br><span class="line">    我个人推荐使用将所有节点的state都设置成BACKUP并且都加上nopreempt选项，这样就完成了关于autofailback功能，</span><br><span class="line">    当想手动将某节点切换为MASTER时只需去掉该节点的nopreempt选项并且将priority改的比其他节点大，</span><br><span class="line">    然后重新加载配置文件即可（等MASTER切过来之后再将配置文件改回去再reload一下）。</span><br><span class="line">    </span><br><span class="line">    当使用track_script时可以不用加nopreempt，只需要加上preempt_delay 5，这里的间隔时间要大于vrrp_script中定义的时长。</span><br><span class="line">    </span><br><span class="line">    track interface         # 跟踪接口，设置额外的监控，里面任意一块网卡出现问题，都会进入故障(FAULT)状态，例如，用nginx做均衡器的时候，内网必须正常工作，如果内网出问题了，这个均衡器也就无法运作了，所以必须对内外网同时做健康检查</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="vrrp-script区域"><a href="#vrrp-script区域" class="headerlink" title="vrrp_script区域"></a>vrrp_script区域</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script chk_httpd &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_and_start_httpd.sh&quot;   # apache httpd 服务检测并试图重启</span><br><span class="line">    interval 2                    # 每2s检查一次</span><br><span class="line">    weight -5                     # 检测失败（脚本返回非0）则优先级减少5个值</span><br><span class="line">    fall 3                        # 如果连续失败次数达到此值，则认为服务器已down</span><br><span class="line">    rise 2                        # 如果连续成功次数达到此值，则认为服务器已up</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="virtual-server-group和virtual-server区域"><a href="#virtual-server-group和virtual-server区域" class="headerlink" title="virtual_server_group和virtual_server区域"></a>virtual_server_group和virtual_server区域</h4><p><code>virtual_server_group</code>一般在超大型的LVS中用到，一般<code>LVS</code>用不着这东西，因此不多说。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">virtual_server 192.168.8.8 80 &#123;</span><br><span class="line">    delay_loop 3            # 检查后端服务器的时间间隔（单位秒）</span><br><span class="line">    lb_algo rr              # 后端调试算法（load balancing algorithm）</span><br><span class="line">    lb_kind DR              #  LVS调度类型NAT/DR/TUN。</span><br><span class="line">    protocol TCP            # 服务协议，进支持TCP</span><br><span class="line">    </span><br><span class="line">    sorry_server 127.0.0.1 80       # 当所有real server宕掉时，sorry server顶替</span><br><span class="line">    </span><br><span class="line">    real_server 192.168.8.128 80 &#123;      # real_server 真正提供服务的服务器</span><br><span class="line">        weight 1            # weight 权重</span><br><span class="line">        HTTP_GET | SSL_GET &#123;          # 健康检查的方式，N多种方式</span><br><span class="line">        url &#123;</span><br><span class="line">            path /          # path 请求real serserver上的路径。</span><br><span class="line">            status_code 200 # digest/status_code 分别表示用genhash算出的结果和http状态码</span><br><span class="line">        &#125;   </span><br><span class="line">        connect_ip 192.168.8.128    # 向当前RS的哪个IP地址发起健康状态检测请求</span><br><span class="line">        connect_port 80     # 健康检查，如果端口通则认为服务器正常</span><br><span class="line">        bindto 192.168.8.138    # 发出健康状态检测请求时使用的源地址</span><br><span class="line">        bind_port 12340         # 发出健康状态检测请求时使用的源端口</span><br><span class="line">        connect_timeout     # 超时时长</span><br><span class="line">        nb_get_retry 3      # 重试次数</span><br><span class="line">        delay_before_retyr 1        # 下次重试的时间延迟</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    real_server 192.168.8.136 80 &#123;</span><br><span class="line">            weight 1</span><br><span class="line">            HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">                path /</span><br><span class="line">                status_code 200</span><br><span class="line">            &#125;</span><br><span class="line">            connect_timeout 1</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retyr 1</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    track_script &#123;                # 引用VRRP脚本，即在 vrrp_script 部分指定的名字。定期运行它们来改变优先级，并最终引发主备切换。</span><br><span class="line">        chk_httpd          </span><br><span class="line">    &#125;     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://outofmemory.cn/wiki/keepalived-configuration" target="_blank" rel="noopener">keepalived工作原理和配置说明</a></p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>