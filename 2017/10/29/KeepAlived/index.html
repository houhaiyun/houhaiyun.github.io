<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>Keepalived简介 | Peter's technology stack.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/KeepAlived/">KeepAlived</a></div><div class="post-time">2017-10-29</div></div></div><div class="container post-header"><h1>Keepalived简介</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#官网介绍"><span class="toc-number">1.</span> <span class="toc-text">官网介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#VRRP简介"><span class="toc-number">1.1.</span> <span class="toc-text">VRRP简介</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模块介绍"><span class="toc-number">2.</span> <span class="toc-text">模块介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#架构图"><span class="toc-number">2.1.</span> <span class="toc-text">架构图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#工作原理"><span class="toc-number">3.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#致谢"><span class="toc-number">4.</span> <span class="toc-text">致谢</span></a></li></ol></details></div><div class="container post-content"><center><img src="https://houhaiyun.github.io/img/images/KeepAlived-1.jpg" title="KeepAlived"></center>

<h3 id="官网介绍"><a href="#官网介绍" class="headerlink" title="官网介绍"></a>官网介绍</h3><p><a href="http://www.keepalived.org/" target="_blank" rel="noopener">官网：http://www.keepalived.org/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">What is Keepalived ?</span><br><span class="line">Keepalived is a routing software written in C. The main goal of this project is to provide simple and robust facilities for loadbalancing and high-availability to Linux system and Linux based infrastructures. Loadbalancing framework relies on well-known and widely used Linux Virtual Server (IPVS) kernel module providing Layer4 loadbalancing. Keepalived implements a set of checkers to dynamically and adaptively maintain and manage loadbalanced server pool according their health. On the other hand high-availability is achieved by VRRP protocol. VRRP is a fundamental brick for router failover. In addition, Keepalived implements a set of hooks to the VRRP finite state machine providing low-level and high-speed protocol interactions. Keepalived frameworks can be used independently or all together to provide resilient infrastructures.</span><br><span class="line"></span><br><span class="line">Keepalived is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p><code>Keepalived</code>是用C编写的路由软件。该项目的主要目标是为<code>Linux</code>系统和基于<code>Linux</code>的基础设施提供简单而强大的负载平衡和高可用性设施。 负载平衡框架依赖于众所周知的广泛使用的<code>Linux</code>虚拟服务器（<code>IPVS</code>）内核模块，提供<code>Layer4</code>负载平衡。<code>Keepalived</code>实现了一组检查器，以动态和自适应地维护和管理负载平衡的服务器池，以保证其健康。另一方面<code>VRRP</code>实现了高可用性 协议。<code>VRRP</code>是路由器故障切换的基础。此外，<code>Keepalived</code>实现了一组钩子到<code>VRRP</code>有限状态机，提供低级和高速协议交互。<code>Keepalived</code>框架可以单独使用或全部使用，以提供弹性的基础设施。</p>
<h4 id="VRRP简介"><a href="#VRRP简介" class="headerlink" title="VRRP简介"></a>VRRP简介</h4><p>虚拟路由冗余协议(<code>Virtual Router Redundancy Protocol</code>，简称<code>VRRP</code>)是由<code>IETF</code>提出的解决局域网中配置静态网关出现单点失效现象的路由协议。</p>
<h3 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a>模块介绍</h3><p><code>Keepalived</code>采用是模块化设计，不同模块实现不同的功能，<code>keepalived</code>主要有三个模块，分别是<code>core</code>、<code>check</code>和<code>vrrp</code>。 <code>core</code>：是<code>keepalived</code>的核心，负责主进程的启动和维护，全局配置文件的加载解析等 <code>check</code>： 负责<code>healthchecker</code>(健康检查)，包括了各种健康检查方式，以及对应的配置的解析包括LVS的配置解析；<br>可基于脚本检查对<code>IPVS</code>后端服务器健康状况进行检查。 <code>vrrp</code>：<code>VRRPD</code>子进程，<code>VRRPD</code>子进程就是来实现<code>VRRP</code>协议的</p>
<p>以上是主要组件；下面是其他库： <code>libipfwc</code>：<code>iptables/ipchains</code>库，配置<code>LVS</code>会用到 <code>libipvs*</code>：配置LVS会用到。<br><strong>注意</strong>，<code>keepalived</code>和<code>LVS</code>完全是两码事，各司其职相互配合。</p>
<h4 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h4><center><img src="https://houhaiyun.github.io/img/images/KeepAlived-2.jpg" title="KeepAlived架构图"></center>

<p><code>Keepalived</code>启动后会有三个进程:</p>
<ul>
<li>父进程：内存管理，子进程管理等等</li>
<li>子进程：<code>vrrpd</code>子进程</li>
<li>子进程：<code>healthchecker</code>子进程</li>
</ul>
<p>由上图可知，两个子进程都被系统<code>WatchDog</code>看管，两个子进程各自实现自己的事，<code>healthchecker</code>子进程实现检查各自服务器的健康程度，例如<code>HTTP</code>，<code>LVS</code>等等，如果<code>healthchecker</code>子进程检查到<code>MASTER</code>上服务不可用，就会通知本机上的兄弟<code>VRRP</code>子进程，让他删除通告，并且去掉虚拟<code>IP</code>，转换为<code>BACKUP</code>状态</p>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p><code>keepalived</code>是一个类似于<code>layer3, 4 &amp; 5</code>交换机制的软件，也就是第3层、第4层和第5层交换,分别工作在<code>IP/TCP</code>协议栈的<code>IP层</code>、<code>TCP层</code>、<code>应用层</code>，原理分别如下： <code>Layer3</code>： <code>Keepalived</code>使用<code>Layer3</code>的方式工作式时，<code>Keepalived</code>会定期向服务器群中的服务器发送一个<code>ICMP</code>的数据包（既<code>Ping</code>）,如果发现某台服务的<code>IP</code>地址没有激活，<code>Keepalived</code>便报告这台服务器失效，并将它从服务器群中剔除(这种情况的典型例子是某台服务器被非法关机)。<code>Layer3</code>方式是以服务器的<code>IP</code>地址是否有效作为服务器工作正常与否的标准。 <code>Layer4</code>: <code>Layer4</code>主要以<code>TCP</code>端口的状态来决定服务器工作正常与否。如<code>web server</code>的服务端口一般是<code>80</code>，如果<code>Keepalived</code>检测到<code>80</code>端口没有启动，则<code>Keepalived</code>将把这台服务器从服务器群中剔除。 <code>Layer5</code>： <code>Layer5</code>就是工作在具体的应用层了，比<code>Layer3</code>,<code>Layer4</code>要复杂，在网络上占用的带宽也要大一些。<code>Keepalived</code>将根据用户的设定检查服务器相应服务是否运行正常，如果没有正常运行，则<code>Keepalived</code>将把服务器从服务器群中剔除。</p>
<h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="http://www.userzr.com/57.html" target="_blank" rel="noopener">Keepalived原理</a></p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>