<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>httpd-2.2 实现https | Keep learn!</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Apache/">Apache</a></div><div class="post-time">2017-10-09</div></div></div><div class="container post-header"><h1>httpd-2.2 实现https</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#主要步骤"><span class="toc-number">1.</span> <span class="toc-text">主要步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-安装mod-ssl模块，使其支持ssl"><span class="toc-number">2.</span> <span class="toc-text">1. 安装mod_ssl模块，使其支持ssl</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#直接访问测试"><span class="toc-number">2.1.</span> <span class="toc-text">直接访问测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#问题如下"><span class="toc-number">2.2.</span> <span class="toc-text">问题如下</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-为服务器申请数字证书"><span class="toc-number">3.</span> <span class="toc-text">2. 为服务器申请数字证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建私有CA"><span class="toc-number">3.1.</span> <span class="toc-text">创建私有CA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在服务器创建证书签署请求"><span class="toc-number">3.2.</span> <span class="toc-text">在服务器创建证书签署请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CA签证"><span class="toc-number">3.3.</span> <span class="toc-text">CA签证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取证书"><span class="toc-number">3.4.</span> <span class="toc-text">获取证书</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-搭建DNS"><span class="toc-number">4.</span> <span class="toc-text">3. 搭建DNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-修改配置文件"><span class="toc-number">5.</span> <span class="toc-text">4. 修改配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-测试"><span class="toc-number">6.</span> <span class="toc-text">5. 测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#直接访问测试-1"><span class="toc-number">6.1.</span> <span class="toc-text">直接访问测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#将根证书导入到测试客户端中"><span class="toc-number">6.2.</span> <span class="toc-text">将根证书导入到测试客户端中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#再次测试"><span class="toc-number">6.3.</span> <span class="toc-text">再次测试</span></a></li></ol></li></ol></details></div><div class="container post-content"><center><img src="https://houhaiyun.github.io/img/images/Httpd-https-1.jpg" title="https"></center>

<a id="more"></a>
<h3 id="主要步骤"><a href="#主要步骤" class="headerlink" title="主要步骤"></a>主要步骤</h3><ol>
<li>安装mod_ssl模块，使其支持ssl</li>
<li>为服务器申请数字证书<ul>
<li>创建私有CA</li>
<li>在服务器创建证书签署请求</li>
<li>CA签证</li>
</ul>
</li>
<li>搭建DNS</li>
<li>修改配置文件</li>
<li>测试基于https访问响应的主机</li>
</ol>
<h3 id="1-安装mod-ssl模块，使其支持ssl"><a href="#1-安装mod-ssl模块，使其支持ssl" class="headerlink" title="1. 安装mod_ssl模块，使其支持ssl"></a>1. 安装mod_ssl模块，使其支持ssl</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# yum install -y mod_ssl</span><br><span class="line">[root@centos6 ~]# rpm -ql mod_ssl       # 生成了以下文件</span><br><span class="line">/etc/httpd/conf.d/ssl.conf              # 新生成的配置文件</span><br><span class="line">/usr/lib64/httpd/modules/mod_ssl.so</span><br><span class="line">/var/cache/mod_ssl</span><br><span class="line">/var/cache/mod_ssl/scache.dir</span><br><span class="line">/var/cache/mod_ssl/scache.pag</span><br><span class="line">/var/cache/mod_ssl/scache.sem</span><br><span class="line"></span><br><span class="line">[root@centos6 ~]# service httpd reload          # 重新加载配置文件</span><br><span class="line">Reloading httpd:</span><br></pre></td></tr></table></figure>
<h4 id="直接访问测试"><a href="#直接访问测试" class="headerlink" title="直接访问测试"></a>直接访问测试</h4><p>现在我们已经可以访问了，还有两个问题：站点还未被信任和证书并不是自己的。</p>
<center><img src="https://houhaiyun.github.io/img/images/Httpd-https-2.gif" title="测试访问"></center>

<h4 id="问题如下"><a href="#问题如下" class="headerlink" title="问题如下"></a>问题如下</h4><center><img src="https://houhaiyun.github.io/img/images/Httpd-https-3.jpg" title="问题"></center>

<h3 id="2-为服务器申请数字证书"><a href="#2-为服务器申请数字证书" class="headerlink" title="2. 为服务器申请数字证书"></a>2. 为服务器申请数字证书</h3><h4 id="创建私有CA"><a href="#创建私有CA" class="headerlink" title="创建私有CA"></a>创建私有CA</h4><p><a href="http://blog.csdn.net/hai__yun/article/details/77921134" target="_blank" rel="noopener">关于创建私有CA，可以参考我的另外一篇博客</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# touch /etc/pki/CA/index.txt</span><br><span class="line">[root@centos7 ~]# echo 01 &gt; /etc/pki/CA/serial</span><br><span class="line">[root@centos7 ~]# cd /etc/pki/CA/</span><br><span class="line">[root@centos7 CA]# (umask 066 ; openssl genrsa -out /etc/pki/CA/private/cakey.pem 2048)</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">...................+++</span><br><span class="line">.....................................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">[root@centos7 CA]# openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -days 7300 -out /etc/pki/CA/cacert.pem</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:hlg</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:ihaiyun.com</span><br><span class="line">Organizational Unit Name (eg, section) []:opt</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:ca.ihaiyun.com</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure></p>
<h4 id="在服务器创建证书签署请求"><a href="#在服务器创建证书签署请求" class="headerlink" title="在服务器创建证书签署请求"></a>在服务器创建证书签署请求</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# (umask 066 ; openssl genrsa -out /etc/pki/tls/private/test.key 2048)</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">..........................................................+++</span><br><span class="line">.............................................................................................................................................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">[root@centos6 ~]# openssl req -new -key /etc/pki/tls/private/test.key -days 365 -out /etc/pki/tls/test.csr</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:beijing</span><br><span class="line">Locality Name (eg, city) [Default City]:caoyang</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:ihaiyun.com</span><br><span class="line">Organizational Unit Name (eg, section) []:opt</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:www.ihaiyun.com</span><br><span class="line">Email Address []:</span><br><span class="line"></span><br><span class="line">Please enter the following &apos;extra&apos; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br><span class="line">[root@centos6 tls]# scp test.csr 192.168.8.135:/etc/pki/CA</span><br><span class="line">root@192.168.8.135&apos;s password: </span><br><span class="line">test.csr                                                       100% 1029     1.0KB/s   00:00</span><br></pre></td></tr></table></figure>
<h4 id="CA签证"><a href="#CA签证" class="headerlink" title="CA签证"></a>CA签证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 CA]# openssl ca -in /etc/pki/CA/test.csr -out /etc/pki/CA/certs/test.crt  </span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">Certificate Details:</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Oct  9 01:18:33 2017 GMT</span><br><span class="line">            Not After : Oct  9 01:18:33 2018 GMT</span><br><span class="line">        Subject:</span><br><span class="line">            countryName               = CN</span><br><span class="line">            stateOrProvinceName       = beijing</span><br><span class="line">            organizationName          = ihaiyun.com</span><br><span class="line">            organizationalUnitName    = www.ihaiyun.com</span><br><span class="line">            commonName                = www.ihaiyun.com</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints: </span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment: </span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                A6:59:85:90:9D:84:C4:80:6B:27:E2:A2:57:44:58:FA:69:64:CB:00</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                keyid:43:65:C5:B5:03:8E:E9:2E:82:C9:0D:5F:87:72:2D:F1:81:5F:FB:CE</span><br><span class="line"></span><br><span class="line">Certificate is to be certified until Oct  9 01:18:33 2018 GMT (365 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure>
<h4 id="获取证书"><a href="#获取证书" class="headerlink" title="获取证书"></a>获取证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# mkdir /etc/httpd/ssl          # 新建目录用来存放证书文件</span><br><span class="line">[root@centos7 CA]# scp certs/test.crt 192.168.8.128:/etc/httpd/ssl          # 将证书发送到192.168.8.128</span><br><span class="line">root@192.168.8.128&apos;s password: </span><br><span class="line">test.crt                                                       100% 4507     4.4KB/s   00:00 </span><br><span class="line">[root@centos7 CA]# scp cacert.pem 192.168.8.128:/etc/httpd/ssl              # 将根的证书发送给192.168.8.128</span><br><span class="line">root@192.168.8.128&apos;s password: </span><br><span class="line">cacert.pem                                                     100% 1326     1.3KB/s   00:00</span><br></pre></td></tr></table></figure>
<h3 id="3-搭建DNS"><a href="#3-搭建DNS" class="headerlink" title="3. 搭建DNS"></a>3. 搭建DNS</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# vim /etc/named.conf </span><br><span class="line">options &#123;</span><br><span class="line">//  listen-on port 53 &#123; 127.0.0.1; &#125;;</span><br><span class="line">    listen-on-v6 port 53 &#123; ::1; &#125;;</span><br><span class="line">    directory   &quot;/var/named&quot;;</span><br><span class="line">    dump-file   &quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">    statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">    memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">//  allow-query     &#123; localhost; &#125;;</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# tail -5 /etc/named.rfc1912.zones </span><br><span class="line">zone &quot;ihaiyun.com&quot; IN &#123;</span><br><span class="line">	type master;</span><br><span class="line">	file &quot;ihaiyun.com.zone&quot;;</span><br><span class="line">	allow-update &#123; none; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]# cp -p /var/named/named.localhost /var/named/ihaiyun.com.zone</span><br><span class="line">[root@centos7 ~]# cat /var/named/ihaiyun.com.zone </span><br><span class="line">$TTL 1D</span><br><span class="line">@	IN SOA	dns1 admin.ihaiyun.com. (</span><br><span class="line">					0	; serial</span><br><span class="line">					1D	; refresh</span><br><span class="line">					1H	; retry</span><br><span class="line">					1W	; expire</span><br><span class="line">					3H )	; minimum</span><br><span class="line">	NS	dns1</span><br><span class="line">dns1 A	192.168.8.135</span><br><span class="line">www	 A	192.168.8.128</span><br></pre></td></tr></table></figure>
<h3 id="4-修改配置文件"><a href="#4-修改配置文件" class="headerlink" title="4. 修改配置文件"></a>4. 修改配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]# cp /etc/pki/tls/private/test.key /etc/httpd/ssl/          # 将key文件cp到/etc/httpd/ssl目录下方便管理</span><br><span class="line">[root@centos6 ~]# vim /etc/httpd/conf.d/ssl.conf</span><br><span class="line">SSLCertificateFile /etc/httpd/ssl/test.crt</span><br><span class="line">SSLCertificateKeyFile /etc/httpd/ssl/test.key</span><br><span class="line">SSLCACertificateFile /etc/httpd/ssl/cacert.pem</span><br><span class="line">[root@centos6 ~]# service httpd restart</span><br><span class="line">Stopping httpd:                                            [  OK  ]</span><br><span class="line">Starting httpd:                                            [  OK  ]</span><br></pre></td></tr></table></figure>
<h3 id="5-测试"><a href="#5-测试" class="headerlink" title="5. 测试"></a>5. 测试</h3><h4 id="直接访问测试-1"><a href="#直接访问测试-1" class="headerlink" title="直接访问测试"></a>直接访问测试</h4><p>还是提醒我们证书不安全</p>
<center><img src="https://houhaiyun.github.io/img/images/Httpd-https-4.gif" title="访问测试"></center>

<h4 id="将根证书导入到测试客户端中"><a href="#将根证书导入到测试客户端中" class="headerlink" title="将根证书导入到测试客户端中"></a>将根证书导入到测试客户端中</h4><p>需要把根证书下载到客户端中，具体怎么下载，相信你们会有办法。导入方法如下：</p>
<center><img src="https://houhaiyun.github.io/img/images/Httpd-https-5.gif" title="将根证书导入到测试客户端中"></center>

<h4 id="再次测试"><a href="#再次测试" class="headerlink" title="再次测试"></a>再次测试</h4><center><img src="https://houhaiyun.github.io/img/images/Httpd-https-6.gif" title="再次测试"></center>

<p>https已经实现!</p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>