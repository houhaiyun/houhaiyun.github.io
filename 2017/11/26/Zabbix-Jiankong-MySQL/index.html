<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>Zabbix：监控MySQL | Keep learn!</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Zabbix/">Zabbix</a></div><div class="post-time">2017-11-26</div></div></div><div class="container post-header"><h1>Zabbix：监控MySQL</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#概述"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Percona组成介绍"><span class="toc-number">2.</span> <span class="toc-text">Percona组成介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装数据库"><span class="toc-number">3.</span> <span class="toc-text">安装数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装步骤"><span class="toc-number">4.</span> <span class="toc-text">安装步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装模板"><span class="toc-number">4.1.</span> <span class="toc-text">安装模板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#将模板文件下载到本地"><span class="toc-number">4.2.</span> <span class="toc-text">将模板文件下载到本地</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#导入模板文件"><span class="toc-number">4.3.</span> <span class="toc-text">导入模板文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#复制配置文件"><span class="toc-number">4.4.</span> <span class="toc-text">复制配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建php文件"><span class="toc-number">4.5.</span> <span class="toc-text">创建php文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试"><span class="toc-number">4.6.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zabbix-Web界面配置"><span class="toc-number">5.</span> <span class="toc-text">Zabbix-Web界面配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#授权-tmp下的一个文件"><span class="toc-number">5.1.</span> <span class="toc-text">授权/tmp下的一个文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看监控值"><span class="toc-number">6.</span> <span class="toc-text">查看监控值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#致谢"><span class="toc-number">7.</span> <span class="toc-text">致谢</span></a></li></ol></details></div><div class="container post-content"><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p><code>zabbix</code>自带了一个监控<code>mysql</code>的模板，但是真正监控<code>mysql</code>的并不是<code>zabbix</code>自带的模板。而是<code>percona</code>公司的一个监控<code>mysql</code>模板</p>
<p><a href="www.percona.com">percona官网： www.percona.com</a></p>
<a id="more"></a>
<h3 id="Percona组成介绍"><a href="#Percona组成介绍" class="headerlink" title="Percona组成介绍"></a>Percona组成介绍</h3><ul>
<li>1、<code>php</code>脚本    用来数据采集</li>
<li>2、<code>shell</code>脚本  用来调用采集信息</li>
<li>3、<code>zabbix</code>配置文件</li>
<li>4、<code>zabbix</code>模板文件</li>
</ul>
<p><a href="https://www.percona.com/doc/percona-monitoring-plugins/LATEST/zabbix/index.html" target="_blank" rel="noopener">官方安装文档：https://www.percona.com/doc/percona-monitoring-plugins/LATEST/zabbix/index.html</a></p>
<p><code>percona</code> 利用的是<code>php</code>来获取<code>mysql</code>的相关信息，所以如果我们想使用<code>percona</code>插件监控<code>mysql</code>就需要在<code>agent</code>端安装<code>php</code>。在安装文档上有写哦~</p>
<center><img src="https://houhaiyun.github.io/img/images/Zabbix-Jiankong-MySQL-1.jpg" title="percona官网"></center>

<h3 id="安装数据库"><a href="#安装数据库" class="headerlink" title="安装数据库"></a>安装数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-client1 ~]# yum install mariadb-server </span><br><span class="line">[root@zabbix-client1 ~]# mysql</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 95</span><br><span class="line">Server version: 5.5.52-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; Bye</span><br></pre></td></tr></table></figure>
<h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><p>查看上面的官网安装文档也可以进行安装</p>
<h4 id="安装模板"><a href="#安装模板" class="headerlink" title="安装模板"></a>安装模板</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-client1 ~]# yum -y install http://www.percona.com/downloads/percona-release/redhat/0.1-3/percona-release-0.1-3.noarch.rpm</span><br><span class="line">[root@zabbix-client1 ~]# yum -y  install percona-zabbix-templates php php-mysql      # percona插件是通过php去获取mysql的参数，所以我们要安装php和php-mysql；</span><br><span class="line">[root@zabbix-client1 ~]# yum -y  install percona-zabbix-templates php php-mysql </span><br><span class="line"></span><br><span class="line">[root@zabbix-client1 ~]# rpm -ql percona-zabbix-templates        # 查看安装后生成的文件；</span><br><span class="line">/var/lib/zabbix/percona</span><br><span class="line">/var/lib/zabbix/percona/scripts</span><br><span class="line">/var/lib/zabbix/percona/scripts/get_mysql_stats_wrapper.sh      # shell脚本；</span><br><span class="line">/var/lib/zabbix/percona/scripts/ss_get_mysql_stats.php          # php获取mysql信息；</span><br><span class="line">/var/lib/zabbix/percona/templates</span><br><span class="line">/var/lib/zabbix/percona/templates/userparameter_percona_mysql.conf      # zabbix配置文件；</span><br><span class="line">/var/lib/zabbix/percona/templates/zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.7.xml     # zabbix模板文件；</span><br><span class="line">/var/lib/zabbix/percona/templates/zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.7.xml     # zabbix模板文件；</span><br></pre></td></tr></table></figure>
<h4 id="将模板文件下载到本地"><a href="#将模板文件下载到本地" class="headerlink" title="将模板文件下载到本地"></a>将模板文件下载到本地</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-client1 ~]# sz /var/lib/zabbix/percona/templates/zabbix_agent_template_percona_mysql_server_ht_2.0.9-sver1.1.7.xml</span><br></pre></td></tr></table></figure>
<h4 id="导入模板文件"><a href="#导入模板文件" class="headerlink" title="导入模板文件"></a>导入模板文件</h4><p>然后我们需要将模板通过<code>web</code>界面导入到<code>zabbix</code>中 </p>
<center><img src="https://houhaiyun.github.io/img/images/Zabbix-Jiankong-MySQL-2.jpg" title="导入模板文件"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Jiankong-MySQL-3.jpg" title="导入模板文件"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Jiankong-MySQL-4.jpg" title="导入模板文件"></center>

<p><strong>提示</strong>：如果出现错误，可能是<code>zabbix 3.0</code>版本的问题。我们这里提供了一个生产的模板 </p>
<p><a href="http://pan.baidu.com/s/1qX8RfFQ" target="_blank" rel="noopener">链接：http://pan.baidu.com/s/1qX8RfFQ 密码：z2sj</a></p>
<p>然后重新上传即可</p>
<h4 id="复制配置文件"><a href="#复制配置文件" class="headerlink" title="复制配置文件"></a>复制配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-client1 ~]# cp /var/lib/zabbix/percona/templates/userparameter_percona_mysql.conf /etc/zabbix/zabbix_agentd.d/</span><br><span class="line">[root@zabbix-client1 ~]# ls /etc/zabbix/zabbix_agentd.d/        # 安装完软件包后会在/var/lib/zabbix/percona/templates/目录下产生一个配置文件，我们将它拷贝，因为在zabbix的配置文件中定义了Include=/etc/zabbix/zabbix_agentd.d/*.conf只有在此路径才能生效；</span><br><span class="line">userparameter_mem.conf  userparameter_mysql.conf  userparameter_percona_mysql.conf</span><br></pre></td></tr></table></figure>
<h4 id="创建php文件"><a href="#创建php文件" class="headerlink" title="创建php文件"></a>创建php文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-client1 ~]# cat /var/lib/zabbix/percona/scripts/ss_get_mysql_stats.php.cnf </span><br><span class="line">&lt;?php</span><br><span class="line">$mysql_user = &apos;root&apos;;</span><br><span class="line">$mysql_pass = &apos;&apos;;</span><br><span class="line">?&gt;</span><br><span class="line"># 用户名密码可以自己创建，有密码写密码，没密码为空就好了；</span><br></pre></td></tr></table></figure>
<p><strong>提示</strong>： 正常这里的用户我们应该创建一个专门用来监控的，由于我这里是测试环境。就不浪费时间了</p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-client1 ~]#  cat /var/lib/zabbix/percona/templates/userparameter_percona_mysql.conf    # 选择一个肯定有值的key；</span><br><span class="line">[root@zabbix-client1 ~]# cat /var/lib/zabbix/percona/templates/userparameter_percona_mysql.conf|grep gm</span><br><span class="line">UserParameter=MySQL.read-views,/var/lib/zabbix/percona/scripts/get_mysql_stats_wrapper.sh gm</span><br><span class="line"></span><br><span class="line"># 测试结果如下：</span><br><span class="line">[root@zabbix-client1 ~]# cd /var/lib/zabbix/percona/scripts/</span><br><span class="line">[root@zabbix-client1 scripts]# ./get_mysql_stats_wrapper.sh gm</span><br><span class="line">1</span><br><span class="line">[root@zabbix-client1 scripts]# ./get_mysql_stats_wrapper.sh gw</span><br><span class="line">317</span><br></pre></td></tr></table></figure>
<p><strong>温馨提示</strong>： shell脚本中数据库的路径是localhost，如果我们没有授权localhost会获取不到值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 scripts]# cat get_mysql_stats_wrapper.sh </span><br><span class="line">HOST=localhost</span><br><span class="line">    RES=`HOME=~zabbix mysql -e &apos;SHOW SLAVE STATUS\G&apos; | egrep &apos;(Slave_IO_Running|Slave_SQL_Running):&apos; | awk -F: &apos;&#123;print $2&#125;&apos; | tr &apos;\n&apos; &apos;,&apos;`</span><br><span class="line"># mysql是通过命令来获取的，如果环境变量不一样 也可能造成影响</span><br></pre></td></tr></table></figure>
<h3 id="Zabbix-Web界面配置"><a href="#Zabbix-Web界面配置" class="headerlink" title="Zabbix-Web界面配置"></a>Zabbix-Web界面配置</h3><p>模板已经上传到<code>zabbix</code>中，这时候我们就需要进行设置了 </p>
<center><img src="https://houhaiyun.github.io/img/images/Zabbix-Jiankong-MySQL-5.jpg" title="Zabbix-Web界面配置"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Jiankong-MySQL-6.jpg" title="Zabbix-Web界面配置"></center>

<h4 id="授权-tmp下的一个文件"><a href="#授权-tmp下的一个文件" class="headerlink" title="授权/tmp下的一个文件"></a>授权/tmp下的一个文件</h4><p><strong>提示</strong>： 我们还需要授权/tmp下的一个文件，因为默认情况下 zabbix在文件中获取的值 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-server ~]# zabbix_get -s 192.168.8.15 -k &quot;MySQL.max-connections&quot;       # 直接测试是会失败的；</span><br><span class="line">rm: cannot remove ‘/tmp/localhost-mysql_cacti_stats.txt’: Operation not permitted</span><br><span class="line">151         </span><br><span class="line">[root@zabbix-client1 ~]# ll /tmp/localhost-mysql_cacti_stats.txt</span><br><span class="line">-rw-rw-r-- 1 root root 1228 Nov 26 21:27 /tmp/localhost-mysql_cacti_stats.txt</span><br><span class="line">[root@zabbix-client1 ~]# chown zabbix.zabbix /tmp/localhost-mysql_cacti_stats.txt</span><br><span class="line">[root@zabbix-client1 ~]# ll /tmp/localhost-mysql_cacti_stats.txt</span><br><span class="line">-rw-rw-r-- 1 zabbix zabbix 1228 Nov 26 21:27 /tmp/localhost-mysql_cacti_stats.txt</span><br><span class="line"></span><br><span class="line">[root@zabbix-server ~]# zabbix_get -s 192.168.8.15 -k &quot;MySQL.max-connections&quot;       # 再次测试，ok；</span><br><span class="line">151</span><br></pre></td></tr></table></figure>
<h3 id="查看监控值"><a href="#查看监控值" class="headerlink" title="查看监控值"></a>查看监控值</h3><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Jiankong-MySQL-7.jpg" title="查看监控值"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Jiankong-MySQL-8.gif" title="查看监控值"></center>


<h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://www.abcdocker.com/abcdocker/1498" target="_blank" rel="noopener">Zabbix 3.0 监控MySQL https://www.abcdocker.com/abcdocker/1498</a></p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>