<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>Zabbix：实现新版微信告警 | Peter's technology stack.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Zabbix/">Zabbix</a></div><div class="post-time">2017-11-27</div></div></div><div class="container post-header"><h1>Zabbix：实现新版微信告警</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#微信企业号申请"><span class="toc-number">1.</span> <span class="toc-text">微信企业号申请</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置微信企业号"><span class="toc-number">2.</span> <span class="toc-text">配置微信企业号</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#记录CorpID"><span class="toc-number">2.1.</span> <span class="toc-text">记录CorpID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建新应用"><span class="toc-number">2.2.</span> <span class="toc-text">创建新应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#需要得到的信息"><span class="toc-number">2.3.</span> <span class="toc-text">需要得到的信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注意事项"><span class="toc-number">2.4.</span> <span class="toc-text">注意事项</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zabbix-server配置"><span class="toc-number">3.</span> <span class="toc-text">Zabbix-server配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#设置Zabbix默认脚本路径"><span class="toc-number">3.1.</span> <span class="toc-text">设置Zabbix默认脚本路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设置脚本"><span class="toc-number">3.2.</span> <span class="toc-text">设置脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#下载脚本"><span class="toc-number">3.2.1.</span> <span class="toc-text">下载脚本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#调试脚本"><span class="toc-number">3.2.2.</span> <span class="toc-text">调试脚本</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Zabbix-界面配置"><span class="toc-number">3.3.</span> <span class="toc-text">Zabbix 界面配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#创建报警媒介"><span class="toc-number">3.3.1.</span> <span class="toc-text">创建报警媒介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建报警用户"><span class="toc-number">3.3.2.</span> <span class="toc-text">创建报警用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#创建报警动作"><span class="toc-number">3.3.3.</span> <span class="toc-text">创建报警动作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试报警"><span class="toc-number">4.</span> <span class="toc-text">测试报警</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#停止Nginx服务"><span class="toc-number">4.1.</span> <span class="toc-text">停止Nginx服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#恢复Nginx服务"><span class="toc-number">4.2.</span> <span class="toc-text">恢复Nginx服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#致谢"><span class="toc-number">5.</span> <span class="toc-text">致谢</span></a></li></ol></details></div><div class="container post-content"><h3 id="微信企业号申请"><a href="#微信企业号申请" class="headerlink" title="微信企业号申请"></a>微信企业号申请</h3><p><a href="http://work.weixin.qq.com/" target="_blank" rel="noopener">地址：http://work.weixin.qq.com/</a></p>
<a id="more"></a>
<center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-1.jpg" title="微信企业号申请"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-2.jpg" title="微信企业号申请"></center>


<h3 id="配置微信企业号"><a href="#配置微信企业号" class="headerlink" title="配置微信企业号"></a>配置微信企业号</h3><h4 id="记录CorpID"><a href="#记录CorpID" class="headerlink" title="记录CorpID"></a>记录CorpID</h4><p>我们需要记录<code>CorpID</code></p>
<center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-3.jpg" title="我们需要记录`CorpID`"></center>

<h4 id="创建新应用"><a href="#创建新应用" class="headerlink" title="创建新应用"></a>创建新应用</h4><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-4.jpg" title="创建新应用"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-5.jpg" title="创建新应用"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-6.jpg" title="创建新应用"></center>


<h4 id="需要得到的信息"><a href="#需要得到的信息" class="headerlink" title="需要得到的信息"></a>需要得到的信息</h4><p>记录用户的账号、<code>CorpID</code>和<code>Secret</code>、<code>Agentld</code></p>
<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul>
<li>企业号已经被部门成员关注</li>
<li>企业号有一个可以发送消息的应用，一个授权管理员，可以使应用成员发消息</li>
<li>此处我们并于设置成员、部门，大家可以根据自己的需求来设定</li>
</ul>
<h3 id="Zabbix-server配置"><a href="#Zabbix-server配置" class="headerlink" title="Zabbix-server配置"></a>Zabbix-server配置</h3><h4 id="设置Zabbix默认脚本路径"><a href="#设置Zabbix默认脚本路径" class="headerlink" title="设置Zabbix默认脚本路径"></a>设置Zabbix默认脚本路径</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-server ~]# grep -i  &quot;AlertScriptsPath&quot; /etc/zabbix/zabbix_server.conf</span><br><span class="line">### Option: AlertScriptsPath</span><br><span class="line"># AlertScriptsPath=$&#123;datadir&#125;/zabbix/alertscripts</span><br><span class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts       # 脚本默认路径；</span><br></pre></td></tr></table></figure>
<h4 id="设置脚本"><a href="#设置脚本" class="headerlink" title="设置脚本"></a>设置脚本</h4><h5 id="下载脚本"><a href="#下载脚本" class="headerlink" title="下载脚本"></a>下载脚本</h5><p><a href="https://pan.baidu.com/s/1o7Lg6nC" target="_blank" rel="noopener">链接: https://pan.baidu.com/s/1o7Lg6nC 密码: csqc</a></p>
<h5 id="调试脚本"><a href="#调试脚本" class="headerlink" title="调试脚本"></a>调试脚本</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-server ~]# cd /usr/lib/zabbix/alertscripts         </span><br><span class="line">[root@zabbix-server alertscripts]# ls       # 已经把脚本上传到/usr/lib/zabbix/alertscripts；</span><br><span class="line">wechat</span><br><span class="line">[root@zabbix-server alertscripts]# chmod +x wechat      # 添加执行权限；</span><br><span class="line">[root@zabbix-server alertscripts]# chown zabbix.zabbix wechat       # 设置属主和属组；</span><br><span class="line">[root@zabbix-server alertscripts]# ll wechat        # 查看权限；</span><br><span class="line">-rwxr-xr-x 1 zabbix zabbix 3579488 Nov 26 11:11 wechat</span><br><span class="line"></span><br><span class="line">[root@zabbix-server alertscripts]# ./wechat --corpid=haiyunabcwwwwwwww --corpsecret=aHHVhGaTDznOTp4xfcck1F4uJixxP_nD4B9N2AyJOt4 --msg=&quot;您好，Zabbix测试&quot; --user=HouHaiYun --agentid=1000002       # 测试；</span><br><span class="line">&#123;&quot;errcode&quot;:0,&quot;errmsg&quot;:&quot;ok&quot;,&quot;invaliduser&quot;:&quot;&quot;&#125;</span><br><span class="line"></span><br><span class="line">提示：</span><br><span class="line">--corpid= 我们企业里面的id</span><br><span class="line">--corpsecret= 这里就是我们Secret里面的id</span><br><span class="line">-msg= 内容</span><br><span class="line">-user=我们邀请用户的账号</span><br><span class="line">因为脚本是编译过的，无法进行编辑，我们可以使用./wechat -h or --help 查看</span><br></pre></td></tr></table></figure>
<center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-7.png" title="调试脚本"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-8.png" title="调试脚本"></center>

<h4 id="Zabbix-界面配置"><a href="#Zabbix-界面配置" class="headerlink" title="Zabbix 界面配置"></a>Zabbix 界面配置</h4><h5 id="创建报警媒介"><a href="#创建报警媒介" class="headerlink" title="创建报警媒介"></a>创建报警媒介</h5><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-9.jpg" title="创建报警媒介"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-10.jpg" title="创建报警媒介"></center>

<h5 id="创建报警用户"><a href="#创建报警用户" class="headerlink" title="创建报警用户"></a>创建报警用户</h5><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-11.jpg" title="创建报警用户"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-12.jpg" title="创建报警用户"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-13.jpg" title="创建报警用户"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-15.jpg" title="创建报警用户"></center>

<h5 id="创建报警动作"><a href="#创建报警动作" class="headerlink" title="创建报警动作"></a>创建报警动作</h5><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-14.jpg" title="创建报警动作"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-16.jpg" title="创建报警动作"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-17.jpg" title="创建报警动作"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-18.jpg" title="创建报警动作"></center>


<blockquote>
<p><strong>提示： 不要忘记先点小的add–&gt;小的update–&gt;Update</strong></p>
</blockquote>
<h3 id="测试报警"><a href="#测试报警" class="headerlink" title="测试报警"></a>测试报警</h3><h4 id="停止Nginx服务"><a href="#停止Nginx服务" class="headerlink" title="停止Nginx服务"></a>停止Nginx服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-client1 ~]# systemctl stop nginx</span><br></pre></td></tr></table></figure>
<center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-19.gif" title="测试报警"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-20.png" title="测试报警"></center>

<h4 id="恢复Nginx服务"><a href="#恢复Nginx服务" class="headerlink" title="恢复Nginx服务"></a>恢复Nginx服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix-client1 ~]# systemctl start nginx</span><br></pre></td></tr></table></figure>
<center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-21.gif" title="测试报警"></center><br><center><img src="https://houhaiyun.github.io/img/images/Zabbix-Wechat-Baojing-22.png" title="测试报警"></center>


<h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p><a href="https://www.abcdocker.com/abcdocker/2573" target="_blank" rel="noopener">Zabbix 新版微信告警：https://www.abcdocker.com/abcdocker/2573</a></p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>