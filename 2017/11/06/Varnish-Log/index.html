<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>Varnish日志 | Keep learn!</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Varnish/">Varnish</a></div><div class="post-time">2017-11-06</div></div></div><div class="container post-header"><h1>Varnish日志</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Varnishlog"><span class="toc-number">1.</span> <span class="toc-text">Varnishlog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#varnishtop-日志条目实时排序"><span class="toc-number">2.</span> <span class="toc-text">varnishtop: 日志条目实时排序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#直接使用varnishtop"><span class="toc-number">2.1.</span> <span class="toc-text">直接使用varnishtop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看特定标签的排序"><span class="toc-number">2.2.</span> <span class="toc-text">查看特定标签的排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看除了某标签的排序"><span class="toc-number">2.3.</span> <span class="toc-text">查看除了某标签的排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看特定的多个标签"><span class="toc-number">2.4.</span> <span class="toc-text">查看特定的多个标签</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基于正则表达式过滤"><span class="toc-number">2.5.</span> <span class="toc-text">基于正则表达式过滤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#varnishncsa-显示combined格式日志信息"><span class="toc-number">3.</span> <span class="toc-text">varnishncsa: 显示combined格式日志信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#将日志记录到本地"><span class="toc-number">3.1.</span> <span class="toc-text">将日志记录到本地</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#varnishstat-显示计数器信息"><span class="toc-number">4.</span> <span class="toc-text">varnishstat: 显示计数器信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#直接执行varnishstat"><span class="toc-number">4.1.</span> <span class="toc-text">直接执行varnishstat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看特定某字段"><span class="toc-number">4.2.</span> <span class="toc-text">查看特定某字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看多个字段"><span class="toc-number">4.3.</span> <span class="toc-text">查看多个字段</span></a></li></ol></li></ol></details></div><div class="container post-content"><h3 id="Varnishlog"><a href="#Varnishlog" class="headerlink" title="Varnishlog"></a>Varnishlog</h3><p><code>varnishlog</code>：显示原始日志格式信息</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">[root@Varnish ~]# varnishlog </span><br><span class="line">*   &lt;&lt; BeReq    &gt;&gt; 3         </span><br><span class="line">-   Begin          bereq 2 pass</span><br><span class="line">-   Timestamp      Start: 1509976549.796530 0.000000 0.000000</span><br><span class="line">-   BereqMethod    GET</span><br><span class="line">-   BereqURL       /login/</span><br><span class="line">-   BereqProtocol  HTTP/1.1</span><br><span class="line">-   BereqHeader    Host: 192.168.8.12</span><br><span class="line">-   BereqHeader    Cache-Control: max-age=0</span><br><span class="line">-   BereqHeader    Upgrade-Insecure-Requests: 1</span><br><span class="line">-   BereqHeader    User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.79 Safari/537.36</span><br><span class="line">-   BereqHeader    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">-   BereqHeader    Accept-Encoding: gzip, deflate</span><br><span class="line">-   BereqHeader    Accept-Language: zh-CN,zh;q=0.8</span><br><span class="line">-   BereqHeader    Cookie: solo=732e32b4c3cbba398e9012784ab5b73c476497082ae9da4fece6802005aa95e7b56437ec3b4f64a6f3f8d84903ae067826d5036728270b7ce8a3136e6427a59888a534443b2723cf1a379f2a83216b0a7992966869df4284f600c6be73056c528b6a93e20c50dda63b7d8eaecac3b4e8</span><br><span class="line">-   BereqHeader    If-None-Match: &quot;134-b-55d4f270ba01d&quot;</span><br><span class="line">-   BereqHeader    If-Modified-Since: Mon, 06 Nov 2017 11:57:02 GMT</span><br><span class="line">-   BereqHeader    X-Forwarded-For: 192.168.8.1</span><br><span class="line">-   BereqHeader    X-Varnish: 3</span><br><span class="line">-   VCL_call       BACKEND_FETCH</span><br><span class="line">-   VCL_return     fetch</span><br><span class="line">-   BackendOpen    21 srv1(192.168.8.11,,80) 192.168.8.12 54160 </span><br><span class="line">-   Backend        21 srvs srv1(192.168.8.11,,80)</span><br><span class="line">-   Timestamp      Bereq: 1509976549.797146 0.000617 0.000617</span><br><span class="line">-   Timestamp      Beresp: 1509976549.797757 0.001227 0.000611</span><br><span class="line">-   BerespProtocol HTTP/1.1</span><br><span class="line">-   BerespStatus   304</span><br><span class="line">-   BerespReason   Not Modified</span><br><span class="line">-   BerespHeader   Date: Mon, 06 Nov 2017 13:56:12 GMT</span><br><span class="line">-   BerespHeader   Server: Apache/2.2.15 (CentOS)</span><br><span class="line">-   BerespHeader   Connection: close</span><br><span class="line">-   BerespHeader   ETag: &quot;134-b-55d4f270ba01d&quot;</span><br><span class="line">-   TTL            RFC 120 -1 -1 1509976550 1509976550 1509976572 0 0</span><br><span class="line">-   VCL_call       BACKEND_RESPONSE</span><br><span class="line">-   TTL            VCL 120 10 0 1509976550</span><br><span class="line">-   VCL_return     deliver</span><br><span class="line">-   Storage        malloc Transient</span><br><span class="line">-   ObjProtocol    HTTP/1.1</span><br><span class="line">-   ObjStatus      304</span><br><span class="line">-   ObjReason      Not Modified</span><br><span class="line">-   ObjHeader      Date: Mon, 06 Nov 2017 13:56:12 GMT</span><br><span class="line">-   ObjHeader      Server: Apache/2.2.15 (CentOS)</span><br><span class="line">-   ObjHeader      ETag: &quot;134-b-55d4f270ba01d&quot;</span><br><span class="line">-   Fetch_Body     0 none -</span><br><span class="line">-   Timestamp      BerespBody: 1509976549.802552 0.006022 0.004795</span><br><span class="line">-   BackendClose   21 srv1(192.168.8.11,,80)</span><br><span class="line">-   Length         0</span><br><span class="line">-   BereqAcct      754 0 754 146 0 146</span><br><span class="line">-   End            </span><br><span class="line"></span><br><span class="line">*   &lt;&lt; Request  &gt;&gt; 2         </span><br><span class="line">-   Begin          req 1 rxreq</span><br><span class="line">-   Timestamp      Start: 1509976549.796289 0.000000 0.000000</span><br><span class="line">-   Timestamp      Req: 1509976549.796289 0.000000 0.000000</span><br><span class="line">-   ReqStart       192.168.8.1 57807</span><br><span class="line">-   ReqMethod      GET</span><br><span class="line">-   ReqURL         /login/</span><br><span class="line">-   ReqProtocol    HTTP/1.1</span><br><span class="line">-   ReqHeader      Host: 192.168.8.12</span><br><span class="line">-   ReqHeader      Connection: keep-alive</span><br><span class="line">-   ReqHeader      Cache-Control: max-age=0</span><br><span class="line">-   ReqHeader      Upgrade-Insecure-Requests: 1</span><br><span class="line">-   ReqHeader      User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.79 Safari/537.36</span><br><span class="line">-   ReqHeader      Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">-   ReqHeader      Accept-Encoding: gzip, deflate</span><br><span class="line">-   ReqHeader      Accept-Language: zh-CN,zh;q=0.8</span><br><span class="line">-   ReqHeader      Cookie: solo=732e32b4c3cbba398e9012784ab5b73c476497082ae9da4fece6802005aa95e7b56437ec3b4f64a6f3f8d84903ae067826d5036728270b7ce8a3136e6427a59888a534443b2723cf1a379f2a83216b0a7992966869df4284f600c6be73056c528b6a93e20c50dda63b7d8eaecac3b4e8</span><br><span class="line">-   ReqHeader      If-None-Match: &quot;134-b-55d4f270ba01d&quot;</span><br><span class="line">-   ReqHeader      If-Modified-Since: Mon, 06 Nov 2017 11:57:02 GMT</span><br><span class="line">-   ReqHeader      X-Forwarded-For: 192.168.8.1</span><br><span class="line">-   VCL_call       RECV</span><br><span class="line">-   VCL_return     pass</span><br><span class="line">-   VCL_call       HASH</span><br><span class="line">-   VCL_return     lookup</span><br><span class="line">-   VCL_call       PASS</span><br><span class="line">-   VCL_return     fetch</span><br><span class="line">-   Link           bereq 3 pass</span><br><span class="line">-   Timestamp      Fetch: 1509976549.802556 0.006268 0.006268</span><br><span class="line">-   RespProtocol   HTTP/1.1</span><br><span class="line">-   RespStatus     304</span><br><span class="line">-   RespReason     Not Modified</span><br><span class="line">-   RespHeader     Date: Mon, 06 Nov 2017 13:56:12 GMT</span><br><span class="line">-   RespHeader     Server: Apache/2.2.15 (CentOS)</span><br><span class="line">-   RespHeader     ETag: &quot;134-b-55d4f270ba01d&quot;</span><br><span class="line">-   RespHeader     X-Varnish: 2</span><br><span class="line">-   RespHeader     Age: 0</span><br><span class="line">-   RespHeader     Via: 1.1 varnish-v4</span><br><span class="line">-   VCL_call       DELIVER</span><br><span class="line">-   VCL_return     deliver</span><br><span class="line">-   Timestamp      Process: 1509976549.802575 0.006286 0.000019</span><br><span class="line">-   Debug          &quot;RES_MODE 0&quot;</span><br><span class="line">-   RespHeader     Connection: keep-alive</span><br><span class="line">-   Timestamp      Resp: 1509976549.802628 0.006340 0.000053</span><br><span class="line">-   Debug          &quot;XXX REF 1&quot;</span><br><span class="line">-   ReqAcct        734 0 734 194 0 194</span><br><span class="line">-   End            </span><br><span class="line"></span><br><span class="line">*   &lt;&lt; Session  &gt;&gt; 1         </span><br><span class="line">-   Begin          sess 0 HTTP/1</span><br><span class="line">-   SessOpen       192.168.8.1 57807 :80 192.168.8.12 80 1509976549.795585 12</span><br><span class="line">-   Link           req 2 rxreq</span><br><span class="line">-   SessClose      RX_TIMEOUT 5.048</span><br><span class="line">-   End</span><br></pre></td></tr></table></figure>
<h3 id="varnishtop-日志条目实时排序"><a href="#varnishtop-日志条目实时排序" class="headerlink" title="varnishtop: 日志条目实时排序"></a>varnishtop: 日志条目实时排序</h3><ul>
<li>支持正则表达式匹配</li>
<li>常用选项：<ul>
<li><code>-IP PATTERN</code>：匹配条件则显示</li>
<li><code>-X  PATTERN</code>：不匹配条件则显示</li>
<li><code>-1     Inst</code>ead of a continously updated display, print the statistics once and exit.</li>
<li><code>-i taglist</code>，可以同时使用多个-i选项，也可以一个选项跟上多个标签；</li>
<li><code>-I &lt;[taglist:]regex&gt;</code></li>
<li><code>-x taglist</code>：排除列表</li>
<li><code>-X  &lt;[taglist:]regex&gt;</code></li>
</ul>
</li>
</ul>
<h4 id="直接使用varnishtop"><a href="#直接使用varnishtop" class="headerlink" title="直接使用varnishtop"></a>直接使用varnishtop</h4><p>刷新浏览器</p>
<center><img src="https://houhaiyun.github.io/img/images/Varnish-Log-1.gif" title="访问测试"></center>

<p>查看排序</p>
<center><img src="https://houhaiyun.github.io/img/images/Varnish-Log-2.gif" title="查看排序"></center>

<h4 id="查看特定标签的排序"><a href="#查看特定标签的排序" class="headerlink" title="查看特定标签的排序"></a>查看特定标签的排序</h4><center><img src="https://houhaiyun.github.io/img/images/Varnish-Log-3.gif" title="查看特定标签的排序"></center>

<h4 id="查看除了某标签的排序"><a href="#查看除了某标签的排序" class="headerlink" title="查看除了某标签的排序"></a>查看除了某标签的排序</h4><center><img src="https://houhaiyun.github.io/img/images/Varnish-Log-4.gif" title="查看除了某标签的排序"></center>

<h4 id="查看特定的多个标签"><a href="#查看特定的多个标签" class="headerlink" title="查看特定的多个标签"></a>查看特定的多个标签</h4><center><img src="https://houhaiyun.github.io/img/images/Varnish-Log-5.gif" title="查看特定的多个标签"></center>

<h4 id="基于正则表达式过滤"><a href="#基于正则表达式过滤" class="headerlink" title="基于正则表达式过滤"></a>基于正则表达式过滤</h4><center><img src="https://houhaiyun.github.io/img/images/Varnish-Log-6.gif" title="基于正则表达式过滤"></center>

<h3 id="varnishncsa-显示combined格式日志信息"><a href="#varnishncsa-显示combined格式日志信息" class="headerlink" title="varnishncsa: 显示combined格式日志信息"></a>varnishncsa: 显示combined格式日志信息</h3><p><code>varnishncsa</code>: 显示<code>combined</code>格式日志信息</p>
<p>打开之后会一直处于监听状态，有请求则以<code>combined</code>格式显示请求日志</p>
<p>格式如下：</p>
<center><img src="https://houhaiyun.github.io/img/images/Varnish-Log-7.jpg" title="combined格式日志信息"></center>

<h4 id="将日志记录到本地"><a href="#将日志记录到本地" class="headerlink" title="将日志记录到本地"></a>将日志记录到本地</h4><p>命令：<code>/usr/bin/varnishncsa -a -w /var/log/varnish/varnishncsa.log -D -P /run/varnishncsa/varnishncsa.pid</code></p>
<p>文件路径：<code>/var/log/varnish/varnishncsa.log</code></p>
<center><img src="https://houhaiyun.github.io/img/images/Varnish-Log-8.gif" title="日志记录到本地"></center>


<h3 id="varnishstat-显示计数器信息"><a href="#varnishstat-显示计数器信息" class="headerlink" title="varnishstat: 显示计数器信息"></a>varnishstat: 显示计数器信息</h3><ul>
<li>显示的信息为服务工作状态信息</li>
<li>如：接收的客户端请求数，缓冲的命中次数，启动的线程数等</li>
</ul>
<p>选项：</p>
<ul>
<li><code>-1</code></li>
<li><code>-1 -f FILED_NAME</code> <ul>
<li><code>-l</code>：可用于<code>-f</code>选项指定的字段名称列表；</li>
</ul>
</li>
</ul>
<h4 id="直接执行varnishstat"><a href="#直接执行varnishstat" class="headerlink" title="直接执行varnishstat"></a>直接执行varnishstat</h4><center><img src="https://houhaiyun.github.io/img/images/Varnish-Log-9.gif" title="执行varnishstat"></center>

<h4 id="查看特定某字段"><a href="#查看特定某字段" class="headerlink" title="查看特定某字段"></a>查看特定某字段</h4><p>查看缓存命中的次数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Varnish ~]# varnishstat -1 -f MAIN.cache_hit</span><br><span class="line">MAIN.cache_hit               0         0.00 Cache hits</span><br></pre></td></tr></table></figure>
<h4 id="查看多个字段"><a href="#查看多个字段" class="headerlink" title="查看多个字段"></a>查看多个字段</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@Varnish ~]# varnishstat -1 -f MAIN.cache_hit -f MAIN.cache_miss</span><br><span class="line">MAIN.cache_hit               0         0.00 Cache hits</span><br><span class="line">MAIN.cache_miss              0         0.00 Cache misses</span><br></pre></td></tr></table></figure>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>