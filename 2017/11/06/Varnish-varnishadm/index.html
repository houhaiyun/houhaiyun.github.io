<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>varnishadm(命令行接口)常用子命令 | Peter's technology stack.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Varnish/">Varnish</a></div><div class="post-time">2017-11-06</div></div></div><div class="container post-header"><h1>varnishadm(命令行接口)常用子命令</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#命令行管理接口命令"><span class="toc-number">1.</span> <span class="toc-text">命令行管理接口命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#命令行接口常用子命令"><span class="toc-number">1.1.</span> <span class="toc-text">命令行接口常用子命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#加载配置示例"><span class="toc-number">1.2.</span> <span class="toc-text">加载配置示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#线程相关的参数：使用线程池机制管理线程"><span class="toc-number">2.</span> <span class="toc-text">线程相关的参数：使用线程池机制管理线程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#设定线程池最大线程为3000"><span class="toc-number">2.1.</span> <span class="toc-text">设定线程池最大线程为3000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改线程池的数量为4个"><span class="toc-number">2.2.</span> <span class="toc-text">修改线程池的数量为4个</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设定thread-pools禁止在CLI中修改"><span class="toc-number">2.3.</span> <span class="toc-text">设定thread_pools禁止在CLI中修改</span></a></li></ol></li></ol></details></div><div class="container post-content"><h3 id="命令行管理接口命令"><a href="#命令行管理接口命令" class="headerlink" title="命令行管理接口命令"></a>命令行管理接口命令</h3><p><code>varnishadm  [-t  timeout] [-S secret_file] [-T address:port] [-n name] [command[...]]</code></p>
<ul>
<li><code>-S secret_file</code>：指定秘钥文件路径(<code>/etc/varnish/secret</code>)</li>
<li><code>-T -T address:port</code>: 指定连接命令行接口的地址和端口</li>
</ul>
<p>默认可不指选项参数，<code>varnishadm</code>即可连接到命令行管理接口</p>
<a id="more"></a>
<h4 id="命令行接口常用子命令"><a href="#命令行接口常用子命令" class="headerlink" title="命令行接口常用子命令"></a>命令行接口常用子命令</h4><ul>
<li><code>vcl.list</code>：列出所有配置文件</li>
<li><code>vcl.show CONF_NAME</code>: 查看配置文件</li>
<li><code>vcl.load CONF_NAME config_file</code>: 编译配置文件</li>
<li><code>vcl.use CONF_NAME</code>：使用配置文件（转为active状态）</li>
<li><code>backend.list</code> 查看后端服务器主机</li>
<li><code>backend.set_hleth</code> 设定后端服务器状态</li>
<li><code>storage.list</code> 查看后端存储方式</li>
<li><code>param.show thread_pools</code> 显示线程池参数</li>
<li><code>param.set thread_pools = 4</code> 设定线程池数量<br>配置生效需要先加载（<code>vcl.load</code>），再使用（<code>vcl.use</code>）</li>
</ul>
<h4 id="加载配置示例"><a href="#加载配置示例" class="headerlink" title="加载配置示例"></a>加载配置示例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]# varnishadm -S /etc/varnish/secret -T 127.0.0.1:6082       # -S 指定密钥文件路径；-T：指定地址和端口；</span><br><span class="line">200       </span><br><span class="line">-----------------------------</span><br><span class="line">Varnish Cache CLI 1.0</span><br><span class="line">-----------------------------</span><br><span class="line">Linux,3.10.0-514.el7.x86_64,x86_64,-smalloc,-smalloc,-hcritbit</span><br><span class="line">varnish-4.0.4 revision 386f712</span><br><span class="line"></span><br><span class="line">Type &apos;help&apos; for command list.</span><br><span class="line">Type &apos;quit&apos; to close CLI session.</span><br><span class="line"></span><br><span class="line">vcl.list        # 列出所有配置文件；</span><br><span class="line">200        </span><br><span class="line">active          0 boot      # active表示当前使用的配置文件；</span><br><span class="line">available       0 test22    # available表示可用；</span><br><span class="line"></span><br><span class="line">vcl.load test23 default.vcl     # 加载新的配置；</span><br><span class="line">200        </span><br><span class="line">VCL compiled.</span><br><span class="line">vcl.list        # 列出所有配置文件；</span><br><span class="line">200        </span><br><span class="line">active          0 boot</span><br><span class="line">available       0 test22</span><br><span class="line">available       0 test23</span><br><span class="line"></span><br><span class="line">vcl.use test23      # 使用此配置文件；</span><br><span class="line">200        </span><br><span class="line">VCL &apos;test23&apos; now active     # 启用此配置文件</span><br><span class="line">vcl.list</span><br><span class="line">200        </span><br><span class="line">available       0 boot</span><br><span class="line">available       0 test22</span><br><span class="line">active          0 test23</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong> ：命令行中调整的参数不会永久有效（配置文件永久有效），但不要轻易重启</p>
<h3 id="线程相关的参数：使用线程池机制管理线程"><a href="#线程相关的参数：使用线程池机制管理线程" class="headerlink" title="线程相关的参数：使用线程池机制管理线程"></a>线程相关的参数：使用线程池机制管理线程</h3><p>在线程池内部，其每一个请求由一个线程来处理； 其<code>worker</code>线程的最大数决定了v<code>arnish</code>的并发响应能力；</p>
<ul>
<li><code>thread_pools</code>：Number of worker thread pools. 最好小于或等于CPU核心数量； </li>
<li><code>thread_pool_max</code>：The maximum number of worker threads in each pool. 每线程池的最大线程数；</li>
<li><code>thread_pool_min</code>：The minimum number of worker threads in each pool. 额外意义为“最大空闲线程数”；</li>
<li>`最大并发连接数 = thread_pools  * thread_pool_max</li>
<li><code>thread_pool_timeout</code>：Thread idle threshold.  Threads in excess of thread_pool_min, which have been idle for at least this long, will be destroyed.(线程池超时时间)</li>
<li><code>thread_pool_add_delay</code>：Wait at least this long after creating a thread.(添加线程是否要犹豫一下)</li>
<li><code>thread_pool_destroy_delay</code>：Wait this long after destroying a thread.(删除线程是否要犹豫一下)</li>
</ul>
<h4 id="设定线程池最大线程为3000"><a href="#设定线程池最大线程为3000" class="headerlink" title="设定线程池最大线程为3000"></a>设定线程池最大线程为3000</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@Varnish ~]# varnishadm -S /etc/varnish/secret -T 127.0.0.1:6082 </span><br><span class="line">200        </span><br><span class="line">-----------------------------</span><br><span class="line">Varnish Cache CLI 1.0</span><br><span class="line">-----------------------------</span><br><span class="line">Linux,3.10.0-514.el7.x86_64,x86_64,-smalloc,-smalloc,-hcritbit</span><br><span class="line">varnish-4.0.4 revision 386f712</span><br><span class="line"></span><br><span class="line">Type &apos;help&apos; for command list.</span><br><span class="line">Type &apos;quit&apos; to close CLI session.</span><br><span class="line"></span><br><span class="line">param.set thread_pool_max 3000</span><br><span class="line">200        </span><br><span class="line"></span><br><span class="line">param.show thread_pool_max</span><br><span class="line">200        </span><br><span class="line">thread_pool_max</span><br><span class="line">        Value is: 3000 [threads]</span><br><span class="line">        Default is: 5000</span><br><span class="line">        Minimum is: 100</span><br><span class="line"></span><br><span class="line">        The maximum number of worker threads in each pool.</span><br><span class="line"></span><br><span class="line">        Do not set this higher than you have to, since excess worker</span><br><span class="line">        threads soak up RAM and CPU and generally just get in the way</span><br><span class="line">        of getting work done.</span><br><span class="line"></span><br><span class="line">        Minimum is 10 threads.</span><br><span class="line"></span><br><span class="line">        NB: This parameter may take quite some time to take (full)</span><br><span class="line">        effect.</span><br></pre></td></tr></table></figure>
<h4 id="修改线程池的数量为4个"><a href="#修改线程池的数量为4个" class="headerlink" title="修改线程池的数量为4个"></a>修改线程池的数量为4个</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">param.set thread_pools 4</span><br><span class="line">200        </span><br><span class="line"></span><br><span class="line">param.show thread_pools</span><br><span class="line">200        </span><br><span class="line">thread_pools</span><br><span class="line">        Value is: 4 [pools]</span><br><span class="line">        Default is: 2</span><br><span class="line">        Minimum is: 1</span><br><span class="line"></span><br><span class="line">        Number of worker thread pools.</span><br><span class="line"></span><br><span class="line">        Increasing number of worker pools decreases lock contention.</span><br><span class="line"></span><br><span class="line">        Too many pools waste CPU and RAM resources, and more than one</span><br><span class="line">        pool for each CPU is probably detrimal to performance.</span><br><span class="line"></span><br><span class="line">        Can be increased on the fly, but decreases require a restart to</span><br><span class="line">        take effect.</span><br><span class="line"></span><br><span class="line">        NB: This parameter may take quite some time to take (full)</span><br><span class="line">        effect.</span><br><span class="line"></span><br><span class="line">        NB: We do not know yet if it is a good idea to change this</span><br><span class="line">        parameter, or if the default value is even sensible.  Caution</span><br><span class="line">        is advised, and feedback is most welcome.</span><br></pre></td></tr></table></figure>
<h4 id="设定thread-pools禁止在CLI中修改"><a href="#设定thread-pools禁止在CLI中修改" class="headerlink" title="设定thread_pools禁止在CLI中修改"></a>设定thread_pools禁止在CLI中修改</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@Varnish ~]# vim /etc/varnish/varnish.params       # 修改配置文件；</span><br><span class="line">DAEMON_OPTS=&quot;-p thread_pool_min=5 -p thread_pool_max=500 -p thread_pool_timeout=300 -p thread_pools=4 -r thread_pools,thread_pool_max,thread_pool_min&quot;</span><br><span class="line">[root@Varnish ~]# systemctl restart varnish     # 重启varnish；</span><br><span class="line">[root@Varnish ~]# varnishadm -S /etc/varnish/secret -T 127.0.0.1:6082 </span><br><span class="line">200        </span><br><span class="line">-----------------------------</span><br><span class="line">Varnish Cache CLI 1.0</span><br><span class="line">-----------------------------</span><br><span class="line">Linux,3.10.0-514.el7.x86_64,x86_64,-smalloc,-smalloc,-hcritbit</span><br><span class="line">varnish-4.0.4 revision 386f712</span><br><span class="line"></span><br><span class="line">Type &apos;help&apos; for command list.</span><br><span class="line">Type &apos;quit&apos; to close CLI session.</span><br><span class="line"></span><br><span class="line">param.set thread_pools 2        # 测试修改，已经处于保护状态；</span><br><span class="line">107        </span><br><span class="line">parameter &quot;thread_pools&quot; is protected.</span><br></pre></td></tr></table></figure>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>