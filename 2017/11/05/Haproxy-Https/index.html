<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Peter's technology stack."><title>HAProxy支持https协议 | Peter's technology stack.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/about">About</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Haproxy/">Haproxy</a></div><div class="post-time">2017-11-05</div></div></div><div class="container post-header"><h1>HAProxy支持https协议</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#生成证书"><span class="toc-number">1.</span> <span class="toc-text">生成证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改配置文件"><span class="toc-number">2.</span> <span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#把80端口的请求重定向到443"><span class="toc-number">3.</span> <span class="toc-text">把80端口的请求重定向到443</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#向后端传递用户请求的协议和端口（frontend或backend）"><span class="toc-number">4.</span> <span class="toc-text">向后端传递用户请求的协议和端口（frontend或backend）</span></a></li></ol></details></div><div class="container post-content"><h3 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h3><a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# cd /etc/pki/tls/certs/</span><br><span class="line">[root@HAProxy certs]# make /etc/haproxy/haproxy.pem</span><br><span class="line">umask 77 ; \</span><br><span class="line">	PEM1=`/bin/mktemp /tmp/openssl.XXXXXX` ; \</span><br><span class="line">	PEM2=`/bin/mktemp /tmp/openssl.XXXXXX` ; \</span><br><span class="line">	/usr/bin/openssl req -utf8 -newkey rsa:2048 -keyout $PEM1 -nodes -x509 -days 365 -out $PEM2 -set_serial 0 ; \</span><br><span class="line">	cat $PEM1 &gt;  /etc/haproxy/haproxy.pem ; \</span><br><span class="line">	echo &quot;&quot;    &gt;&gt; /etc/haproxy/haproxy.pem ; \</span><br><span class="line">	cat $PEM2 &gt;&gt; /etc/haproxy/haproxy.pem ; \</span><br><span class="line">	rm -f $PEM1 $PEM2</span><br><span class="line">Generating a 2048 bit RSA private key</span><br><span class="line">....+++</span><br><span class="line">..............................................................................................................................................+++</span><br><span class="line">writing new private key to &apos;/tmp/openssl.2c99KA&apos;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:BJ</span><br><span class="line">Locality Name (eg, city) [Default City]:haidian</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:haiyun</span><br><span class="line">Organizational Unit Name (eg, section) []:opt</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:www.ihaiyun.cc</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg      # 修改配置文件；</span><br><span class="line">frontend https</span><br><span class="line">    bind *:80</span><br><span class="line">    bind *:443 ssl crt /etc/haproxy/haproxy.pem     # 指定启用ssl和证书文件路径；</span><br><span class="line">    default_backend websrvs</span><br><span class="line"></span><br><span class="line">backend websrvs</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check</span><br><span class="line">    </span><br><span class="line">[root@HAProxy ~]# service  haproxy restart          # 重启服务；</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11         # 测试访问，加密和不加密都可以；</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl -k https://192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl -k https://192.168.8.11</span><br><span class="line">web2</span><br></pre></td></tr></table></figure>
<center><img src="https://houhaiyun.github.io/img/images/Haproxy-Https-1.gif" title="测试访问"></center>

<h3 id="把80端口的请求重定向到443"><a href="#把80端口的请求重定向到443" class="headerlink" title="把80端口的请求重定向到443"></a>把80端口的请求重定向到443</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg      # 修改配置文件；</span><br><span class="line">frontend https</span><br><span class="line">    bind *:80</span><br><span class="line">    bind *:443 ssl crt /etc/haproxy/haproxy.pem</span><br><span class="line">    default_backend websrvs</span><br><span class="line">    redirect scheme https if !&#123; ssl_fc &#125;        # 加入此项；</span><br><span class="line"></span><br><span class="line">backend websrvs</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# service  haproxy restart          # 重启服务；</span><br><span class="line">Stopping haproxy:                                          [  OK  ]</span><br><span class="line">Starting haproxy:                                          [  OK  ]</span><br><span class="line"></span><br><span class="line">[root@HAProxy ~]# curl -kL  192.168.8.11</span><br><span class="line">web1</span><br><span class="line">[root@HAProxy ~]# curl -kL  192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl -I  192.168.8.11         # 查看头部已经被重定向到https；</span><br><span class="line">HTTP/1.1 302 Found</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Content-length: 0</span><br><span class="line">Location: https://192.168.8.11/</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>
<h3 id="向后端传递用户请求的协议和端口（frontend或backend）"><a href="#向后端传递用户请求的协议和端口（frontend或backend）" class="headerlink" title="向后端传递用户请求的协议和端口（frontend或backend）"></a>向后端传递用户请求的协议和端口（frontend或backend）</h3><p><code>http_request set-header X-Forwarded-Port%[dst_port]</code></p>
<p><code>http_request add-header X-Forwared-Proto httpsif { ssl_fc }</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@HAProxy ~]# vim /etc/haproxy/haproxy.cfg      # 修改配置文件；</span><br><span class="line">frontend https</span><br><span class="line">    bind *:80</span><br><span class="line">    bind *:443 ssl crt /etc/haproxy/haproxy.pem</span><br><span class="line">    default_backend websrvs</span><br><span class="line">    redirect scheme https if !&#123; ssl_fc &#125;</span><br><span class="line">    http-request set-header X-Forwared-Port %[dst_port]         # 加入此项；</span><br><span class="line"></span><br><span class="line">backend websrvs</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server ser1 192.168.8.12:80 check</span><br><span class="line">    server ser2 192.168.8.13:80 check</span><br><span class="line"></span><br><span class="line">[root@web1 html]# vim /etc/httpd/conf/httpd.conf        # 修改后端http日志；</span><br><span class="line">    LogFormat &quot; %h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%&#123;Referer&#125;i\&quot; \&quot;%&#123;User-Agent&#125;i\&quot;%&#123;X-Forwared-Port&#125;i&quot; haproxy</span><br><span class="line">    CustomLog &quot;logs/access_log&quot; haproxy</span><br><span class="line">    </span><br><span class="line">[root@web1 html]# systemctl restart httpd</span><br><span class="line">[root@HAProxy ~]# curl -kL 192.168.8.11</span><br><span class="line">web2</span><br><span class="line">[root@HAProxy ~]# curl -kL 192.168.8.11</span><br><span class="line">web1</span><br><span class="line"></span><br><span class="line">[root@web1 html]# tail -1 /var/log/httpd/access_log         # 查看日志端口号已经记录；</span><br><span class="line"> 192.168.8.11 - - [02/Nov/2017:15:43:45 +0800] &quot;GET / HTTP/1.1&quot; 200 5 &quot;-&quot; &quot;curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2&quot;443</span><br></pre></td></tr></table></figure>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>